<!DOCTYPE html>
<html>
<head>
<title>DEV LOGS - SQL ( MySQL & PostgreSQL ).md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="%F0%9F%93%9A-sql-learning-index--navigation-guide">ğŸ“š SQL Learning Index &amp; Navigation Guide</h1>
<blockquote>
<p><strong>Complete SQL Mastery Path</strong>: From beginner to advanced database professional</p>
</blockquote>
<hr>
<h2 id="%F0%9F%8E%AF-learning-path-overview">ğŸ¯ Learning Path Overview</h2>
<p>This comprehensive SQL course covers <strong>MySQL</strong> and <strong>PostgreSQL</strong> with real-world examples, performance optimization, and interview preparation. Follow the chapters in order for structured learning, or jump to specific topics as needed.</p>
<h3 id="%F0%9F%93%8A-progress-tracking">ğŸ“Š Progress Tracking</h3>
<ul>
<li><input type="checkbox" id="checkbox0"><label for="checkbox0"></label><strong>Basics Complete</strong> (Chapters 1-5)</li>
<li><input type="checkbox" id="checkbox1"><label for="checkbox1"></label><strong>Intermediate Complete</strong> (Chapters 6-9)</li>
<li><input type="checkbox" id="checkbox2"><label for="checkbox2"></label><strong>Advanced Complete</strong> (Chapters 10-17)</li>
<li><input type="checkbox" id="checkbox3"><label for="checkbox3"></label><strong>Enterprise &amp; Modern SQL Complete</strong> (Chapters 18-23)</li>
<li><input type="checkbox" id="checkbox4"><label for="checkbox4"></label><strong>Ready for Production</strong> ğŸš€</li>
</ul>
<hr>
<h2 id="%F0%9F%93%97-basics-chapters-1-5">ğŸ“— BASICS (Chapters 1-5)</h2>
<p><em>Foundation concepts every SQL developer needs</em></p>
<h3 id="chapter-1-introduction-to-sql--rdbms"><a href="./01-introduction-to-sql-rdbms.md">Chapter 1: Introduction to SQL &amp; RDBMS</a></h3>
<p><strong>ğŸ¯ Learn:</strong> Database fundamentals, MySQL vs PostgreSQL, ACID properties<br>
<strong>â±ï¸ Time:</strong> 45 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Setting up databases, basic commands</p>
<h3 id="chapter-2-data-types"><a href="./02-data-types.md">Chapter 2: Data Types</a></h3>
<p><strong>ğŸ¯ Learn:</strong> Numeric, string, date types across databases<br>
<strong>â±ï¸ Time:</strong> 60 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Choosing optimal data types, storage efficiency</p>
<h3 id="chapter-3-creating-databases--tables"><a href="./03-creating-databases-tables.md">Chapter 3: Creating Databases &amp; Tables</a></h3>
<p><strong>ğŸ¯ Learn:</strong> DDL statements, table design, naming conventions<br>
<strong>â±ï¸ Time:</strong> 75 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Building e-commerce database schema</p>
<h3 id="chapter-4-crud-operations"><a href="./04-crud-operations.md">Chapter 4: CRUD Operations</a></h3>
<p><strong>ğŸ¯ Learn:</strong> SELECT, INSERT, UPDATE, DELETE mastery<br>
<strong>â±ï¸ Time:</strong> 90 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Data manipulation, bulk operations</p>
<h3 id="chapter-5-constraints"><a href="./05-constraints.md">Chapter 5: Constraints</a></h3>
<p><strong>ğŸ¯ Learn:</strong> PRIMARY KEY, FOREIGN KEY, UNIQUE, CHECK constraints<br>
<strong>â±ï¸ Time:</strong> 60 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Data integrity, relationship enforcement</p>
<hr>
<h2 id="%F0%9F%93%98-intermediate-chapters-6-9">ğŸ“˜ INTERMEDIATE (Chapters 6-9)</h2>
<p><em>Building complex queries and relationships</em></p>
<h3 id="chapter-6-where-group-by-having-order-by"><a href="./06-where-group-by-having-order-by.md">Chapter 6: WHERE, GROUP BY, HAVING, ORDER BY</a></h3>
<p><strong>ğŸ¯ Learn:</strong> Filtering, grouping, sorting data<br>
<strong>â±ï¸ Time:</strong> 75 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Complex filtering conditions, data aggregation</p>
<h3 id="chapter-7-joins"><a href="./07-joins.md">Chapter 7: Joins</a></h3>
<p><strong>ğŸ¯ Learn:</strong> INNER, LEFT, RIGHT, FULL OUTER joins<br>
<strong>â±ï¸ Time:</strong> 90 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Multi-table queries, relationship navigation</p>
<h3 id="chapter-8-aggregate-functions"><a href="./08-aggregate-functions.md">Chapter 8: Aggregate Functions</a></h3>
<p><strong>ğŸ¯ Learn:</strong> COUNT, SUM, AVG, MIN, MAX, statistical functions<br>
<strong>â±ï¸ Time:</strong> 60 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Business analytics, reporting queries</p>
<h3 id="chapter-9-subqueries--nested-queries"><a href="./09-subqueries-nested-queries.md">Chapter 9: Subqueries &amp; Nested Queries</a></h3>
<p><strong>ğŸ¯ Learn:</strong> Correlated subqueries, EXISTS, IN, scalar subqueries<br>
<strong>â±ï¸ Time:</strong> 90 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Complex data retrieval, conditional logic</p>
<hr>
<h2 id="%F0%9F%93%99-advanced-chapters-10-17">ğŸ“™ ADVANCED (Chapters 10-17)</h2>
<p><em>Professional-level database skills</em></p>
<h3 id="chapter-10-window-functions"><a href="./10-window-functions.md">Chapter 10: Window Functions</a></h3>
<p><strong>ğŸ¯ Learn:</strong> ROW_NUMBER, RANK, LAG, LEAD, analytical functions<br>
<strong>â±ï¸ Time:</strong> 120 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Advanced analytics, running totals, comparisons</p>
<h3 id="chapter-11-indexes--query-optimization"><a href="./11-indexes-query-optimization.md">Chapter 11: Indexes &amp; Query Optimization</a></h3>
<p><strong>ğŸ¯ Learn:</strong> Index types, EXPLAIN plans, performance tuning<br>
<strong>â±ï¸ Time:</strong> 90 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Query optimization, performance analysis</p>
<h3 id="chapter-12-stored-procedures--functions"><a href="./12-stored-procedures-functions.md">Chapter 12: Stored Procedures &amp; Functions</a></h3>
<p><strong>ğŸ¯ Learn:</strong> Reusable code, parameters, control structures<br>
<strong>â±ï¸ Time:</strong> 75 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Business logic implementation, code organization</p>
<h3 id="chapter-13-triggers--events"><a href="./13-triggers-events.md">Chapter 13: Triggers &amp; Events</a></h3>
<p><strong>ğŸ¯ Learn:</strong> Automated responses, data validation, scheduling<br>
<strong>â±ï¸ Time:</strong> 75 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Audit trails, data synchronization</p>
<h3 id="chapter-14-views--ctes"><a href="./14-views-ctes.md">Chapter 14: Views &amp; CTEs</a></h3>
<p><strong>ğŸ¯ Learn:</strong> Virtual tables, Common Table Expressions, recursive queries<br>
<strong>â±ï¸ Time:</strong> 90 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Data abstraction, complex hierarchical queries</p>
<h3 id="chapter-15-transactions--concurrency"><a href="./15-transactions-concurrency.md">Chapter 15: Transactions &amp; Concurrency</a></h3>
<p><strong>ğŸ¯ Learn:</strong> ACID properties, isolation levels, deadlock handling<br>
<strong>â±ï¸ Time:</strong> 105 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Multi-user scenarios, data consistency</p>
<h3 id="chapter-16-database-security--user-management"><a href="./16-database-security-user-management.md">Chapter 16: Database Security &amp; User Management</a></h3>
<p><strong>ğŸ¯ Learn:</strong> Authentication, authorization, encryption, auditing<br>
<strong>â±ï¸ Time:</strong> 90 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Security implementation, compliance</p>
<h3 id="chapter-17-backup-and-recovery"><a href="./17-backup-recovery.md">Chapter 17: Backup and Recovery</a></h3>
<p><strong>ğŸ¯ Learn:</strong> Backup strategies, disaster recovery, high availability<br>
<strong>â±ï¸ Time:</strong> 120 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Recovery procedures, replication setup</p>
<hr>
<h2 id="%F0%9F%8F%A2-enterprise--modern-sql-chapters-18-23">ğŸ¢ ENTERPRISE &amp; MODERN SQL (Chapters 18-23)</h2>
<p><em>Enterprise-level database architecture and modern practices</em></p>
<h3 id="chapter-18-database-replication--high-availability"><a href="./18-database-replication-high-availability.md">Chapter 18: Database Replication &amp; High Availability</a></h3>
<p><strong>ğŸ¯ Learn:</strong> Master-slave replication, clustering, failover strategies<br>
<strong>â±ï¸ Time:</strong> 135 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Setting up replication, testing failover scenarios</p>
<h3 id="chapter-19-database-proxies--connection-pooling"><a href="./19-database-proxies-connection-pooling.md">Chapter 19: Database Proxies &amp; Connection Pooling</a></h3>
<p><strong>ğŸ¯ Learn:</strong> Connection management, load balancing solutions<br>
<strong>â±ï¸ Time:</strong> 90 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Configuring database proxies, implementing connection pooling</p>
<h3 id="chapter-20-partitioning--sharding"><a href="./20-partitioning-sharding.md">Chapter 20: Partitioning &amp; Sharding</a></h3>
<p><strong>ğŸ¯ Learn:</strong> Scale databases through partitioning and sharding strategies<br>
<strong>â±ï¸ Time:</strong> 120 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Implementing partitioning schemes, designing shard architectures</p>
<h3 id="chapter-21-etl--data-warehousing"><a href="./21-etl-data-warehousing.md">Chapter 21: ETL &amp; Data Warehousing</a></h3>
<p><strong>ğŸ¯ Learn:</strong> ETL pipelines, data warehousing concepts<br>
<strong>â±ï¸ Time:</strong> 150 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Creating ETL processes, dimensional modeling, data quality checks</p>
<h3 id="chapter-22-cloud-databases--dbaas"><a href="./22-cloud-databases-dbaas.md">Chapter 22: Cloud Databases &amp; DBaaS</a></h3>
<p><strong>ğŸ¯ Learn:</strong> Deploy and manage databases in cloud environments<br>
<strong>â±ï¸ Time:</strong> 105 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Setting up cloud databases, migration strategies, cost optimization</p>
<h3 id="chapter-23-database-devops--cicd"><a href="./23-database-devops-cicd.md">Chapter 23: Database DevOps &amp; CI/CD</a></h3>
<p><strong>ğŸ¯ Learn:</strong> Database DevOps practices and automated deployments<br>
<strong>â±ï¸ Time:</strong> 120 minutes<br>
<strong>ğŸ”§ Hands-on:</strong> Database version control, CI/CD pipelines, infrastructure as code</p>
<hr>
<h2 id="%F0%9F%8E%AF-learning-strategies">ğŸ¯ Learning Strategies</h2>
<h3 id="%F0%9F%93%9A-sequential-learning-recommended-for-beginners">ğŸ“š <strong>Sequential Learning</strong> (Recommended for beginners)</h3>
<ol>
<li>Start with Chapter 1 and progress linearly</li>
<li>Complete all hands-on exercises</li>
<li>Review interview questions at the end of each chapter</li>
<li>Build the practice projects as you learn</li>
</ol>
<h3 id="%F0%9F%8E%AF-topic-focused-learning-for-experienced-developers">ğŸ¯ <strong>Topic-Focused Learning</strong> (For experienced developers)</h3>
<ul>
<li><strong>Performance Focus:</strong> Chapters 11, 15, 10, 17</li>
<li><strong>Analytics Focus:</strong> Chapters 8, 9, 10, 14</li>
<li><strong>Security Focus:</strong> Chapters 16, 15, 5, 17</li>
<li><strong>Architecture Focus:</strong> Chapters 1, 3, 11, 14, 17</li>
</ul>
<h3 id="%F0%9F%94%84-review--practice">ğŸ”„ <strong>Review &amp; Practice</strong></h3>
<ul>
<li><strong>Week 1-2:</strong> Basics (Chapters 1-5)</li>
<li><strong>Week 3-4:</strong> Intermediate (Chapters 6-9)</li>
<li><strong>Week 5-7:</strong> Advanced (Chapters 10-17)</li>
<li><strong>Week 8:</strong> Review, practice projects, interview prep</li>
</ul>
<hr>
<h2 id="%F0%9F%9B%A0%EF%B8%8F-practical-projects">ğŸ› ï¸ Practical Projects</h2>
<h3 id="%F0%9F%8F%AA-e-commerce-database-chapters-1-9">ğŸª <strong>E-commerce Database</strong> (Chapters 1-9)</h3>
<p>Build a complete online store database with:</p>
<ul>
<li>Customer management</li>
<li>Product catalog</li>
<li>Order processing</li>
<li>Inventory tracking</li>
</ul>
<h3 id="%F0%9F%93%8A-analytics-dashboard-chapters-10-14">ğŸ“Š <strong>Analytics Dashboard</strong> (Chapters 10-14)</h3>
<p>Create business intelligence queries for:</p>
<ul>
<li>Sales reporting</li>
<li>Customer segmentation</li>
<li>Performance metrics</li>
<li>Trend analysis</li>
</ul>
<h3 id="%F0%9F%94%92-enterprise-security-chapters-15-17">ğŸ”’ <strong>Enterprise Security</strong> (Chapters 15-17)</h3>
<p>Implement production-ready:</p>
<ul>
<li>User access control</li>
<li>Data encryption</li>
<li>Audit logging</li>
<li>Backup strategies</li>
<li>Disaster recovery</li>
</ul>
<h3 id="%F0%9F%8F%A2-scalable-multi-tenant-saas-platform-chapters-18-20">ğŸ¢ <strong>Scalable Multi-Tenant SaaS Platform</strong> (Chapters 18-20)</h3>
<p>Build enterprise-grade infrastructure with:</p>
<ul>
<li>Database replication and high availability</li>
<li>Connection pooling and load balancing</li>
<li>Horizontal partitioning and sharding</li>
<li>Multi-tenant data isolation</li>
</ul>
<h3 id="%F0%9F%94%84-real-time-data-pipeline--warehouse-chapter-21">ğŸ”„ <strong>Real-time Data Pipeline &amp; Warehouse</strong> (Chapter 21)</h3>
<p>Create comprehensive data processing system:</p>
<ul>
<li>ETL pipeline development</li>
<li>Data transformation and validation</li>
<li>Dimensional modeling</li>
<li>Data quality monitoring</li>
</ul>
<h3 id="%E2%98%81%EF%B8%8F-cloud-native-database-infrastructure-chapters-22-23">â˜ï¸ <strong>Cloud-Native Database Infrastructure</strong> (Chapters 22-23)</h3>
<p>Implement modern cloud database operations:</p>
<ul>
<li>Cloud database deployment and migration</li>
<li>Database DevOps and CI/CD pipelines</li>
<li>Infrastructure as code</li>
<li>Automated monitoring and scaling</li>
</ul>
<hr>
<h2 id="%F0%9F%92%A1-interview-preparation">ğŸ’¡ Interview Preparation</h2>
<h3 id="%F0%9F%8E%AF-common-sql-interview-topics">ğŸ¯ <strong>Common SQL Interview Topics</strong></h3>
<ul>
<li><strong>Joins &amp; Subqueries</strong> (Chapters 7, 9)</li>
<li><strong>Window Functions</strong> (Chapter 10)</li>
<li><strong>Performance Optimization</strong> (Chapter 11)</li>
<li><strong>Database Design</strong> (Chapters 3, 5)</li>
<li><strong>Transactions</strong> (Chapter 15)</li>
<li><strong>Backup &amp; Recovery</strong> (Chapter 17)</li>
<li><strong>Database Replication &amp; High Availability</strong> (Chapter 18)</li>
<li><strong>Partitioning &amp; Sharding</strong> (Chapter 20)</li>
<li><strong>ETL &amp; Data Warehousing</strong> (Chapter 21)</li>
<li><strong>Cloud Databases</strong> (Chapter 22)</li>
<li><strong>Database DevOps</strong> (Chapter 23)</li>
</ul>
<h3 id="%F0%9F%93%9D-practice-questions-by-level">ğŸ“ <strong>Practice Questions by Level</strong></h3>
<ul>
<li><strong>Junior:</strong> Basic CRUD, simple joins, aggregate functions</li>
<li><strong>Mid-level:</strong> Complex joins, subqueries, window functions</li>
<li><strong>Senior:</strong> Performance tuning, architecture, security, disaster recovery</li>
<li><strong>Database Architect:</strong> Replication strategies, sharding design, ETL pipelines</li>
<li><strong>Enterprise Engineer:</strong> Cloud migration, DevOps automation, high availability</li>
</ul>
<hr>
<h2 id="%F0%9F%94%97-quick-reference-links">ğŸ”— Quick Reference Links</h2>
<h3 id="%F0%9F%93%96-syntax-references">ğŸ“– <strong>Syntax References</strong></h3>
<ul>
<li><a href="https://dev.mysql.com/doc/">MySQL Documentation</a></li>
<li><a href="https://www.postgresql.org/docs/">PostgreSQL Documentation</a></li>
</ul>
<h3 id="%F0%9F%9B%A0%EF%B8%8F-tools--setup">ğŸ› ï¸ <strong>Tools &amp; Setup</strong></h3>
<ul>
<li>MySQL Workbench</li>
<li>pgAdmin (PostgreSQL)</li>
<li>DBeaver (Universal)</li>
<li>VS Code with SQL extensions</li>
</ul>
<h3 id="%F0%9F%8E%93-additional-resources">ğŸ“ <strong>Additional Resources</strong></h3>
<ul>
<li>SQL practice platforms</li>
<li>Database design tools</li>
<li>Performance monitoring tools</li>
</ul>
<hr>
<h2 id="%E2%9C%85-completion-checklist">âœ… Completion Checklist</h2>
<h3 id="%F0%9F%93%97-basics-mastery">ğŸ“— Basics Mastery</h3>
<ul>
<li><input type="checkbox" id="checkbox5"><label for="checkbox5">Can create and modify database schemas</label></li>
<li><input type="checkbox" id="checkbox6"><label for="checkbox6">Comfortable with all CRUD operations</label></li>
<li><input type="checkbox" id="checkbox7"><label for="checkbox7">Understands data types and constraints</label></li>
<li><input type="checkbox" id="checkbox8"><label for="checkbox8">Can write basic queries with filtering and sorting</label></li>
</ul>
<h3 id="%F0%9F%93%98-intermediate-mastery">ğŸ“˜ Intermediate Mastery</h3>
<ul>
<li><input type="checkbox" id="checkbox9"><label for="checkbox9">Masters all types of joins</label></li>
<li><input type="checkbox" id="checkbox10"><label for="checkbox10">Can write complex subqueries</label></li>
<li><input type="checkbox" id="checkbox11"><label for="checkbox11">Comfortable with aggregate functions</label></li>
<li><input type="checkbox" id="checkbox12"><label for="checkbox12">Understands query execution flow</label></li>
</ul>
<h3 id="%F0%9F%93%99-advanced-mastery">ğŸ“™ Advanced Mastery</h3>
<ul>
<li><input type="checkbox" id="checkbox13"><label for="checkbox13">Uses window functions for analytics</label></li>
<li><input type="checkbox" id="checkbox14"><label for="checkbox14">Can optimize query performance</label></li>
<li><input type="checkbox" id="checkbox15"><label for="checkbox15">Implements stored procedures and triggers</label></li>
<li><input type="checkbox" id="checkbox16"><label for="checkbox16">Understands transactions and concurrency</label></li>
<li><input type="checkbox" id="checkbox17"><label for="checkbox17">Can design secure database systems</label></li>
<li><input type="checkbox" id="checkbox18"><label for="checkbox18">Masters backup and recovery procedures</label></li>
</ul>
<h3 id="%F0%9F%8F%A2-enterprise-mastery">ğŸ¢ Enterprise Mastery</h3>
<ul>
<li><input type="checkbox" id="checkbox19"><label for="checkbox19">Sets up database replication and high availability</label></li>
<li><input type="checkbox" id="checkbox20"><label for="checkbox20">Configures database proxies and connection pooling</label></li>
<li><input type="checkbox" id="checkbox21"><label for="checkbox21">Implements partitioning and sharding strategies</label></li>
<li><input type="checkbox" id="checkbox22"><label for="checkbox22">Builds ETL pipelines and data warehouses</label></li>
<li><input type="checkbox" id="checkbox23"><label for="checkbox23">Deploys and manages cloud databases</label></li>
<li><input type="checkbox" id="checkbox24"><label for="checkbox24">Implements database DevOps and CI/CD practices</label></li>
</ul>
<h3 id="%F0%9F%9A%80-production-ready">ğŸš€ Production Ready</h3>
<ul>
<li><input type="checkbox" id="checkbox25"><label for="checkbox25">Can design scalable database schemas</label></li>
<li><input type="checkbox" id="checkbox26"><label for="checkbox26">Implements proper security measures</label></li>
<li><input type="checkbox" id="checkbox27"><label for="checkbox27">Monitors and optimizes performance</label></li>
<li><input type="checkbox" id="checkbox28"><label for="checkbox28">Handles backup and recovery</label></li>
<li><input type="checkbox" id="checkbox29"><label for="checkbox29">Plans for disaster recovery</label></li>
<li><input type="checkbox" id="checkbox30"><label for="checkbox30">Ready for senior database roles</label></li>
</ul>
<hr>
<blockquote>
<p><strong>ğŸ¯ Goal</strong>: Master SQL to work cross-database, troubleshoot queries, optimize performance, design clean relational schemas, and ensure data protection. If you understand how transactions behave in PostgreSQL vs MySQL, when to use window functions, how to model efficient schemas, and how to recover from disasters â€” you've nailed it! ğŸš€</p>
</blockquote>
<h1 id="%F0%9F%93%98-chapter-1-introduction-to-sql--rdbms">ğŸ“˜ Chapter 1: Introduction to SQL &amp; RDBMS</h1>
<h2 id="%F0%9F%8E%AF-what-youll-learn">ğŸ¯ What You'll Learn</h2>
<ul>
<li>What SQL is and why it matters</li>
<li>Understanding Relational Database Management Systems (RDBMS)</li>
<li>Key differences between MySQL and PostgreSQL</li>
<li>Setting up your first database</li>
</ul>
<hr>
<h2 id="%F0%9F%93%96-concept-explanation">ğŸ“– Concept Explanation</h2>
<p><strong>SQL (Structured Query Language)</strong> is a standardized language for managing and manipulating relational databases. Think of it as the &quot;universal language&quot; that lets you communicate with databases to store, retrieve, update, and delete data.</p>
<p><strong>RDBMS (Relational Database Management System)</strong> is software that manages relational databases. Popular examples include:</p>
<ul>
<li><strong>MySQL</strong>: Fast, reliable, widely used in web applications</li>
<li><strong>PostgreSQL</strong>: Feature-rich, standards-compliant, excellent for complex queries</li>
<li><strong>SQLite</strong>: Lightweight, file-based, perfect for small applications</li>
<li><strong>Microsoft SQL Server</strong>: Enterprise-grade, Windows-focused</li>
<li><strong>MariaDB</strong>: MySQL fork with additional features</li>
</ul>
<h3 id="why-relational-databases">Why Relational Databases?</h3>
<ul>
<li><strong>Structure</strong>: Data is organized in tables with rows and columns</li>
<li><strong>Relationships</strong>: Tables can be linked together (hence &quot;relational&quot;)</li>
<li><strong>ACID Properties</strong>: Atomicity, Consistency, Isolation, Durability</li>
<li><strong>Scalability</strong>: Can handle millions of records efficiently</li>
</ul>
<hr>
<h2 id="%F0%9F%94%A7-syntax-comparison">ğŸ”§ Syntax Comparison</h2>
<h3 id="creating-a-database">Creating a Database</h3>
<p><strong>MySQL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> company_db;
<span class="hljs-keyword">USE</span> company_db;
</div></code></pre>
<p><strong>PostgreSQL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> company_db;
\c company_db  <span class="hljs-comment">-- Connect to database in psql</span>
</div></code></pre>
<h3 id="basic-database-operations">Basic Database Operations</h3>
<p><strong>Show Databases:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">DATABASES</span>;

<span class="hljs-comment">-- PostgreSQL</span>
\l  <span class="hljs-comment">-- In psql command line</span>
<span class="hljs-comment">-- OR</span>
<span class="hljs-keyword">SELECT</span> datname <span class="hljs-keyword">FROM</span> pg_database;
</div></code></pre>
<p><strong>Show Tables:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">TABLES</span>;

<span class="hljs-comment">-- PostgreSQL</span>
\dt  <span class="hljs-comment">-- In psql</span>
<span class="hljs-comment">-- OR</span>
<span class="hljs-keyword">SELECT</span> table_name <span class="hljs-keyword">FROM</span> information_schema.tables
<span class="hljs-keyword">WHERE</span> table_schema = <span class="hljs-string">'public'</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%92%A1-real-world-examples">ğŸ’¡ Real-World Examples</h2>
<h3 id="example-1-e-commerce-database-structure">Example 1: E-commerce Database Structure</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Creating a simple e-commerce database</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> ecommerce_db;

<span class="hljs-comment">-- MySQL/PostgreSQL (similar syntax)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customers (
    customer_id <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span> AUTO_INCREMENT,  <span class="hljs-comment">-- MySQL</span>
    <span class="hljs-comment">-- customer_id SERIAL PRIMARY KEY,          -- PostgreSQL alternative</span>
    first_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    last_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    product_id <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span> AUTO_INCREMENT,   <span class="hljs-comment">-- MySQL</span>
    <span class="hljs-comment">-- product_id SERIAL PRIMARY KEY,           -- PostgreSQL alternative</span>
    product_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    stock_quantity <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    <span class="hljs-keyword">category</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>)
);
</div></code></pre>
<h3 id="example-2-blog-database">Example 2: Blog Database</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> (
    user_id <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span> AUTO_INCREMENT,
    username <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    password_hash <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> posts (
    post_id <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span> AUTO_INCREMENT,
    title <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">content</span> <span class="hljs-built_in">TEXT</span>,
    author_id <span class="hljs-built_in">INT</span>,
    published_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (author_id) <span class="hljs-keyword">REFERENCES</span> <span class="hljs-keyword">users</span>(user_id)
);
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-use-cases--interview-tips">ğŸ¯ Use Cases &amp; Interview Tips</h2>
<h3 id="common-interview-questions">Common Interview Questions:</h3>
<ol>
<li>
<p><strong>&quot;What's the difference between SQL and NoSQL?&quot;</strong></p>
<ul>
<li>SQL: Structured, ACID compliant, good for complex relationships</li>
<li>NoSQL: Flexible schema, horizontally scalable, good for big data</li>
</ul>
</li>
<li>
<p><strong>&quot;Why choose PostgreSQL over MySQL?&quot;</strong></p>
<ul>
<li>PostgreSQL: Better standards compliance, advanced features (JSON, arrays, window functions)</li>
<li>MySQL: Faster for simple queries, easier to set up, more hosting options</li>
</ul>
</li>
<li>
<p><strong>&quot;What are ACID properties?&quot;</strong></p>
<ul>
<li><strong>Atomicity</strong>: All or nothing transactions</li>
<li><strong>Consistency</strong>: Data integrity maintained</li>
<li><strong>Isolation</strong>: Concurrent transactions don't interfere</li>
<li><strong>Durability</strong>: Committed data survives system failures</li>
</ul>
</li>
</ol>
<h3 id="real-world-use-cases">Real-World Use Cases:</h3>
<ul>
<li><strong>E-commerce</strong>: Product catalogs, order management, inventory tracking</li>
<li><strong>Social Media</strong>: User profiles, posts, comments, relationships</li>
<li><strong>Banking</strong>: Account management, transactions, audit trails</li>
<li><strong>Healthcare</strong>: Patient records, appointments, medical history</li>
</ul>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-things-to-watch-out-for">âš ï¸ Things to Watch Out For</h2>
<h3 id="1-case-sensitivity-differences">1. <strong>Case Sensitivity Differences</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL: Generally case-insensitive (depends on OS)</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">Users</span>;  <span class="hljs-comment">-- Works</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span>;  <span class="hljs-comment">-- Also works</span>

<span class="hljs-comment">-- PostgreSQL: Case-sensitive</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">Users</span>;  <span class="hljs-comment">-- Error if table is 'users'</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span>;  <span class="hljs-comment">-- Correct</span>
</div></code></pre>
<h3 id="2-auto-increment-syntax">2. <strong>Auto-Increment Syntax</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL</span>
id INT PRIMARY KEY AUTO_INCREMENT

<span class="hljs-comment">-- PostgreSQL</span>
id SERIAL PRIMARY KEY
<span class="hljs-comment">-- OR</span>
id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY
</div></code></pre>
<h3 id="3-string-concatenation">3. <strong>String Concatenation</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CONCAT</span>(first_name, <span class="hljs-string">' '</span>, last_name) <span class="hljs-keyword">AS</span> full_name <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span>;

<span class="hljs-comment">-- PostgreSQL</span>
<span class="hljs-keyword">SELECT</span> first_name || <span class="hljs-string">' '</span> || last_name <span class="hljs-keyword">AS</span> full_name <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span>;
<span class="hljs-comment">-- OR</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CONCAT</span>(first_name, <span class="hljs-string">' '</span>, last_name) <span class="hljs-keyword">AS</span> full_name <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span>;
</div></code></pre>
<h3 id="4-limit-syntax">4. <strong>Limit Syntax</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;

<span class="hljs-comment">-- PostgreSQL</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;
<span class="hljs-comment">-- Both support LIMIT, but PostgreSQL also supports:</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span> <span class="hljs-keyword">OFFSET</span> <span class="hljs-number">20</span>;
</div></code></pre>
<h3 id="5-datetime-functions">5. <strong>Date/Time Functions</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">NOW</span>(), <span class="hljs-keyword">CURDATE</span>(), <span class="hljs-keyword">CURTIME</span>();

<span class="hljs-comment">-- PostgreSQL</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">NOW</span>(), <span class="hljs-keyword">CURRENT_DATE</span>, <span class="hljs-keyword">CURRENT_TIME</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%80-next-steps">ğŸš€ Next Steps</h2>
<p>In the next chapter, we'll dive into <strong>Data Types</strong> and explore how MySQL and PostgreSQL handle different kinds of data. You'll learn when to use VARCHAR vs TEXT, INT vs BIGINT, and how to work with dates, JSON, and more.</p>
<hr>
<h2 id="%F0%9F%93%9D-quick-practice">ğŸ“ Quick Practice</h2>
<p>Try creating a simple database for a library system with tables for:</p>
<ul>
<li><code>books</code> (id, title, author, isbn, published_year)</li>
<li><code>members</code> (id, name, email, join_date)</li>
<li><code>loans</code> (id, book_id, member_id, loan_date, return_date)</li>
</ul>
<p>Think about what data types and constraints you'd use for each field!</p>
<h1 id="%F0%9F%93%98-chapter-2-data-types-mysql-vs-postgresql">ğŸ“˜ Chapter 2: Data Types (MySQL vs PostgreSQL)</h1>
<h2 id="%F0%9F%8E%AF-what-youll-learn">ğŸ¯ What You'll Learn</h2>
<ul>
<li>Core data types in MySQL and PostgreSQL</li>
<li>When to use each data type</li>
<li>Cross-database compatibility considerations</li>
<li>Performance implications of data type choices</li>
</ul>
<hr>
<h2 id="%F0%9F%93%96-concept-explanation">ğŸ“– Concept Explanation</h2>
<p><strong>Data types</strong> define what kind of data can be stored in each column of a table. Choosing the right data type is crucial for:</p>
<ul>
<li><strong>Storage efficiency</strong>: Using the smallest appropriate type saves space</li>
<li><strong>Performance</strong>: Proper types enable faster queries and indexing</li>
<li><strong>Data integrity</strong>: Types prevent invalid data from being stored</li>
<li><strong>Application compatibility</strong>: Ensures your app can handle the data correctly</li>
</ul>
<h3 id="key-principles">Key Principles:</h3>
<ol>
<li><strong>Use the most restrictive type that fits your data</strong></li>
<li><strong>Consider future growth</strong> (but don't over-engineer)</li>
<li><strong>Think about queries</strong> you'll run on the data</li>
<li><strong>Plan for data validation</strong> at the database level</li>
</ol>
<hr>
<h2 id="%F0%9F%94%A7-data-types-comparison">ğŸ”§ Data Types Comparison</h2>
<h3 id="%F0%9F%93%8A-numeric-types">ğŸ“Š Numeric Types</h3>
<table>
<thead>
<tr>
<th>Purpose</th>
<th>MySQL</th>
<th>PostgreSQL</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Small integers</td>
<td><code>TINYINT</code> (-128 to 127)</td>
<td><code>SMALLINT</code> (-32,768 to 32,767)</td>
<td>PostgreSQL doesn't have TINYINT</td>
</tr>
<tr>
<td>Regular integers</td>
<td><code>INT</code> (-2B to 2B)</td>
<td><code>INTEGER</code> (same range)</td>
<td>Most common for IDs</td>
</tr>
<tr>
<td>Large integers</td>
<td><code>BIGINT</code></td>
<td><code>BIGINT</code></td>
<td>For very large numbers</td>
</tr>
<tr>
<td>Auto-increment</td>
<td><code>AUTO_INCREMENT</code></td>
<td><code>SERIAL</code> or <code>IDENTITY</code></td>
<td>Different syntax, same concept</td>
</tr>
<tr>
<td>Decimals</td>
<td><code>DECIMAL(10,2)</code></td>
<td><code>NUMERIC(10,2)</code></td>
<td>Exact precision</td>
</tr>
<tr>
<td>Floating point</td>
<td><code>FLOAT</code>, <code>DOUBLE</code></td>
<td><code>REAL</code>, <code>DOUBLE PRECISION</code></td>
<td>Approximate values</td>
</tr>
</tbody>
</table>
<p><strong>Examples:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span> AUTO_INCREMENT PRIMARY <span class="hljs-keyword">KEY</span>,
    price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),  <span class="hljs-comment">-- $99,999,999.99 max</span>
    weight <span class="hljs-built_in">FLOAT</span>,         <span class="hljs-comment">-- Approximate weight</span>
    stock_count <span class="hljs-built_in">SMALLINT</span> <span class="hljs-keyword">UNSIGNED</span>  <span class="hljs-comment">-- 0 to 65,535</span>
);

<span class="hljs-comment">-- PostgreSQL</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    price <span class="hljs-built_in">NUMERIC</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),  <span class="hljs-comment">-- Same precision as MySQL DECIMAL</span>
    weight <span class="hljs-built_in">REAL</span>,          <span class="hljs-comment">-- Approximate weight</span>
    stock_count <span class="hljs-built_in">SMALLINT</span> <span class="hljs-keyword">CHECK</span> (stock_count &gt;= <span class="hljs-number">0</span>)
);
</div></code></pre>
<h3 id="%F0%9F%93%9D-string-types">ğŸ“ String Types</h3>
<table>
<thead>
<tr>
<th>Purpose</th>
<th>MySQL</th>
<th>PostgreSQL</th>
<th>Max Length</th>
</tr>
</thead>
<tbody>
<tr>
<td>Fixed length</td>
<td><code>CHAR(n)</code></td>
<td><code>CHAR(n)</code></td>
<td>n characters</td>
</tr>
<tr>
<td>Variable length</td>
<td><code>VARCHAR(n)</code></td>
<td><code>VARCHAR(n)</code></td>
<td>n characters</td>
</tr>
<tr>
<td>Large text</td>
<td><code>TEXT</code></td>
<td><code>TEXT</code></td>
<td>~65KB (MySQL), ~1GB (PostgreSQL)</td>
</tr>
<tr>
<td>Huge text</td>
<td><code>LONGTEXT</code></td>
<td><code>TEXT</code></td>
<td>~4GB (MySQL), unlimited (PostgreSQL)</td>
</tr>
<tr>
<td>Binary data</td>
<td><code>BLOB</code></td>
<td><code>BYTEA</code></td>
<td>For files, images</td>
</tr>
</tbody>
</table>
<p><strong>Examples:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- User profile table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    username <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,     <span class="hljs-comment">-- Short, indexed field</span>
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,       <span class="hljs-comment">-- Email addresses</span>
    bio <span class="hljs-built_in">TEXT</span>,                          <span class="hljs-comment">-- Long description</span>
    avatar_data BYTEA,                 <span class="hljs-comment">-- Profile picture (PostgreSQL)</span>
    <span class="hljs-comment">-- avatar_data BLOB,               -- Profile picture (MySQL)</span>
    country_code <span class="hljs-built_in">CHAR</span>(<span class="hljs-number">2</span>)               <span class="hljs-comment">-- Fixed: 'US', 'CA', 'UK'</span>
);
</div></code></pre>
<h3 id="%F0%9F%93%85-date-and-time-types">ğŸ“… Date and Time Types</h3>
<table>
<thead>
<tr>
<th>Purpose</th>
<th>MySQL</th>
<th>PostgreSQL</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Date only</td>
<td><code>DATE</code></td>
<td><code>DATE</code></td>
<td>YYYY-MM-DD</td>
</tr>
<tr>
<td>Time only</td>
<td><code>TIME</code></td>
<td><code>TIME</code></td>
<td>HH:MM:SS</td>
</tr>
<tr>
<td>Date + Time</td>
<td><code>DATETIME</code></td>
<td><code>TIMESTAMP</code></td>
<td>Different default behaviors</td>
</tr>
<tr>
<td>With timezone</td>
<td><code>TIMESTAMP</code></td>
<td><code>TIMESTAMPTZ</code></td>
<td>PostgreSQL handles timezones better</td>
</tr>
<tr>
<td>Year only</td>
<td><code>YEAR</code></td>
<td>Use <code>INTEGER</code></td>
<td>MySQL-specific</td>
</tr>
</tbody>
</table>
<p><strong>Examples:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Event scheduling table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">events</span> (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    event_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    event_date <span class="hljs-built_in">DATE</span>,                    <span class="hljs-comment">-- Just the date</span>
    start_time <span class="hljs-built_in">TIME</span>,                    <span class="hljs-comment">-- Just the time</span>
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    <span class="hljs-comment">-- PostgreSQL also supports:</span>
    scheduled_at TIMESTAMPTZ,           <span class="hljs-comment">-- With timezone info</span>
    <span class="hljs-keyword">duration</span> <span class="hljs-built_in">INTERVAL</span>                   <span class="hljs-comment">-- PostgreSQL: '2 hours 30 minutes'</span>
);
</div></code></pre>
<h3 id="%F0%9F%94%A2-boolean-and-special-types">ğŸ”¢ Boolean and Special Types</h3>
<p><strong>Boolean:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL (no native boolean)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">settings</span> (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    is_active <span class="hljs-built_in">TINYINT</span>(<span class="hljs-number">1</span>),  <span class="hljs-comment">-- 0 or 1</span>
    <span class="hljs-comment">-- OR</span>
    is_public <span class="hljs-built_in">BOOLEAN</span>      <span class="hljs-comment">-- Actually TINYINT(1)</span>
);

<span class="hljs-comment">-- PostgreSQL (true boolean)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">settings</span> (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    is_active <span class="hljs-built_in">BOOLEAN</span>,     <span class="hljs-comment">-- TRUE/FALSE/NULL</span>
    is_public <span class="hljs-built_in">BOOL</span>         <span class="hljs-comment">-- Alias for BOOLEAN</span>
);
</div></code></pre>
<p><strong>JSON (Modern databases):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL 5.7+</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    <span class="hljs-keyword">attributes</span> <span class="hljs-keyword">JSON</span>,
    metadata <span class="hljs-keyword">JSON</span>
);

<span class="hljs-comment">-- PostgreSQL (superior JSON support)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    <span class="hljs-keyword">attributes</span> <span class="hljs-keyword">JSON</span>,       <span class="hljs-comment">-- Basic JSON</span>
    metadata JSONB,       <span class="hljs-comment">-- Binary JSON (faster, indexable)</span>
    tags <span class="hljs-built_in">TEXT</span>[]           <span class="hljs-comment">-- Array of strings (PostgreSQL only)</span>
);
</div></code></pre>
<hr>
<h2 id="%F0%9F%92%A1-real-world-examples">ğŸ’¡ Real-World Examples</h2>
<h3 id="example-1-e-commerce-product-catalog">Example 1: E-commerce Product Catalog</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Optimized for performance and storage</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    <span class="hljs-comment">-- Primary key: INT is sufficient for most catalogs</span>
    product_id <span class="hljs-built_in">INT</span> AUTO_INCREMENT PRIMARY <span class="hljs-keyword">KEY</span>,

    <span class="hljs-comment">-- Product info: VARCHAR for known limits</span>
    sku <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">name</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,

    <span class="hljs-comment">-- Price: DECIMAL for exact money calculations</span>
    price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    sale_price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),

    <span class="hljs-comment">-- Inventory: SMALLINT saves space</span>
    stock_quantity <span class="hljs-built_in">SMALLINT</span> <span class="hljs-keyword">UNSIGNED</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,

    <span class="hljs-comment">-- Descriptions: TEXT for variable length</span>
    short_description <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">500</span>),
    full_description <span class="hljs-built_in">TEXT</span>,

    <span class="hljs-comment">-- Flags: BOOLEAN/TINYINT for true/false</span>
    is_active <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">TRUE</span>,
    is_featured <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>,

    <span class="hljs-comment">-- Tracking: TIMESTAMP for audit trail</span>
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    updated_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,

    <span class="hljs-comment">-- Categories: INT for foreign key</span>
    category_id <span class="hljs-built_in">INT</span>,

    <span class="hljs-comment">-- Metadata: JSON for flexible attributes</span>
    <span class="hljs-keyword">attributes</span> <span class="hljs-keyword">JSON</span>,  <span class="hljs-comment">-- {"color": "red", "size": "large"}</span>

    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (category_id) <span class="hljs-keyword">REFERENCES</span> categories(category_id)
);
</div></code></pre>
<h3 id="example-2-user-management-system">Example 2: User Management System</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> (
    user_id <span class="hljs-built_in">BIGINT</span> AUTO_INCREMENT PRIMARY <span class="hljs-keyword">KEY</span>,  <span class="hljs-comment">-- BIGINT for large user base</span>

    <span class="hljs-comment">-- Authentication</span>
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    username <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    password_hash <span class="hljs-built_in">CHAR</span>(<span class="hljs-number">60</span>),  <span class="hljs-comment">-- bcrypt hash is always 60 chars</span>

    <span class="hljs-comment">-- Profile</span>
    first_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    last_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    date_of_birth <span class="hljs-built_in">DATE</span>,

    <span class="hljs-comment">-- Settings</span>
    email_verified <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>,
    is_admin <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>,
    timezone <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'UTC'</span>,

    <span class="hljs-comment">-- Tracking</span>
    last_login <span class="hljs-built_in">TIMESTAMP</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,

    <span class="hljs-comment">-- Flexible data</span>
    preferences <span class="hljs-keyword">JSON</span>,  <span class="hljs-comment">-- User settings, theme, etc.</span>

    <span class="hljs-comment">-- Constraints</span>
    <span class="hljs-keyword">CHECK</span> (email <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%@%'</span>),  <span class="hljs-comment">-- Basic email validation</span>
    <span class="hljs-keyword">CHECK</span> (date_of_birth &lt; <span class="hljs-keyword">CURRENT_DATE</span>)
);
</div></code></pre>
<h3 id="example-3-financial-transactions">Example 3: Financial Transactions</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> transactions (
    transaction_id <span class="hljs-built_in">BIGINT</span> AUTO_INCREMENT PRIMARY <span class="hljs-keyword">KEY</span>,

    <span class="hljs-comment">-- Money: Always use DECIMAL for currency</span>
    amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">15</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,  <span class="hljs-comment">-- Up to $999,999,999,999.99</span>
    currency <span class="hljs-built_in">CHAR</span>(<span class="hljs-number">3</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'USD'</span>, <span class="hljs-comment">-- ISO currency codes</span>

    <span class="hljs-comment">-- References</span>
    from_account_id <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    to_account_id <span class="hljs-built_in">BIGINT</span>,

    <span class="hljs-comment">-- Transaction details</span>
    transaction_type ENUM(<span class="hljs-string">'deposit'</span>, <span class="hljs-string">'withdrawal'</span>, <span class="hljs-string">'transfer'</span>, <span class="hljs-string">'fee'</span>),
    <span class="hljs-keyword">status</span> ENUM(<span class="hljs-string">'pending'</span>, <span class="hljs-string">'completed'</span>, <span class="hljs-string">'failed'</span>, <span class="hljs-string">'cancelled'</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'pending'</span>,

    <span class="hljs-comment">-- Audit trail</span>
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    processed_at <span class="hljs-built_in">TIMESTAMP</span>,

    <span class="hljs-comment">-- Additional info</span>
    description <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    reference_number <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span>,

    <span class="hljs-comment">-- Constraints</span>
    <span class="hljs-keyword">CHECK</span> (amount &gt; <span class="hljs-number">0</span>),
    <span class="hljs-keyword">CHECK</span> (from_account_id != to_account_id)
);
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-use-cases--interview-tips">ğŸ¯ Use Cases &amp; Interview Tips</h2>
<h3 id="common-interview-questions">Common Interview Questions:</h3>
<ol>
<li>
<p><strong>&quot;When would you use VARCHAR vs TEXT?&quot;</strong></p>
<ul>
<li>VARCHAR: When you know the approximate max length (names, emails)</li>
<li>TEXT: For variable-length content (blog posts, comments)</li>
<li>Performance: VARCHAR can be indexed more efficiently</li>
</ul>
</li>
<li>
<p><strong>&quot;Why use DECIMAL instead of FLOAT for money?&quot;</strong></p>
<ul>
<li>DECIMAL: Exact precision, no rounding errors</li>
<li>FLOAT: Approximate, can cause rounding issues with currency</li>
<li>Example: 0.1 + 0.2 might not equal 0.3 in floating point</li>
</ul>
</li>
<li>
<p><strong>&quot;What's the difference between DATETIME and TIMESTAMP?&quot;</strong></p>
<ul>
<li>DATETIME: Fixed time, no timezone conversion</li>
<li>TIMESTAMP: Converts to UTC, affected by timezone changes</li>
<li>TIMESTAMP has smaller range but better for global apps</li>
</ul>
</li>
</ol>
<h3 id="performance-tips">Performance Tips:</h3>
<ol>
<li>
<p><strong>Choose the smallest appropriate type</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Bad: Wastes 3 bytes per row</span>
age INT;

<span class="hljs-comment">-- Good: TINYINT is sufficient (0-255)</span>
age TINYINT UNSIGNED;
</div></code></pre>
</li>
<li>
<p><strong>Use fixed-length types when possible</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Good for indexing and joins</span>
country_code CHAR(2);
phone_country_code CHAR(3);
</div></code></pre>
</li>
<li>
<p><strong>Consider indexing implications</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Shorter keys = faster indexes</span>
email VARCHAR(255),  <span class="hljs-comment">-- Good</span>
bio TEXT,           <span class="hljs-comment">-- Don't index the full column</span>
</div></code></pre>
</li>
</ol>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-things-to-watch-out-for">âš ï¸ Things to Watch Out For</h2>
<h3 id="1-mysql-vs-postgresql-auto-increment">1. <strong>MySQL vs PostgreSQL Auto-Increment</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span> AUTO_INCREMENT PRIMARY <span class="hljs-keyword">KEY</span>
);

<span class="hljs-comment">-- PostgreSQL</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>
    <span class="hljs-comment">-- OR (PostgreSQL 10+)</span>
    <span class="hljs-comment">-- id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY</span>
);
</div></code></pre>
<h3 id="2-boolean-handling">2. <strong>Boolean Handling</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL: No true boolean</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> is_active = <span class="hljs-number">1</span>;  <span class="hljs-comment">-- Use 1/0</span>

<span class="hljs-comment">-- PostgreSQL: True boolean</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> is_active = <span class="hljs-literal">TRUE</span>;  <span class="hljs-comment">-- Use TRUE/FALSE</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> is_active;         <span class="hljs-comment">-- Implicit TRUE check</span>
</div></code></pre>
<h3 id="3-string-length-limits">3. <strong>String Length Limits</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL: VARCHAR max is 65,535 characters</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> posts (<span class="hljs-keyword">content</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">65535</span>));  <span class="hljs-comment">-- Max in MySQL</span>

<span class="hljs-comment">-- PostgreSQL: VARCHAR can be much larger</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> posts (<span class="hljs-keyword">content</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">1000000</span>)); <span class="hljs-comment">-- Works in PostgreSQL</span>
</div></code></pre>
<h3 id="4-json-support-differences">4. <strong>JSON Support Differences</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL: Basic JSON</span>
<span class="hljs-keyword">SELECT</span> JSON_EXTRACT(<span class="hljs-keyword">data</span>, <span class="hljs-string">'$.name'</span>) <span class="hljs-keyword">FROM</span> products;

<span class="hljs-comment">-- PostgreSQL: Rich JSON operators</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">data</span>-&gt;&gt;<span class="hljs-string">'name'</span> <span class="hljs-keyword">FROM</span> products;           <span class="hljs-comment">-- Get as text</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">data</span>-&gt;<span class="hljs-string">'attributes'</span>-&gt;<span class="hljs-string">'color'</span> <span class="hljs-keyword">FROM</span> products; <span class="hljs-comment">-- Nested access</span>
</div></code></pre>
<h3 id="5-datetime-timezone-handling">5. <strong>Date/Time Timezone Handling</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL: TIMESTAMP affected by timezone setting</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">time_zone</span> = <span class="hljs-string">'+00:00'</span>;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">events</span> (created_at) <span class="hljs-keyword">VALUES</span> (<span class="hljs-keyword">NOW</span>());

<span class="hljs-comment">-- PostgreSQL: TIMESTAMPTZ stores timezone info</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">events</span> (created_at) <span class="hljs-keyword">VALUES</span> (<span class="hljs-keyword">NOW</span>()); <span class="hljs-comment">-- Includes timezone</span>
</div></code></pre>
<h3 id="6-enum-vs-check-constraints">6. <strong>Enum vs Check Constraints</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL: ENUM type</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    <span class="hljs-keyword">status</span> ENUM(<span class="hljs-string">'pending'</span>, <span class="hljs-string">'shipped'</span>, <span class="hljs-string">'delivered'</span>)
);

<span class="hljs-comment">-- PostgreSQL: Can use ENUM or CHECK</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TYPE</span> order_status <span class="hljs-keyword">AS</span> ENUM (<span class="hljs-string">'pending'</span>, <span class="hljs-string">'shipped'</span>, <span class="hljs-string">'delivered'</span>);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    <span class="hljs-keyword">status</span> order_status
);
<span class="hljs-comment">-- OR</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    <span class="hljs-keyword">status</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">CHECK</span> (<span class="hljs-keyword">status</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'pending'</span>, <span class="hljs-string">'shipped'</span>, <span class="hljs-string">'delivered'</span>))
);
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%80-next-steps">ğŸš€ Next Steps</h2>
<p>In the next chapter, we'll learn how to <strong>Create Databases &amp; Tables</strong> with proper constraints, indexes, and relationships. You'll see how to put these data types to work in real table designs.</p>
<hr>
<h2 id="%F0%9F%93%9D-quick-practice">ğŸ“ Quick Practice</h2>
<p>Design data types for a social media platform:</p>
<ul>
<li>User profiles (username, bio, follower count)</li>
<li>Posts (content, likes, shares, timestamp)</li>
<li>Comments (text, reply threading)</li>
<li>Media uploads (file data, metadata)</li>
</ul>
<p>Think about:</p>
<ul>
<li>What's the maximum reasonable length for each field?</li>
<li>Which fields need exact vs approximate numbers?</li>
<li>How will you handle user-generated content of varying lengths?</li>
</ul>
<h1 id="%F0%9F%93%98-chapter-3-creating-databases--tables">ğŸ“˜ Chapter 3: Creating Databases &amp; Tables</h1>
<h2 id="%F0%9F%8E%AF-what-youll-learn">ğŸ¯ What You'll Learn</h2>
<ul>
<li>How to create and manage databases</li>
<li>Table creation with proper structure</li>
<li>Primary keys, foreign keys, and constraints</li>
<li>Indexes for performance</li>
<li>Best practices for schema design</li>
</ul>
<hr>
<h2 id="%F0%9F%93%96-concept-explanation">ğŸ“– Concept Explanation</h2>
<p><strong>Database creation</strong> is the foundation of any data-driven application. A well-designed database schema is like a blueprint for a house - it determines how efficiently your application will run and how easily you can maintain it.</p>
<h3 id="key-concepts">Key Concepts:</h3>
<ul>
<li><strong>Database</strong>: A container that holds related tables</li>
<li><strong>Schema</strong>: The structure and organization of your database</li>
<li><strong>Table</strong>: A collection of related data organized in rows and columns</li>
<li><strong>Constraints</strong>: Rules that ensure data integrity</li>
<li><strong>Indexes</strong>: Data structures that speed up queries</li>
</ul>
<h3 id="design-principles">Design Principles:</h3>
<ol>
<li><strong>Normalization</strong>: Reduce data redundancy</li>
<li><strong>Consistency</strong>: Use consistent naming conventions</li>
<li><strong>Scalability</strong>: Design for future growth</li>
<li><strong>Performance</strong>: Consider query patterns</li>
<li><strong>Integrity</strong>: Enforce data quality through constraints</li>
</ol>
<hr>
<h2 id="%F0%9F%94%A7-syntax-comparison">ğŸ”§ Syntax Comparison</h2>
<h3 id="creating-databases">Creating Databases</h3>
<p><strong>MySQL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Create database</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> ecommerce_db
<span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4
<span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci;

<span class="hljs-comment">-- Use database</span>
<span class="hljs-keyword">USE</span> ecommerce_db;

<span class="hljs-comment">-- Show current database</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DATABASE</span>();

<span class="hljs-comment">-- Drop database (careful!)</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> ecommerce_db;
</div></code></pre>
<p><strong>PostgreSQL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Create database</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> ecommerce_db
<span class="hljs-keyword">WITH</span> <span class="hljs-keyword">ENCODING</span> <span class="hljs-string">'UTF8'</span>
LC_COLLATE = <span class="hljs-string">'en_US.UTF-8'</span>
LC_CTYPE = <span class="hljs-string">'en_US.UTF-8'</span>;

<span class="hljs-comment">-- Connect to database (in psql)</span>
\c ecommerce_db

<span class="hljs-comment">-- Show current database</span>
<span class="hljs-keyword">SELECT</span> current_database();

<span class="hljs-comment">-- Drop database (careful!)</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> ecommerce_db;
</div></code></pre>
<h3 id="basic-table-creation">Basic Table Creation</h3>
<p><strong>Simple Table:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Works in both MySQL and PostgreSQL</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> categories (
    category_id <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    category_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    description <span class="hljs-built_in">TEXT</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);
</div></code></pre>
<p><strong>Auto-Increment Differences:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    product_id <span class="hljs-built_in">INT</span> AUTO_INCREMENT PRIMARY <span class="hljs-keyword">KEY</span>,
    product_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
);

<span class="hljs-comment">-- PostgreSQL</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    product_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    product_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    price <span class="hljs-built_in">NUMERIC</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
);
</div></code></pre>
<hr>
<h2 id="%F0%9F%92%A1-real-world-examples">ğŸ’¡ Real-World Examples</h2>
<h3 id="example-1-complete-e-commerce-database">Example 1: Complete E-commerce Database</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- 1. Categories table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> categories (
    category_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    category_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    parent_category_id <span class="hljs-built_in">INT</span>,
    description <span class="hljs-built_in">TEXT</span>,
    is_active <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">TRUE</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    updated_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,

    <span class="hljs-comment">-- Self-referencing foreign key for subcategories</span>
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (parent_category_id) <span class="hljs-keyword">REFERENCES</span> categories(category_id)
);

<span class="hljs-comment">-- 2. Products table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    product_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    sku <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    product_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    description <span class="hljs-built_in">TEXT</span>,
    price <span class="hljs-built_in">NUMERIC</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    cost_price <span class="hljs-built_in">NUMERIC</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    stock_quantity <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    min_stock_level <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    category_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    brand <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    weight <span class="hljs-built_in">NUMERIC</span>(<span class="hljs-number">8</span>,<span class="hljs-number">3</span>),
    dimensions <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>), <span class="hljs-comment">-- "10x5x3 cm"</span>
    is_active <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">TRUE</span>,
    is_featured <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    updated_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,

    <span class="hljs-comment">-- Constraints</span>
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (category_id) <span class="hljs-keyword">REFERENCES</span> categories(category_id),
    <span class="hljs-keyword">CHECK</span> (price &gt; <span class="hljs-number">0</span>),
    <span class="hljs-keyword">CHECK</span> (stock_quantity &gt;= <span class="hljs-number">0</span>),
    <span class="hljs-keyword">CHECK</span> (cost_price <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">OR</span> cost_price &gt;= <span class="hljs-number">0</span>)
);

<span class="hljs-comment">-- 3. Customers table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customers (
    customer_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    password_hash <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    first_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    last_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    phone <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    date_of_birth <span class="hljs-built_in">DATE</span>,
    gender <span class="hljs-built_in">CHAR</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">CHECK</span> (gender <span class="hljs-keyword">IN</span> (<span class="hljs-string">'M'</span>, <span class="hljs-string">'F'</span>, <span class="hljs-string">'O'</span>)),
    is_active <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">TRUE</span>,
    email_verified <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    last_login <span class="hljs-built_in">TIMESTAMP</span>,

    <span class="hljs-comment">-- Constraints</span>
    <span class="hljs-keyword">CHECK</span> (email <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%@%'</span>),
    <span class="hljs-keyword">CHECK</span> (date_of_birth <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">OR</span> date_of_birth &lt; <span class="hljs-keyword">CURRENT_DATE</span>)
);

<span class="hljs-comment">-- 4. Addresses table (one-to-many with customers)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> addresses (
    address_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    customer_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    address_type <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'shipping'</span>, <span class="hljs-comment">-- 'shipping', 'billing'</span>
    first_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    last_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    company <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    address_line1 <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    address_line2 <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    city <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    state_province <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    postal_code <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    country <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    phone <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    is_default <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,

    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (customer_id) <span class="hljs-keyword">REFERENCES</span> customers(customer_id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">CASCADE</span>,
    <span class="hljs-keyword">CHECK</span> (address_type <span class="hljs-keyword">IN</span> (<span class="hljs-string">'shipping'</span>, <span class="hljs-string">'billing'</span>))
);

<span class="hljs-comment">-- 5. Orders table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    order_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    order_number <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    customer_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    order_status <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'pending'</span>,
    payment_status <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'pending'</span>,
    subtotal <span class="hljs-built_in">NUMERIC</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    tax_amount <span class="hljs-built_in">NUMERIC</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    shipping_amount <span class="hljs-built_in">NUMERIC</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    discount_amount <span class="hljs-built_in">NUMERIC</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    total_amount <span class="hljs-built_in">NUMERIC</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    currency <span class="hljs-built_in">CHAR</span>(<span class="hljs-number">3</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'USD'</span>,

    <span class="hljs-comment">-- Address snapshots (data at time of order)</span>
    shipping_address_id <span class="hljs-built_in">INT</span>,
    billing_address_id <span class="hljs-built_in">INT</span>,

    <span class="hljs-comment">-- Timestamps</span>
    order_date <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    shipped_date <span class="hljs-built_in">TIMESTAMP</span>,
    delivered_date <span class="hljs-built_in">TIMESTAMP</span>,

    <span class="hljs-comment">-- Notes</span>
    customer_notes <span class="hljs-built_in">TEXT</span>,
    admin_notes <span class="hljs-built_in">TEXT</span>,

    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (customer_id) <span class="hljs-keyword">REFERENCES</span> customers(customer_id),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (shipping_address_id) <span class="hljs-keyword">REFERENCES</span> addresses(address_id),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (billing_address_id) <span class="hljs-keyword">REFERENCES</span> addresses(address_id),

    <span class="hljs-keyword">CHECK</span> (order_status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'pending'</span>, <span class="hljs-string">'processing'</span>, <span class="hljs-string">'shipped'</span>, <span class="hljs-string">'delivered'</span>, <span class="hljs-string">'cancelled'</span>)),
    <span class="hljs-keyword">CHECK</span> (payment_status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'pending'</span>, <span class="hljs-string">'paid'</span>, <span class="hljs-string">'failed'</span>, <span class="hljs-string">'refunded'</span>)),
    <span class="hljs-keyword">CHECK</span> (subtotal &gt;= <span class="hljs-number">0</span>),
    <span class="hljs-keyword">CHECK</span> (total_amount &gt;= <span class="hljs-number">0</span>)
);

<span class="hljs-comment">-- 6. Order items table (many-to-many between orders and products)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> order_items (
    order_item_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    order_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    product_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    quantity <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    unit_price <span class="hljs-built_in">NUMERIC</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    total_price <span class="hljs-built_in">NUMERIC</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,

    <span class="hljs-comment">-- Product snapshot at time of order</span>
    product_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    product_sku <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,

    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (order_id) <span class="hljs-keyword">REFERENCES</span> orders(order_id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">CASCADE</span>,
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (product_id) <span class="hljs-keyword">REFERENCES</span> products(product_id),

    <span class="hljs-keyword">CHECK</span> (quantity &gt; <span class="hljs-number">0</span>),
    <span class="hljs-keyword">CHECK</span> (unit_price &gt;= <span class="hljs-number">0</span>),
    <span class="hljs-keyword">CHECK</span> (total_price &gt;= <span class="hljs-number">0</span>),

    <span class="hljs-comment">-- Ensure total_price = quantity * unit_price</span>
    <span class="hljs-keyword">CHECK</span> (total_price = quantity * unit_price)
);
</div></code></pre>
<h3 id="example-2-blogcms-database">Example 2: Blog/CMS Database</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- 1. Users table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> (
    user_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    username <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    password_hash <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    first_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    last_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    bio <span class="hljs-built_in">TEXT</span>,
    avatar_url <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">500</span>),
    <span class="hljs-keyword">role</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'user'</span>,
    is_active <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">TRUE</span>,
    email_verified <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    updated_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    last_login <span class="hljs-built_in">TIMESTAMP</span>,

    <span class="hljs-keyword">CHECK</span> (<span class="hljs-keyword">role</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'admin'</span>, <span class="hljs-string">'editor'</span>, <span class="hljs-string">'author'</span>, <span class="hljs-string">'user'</span>)),
    <span class="hljs-keyword">CHECK</span> (email <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%@%'</span>)
);

<span class="hljs-comment">-- 2. Categories table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> post_categories (
    category_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    category_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    slug <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    description <span class="hljs-built_in">TEXT</span>,
    parent_category_id <span class="hljs-built_in">INT</span>,
    sort_order <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    is_active <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">TRUE</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,

    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (parent_category_id) <span class="hljs-keyword">REFERENCES</span> post_categories(category_id)
);

<span class="hljs-comment">-- 3. Posts table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> posts (
    post_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    title <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    slug <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    excerpt <span class="hljs-built_in">TEXT</span>,
    <span class="hljs-keyword">content</span> <span class="hljs-built_in">TEXT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    featured_image_url <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">500</span>),
    author_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    category_id <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">status</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'draft'</span>,
    is_featured <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>,
    view_count <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    comment_count <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    like_count <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,

    <span class="hljs-comment">-- SEO fields</span>
    meta_title <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    meta_description <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">500</span>),
    meta_keywords <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">500</span>),

    <span class="hljs-comment">-- Timestamps</span>
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    updated_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    published_at <span class="hljs-built_in">TIMESTAMP</span>,

    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (author_id) <span class="hljs-keyword">REFERENCES</span> <span class="hljs-keyword">users</span>(user_id),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (category_id) <span class="hljs-keyword">REFERENCES</span> post_categories(category_id),

    <span class="hljs-keyword">CHECK</span> (<span class="hljs-keyword">status</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'draft'</span>, <span class="hljs-string">'published'</span>, <span class="hljs-string">'archived'</span>)),
    <span class="hljs-keyword">CHECK</span> (view_count &gt;= <span class="hljs-number">0</span>),
    <span class="hljs-keyword">CHECK</span> (comment_count &gt;= <span class="hljs-number">0</span>),
    <span class="hljs-keyword">CHECK</span> (like_count &gt;= <span class="hljs-number">0</span>)
);

<span class="hljs-comment">-- 4. Comments table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> comments (
    comment_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    post_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    parent_comment_id <span class="hljs-built_in">INT</span>, <span class="hljs-comment">-- For nested comments</span>
    author_id <span class="hljs-built_in">INT</span>, <span class="hljs-comment">-- NULL for guest comments</span>
    author_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>), <span class="hljs-comment">-- For guest comments</span>
    author_email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>), <span class="hljs-comment">-- For guest comments</span>
    <span class="hljs-keyword">content</span> <span class="hljs-built_in">TEXT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">status</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'pending'</span>,
    ip_address INET, <span class="hljs-comment">-- PostgreSQL specific</span>
    user_agent <span class="hljs-built_in">TEXT</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    updated_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,

    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (post_id) <span class="hljs-keyword">REFERENCES</span> posts(post_id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">CASCADE</span>,
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (parent_comment_id) <span class="hljs-keyword">REFERENCES</span> comments(comment_id),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (author_id) <span class="hljs-keyword">REFERENCES</span> <span class="hljs-keyword">users</span>(user_id),

    <span class="hljs-keyword">CHECK</span> (<span class="hljs-keyword">status</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'pending'</span>, <span class="hljs-string">'approved'</span>, <span class="hljs-string">'spam'</span>, <span class="hljs-string">'trash'</span>)),
    <span class="hljs-comment">-- Either registered user OR guest info required</span>
    <span class="hljs-keyword">CHECK</span> (
        (author_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">OR</span>
        (author_name <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">AND</span> author_email <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>)
    )
);
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-use-cases--interview-tips">ğŸ¯ Use Cases &amp; Interview Tips</h2>
<h3 id="common-interview-questions">Common Interview Questions:</h3>
<ol>
<li>
<p><strong>&quot;How do you design a database schema?&quot;</strong></p>
<ul>
<li>Start with entities and relationships</li>
<li>Normalize to reduce redundancy</li>
<li>Add constraints for data integrity</li>
<li>Consider performance and indexing</li>
<li>Plan for scalability</li>
</ul>
</li>
<li>
<p><strong>&quot;What's the difference between PRIMARY KEY and UNIQUE?&quot;</strong></p>
<ul>
<li>PRIMARY KEY: Unique + NOT NULL + one per table</li>
<li>UNIQUE: Can have NULLs + multiple per table</li>
<li>PRIMARY KEY creates clustered index (usually)</li>
</ul>
</li>
<li>
<p><strong>&quot;When would you use CASCADE vs RESTRICT for foreign keys?&quot;</strong></p>
<ul>
<li>CASCADE: Delete related records (order_items when order deleted)</li>
<li>RESTRICT: Prevent deletion if references exist</li>
<li>SET NULL: Set foreign key to NULL when parent deleted</li>
</ul>
</li>
</ol>
<h3 id="schema-design-best-practices">Schema Design Best Practices:</h3>
<ol>
<li>
<p><strong>Naming Conventions</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Good: Consistent, descriptive names</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_profiles (
    user_id <span class="hljs-built_in">INT</span>,
    profile_id <span class="hljs-built_in">INT</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span>
);

<span class="hljs-comment">-- Bad: Inconsistent, unclear</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> UserProf (
    uid <span class="hljs-built_in">INT</span>,
    PID <span class="hljs-built_in">INT</span>,
    dt <span class="hljs-built_in">TIMESTAMP</span>
);
</div></code></pre>
</li>
<li>
<p><strong>Use Appropriate Constraints</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    product_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    price <span class="hljs-built_in">NUMERIC</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">CHECK</span> (price &gt; <span class="hljs-number">0</span>),
    stock_quantity <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> <span class="hljs-keyword">CHECK</span> (stock_quantity &gt;= <span class="hljs-number">0</span>),
    category_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (category_id) <span class="hljs-keyword">REFERENCES</span> categories(category_id)
);
</div></code></pre>
</li>
<li>
<p><strong>Plan for Soft Deletes</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> (
    user_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    is_deleted <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>,
    deleted_at <span class="hljs-built_in">TIMESTAMP</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);
</div></code></pre>
</li>
</ol>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-things-to-watch-out-for">âš ï¸ Things to Watch Out For</h2>
<h3 id="1-foreign-key-constraint-differences">1. <strong>Foreign Key Constraint Differences</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL: Foreign keys optional by default</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    customer_id <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (customer_id) <span class="hljs-keyword">REFERENCES</span> customers(<span class="hljs-keyword">id</span>)
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span>; <span class="hljs-comment">-- Must specify InnoDB for FK support</span>

<span class="hljs-comment">-- PostgreSQL: Foreign keys always enforced</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    customer_id <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (customer_id) <span class="hljs-keyword">REFERENCES</span> customers(<span class="hljs-keyword">id</span>)
); <span class="hljs-comment">-- Always enforced</span>
</div></code></pre>
<h3 id="2-auto-increment-reset-behavior">2. <strong>Auto-Increment Reset Behavior</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL: AUTO_INCREMENT continues after DELETE</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> product_id = <span class="hljs-number">5</span>;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> products (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'New Product'</span>); <span class="hljs-comment">-- Gets ID 6, not 5</span>

<span class="hljs-comment">-- PostgreSQL: SERIAL continues after DELETE</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> product_id = <span class="hljs-number">5</span>;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> products (<span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'New Product'</span>); <span class="hljs-comment">-- Gets ID 6, not 5</span>

<span class="hljs-comment">-- To reset (be careful!):</span>
<span class="hljs-comment">-- MySQL</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> products AUTO_INCREMENT = <span class="hljs-number">1</span>;
<span class="hljs-comment">-- PostgreSQL</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SEQUENCE</span> products_product_id_seq RESTART <span class="hljs-keyword">WITH</span> <span class="hljs-number">1</span>;
</div></code></pre>
<h3 id="3-case-sensitivity-in-names">3. <strong>Case Sensitivity in Names</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL: Generally case-insensitive</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">Users</span> (<span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span>); <span class="hljs-comment">-- Creates 'users' table</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span>; <span class="hljs-comment">-- Works</span>

<span class="hljs-comment">-- PostgreSQL: Case-sensitive</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">Users</span> (<span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span>); <span class="hljs-comment">-- Creates 'Users' table</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span>; <span class="hljs-comment">-- Error! Table is 'Users'</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-string">"Users"</span>; <span class="hljs-comment">-- Correct</span>
</div></code></pre>
<h3 id="4-default-value-differences">4. <strong>Default Value Differences</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL: Can use functions in defaults</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">logs</span> (
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    updated_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- PostgreSQL: Limited function defaults</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">logs</span> (
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    updated_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
    <span class="hljs-comment">-- No automatic ON UPDATE equivalent</span>
);
</div></code></pre>
<h3 id="5-storage-engine-considerations-mysql">5. <strong>Storage Engine Considerations (MySQL)</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL: Different storage engines</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span>; <span class="hljs-comment">-- Supports transactions, foreign keys</span>

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> search_cache (
    keyword <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>)
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">MEMORY</span>; <span class="hljs-comment">-- Faster, but data lost on restart</span>
</div></code></pre>
<h3 id="6-index-creation-timing">6. <strong>Index Creation Timing</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Create indexes after table creation for better performance</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    product_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    <span class="hljs-keyword">name</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    category_id <span class="hljs-built_in">INT</span>,
    price <span class="hljs-built_in">NUMERIC</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- Add indexes separately</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_products_category <span class="hljs-keyword">ON</span> products(category_id);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_products_price <span class="hljs-keyword">ON</span> products(price);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_products_name <span class="hljs-keyword">ON</span> products(<span class="hljs-keyword">name</span>);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_products_created_at <span class="hljs-keyword">ON</span> products(created_at);

<span class="hljs-comment">-- Composite index for common query patterns</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_products_category_price <span class="hljs-keyword">ON</span> products(category_id, price);
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%80-next-steps">ğŸš€ Next Steps</h2>
<p>In the next chapter, we'll dive into <strong>CRUD Operations</strong> (Create, Read, Update, Delete) - the fundamental operations you'll use to manipulate data in your tables. You'll learn how to insert, select, update, and delete data effectively.</p>
<hr>
<h2 id="%F0%9F%93%9D-quick-practice">ğŸ“ Quick Practice</h2>
<p>Design a database schema for a library management system:</p>
<p><strong>Required entities:</strong></p>
<ul>
<li>Books (title, author, ISBN, publication year, copies available)</li>
<li>Members (name, email, phone, membership date)</li>
<li>Loans (which book, which member, loan date, due date, return date)</li>
<li>Authors (name, biography, birth date)</li>
<li>Categories (fiction, non-fiction, science, etc.)</li>
</ul>
<p><strong>Consider:</strong></p>
<ul>
<li>What relationships exist between entities?</li>
<li>What constraints would ensure data integrity?</li>
<li>What indexes would improve query performance?</li>
<li>How would you handle a book with multiple authors?</li>
</ul>
<h1 id="%F0%9F%93%98-chapter-4-crud-operations-select-insert-update-delete">ğŸ“˜ Chapter 4: CRUD Operations (SELECT, INSERT, UPDATE, DELETE)</h1>
<h2 id="%F0%9F%8E%AF-what-youll-learn">ğŸ¯ What You'll Learn</h2>
<ul>
<li>Master the four fundamental database operations</li>
<li>Write efficient SELECT queries with filtering and sorting</li>
<li>Insert single and multiple records safely</li>
<li>Update data with precision and safety</li>
<li>Delete data responsibly with proper safeguards</li>
</ul>
<hr>
<h2 id="%F0%9F%93%96-concept-explanation">ğŸ“– Concept Explanation</h2>
<p><strong>CRUD</strong> stands for the four basic operations you can perform on data:</p>
<ul>
<li><strong>C</strong>reate (INSERT) - Add new data</li>
<li><strong>R</strong>ead (SELECT) - Retrieve existing data</li>
<li><strong>U</strong>pdate (UPDATE) - Modify existing data</li>
<li><strong>D</strong>elete (DELETE) - Remove data</li>
</ul>
<p>These operations form the foundation of all database interactions. Whether you're building a web app, mobile app, or data analysis tool, you'll use these operations constantly.</p>
<h3 id="key-principles">Key Principles:</h3>
<ol>
<li><strong>Safety First</strong>: Always use WHERE clauses with UPDATE/DELETE</li>
<li><strong>Performance</strong>: Write efficient queries that use indexes</li>
<li><strong>Data Integrity</strong>: Respect constraints and relationships</li>
<li><strong>Transactions</strong>: Group related operations together</li>
<li><strong>Testing</strong>: Test queries on small datasets first</li>
</ol>
<hr>
<h2 id="%F0%9F%94%A7-create-insert-operations">ğŸ”§ CREATE (INSERT) Operations</h2>
<h3 id="basic-insert-syntax">Basic INSERT Syntax</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Insert single record</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> table_name (column1, column2, column3)
<span class="hljs-keyword">VALUES</span> (value1, value2, value3);

<span class="hljs-comment">-- Insert multiple records</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> table_name (column1, column2, column3)
<span class="hljs-keyword">VALUES</span>
    (value1a, value2a, value3a),
    (value1b, value2b, value3b),
    (value1c, value2c, value3c);
</div></code></pre>
<h3 id="real-world-examples">Real-World Examples</h3>
<p><strong>1. Adding New Customers:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Single customer</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customers (first_name, last_name, email, phone)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'John'</span>, <span class="hljs-string">'Doe'</span>, <span class="hljs-string">'john.doe@email.com'</span>, <span class="hljs-string">'+1-555-0123'</span>);

<span class="hljs-comment">-- Multiple customers at once (more efficient)</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customers (first_name, last_name, email, phone, created_at)
<span class="hljs-keyword">VALUES</span>
    (<span class="hljs-string">'Alice'</span>, <span class="hljs-string">'Smith'</span>, <span class="hljs-string">'alice@email.com'</span>, <span class="hljs-string">'+1-555-0124'</span>, <span class="hljs-keyword">CURRENT_TIMESTAMP</span>),
    (<span class="hljs-string">'Bob'</span>, <span class="hljs-string">'Johnson'</span>, <span class="hljs-string">'bob@email.com'</span>, <span class="hljs-string">'+1-555-0125'</span>, <span class="hljs-keyword">CURRENT_TIMESTAMP</span>),
    (<span class="hljs-string">'Carol'</span>, <span class="hljs-string">'Williams'</span>, <span class="hljs-string">'carol@email.com'</span>, <span class="hljs-string">'+1-555-0126'</span>, <span class="hljs-keyword">CURRENT_TIMESTAMP</span>);
</div></code></pre>
<p><strong>2. Adding Products with Categories:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- First, ensure category exists</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> categories (category_name, description)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'Electronics'</span>, <span class="hljs-string">'Electronic devices and accessories'</span>);

<span class="hljs-comment">-- Then add products</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> products (sku, product_name, price, category_id, stock_quantity)
<span class="hljs-keyword">VALUES</span>
    (<span class="hljs-string">'LAPTOP001'</span>, <span class="hljs-string">'Gaming Laptop Pro'</span>, <span class="hljs-number">1299.99</span>, <span class="hljs-number">1</span>, <span class="hljs-number">15</span>),
    (<span class="hljs-string">'MOUSE001'</span>, <span class="hljs-string">'Wireless Gaming Mouse'</span>, <span class="hljs-number">79.99</span>, <span class="hljs-number">1</span>, <span class="hljs-number">50</span>),
    (<span class="hljs-string">'KEYBOARD001'</span>, <span class="hljs-string">'Mechanical Keyboard RGB'</span>, <span class="hljs-number">149.99</span>, <span class="hljs-number">1</span>, <span class="hljs-number">30</span>);
</div></code></pre>
<p><strong>3. Handling Auto-Increment and Defaults:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Let database generate ID and timestamp</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (customer_id, total_amount, order_status)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">1529.97</span>, <span class="hljs-string">'pending'</span>);

<span class="hljs-comment">-- Get the generated ID (MySQL)</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">LAST_INSERT_ID</span>();

<span class="hljs-comment">-- Get the generated ID (PostgreSQL)</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (customer_id, total_amount, order_status)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">1529.97</span>, <span class="hljs-string">'pending'</span>)
<span class="hljs-keyword">RETURNING</span> order_id;
</div></code></pre>
<p><strong>4. INSERT with SELECT (Copy Data):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Copy products from one category to another</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> product_archive (product_name, price, archived_date)
<span class="hljs-keyword">SELECT</span> product_name, price, <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> category_id = <span class="hljs-number">5</span> <span class="hljs-keyword">AND</span> is_active = <span class="hljs-literal">FALSE</span>;
</div></code></pre>
<h3 id="insert-safety-and-error-handling">INSERT Safety and Error Handling</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Handle duplicate key errors gracefully</span>

<span class="hljs-comment">-- MySQL: INSERT IGNORE (skips duplicates)</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">IGNORE</span> <span class="hljs-keyword">INTO</span> customers (email, first_name, last_name)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'existing@email.com'</span>, <span class="hljs-string">'John'</span>, <span class="hljs-string">'Doe'</span>);

<span class="hljs-comment">-- MySQL: ON DUPLICATE KEY UPDATE</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customers (email, first_name, last_name, updated_at)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'john@email.com'</span>, <span class="hljs-string">'John'</span>, <span class="hljs-string">'Doe'</span>, <span class="hljs-keyword">CURRENT_TIMESTAMP</span>)
<span class="hljs-keyword">ON</span> <span class="hljs-keyword">DUPLICATE</span> <span class="hljs-keyword">KEY</span> <span class="hljs-keyword">UPDATE</span>
    first_name = <span class="hljs-keyword">VALUES</span>(first_name),
    last_name = <span class="hljs-keyword">VALUES</span>(last_name),
    updated_at = <span class="hljs-keyword">CURRENT_TIMESTAMP</span>;

<span class="hljs-comment">-- PostgreSQL: ON CONFLICT</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customers (email, first_name, last_name, updated_at)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'john@email.com'</span>, <span class="hljs-string">'John'</span>, <span class="hljs-string">'Doe'</span>, <span class="hljs-keyword">CURRENT_TIMESTAMP</span>)
<span class="hljs-keyword">ON</span> CONFLICT (email) <span class="hljs-keyword">DO</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">SET</span>
    first_name = EXCLUDED.first_name,
    last_name = EXCLUDED.last_name,
    updated_at = <span class="hljs-keyword">CURRENT_TIMESTAMP</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%8D-read-select-operations">ğŸ” READ (SELECT) Operations</h2>
<h3 id="basic-select-syntax">Basic SELECT Syntax</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Basic structure</span>
<span class="hljs-keyword">SELECT</span> column1, column2, column3
<span class="hljs-keyword">FROM</span> table_name
<span class="hljs-keyword">WHERE</span> condition
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> column1 <span class="hljs-keyword">ASC</span>/<span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-built_in">number</span>;
</div></code></pre>
<h3 id="essential-select-patterns">Essential SELECT Patterns</h3>
<p><strong>1. Basic Filtering:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Select specific columns</span>
<span class="hljs-keyword">SELECT</span> first_name, last_name, email
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> is_active = <span class="hljs-literal">TRUE</span>;

<span class="hljs-comment">-- Multiple conditions</span>
<span class="hljs-keyword">SELECT</span> product_name, price
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> price <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">50</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">200</span>
  <span class="hljs-keyword">AND</span> category_id <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
  <span class="hljs-keyword">AND</span> stock_quantity &gt; <span class="hljs-number">0</span>;

<span class="hljs-comment">-- Pattern matching</span>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> email <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%@gmail.com'</span>
  <span class="hljs-keyword">AND</span> first_name <span class="hljs-keyword">ILIKE</span> <span class="hljs-string">'john%'</span>;  <span class="hljs-comment">-- ILIKE is case-insensitive (PostgreSQL)</span>
</div></code></pre>
<p><strong>2. Sorting and Limiting:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Order by multiple columns</span>
<span class="hljs-keyword">SELECT</span> product_name, price, stock_quantity
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> category_id <span class="hljs-keyword">ASC</span>, price <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Top 10 most expensive products</span>
<span class="hljs-keyword">SELECT</span> product_name, price
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> price <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;

<span class="hljs-comment">-- Pagination (skip first 20, get next 10)</span>
<span class="hljs-keyword">SELECT</span> product_name, price
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> product_name
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span> <span class="hljs-keyword">OFFSET</span> <span class="hljs-number">20</span>;
</div></code></pre>
<p><strong>3. Aggregate Functions:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Count records</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> total_customers
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> created_at &gt;= <span class="hljs-string">'2024-01-01'</span>;

<span class="hljs-comment">-- Sum, average, min, max</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> total_products,
    <span class="hljs-keyword">AVG</span>(price) <span class="hljs-keyword">as</span> average_price,
    <span class="hljs-keyword">MIN</span>(price) <span class="hljs-keyword">as</span> cheapest_price,
    <span class="hljs-keyword">MAX</span>(price) <span class="hljs-keyword">as</span> most_expensive,
    <span class="hljs-keyword">SUM</span>(stock_quantity * price) <span class="hljs-keyword">as</span> total_inventory_value
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> is_active = <span class="hljs-literal">TRUE</span>;
</div></code></pre>
<p><strong>4. Grouping Data:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Sales by category</span>
<span class="hljs-keyword">SELECT</span>
    c.category_name,
    <span class="hljs-keyword">COUNT</span>(p.product_id) <span class="hljs-keyword">as</span> product_count,
    <span class="hljs-keyword">AVG</span>(p.price) <span class="hljs-keyword">as</span> average_price,
    <span class="hljs-keyword">SUM</span>(p.stock_quantity) <span class="hljs-keyword">as</span> total_stock
<span class="hljs-keyword">FROM</span> categories c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> c.category_id = p.category_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.category_id, c.category_name
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(p.product_id) &gt; <span class="hljs-number">0</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> product_count <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<p><strong>5. Advanced Filtering:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Subqueries</span>
<span class="hljs-keyword">SELECT</span> customer_id, first_name, last_name
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> customer_id <span class="hljs-keyword">IN</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> customer_id
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> order_date &gt;= <span class="hljs-string">'2024-01-01'</span>
);

<span class="hljs-comment">-- EXISTS clause</span>
<span class="hljs-keyword">SELECT</span> c.customer_id, c.first_name, c.last_name
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
      <span class="hljs-keyword">AND</span> o.total_amount &gt; <span class="hljs-number">1000</span>
);

<span class="hljs-comment">-- CASE statements</span>
<span class="hljs-keyword">SELECT</span>
    product_name,
    price,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> price &lt; <span class="hljs-number">50</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Budget'</span>
        <span class="hljs-keyword">WHEN</span> price <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">50</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">200</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Mid-range'</span>
        <span class="hljs-keyword">WHEN</span> price &gt; <span class="hljs-number">200</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Premium'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Unknown'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> price_category
<span class="hljs-keyword">FROM</span> products;
</div></code></pre>
<hr>
<h2 id="%E2%9C%8F%EF%B8%8F-update-operations">âœï¸ UPDATE Operations</h2>
<h3 id="basic-update-syntax">Basic UPDATE Syntax</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">UPDATE</span> table_name
<span class="hljs-keyword">SET</span> column1 = value1, column2 = value2
<span class="hljs-keyword">WHERE</span> condition;
</div></code></pre>
<h3 id="safe-update-practices">Safe UPDATE Practices</h3>
<p><strong>1. Always Use WHERE Clause:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- DANGEROUS: Updates ALL records</span>
<span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> price = price * <span class="hljs-number">1.1</span>;

<span class="hljs-comment">-- SAFE: Updates specific records</span>
<span class="hljs-keyword">UPDATE</span> products
<span class="hljs-keyword">SET</span> price = price * <span class="hljs-number">1.1</span>
<span class="hljs-keyword">WHERE</span> category_id = <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> is_active = <span class="hljs-literal">TRUE</span>;
</div></code></pre>
<p><strong>2. Update Single Records:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Update customer information</span>
<span class="hljs-keyword">UPDATE</span> customers
<span class="hljs-keyword">SET</span>
    first_name = <span class="hljs-string">'John'</span>,
    last_name = <span class="hljs-string">'Smith'</span>,
    phone = <span class="hljs-string">'+1-555-9999'</span>,
    updated_at = <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
<span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">123</span>;

<span class="hljs-comment">-- Verify the update</span>
<span class="hljs-keyword">SELECT</span> customer_id, first_name, last_name, phone, updated_at
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">123</span>;
</div></code></pre>
<p><strong>3. Conditional Updates:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Update stock after sale</span>
<span class="hljs-keyword">UPDATE</span> products
<span class="hljs-keyword">SET</span>
    stock_quantity = stock_quantity - <span class="hljs-number">5</span>,
    updated_at = <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
<span class="hljs-keyword">WHERE</span> product_id = <span class="hljs-number">456</span>
  <span class="hljs-keyword">AND</span> stock_quantity &gt;= <span class="hljs-number">5</span>;  <span class="hljs-comment">-- Only if enough stock</span>

<span class="hljs-comment">-- Update order status</span>
<span class="hljs-keyword">UPDATE</span> orders
<span class="hljs-keyword">SET</span>
    order_status = <span class="hljs-string">'shipped'</span>,
    shipped_date = <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
<span class="hljs-keyword">WHERE</span> order_id = <span class="hljs-number">789</span>
  <span class="hljs-keyword">AND</span> order_status = <span class="hljs-string">'processing'</span>;
</div></code></pre>
<p><strong>4. Bulk Updates:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Deactivate old products</span>
<span class="hljs-keyword">UPDATE</span> products
<span class="hljs-keyword">SET</span>
    is_active = <span class="hljs-literal">FALSE</span>,
    updated_at = <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
<span class="hljs-keyword">WHERE</span> created_at &lt; <span class="hljs-string">'2020-01-01'</span>
  <span class="hljs-keyword">AND</span> stock_quantity = <span class="hljs-number">0</span>;

<span class="hljs-comment">-- Apply discount to category</span>
<span class="hljs-keyword">UPDATE</span> products
<span class="hljs-keyword">SET</span>
    price = price * <span class="hljs-number">0.9</span>,  <span class="hljs-comment">-- 10% discount</span>
    updated_at = <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
<span class="hljs-keyword">WHERE</span> category_id = <span class="hljs-number">5</span>
  <span class="hljs-keyword">AND</span> is_active = <span class="hljs-literal">TRUE</span>;
</div></code></pre>
<p><strong>5. UPDATE with JOIN (MySQL):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Update product prices based on category</span>
<span class="hljs-keyword">UPDATE</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">SET</span> p.price = p.price * <span class="hljs-number">1.15</span>
<span class="hljs-keyword">WHERE</span> c.category_name = <span class="hljs-string">'Electronics'</span>;
</div></code></pre>
<p><strong>6. UPDATE with FROM (PostgreSQL):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Update product prices based on category</span>
<span class="hljs-keyword">UPDATE</span> products
<span class="hljs-keyword">SET</span> price = price * <span class="hljs-number">1.15</span>
<span class="hljs-keyword">FROM</span> categories
<span class="hljs-keyword">WHERE</span> products.category_id = categories.category_id
  <span class="hljs-keyword">AND</span> categories.category_name = <span class="hljs-string">'Electronics'</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%97%91%EF%B8%8F-delete-operations">ğŸ—‘ï¸ DELETE Operations</h2>
<h3 id="basic-delete-syntax">Basic DELETE Syntax</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> table_name
<span class="hljs-keyword">WHERE</span> condition;
</div></code></pre>
<h3 id="safe-delete-practices">Safe DELETE Practices</h3>
<p><strong>1. Always Test with SELECT First:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- STEP 1: Test what will be deleted</span>
<span class="hljs-keyword">SELECT</span> customer_id, first_name, last_name, created_at
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> is_active = <span class="hljs-literal">FALSE</span>
  <span class="hljs-keyword">AND</span> created_at &lt; <span class="hljs-string">'2020-01-01'</span>
  <span class="hljs-keyword">AND</span> customer_id <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> customer_id
      <span class="hljs-keyword">FROM</span> orders
      <span class="hljs-keyword">WHERE</span> customer_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
  );

<span class="hljs-comment">-- STEP 2: If results look correct, then delete</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> is_active = <span class="hljs-literal">FALSE</span>
  <span class="hljs-keyword">AND</span> created_at &lt; <span class="hljs-string">'2020-01-01'</span>
  <span class="hljs-keyword">AND</span> customer_id <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> customer_id
      <span class="hljs-keyword">FROM</span> orders
      <span class="hljs-keyword">WHERE</span> customer_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
  );
</div></code></pre>
<p><strong>2. Soft Delete vs Hard Delete:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Soft delete (recommended for important data)</span>
<span class="hljs-keyword">UPDATE</span> customers
<span class="hljs-keyword">SET</span>
    is_deleted = <span class="hljs-literal">TRUE</span>,
    deleted_at = <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
<span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">123</span>;

<span class="hljs-comment">-- Hard delete (permanent removal)</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">123</span>;
</div></code></pre>
<p><strong>3. Delete with Foreign Key Considerations:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Delete order and related items (with CASCADE)</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> order_id = <span class="hljs-number">456</span>;
<span class="hljs-comment">-- This automatically deletes related order_items if CASCADE is set</span>

<span class="hljs-comment">-- Manual cleanup approach</span>
<span class="hljs-keyword">BEGIN</span> <span class="hljs-keyword">TRANSACTION</span>;

<span class="hljs-comment">-- Delete related records first</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> order_items <span class="hljs-keyword">WHERE</span> order_id = <span class="hljs-number">456</span>;

<span class="hljs-comment">-- Then delete main record</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> order_id = <span class="hljs-number">456</span>;

<span class="hljs-keyword">COMMIT</span>;
</div></code></pre>
<p><strong>4. Conditional Deletes:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Delete expired sessions</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> user_sessions
<span class="hljs-keyword">WHERE</span> expires_at &lt; <span class="hljs-keyword">CURRENT_TIMESTAMP</span>;

<span class="hljs-comment">-- Delete duplicate records (keep newest)</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> customers c1
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">FROM</span> customers c2
    <span class="hljs-keyword">WHERE</span> c2.email = c1.email
      <span class="hljs-keyword">AND</span> c2.customer_id &gt; c1.customer_id
);
</div></code></pre>
<hr>
<h2 id="%F0%9F%92%A1-real-world-crud-examples">ğŸ’¡ Real-World CRUD Examples</h2>
<h3 id="example-1-e-commerce-order-processing">Example 1: E-commerce Order Processing</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- 1. CREATE: New customer places order</span>
<span class="hljs-keyword">BEGIN</span> <span class="hljs-keyword">TRANSACTION</span>;

<span class="hljs-comment">-- Insert customer if not exists</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customers (email, first_name, last_name)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'newcustomer@email.com'</span>, <span class="hljs-string">'Jane'</span>, <span class="hljs-string">'Doe'</span>)
<span class="hljs-keyword">ON</span> CONFLICT (email) <span class="hljs-keyword">DO</span> <span class="hljs-keyword">NOTHING</span>;

<span class="hljs-comment">-- Get customer ID</span>
<span class="hljs-keyword">SET</span> @customer_id = (
    <span class="hljs-keyword">SELECT</span> customer_id
    <span class="hljs-keyword">FROM</span> customers
    <span class="hljs-keyword">WHERE</span> email = <span class="hljs-string">'newcustomer@email.com'</span>
);

<span class="hljs-comment">-- Create order</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (customer_id, order_status, total_amount)
<span class="hljs-keyword">VALUES</span> (@customer_id, <span class="hljs-string">'pending'</span>, <span class="hljs-number">299.98</span>);

<span class="hljs-keyword">SET</span> @order_id = <span class="hljs-keyword">LAST_INSERT_ID</span>();

<span class="hljs-comment">-- Add order items</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> order_items (order_id, product_id, quantity, unit_price, total_price)
<span class="hljs-keyword">VALUES</span>
    (@order_id, <span class="hljs-number">101</span>, <span class="hljs-number">2</span>, <span class="hljs-number">99.99</span>, <span class="hljs-number">199.98</span>),
    (@order_id, <span class="hljs-number">102</span>, <span class="hljs-number">1</span>, <span class="hljs-number">99.99</span>, <span class="hljs-number">99.99</span>);

<span class="hljs-comment">-- Update product stock</span>
<span class="hljs-keyword">UPDATE</span> products
<span class="hljs-keyword">SET</span> stock_quantity = stock_quantity - <span class="hljs-number">2</span>
<span class="hljs-keyword">WHERE</span> product_id = <span class="hljs-number">101</span> <span class="hljs-keyword">AND</span> stock_quantity &gt;= <span class="hljs-number">2</span>;

<span class="hljs-keyword">UPDATE</span> products
<span class="hljs-keyword">SET</span> stock_quantity = stock_quantity - <span class="hljs-number">1</span>
<span class="hljs-keyword">WHERE</span> product_id = <span class="hljs-number">102</span> <span class="hljs-keyword">AND</span> stock_quantity &gt;= <span class="hljs-number">1</span>;

<span class="hljs-keyword">COMMIT</span>;
</div></code></pre>
<h3 id="example-2-blog-content-management">Example 2: Blog Content Management</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- 1. CREATE: Publish new blog post</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> posts (title, slug, <span class="hljs-keyword">content</span>, author_id, category_id, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">VALUES</span> (
    <span class="hljs-string">'Getting Started with SQL'</span>,
    <span class="hljs-string">'getting-started-with-sql'</span>,
    <span class="hljs-string">'SQL is the standard language for managing relational databases...'</span>,
    <span class="hljs-number">1</span>,
    <span class="hljs-number">2</span>,
    <span class="hljs-string">'published'</span>
);

<span class="hljs-comment">-- 2. READ: Get published posts with author info</span>
<span class="hljs-keyword">SELECT</span>
    p.title,
    p.slug,
    p.excerpt,
    p.published_at,
    u.first_name || <span class="hljs-string">' '</span> || u.last_name <span class="hljs-keyword">as</span> author_name,
    c.category_name,
    p.view_count,
    p.comment_count
<span class="hljs-keyword">FROM</span> posts p
<span class="hljs-keyword">JOIN</span> <span class="hljs-keyword">users</span> u <span class="hljs-keyword">ON</span> p.author_id = u.user_id
<span class="hljs-keyword">JOIN</span> post_categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'published'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.published_at <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;

<span class="hljs-comment">-- 3. UPDATE: Increment view count</span>
<span class="hljs-keyword">UPDATE</span> posts
<span class="hljs-keyword">SET</span> view_count = view_count + <span class="hljs-number">1</span>
<span class="hljs-keyword">WHERE</span> slug = <span class="hljs-string">'getting-started-with-sql'</span>;

<span class="hljs-comment">-- 4. DELETE: Remove spam comments</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> comments
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'spam'</span>
  <span class="hljs-keyword">AND</span> created_at &lt; <span class="hljs-keyword">CURRENT_TIMESTAMP</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'30 days'</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-use-cases--interview-tips">ğŸ¯ Use Cases &amp; Interview Tips</h2>
<h3 id="common-interview-questions">Common Interview Questions:</h3>
<ol>
<li>
<p><strong>&quot;How do you prevent accidental data loss?&quot;</strong></p>
<ul>
<li>Always use WHERE clauses with UPDATE/DELETE</li>
<li>Test with SELECT first</li>
<li>Use transactions for multi-step operations</li>
<li>Implement soft deletes for critical data</li>
<li>Regular backups</li>
</ul>
</li>
<li>
<p><strong>&quot;What's the difference between DELETE and TRUNCATE?&quot;</strong></p>
<ul>
<li>DELETE: Removes rows based on WHERE clause, can be rolled back</li>
<li>TRUNCATE: Removes all rows, faster, resets auto-increment, limited rollback</li>
<li>DROP: Removes entire table structure</li>
</ul>
</li>
<li>
<p><strong>&quot;How do you handle duplicate data during INSERT?&quot;</strong></p>
<ul>
<li>MySQL: INSERT IGNORE, ON DUPLICATE KEY UPDATE</li>
<li>PostgreSQL: ON CONFLICT DO UPDATE/NOTHING</li>
<li>Check for existence before inserting</li>
</ul>
</li>
</ol>
<h3 id="performance-tips">Performance Tips:</h3>
<ol>
<li>
<p><strong>Use Indexes for WHERE Clauses:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Slow without index on email</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">WHERE</span> email = <span class="hljs-string">'john@email.com'</span>;

<span class="hljs-comment">-- Create index for faster lookups</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_customers_email <span class="hljs-keyword">ON</span> customers(email);
</div></code></pre>
</li>
<li>
<p><strong>Batch Operations:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Slow: Multiple single inserts</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> products (<span class="hljs-keyword">name</span>, price) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'Product 1'</span>, <span class="hljs-number">10.00</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> products (<span class="hljs-keyword">name</span>, price) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'Product 2'</span>, <span class="hljs-number">15.00</span>);

<span class="hljs-comment">-- Fast: Batch insert</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> products (<span class="hljs-keyword">name</span>, price) <span class="hljs-keyword">VALUES</span>
    (<span class="hljs-string">'Product 1'</span>, <span class="hljs-number">10.00</span>),
    (<span class="hljs-string">'Product 2'</span>, <span class="hljs-number">15.00</span>);
</div></code></pre>
</li>
<li>
<p><strong>Limit Large Operations:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Process in chunks to avoid locking</span>
<span class="hljs-keyword">UPDATE</span> products
<span class="hljs-keyword">SET</span> is_active = <span class="hljs-literal">FALSE</span>
<span class="hljs-keyword">WHERE</span> created_at &lt; <span class="hljs-string">'2020-01-01'</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1000</span>;
</div></code></pre>
</li>
</ol>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-things-to-watch-out-for">âš ï¸ Things to Watch Out For</h2>
<h3 id="1-missing-where-clauses">1. <strong>Missing WHERE Clauses</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- DISASTER: Updates all records</span>
<span class="hljs-keyword">UPDATE</span> customers <span class="hljs-keyword">SET</span> email = <span class="hljs-string">'test@email.com'</span>;

<span class="hljs-comment">-- SAFE: Updates specific record</span>
<span class="hljs-keyword">UPDATE</span> customers <span class="hljs-keyword">SET</span> email = <span class="hljs-string">'test@email.com'</span> <span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">1</span>;
</div></code></pre>
<h3 id="2-foreign-key-violations">2. <strong>Foreign Key Violations</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Error: Cannot delete customer with orders</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">1</span>;

<span class="hljs-comment">-- Solution: Delete orders first, or use CASCADE</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> order_items <span class="hljs-keyword">WHERE</span> order_id <span class="hljs-keyword">IN</span> (
    <span class="hljs-keyword">SELECT</span> order_id <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">1</span>
);
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">1</span>;
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">1</span>;
</div></code></pre>
<h3 id="3-data-type-mismatches">3. <strong>Data Type Mismatches</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Error: String in numeric field</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> products (price) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'not a number'</span>);

<span class="hljs-comment">-- Correct: Proper data type</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> products (price) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">29.99</span>);
</div></code></pre>
<h3 id="4-transaction-management">4. <strong>Transaction Management</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Always wrap related operations in transactions</span>
<span class="hljs-keyword">BEGIN</span> <span class="hljs-keyword">TRANSACTION</span>;

<span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> stock_quantity = stock_quantity - <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> product_id = <span class="hljs-number">1</span>;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> order_items (product_id, quantity) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);

<span class="hljs-comment">-- Check if both operations succeeded</span>
IF @@ERROR = 0
    <span class="hljs-keyword">COMMIT</span>;
ELSE
    <span class="hljs-keyword">ROLLBACK</span>;
</div></code></pre>
<h3 id="5-null-handling">5. <strong>NULL Handling</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Wrong: NULL comparison</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">WHERE</span> phone = <span class="hljs-literal">NULL</span>;

<span class="hljs-comment">-- Correct: IS NULL</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">WHERE</span> phone <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>;

<span class="hljs-comment">-- Handle NULLs in calculations</span>
<span class="hljs-keyword">SELECT</span>
    product_name,
    <span class="hljs-keyword">COALESCE</span>(discount_price, price) <span class="hljs-keyword">as</span> final_price
<span class="hljs-keyword">FROM</span> products;
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%80-next-steps">ğŸš€ Next Steps</h2>
<p>In the next chapter, we'll explore <strong>Constraints</strong> - the rules that ensure your data stays clean and consistent. You'll learn about primary keys, foreign keys, unique constraints, check constraints, and how they protect your database integrity.</p>
<hr>
<h2 id="%F0%9F%93%9D-quick-practice">ğŸ“ Quick Practice</h2>
<p>Using the e-commerce database from previous chapters:</p>
<ol>
<li><strong>INSERT</strong>: Add 5 new products in the &quot;Books&quot; category</li>
<li><strong>SELECT</strong>: Find all customers who have placed orders over $500</li>
<li><strong>UPDATE</strong>: Apply a 15% discount to all products in the &quot;Clothing&quot; category</li>
<li><strong>DELETE</strong>: Remove all products that have 0 stock and haven't been ordered in the last year</li>
</ol>
<p>Remember to:</p>
<ul>
<li>Test your SELECT queries first</li>
<li>Use transactions for multi-step operations</li>
<li>Verify your results after each operation</li>
</ul>
<h1 id="%F0%9F%93%98-chapter-5-constraints-primary-key-foreign-key-unique-etc">ğŸ“˜ Chapter 5: Constraints (PRIMARY KEY, FOREIGN KEY, UNIQUE, etc.)</h1>
<h2 id="%F0%9F%8E%AF-what-youll-learn">ğŸ¯ What You'll Learn</h2>
<ul>
<li>Understanding database constraints and their importance</li>
<li>Primary keys, foreign keys, and referential integrity</li>
<li>Unique constraints and check constraints</li>
<li>NOT NULL constraints and default values</li>
<li>How constraints prevent data corruption and maintain quality</li>
</ul>
<hr>
<h2 id="%F0%9F%93%96-concept-explanation">ğŸ“– Concept Explanation</h2>
<p><strong>Database constraints</strong> are rules enforced by the database to ensure data integrity, consistency, and validity. Think of them as &quot;guardrails&quot; that prevent bad data from entering your database and maintain relationships between tables.</p>
<h3 id="why-constraints-matter">Why Constraints Matter:</h3>
<ol>
<li><strong>Data Integrity</strong>: Prevent invalid or inconsistent data</li>
<li><strong>Referential Integrity</strong>: Maintain relationships between tables</li>
<li><strong>Business Rules</strong>: Enforce application logic at the database level</li>
<li><strong>Performance</strong>: Some constraints create indexes automatically</li>
<li><strong>Documentation</strong>: Constraints serve as living documentation of your data rules</li>
</ol>
<h3 id="types-of-constraints">Types of Constraints:</h3>
<ul>
<li><strong>PRIMARY KEY</strong>: Unique identifier for each row</li>
<li><strong>FOREIGN KEY</strong>: Links to another table's primary key</li>
<li><strong>UNIQUE</strong>: Ensures column values are unique</li>
<li><strong>NOT NULL</strong>: Prevents empty values</li>
<li><strong>CHECK</strong>: Custom validation rules</li>
<li><strong>DEFAULT</strong>: Provides default values</li>
</ul>
<hr>
<h2 id="%F0%9F%94%A7-primary-key-constraints">ğŸ”§ PRIMARY KEY Constraints</h2>
<h3 id="what-is-a-primary-key">What is a Primary Key?</h3>
<p>A primary key uniquely identifies each row in a table. Every table should have one (and only one) primary key.</p>
<p><strong>Rules:</strong></p>
<ul>
<li>Must be unique across all rows</li>
<li>Cannot be NULL</li>
<li>Should be immutable (rarely changed)</li>
<li>Automatically creates a unique index</li>
</ul>
<h3 id="primary-key-examples">Primary Key Examples</h3>
<p><strong>1. Single Column Primary Key:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Auto-increment primary key (most common)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customers (
    customer_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,  <span class="hljs-comment">-- PostgreSQL</span>
    <span class="hljs-comment">-- customer_id INT AUTO_INCREMENT PRIMARY KEY,  -- MySQL</span>
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    first_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    last_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
);

<span class="hljs-comment">-- Natural primary key (use with caution)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> countries (
    country_code <span class="hljs-built_in">CHAR</span>(<span class="hljs-number">2</span>) PRIMARY <span class="hljs-keyword">KEY</span>,  <span class="hljs-comment">-- 'US', 'CA', 'UK'</span>
    country_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    continent <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>)
);
</div></code></pre>
<p><strong>2. Composite Primary Key:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Multiple columns form the primary key</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> order_items (
    order_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    product_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    quantity <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    unit_price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,

    <span class="hljs-comment">-- Composite primary key</span>
    PRIMARY <span class="hljs-keyword">KEY</span> (order_id, product_id),

    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (order_id) <span class="hljs-keyword">REFERENCES</span> orders(order_id),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (product_id) <span class="hljs-keyword">REFERENCES</span> products(product_id)
);

<span class="hljs-comment">-- User roles assignment</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_roles (
    user_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    role_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    assigned_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    assigned_by <span class="hljs-built_in">INT</span>,

    PRIMARY <span class="hljs-keyword">KEY</span> (user_id, role_id),

    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (user_id) <span class="hljs-keyword">REFERENCES</span> <span class="hljs-keyword">users</span>(user_id),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (role_id) <span class="hljs-keyword">REFERENCES</span> <span class="hljs-keyword">roles</span>(role_id),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (assigned_by) <span class="hljs-keyword">REFERENCES</span> <span class="hljs-keyword">users</span>(user_id)
);
</div></code></pre>
<p><strong>3. Adding Primary Key to Existing Table:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Add primary key constraint</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> existing_table
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> pk_existing_table PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-keyword">id</span>);

<span class="hljs-comment">-- Drop primary key (MySQL)</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> existing_table <span class="hljs-keyword">DROP</span> PRIMARY <span class="hljs-keyword">KEY</span>;

<span class="hljs-comment">-- Drop primary key (PostgreSQL)</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> existing_table <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">CONSTRAINT</span> existing_table_pkey;
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%97-foreign-key-constraints">ğŸ”— FOREIGN KEY Constraints</h2>
<h3 id="what-is-a-foreign-key">What is a Foreign Key?</h3>
<p>A foreign key creates a link between two tables, ensuring referential integrity. It must match a value in the referenced table's primary key or be NULL.</p>
<h3 id="foreign-key-examples">Foreign Key Examples</h3>
<p><strong>1. Basic Foreign Key:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Orders table references customers</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    order_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    customer_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    order_date <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    total_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,

    <span class="hljs-comment">-- Foreign key constraint</span>
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (customer_id) <span class="hljs-keyword">REFERENCES</span> customers(customer_id)
);

<span class="hljs-comment">-- Alternative syntax</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    order_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    customer_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">REFERENCES</span> customers(customer_id),
    order_date <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    total_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
);
</div></code></pre>
<p><strong>2. Foreign Key with Actions:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    order_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    customer_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    order_date <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    total_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,

    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (customer_id) <span class="hljs-keyword">REFERENCES</span> customers(customer_id)
        <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> RESTRICT    <span class="hljs-comment">-- Prevent deletion if orders exist</span>
        <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">CASCADE</span>     <span class="hljs-comment">-- Update order.customer_id if customer.customer_id changes</span>
);

<span class="hljs-comment">-- Different action options:</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> order_items (
    order_item_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    order_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    product_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    quantity <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,

    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (order_id) <span class="hljs-keyword">REFERENCES</span> orders(order_id)
        <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">CASCADE</span>,    <span class="hljs-comment">-- Delete order_items when order is deleted</span>

    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (product_id) <span class="hljs-keyword">REFERENCES</span> products(product_id)
        <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">SET</span> <span class="hljs-literal">NULL</span>    <span class="hljs-comment">-- Set product_id to NULL if product is deleted</span>
        <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">CASCADE</span>
);
</div></code></pre>
<p><strong>3. Self-Referencing Foreign Key:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Employee hierarchy</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> employees (
    employee_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    first_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    last_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    manager_id <span class="hljs-built_in">INT</span>,
    department <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),

    <span class="hljs-comment">-- Self-referencing foreign key</span>
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (manager_id) <span class="hljs-keyword">REFERENCES</span> employees(employee_id)
        <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">SET</span> <span class="hljs-literal">NULL</span>
);

<span class="hljs-comment">-- Category hierarchy</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> categories (
    category_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    category_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    parent_category_id <span class="hljs-built_in">INT</span>,

    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (parent_category_id) <span class="hljs-keyword">REFERENCES</span> categories(category_id)
        <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">CASCADE</span>
);
</div></code></pre>
<p><strong>4. Multiple Foreign Keys:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> product_reviews (
    review_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    product_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    customer_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    rating <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">CHECK</span> (rating <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">5</span>),
    review_text <span class="hljs-built_in">TEXT</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,

    <span class="hljs-comment">-- Multiple foreign keys</span>
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (product_id) <span class="hljs-keyword">REFERENCES</span> products(product_id)
        <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">CASCADE</span>,
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (customer_id) <span class="hljs-keyword">REFERENCES</span> customers(customer_id)
        <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">CASCADE</span>,

    <span class="hljs-comment">-- Ensure one review per customer per product</span>
    <span class="hljs-keyword">UNIQUE</span> (product_id, customer_id)
);
</div></code></pre>
<h3 id="foreign-key-actions-explained">Foreign Key Actions Explained</h3>
<table>
<thead>
<tr>
<th>Action</th>
<th>Description</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>RESTRICT</code></td>
<td>Prevent parent deletion/update</td>
<td>Default, safest option</td>
</tr>
<tr>
<td><code>CASCADE</code></td>
<td>Delete/update child records too</td>
<td>Order items when order deleted</td>
</tr>
<tr>
<td><code>SET NULL</code></td>
<td>Set foreign key to NULL</td>
<td>Optional relationships</td>
</tr>
<tr>
<td><code>SET DEFAULT</code></td>
<td>Set to default value</td>
<td>Rarely used</td>
</tr>
<tr>
<td><code>NO ACTION</code></td>
<td>Same as RESTRICT</td>
<td>PostgreSQL default</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="%F0%9F%94%92-unique-constraints">ğŸ”’ UNIQUE Constraints</h2>
<h3 id="what-is-a-unique-constraint">What is a UNIQUE Constraint?</h3>
<p>Ensures that all values in a column (or combination of columns) are unique across the table.</p>
<h3 id="unique-examples">UNIQUE Examples</h3>
<p><strong>1. Single Column UNIQUE:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customers (
    customer_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,  <span class="hljs-comment">-- Inline unique constraint</span>
    username <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    phone <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),

    <span class="hljs-comment">-- Named unique constraints</span>
    <span class="hljs-keyword">CONSTRAINT</span> uk_customers_username <span class="hljs-keyword">UNIQUE</span> (username),
    <span class="hljs-keyword">CONSTRAINT</span> uk_customers_phone <span class="hljs-keyword">UNIQUE</span> (phone)
);
</div></code></pre>
<p><strong>2. Composite UNIQUE:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Ensure unique combination of first_name + last_name + date_of_birth</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> persons (
    person_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    first_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    last_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    date_of_birth <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),

    <span class="hljs-keyword">UNIQUE</span> (first_name, last_name, date_of_birth)
);

<span class="hljs-comment">-- Product SKU must be unique per supplier</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> supplier_products (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    supplier_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    product_sku <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    product_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),

    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (supplier_id) <span class="hljs-keyword">REFERENCES</span> suppliers(supplier_id),
    <span class="hljs-keyword">UNIQUE</span> (supplier_id, product_sku)
);
</div></code></pre>
<p><strong>3. Adding/Dropping UNIQUE Constraints:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Add unique constraint to existing table</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> customers
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> uk_customers_email <span class="hljs-keyword">UNIQUE</span> (email);

<span class="hljs-comment">-- Drop unique constraint</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> customers
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">CONSTRAINT</span> uk_customers_email;

<span class="hljs-comment">-- MySQL syntax for dropping</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> customers
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">INDEX</span> uk_customers_email;
</div></code></pre>
<hr>
<h2 id="%E2%9C%85-check-constraints">âœ… CHECK Constraints</h2>
<h3 id="what-is-a-check-constraint">What is a CHECK Constraint?</h3>
<p>Enforces custom business rules by validating data before it's inserted or updated.</p>
<h3 id="check-examples">CHECK Examples</h3>
<p><strong>1. Range Validation:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    product_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    product_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">CHECK</span> (price &gt; <span class="hljs-number">0</span>),
    discount_percentage <span class="hljs-built_in">INT</span> <span class="hljs-keyword">CHECK</span> (discount_percentage <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">100</span>),
    stock_quantity <span class="hljs-built_in">INT</span> <span class="hljs-keyword">CHECK</span> (stock_quantity &gt;= <span class="hljs-number">0</span>),
    weight <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">8</span>,<span class="hljs-number">3</span>) <span class="hljs-keyword">CHECK</span> (weight &gt; <span class="hljs-number">0</span>),

    <span class="hljs-comment">-- Named check constraints</span>
    <span class="hljs-keyword">CONSTRAINT</span> chk_products_price_range <span class="hljs-keyword">CHECK</span> (price <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">0.01</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">999999.99</span>)
);
</div></code></pre>
<p><strong>2. Enum-like Validation:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    order_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    customer_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    order_status <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
        <span class="hljs-keyword">CHECK</span> (order_status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'pending'</span>, <span class="hljs-string">'processing'</span>, <span class="hljs-string">'shipped'</span>, <span class="hljs-string">'delivered'</span>, <span class="hljs-string">'cancelled'</span>)),
    payment_status <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
        <span class="hljs-keyword">CHECK</span> (payment_status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'pending'</span>, <span class="hljs-string">'paid'</span>, <span class="hljs-string">'failed'</span>, <span class="hljs-string">'refunded'</span>)),
    <span class="hljs-keyword">priority</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'normal'</span>
        <span class="hljs-keyword">CHECK</span> (<span class="hljs-keyword">priority</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'low'</span>, <span class="hljs-string">'normal'</span>, <span class="hljs-string">'high'</span>, <span class="hljs-string">'urgent'</span>)),

    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (customer_id) <span class="hljs-keyword">REFERENCES</span> customers(customer_id)
);
</div></code></pre>
<p><strong>3. Complex Business Rules:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> employees (
    employee_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    first_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    last_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    hire_date <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    birth_date <span class="hljs-built_in">DATE</span>,
    salary <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    department <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),

    <span class="hljs-comment">-- Business rule validations</span>
    <span class="hljs-keyword">CHECK</span> (hire_date &gt;= <span class="hljs-string">'1900-01-01'</span>),
    <span class="hljs-keyword">CHECK</span> (birth_date <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">OR</span> birth_date &lt; hire_date),
    <span class="hljs-keyword">CHECK</span> (salary <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">OR</span> salary &gt; <span class="hljs-number">0</span>),
    <span class="hljs-keyword">CHECK</span> (email <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%@%'</span>),

    <span class="hljs-comment">-- Age must be at least 16 at hire date</span>
    <span class="hljs-keyword">CHECK</span> (birth_date <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">OR</span>
           (hire_date - birth_date) &gt;= <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'16 years'</span>)
);
</div></code></pre>
<p><strong>4. Cross-Column Validation:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> promotions (
    promotion_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    promotion_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    start_date <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    end_date <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    discount_percentage <span class="hljs-built_in">INT</span>,
    discount_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),

    <span class="hljs-comment">-- Date validation</span>
    <span class="hljs-keyword">CHECK</span> (end_date &gt; start_date),

    <span class="hljs-comment">-- Either percentage OR amount discount, not both</span>
    <span class="hljs-keyword">CHECK</span> (
        (discount_percentage <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">AND</span> discount_amount <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">OR</span>
        (discount_percentage <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">AND</span> discount_amount <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>)
    ),

    <span class="hljs-comment">-- Percentage must be reasonable</span>
    <span class="hljs-keyword">CHECK</span> (discount_percentage <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">OR</span>
           discount_percentage <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">100</span>),

    <span class="hljs-comment">-- Amount must be positive</span>
    <span class="hljs-keyword">CHECK</span> (discount_amount <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">OR</span> discount_amount &gt; <span class="hljs-number">0</span>)
);
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%AB-not-null-constraints">ğŸš« NOT NULL Constraints</h2>
<h3 id="what-is-not-null">What is NOT NULL?</h3>
<p>Prevents empty (NULL) values in a column, ensuring required data is always present.</p>
<h3 id="not-null-examples">NOT NULL Examples</h3>
<p><strong>1. Required Fields:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customers (
    customer_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,        <span class="hljs-comment">-- Required</span>
    first_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,   <span class="hljs-comment">-- Required</span>
    last_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,    <span class="hljs-comment">-- Required</span>
    phone <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),                  <span class="hljs-comment">-- Optional</span>
    date_of_birth <span class="hljs-built_in">DATE</span>,                 <span class="hljs-comment">-- Optional</span>
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);
</div></code></pre>
<p><strong>2. Adding/Removing NOT NULL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Add NOT NULL to existing column (ensure no NULLs exist first)</span>
<span class="hljs-keyword">UPDATE</span> customers <span class="hljs-keyword">SET</span> phone = <span class="hljs-string">'Unknown'</span> <span class="hljs-keyword">WHERE</span> phone <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> customers <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">COLUMN</span> phone <span class="hljs-keyword">SET</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>;

<span class="hljs-comment">-- Remove NOT NULL constraint</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> customers <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">COLUMN</span> phone <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>;

<span class="hljs-comment">-- MySQL syntax</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> customers <span class="hljs-keyword">MODIFY</span> phone <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-literal">NULL</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-default-constraints">ğŸ¯ DEFAULT Constraints</h2>
<h3 id="what-is-default">What is DEFAULT?</h3>
<p>Provides automatic values when no value is specified during INSERT.</p>
<h3 id="default-examples">DEFAULT Examples</h3>
<p><strong>1. Common Defaults:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    order_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    customer_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    order_status <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'pending'</span>,
    payment_status <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'pending'</span>,
    order_date <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    total_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    currency <span class="hljs-built_in">CHAR</span>(<span class="hljs-number">3</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'USD'</span>,
    is_gift <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>,

    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (customer_id) <span class="hljs-keyword">REFERENCES</span> customers(customer_id)
);
</div></code></pre>
<p><strong>2. Function-based Defaults:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> audit_log (
    log_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    table_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">action</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    user_id <span class="hljs-built_in">INT</span>,
    <span class="hljs-built_in">timestamp</span> <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    date_only <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_DATE</span>,

    <span class="hljs-comment">-- PostgreSQL: Generate UUID</span>
    session_id <span class="hljs-keyword">UUID</span> <span class="hljs-keyword">DEFAULT</span> gen_random_uuid(),

    <span class="hljs-comment">-- MySQL: Generate UUID</span>
    <span class="hljs-comment">-- session_id CHAR(36) DEFAULT (UUID())</span>
);
</div></code></pre>
<p><strong>3. Computed Defaults:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- PostgreSQL: More advanced defaults</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    product_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    product_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    sku <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> (<span class="hljs-string">'SKU-'</span> || <span class="hljs-keyword">nextval</span>(<span class="hljs-string">'sku_sequence'</span>)),
    price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,

    <span class="hljs-comment">-- Generate slug from name (would need trigger for this)</span>
    slug <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>)
);
</div></code></pre>
<hr>
<h2 id="%F0%9F%92%A1-real-world-constraint-examples">ğŸ’¡ Real-World Constraint Examples</h2>
<h3 id="example-1-e-commerce-product-catalog">Example 1: E-commerce Product Catalog</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    <span class="hljs-comment">-- Primary key</span>
    product_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,

    <span class="hljs-comment">-- Required fields with constraints</span>
    sku <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">UNIQUE</span>,
    product_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,

    <span class="hljs-comment">-- Price validation</span>
    price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">CHECK</span> (price &gt; <span class="hljs-number">0</span>),
    cost_price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">CHECK</span> (cost_price <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">OR</span> cost_price &gt;= <span class="hljs-number">0</span>),

    <span class="hljs-comment">-- Stock management</span>
    stock_quantity <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> <span class="hljs-keyword">CHECK</span> (stock_quantity &gt;= <span class="hljs-number">0</span>),
    min_stock_level <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> <span class="hljs-keyword">CHECK</span> (min_stock_level &gt;= <span class="hljs-number">0</span>),
    max_stock_level <span class="hljs-built_in">INT</span> <span class="hljs-keyword">CHECK</span> (max_stock_level <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">OR</span> max_stock_level &gt;= min_stock_level),

    <span class="hljs-comment">-- Category relationship</span>
    category_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (category_id) <span class="hljs-keyword">REFERENCES</span> categories(category_id)
        <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> RESTRICT,

    <span class="hljs-comment">-- Product attributes</span>
    weight <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">8</span>,<span class="hljs-number">3</span>) <span class="hljs-keyword">CHECK</span> (weight <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">OR</span> weight &gt; <span class="hljs-number">0</span>),
    dimensions <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),

    <span class="hljs-comment">-- Status and flags</span>
    <span class="hljs-keyword">status</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'active'</span>
        <span class="hljs-keyword">CHECK</span> (<span class="hljs-keyword">status</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'active'</span>, <span class="hljs-string">'inactive'</span>, <span class="hljs-string">'discontinued'</span>)),
    is_featured <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>,
    is_digital <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>,

    <span class="hljs-comment">-- Audit fields</span>
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    updated_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    created_by <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (created_by) <span class="hljs-keyword">REFERENCES</span> <span class="hljs-keyword">users</span>(user_id),

    <span class="hljs-comment">-- Business rules</span>
    <span class="hljs-keyword">CHECK</span> (cost_price <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">OR</span> cost_price &lt;= price),
    <span class="hljs-keyword">CHECK</span> (<span class="hljs-keyword">NOT</span> (is_digital = <span class="hljs-literal">TRUE</span> <span class="hljs-keyword">AND</span> weight <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>))
);
</div></code></pre>
<h3 id="example-2-user-management-system">Example 2: User Management System</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> (
    <span class="hljs-comment">-- Primary key</span>
    user_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,

    <span class="hljs-comment">-- Authentication (required, unique)</span>
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">UNIQUE</span>
        <span class="hljs-keyword">CHECK</span> (email ~* <span class="hljs-string">'^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'</span>),
    username <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">UNIQUE</span>
        <span class="hljs-keyword">CHECK</span> (<span class="hljs-keyword">LENGTH</span>(username) &gt;= <span class="hljs-number">3</span> <span class="hljs-keyword">AND</span> username ~ <span class="hljs-string">'^[a-zA-Z0-9_]+$'</span>),
    password_hash <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,

    <span class="hljs-comment">-- Profile information</span>
    first_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">CHECK</span> (<span class="hljs-keyword">LENGTH</span>(<span class="hljs-keyword">TRIM</span>(first_name)) &gt; <span class="hljs-number">0</span>),
    last_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">CHECK</span> (<span class="hljs-keyword">LENGTH</span>(<span class="hljs-keyword">TRIM</span>(last_name)) &gt; <span class="hljs-number">0</span>),
    date_of_birth <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">CHECK</span> (date_of_birth &lt; <span class="hljs-keyword">CURRENT_DATE</span>),
    phone <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">CHECK</span> (phone ~ <span class="hljs-string">'^\+?[1-9]\d{1,14}$'</span>),

    <span class="hljs-comment">-- Account settings</span>
    <span class="hljs-keyword">role</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'user'</span>
        <span class="hljs-keyword">CHECK</span> (<span class="hljs-keyword">role</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'admin'</span>, <span class="hljs-string">'moderator'</span>, <span class="hljs-string">'user'</span>, <span class="hljs-string">'guest'</span>)),
    <span class="hljs-keyword">status</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'active'</span>
        <span class="hljs-keyword">CHECK</span> (<span class="hljs-keyword">status</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'active'</span>, <span class="hljs-string">'inactive'</span>, <span class="hljs-string">'suspended'</span>, <span class="hljs-string">'deleted'</span>)),

    <span class="hljs-comment">-- Verification and security</span>
    email_verified <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>,
    phone_verified <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>,
    two_factor_enabled <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>,

    <span class="hljs-comment">-- Audit trail</span>
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    updated_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    last_login <span class="hljs-built_in">TIMESTAMP</span>,
    login_count <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> <span class="hljs-keyword">CHECK</span> (login_count &gt;= <span class="hljs-number">0</span>),

    <span class="hljs-comment">-- Age validation (must be at least 13)</span>
    <span class="hljs-keyword">CHECK</span> (date_of_birth <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">OR</span>
           (<span class="hljs-keyword">CURRENT_DATE</span> - date_of_birth) &gt;= <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'13 years'</span>)
);
</div></code></pre>
<h3 id="example-3-financial-transactions">Example 3: Financial Transactions</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> transactions (
    <span class="hljs-comment">-- Primary key</span>
    transaction_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,

    <span class="hljs-comment">-- Transaction reference</span>
    reference_number <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">UNIQUE</span>,

    <span class="hljs-comment">-- Account relationships</span>
    from_account_id <span class="hljs-built_in">BIGINT</span>,
    to_account_id <span class="hljs-built_in">BIGINT</span>,
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (from_account_id) <span class="hljs-keyword">REFERENCES</span> accounts(account_id),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (to_account_id) <span class="hljs-keyword">REFERENCES</span> accounts(account_id),

    <span class="hljs-comment">-- Amount and currency</span>
    amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">15</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">CHECK</span> (amount &gt; <span class="hljs-number">0</span>),
    currency <span class="hljs-built_in">CHAR</span>(<span class="hljs-number">3</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'USD'</span>
        <span class="hljs-keyword">CHECK</span> (currency ~ <span class="hljs-string">'^[A-Z]{3}$'</span>),

    <span class="hljs-comment">-- Transaction details</span>
    transaction_type <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
        <span class="hljs-keyword">CHECK</span> (transaction_type <span class="hljs-keyword">IN</span> (<span class="hljs-string">'deposit'</span>, <span class="hljs-string">'withdrawal'</span>, <span class="hljs-string">'transfer'</span>, <span class="hljs-string">'fee'</span>, <span class="hljs-string">'interest'</span>)),
    <span class="hljs-keyword">status</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'pending'</span>
        <span class="hljs-keyword">CHECK</span> (<span class="hljs-keyword">status</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'pending'</span>, <span class="hljs-string">'processing'</span>, <span class="hljs-string">'completed'</span>, <span class="hljs-string">'failed'</span>, <span class="hljs-string">'cancelled'</span>)),

    <span class="hljs-comment">-- Descriptions and metadata</span>
    description <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    internal_notes <span class="hljs-built_in">TEXT</span>,

    <span class="hljs-comment">-- Timestamps</span>
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    processed_at <span class="hljs-built_in">TIMESTAMP</span>,

    <span class="hljs-comment">-- Business rules</span>
    <span class="hljs-keyword">CHECK</span> (
        <span class="hljs-comment">-- Transfer must have both accounts</span>
        (transaction_type = <span class="hljs-string">'transfer'</span> <span class="hljs-keyword">AND</span> from_account_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">AND</span> to_account_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">OR</span>
        <span class="hljs-comment">-- Deposit must have to_account</span>
        (transaction_type = <span class="hljs-string">'deposit'</span> <span class="hljs-keyword">AND</span> to_account_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">OR</span>
        <span class="hljs-comment">-- Withdrawal must have from_account</span>
        (transaction_type = <span class="hljs-string">'withdrawal'</span> <span class="hljs-keyword">AND</span> from_account_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">OR</span>
        <span class="hljs-comment">-- Fee can have either or both</span>
        (transaction_type <span class="hljs-keyword">IN</span> (<span class="hljs-string">'fee'</span>, <span class="hljs-string">'interest'</span>))
    ),

    <span class="hljs-comment">-- Cannot transfer to same account</span>
    <span class="hljs-keyword">CHECK</span> (from_account_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">OR</span> to_account_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">OR</span> from_account_id != to_account_id),

    <span class="hljs-comment">-- Processed timestamp only for completed transactions</span>
    <span class="hljs-keyword">CHECK</span> (<span class="hljs-keyword">status</span> != <span class="hljs-string">'completed'</span> <span class="hljs-keyword">OR</span> processed_at <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>)
);
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-use-cases--interview-tips">ğŸ¯ Use Cases &amp; Interview Tips</h2>
<h3 id="common-interview-questions">Common Interview Questions:</h3>
<ol>
<li>
<p><strong>&quot;What's the difference between PRIMARY KEY and UNIQUE?&quot;</strong></p>
<ul>
<li>PRIMARY KEY: One per table, cannot be NULL, creates clustered index</li>
<li>UNIQUE: Multiple per table, can have one NULL, creates non-clustered index</li>
<li>Both ensure uniqueness, but PRIMARY KEY has additional restrictions</li>
</ul>
</li>
<li>
<p><strong>&quot;When would you use CASCADE vs RESTRICT for foreign keys?&quot;</strong></p>
<ul>
<li>CASCADE: When child records should be deleted with parent (order_items with orders)</li>
<li>RESTRICT: When you want to prevent accidental deletion (customers with orders)</li>
<li>SET NULL: When relationship is optional (manager_id when manager is deleted)</li>
</ul>
</li>
<li>
<p><strong>&quot;How do you enforce business rules in the database?&quot;</strong></p>
<ul>
<li>CHECK constraints for validation rules</li>
<li>FOREIGN KEY constraints for referential integrity</li>
<li>UNIQUE constraints for business uniqueness</li>
<li>NOT NULL for required fields</li>
<li>Triggers for complex logic</li>
</ul>
</li>
</ol>
<h3 id="best-practices">Best Practices:</h3>
<ol>
<li>
<p><strong>Name Your Constraints:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Good: Named constraints are easier to manage</span>
CONSTRAINT pk_customers PRIMARY KEY (customer_id),
CONSTRAINT fk_orders_customer FOREIGN KEY (customer_id) REFERENCES customers(customer_id),
CONSTRAINT uk_customers_email UNIQUE (email),
CONSTRAINT chk_products_price <span class="hljs-keyword">CHECK</span> (price &gt; <span class="hljs-number">0</span>)
</div></code></pre>
</li>
<li>
<p><strong>Use Appropriate Data Types:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Good: Specific types with constraints</span>
email VARCHAR(255) NOT NULL <span class="hljs-keyword">CHECK</span> (email <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%@%'</span>),
<span class="hljs-keyword">status</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">CHECK</span> (<span class="hljs-keyword">status</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'active'</span>, <span class="hljs-string">'inactive'</span>)),

<span class="hljs-comment">-- Avoid: Generic types without validation</span>
email <span class="hljs-built_in">TEXT</span>,
<span class="hljs-keyword">status</span> <span class="hljs-built_in">TEXT</span>
</div></code></pre>
</li>
<li>
<p><strong>Document Business Rules:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    order_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    total_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,

    <span class="hljs-comment">-- Business rule: Orders must be at least $1</span>
    <span class="hljs-keyword">CONSTRAINT</span> chk_orders_min_amount <span class="hljs-keyword">CHECK</span> (total_amount &gt;= <span class="hljs-number">1.00</span>)
);
</div></code></pre>
</li>
</ol>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-things-to-watch-out-for">âš ï¸ Things to Watch Out For</h2>
<h3 id="1-constraint-naming-conflicts">1. <strong>Constraint Naming Conflicts</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Bad: Generic constraint names</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,  <span class="hljs-comment">-- Creates generic name</span>
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">UNIQUE</span>  <span class="hljs-comment">-- Creates generic name</span>
);

<span class="hljs-comment">-- Good: Explicit constraint names</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span>,
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    <span class="hljs-keyword">CONSTRAINT</span> pk_users PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-keyword">id</span>),
    <span class="hljs-keyword">CONSTRAINT</span> uk_users_email <span class="hljs-keyword">UNIQUE</span> (email)
);
</div></code></pre>
<h3 id="2-foreign-key-performance">2. <strong>Foreign Key Performance</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Ensure foreign key columns are indexed</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    order_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    customer_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (customer_id) <span class="hljs-keyword">REFERENCES</span> customers(customer_id)
);

<span class="hljs-comment">-- Add index for better performance</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_orders_customer_id <span class="hljs-keyword">ON</span> orders(customer_id);
</div></code></pre>
<h3 id="3-check-constraint-limitations">3. <strong>CHECK Constraint Limitations</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL: CHECK constraints ignored in older versions</span>
<span class="hljs-comment">-- Always test your constraints!</span>

<span class="hljs-comment">-- PostgreSQL: Cannot reference other tables in CHECK</span>
<span class="hljs-comment">-- This won't work:</span>
<span class="hljs-keyword">CHECK</span> (category_id <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> category_id <span class="hljs-keyword">FROM</span> categories))

<span class="hljs-comment">-- Use foreign key instead:</span>
<span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (category_id) <span class="hljs-keyword">REFERENCES</span> categories(category_id)
</div></code></pre>
<h3 id="4-circular-foreign-key-references">4. <strong>Circular Foreign Key References</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Circular dependency</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> departments (
    dept_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    manager_id <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (manager_id) <span class="hljs-keyword">REFERENCES</span> employees(employee_id)
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> employees (
    employee_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    dept_id <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (dept_id) <span class="hljs-keyword">REFERENCES</span> departments(dept_id)
);

<span class="hljs-comment">-- Solution: Create tables first, add constraints later</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> departments (
    dept_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    manager_id <span class="hljs-built_in">INT</span>
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> employees (
    employee_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    dept_id <span class="hljs-built_in">INT</span>
);

<span class="hljs-comment">-- Add foreign keys after both tables exist</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> departments
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (manager_id) <span class="hljs-keyword">REFERENCES</span> employees(employee_id);

<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> employees
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (dept_id) <span class="hljs-keyword">REFERENCES</span> departments(dept_id);
</div></code></pre>
<h3 id="5-constraint-violation-handling">5. <strong>Constraint Violation Handling</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Handle constraint violations gracefully in application code</span>

<span class="hljs-comment">-- PostgreSQL: Use ON CONFLICT</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customers (email, first_name, last_name)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'john@email.com'</span>, <span class="hljs-string">'John'</span>, <span class="hljs-string">'Doe'</span>)
<span class="hljs-keyword">ON</span> CONFLICT (email) <span class="hljs-keyword">DO</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">SET</span>
    first_name = EXCLUDED.first_name,
    last_name = EXCLUDED.last_name;

<span class="hljs-comment">-- MySQL: Use ON DUPLICATE KEY UPDATE</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customers (email, first_name, last_name)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'john@email.com'</span>, <span class="hljs-string">'John'</span>, <span class="hljs-string">'Doe'</span>)
<span class="hljs-keyword">ON</span> <span class="hljs-keyword">DUPLICATE</span> <span class="hljs-keyword">KEY</span> <span class="hljs-keyword">UPDATE</span>
    first_name = <span class="hljs-keyword">VALUES</span>(first_name),
    last_name = <span class="hljs-keyword">VALUES</span>(last_name);
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%80-next-steps">ğŸš€ Next Steps</h2>
<p>In the next chapter, we'll explore <strong>Joins</strong> - one of the most powerful features of SQL that allows you to combine data from multiple tables. You'll learn about INNER, LEFT, RIGHT, and FULL joins, and how to write complex queries that span multiple tables.</p>
<hr>
<h2 id="%F0%9F%93%9D-quick-practice">ğŸ“ Quick Practice</h2>
<p>Design constraints for a social media platform:</p>
<ol>
<li><strong>Users table</strong>: Email must be unique and valid format, username 3-50 characters, age must be 13+</li>
<li><strong>Posts table</strong>: Content cannot be empty, status must be 'draft', 'published', or 'deleted'</li>
<li><strong>Followers table</strong>: User cannot follow themselves, combination of follower_id + following_id must be unique</li>
<li><strong>Comments table</strong>: Must reference valid post and user, content length 1-1000 characters</li>
</ol>
<p>Consider:</p>
<ul>
<li>What happens when a user is deleted?</li>
<li>How do you prevent spam or invalid data?</li>
<li>What business rules need to be enforced?</li>
</ul>
<h1 id="%F0%9F%93%98-chapter-6-where-group-by-having-order-by">ğŸ“˜ Chapter 6: WHERE, GROUP BY, HAVING, ORDER BY</h1>
<h2 id="%F0%9F%8E%AF-what-youll-learn">ğŸ¯ What You'll Learn</h2>
<ul>
<li>Filtering data with WHERE clauses</li>
<li>Grouping data with GROUP BY</li>
<li>Filtering groups with HAVING</li>
<li>Sorting results with ORDER BY</li>
<li>Combining these clauses effectively</li>
<li>Performance considerations and best practices</li>
</ul>
<hr>
<h2 id="%F0%9F%93%96-concept-explanation">ğŸ“– Concept Explanation</h2>
<p>These four clauses are the backbone of data retrieval in SQL. They work together to filter, group, aggregate, and sort your data:</p>
<ul>
<li><strong>WHERE</strong>: Filters individual rows before grouping</li>
<li><strong>GROUP BY</strong>: Groups rows that share common values</li>
<li><strong>HAVING</strong>: Filters groups after aggregation</li>
<li><strong>ORDER BY</strong>: Sorts the final result set</li>
</ul>
<h3 id="sql-query-execution-order">SQL Query Execution Order:</h3>
<pre class="hljs"><code><div>1. FROM       - Choose tables
2. WHERE      - Filter rows
3. GROUP BY   - Group rows
4. HAVING     - Filter groups
5. SELECT     - Choose columns
6. ORDER BY   - Sort results
7. LIMIT      - Limit results
</div></code></pre>
<p>Understanding this order is crucial for writing effective queries!</p>
<hr>
<h2 id="%F0%9F%94%8D-where-clause---filtering-rows">ğŸ” WHERE Clause - Filtering Rows</h2>
<h3 id="basic-where-syntax">Basic WHERE Syntax</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">columns</span>
<span class="hljs-keyword">FROM</span> <span class="hljs-keyword">table</span>
<span class="hljs-keyword">WHERE</span> condition;
</div></code></pre>
<h3 id="comparison-operators">Comparison Operators</h3>
<p><strong>1. Basic Comparisons:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Equality and inequality</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> price = <span class="hljs-number">29.99</span>;
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> price != <span class="hljs-number">29.99</span>;  <span class="hljs-comment">-- or &lt;&gt;</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> price &gt; <span class="hljs-number">50</span>;
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> price &lt;= <span class="hljs-number">100</span>;
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> stock_quantity &gt;= <span class="hljs-number">10</span>;

<span class="hljs-comment">-- Date comparisons</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> order_date = <span class="hljs-string">'2024-01-15'</span>;
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> order_date &gt; <span class="hljs-string">'2024-01-01'</span>;
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> hire_date &lt; <span class="hljs-string">'2020-01-01'</span>;
</div></code></pre>
<p><strong>2. Range Conditions:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- BETWEEN (inclusive)</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> price <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">10</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">50</span>;

<span class="hljs-comment">-- Equivalent to:</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> price &gt;= <span class="hljs-number">10</span> <span class="hljs-keyword">AND</span> price &lt;= <span class="hljs-number">50</span>;

<span class="hljs-comment">-- Date ranges</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> order_date <span class="hljs-keyword">BETWEEN</span> <span class="hljs-string">'2024-01-01'</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">'2024-12-31'</span>;

<span class="hljs-comment">-- NOT BETWEEN</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> price <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">10</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">50</span>;
</div></code></pre>
<p><strong>3. List Conditions:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- IN operator</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> category_id <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>);

<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'pending'</span>, <span class="hljs-string">'processing'</span>, <span class="hljs-string">'shipped'</span>);

<span class="hljs-comment">-- NOT IN</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> category_id <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>);

<span class="hljs-comment">-- IN with subquery</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> category_id <span class="hljs-keyword">IN</span> (
    <span class="hljs-keyword">SELECT</span> category_id
    <span class="hljs-keyword">FROM</span> categories
    <span class="hljs-keyword">WHERE</span> category_name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%Electronics%'</span>
);
</div></code></pre>
<p><strong>4. Pattern Matching:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- LIKE with wildcards</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> first_name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'John%'</span>;     <span class="hljs-comment">-- Starts with 'John'</span>

<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> email <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%@gmail.com'</span>;    <span class="hljs-comment">-- Ends with '@gmail.com'</span>

<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> product_name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%phone%'</span>; <span class="hljs-comment">-- Contains 'phone'</span>

<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> phone <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'555-____'</span>;       <span class="hljs-comment">-- _ matches single character</span>

<span class="hljs-comment">-- Case-insensitive search (PostgreSQL)</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> first_name <span class="hljs-keyword">ILIKE</span> <span class="hljs-string">'john%'</span>;

<span class="hljs-comment">-- Regular expressions (PostgreSQL)</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> email ~ <span class="hljs-string">'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'</span>;

<span class="hljs-comment">-- MySQL regular expressions</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> email REGEXP <span class="hljs-string">'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'</span>;
</div></code></pre>
<p><strong>5. NULL Handling:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Check for NULL values</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">WHERE</span> phone <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>;
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">WHERE</span> phone <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>;

<span class="hljs-comment">-- NULL in comparisons (always returns NULL/false)</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> description = <span class="hljs-literal">NULL</span>;     <span class="hljs-comment">-- Wrong! Returns no rows</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> description <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>;    <span class="hljs-comment">-- Correct!</span>

<span class="hljs-comment">-- COALESCE for NULL handling</span>
<span class="hljs-keyword">SELECT</span> customer_id,
       <span class="hljs-keyword">COALESCE</span>(phone, <span class="hljs-string">'No phone'</span>) <span class="hljs-keyword">as</span> contact_phone
<span class="hljs-keyword">FROM</span> customers;
</div></code></pre>
<h3 id="logical-operators">Logical Operators</h3>
<p><strong>1. AND, OR, NOT:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- AND: All conditions must be true</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> price &gt; <span class="hljs-number">10</span> <span class="hljs-keyword">AND</span> price &lt; <span class="hljs-number">100</span> <span class="hljs-keyword">AND</span> stock_quantity &gt; <span class="hljs-number">0</span>;

<span class="hljs-comment">-- OR: At least one condition must be true</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'shipped'</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'delivered'</span>;

<span class="hljs-comment">-- NOT: Negates the condition</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">NOT</span> (first_name = <span class="hljs-string">'John'</span> <span class="hljs-keyword">AND</span> last_name = <span class="hljs-string">'Doe'</span>);

<span class="hljs-comment">-- Complex combinations with parentheses</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> (category_id = <span class="hljs-number">1</span> <span class="hljs-keyword">OR</span> category_id = <span class="hljs-number">2</span>)
  <span class="hljs-keyword">AND</span> price &gt; <span class="hljs-number">50</span>
  <span class="hljs-keyword">AND</span> stock_quantity &gt; <span class="hljs-number">0</span>;
</div></code></pre>
<p><strong>2. Operator Precedence:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Without parentheses (AND has higher precedence)</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> category_id = <span class="hljs-number">1</span> <span class="hljs-keyword">OR</span> category_id = <span class="hljs-number">2</span> <span class="hljs-keyword">AND</span> price &gt; <span class="hljs-number">50</span>;
<span class="hljs-comment">-- Equivalent to: category_id = 1 OR (category_id = 2 AND price &gt; 50)</span>

<span class="hljs-comment">-- With parentheses (clearer intent)</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> (category_id = <span class="hljs-number">1</span> <span class="hljs-keyword">OR</span> category_id = <span class="hljs-number">2</span>) <span class="hljs-keyword">AND</span> price &gt; <span class="hljs-number">50</span>;
</div></code></pre>
<h3 id="real-world-where-examples">Real-World WHERE Examples</h3>
<p><strong>1. E-commerce Product Search:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Find available products in specific categories with good ratings</span>
<span class="hljs-keyword">SELECT</span> product_id, product_name, price, average_rating
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> category_id <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>)           <span class="hljs-comment">-- Electronics, Books, Clothing</span>
  <span class="hljs-keyword">AND</span> stock_quantity &gt; <span class="hljs-number">0</span>                  <span class="hljs-comment">-- In stock</span>
  <span class="hljs-keyword">AND</span> price <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">10</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">500</span>           <span class="hljs-comment">-- Price range</span>
  <span class="hljs-keyword">AND</span> average_rating &gt;= <span class="hljs-number">4.0</span>              <span class="hljs-comment">-- Good ratings</span>
  <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>                  <span class="hljs-comment">-- Active products</span>
  <span class="hljs-keyword">AND</span> (discount_percentage &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">OR</span> is_featured = <span class="hljs-literal">true</span>); <span class="hljs-comment">-- On sale or featured</span>
</div></code></pre>
<p><strong>2. Customer Segmentation:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Find high-value customers for marketing campaign</span>
<span class="hljs-keyword">SELECT</span> customer_id, email, first_name, last_name, total_spent
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> total_spent &gt; <span class="hljs-number">1000</span>                 <span class="hljs-comment">-- High spenders</span>
  <span class="hljs-keyword">AND</span> last_order_date &gt; <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'90 days'</span>  <span class="hljs-comment">-- Recent activity</span>
  <span class="hljs-keyword">AND</span> email_verified = <span class="hljs-literal">true</span>              <span class="hljs-comment">-- Verified email</span>
  <span class="hljs-keyword">AND</span> marketing_consent = <span class="hljs-literal">true</span>           <span class="hljs-comment">-- Opted in for marketing</span>
  <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>                  <span class="hljs-comment">-- Active account</span>
  <span class="hljs-keyword">AND</span> country <span class="hljs-keyword">IN</span> (<span class="hljs-string">'US'</span>, <span class="hljs-string">'CA'</span>, <span class="hljs-string">'UK'</span>);     <span class="hljs-comment">-- Specific regions</span>
</div></code></pre>
<p><strong>3. Order Analysis:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Find problematic orders that need attention</span>
<span class="hljs-keyword">SELECT</span> order_id, customer_id, order_date, total_amount, <span class="hljs-keyword">status</span>
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> (
    <span class="hljs-comment">-- Old pending orders</span>
    (<span class="hljs-keyword">status</span> = <span class="hljs-string">'pending'</span> <span class="hljs-keyword">AND</span> order_date &lt; <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 days'</span>)
    <span class="hljs-keyword">OR</span>
    <span class="hljs-comment">-- High-value failed orders</span>
    (<span class="hljs-keyword">status</span> = <span class="hljs-string">'failed'</span> <span class="hljs-keyword">AND</span> total_amount &gt; <span class="hljs-number">500</span>)
    <span class="hljs-keyword">OR</span>
    <span class="hljs-comment">-- Shipped orders without tracking</span>
    (<span class="hljs-keyword">status</span> = <span class="hljs-string">'shipped'</span> <span class="hljs-keyword">AND</span> tracking_number <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>)
  )
  <span class="hljs-keyword">AND</span> order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'30 days'</span>; <span class="hljs-comment">-- Last 30 days only</span>
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%8A-group-by-clause---grouping-data">ğŸ“Š GROUP BY Clause - Grouping Data</h2>
<h3 id="basic-group-by-syntax">Basic GROUP BY Syntax</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">SELECT</span> column1, aggregate_function(column2)
<span class="hljs-keyword">FROM</span> <span class="hljs-keyword">table</span>
<span class="hljs-keyword">WHERE</span> condition
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> column1;
</div></code></pre>
<h3 id="simple-grouping">Simple Grouping</h3>
<p><strong>1. Basic Grouping:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Count customers by country</span>
<span class="hljs-keyword">SELECT</span> country, <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> customer_count
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> country;

<span class="hljs-comment">-- Average order value by customer</span>
<span class="hljs-keyword">SELECT</span> customer_id, <span class="hljs-keyword">AVG</span>(total_amount) <span class="hljs-keyword">as</span> avg_order_value
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id;

<span class="hljs-comment">-- Total sales by product category</span>
<span class="hljs-keyword">SELECT</span> c.category_name, <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">as</span> total_sales
<span class="hljs-keyword">FROM</span> categories c
<span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> c.category_id = p.category_id
<span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> p.product_id = oi.product_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.category_id, c.category_name;
</div></code></pre>
<p><strong>2. Multiple Column Grouping:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Sales by category and month</span>
<span class="hljs-keyword">SELECT</span>
    c.category_name,
    <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> o.order_date) <span class="hljs-keyword">as</span> <span class="hljs-keyword">year</span>,
    <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> o.order_date) <span class="hljs-keyword">as</span> <span class="hljs-keyword">month</span>,
    <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">as</span> monthly_sales,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.order_id) <span class="hljs-keyword">as</span> order_count
<span class="hljs-keyword">FROM</span> categories c
<span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> c.category_id = p.category_id
<span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> p.product_id = oi.product_id
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.category_name, <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> o.order_date), <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> o.order_date)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">year</span>, <span class="hljs-keyword">month</span>, category_name;

<span class="hljs-comment">-- Customer behavior by country and age group</span>
<span class="hljs-keyword">SELECT</span>
    country,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> age(date_of_birth)) &lt; <span class="hljs-number">25</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'18-24'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> age(date_of_birth)) &lt; <span class="hljs-number">35</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'25-34'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> age(date_of_birth)) &lt; <span class="hljs-number">45</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'35-44'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> age(date_of_birth)) &lt; <span class="hljs-number">55</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'45-54'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'55+'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> age_group,
    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> customer_count,
    <span class="hljs-keyword">AVG</span>(total_spent) <span class="hljs-keyword">as</span> avg_spent
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> date_of_birth <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> country, age_group
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> country, age_group;
</div></code></pre>
<h3 id="advanced-grouping">Advanced Grouping</h3>
<p><strong>1. Grouping with Expressions:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Sales by quarter</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> order_date) <span class="hljs-keyword">as</span> <span class="hljs-keyword">year</span>,
    <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">QUARTER</span> <span class="hljs-keyword">FROM</span> order_date) <span class="hljs-keyword">as</span> <span class="hljs-keyword">quarter</span>,
    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> order_count,
    <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">as</span> total_sales,
    <span class="hljs-keyword">AVG</span>(total_amount) <span class="hljs-keyword">as</span> avg_order_value
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> order_date &gt;= <span class="hljs-string">'2024-01-01'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> order_date), <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">QUARTER</span> <span class="hljs-keyword">FROM</span> order_date)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">year</span>, <span class="hljs-keyword">quarter</span>;

<span class="hljs-comment">-- Product performance by price range</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> price &lt; <span class="hljs-number">25</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Budget ($0-$24)'</span>
        <span class="hljs-keyword">WHEN</span> price &lt; <span class="hljs-number">100</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Mid-range ($25-$99)'</span>
        <span class="hljs-keyword">WHEN</span> price &lt; <span class="hljs-number">500</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Premium ($100-$499)'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Luxury ($500+)'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> price_category,
    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> product_count,
    <span class="hljs-keyword">AVG</span>(average_rating) <span class="hljs-keyword">as</span> avg_rating,
    <span class="hljs-keyword">SUM</span>(units_sold) <span class="hljs-keyword">as</span> total_units_sold
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> price_category
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">MIN</span>(price);
</div></code></pre>
<p><strong>2. Grouping Sets (PostgreSQL):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Multiple grouping levels in one query</span>
<span class="hljs-keyword">SELECT</span>
    category_id,
    <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> order_date) <span class="hljs-keyword">as</span> <span class="hljs-keyword">year</span>,
    <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">as</span> total_sales
<span class="hljs-keyword">FROM</span> orders o
<span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> o.order_id = oi.order_id
<span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> oi.product_id = p.product_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">GROUPING</span> <span class="hljs-keyword">SETS</span> (
    (category_id, <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> order_date)),  <span class="hljs-comment">-- By category and year</span>
    (category_id),                                  <span class="hljs-comment">-- By category only</span>
    (<span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> order_date)),               <span class="hljs-comment">-- By year only</span>
    ()                                             <span class="hljs-comment">-- Grand total</span>
)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> category_id, <span class="hljs-keyword">year</span>;
</div></code></pre>
<p><strong>3. ROLLUP and CUBE (PostgreSQL):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- ROLLUP: Hierarchical subtotals</span>
<span class="hljs-keyword">SELECT</span>
    country,
    state,
    city,
    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> customer_count
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">ROLLUP</span>(country, state, city)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> country, state, city;

<span class="hljs-comment">-- CUBE: All possible combinations</span>
<span class="hljs-keyword">SELECT</span>
    category_id,
    <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> order_date) <span class="hljs-keyword">as</span> <span class="hljs-keyword">year</span>,
    <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">QUARTER</span> <span class="hljs-keyword">FROM</span> order_date) <span class="hljs-keyword">as</span> <span class="hljs-keyword">quarter</span>,
    <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">as</span> total_sales
<span class="hljs-keyword">FROM</span> orders o
<span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> o.order_id = oi.order_id
<span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> oi.product_id = p.product_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">CUBE</span>(category_id, <span class="hljs-keyword">year</span>, <span class="hljs-keyword">quarter</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> category_id, <span class="hljs-keyword">year</span>, <span class="hljs-keyword">quarter</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-having-clause---filtering-groups">ğŸ¯ HAVING Clause - Filtering Groups</h2>
<h3 id="basic-having-syntax">Basic HAVING Syntax</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">SELECT</span> column1, aggregate_function(column2)
<span class="hljs-keyword">FROM</span> <span class="hljs-keyword">table</span>
<span class="hljs-keyword">WHERE</span> condition
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> column1
<span class="hljs-keyword">HAVING</span> aggregate_condition;
</div></code></pre>
<h3 id="having-vs-where">HAVING vs WHERE</h3>
<ul>
<li><strong>WHERE</strong>: Filters rows before grouping</li>
<li><strong>HAVING</strong>: Filters groups after aggregation</li>
</ul>
<h3 id="having-examples">HAVING Examples</h3>
<p><strong>1. Basic HAVING:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Customers with more than 5 orders</span>
<span class="hljs-keyword">SELECT</span> customer_id, <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> order_count
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(*) &gt; <span class="hljs-number">5</span>;

<span class="hljs-comment">-- Categories with average product price &gt; $50</span>
<span class="hljs-keyword">SELECT</span> category_id, <span class="hljs-keyword">AVG</span>(price) <span class="hljs-keyword">as</span> avg_price
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> category_id
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">AVG</span>(price) &gt; <span class="hljs-number">50</span>;

<span class="hljs-comment">-- Countries with total sales &gt; $10,000</span>
<span class="hljs-keyword">SELECT</span>
    c.country,
    <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> total_sales,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> c.customer_id) <span class="hljs-keyword">as</span> customer_count
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.country
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">SUM</span>(o.total_amount) &gt; <span class="hljs-number">10000</span>;
</div></code></pre>
<p><strong>2. Complex HAVING Conditions:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- High-value customer segments</span>
<span class="hljs-keyword">SELECT</span>
    customer_id,
    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> order_count,
    <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">as</span> total_spent,
    <span class="hljs-keyword">AVG</span>(total_amount) <span class="hljs-keyword">as</span> avg_order_value
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'1 year'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(*) &gt;= <span class="hljs-number">3</span>                    <span class="hljs-comment">-- At least 3 orders</span>
   <span class="hljs-keyword">AND</span> <span class="hljs-keyword">SUM</span>(total_amount) &gt; <span class="hljs-number">500</span>          <span class="hljs-comment">-- Spent more than $500</span>
   <span class="hljs-keyword">AND</span> <span class="hljs-keyword">AVG</span>(total_amount) &gt; <span class="hljs-number">50</span>;          <span class="hljs-comment">-- Average order &gt; $50</span>

<span class="hljs-comment">-- Product categories with consistent sales</span>
<span class="hljs-keyword">SELECT</span>
    c.category_name,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> o.order_date)) <span class="hljs-keyword">as</span> active_months,
    <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">as</span> total_sales,
    <span class="hljs-keyword">STDDEV</span>(monthly_sales.sales) <span class="hljs-keyword">as</span> sales_variance
<span class="hljs-keyword">FROM</span> categories c
<span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> c.category_id = p.category_id
<span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> p.product_id = oi.product_id
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
<span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span>
        p2.category_id,
        <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> o2.order_date) <span class="hljs-keyword">as</span> <span class="hljs-keyword">month</span>,
        <span class="hljs-keyword">SUM</span>(oi2.quantity * oi2.unit_price) <span class="hljs-keyword">as</span> sales
    <span class="hljs-keyword">FROM</span> products p2
    <span class="hljs-keyword">JOIN</span> order_items oi2 <span class="hljs-keyword">ON</span> p2.product_id = oi2.product_id
    <span class="hljs-keyword">JOIN</span> orders o2 <span class="hljs-keyword">ON</span> oi2.order_id = o2.order_id
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> p2.category_id, <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> o2.order_date)
) monthly_sales <span class="hljs-keyword">ON</span> c.category_id = monthly_sales.category_id
<span class="hljs-keyword">WHERE</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'1 year'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.category_id, c.category_name
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> o.order_date)) &gt;= <span class="hljs-number">6</span>  <span class="hljs-comment">-- Active in 6+ months</span>
   <span class="hljs-keyword">AND</span> <span class="hljs-keyword">STDDEV</span>(monthly_sales.sales) &lt; <span class="hljs-number">1000</span>;                    <span class="hljs-comment">-- Low variance</span>
</div></code></pre>
<p><strong>3. HAVING with Subqueries:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Categories performing above average</span>
<span class="hljs-keyword">SELECT</span>
    c.category_name,
    <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">as</span> category_sales
<span class="hljs-keyword">FROM</span> categories c
<span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> c.category_id = p.category_id
<span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> p.product_id = oi.product_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.category_id, c.category_name
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) &gt; (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AVG</span>(category_total)
    <span class="hljs-keyword">FROM</span> (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">SUM</span>(oi2.quantity * oi2.unit_price) <span class="hljs-keyword">as</span> category_total
        <span class="hljs-keyword">FROM</span> categories c2
        <span class="hljs-keyword">JOIN</span> products p2 <span class="hljs-keyword">ON</span> c2.category_id = p2.category_id
        <span class="hljs-keyword">JOIN</span> order_items oi2 <span class="hljs-keyword">ON</span> p2.product_id = oi2.product_id
        <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c2.category_id
    ) avg_calc
);
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%88-order-by-clause---sorting-results">ğŸ“ˆ ORDER BY Clause - Sorting Results</h2>
<h3 id="basic-order-by-syntax">Basic ORDER BY Syntax</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">columns</span>
<span class="hljs-keyword">FROM</span> <span class="hljs-keyword">table</span>
<span class="hljs-keyword">WHERE</span> condition
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">columns</span>
<span class="hljs-keyword">HAVING</span> condition
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> column1 [<span class="hljs-keyword">ASC</span>|<span class="hljs-keyword">DESC</span>], column2 [<span class="hljs-keyword">ASC</span>|<span class="hljs-keyword">DESC</span>];
</div></code></pre>
<h3 id="sorting-options">Sorting Options</h3>
<p><strong>1. Basic Sorting:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Single column sorting</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> price;           <span class="hljs-comment">-- Ascending (default)</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> price <span class="hljs-keyword">ASC</span>;      <span class="hljs-comment">-- Explicit ascending</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> price <span class="hljs-keyword">DESC</span>;     <span class="hljs-comment">-- Descending</span>

<span class="hljs-comment">-- Multiple column sorting</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> country <span class="hljs-keyword">ASC</span>, last_name <span class="hljs-keyword">ASC</span>, first_name <span class="hljs-keyword">ASC</span>;

<span class="hljs-comment">-- Mixed sorting directions</span>
<span class="hljs-keyword">SELECT</span> product_name, price, average_rating
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> average_rating <span class="hljs-keyword">DESC</span>, price <span class="hljs-keyword">ASC</span>;
</div></code></pre>
<p><strong>2. Sorting by Expressions:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Sort by calculated values</span>
<span class="hljs-keyword">SELECT</span>
    product_name,
    price,
    stock_quantity,
    (price * stock_quantity) <span class="hljs-keyword">as</span> inventory_value
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> (price * stock_quantity) <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Sort by string functions</span>
<span class="hljs-keyword">SELECT</span> first_name, last_name, email
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">LENGTH</span>(email) <span class="hljs-keyword">DESC</span>, email <span class="hljs-keyword">ASC</span>;

<span class="hljs-comment">-- Sort by date parts</span>
<span class="hljs-keyword">SELECT</span> order_id, order_date, total_amount
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> order_date), <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">DAY</span> <span class="hljs-keyword">FROM</span> order_date);
</div></code></pre>
<p><strong>3. Conditional Sorting:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Custom sort order with CASE</span>
<span class="hljs-keyword">SELECT</span> order_id, <span class="hljs-keyword">status</span>, order_date
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
    <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">status</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'urgent'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'processing'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">2</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'pending'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">3</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'shipped'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">4</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'delivered'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">5</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-number">6</span>
    <span class="hljs-keyword">END</span>,
    order_date <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Sort products by availability, then by rating</span>
<span class="hljs-keyword">SELECT</span> product_name, stock_quantity, average_rating
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
    <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> stock_quantity &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>,  <span class="hljs-comment">-- In stock first</span>
    average_rating <span class="hljs-keyword">DESC</span>,
    product_name <span class="hljs-keyword">ASC</span>;
</div></code></pre>
<p><strong>4. NULL Handling in Sorting:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- PostgreSQL: Control NULL position</span>
<span class="hljs-keyword">SELECT</span> customer_id, phone
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> phone <span class="hljs-keyword">NULLS</span> <span class="hljs-keyword">LAST</span>;   <span class="hljs-comment">-- NULLs at the end</span>

<span class="hljs-keyword">SELECT</span> customer_id, phone
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> phone <span class="hljs-keyword">NULLS</span> <span class="hljs-keyword">FIRST</span>;  <span class="hljs-comment">-- NULLs at the beginning</span>

<span class="hljs-comment">-- MySQL: Use ISNULL() or COALESCE()</span>
<span class="hljs-keyword">SELECT</span> customer_id, phone
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">ISNULL</span>(phone), phone;  <span class="hljs-comment">-- NULLs first</span>

<span class="hljs-keyword">SELECT</span> customer_id, phone
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">COALESCE</span>(phone, <span class="hljs-string">'ZZZZZ'</span>);  <span class="hljs-comment">-- Treat NULL as 'ZZZZZ'</span>
</div></code></pre>
<h3 id="advanced-sorting">Advanced Sorting</h3>
<p><strong>1. Sorting Aggregated Results:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Top customers by total spending</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">as</span> order_count,
    <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> total_spent
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_spent <span class="hljs-keyword">DESC</span> <span class="hljs-keyword">NULLS</span> <span class="hljs-keyword">LAST</span>, order_count <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Best selling products by category</span>
<span class="hljs-keyword">SELECT</span>
    c.category_name,
    p.product_name,
    <span class="hljs-keyword">SUM</span>(oi.quantity) <span class="hljs-keyword">as</span> total_sold,
    <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">as</span> total_revenue
<span class="hljs-keyword">FROM</span> categories c
<span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> c.category_id = p.category_id
<span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> p.product_id = oi.product_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.category_id, c.category_name, p.product_id, p.product_name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.category_name, total_revenue <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<p><strong>2. Window Function Sorting:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Rank products within each category by sales</span>
<span class="hljs-keyword">SELECT</span>
    c.category_name,
    p.product_name,
    <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">as</span> revenue,
    <span class="hljs-keyword">RANK</span>() <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> c.category_id
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">DESC</span>
    ) <span class="hljs-keyword">as</span> category_rank
<span class="hljs-keyword">FROM</span> categories c
<span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> c.category_id = p.category_id
<span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> p.product_id = oi.product_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.category_id, c.category_name, p.product_id, p.product_name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.category_name, category_rank;
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%84-combining-all-clauses">ğŸ”„ Combining All Clauses</h2>
<h3 id="complete-query-structure">Complete Query Structure</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">SELECT</span>
    <span class="hljs-comment">-- What to show</span>
    c.category_name,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> p.product_id) <span class="hljs-keyword">as</span> product_count,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.order_id) <span class="hljs-keyword">as</span> order_count,
    <span class="hljs-keyword">SUM</span>(oi.quantity) <span class="hljs-keyword">as</span> total_units_sold,
    <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">as</span> total_revenue,
    <span class="hljs-keyword">AVG</span>(oi.unit_price) <span class="hljs-keyword">as</span> avg_unit_price,
    <span class="hljs-keyword">MAX</span>(o.order_date) <span class="hljs-keyword">as</span> last_order_date
<span class="hljs-keyword">FROM</span> categories c
<span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> c.category_id = p.category_id
<span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> p.product_id = oi.product_id
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
<span class="hljs-keyword">WHERE</span>
    <span class="hljs-comment">-- Filter individual rows</span>
    o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'1 year'</span>  <span class="hljs-comment">-- Last year only</span>
    <span class="hljs-keyword">AND</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'shipped'</span>, <span class="hljs-string">'delivered'</span>)  <span class="hljs-comment">-- Successful orders</span>
    <span class="hljs-keyword">AND</span> p.status = <span class="hljs-string">'active'</span>                           <span class="hljs-comment">-- Active products</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
    <span class="hljs-comment">-- Group by category</span>
    c.category_id, c.category_name
<span class="hljs-keyword">HAVING</span>
    <span class="hljs-comment">-- Filter groups</span>
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.order_id) &gt;= <span class="hljs-number">10</span>                  <span class="hljs-comment">-- At least 10 orders</span>
    <span class="hljs-keyword">AND</span> <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) &gt; <span class="hljs-number">1000</span>      <span class="hljs-comment">-- Revenue &gt; $1000</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
    <span class="hljs-comment">-- Sort results</span>
    total_revenue <span class="hljs-keyword">DESC</span>,                               <span class="hljs-comment">-- Highest revenue first</span>
    product_count <span class="hljs-keyword">DESC</span>;                               <span class="hljs-comment">-- Then by product count</span>
</div></code></pre>
<h3 id="real-world-complex-examples">Real-World Complex Examples</h3>
<p><strong>1. Sales Performance Dashboard:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Monthly sales performance with growth metrics</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> o.order_date) <span class="hljs-keyword">as</span> <span class="hljs-keyword">year</span>,
    <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> o.order_date) <span class="hljs-keyword">as</span> <span class="hljs-keyword">month</span>,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.order_id) <span class="hljs-keyword">as</span> order_count,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.customer_id) <span class="hljs-keyword">as</span> unique_customers,
    <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> total_revenue,
    <span class="hljs-keyword">AVG</span>(o.total_amount) <span class="hljs-keyword">as</span> avg_order_value,
    <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> c.created_at &gt;= o.order_date - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'30 days'</span>
             <span class="hljs-keyword">THEN</span> o.total_amount <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> new_customer_revenue,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> o.total_amount &gt; <span class="hljs-number">100</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> high_value_orders
<span class="hljs-keyword">FROM</span> orders o
<span class="hljs-keyword">JOIN</span> customers c <span class="hljs-keyword">ON</span> o.customer_id = c.customer_id
<span class="hljs-keyword">WHERE</span>
    o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'2 years'</span>
    <span class="hljs-keyword">AND</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'shipped'</span>, <span class="hljs-string">'delivered'</span>)
    <span class="hljs-keyword">AND</span> o.total_amount &gt; <span class="hljs-number">0</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
    <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> o.order_date),
    <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> o.order_date)
<span class="hljs-keyword">HAVING</span>
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.order_id) &gt;= <span class="hljs-number">5</span>  <span class="hljs-comment">-- Months with at least 5 orders</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
    <span class="hljs-keyword">year</span> <span class="hljs-keyword">DESC</span>, <span class="hljs-keyword">month</span> <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<p><strong>2. Customer Segmentation Analysis:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- RFM Analysis: Recency, Frequency, Monetary</span>
<span class="hljs-keyword">SELECT</span>
    customer_id,
    <span class="hljs-comment">-- Recency: Days since last order</span>
    <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-keyword">MAX</span>(order_date) <span class="hljs-keyword">as</span> days_since_last_order,

    <span class="hljs-comment">-- Frequency: Number of orders</span>
    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> order_frequency,

    <span class="hljs-comment">-- Monetary: Total spent</span>
    <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">as</span> total_monetary_value,
    <span class="hljs-keyword">AVG</span>(total_amount) <span class="hljs-keyword">as</span> avg_order_value,

    <span class="hljs-comment">-- Customer segment based on behavior</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COUNT</span>(*) &gt;= <span class="hljs-number">10</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">SUM</span>(total_amount) &gt;= <span class="hljs-number">1000</span>
             <span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-keyword">MAX</span>(order_date) &lt;= <span class="hljs-number">30</span>
        <span class="hljs-keyword">THEN</span> <span class="hljs-string">'VIP'</span>

        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COUNT</span>(*) &gt;= <span class="hljs-number">5</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">SUM</span>(total_amount) &gt;= <span class="hljs-number">500</span>
             <span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-keyword">MAX</span>(order_date) &lt;= <span class="hljs-number">90</span>
        <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Loyal'</span>

        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COUNT</span>(*) &gt;= <span class="hljs-number">3</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-keyword">MAX</span>(order_date) &lt;= <span class="hljs-number">180</span>
        <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Regular'</span>

        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-keyword">MAX</span>(order_date) &lt;= <span class="hljs-number">365</span>
        <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Occasional'</span>

        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Inactive'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> customer_segment
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span>
    order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'2 years'</span>
    <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id
<span class="hljs-keyword">HAVING</span>
    <span class="hljs-keyword">COUNT</span>(*) &gt;= <span class="hljs-number">1</span>  <span class="hljs-comment">-- At least one order</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
    total_monetary_value <span class="hljs-keyword">DESC</span>,
    order_frequency <span class="hljs-keyword">DESC</span>,
    days_since_last_order <span class="hljs-keyword">ASC</span>;
</div></code></pre>
<p><strong>3. Product Performance Analysis:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Product performance with seasonal trends</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    c.category_name,

    <span class="hljs-comment">-- Overall metrics</span>
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> oi.order_id) <span class="hljs-keyword">as</span> order_count,
    <span class="hljs-keyword">SUM</span>(oi.quantity) <span class="hljs-keyword">as</span> total_units_sold,
    <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">as</span> total_revenue,
    <span class="hljs-keyword">AVG</span>(oi.unit_price) <span class="hljs-keyword">as</span> avg_selling_price,

    <span class="hljs-comment">-- Seasonal performance</span>
    <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">QUARTER</span> <span class="hljs-keyword">FROM</span> o.order_date) = <span class="hljs-number">1</span>
             <span class="hljs-keyword">THEN</span> oi.quantity <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> q1_units,
    <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">QUARTER</span> <span class="hljs-keyword">FROM</span> o.order_date) = <span class="hljs-number">2</span>
             <span class="hljs-keyword">THEN</span> oi.quantity <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> q2_units,
    <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">QUARTER</span> <span class="hljs-keyword">FROM</span> o.order_date) = <span class="hljs-number">3</span>
             <span class="hljs-keyword">THEN</span> oi.quantity <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> q3_units,
    <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">QUARTER</span> <span class="hljs-keyword">FROM</span> o.order_date) = <span class="hljs-number">4</span>
             <span class="hljs-keyword">THEN</span> oi.quantity <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> q4_units,

    <span class="hljs-comment">-- Performance indicators</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) &gt; <span class="hljs-number">10000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Top Performer'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) &gt; <span class="hljs-number">5000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Good Performer'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) &gt; <span class="hljs-number">1000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Average Performer'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Poor Performer'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> performance_category
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> p.product_id = oi.product_id
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
<span class="hljs-keyword">WHERE</span>
    o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'1 year'</span>
    <span class="hljs-keyword">AND</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
    <span class="hljs-keyword">AND</span> p.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
    p.product_id, p.product_name, c.category_name
<span class="hljs-keyword">HAVING</span>
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> oi.order_id) &gt;= <span class="hljs-number">5</span>      <span class="hljs-comment">-- At least 5 orders</span>
    <span class="hljs-keyword">AND</span> <span class="hljs-keyword">SUM</span>(oi.quantity) &gt;= <span class="hljs-number">10</span>            <span class="hljs-comment">-- At least 10 units sold</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
    total_revenue <span class="hljs-keyword">DESC</span>,
    total_units_sold <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-use-cases--interview-tips">ğŸ¯ Use Cases &amp; Interview Tips</h2>
<h3 id="common-interview-questions">Common Interview Questions:</h3>
<ol>
<li>
<p><strong>&quot;What's the difference between WHERE and HAVING?&quot;</strong></p>
<ul>
<li>WHERE filters rows before grouping</li>
<li>HAVING filters groups after aggregation</li>
<li>WHERE cannot use aggregate functions, HAVING can</li>
<li>WHERE is processed before GROUP BY, HAVING after</li>
</ul>
</li>
<li>
<p><strong>&quot;Explain the SQL execution order&quot;</strong></p>
<ul>
<li>FROM â†’ WHERE â†’ GROUP BY â†’ HAVING â†’ SELECT â†’ ORDER BY â†’ LIMIT</li>
<li>Understanding this helps write correct queries and debug issues</li>
</ul>
</li>
<li>
<p><strong>&quot;How do you optimize queries with these clauses?&quot;</strong></p>
<ul>
<li>Use indexes on WHERE clause columns</li>
<li>Use indexes on GROUP BY columns</li>
<li>Use indexes on ORDER BY columns</li>
<li>Filter early with WHERE to reduce data for grouping</li>
<li>Use LIMIT when you don't need all results</li>
</ul>
</li>
</ol>
<h3 id="performance-best-practices">Performance Best Practices:</h3>
<ol>
<li>
<p><strong>Index Strategy:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Create composite indexes for common query patterns</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_orders_customer_date <span class="hljs-keyword">ON</span> orders(customer_id, order_date);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_products_category_price <span class="hljs-keyword">ON</span> products(category_id, price);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_orders_status_date <span class="hljs-keyword">ON</span> orders(<span class="hljs-keyword">status</span>, order_date);
</div></code></pre>
</li>
<li>
<p><strong>Query Optimization:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Good: Filter early with WHERE</span>
<span class="hljs-keyword">SELECT</span> category_id, <span class="hljs-keyword">COUNT</span>(*)
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>  <span class="hljs-comment">-- Filter first</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> category_id;

<span class="hljs-comment">-- Avoid: Filtering after grouping when possible</span>
<span class="hljs-keyword">SELECT</span> category_id, <span class="hljs-keyword">COUNT</span>(*)
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> category_id
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) &gt; <span class="hljs-number">0</span>;
</div></code></pre>
</li>
<li>
<p><strong>Efficient Aggregation:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Use specific aggregate functions</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">FROM</span> orders;              <span class="hljs-comment">-- Count all rows</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(customer_id) <span class="hljs-keyword">FROM</span> orders;    <span class="hljs-comment">-- Count non-NULL values</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> customer_id) <span class="hljs-keyword">FROM</span> orders;  <span class="hljs-comment">-- Count unique values</span>
</div></code></pre>
</li>
</ol>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-things-to-watch-out-for">âš ï¸ Things to Watch Out For</h2>
<h3 id="1-group-by-rules">1. <strong>GROUP BY Rules</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Error: Non-aggregated column in SELECT without GROUP BY</span>
<span class="hljs-keyword">SELECT</span> customer_id, order_date, <span class="hljs-keyword">COUNT</span>(*)
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id;  <span class="hljs-comment">-- order_date not in GROUP BY!</span>

<span class="hljs-comment">-- Correct: Include all non-aggregated columns in GROUP BY</span>
<span class="hljs-keyword">SELECT</span> customer_id, order_date, <span class="hljs-keyword">COUNT</span>(*)
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id, order_date;

<span class="hljs-comment">-- Or use aggregation for the column</span>
<span class="hljs-keyword">SELECT</span> customer_id, <span class="hljs-keyword">MAX</span>(order_date) <span class="hljs-keyword">as</span> latest_order, <span class="hljs-keyword">COUNT</span>(*)
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id;
</div></code></pre>
<h3 id="2-null-handling-in-aggregates">2. <strong>NULL Handling in Aggregates</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- COUNT(*) counts all rows, COUNT(column) ignores NULLs</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> total_customers,           <span class="hljs-comment">-- All customers</span>
    <span class="hljs-keyword">COUNT</span>(phone) <span class="hljs-keyword">as</span> customers_with_phone,  <span class="hljs-comment">-- Only non-NULL phones</span>
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> country) <span class="hljs-keyword">as</span> unique_countries
<span class="hljs-keyword">FROM</span> customers;

<span class="hljs-comment">-- SUM, AVG ignore NULLs</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">AVG</span>(rating) <span class="hljs-keyword">as</span> avg_rating,                    <span class="hljs-comment">-- Ignores NULL ratings</span>
    <span class="hljs-keyword">AVG</span>(<span class="hljs-keyword">COALESCE</span>(rating, <span class="hljs-number">0</span>)) <span class="hljs-keyword">as</span> avg_rating_with_zero  <span class="hljs-comment">-- Treats NULL as 0</span>
<span class="hljs-keyword">FROM</span> product_reviews;
</div></code></pre>
<h3 id="3-datetime-grouping-pitfalls">3. <strong>Date/Time Grouping Pitfalls</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Grouping by full timestamp</span>
<span class="hljs-keyword">SELECT</span> order_date, <span class="hljs-keyword">COUNT</span>(*)
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> order_date;  <span class="hljs-comment">-- Groups by exact timestamp!</span>

<span class="hljs-comment">-- Solution: Extract date part</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">DATE</span>(order_date) <span class="hljs-keyword">as</span> order_day, <span class="hljs-keyword">COUNT</span>(*)
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">DATE</span>(order_date);

<span class="hljs-comment">-- Or use date truncation (PostgreSQL)</span>
<span class="hljs-keyword">SELECT</span> DATE_TRUNC(<span class="hljs-string">'day'</span>, order_date) <span class="hljs-keyword">as</span> order_day, <span class="hljs-keyword">COUNT</span>(*)
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> DATE_TRUNC(<span class="hljs-string">'day'</span>, order_date);
</div></code></pre>
<h3 id="4-performance-issues">4. <strong>Performance Issues</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Slow: No indexes on filtered/grouped columns</span>
<span class="hljs-keyword">SELECT</span> category_id, <span class="hljs-keyword">COUNT</span>(*)
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> price &gt; <span class="hljs-number">100</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> category_id
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Fast: With proper indexes</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_products_price_category <span class="hljs-keyword">ON</span> products(price, category_id);
</div></code></pre>
<h3 id="5-logical-operator-precedence">5. <strong>Logical Operator Precedence</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Confusing: AND has higher precedence than OR</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> category_id = <span class="hljs-number">1</span> <span class="hljs-keyword">OR</span> category_id = <span class="hljs-number">2</span> <span class="hljs-keyword">AND</span> price &gt; <span class="hljs-number">50</span>;
<span class="hljs-comment">-- Equivalent to: category_id = 1 OR (category_id = 2 AND price &gt; 50)</span>

<span class="hljs-comment">-- Clear: Use parentheses</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> (category_id = <span class="hljs-number">1</span> <span class="hljs-keyword">OR</span> category_id = <span class="hljs-number">2</span>) <span class="hljs-keyword">AND</span> price &gt; <span class="hljs-number">50</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%80-next-steps">ğŸš€ Next Steps</h2>
<p>In the next chapter, we'll explore <strong>Joins</strong> - the powerful feature that allows you to combine data from multiple tables. You'll learn about INNER, LEFT, RIGHT, and FULL joins, and how to write complex queries that span multiple related tables.</p>
<hr>
<h2 id="%F0%9F%93%9D-quick-practice">ğŸ“ Quick Practice</h2>
<p>Try these exercises with a sample e-commerce database:</p>
<ol>
<li><strong>Basic Filtering</strong>: Find all orders from the last 30 days with a total amount greater than $100</li>
<li><strong>Grouping</strong>: Calculate total sales by month for the current year</li>
<li><strong>Having</strong>: Find customers who have placed more than 3 orders and spent more than $500 total</li>
<li><strong>Complex Query</strong>: Create a report showing the top 5 product categories by revenue, including the number of products and average price per category</li>
<li><strong>Performance</strong>: Identify which indexes would improve the performance of your queries</li>
</ol>
<p>Consider:</p>
<ul>
<li>How do you handle NULL values in your calculations?</li>
<li>What happens when you group by date columns?</li>
<li>How do you ensure your queries are efficient?</li>
<li>What business insights can you derive from the grouped data?</li>
</ul>
<h1 id="%F0%9F%93%98-chapter-7-joins-inner-left-right-full">ğŸ“˜ Chapter 7: Joins (INNER, LEFT, RIGHT, FULL)</h1>
<h2 id="%F0%9F%8E%AF-what-youll-learn">ğŸ¯ What You'll Learn</h2>
<ul>
<li>Understanding table relationships and join concepts</li>
<li>INNER JOIN for matching records</li>
<li>LEFT JOIN for preserving left table records</li>
<li>RIGHT JOIN for preserving right table records</li>
<li>FULL OUTER JOIN for all records</li>
<li>CROSS JOIN for cartesian products</li>
<li>Self-joins and complex join scenarios</li>
<li>Join performance optimization</li>
</ul>
<hr>
<h2 id="%F0%9F%93%96-concept-explanation">ğŸ“– Concept Explanation</h2>
<p><strong>Joins</strong> are the heart of relational databases. They allow you to combine data from multiple tables based on relationships between them. Think of joins as &quot;connecting the dots&quot; between related information stored in different tables.</p>
<h3 id="why-use-joins">Why Use Joins?</h3>
<ol>
<li><strong>Normalization</strong>: Data is stored in separate tables to avoid redundancy</li>
<li><strong>Relationships</strong>: Tables are connected through foreign keys</li>
<li><strong>Comprehensive Queries</strong>: Get complete information by combining related data</li>
<li><strong>Data Integrity</strong>: Maintain consistency across related tables</li>
</ol>
<h3 id="types-of-joins">Types of Joins:</h3>
<ul>
<li><strong>INNER JOIN</strong>: Only matching records from both tables</li>
<li><strong>LEFT JOIN</strong>: All records from left table + matching from right</li>
<li><strong>RIGHT JOIN</strong>: All records from right table + matching from left</li>
<li><strong>FULL OUTER JOIN</strong>: All records from both tables</li>
<li><strong>CROSS JOIN</strong>: Cartesian product (every row with every row)</li>
<li><strong>SELF JOIN</strong>: Join a table with itself</li>
</ul>
<h3 id="visual-join-representation">Visual Join Representation:</h3>
<pre class="hljs"><code><div>Table A (Customers)     Table B (Orders)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ customer_id (PK)â”‚â”€â”€â”€â”€â–¶â”‚ customer_id (FK)â”‚
â”‚ name            â”‚     â”‚ order_id (PK)   â”‚
â”‚ email           â”‚     â”‚ order_date      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ total_amount    â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%97-inner-join---matching-records-only">ğŸ”— INNER JOIN - Matching Records Only</h2>
<h3 id="basic-inner-join-syntax">Basic INNER JOIN Syntax</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">columns</span>
<span class="hljs-keyword">FROM</span> table1
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> table2 <span class="hljs-keyword">ON</span> table1.column = table2.column;

<span class="hljs-comment">-- Alternative syntax (implicit join)</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">columns</span>
<span class="hljs-keyword">FROM</span> table1, table2
<span class="hljs-keyword">WHERE</span> table1.column = table2.column;
</div></code></pre>
<h3 id="simple-inner-join-examples">Simple INNER JOIN Examples</h3>
<p><strong>1. Customers with Orders:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Get customers who have placed orders</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email,
    o.order_id,
    o.order_date,
    o.total_amount
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.last_name, c.first_name, o.order_date;

<span class="hljs-comment">-- Count orders per customer (only customers with orders)</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">as</span> order_count,
    <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> total_spent
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_spent <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<p><strong>2. Products with Categories:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Get products with their category information</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    p.price,
    c.category_name,
    c.description <span class="hljs-keyword">as</span> category_description
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.category_name, p.product_name;

<span class="hljs-comment">-- Average price by category (only categories with products)</span>
<span class="hljs-keyword">SELECT</span>
    c.category_name,
    <span class="hljs-keyword">COUNT</span>(p.product_id) <span class="hljs-keyword">as</span> product_count,
    <span class="hljs-keyword">AVG</span>(p.price) <span class="hljs-keyword">as</span> avg_price,
    <span class="hljs-keyword">MIN</span>(p.price) <span class="hljs-keyword">as</span> min_price,
    <span class="hljs-keyword">MAX</span>(p.price) <span class="hljs-keyword">as</span> max_price
<span class="hljs-keyword">FROM</span> categories c
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> c.category_id = p.category_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.category_id, c.category_name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> avg_price <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<h3 id="multiple-inner-joins">Multiple INNER JOINs</h3>
<p><strong>1. Three Table Join:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Get order details with customer and product information</span>
<span class="hljs-keyword">SELECT</span>
    c.first_name,
    c.last_name,
    o.order_id,
    o.order_date,
    p.product_name,
    oi.quantity,
    oi.unit_price,
    (oi.quantity * oi.unit_price) <span class="hljs-keyword">as</span> line_total
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> o.order_id = oi.order_id
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> oi.product_id = p.product_id
<span class="hljs-keyword">WHERE</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'30 days'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> o.order_date <span class="hljs-keyword">DESC</span>, o.order_id, oi.order_item_id;
</div></code></pre>
<p><strong>2. Complex Business Query:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Sales report: Customer, Order, Product, and Category information</span>
<span class="hljs-keyword">SELECT</span>
    cat.category_name,
    p.product_name,
    c.first_name || <span class="hljs-string">' '</span> || c.last_name <span class="hljs-keyword">as</span> customer_name,
    c.email,
    o.order_date,
    oi.quantity,
    oi.unit_price,
    (oi.quantity * oi.unit_price) <span class="hljs-keyword">as</span> revenue,

    <span class="hljs-comment">-- Calculate discount if original price is available</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> p.price &gt; oi.unit_price
        <span class="hljs-keyword">THEN</span> <span class="hljs-keyword">ROUND</span>(((p.price - oi.unit_price) / p.price * <span class="hljs-number">100</span>), <span class="hljs-number">2</span>)
        <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> discount_percentage
<span class="hljs-keyword">FROM</span> categories cat
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> cat.category_id = p.category_id
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> p.product_id = oi.product_id
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> customers c <span class="hljs-keyword">ON</span> o.customer_id = c.customer_id
<span class="hljs-keyword">WHERE</span>
    o.order_date <span class="hljs-keyword">BETWEEN</span> <span class="hljs-string">'2024-01-01'</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">'2024-12-31'</span>
    <span class="hljs-keyword">AND</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'shipped'</span>, <span class="hljs-string">'delivered'</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
    cat.category_name,
    revenue <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<hr>
<h2 id="%E2%AC%85%EF%B8%8F-left-join---preserve-left-table">â¬…ï¸ LEFT JOIN - Preserve Left Table</h2>
<h3 id="basic-left-join-syntax">Basic LEFT JOIN Syntax</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">columns</span>
<span class="hljs-keyword">FROM</span> table1
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> table2 <span class="hljs-keyword">ON</span> table1.column = table2.column;

<span class="hljs-comment">-- Alternative syntax</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">columns</span>
<span class="hljs-keyword">FROM</span> table1
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> table2 <span class="hljs-keyword">ON</span> table1.column = table2.column;
</div></code></pre>
<h3 id="left-join-examples">LEFT JOIN Examples</h3>
<p><strong>1. All Customers (with or without orders):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Get all customers and their order information (if any)</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email,
    o.order_id,
    o.order_date,
    o.total_amount,

    <span class="hljs-comment">-- Handle NULL values from right table</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> o.order_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'No orders'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Has orders'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> order_status
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.last_name, c.first_name, o.order_date;

<span class="hljs-comment">-- Find customers who have never placed an order</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email,
    c.created_at
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">WHERE</span> o.customer_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>  <span class="hljs-comment">-- No matching orders</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.created_at <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<p><strong>2. Customer Order Summary:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- All customers with their order statistics</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email,

    <span class="hljs-comment">-- Aggregate functions handle NULLs appropriately</span>
    <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">as</span> order_count,
    <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(o.total_amount), <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> total_spent,
    <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">AVG</span>(o.total_amount), <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> avg_order_value,
    <span class="hljs-keyword">MAX</span>(o.order_date) <span class="hljs-keyword">as</span> last_order_date,

    <span class="hljs-comment">-- Customer segmentation</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COUNT</span>(o.order_id) = <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'No Orders'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COUNT</span>(o.order_id) = <span class="hljs-number">1</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'One-time Customer'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">2</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">5</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Regular Customer'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COUNT</span>(o.order_id) &gt; <span class="hljs-number">5</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'VIP Customer'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> customer_segment
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name, c.email
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_spent <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<p><strong>3. Product Performance Analysis:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- All products with their sales performance (including unsold products)</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    p.price,
    p.stock_quantity,
    c.category_name,

    <span class="hljs-comment">-- Sales metrics (NULL-safe)</span>
    <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(oi.quantity), <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> total_units_sold,
    <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price), <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> total_revenue,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> oi.order_id) <span class="hljs-keyword">as</span> order_count,

    <span class="hljs-comment">-- Performance indicators</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">SUM</span>(oi.quantity) <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Never Sold'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">SUM</span>(oi.quantity) &lt; <span class="hljs-number">10</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Low Sales'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">SUM</span>(oi.quantity) &lt; <span class="hljs-number">50</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Moderate Sales'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'High Sales'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> sales_performance
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> p.product_id = oi.product_id
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
    <span class="hljs-keyword">AND</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'shipped'</span>, <span class="hljs-string">'delivered'</span>)
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
    p.product_id, p.product_name, p.price, p.stock_quantity, c.category_name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_revenue <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<hr>
<h2 id="%E2%9E%A1%EF%B8%8F-right-join---preserve-right-table">â¡ï¸ RIGHT JOIN - Preserve Right Table</h2>
<h3 id="basic-right-join-syntax">Basic RIGHT JOIN Syntax</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">columns</span>
<span class="hljs-keyword">FROM</span> table1
<span class="hljs-keyword">RIGHT</span> <span class="hljs-keyword">JOIN</span> table2 <span class="hljs-keyword">ON</span> table1.column = table2.column;

<span class="hljs-comment">-- Alternative syntax</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">columns</span>
<span class="hljs-keyword">FROM</span> table1
<span class="hljs-keyword">RIGHT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> table2 <span class="hljs-keyword">ON</span> table1.column = table2.column;
</div></code></pre>
<h3 id="right-join-examples">RIGHT JOIN Examples</h3>
<p><strong>1. All Orders (with customer info if available):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Get all orders, even if customer data is missing</span>
<span class="hljs-keyword">SELECT</span>
    o.order_id,
    o.order_date,
    o.total_amount,
    o.status,

    <span class="hljs-comment">-- Customer info (might be NULL)</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email,

    <span class="hljs-comment">-- Handle missing customer data</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> c.customer_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Customer data missing'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Customer found'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> customer_status
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">RIGHT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> o.order_date <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Find orders with missing customer references (data integrity check)</span>
<span class="hljs-keyword">SELECT</span>
    o.order_id,
    o.customer_id <span class="hljs-keyword">as</span> orphaned_customer_id,
    o.order_date,
    o.total_amount
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">RIGHT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">WHERE</span> c.customer_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>;
</div></code></pre>
<p><strong>Note</strong>: RIGHT JOIN is less commonly used than LEFT JOIN. Most developers prefer to rewrite RIGHT JOINs as LEFT JOINs by switching table order:</p>
<pre class="hljs"><code><div><span class="hljs-comment">-- These queries are equivalent:</span>

<span class="hljs-comment">-- RIGHT JOIN version</span>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">RIGHT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id;

<span class="hljs-comment">-- LEFT JOIN version (preferred)</span>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> orders o
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> customers c <span class="hljs-keyword">ON</span> o.customer_id = c.customer_id;
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%84-full-outer-join---all-records">ğŸ”„ FULL OUTER JOIN - All Records</h2>
<h3 id="basic-full-outer-join-syntax">Basic FULL OUTER JOIN Syntax</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">columns</span>
<span class="hljs-keyword">FROM</span> table1
<span class="hljs-keyword">FULL</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> table2 <span class="hljs-keyword">ON</span> table1.column = table2.column;

<span class="hljs-comment">-- Alternative syntax</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">columns</span>
<span class="hljs-keyword">FROM</span> table1
<span class="hljs-keyword">FULL</span> <span class="hljs-keyword">JOIN</span> table2 <span class="hljs-keyword">ON</span> table1.column = table2.column;
</div></code></pre>
<p><strong>Note</strong>: MySQL doesn't support FULL OUTER JOIN directly. You can simulate it using UNION:</p>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL: Simulate FULL OUTER JOIN with UNION</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">columns</span> <span class="hljs-keyword">FROM</span> table1 <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> table2 <span class="hljs-keyword">ON</span> condition
<span class="hljs-keyword">UNION</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">columns</span> <span class="hljs-keyword">FROM</span> table1 <span class="hljs-keyword">RIGHT</span> <span class="hljs-keyword">JOIN</span> table2 <span class="hljs-keyword">ON</span> condition;
</div></code></pre>
<h3 id="full-outer-join-examples-postgresql">FULL OUTER JOIN Examples (PostgreSQL)</h3>
<p><strong>1. Complete Customer-Order Relationship:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Get all customers and all orders, showing relationships where they exist</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    o.order_id,
    o.order_date,
    o.total_amount,

    <span class="hljs-comment">-- Categorize the relationship</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> c.customer_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Order without customer'</span>
        <span class="hljs-keyword">WHEN</span> o.order_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Customer without orders'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Customer with orders'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> relationship_status
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">FULL</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
    c.customer_id <span class="hljs-keyword">NULLS</span> <span class="hljs-keyword">LAST</span>,
    o.order_date <span class="hljs-keyword">NULLS</span> <span class="hljs-keyword">LAST</span>;
</div></code></pre>
<p><strong>2. Data Integrity Analysis:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Find all mismatches between customers and orders tables</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">COALESCE</span>(c.customer_id, o.customer_id) <span class="hljs-keyword">as</span> customer_id,
    c.first_name,
    c.last_name,
    o.order_id,
    o.order_date,

    <span class="hljs-comment">-- Identify data issues</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> c.customer_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'ORPHANED ORDER: No customer record'</span>
        <span class="hljs-keyword">WHEN</span> o.order_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'CUSTOMER WITHOUT ORDERS: Potential marketing target'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'VALID RELATIONSHIP'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> data_status
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">FULL</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">WHERE</span>
    c.customer_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">OR</span> o.order_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>  <span class="hljs-comment">-- Only show mismatches</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> data_status, customer_id;
</div></code></pre>
<hr>
<h2 id="%E2%9D%8C-cross-join---cartesian-product">âŒ CROSS JOIN - Cartesian Product</h2>
<h3 id="basic-cross-join-syntax">Basic CROSS JOIN Syntax</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">columns</span>
<span class="hljs-keyword">FROM</span> table1
<span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span> table2;

<span class="hljs-comment">-- Alternative syntax</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">columns</span>
<span class="hljs-keyword">FROM</span> table1, table2;
</div></code></pre>
<h3 id="cross-join-examples">CROSS JOIN Examples</h3>
<p><strong>1. Product-Size Combinations:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Generate all possible product-size combinations</span>
<span class="hljs-keyword">SELECT</span>
    p.product_name,
    s.size_name,
    p.base_price,
    s.price_modifier,
    (p.base_price + s.price_modifier) <span class="hljs-keyword">as</span> final_price
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-keyword">sizes</span> s
<span class="hljs-keyword">WHERE</span> p.category_id = <span class="hljs-number">1</span>  <span class="hljs-comment">-- Only for clothing category</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.product_name, s.sort_order;

<span class="hljs-comment">-- Create a size availability matrix</span>
<span class="hljs-keyword">SELECT</span>
    p.product_name,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> s.size_name = <span class="hljs-string">'XS'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> xs_available,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> s.size_name = <span class="hljs-string">'S'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> s_available,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> s.size_name = <span class="hljs-string">'M'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> m_available,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> s.size_name = <span class="hljs-string">'L'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> l_available,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> s.size_name = <span class="hljs-string">'XL'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> xl_available
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-keyword">sizes</span> s
<span class="hljs-keyword">WHERE</span> p.category_id = <span class="hljs-number">1</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> p.product_id, p.product_name;
</div></code></pre>
<p><strong>2. Date Range Generation:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Generate sales report template for all months and categories</span>
<span class="hljs-keyword">WITH</span> <span class="hljs-keyword">months</span> <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> generate_series(
        DATE_TRUNC(<span class="hljs-string">'month'</span>, <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'11 months'</span>),
        DATE_TRUNC(<span class="hljs-string">'month'</span>, <span class="hljs-keyword">CURRENT_DATE</span>),
        <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'1 month'</span>
    )::<span class="hljs-built_in">date</span> <span class="hljs-keyword">as</span> month_start
)
<span class="hljs-keyword">SELECT</span>
    m.month_start,
    TO_CHAR(m.month_start, <span class="hljs-string">'YYYY-MM'</span>) <span class="hljs-keyword">as</span> month_label,
    c.category_id,
    c.category_name,

    <span class="hljs-comment">-- Placeholder for actual sales data</span>
    <span class="hljs-number">0</span> <span class="hljs-keyword">as</span> planned_sales,
    <span class="hljs-literal">NULL</span> <span class="hljs-keyword">as</span> actual_sales
<span class="hljs-keyword">FROM</span> <span class="hljs-keyword">months</span> m
<span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span> categories c
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> m.month_start, c.category_name;
</div></code></pre>
<p><strong>âš ï¸ Warning</strong>: CROSS JOIN can produce very large result sets. A table with 1,000 rows crossed with another 1,000-row table produces 1,000,000 rows!</p>
<hr>
<h2 id="%F0%9F%94%84-self-join---join-table-with-itself">ğŸ”„ SELF JOIN - Join Table with Itself</h2>
<h3 id="self-join-concept">Self JOIN Concept</h3>
<p>A self join is when you join a table with itself, typically to find relationships within the same table (like hierarchies, comparisons, or sequences).</p>
<h3 id="self-join-examples">Self JOIN Examples</h3>
<p><strong>1. Employee Hierarchy:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Find employees and their managers</span>
<span class="hljs-keyword">SELECT</span>
    e.employee_id,
    e.first_name || <span class="hljs-string">' '</span> || e.last_name <span class="hljs-keyword">as</span> employee_name,
    e.job_title,
    m.employee_id <span class="hljs-keyword">as</span> manager_id,
    m.first_name || <span class="hljs-string">' '</span> || m.last_name <span class="hljs-keyword">as</span> manager_name,
    m.job_title <span class="hljs-keyword">as</span> manager_title
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> employees m <span class="hljs-keyword">ON</span> e.manager_id = m.employee_id
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> m.employee_id <span class="hljs-keyword">NULLS</span> <span class="hljs-keyword">FIRST</span>, e.last_name;

<span class="hljs-comment">-- Find all employees who report to a specific manager</span>
<span class="hljs-keyword">SELECT</span>
    m.first_name || <span class="hljs-string">' '</span> || m.last_name <span class="hljs-keyword">as</span> manager_name,
    <span class="hljs-keyword">COUNT</span>(e.employee_id) <span class="hljs-keyword">as</span> direct_reports,
    STRING_AGG(e.first_name || <span class="hljs-string">' '</span> || e.last_name, <span class="hljs-string">', '</span>) <span class="hljs-keyword">as</span> team_members
<span class="hljs-keyword">FROM</span> employees m
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> employees e <span class="hljs-keyword">ON</span> m.employee_id = e.manager_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> m.employee_id, m.first_name, m.last_name
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(e.employee_id) &gt; <span class="hljs-number">0</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> direct_reports <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<p><strong>2. Product Comparisons:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Find products in the same category with similar prices</span>
<span class="hljs-keyword">SELECT</span>
    p1.product_name <span class="hljs-keyword">as</span> product_1,
    p1.price <span class="hljs-keyword">as</span> price_1,
    p2.product_name <span class="hljs-keyword">as</span> product_2,
    p2.price <span class="hljs-keyword">as</span> price_2,
    <span class="hljs-keyword">ABS</span>(p1.price - p2.price) <span class="hljs-keyword">as</span> price_difference
<span class="hljs-keyword">FROM</span> products p1
<span class="hljs-keyword">JOIN</span> products p2 <span class="hljs-keyword">ON</span> p1.category_id = p2.category_id
    <span class="hljs-keyword">AND</span> p1.product_id &lt; p2.product_id  <span class="hljs-comment">-- Avoid duplicates and self-comparison</span>
    <span class="hljs-keyword">AND</span> <span class="hljs-keyword">ABS</span>(p1.price - p2.price) &lt; <span class="hljs-number">10</span>  <span class="hljs-comment">-- Similar prices (within $10)</span>
<span class="hljs-keyword">WHERE</span> p1.status = <span class="hljs-string">'active'</span> <span class="hljs-keyword">AND</span> p2.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p1.category_id, price_difference;
</div></code></pre>
<p><strong>3. Sequential Data Analysis:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Compare consecutive orders from the same customer</span>
<span class="hljs-keyword">SELECT</span>
    c.first_name || <span class="hljs-string">' '</span> || c.last_name <span class="hljs-keyword">as</span> customer_name,
    o1.order_id <span class="hljs-keyword">as</span> first_order,
    o1.order_date <span class="hljs-keyword">as</span> first_date,
    o1.total_amount <span class="hljs-keyword">as</span> first_amount,
    o2.order_id <span class="hljs-keyword">as</span> next_order,
    o2.order_date <span class="hljs-keyword">as</span> next_date,
    o2.total_amount <span class="hljs-keyword">as</span> next_amount,

    <span class="hljs-comment">-- Calculate time between orders</span>
    (o2.order_date - o1.order_date) <span class="hljs-keyword">as</span> days_between,

    <span class="hljs-comment">-- Calculate spending change</span>
    (o2.total_amount - o1.total_amount) <span class="hljs-keyword">as</span> amount_change,
    <span class="hljs-keyword">ROUND</span>(
        ((o2.total_amount - o1.total_amount) / o1.total_amount * <span class="hljs-number">100</span>), <span class="hljs-number">2</span>
    ) <span class="hljs-keyword">as</span> percent_change
<span class="hljs-keyword">FROM</span> orders o1
<span class="hljs-keyword">JOIN</span> orders o2 <span class="hljs-keyword">ON</span> o1.customer_id = o2.customer_id
    <span class="hljs-keyword">AND</span> o2.order_date &gt; o1.order_date
<span class="hljs-keyword">JOIN</span> customers c <span class="hljs-keyword">ON</span> o1.customer_id = c.customer_id
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-comment">-- Ensure o2 is the immediate next order</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> orders o3
    <span class="hljs-keyword">WHERE</span> o3.customer_id = o1.customer_id
    <span class="hljs-keyword">AND</span> o3.order_date &gt; o1.order_date
    <span class="hljs-keyword">AND</span> o3.order_date &lt; o2.order_date
)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.customer_id, o1.order_date;
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%A7-advanced-join-techniques">ğŸ”§ Advanced Join Techniques</h2>
<h3 id="1-multiple-join-conditions">1. Multiple Join Conditions</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Join with multiple conditions</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_name,
    o.order_date,
    p.product_name,
    oi.quantity
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
    <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-string">'2024-01-01'</span>  <span class="hljs-comment">-- Additional condition</span>
<span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> o.order_id = oi.order_id
    <span class="hljs-keyword">AND</span> oi.quantity &gt; <span class="hljs-number">1</span>  <span class="hljs-comment">-- Additional condition</span>
<span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> oi.product_id = p.product_id
    <span class="hljs-keyword">AND</span> p.status = <span class="hljs-string">'active'</span>;  <span class="hljs-comment">-- Additional condition</span>
</div></code></pre>
<h3 id="2-conditional-joins">2. Conditional Joins</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Join based on conditions</span>
<span class="hljs-keyword">SELECT</span>
    p.product_name,
    p.price,
    d.discount_percentage,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> d.discount_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
        <span class="hljs-keyword">THEN</span> p.price * (<span class="hljs-number">1</span> - d.discount_percentage / <span class="hljs-number">100</span>)
        <span class="hljs-keyword">ELSE</span> p.price
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> final_price
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> discounts d <span class="hljs-keyword">ON</span> p.product_id = d.product_id
    <span class="hljs-keyword">AND</span> d.start_date &lt;= <span class="hljs-keyword">CURRENT_DATE</span>
    <span class="hljs-keyword">AND</span> d.end_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span>
    <span class="hljs-keyword">AND</span> d.is_active = <span class="hljs-literal">true</span>;
</div></code></pre>
<h3 id="3-subquery-joins">3. Subquery Joins</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Join with subquery results</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    recent_orders.order_count,
    recent_orders.total_spent
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span>
        customer_id,
        <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> order_count,
        <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">as</span> total_spent
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'90 days'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id
    <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(*) &gt;= <span class="hljs-number">2</span>
) recent_orders <span class="hljs-keyword">ON</span> c.customer_id = recent_orders.customer_id;
</div></code></pre>
<h3 id="4-window-functions-with-joins">4. Window Functions with Joins</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Rank customers by spending within each country</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.country,
    <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> total_spent,
    <span class="hljs-keyword">RANK</span>() <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> c.country
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">DESC</span>
    ) <span class="hljs-keyword">as</span> country_rank,
    <span class="hljs-keyword">PERCENT_RANK</span>() <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> c.country
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">SUM</span>(o.total_amount)
    ) <span class="hljs-keyword">as</span> percentile_rank
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">WHERE</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name, c.country
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.country, country_rank;
</div></code></pre>
<hr>
<h2 id="%F0%9F%92%A1-real-world-join-examples">ğŸ’¡ Real-World Join Examples</h2>
<h3 id="example-1-e-commerce-analytics-dashboard">Example 1: E-commerce Analytics Dashboard</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Comprehensive sales analytics with multiple joins</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-comment">-- Time dimensions</span>
    DATE_TRUNC(<span class="hljs-string">'month'</span>, o.order_date) <span class="hljs-keyword">as</span> <span class="hljs-keyword">month</span>,

    <span class="hljs-comment">-- Product dimensions</span>
    cat.category_name,
    p.product_name,

    <span class="hljs-comment">-- Customer dimensions</span>
    c.country,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> age(c.date_of_birth)) &lt; <span class="hljs-number">25</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'18-24'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> age(c.date_of_birth)) &lt; <span class="hljs-number">35</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'25-34'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> age(c.date_of_birth)) &lt; <span class="hljs-number">45</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'35-44'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> age(c.date_of_birth)) &lt; <span class="hljs-number">55</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'45-54'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'55+'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> age_group,

    <span class="hljs-comment">-- Metrics</span>
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.order_id) <span class="hljs-keyword">as</span> order_count,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> c.customer_id) <span class="hljs-keyword">as</span> unique_customers,
    <span class="hljs-keyword">SUM</span>(oi.quantity) <span class="hljs-keyword">as</span> units_sold,
    <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">as</span> revenue,
    <span class="hljs-keyword">AVG</span>(oi.unit_price) <span class="hljs-keyword">as</span> avg_unit_price,

    <span class="hljs-comment">-- Advanced metrics</span>
    <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) / <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.order_id) <span class="hljs-keyword">as</span> avg_order_value,
    <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) / <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> c.customer_id) <span class="hljs-keyword">as</span> revenue_per_customer
<span class="hljs-keyword">FROM</span> orders o
<span class="hljs-keyword">JOIN</span> customers c <span class="hljs-keyword">ON</span> o.customer_id = c.customer_id
<span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> o.order_id = oi.order_id
<span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> oi.product_id = p.product_id
<span class="hljs-keyword">JOIN</span> categories cat <span class="hljs-keyword">ON</span> p.category_id = cat.category_id
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> discounts d <span class="hljs-keyword">ON</span> p.product_id = d.product_id
    <span class="hljs-keyword">AND</span> o.order_date <span class="hljs-keyword">BETWEEN</span> d.start_date <span class="hljs-keyword">AND</span> d.end_date
<span class="hljs-keyword">WHERE</span>
    o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
    <span class="hljs-keyword">AND</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'shipped'</span>, <span class="hljs-string">'delivered'</span>)
    <span class="hljs-keyword">AND</span> c.date_of_birth <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
    DATE_TRUNC(<span class="hljs-string">'month'</span>, o.order_date),
    cat.category_name,
    p.product_name,
    c.country,
    age_group
<span class="hljs-keyword">HAVING</span>
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.order_id) &gt;= <span class="hljs-number">5</span>  <span class="hljs-comment">-- Significant volume</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
    <span class="hljs-keyword">month</span> <span class="hljs-keyword">DESC</span>,
    revenue <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<h3 id="example-2-customer-lifetime-value-analysis">Example 2: Customer Lifetime Value Analysis</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Calculate customer lifetime value with cohort analysis</span>
<span class="hljs-keyword">WITH</span> customer_cohorts <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        c.customer_id,
        c.first_name,
        c.last_name,
        c.email,
        c.created_at <span class="hljs-keyword">as</span> registration_date,
        DATE_TRUNC(<span class="hljs-string">'month'</span>, c.created_at) <span class="hljs-keyword">as</span> cohort_month,
        <span class="hljs-keyword">MIN</span>(o.order_date) <span class="hljs-keyword">as</span> first_order_date,
        <span class="hljs-keyword">MAX</span>(o.order_date) <span class="hljs-keyword">as</span> last_order_date
    <span class="hljs-keyword">FROM</span> customers c
    <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
        <span class="hljs-keyword">AND</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name, c.email, c.created_at
),
customer_metrics <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        cc.customer_id,
        cc.first_name,
        cc.last_name,
        cc.cohort_month,
        cc.first_order_date,
        cc.last_order_date,

        <span class="hljs-comment">-- Order metrics</span>
        <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">as</span> total_orders,
        <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> total_spent,
        <span class="hljs-keyword">AVG</span>(o.total_amount) <span class="hljs-keyword">as</span> avg_order_value,

        <span class="hljs-comment">-- Time metrics</span>
        <span class="hljs-keyword">CASE</span>
            <span class="hljs-keyword">WHEN</span> cc.first_order_date <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
            <span class="hljs-keyword">THEN</span> cc.last_order_date - cc.first_order_date
            <span class="hljs-keyword">ELSE</span> <span class="hljs-literal">NULL</span>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> customer_lifespan_days,

        <span class="hljs-comment">-- Product diversity</span>
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> oi.product_id) <span class="hljs-keyword">as</span> unique_products_purchased,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> cat.category_id) <span class="hljs-keyword">as</span> unique_categories_purchased
    <span class="hljs-keyword">FROM</span> customer_cohorts cc
    <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> cc.customer_id = o.customer_id
        <span class="hljs-keyword">AND</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
    <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> o.order_id = oi.order_id
    <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> oi.product_id = p.product_id
    <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> categories cat <span class="hljs-keyword">ON</span> p.category_id = cat.category_id
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
        cc.customer_id, cc.first_name, cc.last_name,
        cc.cohort_month, cc.first_order_date, cc.last_order_date
)
<span class="hljs-keyword">SELECT</span>
    cm.*,

    <span class="hljs-comment">-- Customer segmentation</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> cm.total_orders = <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Never Purchased'</span>
        <span class="hljs-keyword">WHEN</span> cm.total_orders = <span class="hljs-number">1</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'One-time Buyer'</span>
        <span class="hljs-keyword">WHEN</span> cm.total_orders <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">2</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">5</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Occasional Buyer'</span>
        <span class="hljs-keyword">WHEN</span> cm.total_orders <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">6</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">15</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Regular Customer'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'VIP Customer'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> customer_segment,

    <span class="hljs-comment">-- Value segmentation</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> cm.total_spent = <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'No Value'</span>
        <span class="hljs-keyword">WHEN</span> cm.total_spent &lt; <span class="hljs-number">100</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Low Value'</span>
        <span class="hljs-keyword">WHEN</span> cm.total_spent &lt; <span class="hljs-number">500</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Medium Value'</span>
        <span class="hljs-keyword">WHEN</span> cm.total_spent &lt; <span class="hljs-number">2000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'High Value'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Premium Value'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> value_segment,

    <span class="hljs-comment">-- Engagement metrics</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> cm.last_order_date <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Never Ordered'</span>
        <span class="hljs-keyword">WHEN</span> cm.last_order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'30 days'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Active'</span>
        <span class="hljs-keyword">WHEN</span> cm.last_order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'90 days'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Recent'</span>
        <span class="hljs-keyword">WHEN</span> cm.last_order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'365 days'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Dormant'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Inactive'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> engagement_status
<span class="hljs-keyword">FROM</span> customer_metrics cm
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> cm.total_spent <span class="hljs-keyword">DESC</span>, cm.total_orders <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<h3 id="example-3-inventory-and-sales-correlation">Example 3: Inventory and Sales Correlation</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Analyze relationship between inventory levels and sales performance</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    cat.category_name,
    p.price,
    p.stock_quantity <span class="hljs-keyword">as</span> current_stock,

    <span class="hljs-comment">-- Sales metrics (last 90 days)</span>
    <span class="hljs-keyword">COALESCE</span>(sales.units_sold, <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> units_sold_90d,
    <span class="hljs-keyword">COALESCE</span>(sales.revenue, <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> revenue_90d,
    <span class="hljs-keyword">COALESCE</span>(sales.order_count, <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> order_count_90d,

    <span class="hljs-comment">-- Inventory metrics</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COALESCE</span>(sales.units_sold, <span class="hljs-number">0</span>) = <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-literal">NULL</span>
        <span class="hljs-keyword">ELSE</span> p.stock_quantity::<span class="hljs-built_in">float</span> / (sales.units_sold / <span class="hljs-number">90.0</span>)  <span class="hljs-comment">-- Days of inventory</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> days_of_inventory,

    <span class="hljs-comment">-- Performance indicators</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> p.stock_quantity = <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Out of Stock'</span>
        <span class="hljs-keyword">WHEN</span> p.stock_quantity &lt; <span class="hljs-number">10</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Low Stock'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COALESCE</span>(sales.units_sold, <span class="hljs-number">0</span>) = <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'No Recent Sales'</span>
        <span class="hljs-keyword">WHEN</span> p.stock_quantity::<span class="hljs-built_in">float</span> / (sales.units_sold / <span class="hljs-number">90.0</span>) &lt; <span class="hljs-number">30</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Fast Moving'</span>
        <span class="hljs-keyword">WHEN</span> p.stock_quantity::<span class="hljs-built_in">float</span> / (sales.units_sold / <span class="hljs-number">90.0</span>) &gt; <span class="hljs-number">180</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Slow Moving'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Normal'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> inventory_status,

    <span class="hljs-comment">-- Supplier information</span>
    s.supplier_name,
    s.lead_time_days,

    <span class="hljs-comment">-- Reorder recommendations</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> p.stock_quantity = <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'URGENT: Reorder immediately'</span>
        <span class="hljs-keyword">WHEN</span> p.stock_quantity &lt; <span class="hljs-number">10</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">COALESCE</span>(sales.units_sold, <span class="hljs-number">0</span>) &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'HIGH: Reorder soon'</span>
        <span class="hljs-keyword">WHEN</span> p.stock_quantity::<span class="hljs-built_in">float</span> / (sales.units_sold / <span class="hljs-number">90.0</span>) &lt; <span class="hljs-number">30</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'MEDIUM: Monitor closely'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COALESCE</span>(sales.units_sold, <span class="hljs-number">0</span>) = <span class="hljs-number">0</span> <span class="hljs-keyword">AND</span> p.stock_quantity &gt; <span class="hljs-number">50</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'LOW: Consider discontinuing'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'NORMAL: No action needed'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> reorder_priority
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories cat <span class="hljs-keyword">ON</span> p.category_id = cat.category_id
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> suppliers s <span class="hljs-keyword">ON</span> p.supplier_id = s.supplier_id
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span>
        oi.product_id,
        <span class="hljs-keyword">SUM</span>(oi.quantity) <span class="hljs-keyword">as</span> units_sold,
        <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">as</span> revenue,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> oi.order_id) <span class="hljs-keyword">as</span> order_count
    <span class="hljs-keyword">FROM</span> order_items oi
    <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
    <span class="hljs-keyword">WHERE</span>
        o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'90 days'</span>
        <span class="hljs-keyword">AND</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'shipped'</span>, <span class="hljs-string">'delivered'</span>)
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> oi.product_id
) sales <span class="hljs-keyword">ON</span> p.product_id = sales.product_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> p.stock_quantity = <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span>
        <span class="hljs-keyword">WHEN</span> p.stock_quantity &lt; <span class="hljs-number">10</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">COALESCE</span>(sales.units_sold, <span class="hljs-number">0</span>) &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">2</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-number">3</span>
    <span class="hljs-keyword">END</span>,
    revenue_90d <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-use-cases--interview-tips">ğŸ¯ Use Cases &amp; Interview Tips</h2>
<h3 id="common-interview-questions">Common Interview Questions:</h3>
<ol>
<li>
<p><strong>&quot;Explain the difference between INNER JOIN and LEFT JOIN&quot;</strong></p>
<ul>
<li>INNER JOIN: Only returns rows where there's a match in both tables</li>
<li>LEFT JOIN: Returns all rows from left table, plus matching rows from right table</li>
<li>Use INNER JOIN when you need data that exists in both tables</li>
<li>Use LEFT JOIN when you want to preserve all records from one table</li>
</ul>
</li>
<li>
<p><strong>&quot;When would you use a self-join?&quot;</strong></p>
<ul>
<li>Employee-manager relationships</li>
<li>Hierarchical data (categories, organizational charts)</li>
<li>Comparing records within the same table</li>
<li>Finding duplicates or similar records</li>
</ul>
</li>
<li>
<p><strong>&quot;How do you optimize join performance?&quot;</strong></p>
<ul>
<li>Create indexes on join columns</li>
<li>Use appropriate join types</li>
<li>Filter early with WHERE clauses</li>
<li>Consider query execution order</li>
<li>Use EXPLAIN to analyze query plans</li>
</ul>
</li>
</ol>
<h3 id="best-practices">Best Practices:</h3>
<ol>
<li>
<p><strong>Always Use Table Aliases:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Good: Clear and readable</span>
<span class="hljs-keyword">SELECT</span> c.name, o.total
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.id = o.customer_id;

<span class="hljs-comment">-- Avoid: Ambiguous and verbose</span>
<span class="hljs-keyword">SELECT</span> customers.name, orders.total
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">JOIN</span> orders <span class="hljs-keyword">ON</span> customers.id = orders.customer_id;
</div></code></pre>
</li>
<li>
<p><strong>Be Explicit with JOIN Types:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Good: Explicit intent</span>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id;

<span class="hljs-comment">-- Avoid: Implicit join (harder to read)</span>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> customers c, orders o
<span class="hljs-keyword">WHERE</span> c.customer_id = o.customer_id;
</div></code></pre>
</li>
<li>
<p><strong>Handle NULL Values Appropriately:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Use COALESCE for NULL handling</span>
<span class="hljs-keyword">SELECT</span>
    c.name,
    <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(o.total), <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> total_spent
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.name;
</div></code></pre>
</li>
</ol>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-things-to-watch-out-for">âš ï¸ Things to Watch Out For</h2>
<h3 id="1-cartesian-products-accidental-cross-joins">1. <strong>Cartesian Products (Accidental CROSS JOINs)</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Dangerous: Missing join condition</span>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> orders o;  <span class="hljs-comment">-- Missing ON clause!</span>

<span class="hljs-comment">-- This creates a cartesian product: every customer with every order</span>
<span class="hljs-comment">-- 1,000 customers Ã— 10,000 orders = 10,000,000 rows!</span>

<span class="hljs-comment">-- Correct: Always include join conditions</span>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id;
</div></code></pre>
<h3 id="2-null-handling-in-joins">2. <strong>NULL Handling in Joins</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- NULLs don't match in joins</span>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> table1 t1
<span class="hljs-keyword">JOIN</span> table2 t2 <span class="hljs-keyword">ON</span> t1.column = t2.column;
<span class="hljs-comment">-- Rows with NULL in either column won't match</span>

<span class="hljs-comment">-- Use IS NULL checks when needed</span>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">WHERE</span> o.customer_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>;  <span class="hljs-comment">-- Customers without orders</span>
</div></code></pre>
<h3 id="3-performance-issues-with-large-joins">3. <strong>Performance Issues with Large Joins</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Slow: No indexes on join columns</span>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> large_table1 t1
<span class="hljs-keyword">JOIN</span> large_table2 t2 <span class="hljs-keyword">ON</span> t1.unindexed_column = t2.unindexed_column;

<span class="hljs-comment">-- Fast: Proper indexes</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_table1_join_col <span class="hljs-keyword">ON</span> large_table1(join_column);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_table2_join_col <span class="hljs-keyword">ON</span> large_table2(join_column);
</div></code></pre>
<h3 id="4-ambiguous-column-names">4. <strong>Ambiguous Column Names</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Error: Ambiguous column reference</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span>  <span class="hljs-comment">-- Which table's id and name?</span>
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id;

<span class="hljs-comment">-- Correct: Use table aliases</span>
<span class="hljs-keyword">SELECT</span> c.customer_id, c.name, o.order_id
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id;
</div></code></pre>
<h3 id="5-incorrect-join-logic">5. <strong>Incorrect Join Logic</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Wrong: Using WHERE instead of ON for join conditions</span>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o
<span class="hljs-keyword">WHERE</span> c.customer_id = o.customer_id;  <span class="hljs-comment">-- This becomes an INNER JOIN!</span>

<span class="hljs-comment">-- Correct: Use ON for join conditions</span>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id;
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%80-next-steps">ğŸš€ Next Steps</h2>
<p>In the next chapter, we'll explore <strong>Aggregate Functions</strong> (COUNT, SUM, AVG, etc.) in detail. You'll learn how to use these functions effectively with joins and grouping to create powerful analytical queries.</p>
<hr>
<h2 id="%F0%9F%93%9D-quick-practice">ğŸ“ Quick Practice</h2>
<p>Using a sample e-commerce database, try these join exercises:</p>
<ol>
<li><strong>Basic Joins</strong>: Find all customers who have placed orders in the last 30 days</li>
<li><strong>LEFT JOIN</strong>: List all products and their total sales (including products with no sales)</li>
<li><strong>Multiple Joins</strong>: Create a report showing customer name, order date, product name, and category for all orders</li>
<li><strong>Self Join</strong>: Find all employees and their managers in an employee hierarchy</li>
<li><strong>Complex Analysis</strong>: Identify customers who bought products from multiple categories</li>
</ol>
<p>Consider:</p>
<ul>
<li>Which join type is most appropriate for each scenario?</li>
<li>How do you handle NULL values in your results?</li>
<li>What indexes would improve performance?</li>
<li>How do you avoid cartesian products?</li>
</ul>
<h1 id="%F0%9F%93%98-chapter-8-aggregate-functions-count-sum-avg-etc">ğŸ“˜ Chapter 8: Aggregate Functions (COUNT, SUM, AVG, etc.)</h1>
<h2 id="%F0%9F%8E%AF-what-youll-learn">ğŸ¯ What You'll Learn</h2>
<ul>
<li>Understanding aggregate functions and their purpose</li>
<li>COUNT for counting records and non-NULL values</li>
<li>SUM for calculating totals</li>
<li>AVG for calculating averages</li>
<li>MIN and MAX for finding extremes</li>
<li>Advanced aggregate functions (STDDEV, VARIANCE, etc.)</li>
<li>Using aggregates with GROUP BY and HAVING</li>
<li>Window functions vs aggregate functions</li>
<li>Performance considerations</li>
</ul>
<hr>
<h2 id="%F0%9F%93%96-concept-explanation">ğŸ“– Concept Explanation</h2>
<p><strong>Aggregate functions</strong> perform calculations on a set of rows and return a single result. They're essential for data analysis, reporting, and business intelligence. Think of them as &quot;summarizing&quot; your data - turning many rows into meaningful insights.</p>
<h3 id="key-characteristics">Key Characteristics:</h3>
<ol>
<li><strong>Input</strong>: Multiple rows</li>
<li><strong>Output</strong>: Single value</li>
<li><strong>NULL Handling</strong>: Most aggregates ignore NULL values</li>
<li><strong>Grouping</strong>: Work with GROUP BY to create subtotals</li>
<li><strong>Filtering</strong>: Use HAVING to filter aggregated results</li>
</ol>
<h3 id="common-aggregate-functions">Common Aggregate Functions:</h3>
<ul>
<li><strong>COUNT()</strong>: Count rows or non-NULL values</li>
<li><strong>SUM()</strong>: Add up numeric values</li>
<li><strong>AVG()</strong>: Calculate average of numeric values</li>
<li><strong>MIN()</strong>: Find minimum value</li>
<li><strong>MAX()</strong>: Find maximum value</li>
<li><strong>STDDEV()</strong>: Calculate standard deviation</li>
<li><strong>VARIANCE()</strong>: Calculate variance</li>
</ul>
<hr>
<h2 id="%F0%9F%94%A2-count-function">ğŸ”¢ COUNT Function</h2>
<h3 id="count-variations">COUNT Variations</h3>
<pre class="hljs"><code><div>COUNT(*)           <span class="hljs-comment">-- Count all rows (including NULLs)</span>
COUNT(column)      <span class="hljs-comment">-- Count non-NULL values in column</span>
COUNT(DISTINCT column)  <span class="hljs-comment">-- Count unique non-NULL values</span>
</div></code></pre>
<h3 id="basic-count-examples">Basic COUNT Examples</h3>
<p><strong>1. Simple Counting:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Total number of customers</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> total_customers
<span class="hljs-keyword">FROM</span> customers;

<span class="hljs-comment">-- Customers with phone numbers</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(phone) <span class="hljs-keyword">as</span> customers_with_phone
<span class="hljs-keyword">FROM</span> customers;

<span class="hljs-comment">-- Customers with verified emails</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> verified_customers
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> email_verified = <span class="hljs-literal">true</span>;

<span class="hljs-comment">-- Unique countries</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> country) <span class="hljs-keyword">as</span> unique_countries
<span class="hljs-keyword">FROM</span> customers;
</div></code></pre>
<p><strong>2. COUNT with Conditions:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Count orders by status</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> total_orders,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> completed_orders,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'pending'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> pending_orders,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'cancelled'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> cancelled_orders,

    <span class="hljs-comment">-- Calculate percentages</span>
    <span class="hljs-keyword">ROUND</span>(
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) * <span class="hljs-number">100.0</span> / <span class="hljs-keyword">COUNT</span>(*), <span class="hljs-number">2</span>
    ) <span class="hljs-keyword">as</span> completion_rate
<span class="hljs-keyword">FROM</span> orders;

<span class="hljs-comment">-- Count customers by registration year</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> created_at) <span class="hljs-keyword">as</span> registration_year,
    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> new_customers,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> email_verified = <span class="hljs-literal">true</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> verified_customers
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> created_at)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> registration_year;
</div></code></pre>
<p><strong>3. Advanced COUNT Patterns:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Count distinct customers who made purchases in different time periods</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'30 days'</span>
        <span class="hljs-keyword">THEN</span> customer_id
    <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> active_last_30_days,

    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'90 days'</span>
        <span class="hljs-keyword">THEN</span> customer_id
    <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> active_last_90_days,

    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> customer_id) <span class="hljs-keyword">as</span> total_customers_with_orders
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'shipped'</span>, <span class="hljs-string">'delivered'</span>);

<span class="hljs-comment">-- Count products by availability and price range</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> total_products,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> stock_quantity &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> in_stock_products,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> price &lt; <span class="hljs-number">50</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> budget_products,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> price <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">50</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">200</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> mid_range_products,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> price &gt; <span class="hljs-number">200</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> premium_products,

    <span class="hljs-comment">-- Count products with reviews</span>
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> average_rating <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> products_with_reviews
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>;
</div></code></pre>
<hr>
<h2 id="%E2%9E%95-sum-function">â• SUM Function</h2>
<h3 id="basic-sum-examples">Basic SUM Examples</h3>
<p><strong>1. Simple Totals:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Total revenue</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">as</span> total_revenue
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>);

<span class="hljs-comment">-- Total inventory value</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">SUM</span>(price * stock_quantity) <span class="hljs-keyword">as</span> total_inventory_value
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>;

<span class="hljs-comment">-- Total units sold</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">SUM</span>(quantity) <span class="hljs-keyword">as</span> total_units_sold
<span class="hljs-keyword">FROM</span> order_items oi
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
<span class="hljs-keyword">WHERE</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>);
</div></code></pre>
<p><strong>2. Conditional SUM:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Revenue by payment method</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> payment_method = <span class="hljs-string">'credit_card'</span> <span class="hljs-keyword">THEN</span> total_amount <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> credit_card_revenue,
    <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> payment_method = <span class="hljs-string">'paypal'</span> <span class="hljs-keyword">THEN</span> total_amount <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> paypal_revenue,
    <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> payment_method = <span class="hljs-string">'bank_transfer'</span> <span class="hljs-keyword">THEN</span> total_amount <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> bank_transfer_revenue,
    <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">as</span> total_revenue
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>;

<span class="hljs-comment">-- Monthly revenue comparison</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> order_date) <span class="hljs-keyword">as</span> <span class="hljs-keyword">month</span>,
    <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">as</span> monthly_revenue,
    <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> order_date) = <span class="hljs-number">2024</span> <span class="hljs-keyword">THEN</span> total_amount <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> revenue_2024,
    <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> order_date) = <span class="hljs-number">2023</span> <span class="hljs-keyword">THEN</span> total_amount <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> revenue_2023
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
  <span class="hljs-keyword">AND</span> order_date &gt;= <span class="hljs-string">'2023-01-01'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> order_date)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>;
</div></code></pre>
<p><strong>3. SUM with Joins:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Revenue by product category</span>
<span class="hljs-keyword">SELECT</span>
    c.category_name,
    <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">as</span> category_revenue,
    <span class="hljs-keyword">SUM</span>(oi.quantity) <span class="hljs-keyword">as</span> units_sold,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.order_id) <span class="hljs-keyword">as</span> order_count,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.customer_id) <span class="hljs-keyword">as</span> unique_customers
<span class="hljs-keyword">FROM</span> categories c
<span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> c.category_id = p.category_id
<span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> p.product_id = oi.product_id
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
<span class="hljs-keyword">WHERE</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
  <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'1 year'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.category_id, c.category_name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> category_revenue <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Customer lifetime value</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email,
    <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">as</span> total_orders,
    <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> lifetime_value,
    <span class="hljs-keyword">AVG</span>(o.total_amount) <span class="hljs-keyword">as</span> avg_order_value,
    <span class="hljs-keyword">MIN</span>(o.order_date) <span class="hljs-keyword">as</span> first_order_date,
    <span class="hljs-keyword">MAX</span>(o.order_date) <span class="hljs-keyword">as</span> last_order_date
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">WHERE</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name, c.email
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">SUM</span>(o.total_amount) &gt; <span class="hljs-number">500</span>  <span class="hljs-comment">-- High-value customers only</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> lifetime_value <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%8A-avg-function">ğŸ“Š AVG Function</h2>
<h3 id="basic-avg-examples">Basic AVG Examples</h3>
<p><strong>1. Simple Averages:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Average order value</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AVG</span>(total_amount) <span class="hljs-keyword">as</span> avg_order_value
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>;

<span class="hljs-comment">-- Average product price by category</span>
<span class="hljs-keyword">SELECT</span>
    c.category_name,
    <span class="hljs-keyword">AVG</span>(p.price) <span class="hljs-keyword">as</span> avg_price,
    <span class="hljs-keyword">COUNT</span>(p.product_id) <span class="hljs-keyword">as</span> product_count
<span class="hljs-keyword">FROM</span> categories c
<span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> c.category_id = p.category_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.category_id, c.category_name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> avg_price <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Average customer age</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">AVG</span>(<span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> age(date_of_birth))) <span class="hljs-keyword">as</span> avg_age
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> date_of_birth <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>;
</div></code></pre>
<p><strong>2. Weighted Averages:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Weighted average product rating (by number of reviews)</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    <span class="hljs-keyword">COUNT</span>(r.review_id) <span class="hljs-keyword">as</span> review_count,
    <span class="hljs-keyword">AVG</span>(r.rating) <span class="hljs-keyword">as</span> avg_rating,

    <span class="hljs-comment">-- Weighted average considering review volume</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COUNT</span>(r.review_id) &gt;= <span class="hljs-number">10</span> <span class="hljs-keyword">THEN</span> <span class="hljs-keyword">AVG</span>(r.rating)
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COUNT</span>(r.review_id) &gt;= <span class="hljs-number">5</span> <span class="hljs-keyword">THEN</span> <span class="hljs-keyword">AVG</span>(r.rating) * <span class="hljs-number">0.9</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COUNT</span>(r.review_id) &gt;= <span class="hljs-number">1</span> <span class="hljs-keyword">THEN</span> <span class="hljs-keyword">AVG</span>(r.rating) * <span class="hljs-number">0.8</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> weighted_rating
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> reviews r <span class="hljs-keyword">ON</span> p.product_id = r.product_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> p.product_id, p.product_name
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(r.review_id) &gt; <span class="hljs-number">0</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> weighted_rating <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Average order value by customer segment</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> customer_orders.order_count = <span class="hljs-number">1</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'One-time'</span>
        <span class="hljs-keyword">WHEN</span> customer_orders.order_count <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">2</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">5</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Occasional'</span>
        <span class="hljs-keyword">WHEN</span> customer_orders.order_count <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">6</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">15</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Regular'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'VIP'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> customer_segment,
    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> customers_in_segment,
    <span class="hljs-keyword">AVG</span>(customer_orders.avg_order_value) <span class="hljs-keyword">as</span> segment_avg_order_value,
    <span class="hljs-keyword">AVG</span>(customer_orders.total_spent) <span class="hljs-keyword">as</span> segment_avg_lifetime_value
<span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span>
        c.customer_id,
        <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">as</span> order_count,
        <span class="hljs-keyword">AVG</span>(o.total_amount) <span class="hljs-keyword">as</span> avg_order_value,
        <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> total_spent
    <span class="hljs-keyword">FROM</span> customers c
    <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
    <span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id
) customer_orders
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_segment
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> segment_avg_lifetime_value <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<p><strong>3. Moving Averages:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- 7-day moving average of daily sales</span>
<span class="hljs-keyword">SELECT</span>
    order_date,
    daily_revenue,
    <span class="hljs-keyword">AVG</span>(daily_revenue) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">6</span> <span class="hljs-keyword">PRECEDING</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">ROW</span>
    ) <span class="hljs-keyword">as</span> moving_avg_7_days
<span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span>
        <span class="hljs-built_in">DATE</span>(order_date) <span class="hljs-keyword">as</span> order_date,
        <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">as</span> daily_revenue
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
      <span class="hljs-keyword">AND</span> order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'90 days'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">DATE</span>(order_date)
) daily_sales
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date;
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%8D-min-and-max-functions">ğŸ” MIN and MAX Functions</h2>
<h3 id="basic-minmax-examples">Basic MIN/MAX Examples</h3>
<p><strong>1. Simple Extremes:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Price range analysis</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">MIN</span>(price) <span class="hljs-keyword">as</span> cheapest_product,
    <span class="hljs-keyword">MAX</span>(price) <span class="hljs-keyword">as</span> most_expensive_product,
    <span class="hljs-keyword">AVG</span>(price) <span class="hljs-keyword">as</span> average_price,
    <span class="hljs-keyword">MAX</span>(price) - <span class="hljs-keyword">MIN</span>(price) <span class="hljs-keyword">as</span> price_range
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>;

<span class="hljs-comment">-- Order date range</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">MIN</span>(order_date) <span class="hljs-keyword">as</span> first_order,
    <span class="hljs-keyword">MAX</span>(order_date) <span class="hljs-keyword">as</span> latest_order,
    <span class="hljs-keyword">MAX</span>(order_date) - <span class="hljs-keyword">MIN</span>(order_date) <span class="hljs-keyword">as</span> business_duration_days
<span class="hljs-keyword">FROM</span> orders;

<span class="hljs-comment">-- Customer age demographics</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">MIN</span>(<span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> age(date_of_birth))) <span class="hljs-keyword">as</span> youngest_customer,
    <span class="hljs-keyword">MAX</span>(<span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> age(date_of_birth))) <span class="hljs-keyword">as</span> oldest_customer,
    <span class="hljs-keyword">AVG</span>(<span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> age(date_of_birth))) <span class="hljs-keyword">as</span> average_age
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> date_of_birth <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>;
</div></code></pre>
<p><strong>2. MIN/MAX with GROUP BY:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Price range by category</span>
<span class="hljs-keyword">SELECT</span>
    c.category_name,
    <span class="hljs-keyword">COUNT</span>(p.product_id) <span class="hljs-keyword">as</span> product_count,
    <span class="hljs-keyword">MIN</span>(p.price) <span class="hljs-keyword">as</span> min_price,
    <span class="hljs-keyword">MAX</span>(p.price) <span class="hljs-keyword">as</span> max_price,
    <span class="hljs-keyword">AVG</span>(p.price) <span class="hljs-keyword">as</span> avg_price,
    <span class="hljs-keyword">MAX</span>(p.price) - <span class="hljs-keyword">MIN</span>(p.price) <span class="hljs-keyword">as</span> price_range
<span class="hljs-keyword">FROM</span> categories c
<span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> c.category_id = p.category_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.category_id, c.category_name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> price_range <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Customer order patterns</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">as</span> total_orders,
    <span class="hljs-keyword">MIN</span>(o.order_date) <span class="hljs-keyword">as</span> first_order_date,
    <span class="hljs-keyword">MAX</span>(o.order_date) <span class="hljs-keyword">as</span> last_order_date,
    <span class="hljs-keyword">MIN</span>(o.total_amount) <span class="hljs-keyword">as</span> smallest_order,
    <span class="hljs-keyword">MAX</span>(o.total_amount) <span class="hljs-keyword">as</span> largest_order,

    <span class="hljs-comment">-- Calculate customer lifecycle metrics</span>
    <span class="hljs-keyword">MAX</span>(o.order_date) - <span class="hljs-keyword">MIN</span>(o.order_date) <span class="hljs-keyword">as</span> customer_lifespan_days,
    <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-keyword">MAX</span>(o.order_date) <span class="hljs-keyword">as</span> days_since_last_order
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(o.order_id) &gt; <span class="hljs-number">1</span>  <span class="hljs-comment">-- Multi-order customers only</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> customer_lifespan_days <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<p><strong>3. Finding Records with MIN/MAX Values:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Most expensive product in each category</span>
<span class="hljs-keyword">SELECT</span>
    c.category_name,
    p.product_name,
    p.price
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">WHERE</span> p.price = (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">MAX</span>(p2.price)
    <span class="hljs-keyword">FROM</span> products p2
    <span class="hljs-keyword">WHERE</span> p2.category_id = p.category_id
      <span class="hljs-keyword">AND</span> p2.status = <span class="hljs-string">'active'</span>
)
<span class="hljs-keyword">AND</span> p.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.price <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Latest order for each customer</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    o.order_id,
    o.order_date,
    o.total_amount
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">WHERE</span> o.order_date = (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">MAX</span>(o2.order_date)
    <span class="hljs-keyword">FROM</span> orders o2
    <span class="hljs-keyword">WHERE</span> o2.customer_id = c.customer_id
      <span class="hljs-keyword">AND</span> o2.status = <span class="hljs-string">'completed'</span>
)
<span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> o.order_date <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%88-advanced-aggregate-functions">ğŸ“ˆ Advanced Aggregate Functions</h2>
<h3 id="statistical-functions">Statistical Functions</h3>
<p><strong>1. Standard Deviation and Variance:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Price distribution analysis</span>
<span class="hljs-keyword">SELECT</span>
    c.category_name,
    <span class="hljs-keyword">COUNT</span>(p.product_id) <span class="hljs-keyword">as</span> product_count,
    <span class="hljs-keyword">AVG</span>(p.price) <span class="hljs-keyword">as</span> avg_price,
    <span class="hljs-keyword">STDDEV</span>(p.price) <span class="hljs-keyword">as</span> price_stddev,
    <span class="hljs-keyword">VARIANCE</span>(p.price) <span class="hljs-keyword">as</span> price_variance,

    <span class="hljs-comment">-- Coefficient of variation (relative variability)</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">AVG</span>(p.price) &gt; <span class="hljs-number">0</span>
        <span class="hljs-keyword">THEN</span> <span class="hljs-keyword">STDDEV</span>(p.price) / <span class="hljs-keyword">AVG</span>(p.price)
        <span class="hljs-keyword">ELSE</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> coefficient_of_variation
<span class="hljs-keyword">FROM</span> categories c
<span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> c.category_id = p.category_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.category_id, c.category_name
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(p.product_id) &gt;= <span class="hljs-number">5</span>  <span class="hljs-comment">-- Categories with enough products</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> coefficient_of_variation <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Order value consistency by customer</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">as</span> order_count,
    <span class="hljs-keyword">AVG</span>(o.total_amount) <span class="hljs-keyword">as</span> avg_order_value,
    <span class="hljs-keyword">STDDEV</span>(o.total_amount) <span class="hljs-keyword">as</span> order_value_stddev,

    <span class="hljs-comment">-- Customer spending consistency</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">STDDEV</span>(o.total_amount) &lt; <span class="hljs-keyword">AVG</span>(o.total_amount) * <span class="hljs-number">0.3</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Consistent'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">STDDEV</span>(o.total_amount) &lt; <span class="hljs-keyword">AVG</span>(o.total_amount) * <span class="hljs-number">0.7</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Moderate'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Variable'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> spending_pattern
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(o.order_id) &gt;= <span class="hljs-number">5</span>  <span class="hljs-comment">-- Customers with enough orders</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_value_stddev <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<p><strong>2. Percentiles (PostgreSQL):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Order value percentiles</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">PERCENTILE_CONT</span>(<span class="hljs-number">0.25</span>) <span class="hljs-keyword">WITHIN</span> <span class="hljs-keyword">GROUP</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_amount) <span class="hljs-keyword">as</span> q1_25th_percentile,
    <span class="hljs-keyword">PERCENTILE_CONT</span>(<span class="hljs-number">0.5</span>) <span class="hljs-keyword">WITHIN</span> <span class="hljs-keyword">GROUP</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_amount) <span class="hljs-keyword">as</span> median_50th_percentile,
    <span class="hljs-keyword">PERCENTILE_CONT</span>(<span class="hljs-number">0.75</span>) <span class="hljs-keyword">WITHIN</span> <span class="hljs-keyword">GROUP</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_amount) <span class="hljs-keyword">as</span> q3_75th_percentile,
    <span class="hljs-keyword">PERCENTILE_CONT</span>(<span class="hljs-number">0.9</span>) <span class="hljs-keyword">WITHIN</span> <span class="hljs-keyword">GROUP</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_amount) <span class="hljs-keyword">as</span> p90_90th_percentile,
    <span class="hljs-keyword">PERCENTILE_CONT</span>(<span class="hljs-number">0.95</span>) <span class="hljs-keyword">WITHIN</span> <span class="hljs-keyword">GROUP</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_amount) <span class="hljs-keyword">as</span> p95_95th_percentile
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
  <span class="hljs-keyword">AND</span> order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'1 year'</span>;

<span class="hljs-comment">-- Customer spending distribution</span>
<span class="hljs-keyword">SELECT</span>
    customer_segment,
    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> customer_count,
    <span class="hljs-keyword">AVG</span>(total_spent) <span class="hljs-keyword">as</span> avg_spent,
    <span class="hljs-keyword">PERCENTILE_CONT</span>(<span class="hljs-number">0.5</span>) <span class="hljs-keyword">WITHIN</span> <span class="hljs-keyword">GROUP</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_spent) <span class="hljs-keyword">as</span> median_spent
<span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span>
        c.customer_id,
        <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> total_spent,
        <span class="hljs-keyword">CASE</span>
            <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">SUM</span>(o.total_amount) &lt; <span class="hljs-number">100</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Low Value'</span>
            <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">SUM</span>(o.total_amount) &lt; <span class="hljs-number">500</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Medium Value'</span>
            <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">SUM</span>(o.total_amount) &lt; <span class="hljs-number">2000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'High Value'</span>
            <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Premium Value'</span>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> customer_segment
    <span class="hljs-keyword">FROM</span> customers c
    <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
    <span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id
) customer_spending
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_segment
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> avg_spent <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<h3 id="string-aggregation">String Aggregation</h3>
<p><strong>1. STRING_AGG (PostgreSQL) / GROUP_CONCAT (MySQL):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- PostgreSQL: Concatenate product names by category</span>
<span class="hljs-keyword">SELECT</span>
    c.category_name,
    <span class="hljs-keyword">COUNT</span>(p.product_id) <span class="hljs-keyword">as</span> product_count,
    STRING_AGG(p.product_name, <span class="hljs-string">', '</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.product_name) <span class="hljs-keyword">as</span> product_list
<span class="hljs-keyword">FROM</span> categories c
<span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> c.category_id = p.category_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.category_id, c.category_name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> product_count <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- MySQL: Same functionality with GROUP_CONCAT</span>
<span class="hljs-keyword">SELECT</span>
    c.category_name,
    <span class="hljs-keyword">COUNT</span>(p.product_id) <span class="hljs-keyword">as</span> product_count,
    <span class="hljs-keyword">GROUP_CONCAT</span>(p.product_name <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.product_name SEPARATOR <span class="hljs-string">', '</span>) <span class="hljs-keyword">as</span> product_list
<span class="hljs-keyword">FROM</span> categories c
<span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> c.category_id = p.category_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.category_id, c.category_name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> product_count <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Customer order history summary</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">as</span> order_count,
    <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> total_spent,
    STRING_AGG(
        o.order_id::<span class="hljs-built_in">text</span> || <span class="hljs-string">' ($'</span> || o.total_amount || <span class="hljs-string">')'</span>,
        <span class="hljs-string">', '</span>
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> o.order_date <span class="hljs-keyword">DESC</span>
    ) <span class="hljs-keyword">as</span> order_history
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(o.order_id) &lt;= <span class="hljs-number">5</span>  <span class="hljs-comment">-- Customers with few orders</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_spent <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%84-aggregate-functions-with-window-functions">ğŸ”„ Aggregate Functions with Window Functions</h2>
<h3 id="running-totals-and-cumulative-aggregates">Running Totals and Cumulative Aggregates</h3>
<p><strong>1. Running Totals:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Daily sales with running total</span>
<span class="hljs-keyword">SELECT</span>
    order_date,
    daily_revenue,
    <span class="hljs-keyword">SUM</span>(daily_revenue) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">PRECEDING</span>
    ) <span class="hljs-keyword">as</span> running_total,

    <span class="hljs-comment">-- Running average</span>
    <span class="hljs-keyword">AVG</span>(daily_revenue) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">PRECEDING</span>
    ) <span class="hljs-keyword">as</span> running_average
<span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span>
        <span class="hljs-built_in">DATE</span>(order_date) <span class="hljs-keyword">as</span> order_date,
        <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">as</span> daily_revenue
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
      <span class="hljs-keyword">AND</span> order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'90 days'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">DATE</span>(order_date)
) daily_sales
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date;
</div></code></pre>
<p><strong>2. Ranking with Aggregates:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Top customers by spending with rankings</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> total_spent,
    <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">as</span> order_count,
    <span class="hljs-keyword">AVG</span>(o.total_amount) <span class="hljs-keyword">as</span> avg_order_value,

    <span class="hljs-comment">-- Rankings</span>
    <span class="hljs-keyword">RANK</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">as</span> spending_rank,
    <span class="hljs-keyword">RANK</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">as</span> frequency_rank,
    <span class="hljs-keyword">RANK</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">AVG</span>(o.total_amount) <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">as</span> avg_value_rank,

    <span class="hljs-comment">-- Percentile rankings</span>
    <span class="hljs-keyword">PERCENT_RANK</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">SUM</span>(o.total_amount)) <span class="hljs-keyword">as</span> spending_percentile
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_spent <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%92%A1-real-world-aggregate-examples">ğŸ’¡ Real-World Aggregate Examples</h2>
<h3 id="example-1-sales-performance-dashboard">Example 1: Sales Performance Dashboard</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Comprehensive sales dashboard with multiple aggregates</span>
<span class="hljs-keyword">WITH</span> monthly_sales <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        DATE_TRUNC(<span class="hljs-string">'month'</span>, o.order_date) <span class="hljs-keyword">as</span> <span class="hljs-keyword">month</span>,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.order_id) <span class="hljs-keyword">as</span> order_count,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.customer_id) <span class="hljs-keyword">as</span> unique_customers,
        <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> revenue,
        <span class="hljs-keyword">AVG</span>(o.total_amount) <span class="hljs-keyword">as</span> avg_order_value,
        <span class="hljs-keyword">MIN</span>(o.total_amount) <span class="hljs-keyword">as</span> min_order_value,
        <span class="hljs-keyword">MAX</span>(o.total_amount) <span class="hljs-keyword">as</span> max_order_value,
        <span class="hljs-keyword">STDDEV</span>(o.total_amount) <span class="hljs-keyword">as</span> order_value_stddev
    <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">WHERE</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
      <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> DATE_TRUNC(<span class="hljs-string">'month'</span>, o.order_date)
),
product_performance <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        DATE_TRUNC(<span class="hljs-string">'month'</span>, o.order_date) <span class="hljs-keyword">as</span> <span class="hljs-keyword">month</span>,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> oi.product_id) <span class="hljs-keyword">as</span> unique_products_sold,
        <span class="hljs-keyword">SUM</span>(oi.quantity) <span class="hljs-keyword">as</span> total_units_sold,
        <span class="hljs-keyword">AVG</span>(oi.unit_price) <span class="hljs-keyword">as</span> avg_unit_price
    <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> o.order_id = oi.order_id
    <span class="hljs-keyword">WHERE</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
      <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> DATE_TRUNC(<span class="hljs-string">'month'</span>, o.order_date)
)
<span class="hljs-keyword">SELECT</span>
    ms.month,
    TO_CHAR(ms.month, <span class="hljs-string">'YYYY-MM'</span>) <span class="hljs-keyword">as</span> month_label,

    <span class="hljs-comment">-- Order metrics</span>
    ms.order_count,
    ms.unique_customers,
    ms.revenue,
    ms.avg_order_value,
    ms.order_value_stddev,

    <span class="hljs-comment">-- Product metrics</span>
    pp.unique_products_sold,
    pp.total_units_sold,
    pp.avg_unit_price,

    <span class="hljs-comment">-- Calculated metrics</span>
    <span class="hljs-keyword">ROUND</span>(ms.revenue / ms.order_count, <span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> revenue_per_order,
    <span class="hljs-keyword">ROUND</span>(ms.revenue / ms.unique_customers, <span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> revenue_per_customer,
    <span class="hljs-keyword">ROUND</span>(pp.total_units_sold::<span class="hljs-built_in">float</span> / ms.order_count, <span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> units_per_order,

    <span class="hljs-comment">-- Growth metrics (compared to previous month)</span>
    LAG(ms.revenue) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ms.month) <span class="hljs-keyword">as</span> prev_month_revenue,
    <span class="hljs-keyword">ROUND</span>(
        (ms.revenue - LAG(ms.revenue) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ms.month)) /
        LAG(ms.revenue) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ms.month) * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>
    ) <span class="hljs-keyword">as</span> revenue_growth_percent
<span class="hljs-keyword">FROM</span> monthly_sales ms
<span class="hljs-keyword">JOIN</span> product_performance pp <span class="hljs-keyword">ON</span> ms.month = pp.month
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ms.month <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<h3 id="example-2-customer-segmentation-analysis">Example 2: Customer Segmentation Analysis</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- RFM Analysis using aggregates</span>
<span class="hljs-keyword">WITH</span> customer_rfm <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        c.customer_id,
        c.first_name,
        c.last_name,
        c.email,

        <span class="hljs-comment">-- Recency: Days since last order</span>
        <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-keyword">MAX</span>(o.order_date) <span class="hljs-keyword">as</span> days_since_last_order,

        <span class="hljs-comment">-- Frequency: Number of orders</span>
        <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">as</span> order_frequency,

        <span class="hljs-comment">-- Monetary: Total amount spent</span>
        <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> total_monetary_value,
        <span class="hljs-keyword">AVG</span>(o.total_amount) <span class="hljs-keyword">as</span> avg_order_value,

        <span class="hljs-comment">-- Additional metrics</span>
        <span class="hljs-keyword">MIN</span>(o.order_date) <span class="hljs-keyword">as</span> first_order_date,
        <span class="hljs-keyword">MAX</span>(o.order_date) <span class="hljs-keyword">as</span> last_order_date,
        <span class="hljs-keyword">MAX</span>(o.order_date) - <span class="hljs-keyword">MIN</span>(o.order_date) <span class="hljs-keyword">as</span> customer_lifespan_days
    <span class="hljs-keyword">FROM</span> customers c
    <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
    <span class="hljs-keyword">WHERE</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name, c.email
),
rfm_scores <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        *,
        <span class="hljs-comment">-- Recency score (lower days = higher score)</span>
        <span class="hljs-keyword">CASE</span>
            <span class="hljs-keyword">WHEN</span> days_since_last_order &lt;= <span class="hljs-number">30</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">5</span>
            <span class="hljs-keyword">WHEN</span> days_since_last_order &lt;= <span class="hljs-number">60</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">4</span>
            <span class="hljs-keyword">WHEN</span> days_since_last_order &lt;= <span class="hljs-number">90</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">3</span>
            <span class="hljs-keyword">WHEN</span> days_since_last_order &lt;= <span class="hljs-number">180</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">2</span>
            <span class="hljs-keyword">ELSE</span> <span class="hljs-number">1</span>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> recency_score,

        <span class="hljs-comment">-- Frequency score</span>
        <span class="hljs-keyword">CASE</span>
            <span class="hljs-keyword">WHEN</span> order_frequency &gt;= <span class="hljs-number">20</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">5</span>
            <span class="hljs-keyword">WHEN</span> order_frequency &gt;= <span class="hljs-number">10</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">4</span>
            <span class="hljs-keyword">WHEN</span> order_frequency &gt;= <span class="hljs-number">5</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">3</span>
            <span class="hljs-keyword">WHEN</span> order_frequency &gt;= <span class="hljs-number">2</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">2</span>
            <span class="hljs-keyword">ELSE</span> <span class="hljs-number">1</span>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> frequency_score,

        <span class="hljs-comment">-- Monetary score</span>
        <span class="hljs-keyword">CASE</span>
            <span class="hljs-keyword">WHEN</span> total_monetary_value &gt;= <span class="hljs-number">2000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">5</span>
            <span class="hljs-keyword">WHEN</span> total_monetary_value &gt;= <span class="hljs-number">1000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">4</span>
            <span class="hljs-keyword">WHEN</span> total_monetary_value &gt;= <span class="hljs-number">500</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">3</span>
            <span class="hljs-keyword">WHEN</span> total_monetary_value &gt;= <span class="hljs-number">100</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">2</span>
            <span class="hljs-keyword">ELSE</span> <span class="hljs-number">1</span>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> monetary_score
    <span class="hljs-keyword">FROM</span> customer_rfm
)
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-comment">-- Customer segments based on RFM scores</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> recency_score &gt;= <span class="hljs-number">4</span> <span class="hljs-keyword">AND</span> frequency_score &gt;= <span class="hljs-number">4</span> <span class="hljs-keyword">AND</span> monetary_score &gt;= <span class="hljs-number">4</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Champions'</span>
        <span class="hljs-keyword">WHEN</span> recency_score &gt;= <span class="hljs-number">3</span> <span class="hljs-keyword">AND</span> frequency_score &gt;= <span class="hljs-number">3</span> <span class="hljs-keyword">AND</span> monetary_score &gt;= <span class="hljs-number">3</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Loyal Customers'</span>
        <span class="hljs-keyword">WHEN</span> recency_score &gt;= <span class="hljs-number">4</span> <span class="hljs-keyword">AND</span> frequency_score &lt;= <span class="hljs-number">2</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'New Customers'</span>
        <span class="hljs-keyword">WHEN</span> recency_score &lt;= <span class="hljs-number">2</span> <span class="hljs-keyword">AND</span> frequency_score &gt;= <span class="hljs-number">3</span> <span class="hljs-keyword">AND</span> monetary_score &gt;= <span class="hljs-number">3</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'At Risk'</span>
        <span class="hljs-keyword">WHEN</span> recency_score &lt;= <span class="hljs-number">2</span> <span class="hljs-keyword">AND</span> frequency_score &lt;= <span class="hljs-number">2</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Lost Customers'</span>
        <span class="hljs-keyword">WHEN</span> frequency_score &gt;= <span class="hljs-number">3</span> <span class="hljs-keyword">AND</span> monetary_score &lt;= <span class="hljs-number">2</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Price Sensitive'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Others'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> customer_segment,

    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> customer_count,
    <span class="hljs-keyword">AVG</span>(total_monetary_value) <span class="hljs-keyword">as</span> avg_monetary_value,
    <span class="hljs-keyword">AVG</span>(order_frequency) <span class="hljs-keyword">as</span> avg_frequency,
    <span class="hljs-keyword">AVG</span>(days_since_last_order) <span class="hljs-keyword">as</span> avg_recency,
    <span class="hljs-keyword">SUM</span>(total_monetary_value) <span class="hljs-keyword">as</span> segment_total_value,

    <span class="hljs-comment">-- Segment percentages</span>
    <span class="hljs-keyword">ROUND</span>(
        <span class="hljs-keyword">COUNT</span>(*) * <span class="hljs-number">100.0</span> / <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">COUNT</span>(*)) <span class="hljs-keyword">OVER</span> (), <span class="hljs-number">2</span>
    ) <span class="hljs-keyword">as</span> segment_percentage
<span class="hljs-keyword">FROM</span> rfm_scores
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_segment
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> segment_total_value <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<h3 id="example-3-product-performance-analysis">Example 3: Product Performance Analysis</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Comprehensive product analysis with multiple aggregates</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    c.category_name,
    p.price <span class="hljs-keyword">as</span> current_price,
    p.stock_quantity,

    <span class="hljs-comment">-- Sales metrics (last 12 months)</span>
    <span class="hljs-keyword">COALESCE</span>(sales.units_sold, <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> units_sold_12m,
    <span class="hljs-keyword">COALESCE</span>(sales.revenue, <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> revenue_12m,
    <span class="hljs-keyword">COALESCE</span>(sales.order_count, <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> order_count_12m,
    <span class="hljs-keyword">COALESCE</span>(sales.unique_customers, <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> unique_customers_12m,
    <span class="hljs-keyword">COALESCE</span>(sales.avg_unit_price, p.price) <span class="hljs-keyword">as</span> avg_selling_price,

    <span class="hljs-comment">-- Review metrics</span>
    <span class="hljs-keyword">COALESCE</span>(reviews.review_count, <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> review_count,
    <span class="hljs-keyword">COALESCE</span>(reviews.avg_rating, <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> avg_rating,
    <span class="hljs-keyword">COALESCE</span>(reviews.rating_stddev, <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> rating_stddev,

    <span class="hljs-comment">-- Performance calculations</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> sales.units_sold &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-keyword">ROUND</span>(sales.revenue / sales.units_sold, <span class="hljs-number">2</span>)
        <span class="hljs-keyword">ELSE</span> p.price
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> actual_avg_price,

    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> sales.units_sold &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-keyword">ROUND</span>((p.price - sales.avg_unit_price) / p.price * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>)
        <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> avg_discount_percent,

    <span class="hljs-comment">-- Inventory turnover (annual rate)</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> p.stock_quantity &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">AND</span> sales.units_sold &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-keyword">ROUND</span>(sales.units_sold::<span class="hljs-built_in">float</span> / p.stock_quantity, <span class="hljs-number">2</span>)
        <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> inventory_turnover_rate,

    <span class="hljs-comment">-- Performance categories</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COALESCE</span>(sales.revenue, <span class="hljs-number">0</span>) = <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'No Sales'</span>
        <span class="hljs-keyword">WHEN</span> sales.revenue &gt; <span class="hljs-number">10000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Top Performer'</span>
        <span class="hljs-keyword">WHEN</span> sales.revenue &gt; <span class="hljs-number">5000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Good Performer'</span>
        <span class="hljs-keyword">WHEN</span> sales.revenue &gt; <span class="hljs-number">1000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Average Performer'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Poor Performer'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> performance_category,

    <span class="hljs-comment">-- Stock status</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> p.stock_quantity = <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Out of Stock'</span>
        <span class="hljs-keyword">WHEN</span> p.stock_quantity &lt; <span class="hljs-number">10</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Low Stock'</span>
        <span class="hljs-keyword">WHEN</span> sales.units_sold &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">AND</span>
             (p.stock_quantity::<span class="hljs-built_in">float</span> / (sales.units_sold / <span class="hljs-number">12.0</span>)) &lt; <span class="hljs-number">30</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Fast Moving'</span>
        <span class="hljs-keyword">WHEN</span> sales.units_sold &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">AND</span>
             (p.stock_quantity::<span class="hljs-built_in">float</span> / (sales.units_sold / <span class="hljs-number">12.0</span>)) &gt; <span class="hljs-number">180</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Slow Moving'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Normal Stock'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> stock_status
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span>
        oi.product_id,
        <span class="hljs-keyword">SUM</span>(oi.quantity) <span class="hljs-keyword">as</span> units_sold,
        <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">as</span> revenue,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> oi.order_id) <span class="hljs-keyword">as</span> order_count,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.customer_id) <span class="hljs-keyword">as</span> unique_customers,
        <span class="hljs-keyword">AVG</span>(oi.unit_price) <span class="hljs-keyword">as</span> avg_unit_price
    <span class="hljs-keyword">FROM</span> order_items oi
    <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
    <span class="hljs-keyword">WHERE</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
      <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> oi.product_id
) sales <span class="hljs-keyword">ON</span> p.product_id = sales.product_id
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span>
        product_id,
        <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> review_count,
        <span class="hljs-keyword">AVG</span>(rating) <span class="hljs-keyword">as</span> avg_rating,
        <span class="hljs-keyword">STDDEV</span>(rating) <span class="hljs-keyword">as</span> rating_stddev
    <span class="hljs-keyword">FROM</span> reviews
    <span class="hljs-keyword">WHERE</span> created_at &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> product_id
) reviews <span class="hljs-keyword">ON</span> p.product_id = reviews.product_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> revenue_12m <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-use-cases--interview-tips">ğŸ¯ Use Cases &amp; Interview Tips</h2>
<h3 id="common-interview-questions">Common Interview Questions:</h3>
<ol>
<li>
<p><strong>&quot;What's the difference between COUNT(*) and COUNT(column)?&quot;</strong></p>
<ul>
<li>COUNT(*): Counts all rows, including those with NULL values</li>
<li>COUNT(column): Counts only non-NULL values in the specified column</li>
<li>COUNT(DISTINCT column): Counts unique non-NULL values</li>
</ul>
</li>
<li>
<p><strong>&quot;How do aggregate functions handle NULL values?&quot;</strong></p>
<ul>
<li>Most aggregates (SUM, AVG, MIN, MAX) ignore NULL values</li>
<li>COUNT(*) includes rows with NULLs, COUNT(column) excludes them</li>
<li>If all values are NULL, SUM returns NULL, COUNT returns 0</li>
</ul>
</li>
<li>
<p><strong>&quot;When would you use HAVING vs WHERE?&quot;</strong></p>
<ul>
<li>WHERE: Filters rows before grouping and aggregation</li>
<li>HAVING: Filters groups after aggregation</li>
<li>HAVING can use aggregate functions, WHERE cannot</li>
</ul>
</li>
</ol>
<h3 id="performance-best-practices">Performance Best Practices:</h3>
<ol>
<li>
<p><strong>Index Strategy for Aggregates:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Create indexes for GROUP BY columns</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_orders_customer_date <span class="hljs-keyword">ON</span> orders(customer_id, order_date);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_order_items_product <span class="hljs-keyword">ON</span> order_items(product_id);

<span class="hljs-comment">-- Covering indexes for common aggregate queries</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_orders_status_date_amount <span class="hljs-keyword">ON</span> orders(<span class="hljs-keyword">status</span>, order_date, total_amount);
</div></code></pre>
</li>
<li>
<p><strong>Efficient Aggregate Queries:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Good: Filter before aggregating</span>
<span class="hljs-keyword">SELECT</span> customer_id, <span class="hljs-keyword">SUM</span>(total_amount)
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>  <span class="hljs-comment">-- Filter first</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id;

<span class="hljs-comment">-- Avoid: Aggregating then filtering</span>
<span class="hljs-keyword">SELECT</span> customer_id, total_spent
<span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span> customer_id, <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">as</span> total_spent
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id
) t
<span class="hljs-keyword">WHERE</span> total_spent &gt; <span class="hljs-number">1000</span>;  <span class="hljs-comment">-- Better to use HAVING</span>
</div></code></pre>
</li>
<li>
<p><strong>Use Appropriate Data Types:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Use DECIMAL for monetary calculations</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">SUM</span>(price::<span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)) <span class="hljs-keyword">FROM</span> products;

<span class="hljs-comment">-- Be careful with integer division</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AVG</span>(price::<span class="hljs-built_in">FLOAT</span>) <span class="hljs-keyword">FROM</span> products;  <span class="hljs-comment">-- Avoid integer truncation</span>
</div></code></pre>
</li>
</ol>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-things-to-watch-out-for">âš ï¸ Things to Watch Out For</h2>
<h3 id="1-null-handling-gotchas">1. <strong>NULL Handling Gotchas</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Unexpected results with NULLs</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AVG</span>(rating) <span class="hljs-keyword">FROM</span> reviews;  <span class="hljs-comment">-- Ignores NULL ratings</span>

<span class="hljs-comment">-- Solution: Handle NULLs explicitly</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">AVG</span>(rating) <span class="hljs-keyword">as</span> avg_rating_excluding_nulls,
    <span class="hljs-keyword">AVG</span>(<span class="hljs-keyword">COALESCE</span>(rating, <span class="hljs-number">0</span>)) <span class="hljs-keyword">as</span> avg_rating_including_nulls_as_zero,
    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> total_reviews,
    <span class="hljs-keyword">COUNT</span>(rating) <span class="hljs-keyword">as</span> reviews_with_rating
<span class="hljs-keyword">FROM</span> reviews;
</div></code></pre>
<h3 id="2-integer-division-issues">2. <strong>Integer Division Issues</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Integer division truncates</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-number">5</span> / <span class="hljs-number">2</span>;  <span class="hljs-comment">-- Returns 2, not 2.5</span>

<span class="hljs-comment">-- Solution: Cast to decimal/float</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-number">5.0</span> / <span class="hljs-number">2</span>;  <span class="hljs-comment">-- Returns 2.5</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-number">5</span>::<span class="hljs-built_in">FLOAT</span> / <span class="hljs-number">2</span>;  <span class="hljs-comment">-- PostgreSQL</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CAST</span>(<span class="hljs-number">5</span> <span class="hljs-keyword">AS</span> <span class="hljs-built_in">FLOAT</span>) / <span class="hljs-number">2</span>;  <span class="hljs-comment">-- Standard SQL</span>
</div></code></pre>
<h3 id="3-group-by-requirements">3. <strong>GROUP BY Requirements</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Error: Non-aggregated column not in GROUP BY</span>
<span class="hljs-keyword">SELECT</span> customer_id, order_date, <span class="hljs-keyword">COUNT</span>(*)
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id;  <span class="hljs-comment">-- order_date must be in GROUP BY or aggregated</span>

<span class="hljs-comment">-- Correct: Include all non-aggregated columns</span>
<span class="hljs-keyword">SELECT</span> customer_id, order_date, <span class="hljs-keyword">COUNT</span>(*)
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id, order_date;

<span class="hljs-comment">-- Or aggregate the column</span>
<span class="hljs-keyword">SELECT</span> customer_id, <span class="hljs-keyword">MAX</span>(order_date), <span class="hljs-keyword">COUNT</span>(*)
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id;
</div></code></pre>
<h3 id="4-performance-with-large-datasets">4. <strong>Performance with Large Datasets</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Slow: Aggregating without proper indexes</span>
<span class="hljs-keyword">SELECT</span> category_id, <span class="hljs-keyword">AVG</span>(price)
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> category_id;  <span class="hljs-comment">-- Needs index on category_id</span>

<span class="hljs-comment">-- Fast: With proper index</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_products_category <span class="hljs-keyword">ON</span> products(category_id);
</div></code></pre>
<h3 id="5-precision-issues-with-averages">5. <strong>Precision Issues with Averages</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Precision loss</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AVG</span>(price) <span class="hljs-keyword">FROM</span> products;  <span class="hljs-comment">-- May lose precision</span>

<span class="hljs-comment">-- Solution: Use appropriate precision</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ROUND</span>(<span class="hljs-keyword">AVG</span>(price), <span class="hljs-number">2</span>) <span class="hljs-keyword">FROM</span> products;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AVG</span>(price::<span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)) <span class="hljs-keyword">FROM</span> products;
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%80-next-steps">ğŸš€ Next Steps</h2>
<p>In the next chapter, we'll explore <strong>Subqueries and Nested Queries</strong> - powerful techniques for creating complex queries that use the results of one query within another. You'll learn about correlated subqueries, EXISTS clauses, and how to break down complex problems into manageable parts.</p>
<hr>
<h2 id="%F0%9F%93%9D-quick-practice">ğŸ“ Quick Practice</h2>
<p>Try these aggregate function exercises:</p>
<ol>
<li><strong>Basic Aggregates</strong>: Calculate total sales, average order value, and customer count for the last quarter</li>
<li><strong>Conditional Aggregates</strong>: Count orders by status and calculate completion rate</li>
<li><strong>Grouped Aggregates</strong>: Find the top 5 product categories by revenue</li>
<li><strong>Statistical Analysis</strong>: Calculate price distribution (mean, median, standard deviation) by category</li>
<li><strong>Customer Analysis</strong>: Identify customers in the top 10% by spending using percentiles</li>
</ol>
<p>Consider:</p>
<ul>
<li>How do you handle NULL values in your calculations?</li>
<li>What indexes would improve performance?</li>
<li>How do you ensure precision in monetary calculations?</li>
<li>What business insights can you derive from the aggregated data?</li>
</ul>
<h1 id="%F0%9F%93%98-chapter-9-subqueries-and-nested-queries">ğŸ“˜ Chapter 9: Subqueries and Nested Queries</h1>
<h2 id="%F0%9F%8E%AF-what-youll-learn">ğŸ¯ What You'll Learn</h2>
<ul>
<li>Understanding subqueries and their types</li>
<li>Scalar subqueries (single value)</li>
<li>Row subqueries (single row, multiple columns)</li>
<li>Table subqueries (multiple rows and columns)</li>
<li>Correlated vs non-correlated subqueries</li>
<li>EXISTS and NOT EXISTS clauses</li>
<li>IN and NOT IN with subqueries</li>
<li>ANY, ALL, and SOME operators</li>
<li>Common Table Expressions (CTEs)</li>
<li>Performance considerations and optimization</li>
</ul>
<hr>
<h2 id="%F0%9F%93%96-concept-explanation">ğŸ“– Concept Explanation</h2>
<p><strong>Subqueries</strong> (also called nested queries or inner queries) are queries embedded within another query. They allow you to break complex problems into smaller, manageable parts and perform operations that would be difficult or impossible with a single query.</p>
<h3 id="key-characteristics">Key Characteristics:</h3>
<ol>
<li><strong>Nested Structure</strong>: A query inside another query</li>
<li><strong>Execution Order</strong>: Inner query executes first (usually)</li>
<li><strong>Scope</strong>: Inner query can reference outer query columns (correlated)</li>
<li><strong>Return Types</strong>: Can return single value, single row, or multiple rows</li>
<li><strong>Usage</strong>: Can be used in SELECT, FROM, WHERE, HAVING clauses</li>
</ol>
<h3 id="types-of-subqueries">Types of Subqueries:</h3>
<ul>
<li><strong>Scalar Subquery</strong>: Returns single value (one row, one column)</li>
<li><strong>Row Subquery</strong>: Returns single row with multiple columns</li>
<li><strong>Table Subquery</strong>: Returns multiple rows and columns</li>
<li><strong>Correlated Subquery</strong>: References outer query columns</li>
<li><strong>Non-correlated Subquery</strong>: Independent of outer query</li>
</ul>
<hr>
<h2 id="%F0%9F%94%8D-scalar-subqueries-single-value">ğŸ” Scalar Subqueries (Single Value)</h2>
<h3 id="basic-scalar-subqueries">Basic Scalar Subqueries</h3>
<p><strong>1. Simple Scalar Examples:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Find customers who spent more than the average</span>
<span class="hljs-keyword">SELECT</span>
    customer_id,
    first_name,
    last_name,
    total_spent
<span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span>
        c.customer_id,
        c.first_name,
        c.last_name,
        <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> total_spent
    <span class="hljs-keyword">FROM</span> customers c
    <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
    <span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name
) customer_spending
<span class="hljs-keyword">WHERE</span> total_spent &gt; (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AVG</span>(customer_total)
    <span class="hljs-keyword">FROM</span> (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> customer_total
        <span class="hljs-keyword">FROM</span> orders o
        <span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
        <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> o.customer_id
    ) avg_calculation
);

<span class="hljs-comment">-- Products priced above category average</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    p.price,
    c.category_name,
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AVG</span>(p2.price)
        <span class="hljs-keyword">FROM</span> products p2
        <span class="hljs-keyword">WHERE</span> p2.category_id = p.category_id
          <span class="hljs-keyword">AND</span> p2.status = <span class="hljs-string">'active'</span>
    ) <span class="hljs-keyword">as</span> category_avg_price
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> p.price &gt; (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AVG</span>(p2.price)
      <span class="hljs-keyword">FROM</span> products p2
      <span class="hljs-keyword">WHERE</span> p2.category_id = p.category_id
        <span class="hljs-keyword">AND</span> p2.status = <span class="hljs-string">'active'</span>
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.price <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Orders with above-average value</span>
<span class="hljs-keyword">SELECT</span>
    order_id,
    customer_id,
    order_date,
    total_amount,
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AVG</span>(total_amount)
        <span class="hljs-keyword">FROM</span> orders
        <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
    ) <span class="hljs-keyword">as</span> overall_avg_order_value,

    total_amount - (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AVG</span>(total_amount)
        <span class="hljs-keyword">FROM</span> orders
        <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
    ) <span class="hljs-keyword">as</span> difference_from_avg
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
  <span class="hljs-keyword">AND</span> total_amount &gt; (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AVG</span>(total_amount)
      <span class="hljs-keyword">FROM</span> orders
      <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_amount <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<p><strong>2. Scalar Subqueries in SELECT Clause:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Customer summary with comparative metrics</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email,

    <span class="hljs-comment">-- Customer's order count</span>
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*)
        <span class="hljs-keyword">FROM</span> orders o
        <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
          <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
    ) <span class="hljs-keyword">as</span> order_count,

    <span class="hljs-comment">-- Customer's total spending</span>
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(o.total_amount), <span class="hljs-number">0</span>)
        <span class="hljs-keyword">FROM</span> orders o
        <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
          <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
    ) <span class="hljs-keyword">as</span> total_spent,

    <span class="hljs-comment">-- Customer's average order value</span>
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">AVG</span>(o.total_amount), <span class="hljs-number">0</span>)
        <span class="hljs-keyword">FROM</span> orders o
        <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
          <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
    ) <span class="hljs-keyword">as</span> avg_order_value,

    <span class="hljs-comment">-- Days since last order</span>
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COALESCE</span>(
            <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-keyword">MAX</span>(o.order_date),
            <span class="hljs-keyword">CURRENT_DATE</span> - c.created_at
        )
        <span class="hljs-keyword">FROM</span> orders o
        <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
          <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
    ) <span class="hljs-keyword">as</span> days_since_last_order,

    <span class="hljs-comment">-- Compare to overall average</span>
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AVG</span>(total_amount)
        <span class="hljs-keyword">FROM</span> orders
        <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
    ) <span class="hljs-keyword">as</span> overall_avg_order_value
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">WHERE</span> c.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_spent <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Product performance with market context</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    p.price,
    p.stock_quantity,
    c.category_name,

    <span class="hljs-comment">-- Units sold (last 12 months)</span>
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(oi.quantity), <span class="hljs-number">0</span>)
        <span class="hljs-keyword">FROM</span> order_items oi
        <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
        <span class="hljs-keyword">WHERE</span> oi.product_id = p.product_id
          <span class="hljs-keyword">AND</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
          <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
    ) <span class="hljs-keyword">as</span> units_sold_12m,

    <span class="hljs-comment">-- Revenue generated (last 12 months)</span>
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price), <span class="hljs-number">0</span>)
        <span class="hljs-keyword">FROM</span> order_items oi
        <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
        <span class="hljs-keyword">WHERE</span> oi.product_id = p.product_id
          <span class="hljs-keyword">AND</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
          <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
    ) <span class="hljs-keyword">as</span> revenue_12m,

    <span class="hljs-comment">-- Category average price</span>
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AVG</span>(p2.price)
        <span class="hljs-keyword">FROM</span> products p2
        <span class="hljs-keyword">WHERE</span> p2.category_id = p.category_id
          <span class="hljs-keyword">AND</span> p2.status = <span class="hljs-string">'active'</span>
    ) <span class="hljs-keyword">as</span> category_avg_price,

    <span class="hljs-comment">-- Market share within category (by revenue)</span>
    (
        <span class="hljs-keyword">SELECT</span>
            <span class="hljs-keyword">CASE</span>
                <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
                    <span class="hljs-keyword">ROUND</span>(
                        (
                            <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">SUM</span>(oi2.quantity * oi2.unit_price)
                            <span class="hljs-keyword">FROM</span> order_items oi2
                            <span class="hljs-keyword">JOIN</span> orders o2 <span class="hljs-keyword">ON</span> oi2.order_id = o2.order_id
                            <span class="hljs-keyword">WHERE</span> oi2.product_id = p.product_id
                              <span class="hljs-keyword">AND</span> o2.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
                              <span class="hljs-keyword">AND</span> o2.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
                        ) * <span class="hljs-number">100.0</span> / <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price), <span class="hljs-number">2</span>
                    )
                <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span>
            <span class="hljs-keyword">END</span>
        <span class="hljs-keyword">FROM</span> order_items oi
        <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
        <span class="hljs-keyword">JOIN</span> products p2 <span class="hljs-keyword">ON</span> oi.product_id = p2.product_id
        <span class="hljs-keyword">WHERE</span> p2.category_id = p.category_id
          <span class="hljs-keyword">AND</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
          <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
    ) <span class="hljs-keyword">as</span> category_market_share_percent
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> revenue_12m <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%8A-row-and-table-subqueries">ğŸ“Š Row and Table Subqueries</h2>
<h3 id="row-subqueries-single-row-multiple-columns">Row Subqueries (Single Row, Multiple Columns)</h3>
<p><strong>1. Row Comparisons:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Find customers with the same registration date and city as customer ID 1</span>
<span class="hljs-keyword">SELECT</span>
    customer_id,
    first_name,
    last_name,
    email,
    city,
    created_at
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> (city, <span class="hljs-built_in">DATE</span>(created_at)) = (
    <span class="hljs-keyword">SELECT</span> city, <span class="hljs-built_in">DATE</span>(created_at)
    <span class="hljs-keyword">FROM</span> customers
    <span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">1</span>
)
<span class="hljs-keyword">AND</span> customer_id != <span class="hljs-number">1</span>;

<span class="hljs-comment">-- Products with the same price and category as the most expensive product</span>
<span class="hljs-keyword">SELECT</span>
    p1.product_id,
    p1.product_name,
    p1.price,
    c.category_name
<span class="hljs-keyword">FROM</span> products p1
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p1.category_id = c.category_id
<span class="hljs-keyword">WHERE</span> (p1.price, p1.category_id) = (
    <span class="hljs-keyword">SELECT</span> price, category_id
    <span class="hljs-keyword">FROM</span> products
    <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> price <span class="hljs-keyword">DESC</span>
    <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>
)
<span class="hljs-keyword">AND</span> p1.status = <span class="hljs-string">'active'</span>;

<span class="hljs-comment">-- Orders placed on the same date with the same total as a specific order</span>
<span class="hljs-keyword">SELECT</span>
    o1.order_id,
    o1.customer_id,
    o1.order_date,
    o1.total_amount,
    c.first_name,
    c.last_name
<span class="hljs-keyword">FROM</span> orders o1
<span class="hljs-keyword">JOIN</span> customers c <span class="hljs-keyword">ON</span> o1.customer_id = c.customer_id
<span class="hljs-keyword">WHERE</span> (<span class="hljs-built_in">DATE</span>(o1.order_date), o1.total_amount) = (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">DATE</span>(order_date), total_amount
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> order_id = <span class="hljs-number">12345</span>  <span class="hljs-comment">-- Specific order to match</span>
)
<span class="hljs-keyword">AND</span> o1.order_id != <span class="hljs-number">12345</span>
<span class="hljs-keyword">AND</span> o1.status = <span class="hljs-string">'completed'</span>;
</div></code></pre>
<h3 id="table-subqueries-multiple-rows-and-columns">Table Subqueries (Multiple Rows and Columns)</h3>
<p><strong>1. Subqueries in FROM Clause:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Customer spending analysis using derived table</span>
<span class="hljs-keyword">SELECT</span>
    spending_tier,
    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> customer_count,
    <span class="hljs-keyword">AVG</span>(total_spent) <span class="hljs-keyword">as</span> avg_spending,
    <span class="hljs-keyword">MIN</span>(total_spent) <span class="hljs-keyword">as</span> min_spending,
    <span class="hljs-keyword">MAX</span>(total_spent) <span class="hljs-keyword">as</span> max_spending
<span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span>
        c.customer_id,
        c.first_name,
        c.last_name,
        <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> total_spent,
        <span class="hljs-keyword">CASE</span>
            <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">SUM</span>(o.total_amount) &lt; <span class="hljs-number">100</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Low Spender'</span>
            <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">SUM</span>(o.total_amount) &lt; <span class="hljs-number">500</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Medium Spender'</span>
            <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">SUM</span>(o.total_amount) &lt; <span class="hljs-number">2000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'High Spender'</span>
            <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'VIP Spender'</span>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> spending_tier
    <span class="hljs-keyword">FROM</span> customers c
    <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
    <span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name
) customer_spending
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> spending_tier
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> avg_spending <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Monthly sales trends with year-over-year comparison</span>
<span class="hljs-keyword">SELECT</span>
    month_name,
    current_year_sales,
    previous_year_sales,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> previous_year_sales &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-keyword">ROUND</span>(
                (current_year_sales - previous_year_sales) / previous_year_sales * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>
            )
        <span class="hljs-keyword">ELSE</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> growth_percentage
<span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span>
        TO_CHAR(order_date, <span class="hljs-string">'Month'</span>) <span class="hljs-keyword">as</span> month_name,
        <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> order_date) <span class="hljs-keyword">as</span> month_num,
        <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> order_date) = <span class="hljs-number">2024</span> <span class="hljs-keyword">THEN</span> total_amount <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> current_year_sales,
        <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> order_date) = <span class="hljs-number">2023</span> <span class="hljs-keyword">THEN</span> total_amount <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> previous_year_sales
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
      <span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> order_date) <span class="hljs-keyword">IN</span> (<span class="hljs-number">2023</span>, <span class="hljs-number">2024</span>)
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> order_date), TO_CHAR(order_date, <span class="hljs-string">'Month'</span>)
) monthly_comparison
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> month_num;

<span class="hljs-comment">-- Product performance ranking within categories</span>
<span class="hljs-keyword">SELECT</span>
    category_name,
    product_name,
    revenue_12m,
    category_rank,
    category_total_revenue,
    <span class="hljs-keyword">ROUND</span>(revenue_12m / category_total_revenue * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> category_revenue_share
<span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span>
        c.category_name,
        p.product_name,
        <span class="hljs-keyword">COALESCE</span>(sales.revenue, <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> revenue_12m,
        ROW_NUMBER() <span class="hljs-keyword">OVER</span> (
            <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> c.category_id
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">COALESCE</span>(sales.revenue, <span class="hljs-number">0</span>) <span class="hljs-keyword">DESC</span>
        ) <span class="hljs-keyword">as</span> category_rank,
        <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">COALESCE</span>(sales.revenue, <span class="hljs-number">0</span>)) <span class="hljs-keyword">OVER</span> (
            <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> c.category_id
        ) <span class="hljs-keyword">as</span> category_total_revenue
    <span class="hljs-keyword">FROM</span> products p
    <span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
    <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> (
        <span class="hljs-keyword">SELECT</span>
            oi.product_id,
            <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">as</span> revenue
        <span class="hljs-keyword">FROM</span> order_items oi
        <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
        <span class="hljs-keyword">WHERE</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
          <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
        <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> oi.product_id
    ) sales <span class="hljs-keyword">ON</span> p.product_id = sales.product_id
    <span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
) ranked_products
<span class="hljs-keyword">WHERE</span> category_rank &lt;= <span class="hljs-number">5</span>  <span class="hljs-comment">-- Top 5 products per category</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> category_name, category_rank;
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%97-correlated-subqueries">ğŸ”— Correlated Subqueries</h2>
<h3 id="understanding-correlated-subqueries">Understanding Correlated Subqueries</h3>
<p><strong>1. Basic Correlated Examples:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Customers who have placed orders above their personal average</span>
<span class="hljs-keyword">SELECT</span>
    o.order_id,
    o.customer_id,
    c.first_name,
    c.last_name,
    o.order_date,
    o.total_amount,
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AVG</span>(o2.total_amount)
        <span class="hljs-keyword">FROM</span> orders o2
        <span class="hljs-keyword">WHERE</span> o2.customer_id = o.customer_id
          <span class="hljs-keyword">AND</span> o2.status = <span class="hljs-string">'completed'</span>
    ) <span class="hljs-keyword">as</span> customer_avg_order_value
<span class="hljs-keyword">FROM</span> orders o
<span class="hljs-keyword">JOIN</span> customers c <span class="hljs-keyword">ON</span> o.customer_id = c.customer_id
<span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
  <span class="hljs-keyword">AND</span> o.total_amount &gt; (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AVG</span>(o2.total_amount)
      <span class="hljs-keyword">FROM</span> orders o2
      <span class="hljs-keyword">WHERE</span> o2.customer_id = o.customer_id
        <span class="hljs-keyword">AND</span> o2.status = <span class="hljs-string">'completed'</span>
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> o.total_amount <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Products that are the most expensive in their category</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    p.price,
    c.category_name
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> p.price = (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">MAX</span>(p2.price)
      <span class="hljs-keyword">FROM</span> products p2
      <span class="hljs-keyword">WHERE</span> p2.category_id = p.category_id
        <span class="hljs-keyword">AND</span> p2.status = <span class="hljs-string">'active'</span>
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.price <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Customers with their latest order information</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email,
    (
        <span class="hljs-keyword">SELECT</span> o.order_date
        <span class="hljs-keyword">FROM</span> orders o
        <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
          <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> o.order_date <span class="hljs-keyword">DESC</span>
        <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>
    ) <span class="hljs-keyword">as</span> last_order_date,
    (
        <span class="hljs-keyword">SELECT</span> o.total_amount
        <span class="hljs-keyword">FROM</span> orders o
        <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
          <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> o.order_date <span class="hljs-keyword">DESC</span>
        <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>
    ) <span class="hljs-keyword">as</span> last_order_amount,
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*)
        <span class="hljs-keyword">FROM</span> orders o
        <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
          <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
    ) <span class="hljs-keyword">as</span> total_orders
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">WHERE</span> c.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXISTS</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
      <span class="hljs-keyword">FROM</span> orders o
      <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
        <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> last_order_date <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<p><strong>2. Advanced Correlated Patterns:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Products with above-average sales in their category</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    c.category_name,
    p.price,
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(oi.quantity), <span class="hljs-number">0</span>)
        <span class="hljs-keyword">FROM</span> order_items oi
        <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
        <span class="hljs-keyword">WHERE</span> oi.product_id = p.product_id
          <span class="hljs-keyword">AND</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
          <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
    ) <span class="hljs-keyword">as</span> units_sold_12m,
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AVG</span>(category_sales.units_sold)
        <span class="hljs-keyword">FROM</span> (
            <span class="hljs-keyword">SELECT</span>
                p2.product_id,
                <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(oi2.quantity), <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> units_sold
            <span class="hljs-keyword">FROM</span> products p2
            <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> order_items oi2 <span class="hljs-keyword">ON</span> p2.product_id = oi2.product_id
            <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o2 <span class="hljs-keyword">ON</span> oi2.order_id = o2.order_id
                <span class="hljs-keyword">AND</span> o2.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
                <span class="hljs-keyword">AND</span> o2.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
            <span class="hljs-keyword">WHERE</span> p2.category_id = p.category_id
              <span class="hljs-keyword">AND</span> p2.status = <span class="hljs-string">'active'</span>
            <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> p2.product_id
        ) category_sales
    ) <span class="hljs-keyword">as</span> category_avg_units_sold
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(oi.quantity), <span class="hljs-number">0</span>)
      <span class="hljs-keyword">FROM</span> order_items oi
      <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
      <span class="hljs-keyword">WHERE</span> oi.product_id = p.product_id
        <span class="hljs-keyword">AND</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
        <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
  ) &gt; (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AVG</span>(category_sales.units_sold)
      <span class="hljs-keyword">FROM</span> (
          <span class="hljs-keyword">SELECT</span>
              p2.product_id,
              <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(oi2.quantity), <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> units_sold
          <span class="hljs-keyword">FROM</span> products p2
          <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> order_items oi2 <span class="hljs-keyword">ON</span> p2.product_id = oi2.product_id
          <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o2 <span class="hljs-keyword">ON</span> oi2.order_id = o2.order_id
              <span class="hljs-keyword">AND</span> o2.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
              <span class="hljs-keyword">AND</span> o2.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
          <span class="hljs-keyword">WHERE</span> p2.category_id = p.category_id
            <span class="hljs-keyword">AND</span> p2.status = <span class="hljs-string">'active'</span>
          <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> p2.product_id
      ) category_sales
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> units_sold_12m <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Customers who haven't ordered in longer than their typical interval</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email,
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">MAX</span>(o.order_date)
        <span class="hljs-keyword">FROM</span> orders o
        <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
          <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
    ) <span class="hljs-keyword">as</span> last_order_date,
    (
        <span class="hljs-keyword">SELECT</span>
            <span class="hljs-keyword">AVG</span>(<span class="hljs-keyword">EXTRACT</span>(EPOCH <span class="hljs-keyword">FROM</span> (o2.order_date - o1.order_date)) / <span class="hljs-number">86400</span>)
        <span class="hljs-keyword">FROM</span> orders o1
        <span class="hljs-keyword">JOIN</span> orders o2 <span class="hljs-keyword">ON</span> o1.customer_id = o2.customer_id
        <span class="hljs-keyword">WHERE</span> o1.customer_id = c.customer_id
          <span class="hljs-keyword">AND</span> o1.status = <span class="hljs-string">'completed'</span>
          <span class="hljs-keyword">AND</span> o2.status = <span class="hljs-string">'completed'</span>
          <span class="hljs-keyword">AND</span> o2.order_date &gt; o1.order_date
          <span class="hljs-keyword">AND</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> (
              <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
              <span class="hljs-keyword">FROM</span> orders o3
              <span class="hljs-keyword">WHERE</span> o3.customer_id = c.customer_id
                <span class="hljs-keyword">AND</span> o3.status = <span class="hljs-string">'completed'</span>
                <span class="hljs-keyword">AND</span> o3.order_date &gt; o1.order_date
                <span class="hljs-keyword">AND</span> o3.order_date &lt; o2.order_date
          )
    ) <span class="hljs-keyword">as</span> avg_days_between_orders,
    <span class="hljs-keyword">CURRENT_DATE</span> - (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">MAX</span>(o.order_date)
        <span class="hljs-keyword">FROM</span> orders o
        <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
          <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
    ) <span class="hljs-keyword">as</span> days_since_last_order
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">WHERE</span> c.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXISTS</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
      <span class="hljs-keyword">FROM</span> orders o
      <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
        <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
      <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(*) &gt;= <span class="hljs-number">3</span>  <span class="hljs-comment">-- At least 3 orders to calculate average interval</span>
  )
  <span class="hljs-keyword">AND</span> (
      <span class="hljs-keyword">CURRENT_DATE</span> - (
          <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">MAX</span>(o.order_date)
          <span class="hljs-keyword">FROM</span> orders o
          <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
            <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
      )
  ) &gt; (
      <span class="hljs-keyword">SELECT</span>
          <span class="hljs-keyword">AVG</span>(<span class="hljs-keyword">EXTRACT</span>(EPOCH <span class="hljs-keyword">FROM</span> (o2.order_date - o1.order_date)) / <span class="hljs-number">86400</span>) * <span class="hljs-number">1.5</span>
      <span class="hljs-keyword">FROM</span> orders o1
      <span class="hljs-keyword">JOIN</span> orders o2 <span class="hljs-keyword">ON</span> o1.customer_id = o2.customer_id
      <span class="hljs-keyword">WHERE</span> o1.customer_id = c.customer_id
        <span class="hljs-keyword">AND</span> o1.status = <span class="hljs-string">'completed'</span>
        <span class="hljs-keyword">AND</span> o2.status = <span class="hljs-string">'completed'</span>
        <span class="hljs-keyword">AND</span> o2.order_date &gt; o1.order_date
        <span class="hljs-keyword">AND</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> (
            <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
            <span class="hljs-keyword">FROM</span> orders o3
            <span class="hljs-keyword">WHERE</span> o3.customer_id = c.customer_id
              <span class="hljs-keyword">AND</span> o3.status = <span class="hljs-string">'completed'</span>
              <span class="hljs-keyword">AND</span> o3.order_date &gt; o1.order_date
              <span class="hljs-keyword">AND</span> o3.order_date &lt; o2.order_date
        )
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> days_since_last_order <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<hr>
<h2 id="%E2%9C%85-exists-and-not-exists">âœ… EXISTS and NOT EXISTS</h2>
<h3 id="exists-clause">EXISTS Clause</h3>
<p><strong>1. Basic EXISTS Examples:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Customers who have placed at least one order</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email,
    c.created_at
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
      <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.created_at <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Products that have been ordered in the last 30 days</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    p.price,
    c.category_name
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXISTS</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
      <span class="hljs-keyword">FROM</span> order_items oi
      <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
      <span class="hljs-keyword">WHERE</span> oi.product_id = p.product_id
        <span class="hljs-keyword">AND</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
        <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'30 days'</span>
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.product_name;

<span class="hljs-comment">-- Categories that have products with reviews</span>
<span class="hljs-keyword">SELECT</span>
    c.category_id,
    c.category_name,
    c.description
<span class="hljs-keyword">FROM</span> categories c
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">FROM</span> products p
    <span class="hljs-keyword">WHERE</span> p.category_id = c.category_id
      <span class="hljs-keyword">AND</span> p.status = <span class="hljs-string">'active'</span>
      <span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXISTS</span> (
          <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
          <span class="hljs-keyword">FROM</span> reviews r
          <span class="hljs-keyword">WHERE</span> r.product_id = p.product_id
      )
)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.category_name;
</div></code></pre>
<p><strong>2. Complex EXISTS Patterns:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Customers who have ordered from multiple categories</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email,
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> p.category_id)
        <span class="hljs-keyword">FROM</span> orders o
        <span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> o.order_id = oi.order_id
        <span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> oi.product_id = p.product_id
        <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
          <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
    ) <span class="hljs-keyword">as</span> categories_purchased_from
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">FROM</span> (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> p.category_id
        <span class="hljs-keyword">FROM</span> orders o
        <span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> o.order_id = oi.order_id
        <span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> oi.product_id = p.product_id
        <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
          <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
    ) customer_categories
    <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(*) &gt;= <span class="hljs-number">3</span>  <span class="hljs-comment">-- At least 3 different categories</span>
)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> categories_purchased_from <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Products that are frequently bought together</span>
<span class="hljs-keyword">SELECT</span>
    p1.product_id <span class="hljs-keyword">as</span> product_a_id,
    p1.product_name <span class="hljs-keyword">as</span> product_a_name,
    p2.product_id <span class="hljs-keyword">as</span> product_b_id,
    p2.product_name <span class="hljs-keyword">as</span> product_b_name,
    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> times_bought_together
<span class="hljs-keyword">FROM</span> products p1
<span class="hljs-keyword">JOIN</span> order_items oi1 <span class="hljs-keyword">ON</span> p1.product_id = oi1.product_id
<span class="hljs-keyword">JOIN</span> order_items oi2 <span class="hljs-keyword">ON</span> oi1.order_id = oi2.order_id
<span class="hljs-keyword">JOIN</span> products p2 <span class="hljs-keyword">ON</span> oi2.product_id = p2.product_id
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi1.order_id = o.order_id
<span class="hljs-keyword">WHERE</span> p1.product_id &lt; p2.product_id  <span class="hljs-comment">-- Avoid duplicates</span>
  <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
  <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
  <span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXISTS</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
      <span class="hljs-keyword">FROM</span> order_items oi_check
      <span class="hljs-keyword">JOIN</span> orders o_check <span class="hljs-keyword">ON</span> oi_check.order_id = o_check.order_id
      <span class="hljs-keyword">WHERE</span> oi_check.product_id = p1.product_id
        <span class="hljs-keyword">AND</span> o_check.status = <span class="hljs-string">'completed'</span>
        <span class="hljs-keyword">AND</span> o_check.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
      <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(*) &gt;= <span class="hljs-number">10</span>  <span class="hljs-comment">-- Product A sold at least 10 times</span>
  )
  <span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXISTS</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
      <span class="hljs-keyword">FROM</span> order_items oi_check
      <span class="hljs-keyword">JOIN</span> orders o_check <span class="hljs-keyword">ON</span> oi_check.order_id = o_check.order_id
      <span class="hljs-keyword">WHERE</span> oi_check.product_id = p2.product_id
        <span class="hljs-keyword">AND</span> o_check.status = <span class="hljs-string">'completed'</span>
        <span class="hljs-keyword">AND</span> o_check.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
      <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(*) &gt;= <span class="hljs-number">10</span>  <span class="hljs-comment">-- Product B sold at least 10 times</span>
  )
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> p1.product_id, p1.product_name, p2.product_id, p2.product_name
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(*) &gt;= <span class="hljs-number">5</span>  <span class="hljs-comment">-- Bought together at least 5 times</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> times_bought_together <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<h3 id="not-exists-clause">NOT EXISTS Clause</h3>
<p><strong>1. Basic NOT EXISTS Examples:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Customers who have never placed an order</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email,
    c.created_at,
    <span class="hljs-keyword">CURRENT_DATE</span> - c.created_at <span class="hljs-keyword">as</span> days_since_registration
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">WHERE</span> c.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
      <span class="hljs-keyword">FROM</span> orders o
      <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.created_at;

<span class="hljs-comment">-- Products that have never been ordered</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    p.price,
    p.stock_quantity,
    c.category_name,
    p.created_at
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
      <span class="hljs-keyword">FROM</span> order_items oi
      <span class="hljs-keyword">WHERE</span> oi.product_id = p.product_id
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.created_at <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Categories without any active products</span>
<span class="hljs-keyword">SELECT</span>
    c.category_id,
    c.category_name,
    c.description
<span class="hljs-keyword">FROM</span> categories c
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">FROM</span> products p
    <span class="hljs-keyword">WHERE</span> p.category_id = c.category_id
      <span class="hljs-keyword">AND</span> p.status = <span class="hljs-string">'active'</span>
)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.category_name;
</div></code></pre>
<p><strong>2. Advanced NOT EXISTS Patterns:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Customers who haven't ordered in the last 6 months but were active before</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email,
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">MAX</span>(o.order_date)
        <span class="hljs-keyword">FROM</span> orders o
        <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
          <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
    ) <span class="hljs-keyword">as</span> last_order_date,
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*)
        <span class="hljs-keyword">FROM</span> orders o
        <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
          <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
    ) <span class="hljs-keyword">as</span> total_orders,
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">SUM</span>(o.total_amount)
        <span class="hljs-keyword">FROM</span> orders o
        <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
          <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
    ) <span class="hljs-keyword">as</span> lifetime_value
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">WHERE</span> c.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXISTS</span> (
      <span class="hljs-comment">-- Has placed orders before</span>
      <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
      <span class="hljs-keyword">FROM</span> orders o
      <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
        <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
  )
  <span class="hljs-keyword">AND</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> (
      <span class="hljs-comment">-- But not in the last 6 months</span>
      <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
      <span class="hljs-keyword">FROM</span> orders o
      <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
        <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
        <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 months'</span>
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> lifetime_value <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Products available in some categories but missing in others</span>
<span class="hljs-keyword">SELECT</span>
    c.category_id,
    c.category_name,
    missing_products.product_name,
    missing_products.avg_price_in_other_categories
<span class="hljs-keyword">FROM</span> categories c
<span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span>
        p.product_name,
        <span class="hljs-keyword">AVG</span>(p.price) <span class="hljs-keyword">as</span> avg_price_in_other_categories
    <span class="hljs-keyword">FROM</span> products p
    <span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> p.product_name
    <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> p.category_id) &gt;= <span class="hljs-number">2</span>  <span class="hljs-comment">-- Available in at least 2 categories</span>
) missing_products
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">FROM</span> products p
    <span class="hljs-keyword">WHERE</span> p.category_id = c.category_id
      <span class="hljs-keyword">AND</span> p.product_name = missing_products.product_name
      <span class="hljs-keyword">AND</span> p.status = <span class="hljs-string">'active'</span>
)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.category_name, missing_products.product_name;

<span class="hljs-comment">-- Identify gaps in customer purchase patterns</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    popular_products.product_name,
    popular_products.times_ordered,
    popular_products.avg_price
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span>
        p.product_id,
        p.product_name,
        <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> times_ordered,
        <span class="hljs-keyword">AVG</span>(oi.unit_price) <span class="hljs-keyword">as</span> avg_price
    <span class="hljs-keyword">FROM</span> products p
    <span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> p.product_id = oi.product_id
    <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
    <span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
      <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> p.product_id, p.product_name
    <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(*) &gt;= <span class="hljs-number">50</span>  <span class="hljs-comment">-- Popular products (ordered 50+ times)</span>
) popular_products
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-comment">-- Customer has placed orders</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
      <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
      <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
)
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-comment">-- But hasn't ordered this popular product</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> o.order_id = oi.order_id
    <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
      <span class="hljs-keyword">AND</span> oi.product_id = popular_products.product_id
      <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
)
<span class="hljs-keyword">AND</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*)
    <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
      <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
      <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
) &gt;= <span class="hljs-number">3</span>  <span class="hljs-comment">-- Active customers (3+ orders in last year)</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.customer_id, popular_products.times_ordered <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%8B-in-and-not-in-with-subqueries">ğŸ“‹ IN and NOT IN with Subqueries</h2>
<h3 id="in-clause-with-subqueries">IN Clause with Subqueries</h3>
<p><strong>1. Basic IN Examples:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Customers who have ordered specific high-value products</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">WHERE</span> c.customer_id <span class="hljs-keyword">IN</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> o.customer_id
    <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> o.order_id = oi.order_id
    <span class="hljs-keyword">WHERE</span> oi.product_id <span class="hljs-keyword">IN</span> (
        <span class="hljs-keyword">SELECT</span> product_id
        <span class="hljs-keyword">FROM</span> products
        <span class="hljs-keyword">WHERE</span> price &gt; <span class="hljs-number">500</span>
          <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>
    )
    <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.last_name, c.first_name;

<span class="hljs-comment">-- Products in categories that have high average ratings</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    p.price,
    c.category_name
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> p.category_id <span class="hljs-keyword">IN</span> (
      <span class="hljs-keyword">SELECT</span> p2.category_id
      <span class="hljs-keyword">FROM</span> products p2
      <span class="hljs-keyword">JOIN</span> reviews r <span class="hljs-keyword">ON</span> p2.product_id = r.product_id
      <span class="hljs-keyword">WHERE</span> p2.status = <span class="hljs-string">'active'</span>
      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> p2.category_id
      <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">AVG</span>(r.rating) &gt;= <span class="hljs-number">4.0</span>
        <span class="hljs-keyword">AND</span> <span class="hljs-keyword">COUNT</span>(r.review_id) &gt;= <span class="hljs-number">20</span>  <span class="hljs-comment">-- At least 20 reviews</span>
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.category_name, p.product_name;

<span class="hljs-comment">-- Orders placed by customers from specific cities</span>
<span class="hljs-keyword">SELECT</span>
    o.order_id,
    o.customer_id,
    o.order_date,
    o.total_amount,
    c.city
<span class="hljs-keyword">FROM</span> orders o
<span class="hljs-keyword">JOIN</span> customers c <span class="hljs-keyword">ON</span> o.customer_id = c.customer_id
<span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
  <span class="hljs-keyword">AND</span> c.city <span class="hljs-keyword">IN</span> (
      <span class="hljs-keyword">SELECT</span> city
      <span class="hljs-keyword">FROM</span> customers
      <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>
      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> city
      <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(*) &gt;= <span class="hljs-number">100</span>  <span class="hljs-comment">-- Cities with at least 100 customers</span>
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> o.order_date <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<p><strong>2. Complex IN Patterns:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Products that are top sellers in their respective categories</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    p.price,
    c.category_name,
    sales_data.units_sold,
    sales_data.revenue
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span>
        oi.product_id,
        <span class="hljs-keyword">SUM</span>(oi.quantity) <span class="hljs-keyword">as</span> units_sold,
        <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">as</span> revenue
    <span class="hljs-keyword">FROM</span> order_items oi
    <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
    <span class="hljs-keyword">WHERE</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
      <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> oi.product_id
) sales_data <span class="hljs-keyword">ON</span> p.product_id = sales_data.product_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> p.product_id <span class="hljs-keyword">IN</span> (
      <span class="hljs-comment">-- Top 3 products by revenue in each category</span>
      <span class="hljs-keyword">SELECT</span> ranked_products.product_id
      <span class="hljs-keyword">FROM</span> (
          <span class="hljs-keyword">SELECT</span>
              p2.product_id,
              p2.category_id,
              <span class="hljs-keyword">SUM</span>(oi2.quantity * oi2.unit_price) <span class="hljs-keyword">as</span> revenue,
              ROW_NUMBER() <span class="hljs-keyword">OVER</span> (
                  <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> p2.category_id
                  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">SUM</span>(oi2.quantity * oi2.unit_price) <span class="hljs-keyword">DESC</span>
              ) <span class="hljs-keyword">as</span> category_rank
          <span class="hljs-keyword">FROM</span> products p2
          <span class="hljs-keyword">JOIN</span> order_items oi2 <span class="hljs-keyword">ON</span> p2.product_id = oi2.product_id
          <span class="hljs-keyword">JOIN</span> orders o2 <span class="hljs-keyword">ON</span> oi2.order_id = o2.order_id
          <span class="hljs-keyword">WHERE</span> p2.status = <span class="hljs-string">'active'</span>
            <span class="hljs-keyword">AND</span> o2.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
            <span class="hljs-keyword">AND</span> o2.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
          <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> p2.product_id, p2.category_id
      ) ranked_products
      <span class="hljs-keyword">WHERE</span> ranked_products.category_rank &lt;= <span class="hljs-number">3</span>
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.category_name, sales_data.revenue <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Customers who have purchased from the same categories as VIP customers</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email,
    customer_stats.total_spent,
    customer_stats.order_count
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span>
        c2.customer_id,
        <span class="hljs-keyword">SUM</span>(o2.total_amount) <span class="hljs-keyword">as</span> total_spent,
        <span class="hljs-keyword">COUNT</span>(o2.order_id) <span class="hljs-keyword">as</span> order_count
    <span class="hljs-keyword">FROM</span> customers c2
    <span class="hljs-keyword">JOIN</span> orders o2 <span class="hljs-keyword">ON</span> c2.customer_id = o2.customer_id
    <span class="hljs-keyword">WHERE</span> o2.status = <span class="hljs-string">'completed'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c2.customer_id
) customer_stats <span class="hljs-keyword">ON</span> c.customer_id = customer_stats.customer_id
<span class="hljs-keyword">WHERE</span> customer_stats.total_spent &lt; <span class="hljs-number">2000</span>  <span class="hljs-comment">-- Non-VIP customers</span>
  <span class="hljs-keyword">AND</span> c.customer_id <span class="hljs-keyword">IN</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> o.customer_id
      <span class="hljs-keyword">FROM</span> orders o
      <span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> o.order_id = oi.order_id
      <span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> oi.product_id = p.product_id
      <span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
        <span class="hljs-keyword">AND</span> p.category_id <span class="hljs-keyword">IN</span> (
            <span class="hljs-comment">-- Categories purchased by VIP customers</span>
            <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> p2.category_id
            <span class="hljs-keyword">FROM</span> orders o2
            <span class="hljs-keyword">JOIN</span> order_items oi2 <span class="hljs-keyword">ON</span> o2.order_id = oi2.order_id
            <span class="hljs-keyword">JOIN</span> products p2 <span class="hljs-keyword">ON</span> oi2.product_id = p2.product_id
            <span class="hljs-keyword">JOIN</span> (
                <span class="hljs-keyword">SELECT</span> customer_id
                <span class="hljs-keyword">FROM</span> orders
                <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
                <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id
                <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">SUM</span>(total_amount) &gt;= <span class="hljs-number">2000</span>  <span class="hljs-comment">-- VIP threshold</span>
            ) vip_customers <span class="hljs-keyword">ON</span> o2.customer_id = vip_customers.customer_id
            <span class="hljs-keyword">WHERE</span> o2.status = <span class="hljs-string">'completed'</span>
        )
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> customer_stats.total_spent <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<h3 id="not-in-clause-with-subqueries">NOT IN Clause with Subqueries</h3>
<p><strong>1. Basic NOT IN Examples:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Customers who have never ordered expensive products</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email,
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*)
        <span class="hljs-keyword">FROM</span> orders o
        <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
          <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
    ) <span class="hljs-keyword">as</span> total_orders,
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(o.total_amount), <span class="hljs-number">0</span>)
        <span class="hljs-keyword">FROM</span> orders o
        <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
          <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
    ) <span class="hljs-keyword">as</span> total_spent
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">WHERE</span> c.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> c.customer_id <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> o.customer_id
      <span class="hljs-keyword">FROM</span> orders o
      <span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> o.order_id = oi.order_id
      <span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> oi.product_id = p.product_id
      <span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
        <span class="hljs-keyword">AND</span> p.price &gt; <span class="hljs-number">200</span>  <span class="hljs-comment">-- Expensive products</span>
        <span class="hljs-keyword">AND</span> o.customer_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>  <span class="hljs-comment">-- Important for NOT IN</span>
  )
  <span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXISTS</span> (
      <span class="hljs-comment">-- But have placed at least one order</span>
      <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
      <span class="hljs-keyword">FROM</span> orders o
      <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
        <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_spent <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Products not ordered in the last 6 months</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    p.price,
    p.stock_quantity,
    c.category_name,
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">MAX</span>(o.order_date)
        <span class="hljs-keyword">FROM</span> order_items oi
        <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
        <span class="hljs-keyword">WHERE</span> oi.product_id = p.product_id
          <span class="hljs-keyword">AND</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
    ) <span class="hljs-keyword">as</span> last_ordered_date
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> p.product_id <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> oi.product_id
      <span class="hljs-keyword">FROM</span> order_items oi
      <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
      <span class="hljs-keyword">WHERE</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
        <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 months'</span>
        <span class="hljs-keyword">AND</span> oi.product_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>  <span class="hljs-comment">-- Important for NOT IN</span>
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> last_ordered_date <span class="hljs-keyword">DESC</span> <span class="hljs-keyword">NULLS</span> <span class="hljs-keyword">LAST</span>;

<span class="hljs-comment">-- Categories without products in a specific price range</span>
<span class="hljs-keyword">SELECT</span>
    c.category_id,
    c.category_name,
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*)
        <span class="hljs-keyword">FROM</span> products p
        <span class="hljs-keyword">WHERE</span> p.category_id = c.category_id
          <span class="hljs-keyword">AND</span> p.status = <span class="hljs-string">'active'</span>
    ) <span class="hljs-keyword">as</span> total_products,
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">MIN</span>(p.price)
        <span class="hljs-keyword">FROM</span> products p
        <span class="hljs-keyword">WHERE</span> p.category_id = c.category_id
          <span class="hljs-keyword">AND</span> p.status = <span class="hljs-string">'active'</span>
    ) <span class="hljs-keyword">as</span> min_price,
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">MAX</span>(p.price)
        <span class="hljs-keyword">FROM</span> products p
        <span class="hljs-keyword">WHERE</span> p.category_id = c.category_id
          <span class="hljs-keyword">AND</span> p.status = <span class="hljs-string">'active'</span>
    ) <span class="hljs-keyword">as</span> max_price
<span class="hljs-keyword">FROM</span> categories c
<span class="hljs-keyword">WHERE</span> c.category_id <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> p.category_id
    <span class="hljs-keyword">FROM</span> products p
    <span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
      <span class="hljs-keyword">AND</span> p.price <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">50</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">150</span>  <span class="hljs-comment">-- Mid-range products</span>
      <span class="hljs-keyword">AND</span> p.category_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>  <span class="hljs-comment">-- Important for NOT IN</span>
)
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-comment">-- But have at least one active product</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">FROM</span> products p
    <span class="hljs-keyword">WHERE</span> p.category_id = c.category_id
      <span class="hljs-keyword">AND</span> p.status = <span class="hljs-string">'active'</span>
)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.category_name;
</div></code></pre>
<p><strong>2. NOT IN with NULL Handling:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Safe NOT IN pattern (handling NULLs)</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">WHERE</span> c.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> c.customer_id <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (
      <span class="hljs-keyword">SELECT</span> o.customer_id
      <span class="hljs-keyword">FROM</span> orders o
      <span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'cancelled'</span>
        <span class="hljs-keyword">AND</span> o.customer_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>  <span class="hljs-comment">-- Explicit NULL check</span>
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.last_name, c.first_name;

<span class="hljs-comment">-- Alternative using NOT EXISTS (safer than NOT IN)</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">WHERE</span> c.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
      <span class="hljs-keyword">FROM</span> orders o
      <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
        <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'cancelled'</span>
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.last_name, c.first_name;
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%84-any-all-and-some-operators">ğŸ”„ ANY, ALL, and SOME Operators</h2>
<h3 id="any-and-some-operators-equivalent">ANY and SOME Operators (equivalent)</h3>
<p><strong>1. Basic ANY/SOME Examples:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Products more expensive than ANY product in the 'Electronics' category</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    p.price,
    c.category_name
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> p.price &gt; <span class="hljs-keyword">ANY</span> (
      <span class="hljs-keyword">SELECT</span> p2.price
      <span class="hljs-keyword">FROM</span> products p2
      <span class="hljs-keyword">JOIN</span> categories c2 <span class="hljs-keyword">ON</span> p2.category_id = c2.category_id
      <span class="hljs-keyword">WHERE</span> c2.category_name = <span class="hljs-string">'Electronics'</span>
        <span class="hljs-keyword">AND</span> p2.status = <span class="hljs-string">'active'</span>
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.price <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Customers who have spent more than ANY customer from 'New York'</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.city,
    customer_spending.total_spent
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span>
        customer_id,
        <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">as</span> total_spent
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id
) customer_spending <span class="hljs-keyword">ON</span> c.customer_id = customer_spending.customer_id
<span class="hljs-keyword">WHERE</span> c.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> customer_spending.total_spent &gt; <span class="hljs-keyword">ANY</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">SUM</span>(o.total_amount)
      <span class="hljs-keyword">FROM</span> customers c2
      <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c2.customer_id = o.customer_id
      <span class="hljs-keyword">WHERE</span> c2.city = <span class="hljs-string">'New York'</span>
        <span class="hljs-keyword">AND</span> c2.status = <span class="hljs-string">'active'</span>
        <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c2.customer_id
  )
  <span class="hljs-keyword">AND</span> c.city != <span class="hljs-string">'New York'</span>  <span class="hljs-comment">-- Exclude New York customers</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> customer_spending.total_spent <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Orders with amounts greater than ANY order from the previous month</span>
<span class="hljs-keyword">SELECT</span>
    o.order_id,
    o.customer_id,
    o.order_date,
    o.total_amount,
    c.first_name,
    c.last_name
<span class="hljs-keyword">FROM</span> orders o
<span class="hljs-keyword">JOIN</span> customers c <span class="hljs-keyword">ON</span> o.customer_id = c.customer_id
<span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
  <span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> o.order_date) = <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">CURRENT_DATE</span>)
  <span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> o.order_date) = <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">CURRENT_DATE</span>)
  <span class="hljs-keyword">AND</span> o.total_amount &gt; <span class="hljs-keyword">ANY</span> (
      <span class="hljs-keyword">SELECT</span> o2.total_amount
      <span class="hljs-keyword">FROM</span> orders o2
      <span class="hljs-keyword">WHERE</span> o2.status = <span class="hljs-string">'completed'</span>
        <span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> o2.order_date) = <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">CURRENT_DATE</span>) - <span class="hljs-number">1</span>
        <span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> o2.order_date) = <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">CURRENT_DATE</span>)
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> o.total_amount <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<h3 id="all-operator">ALL Operator</h3>
<p><strong>1. Basic ALL Examples:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Products more expensive than ALL products in the 'Books' category</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    p.price,
    c.category_name
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> p.price &gt; <span class="hljs-keyword">ALL</span> (
      <span class="hljs-keyword">SELECT</span> p2.price
      <span class="hljs-keyword">FROM</span> products p2
      <span class="hljs-keyword">JOIN</span> categories c2 <span class="hljs-keyword">ON</span> p2.category_id = c2.category_id
      <span class="hljs-keyword">WHERE</span> c2.category_name = <span class="hljs-string">'Books'</span>
        <span class="hljs-keyword">AND</span> p2.status = <span class="hljs-string">'active'</span>
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.price;

<span class="hljs-comment">-- Customers who have spent more than ALL customers from 'Small Town'</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.city,
    customer_spending.total_spent
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span>
        customer_id,
        <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">as</span> total_spent
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id
) customer_spending <span class="hljs-keyword">ON</span> c.customer_id = customer_spending.customer_id
<span class="hljs-keyword">WHERE</span> c.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> customer_spending.total_spent &gt; <span class="hljs-keyword">ALL</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(o.total_amount), <span class="hljs-number">0</span>)
      <span class="hljs-keyword">FROM</span> customers c2
      <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c2.customer_id = o.customer_id
          <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
      <span class="hljs-keyword">WHERE</span> c2.city = <span class="hljs-string">'Small Town'</span>
        <span class="hljs-keyword">AND</span> c2.status = <span class="hljs-string">'active'</span>
      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c2.customer_id
  )
  <span class="hljs-keyword">AND</span> c.city != <span class="hljs-string">'Small Town'</span>  <span class="hljs-comment">-- Exclude Small Town customers</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> customer_spending.total_spent <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Products with ratings higher than ALL products in competing categories</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    p.price,
    c.category_name,
    product_ratings.avg_rating,
    product_ratings.review_count
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span>
        product_id,
        <span class="hljs-keyword">AVG</span>(rating) <span class="hljs-keyword">as</span> avg_rating,
        <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> review_count
    <span class="hljs-keyword">FROM</span> reviews
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> product_id
    <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(*) &gt;= <span class="hljs-number">5</span>  <span class="hljs-comment">-- At least 5 reviews</span>
) product_ratings <span class="hljs-keyword">ON</span> p.product_id = product_ratings.product_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> product_ratings.avg_rating &gt; <span class="hljs-keyword">ALL</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AVG</span>(r2.rating)
      <span class="hljs-keyword">FROM</span> products p2
      <span class="hljs-keyword">JOIN</span> reviews r2 <span class="hljs-keyword">ON</span> p2.product_id = r2.product_id
      <span class="hljs-keyword">JOIN</span> categories c2 <span class="hljs-keyword">ON</span> p2.category_id = c2.category_id
      <span class="hljs-keyword">WHERE</span> c2.category_name <span class="hljs-keyword">IN</span> (<span class="hljs-string">'Competing Category 1'</span>, <span class="hljs-string">'Competing Category 2'</span>)
        <span class="hljs-keyword">AND</span> p2.status = <span class="hljs-string">'active'</span>
      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> p2.product_id
      <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(r2.review_id) &gt;= <span class="hljs-number">5</span>
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> product_ratings.avg_rating <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<p><strong>2. Complex ANY/ALL Patterns:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Products that outperform ALL products in lower price categories</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    p.price,
    c.category_name,
    sales_metrics.units_sold_12m,
    sales_metrics.revenue_12m
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span>
        oi.product_id,
        <span class="hljs-keyword">SUM</span>(oi.quantity) <span class="hljs-keyword">as</span> units_sold_12m,
        <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">as</span> revenue_12m
    <span class="hljs-keyword">FROM</span> order_items oi
    <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
    <span class="hljs-keyword">WHERE</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
      <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> oi.product_id
) sales_metrics <span class="hljs-keyword">ON</span> p.product_id = sales_metrics.product_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> p.price &gt;= <span class="hljs-number">100</span>  <span class="hljs-comment">-- Focus on higher-priced products</span>
  <span class="hljs-keyword">AND</span> sales_metrics.units_sold_12m &gt; <span class="hljs-keyword">ALL</span> (
      <span class="hljs-comment">-- Compare to all products in lower price ranges</span>
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(oi2.quantity), <span class="hljs-number">0</span>)
      <span class="hljs-keyword">FROM</span> products p2
      <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> order_items oi2 <span class="hljs-keyword">ON</span> p2.product_id = oi2.product_id
      <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o2 <span class="hljs-keyword">ON</span> oi2.order_id = o2.order_id
          <span class="hljs-keyword">AND</span> o2.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
          <span class="hljs-keyword">AND</span> o2.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
      <span class="hljs-keyword">WHERE</span> p2.status = <span class="hljs-string">'active'</span>
        <span class="hljs-keyword">AND</span> p2.price &lt; p.price * <span class="hljs-number">0.7</span>  <span class="hljs-comment">-- Products priced at least 30% lower</span>
      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> p2.product_id
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sales_metrics.units_sold_12m <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Customers whose average order value exceeds ANY VIP customer's average</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email,
    customer_metrics.order_count,
    customer_metrics.total_spent,
    customer_metrics.avg_order_value
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span>
        customer_id,
        <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> order_count,
        <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">as</span> total_spent,
        <span class="hljs-keyword">AVG</span>(total_amount) <span class="hljs-keyword">as</span> avg_order_value
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id
    <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(*) &gt;= <span class="hljs-number">3</span>  <span class="hljs-comment">-- At least 3 orders for reliable average</span>
) customer_metrics <span class="hljs-keyword">ON</span> c.customer_id = customer_metrics.customer_id
<span class="hljs-keyword">WHERE</span> c.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> customer_metrics.total_spent &lt; <span class="hljs-number">2000</span>  <span class="hljs-comment">-- Non-VIP customers</span>
  <span class="hljs-keyword">AND</span> customer_metrics.avg_order_value &gt; <span class="hljs-keyword">ANY</span> (
      <span class="hljs-comment">-- Compare to VIP customers' average order values</span>
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AVG</span>(o.total_amount)
      <span class="hljs-keyword">FROM</span> orders o
      <span class="hljs-keyword">JOIN</span> (
          <span class="hljs-keyword">SELECT</span> customer_id
          <span class="hljs-keyword">FROM</span> orders
          <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
          <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id
          <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">SUM</span>(total_amount) &gt;= <span class="hljs-number">2000</span>  <span class="hljs-comment">-- VIP threshold</span>
      ) vip_customers <span class="hljs-keyword">ON</span> o.customer_id = vip_customers.customer_id
      <span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> o.customer_id
      <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(*) &gt;= <span class="hljs-number">3</span>
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> customer_metrics.avg_order_value <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%9D-common-table-expressions-ctes">ğŸ“ Common Table Expressions (CTEs)</h2>
<h3 id="basic-ctes">Basic CTEs</h3>
<p><strong>1. Simple CTE Examples:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Customer spending analysis with CTE</span>
<span class="hljs-keyword">WITH</span> customer_spending <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        c.customer_id,
        c.first_name,
        c.last_name,
        c.email,
        <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">as</span> order_count,
        <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> total_spent,
        <span class="hljs-keyword">AVG</span>(o.total_amount) <span class="hljs-keyword">as</span> avg_order_value,
        <span class="hljs-keyword">MIN</span>(o.order_date) <span class="hljs-keyword">as</span> first_order_date,
        <span class="hljs-keyword">MAX</span>(o.order_date) <span class="hljs-keyword">as</span> last_order_date
    <span class="hljs-keyword">FROM</span> customers c
    <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
    <span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name, c.email
)
<span class="hljs-keyword">SELECT</span>
    customer_id,
    first_name,
    last_name,
    email,
    order_count,
    total_spent,
    avg_order_value,
    first_order_date,
    last_order_date,
    <span class="hljs-keyword">CURRENT_DATE</span> - last_order_date <span class="hljs-keyword">as</span> days_since_last_order,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> total_spent &gt;= <span class="hljs-number">2000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'VIP'</span>
        <span class="hljs-keyword">WHEN</span> total_spent &gt;= <span class="hljs-number">1000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Premium'</span>
        <span class="hljs-keyword">WHEN</span> total_spent &gt;= <span class="hljs-number">500</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Regular'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Basic'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> customer_tier
<span class="hljs-keyword">FROM</span> customer_spending
<span class="hljs-keyword">WHERE</span> order_count &gt;= <span class="hljs-number">2</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_spent <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Product performance analysis with CTE</span>
<span class="hljs-keyword">WITH</span> product_sales <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        p.product_id,
        p.product_name,
        p.price,
        c.category_name,
        <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(oi.quantity), <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> units_sold,
        <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price), <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> revenue,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.order_id) <span class="hljs-keyword">as</span> order_count
    <span class="hljs-keyword">FROM</span> products p
    <span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
    <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> p.product_id = oi.product_id
    <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
        <span class="hljs-keyword">AND</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
        <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
    <span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> p.product_id, p.product_name, p.price, c.category_name
),
category_averages <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        category_name,
        <span class="hljs-keyword">AVG</span>(units_sold) <span class="hljs-keyword">as</span> avg_category_units,
        <span class="hljs-keyword">AVG</span>(revenue) <span class="hljs-keyword">as</span> avg_category_revenue
    <span class="hljs-keyword">FROM</span> product_sales
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> category_name
)
<span class="hljs-keyword">SELECT</span>
    ps.product_id,
    ps.product_name,
    ps.price,
    ps.category_name,
    ps.units_sold,
    ps.revenue,
    ps.order_count,
    ca.avg_category_units,
    ca.avg_category_revenue,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> ps.units_sold &gt; ca.avg_category_units <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Above Average'</span>
        <span class="hljs-keyword">WHEN</span> ps.units_sold = ca.avg_category_units <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Average'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Below Average'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> performance_vs_category
<span class="hljs-keyword">FROM</span> product_sales ps
<span class="hljs-keyword">JOIN</span> category_averages ca <span class="hljs-keyword">ON</span> ps.category_name = ca.category_name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ps.revenue <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<h3 id="multiple-ctes">Multiple CTEs</h3>
<p><strong>1. Complex Analysis with Multiple CTEs:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Comprehensive customer analysis with multiple CTEs</span>
<span class="hljs-keyword">WITH</span> customer_orders <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        c.customer_id,
        c.first_name,
        c.last_name,
        c.email,
        c.city,
        c.created_at <span class="hljs-keyword">as</span> registration_date,
        <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">as</span> order_count,
        <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> total_spent,
        <span class="hljs-keyword">AVG</span>(o.total_amount) <span class="hljs-keyword">as</span> avg_order_value,
        <span class="hljs-keyword">MIN</span>(o.order_date) <span class="hljs-keyword">as</span> first_order_date,
        <span class="hljs-keyword">MAX</span>(o.order_date) <span class="hljs-keyword">as</span> last_order_date
    <span class="hljs-keyword">FROM</span> customers c
    <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
        <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
    <span class="hljs-keyword">WHERE</span> c.status = <span class="hljs-string">'active'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name, c.email, c.city, c.created_at
),
customer_segments <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        *,
        <span class="hljs-keyword">CASE</span>
            <span class="hljs-keyword">WHEN</span> total_spent &gt;= <span class="hljs-number">2000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'VIP'</span>
            <span class="hljs-keyword">WHEN</span> total_spent &gt;= <span class="hljs-number">1000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Premium'</span>
            <span class="hljs-keyword">WHEN</span> total_spent &gt;= <span class="hljs-number">500</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Regular'</span>
            <span class="hljs-keyword">WHEN</span> total_spent &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Basic'</span>
            <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'No Orders'</span>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> spending_tier,
        <span class="hljs-keyword">CASE</span>
            <span class="hljs-keyword">WHEN</span> order_count = <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Never Ordered'</span>
            <span class="hljs-keyword">WHEN</span> last_order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'30 days'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Active'</span>
            <span class="hljs-keyword">WHEN</span> last_order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'90 days'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Recent'</span>
            <span class="hljs-keyword">WHEN</span> last_order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'180 days'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Dormant'</span>
            <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Inactive'</span>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> activity_status
    <span class="hljs-keyword">FROM</span> customer_orders
),
segment_stats <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        spending_tier,
        activity_status,
        <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> customer_count,
        <span class="hljs-keyword">AVG</span>(total_spent) <span class="hljs-keyword">as</span> avg_spending,
        <span class="hljs-keyword">AVG</span>(order_count) <span class="hljs-keyword">as</span> avg_orders,
        <span class="hljs-keyword">AVG</span>(avg_order_value) <span class="hljs-keyword">as</span> avg_order_value
    <span class="hljs-keyword">FROM</span> customer_segments
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> spending_tier, activity_status
)
<span class="hljs-keyword">SELECT</span>
    cs.customer_id,
    cs.first_name,
    cs.last_name,
    cs.email,
    cs.city,
    cs.spending_tier,
    cs.activity_status,
    cs.order_count,
    cs.total_spent,
    cs.avg_order_value,
    cs.last_order_date,
    ss.customer_count <span class="hljs-keyword">as</span> peers_in_segment,
    ss.avg_spending <span class="hljs-keyword">as</span> segment_avg_spending,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> cs.total_spent &gt; ss.avg_spending <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Above Segment Average'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Below Segment Average'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> performance_vs_peers
<span class="hljs-keyword">FROM</span> customer_segments cs
<span class="hljs-keyword">JOIN</span> segment_stats ss <span class="hljs-keyword">ON</span> cs.spending_tier = ss.spending_tier
    <span class="hljs-keyword">AND</span> cs.activity_status = ss.activity_status
<span class="hljs-keyword">WHERE</span> cs.order_count &gt; <span class="hljs-number">0</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> cs.total_spent <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<p><strong>2. Recursive CTEs (PostgreSQL):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Hierarchical category structure (if categories have parent-child relationships)</span>
<span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> category_hierarchy <span class="hljs-keyword">AS</span> (
    <span class="hljs-comment">-- Base case: top-level categories</span>
    <span class="hljs-keyword">SELECT</span>
        category_id,
        category_name,
        parent_category_id,
        <span class="hljs-number">0</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">level</span>,
        category_name <span class="hljs-keyword">as</span> <span class="hljs-keyword">path</span>
    <span class="hljs-keyword">FROM</span> categories
    <span class="hljs-keyword">WHERE</span> parent_category_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>

    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>

    <span class="hljs-comment">-- Recursive case: child categories</span>
    <span class="hljs-keyword">SELECT</span>
        c.category_id,
        c.category_name,
        c.parent_category_id,
        ch.level + <span class="hljs-number">1</span>,
        ch.path || <span class="hljs-string">' &gt; '</span> || c.category_name
    <span class="hljs-keyword">FROM</span> categories c
    <span class="hljs-keyword">JOIN</span> category_hierarchy ch <span class="hljs-keyword">ON</span> c.parent_category_id = ch.category_id
)
<span class="hljs-keyword">SELECT</span>
    ch.category_id,
    ch.category_name,
    ch.level,
    ch.path,
    <span class="hljs-keyword">COUNT</span>(p.product_id) <span class="hljs-keyword">as</span> product_count,
    <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(sales.revenue), <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> total_revenue
<span class="hljs-keyword">FROM</span> category_hierarchy ch
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> ch.category_id = p.category_id
    <span class="hljs-keyword">AND</span> p.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span>
        p.category_id,
        <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">as</span> revenue
    <span class="hljs-keyword">FROM</span> products p
    <span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> p.product_id = oi.product_id
    <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
    <span class="hljs-keyword">WHERE</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
      <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> p.category_id
) sales <span class="hljs-keyword">ON</span> ch.category_id = sales.category_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> ch.category_id, ch.category_name, ch.level, ch.path
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ch.level, ch.path;
</div></code></pre>
<hr>
<h2 id="%E2%9A%A1-performance-considerations">âš¡ Performance Considerations</h2>
<h3 id="optimization-strategies">Optimization Strategies</h3>
<p><strong>1. Index Usage:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Ensure proper indexes for subquery performance</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_orders_customer_status <span class="hljs-keyword">ON</span> orders(customer_id, <span class="hljs-keyword">status</span>);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_orders_date_status <span class="hljs-keyword">ON</span> orders(order_date, <span class="hljs-keyword">status</span>);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_order_items_product <span class="hljs-keyword">ON</span> order_items(product_id);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_products_category_status <span class="hljs-keyword">ON</span> products(category_id, <span class="hljs-keyword">status</span>);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_reviews_product_rating <span class="hljs-keyword">ON</span> reviews(product_id, rating);

<span class="hljs-comment">-- Covering indexes for common subquery patterns</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_orders_customer_date_amount <span class="hljs-keyword">ON</span> orders(customer_id, order_date, total_amount)
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>;
</div></code></pre>
<p><strong>2. Subquery vs JOIN Performance:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Slower: Correlated subquery</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*)
        <span class="hljs-keyword">FROM</span> orders o
        <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
          <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
    ) <span class="hljs-keyword">as</span> order_count
<span class="hljs-keyword">FROM</span> customers c;

<span class="hljs-comment">-- Faster: LEFT JOIN with GROUP BY</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">as</span> order_count
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
    <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name;
</div></code></pre>
<p><strong>3. EXISTS vs IN Performance:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Generally faster: EXISTS</span>
<span class="hljs-keyword">SELECT</span> c.*
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
      <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
);

<span class="hljs-comment">-- Can be slower: IN</span>
<span class="hljs-keyword">SELECT</span> c.*
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">WHERE</span> c.customer_id <span class="hljs-keyword">IN</span> (
    <span class="hljs-keyword">SELECT</span> o.customer_id
    <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
);
</div></code></pre>
<hr>
<h2 id="%F0%9F%92%A1-real-world-examples">ğŸ’¡ Real-World Examples</h2>
<h3 id="example-1-customer-churn-analysis">Example 1: Customer Churn Analysis</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Identify customers at risk of churning</span>
<span class="hljs-keyword">WITH</span> customer_activity <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        c.customer_id,
        c.first_name,
        c.last_name,
        c.email,
        <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">as</span> total_orders,
        <span class="hljs-keyword">MAX</span>(o.order_date) <span class="hljs-keyword">as</span> last_order_date,
        <span class="hljs-keyword">AVG</span>(<span class="hljs-keyword">EXTRACT</span>(EPOCH <span class="hljs-keyword">FROM</span> (o2.order_date - o1.order_date)) / <span class="hljs-number">86400</span>) <span class="hljs-keyword">as</span> avg_days_between_orders
    <span class="hljs-keyword">FROM</span> customers c
    <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
        <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
    <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o1 <span class="hljs-keyword">ON</span> c.customer_id = o1.customer_id
        <span class="hljs-keyword">AND</span> o1.status = <span class="hljs-string">'completed'</span>
    <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o2 <span class="hljs-keyword">ON</span> c.customer_id = o2.customer_id
        <span class="hljs-keyword">AND</span> o2.status = <span class="hljs-string">'completed'</span>
        <span class="hljs-keyword">AND</span> o2.order_date &gt; o1.order_date
        <span class="hljs-keyword">AND</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> (
            <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
            <span class="hljs-keyword">FROM</span> orders o3
            <span class="hljs-keyword">WHERE</span> o3.customer_id = c.customer_id
              <span class="hljs-keyword">AND</span> o3.status = <span class="hljs-string">'completed'</span>
              <span class="hljs-keyword">AND</span> o3.order_date &gt; o1.order_date
              <span class="hljs-keyword">AND</span> o3.order_date &lt; o2.order_date
        )
    <span class="hljs-keyword">WHERE</span> c.status = <span class="hljs-string">'active'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name, c.email
    <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(o.order_id) &gt;= <span class="hljs-number">2</span>
)
<span class="hljs-keyword">SELECT</span>
    customer_id,
    first_name,
    last_name,
    email,
    total_orders,
    last_order_date,
    <span class="hljs-keyword">CURRENT_DATE</span> - last_order_date <span class="hljs-keyword">as</span> days_since_last_order,
    avg_days_between_orders,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> (<span class="hljs-keyword">CURRENT_DATE</span> - last_order_date) &gt; (avg_days_between_orders * <span class="hljs-number">2</span>) <span class="hljs-keyword">THEN</span> <span class="hljs-string">'High Risk'</span>
        <span class="hljs-keyword">WHEN</span> (<span class="hljs-keyword">CURRENT_DATE</span> - last_order_date) &gt; (avg_days_between_orders * <span class="hljs-number">1.5</span>) <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Medium Risk'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Low Risk'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> churn_risk
<span class="hljs-keyword">FROM</span> customer_activity
<span class="hljs-keyword">WHERE</span> avg_days_between_orders <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> days_since_last_order <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-use-cases--interview-tips">ğŸ¯ Use Cases &amp; Interview Tips</h2>
<h3 id="common-interview-questions">Common Interview Questions:</h3>
<ol>
<li>
<p><strong>&quot;What's the difference between correlated and non-correlated subqueries?&quot;</strong></p>
<ul>
<li>Non-correlated: Independent, executes once</li>
<li>Correlated: References outer query, executes for each outer row</li>
<li>Performance implications and use cases</li>
</ul>
</li>
<li>
<p><strong>&quot;When would you use EXISTS vs IN?&quot;</strong></p>
<ul>
<li>EXISTS: Better for checking existence, handles NULLs safely</li>
<li>IN: Good for exact matches, but watch out for NULL issues</li>
<li>Performance considerations</li>
</ul>
</li>
<li>
<p><strong>&quot;How do you handle NULL values in NOT IN subqueries?&quot;</strong></p>
<ul>
<li>NOT IN with NULLs returns no results</li>
<li>Use NOT EXISTS or explicit NULL checks</li>
<li>Always filter out NULLs in subquery</li>
</ul>
</li>
</ol>
<h3 id="performance-best-practices">Performance Best Practices:</h3>
<ol>
<li><strong>Prefer EXISTS over IN for existence checks</strong></li>
<li><strong>Use proper indexes on subquery columns</strong></li>
<li><strong>Consider JOINs instead of correlated subqueries</strong></li>
<li><strong>Use CTEs for complex, reusable logic</strong></li>
<li><strong>Limit subquery result sets when possible</strong></li>
</ol>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-things-to-watch-out-for">âš ï¸ Things to Watch Out For</h2>
<h3 id="1-null-handling-in-not-in">1. <strong>NULL Handling in NOT IN</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Returns no results if subquery contains NULL</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> customer_id <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (
    <span class="hljs-keyword">SELECT</span> customer_id <span class="hljs-keyword">FROM</span> orders  <span class="hljs-comment">-- If any customer_id is NULL</span>
);

<span class="hljs-comment">-- Solution: Filter NULLs or use NOT EXISTS</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> customer_id <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (
    <span class="hljs-keyword">SELECT</span> customer_id <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> customer_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
);
</div></code></pre>
<h3 id="2-correlated-subquery-performance">2. <strong>Correlated Subquery Performance</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Slow: Executes subquery for each row</span>
<span class="hljs-keyword">SELECT</span> c.*, (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
) <span class="hljs-keyword">FROM</span> customers c;

<span class="hljs-comment">-- Better: Use JOIN</span>
<span class="hljs-keyword">SELECT</span> c.*, <span class="hljs-keyword">COUNT</span>(o.order_id)
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id;
</div></code></pre>
<h3 id="3-subquery-return-type-mismatch">3. <strong>Subquery Return Type Mismatch</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Error: Scalar subquery returns multiple rows</span>
<span class="hljs-keyword">SELECT</span> customer_id, (
    <span class="hljs-keyword">SELECT</span> order_date <span class="hljs-keyword">FROM</span> orders  <span class="hljs-comment">-- Missing WHERE clause</span>
) <span class="hljs-keyword">FROM</span> customers;

<span class="hljs-comment">-- Fix: Ensure single value</span>
<span class="hljs-keyword">SELECT</span> customer_id, (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">MAX</span>(order_date) <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> customer_id = customers.customer_id
) <span class="hljs-keyword">FROM</span> customers;
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%80-next-steps">ğŸš€ Next Steps</h2>
<p>In the next chapter, we'll explore <strong>Window Functions</strong> - advanced analytical functions that allow you to perform calculations across related rows without grouping. You'll learn about ROW_NUMBER(), RANK(), LAG(), LEAD(), and how to create powerful analytical queries.</p>
<hr>
<h2 id="%F0%9F%93%9D-quick-practice">ğŸ“ Quick Practice</h2>
<p>Try these subquery exercises:</p>
<ol>
<li><strong>Scalar Subqueries</strong>: Find products priced above their category average</li>
<li><strong>EXISTS</strong>: Find customers who have ordered in multiple categories</li>
<li><strong>NOT EXISTS</strong>: Find products never ordered by VIP customers</li>
<li><strong>Correlated</strong>: Find each customer's most expensive order</li>
<li><strong>CTEs</strong>: Create a customer segmentation analysis</li>
</ol>
<p>Consider:</p>
<ul>
<li>When to use subqueries vs JOINs</li>
<li>How to handle NULL values safely</li>
<li>Performance implications of different approaches</li>
<li>How to break complex problems into manageable parts</li>
</ul>
<h1 id="chapter-10-window-functions">Chapter 10: Window Functions</h1>
<h2 id="%F0%9F%93%9A-what-youll-learn">ğŸ“š What You'll Learn</h2>
<p>Window functions are powerful analytical tools that allow you to perform calculations across a set of rows related to the current row, without collapsing the result set like aggregate functions do. They're essential for advanced data analysis, ranking, running totals, and comparative analytics.</p>
<hr>
<h2 id="%F0%9F%8E%AF-learning-objectives">ğŸ¯ Learning Objectives</h2>
<p>By the end of this chapter, you will:</p>
<ul>
<li>Understand what window functions are and how they differ from aggregate functions</li>
<li>Master ranking functions (ROW_NUMBER, RANK, DENSE_RANK)</li>
<li>Use analytical functions (LAG, LEAD, FIRST_VALUE, LAST_VALUE)</li>
<li>Create running totals and moving averages</li>
<li>Apply window functions for business analytics</li>
<li>Optimize window function performance</li>
</ul>
<hr>
<h2 id="%F0%9F%94%8D-concept-explanation">ğŸ” Concept Explanation</h2>
<h3 id="what-are-window-functions">What are Window Functions?</h3>
<p>Window functions perform calculations across a set of rows that are somehow related to the current row. Unlike aggregate functions that return a single value for a group of rows, window functions return a value for each row while maintaining the detail level of the original query.</p>
<p><strong>Key Components:</strong></p>
<ul>
<li><strong>OVER clause</strong>: Defines the window of rows</li>
<li><strong>PARTITION BY</strong>: Divides rows into groups (like GROUP BY but doesn't collapse rows)</li>
<li><strong>ORDER BY</strong>: Defines the order within each partition</li>
<li><strong>Frame specification</strong>: Defines which rows within the partition to include</li>
</ul>
<h3 id="basic-syntax">Basic Syntax:</h3>
<pre class="hljs"><code><div>function_name() OVER (
    [PARTITION BY column1, column2, ...]
    [ORDER BY column1 [ASC|DESC], column2 [ASC|DESC], ...]
    [ROWS|RANGE frame_specification]
)
</div></code></pre>
<hr>
<h2 id="%F0%9F%9B%A0%EF%B8%8F-syntax-comparison">ğŸ› ï¸ Syntax Comparison</h2>
<h3 id="mysql-vs-postgresql-window-functions">MySQL vs PostgreSQL Window Functions</h3>
<p>Both MySQL (8.0+) and PostgreSQL support comprehensive window functions with similar syntax:</p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>MySQL 8.0+</th>
<th>PostgreSQL</th>
</tr>
</thead>
<tbody>
<tr>
<td>Basic Window Functions</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td>Ranking Functions</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td>Analytical Functions</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td>Frame Specifications</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td>Named Windows</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td>Advanced Frames</td>
<td>Limited</td>
<td>Full Support</td>
</tr>
</tbody>
</table>
<p><strong>Note</strong>: MySQL versions before 8.0 don't support window functions.</p>
<hr>
<h2 id="%F0%9F%93%8A-ranking-functions">ğŸ“Š Ranking Functions</h2>
<h3 id="rownumber">ROW_NUMBER()</h3>
<p>Assigns a unique sequential number to each row within a partition.</p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Basic row numbering</span>
<span class="hljs-keyword">SELECT</span>
    customer_id,
    first_name,
    last_name,
    order_date,
    total_amount,
    ROW_NUMBER() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date) <span class="hljs-keyword">as</span> order_sequence
<span class="hljs-keyword">FROM</span> orders o
<span class="hljs-keyword">JOIN</span> customers c <span class="hljs-keyword">ON</span> o.customer_id = c.customer_id
<span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date;

<span class="hljs-comment">-- Row numbering within partitions</span>
<span class="hljs-keyword">SELECT</span>
    customer_id,
    first_name,
    last_name,
    order_date,
    total_amount,
    ROW_NUMBER() <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> customer_id
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date
    ) <span class="hljs-keyword">as</span> customer_order_number
<span class="hljs-keyword">FROM</span> orders o
<span class="hljs-keyword">JOIN</span> customers c <span class="hljs-keyword">ON</span> o.customer_id = c.customer_id
<span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> customer_id, order_date;
</div></code></pre>
<h3 id="rank-and-denserank">RANK() and DENSE_RANK()</h3>
<p><strong>RANK()</strong>: Assigns ranks with gaps for ties
<strong>DENSE_RANK()</strong>: Assigns ranks without gaps for ties</p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Product ranking by sales within categories</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    c.category_name,
    sales.total_revenue,
    sales.units_sold,
    <span class="hljs-keyword">RANK</span>() <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> c.category_name
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sales.total_revenue <span class="hljs-keyword">DESC</span>
    ) <span class="hljs-keyword">as</span> revenue_rank,
    <span class="hljs-keyword">DENSE_RANK</span>() <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> c.category_name
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sales.total_revenue <span class="hljs-keyword">DESC</span>
    ) <span class="hljs-keyword">as</span> revenue_dense_rank,
    ROW_NUMBER() <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> c.category_name
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sales.total_revenue <span class="hljs-keyword">DESC</span>
    ) <span class="hljs-keyword">as</span> revenue_row_number
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span>
        oi.product_id,
        <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">as</span> total_revenue,
        <span class="hljs-keyword">SUM</span>(oi.quantity) <span class="hljs-keyword">as</span> units_sold
    <span class="hljs-keyword">FROM</span> order_items oi
    <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
    <span class="hljs-keyword">WHERE</span> o.status <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'delivered'</span>)
      <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> oi.product_id
) sales <span class="hljs-keyword">ON</span> p.product_id = sales.product_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.category_name, sales.total_revenue <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<h3 id="percentrank-and-cumedist">PERCENT_RANK() and CUME_DIST()</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Customer spending percentiles</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    customer_stats.total_spent,
    customer_stats.order_count,
    <span class="hljs-keyword">PERCENT_RANK</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> customer_stats.total_spent) <span class="hljs-keyword">as</span> spending_percentile,
    <span class="hljs-keyword">CUME_DIST</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> customer_stats.total_spent) <span class="hljs-keyword">as</span> cumulative_distribution,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">PERCENT_RANK</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> customer_stats.total_spent) &gt;= <span class="hljs-number">0.9</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Top 10%'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">PERCENT_RANK</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> customer_stats.total_spent) &gt;= <span class="hljs-number">0.75</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Top 25%'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">PERCENT_RANK</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> customer_stats.total_spent) &gt;= <span class="hljs-number">0.5</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Top 50%'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Bottom 50%'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> spending_tier
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span>
        customer_id,
        <span class="hljs-keyword">COUNT</span>(order_id) <span class="hljs-keyword">as</span> order_count,
        <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">as</span> total_spent
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id
    <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(order_id) &gt;= <span class="hljs-number">1</span>
) customer_stats <span class="hljs-keyword">ON</span> c.customer_id = customer_stats.customer_id
<span class="hljs-keyword">WHERE</span> c.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> customer_stats.total_spent <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%88-analytical-functions">ğŸ“ˆ Analytical Functions</h2>
<h3 id="lag-and-lead">LAG() and LEAD()</h3>
<p>Access data from previous or next rows within the same result set.</p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Monthly sales comparison</span>
<span class="hljs-keyword">WITH</span> monthly_sales <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        DATE_TRUNC(<span class="hljs-string">'month'</span>, order_date) <span class="hljs-keyword">as</span> <span class="hljs-keyword">month</span>,
        <span class="hljs-keyword">COUNT</span>(order_id) <span class="hljs-keyword">as</span> order_count,
        <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">as</span> total_revenue,
        <span class="hljs-keyword">AVG</span>(total_amount) <span class="hljs-keyword">as</span> avg_order_value
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
      <span class="hljs-keyword">AND</span> order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'24 months'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> DATE_TRUNC(<span class="hljs-string">'month'</span>, order_date)
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>
)
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">month</span>,
    order_count,
    total_revenue,
    avg_order_value,
    LAG(total_revenue, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>) <span class="hljs-keyword">as</span> prev_month_revenue,
    <span class="hljs-keyword">LEAD</span>(total_revenue, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>) <span class="hljs-keyword">as</span> next_month_revenue,
    total_revenue - LAG(total_revenue, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>) <span class="hljs-keyword">as</span> revenue_change,
    <span class="hljs-keyword">ROUND</span>(
        ((total_revenue - LAG(total_revenue, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>)) /
         <span class="hljs-keyword">NULLIF</span>(LAG(total_revenue, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>), <span class="hljs-number">0</span>)) * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>
    ) <span class="hljs-keyword">as</span> revenue_change_percent,
    LAG(total_revenue, <span class="hljs-number">12</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>) <span class="hljs-keyword">as</span> same_month_last_year,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> LAG(total_revenue, <span class="hljs-number">12</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-keyword">ROUND</span>(
                ((total_revenue - LAG(total_revenue, <span class="hljs-number">12</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>)) /
                 LAG(total_revenue, <span class="hljs-number">12</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>)) * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>
            )
        <span class="hljs-keyword">ELSE</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> yoy_growth_percent
<span class="hljs-keyword">FROM</span> monthly_sales
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>;
</div></code></pre>
<h3 id="firstvalue-and-lastvalue">FIRST_VALUE() and LAST_VALUE()</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Customer order analysis with first and last orders</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    o.order_id,
    o.order_date,
    o.total_amount,
    <span class="hljs-keyword">FIRST_VALUE</span>(o.order_date) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> c.customer_id
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> o.order_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">PRECEDING</span>
    ) <span class="hljs-keyword">as</span> first_order_date,
    <span class="hljs-keyword">FIRST_VALUE</span>(o.total_amount) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> c.customer_id
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> o.order_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">PRECEDING</span>
    ) <span class="hljs-keyword">as</span> first_order_amount,
    <span class="hljs-keyword">LAST_VALUE</span>(o.order_date) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> c.customer_id
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> o.order_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">PRECEDING</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">FOLLOWING</span>
    ) <span class="hljs-keyword">as</span> last_order_date,
    <span class="hljs-keyword">LAST_VALUE</span>(o.total_amount) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> c.customer_id
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> o.order_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">PRECEDING</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">FOLLOWING</span>
    ) <span class="hljs-keyword">as</span> last_order_amount,
    ROW_NUMBER() <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> c.customer_id
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> o.order_date
    ) <span class="hljs-keyword">as</span> order_sequence
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
  <span class="hljs-keyword">AND</span> c.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.customer_id, o.order_date;
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%A2-running-totals-and-moving-averages">ğŸ”¢ Running Totals and Moving Averages</h2>
<h3 id="running-totals">Running Totals</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Daily sales with running totals</span>
<span class="hljs-keyword">WITH</span> daily_sales <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        <span class="hljs-built_in">DATE</span>(order_date) <span class="hljs-keyword">as</span> sale_date,
        <span class="hljs-keyword">COUNT</span>(order_id) <span class="hljs-keyword">as</span> daily_orders,
        <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">as</span> daily_revenue
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
      <span class="hljs-keyword">AND</span> order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'90 days'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">DATE</span>(order_date)
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sale_date
)
<span class="hljs-keyword">SELECT</span>
    sale_date,
    daily_orders,
    daily_revenue,
    <span class="hljs-keyword">SUM</span>(daily_orders) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sale_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">PRECEDING</span>
    ) <span class="hljs-keyword">as</span> running_total_orders,
    <span class="hljs-keyword">SUM</span>(daily_revenue) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sale_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">PRECEDING</span>
    ) <span class="hljs-keyword">as</span> running_total_revenue,
    <span class="hljs-keyword">AVG</span>(daily_revenue) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sale_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">PRECEDING</span>
    ) <span class="hljs-keyword">as</span> cumulative_avg_revenue
<span class="hljs-keyword">FROM</span> daily_sales
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sale_date;
</div></code></pre>
<h3 id="moving-averages">Moving Averages</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- 7-day and 30-day moving averages</span>
<span class="hljs-keyword">WITH</span> daily_sales <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        <span class="hljs-built_in">DATE</span>(order_date) <span class="hljs-keyword">as</span> sale_date,
        <span class="hljs-keyword">COUNT</span>(order_id) <span class="hljs-keyword">as</span> daily_orders,
        <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">as</span> daily_revenue
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
      <span class="hljs-keyword">AND</span> order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'90 days'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">DATE</span>(order_date)
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sale_date
)
<span class="hljs-keyword">SELECT</span>
    sale_date,
    daily_orders,
    daily_revenue,
    <span class="hljs-keyword">AVG</span>(daily_revenue) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sale_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">6</span> <span class="hljs-keyword">PRECEDING</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">ROW</span>
    ) <span class="hljs-keyword">as</span> seven_day_avg,
    <span class="hljs-keyword">AVG</span>(daily_revenue) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sale_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">29</span> <span class="hljs-keyword">PRECEDING</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">ROW</span>
    ) <span class="hljs-keyword">as</span> thirty_day_avg,
    <span class="hljs-keyword">SUM</span>(daily_revenue) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sale_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">6</span> <span class="hljs-keyword">PRECEDING</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">ROW</span>
    ) <span class="hljs-keyword">as</span> seven_day_total,
    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sale_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">6</span> <span class="hljs-keyword">PRECEDING</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">ROW</span>
    ) <span class="hljs-keyword">as</span> days_in_7day_window
<span class="hljs-keyword">FROM</span> daily_sales
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sale_date;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-frame-specifications">ğŸ¯ Frame Specifications</h2>
<h3 id="understanding-window-frames">Understanding Window Frames</h3>
<p>Window frames define which rows within the partition to include in the calculation:</p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Different frame specifications</span>
<span class="hljs-keyword">SELECT</span>
    order_date,
    total_amount,
    <span class="hljs-comment">-- Default frame: RANGE UNBOUNDED PRECEDING</span>
    <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date) <span class="hljs-keyword">as</span> running_total_default,

    <span class="hljs-comment">-- Explicit ROWS frame</span>
    <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">PRECEDING</span>
    ) <span class="hljs-keyword">as</span> running_total_rows,

    <span class="hljs-comment">-- Moving window: last 3 rows including current</span>
    <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">2</span> <span class="hljs-keyword">PRECEDING</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">ROW</span>
    ) <span class="hljs-keyword">as</span> last_3_orders_total,

    <span class="hljs-comment">-- Centered window: 1 before, current, 1 after</span>
    <span class="hljs-keyword">AVG</span>(total_amount) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">PRECEDING</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FOLLOWING</span>
    ) <span class="hljs-keyword">as</span> centered_avg,

    <span class="hljs-comment">-- Future window: current and next 2 rows</span>
    <span class="hljs-keyword">MAX</span>(total_amount) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">ROW</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">2</span> <span class="hljs-keyword">FOLLOWING</span>
    ) <span class="hljs-keyword">as</span> max_next_3_orders
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
  <span class="hljs-keyword">AND</span> customer_id = <span class="hljs-number">1</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date;
</div></code></pre>
<h3 id="rows-vs-range">ROWS vs RANGE</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Demonstrating ROWS vs RANGE with duplicate dates</span>
<span class="hljs-keyword">SELECT</span>
    order_date,
    total_amount,
    order_id,
    <span class="hljs-comment">-- ROWS: Physical row-based window</span>
    <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">PRECEDING</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FOLLOWING</span>
    ) <span class="hljs-keyword">as</span> rows_sum,

    <span class="hljs-comment">-- RANGE: Logical value-based window (includes all rows with same order_date)</span>
    <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date
        <span class="hljs-keyword">RANGE</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'1 day'</span> <span class="hljs-keyword">PRECEDING</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'1 day'</span> <span class="hljs-keyword">FOLLOWING</span>
    ) <span class="hljs-keyword">as</span> range_sum
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
  <span class="hljs-keyword">AND</span> order_date &gt;= <span class="hljs-string">'2024-01-01'</span>
  <span class="hljs-keyword">AND</span> order_date &lt;= <span class="hljs-string">'2024-01-10'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date, order_id;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8F%A2-real-world-business-examples">ğŸ¢ Real-World Business Examples</h2>
<h3 id="example-1-sales-performance-dashboard">Example 1: Sales Performance Dashboard</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Comprehensive sales performance analysis</span>
<span class="hljs-keyword">WITH</span> sales_data <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        DATE_TRUNC(<span class="hljs-string">'month'</span>, o.order_date) <span class="hljs-keyword">as</span> <span class="hljs-keyword">month</span>,
        c.city,
        c.state,
        <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">as</span> orders,
        <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> revenue,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.customer_id) <span class="hljs-keyword">as</span> unique_customers,
        <span class="hljs-keyword">AVG</span>(o.total_amount) <span class="hljs-keyword">as</span> avg_order_value
    <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">JOIN</span> customers c <span class="hljs-keyword">ON</span> o.customer_id = c.customer_id
    <span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
      <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'24 months'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> DATE_TRUNC(<span class="hljs-string">'month'</span>, o.order_date), c.city, c.state
),
ranked_cities <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        <span class="hljs-keyword">month</span>,
        city,
        state,
        orders,
        revenue,
        unique_customers,
        avg_order_value,
        <span class="hljs-comment">-- Ranking within each month</span>
        <span class="hljs-keyword">RANK</span>() <span class="hljs-keyword">OVER</span> (
            <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> revenue <span class="hljs-keyword">DESC</span>
        ) <span class="hljs-keyword">as</span> monthly_revenue_rank,

        <span class="hljs-comment">-- Running totals for each city</span>
        <span class="hljs-keyword">SUM</span>(revenue) <span class="hljs-keyword">OVER</span> (
            <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> city, state
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>
            <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">PRECEDING</span>
        ) <span class="hljs-keyword">as</span> cumulative_revenue,

        <span class="hljs-comment">-- Month-over-month comparison</span>
        LAG(revenue, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (
            <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> city, state
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>
        ) <span class="hljs-keyword">as</span> prev_month_revenue,

        <span class="hljs-comment">-- 3-month moving average</span>
        <span class="hljs-keyword">AVG</span>(revenue) <span class="hljs-keyword">OVER</span> (
            <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> city, state
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>
            <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">2</span> <span class="hljs-keyword">PRECEDING</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">ROW</span>
        ) <span class="hljs-keyword">as</span> three_month_avg,

        <span class="hljs-comment">-- Year-over-year comparison</span>
        LAG(revenue, <span class="hljs-number">12</span>) <span class="hljs-keyword">OVER</span> (
            <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> city, state
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>
        ) <span class="hljs-keyword">as</span> same_month_last_year
    <span class="hljs-keyword">FROM</span> sales_data
)
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">month</span>,
    city,
    state,
    orders,
    revenue,
    unique_customers,
    avg_order_value,
    monthly_revenue_rank,
    cumulative_revenue,
    prev_month_revenue,
    revenue - prev_month_revenue <span class="hljs-keyword">as</span> mom_change,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> prev_month_revenue &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-keyword">ROUND</span>(((revenue - prev_month_revenue) / prev_month_revenue) * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>)
        <span class="hljs-keyword">ELSE</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> mom_change_percent,
    three_month_avg,
    same_month_last_year,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> same_month_last_year &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-keyword">ROUND</span>(((revenue - same_month_last_year) / same_month_last_year) * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>)
        <span class="hljs-keyword">ELSE</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> yoy_change_percent
<span class="hljs-keyword">FROM</span> ranked_cities
<span class="hljs-keyword">WHERE</span> monthly_revenue_rank &lt;= <span class="hljs-number">10</span>  <span class="hljs-comment">-- Top 10 cities by revenue each month</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span> <span class="hljs-keyword">DESC</span>, monthly_revenue_rank;
</div></code></pre>
<h3 id="example-2-customer-lifecycle-analysis">Example 2: Customer Lifecycle Analysis</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Customer journey and lifecycle analysis</span>
<span class="hljs-keyword">WITH</span> customer_orders <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        c.customer_id,
        c.first_name,
        c.last_name,
        c.email,
        c.created_at <span class="hljs-keyword">as</span> registration_date,
        o.order_id,
        o.order_date,
        o.total_amount,
        ROW_NUMBER() <span class="hljs-keyword">OVER</span> (
            <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> c.customer_id
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> o.order_date
        ) <span class="hljs-keyword">as</span> order_number
    <span class="hljs-keyword">FROM</span> customers c
    <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
    <span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
      <span class="hljs-keyword">AND</span> c.status = <span class="hljs-string">'active'</span>
),
customer_metrics <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        customer_id,
        first_name,
        last_name,
        email,
        registration_date,
        order_id,
        order_date,
        total_amount,
        order_number,

        <span class="hljs-comment">-- First order details</span>
        <span class="hljs-keyword">FIRST_VALUE</span>(order_date) <span class="hljs-keyword">OVER</span> (
            <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> customer_id
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date
            <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">PRECEDING</span>
        ) <span class="hljs-keyword">as</span> first_order_date,

        <span class="hljs-keyword">FIRST_VALUE</span>(total_amount) <span class="hljs-keyword">OVER</span> (
            <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> customer_id
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date
            <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">PRECEDING</span>
        ) <span class="hljs-keyword">as</span> first_order_amount,

        <span class="hljs-comment">-- Running customer totals</span>
        <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">OVER</span> (
            <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> customer_id
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date
            <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">PRECEDING</span>
        ) <span class="hljs-keyword">as</span> cumulative_spent,

        <span class="hljs-comment">-- Average order value up to this point</span>
        <span class="hljs-keyword">AVG</span>(total_amount) <span class="hljs-keyword">OVER</span> (
            <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> customer_id
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date
            <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">PRECEDING</span>
        ) <span class="hljs-keyword">as</span> avg_order_value_to_date,

        <span class="hljs-comment">-- Days between orders</span>
        LAG(order_date, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (
            <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> customer_id
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date
        ) <span class="hljs-keyword">as</span> prev_order_date,

        <span class="hljs-comment">-- Time to next order</span>
        <span class="hljs-keyword">LEAD</span>(order_date, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (
            <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> customer_id
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date
        ) <span class="hljs-keyword">as</span> next_order_date,

        <span class="hljs-comment">-- Last order in sequence</span>
        <span class="hljs-keyword">LAST_VALUE</span>(order_date) <span class="hljs-keyword">OVER</span> (
            <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> customer_id
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date
            <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">PRECEDING</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">FOLLOWING</span>
        ) <span class="hljs-keyword">as</span> last_order_date,

        <span class="hljs-comment">-- Total orders for customer</span>
        <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">OVER</span> (
            <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> customer_id
        ) <span class="hljs-keyword">as</span> total_orders
    <span class="hljs-keyword">FROM</span> customer_orders
)
<span class="hljs-keyword">SELECT</span>
    customer_id,
    first_name,
    last_name,
    email,
    registration_date,
    order_number,
    order_date,
    total_amount,
    first_order_date,
    first_order_amount,
    cumulative_spent,
    avg_order_value_to_date,

    <span class="hljs-comment">-- Days since registration to first order</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> order_number = <span class="hljs-number">1</span> <span class="hljs-keyword">THEN</span>
            order_date - registration_date
        <span class="hljs-keyword">ELSE</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> days_to_first_order,

    <span class="hljs-comment">-- Days between consecutive orders</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> prev_order_date <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span>
            order_date - prev_order_date
        <span class="hljs-keyword">ELSE</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> days_since_last_order,

    <span class="hljs-comment">-- Customer lifecycle stage</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> order_number = <span class="hljs-number">1</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'New Customer'</span>
        <span class="hljs-keyword">WHEN</span> order_number = <span class="hljs-number">2</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Repeat Customer'</span>
        <span class="hljs-keyword">WHEN</span> order_number &gt;= <span class="hljs-number">3</span> <span class="hljs-keyword">AND</span> order_number &lt;= <span class="hljs-number">5</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Regular Customer'</span>
        <span class="hljs-keyword">WHEN</span> order_number &gt; <span class="hljs-number">5</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Loyal Customer'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> lifecycle_stage,

    <span class="hljs-comment">-- Customer value tier based on cumulative spending</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> cumulative_spent &gt;= <span class="hljs-number">2000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'VIP'</span>
        <span class="hljs-keyword">WHEN</span> cumulative_spent &gt;= <span class="hljs-number">1000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Premium'</span>
        <span class="hljs-keyword">WHEN</span> cumulative_spent &gt;= <span class="hljs-number">500</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Regular'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Basic'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> value_tier,

    total_orders,
    last_order_date,
    <span class="hljs-keyword">CURRENT_DATE</span> - last_order_date <span class="hljs-keyword">as</span> days_since_last_order_overall
<span class="hljs-keyword">FROM</span> customer_metrics
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> customer_id, order_number;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-use-cases--interview-tips">ğŸ¯ Use Cases &amp; Interview Tips</h2>
<h3 id="common-interview-questions">Common Interview Questions:</h3>
<ol>
<li>
<p><strong>&quot;What's the difference between RANK() and DENSE_RANK()?&quot;</strong></p>
<ul>
<li>RANK() leaves gaps after ties (1, 2, 2, 4)</li>
<li>DENSE_RANK() doesn't leave gaps (1, 2, 2, 3)</li>
<li>ROW_NUMBER() assigns unique numbers regardless of ties</li>
</ul>
</li>
<li>
<p><strong>&quot;How do you calculate a running total?&quot;</strong></p>
<ul>
<li>Use SUM() with ROWS UNBOUNDED PRECEDING</li>
<li>Explain frame specifications</li>
<li>Discuss performance considerations</li>
</ul>
</li>
<li>
<p><strong>&quot;When would you use LAG() vs LEAD()?&quot;</strong></p>
<ul>
<li>LAG(): Compare with previous values (month-over-month growth)</li>
<li>LEAD(): Look ahead to future values (forecasting)</li>
<li>Both useful for time series analysis</li>
</ul>
</li>
<li>
<p><strong>&quot;How do you handle NULL values in window functions?&quot;</strong></p>
<ul>
<li>Most window functions ignore NULLs by default</li>
<li>Use COALESCE() or CASE statements for explicit handling</li>
<li>Consider IGNORE NULLS clause where supported</li>
</ul>
</li>
</ol>
<h3 id="performance-best-practices">Performance Best Practices:</h3>
<ol>
<li><strong>Use appropriate indexes for PARTITION BY and ORDER BY columns</strong></li>
<li><strong>Limit the window frame size when possible</strong></li>
<li><strong>Consider using named windows for repeated window specifications</strong></li>
<li><strong>Be careful with LAST_VALUE() - specify proper frame bounds</strong></li>
<li><strong>Use LIMIT with window functions for large datasets</strong></li>
</ol>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-things-to-watch-out-for">âš ï¸ Things to Watch Out For</h2>
<h3 id="1-lastvalue-default-frame">1. <strong>LAST_VALUE() Default Frame</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Default frame only goes to current row</span>
<span class="hljs-keyword">SELECT</span>
    order_date,
    total_amount,
    <span class="hljs-keyword">LAST_VALUE</span>(total_amount) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date) <span class="hljs-keyword">as</span> last_value_wrong
<span class="hljs-keyword">FROM</span> orders;

<span class="hljs-comment">-- Solution: Specify proper frame</span>
<span class="hljs-keyword">SELECT</span>
    order_date,
    total_amount,
    <span class="hljs-keyword">LAST_VALUE</span>(total_amount) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">PRECEDING</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">FOLLOWING</span>
    ) <span class="hljs-keyword">as</span> last_value_correct
<span class="hljs-keyword">FROM</span> orders;
</div></code></pre>
<h3 id="2-performance-with-large-datasets">2. <strong>Performance with Large Datasets</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Slow: No indexes on window columns</span>
<span class="hljs-keyword">SELECT</span>
    customer_id,
    order_date,
    ROW_NUMBER() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> customer_id <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date)
<span class="hljs-keyword">FROM</span> orders;  <span class="hljs-comment">-- Millions of rows</span>

<span class="hljs-comment">-- Better: Create appropriate indexes</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_orders_customer_date <span class="hljs-keyword">ON</span> orders(customer_id, order_date);
</div></code></pre>
<h3 id="3-null-handling-in-analytical-functions">3. <strong>NULL Handling in Analytical Functions</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Be aware of NULL behavior</span>
<span class="hljs-keyword">SELECT</span>
    order_date,
    total_amount,
    LAG(total_amount, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date) <span class="hljs-keyword">as</span> prev_amount,
    LAG(total_amount, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date) <span class="hljs-keyword">as</span> prev_amount_default_0
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">1</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%80-next-steps">ğŸš€ Next Steps</h2>
<p>In the next chapter, we'll explore <strong>Indexes and Query Optimization</strong> - crucial topics for improving database performance. You'll learn about different index types, how to analyze query execution plans, and optimization strategies for complex queries.</p>
<hr>
<h2 id="%F0%9F%93%9D-quick-practice">ğŸ“ Quick Practice</h2>
<p>Try these window function exercises:</p>
<ol>
<li><strong>Ranking</strong>: Find the top 3 products by sales in each category</li>
<li><strong>Running Totals</strong>: Calculate cumulative sales by month</li>
<li><strong>Moving Averages</strong>: Create 7-day moving average of daily orders</li>
<li><strong>Analytical Functions</strong>: Find customers who increased their order frequency</li>
<li><strong>Complex Analysis</strong>: Build a customer churn prediction model using window functions</li>
</ol>
<p>Consider:</p>
<ul>
<li>When to use different ranking functions</li>
<li>How frame specifications affect results</li>
<li>Performance implications of window functions</li>
<li>Real-world applications in business analytics</li>
</ul>
<h1 id="chapter-11-indexes-and-query-optimization">Chapter 11: Indexes and Query Optimization</h1>
<h2 id="%F0%9F%93%9A-what-youll-learn">ğŸ“š What You'll Learn</h2>
<p>Indexes are database objects that improve query performance by creating shortcuts to data. Understanding how to create, use, and optimize indexes is crucial for building high-performance database applications. This chapter covers index types, query optimization techniques, and performance tuning strategies.</p>
<hr>
<h2 id="%F0%9F%8E%AF-learning-objectives">ğŸ¯ Learning Objectives</h2>
<p>By the end of this chapter, you will:</p>
<ul>
<li>Understand different types of indexes and when to use them</li>
<li>Know how to analyze query execution plans</li>
<li>Master index creation and optimization strategies</li>
<li>Learn query optimization techniques</li>
<li>Understand the trade-offs between query performance and storage</li>
<li>Apply performance tuning best practices</li>
</ul>
<hr>
<h2 id="%F0%9F%94%8D-concept-explanation">ğŸ” Concept Explanation</h2>
<h3 id="what-are-indexes">What are Indexes?</h3>
<p>An index is a data structure that improves the speed of data retrieval operations on a database table. Think of it like an index in a book - instead of reading every page to find a topic, you can use the index to jump directly to the relevant pages.</p>
<p><strong>Key Benefits:</strong></p>
<ul>
<li>Faster SELECT queries</li>
<li>Faster WHERE clause filtering</li>
<li>Faster ORDER BY operations</li>
<li>Faster JOIN operations</li>
</ul>
<p><strong>Trade-offs:</strong></p>
<ul>
<li>Additional storage space</li>
<li>Slower INSERT/UPDATE/DELETE operations</li>
<li>Maintenance overhead</li>
</ul>
<hr>
<h2 id="%F0%9F%9B%A0%EF%B8%8F-index-types-comparison">ğŸ› ï¸ Index Types Comparison</h2>
<h3 id="mysql-vs-postgresql-index-types">MySQL vs PostgreSQL Index Types</h3>
<table>
<thead>
<tr>
<th>Index Type</th>
<th>MySQL</th>
<th>PostgreSQL</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td>B-Tree</td>
<td>âœ… (Default)</td>
<td>âœ… (Default)</td>
<td>General purpose, range queries</td>
</tr>
<tr>
<td>Hash</td>
<td>âœ… (Memory engine)</td>
<td>âœ…</td>
<td>Equality comparisons only</td>
</tr>
<tr>
<td>Full-Text</td>
<td>âœ…</td>
<td>âœ…</td>
<td>Text search</td>
</tr>
<tr>
<td>Spatial</td>
<td>âœ…</td>
<td>âœ… (PostGIS)</td>
<td>Geographic data</td>
</tr>
<tr>
<td>Partial</td>
<td>âŒ</td>
<td>âœ…</td>
<td>Conditional indexing</td>
</tr>
<tr>
<td>Expression</td>
<td>âŒ</td>
<td>âœ…</td>
<td>Function-based indexing</td>
</tr>
<tr>
<td>GIN</td>
<td>âŒ</td>
<td>âœ…</td>
<td>Array, JSON, full-text</td>
</tr>
<tr>
<td>GiST</td>
<td>âŒ</td>
<td>âœ…</td>
<td>Complex data types</td>
</tr>
<tr>
<td>Covering</td>
<td>âœ… (5.7+)</td>
<td>âœ…</td>
<td>Include non-key columns</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="%F0%9F%93%8A-basic-index-operations">ğŸ“Š Basic Index Operations</h2>
<h3 id="creating-indexes">Creating Indexes</h3>
<p><strong>MySQL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Basic index creation</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_customer_email <span class="hljs-keyword">ON</span> customers(email);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_order_date <span class="hljs-keyword">ON</span> orders(order_date);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_product_category <span class="hljs-keyword">ON</span> products(category_id);

<span class="hljs-comment">-- Composite index</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_order_customer_date <span class="hljs-keyword">ON</span> orders(customer_id, order_date);

<span class="hljs-comment">-- Unique index</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">INDEX</span> idx_customer_email_unique <span class="hljs-keyword">ON</span> customers(email);

<span class="hljs-comment">-- Covering index (MySQL 5.7+)</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> orders <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">INDEX</span> idx_customer_covering (customer_id) <span class="hljs-keyword">INCLUDE</span> (order_date, total_amount);

<span class="hljs-comment">-- Full-text index</span>
<span class="hljs-keyword">CREATE</span> FULLTEXT <span class="hljs-keyword">INDEX</span> idx_product_description <span class="hljs-keyword">ON</span> products(product_name, description);
</div></code></pre>
<p><strong>PostgreSQL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Basic index creation</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_customer_email <span class="hljs-keyword">ON</span> customers(email);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_order_date <span class="hljs-keyword">ON</span> orders(order_date);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_product_category <span class="hljs-keyword">ON</span> products(category_id);

<span class="hljs-comment">-- Composite index</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_order_customer_date <span class="hljs-keyword">ON</span> orders(customer_id, order_date);

<span class="hljs-comment">-- Unique index</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">INDEX</span> idx_customer_email_unique <span class="hljs-keyword">ON</span> customers(email);

<span class="hljs-comment">-- Partial index (PostgreSQL only)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_active_customers <span class="hljs-keyword">ON</span> customers(email) <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>;

<span class="hljs-comment">-- Expression index (PostgreSQL only)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_customer_lower_email <span class="hljs-keyword">ON</span> customers(<span class="hljs-keyword">LOWER</span>(email));

<span class="hljs-comment">-- Covering index</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_customer_covering <span class="hljs-keyword">ON</span> orders(customer_id) <span class="hljs-keyword">INCLUDE</span> (order_date, total_amount);

<span class="hljs-comment">-- GIN index for JSON</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_product_attributes <span class="hljs-keyword">ON</span> products <span class="hljs-keyword">USING</span> GIN(<span class="hljs-keyword">attributes</span>);

<span class="hljs-comment">-- Full-text index</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_product_search <span class="hljs-keyword">ON</span> products <span class="hljs-keyword">USING</span> GIN(to_tsvector(<span class="hljs-string">'english'</span>, product_name || <span class="hljs-string">' '</span> || description));
</div></code></pre>
<h3 id="viewing-and-managing-indexes">Viewing and Managing Indexes</h3>
<p><strong>MySQL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Show indexes for a table</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">INDEXES</span> <span class="hljs-keyword">FROM</span> orders;

<span class="hljs-comment">-- Show index usage statistics</span>
<span class="hljs-keyword">SELECT</span>
    TABLE_SCHEMA,
    TABLE_NAME,
    INDEX_NAME,
    COLUMN_NAME,
    CARDINALITY
<span class="hljs-keyword">FROM</span> INFORMATION_SCHEMA.STATISTICS
<span class="hljs-keyword">WHERE</span> TABLE_SCHEMA = <span class="hljs-string">'your_database'</span>
  <span class="hljs-keyword">AND</span> TABLE_NAME = <span class="hljs-string">'orders'</span>;

<span class="hljs-comment">-- Drop index</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">INDEX</span> idx_order_date <span class="hljs-keyword">ON</span> orders;
</div></code></pre>
<p><strong>PostgreSQL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Show indexes for a table</span>
\d+ orders

<span class="hljs-comment">-- Query index information</span>
<span class="hljs-keyword">SELECT</span>
    schemaname,
    tablename,
    indexname,
    indexdef
<span class="hljs-keyword">FROM</span> pg_indexes
<span class="hljs-keyword">WHERE</span> tablename = <span class="hljs-string">'orders'</span>;

<span class="hljs-comment">-- Index usage statistics</span>
<span class="hljs-keyword">SELECT</span>
    schemaname,
    tablename,
    indexname,
    idx_tup_read,
    idx_tup_fetch
<span class="hljs-keyword">FROM</span> pg_stat_user_indexes
<span class="hljs-keyword">WHERE</span> tablename = <span class="hljs-string">'orders'</span>;

<span class="hljs-comment">-- Drop index</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">INDEX</span> idx_order_date;
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%8D-query-execution-plans">ğŸ” Query Execution Plans</h2>
<h3 id="understanding-explain">Understanding EXPLAIN</h3>
<p><strong>MySQL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Basic EXPLAIN</span>
<span class="hljs-keyword">EXPLAIN</span> <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">123</span>;

<span class="hljs-comment">-- Detailed execution plan</span>
<span class="hljs-keyword">EXPLAIN</span> <span class="hljs-keyword">FORMAT</span>=<span class="hljs-keyword">JSON</span>
<span class="hljs-keyword">SELECT</span>
    c.first_name,
    c.last_name,
    <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">as</span> order_count,
    <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> total_spent
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">WHERE</span> c.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-string">'2024-01-01'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(o.order_id) &gt; <span class="hljs-number">5</span>;

<span class="hljs-comment">-- Analyze actual execution</span>
<span class="hljs-keyword">EXPLAIN</span> <span class="hljs-keyword">ANALYZE</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> order_date <span class="hljs-keyword">BETWEEN</span> <span class="hljs-string">'2024-01-01'</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">'2024-12-31'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_amount <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">100</span>;
</div></code></pre>
<p><strong>PostgreSQL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Basic EXPLAIN</span>
<span class="hljs-keyword">EXPLAIN</span> <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">123</span>;

<span class="hljs-comment">-- Detailed execution plan</span>
<span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">ANALYZE</span>, BUFFERS, <span class="hljs-keyword">FORMAT</span> <span class="hljs-keyword">JSON</span>)
<span class="hljs-keyword">SELECT</span>
    c.first_name,
    c.last_name,
    <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">as</span> order_count,
    <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> total_spent
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">WHERE</span> c.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-string">'2024-01-01'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(o.order_id) &gt; <span class="hljs-number">5</span>;

<span class="hljs-comment">-- Visual execution plan</span>
<span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">ANALYZE</span>, BUFFERS, VERBOSE)
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> order_date <span class="hljs-keyword">BETWEEN</span> <span class="hljs-string">'2024-01-01'</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">'2024-12-31'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_amount <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">100</span>;
</div></code></pre>
<h3 id="reading-execution-plans">Reading Execution Plans</h3>
<p><strong>Key Metrics to Watch:</strong></p>
<ul>
<li><strong>Cost</strong>: Estimated query cost (PostgreSQL)</li>
<li><strong>Rows</strong>: Number of rows processed</li>
<li><strong>Time</strong>: Actual execution time</li>
<li><strong>Access Method</strong>: How data is accessed (Index Scan, Seq Scan, etc.)</li>
<li><strong>Join Type</strong>: How tables are joined (Nested Loop, Hash Join, etc.)</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-comment">-- Example: Analyzing a slow query</span>
<span class="hljs-keyword">EXPLAIN</span> <span class="hljs-keyword">ANALYZE</span>
<span class="hljs-keyword">SELECT</span>
    p.product_name,
    c.category_name,
    <span class="hljs-keyword">SUM</span>(oi.quantity) <span class="hljs-keyword">as</span> total_sold,
    <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">as</span> revenue
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> p.product_id = oi.product_id
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
<span class="hljs-keyword">WHERE</span> o.order_date &gt;= <span class="hljs-string">'2024-01-01'</span>
  <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
  <span class="hljs-keyword">AND</span> p.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> p.product_id, p.product_name, c.category_name
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">SUM</span>(oi.quantity) &gt; <span class="hljs-number">100</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> revenue <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<hr>
<h2 id="%E2%9A%A1-index-optimization-strategies">âš¡ Index Optimization Strategies</h2>
<h3 id="1-composite-index-column-order">1. Composite Index Column Order</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Rule: Most selective columns first, then by query patterns</span>

<span class="hljs-comment">-- Good: Selective customer_id first, then date range</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_orders_customer_date_status <span class="hljs-keyword">ON</span> orders(customer_id, order_date, <span class="hljs-keyword">status</span>);

<span class="hljs-comment">-- Query that benefits from this index</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">123</span>
  <span class="hljs-keyword">AND</span> order_date &gt;= <span class="hljs-string">'2024-01-01'</span>
  <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>;

<span class="hljs-comment">-- Also benefits from leftmost prefix</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">123</span>;
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">123</span> <span class="hljs-keyword">AND</span> order_date &gt;= <span class="hljs-string">'2024-01-01'</span>;

<span class="hljs-comment">-- Won't use the index efficiently</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> order_date &gt;= <span class="hljs-string">'2024-01-01'</span>;  <span class="hljs-comment">-- Skips customer_id</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>;        <span class="hljs-comment">-- Skips customer_id and order_date</span>
</div></code></pre>
<h3 id="2-covering-indexes">2. Covering Indexes</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Include frequently accessed columns in the index</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_orders_covering <span class="hljs-keyword">ON</span> orders(customer_id, order_date)
<span class="hljs-keyword">INCLUDE</span> (total_amount, <span class="hljs-keyword">status</span>);

<span class="hljs-comment">-- This query can be satisfied entirely from the index</span>
<span class="hljs-keyword">SELECT</span> customer_id, order_date, total_amount, <span class="hljs-keyword">status</span>
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">123</span>
  <span class="hljs-keyword">AND</span> order_date &gt;= <span class="hljs-string">'2024-01-01'</span>;
</div></code></pre>
<h3 id="3-partial-indexes-postgresql">3. Partial Indexes (PostgreSQL)</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Index only active records</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_active_customers_email <span class="hljs-keyword">ON</span> customers(email)
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>;

<span class="hljs-comment">-- Index only recent orders</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_recent_orders <span class="hljs-keyword">ON</span> orders(customer_id, order_date)
<span class="hljs-keyword">WHERE</span> order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'1 year'</span>;

<span class="hljs-comment">-- Index only high-value orders</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_high_value_orders <span class="hljs-keyword">ON</span> orders(customer_id, order_date)
<span class="hljs-keyword">WHERE</span> total_amount &gt;= <span class="hljs-number">1000</span>;
</div></code></pre>
<h3 id="4-expression-indexes-postgresql">4. Expression Indexes (PostgreSQL)</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Index on function results</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_customer_lower_email <span class="hljs-keyword">ON</span> customers(<span class="hljs-keyword">LOWER</span>(email));

<span class="hljs-comment">-- Query that uses the expression index</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">LOWER</span>(email) = <span class="hljs-string">'john@example.com'</span>;

<span class="hljs-comment">-- Index on calculated values</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_order_year_month <span class="hljs-keyword">ON</span> orders(<span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> order_date), <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> order_date));

<span class="hljs-comment">-- Query using the expression index</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> order_date) = <span class="hljs-number">2024</span>
  <span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> order_date) = <span class="hljs-number">6</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%80-query-optimization-techniques">ğŸš€ Query Optimization Techniques</h2>
<h3 id="1-where-clause-optimization">1. WHERE Clause Optimization</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Bad: Non-sargable queries (can't use indexes effectively)</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">YEAR</span>(order_date) = <span class="hljs-number">2024</span>;
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">UPPER</span>(first_name) = <span class="hljs-string">'JOHN'</span>;
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> price * <span class="hljs-number">1.1</span> &gt; <span class="hljs-number">100</span>;

<span class="hljs-comment">-- Good: Sargable queries (can use indexes)</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> order_date &gt;= <span class="hljs-string">'2024-01-01'</span>
  <span class="hljs-keyword">AND</span> order_date &lt; <span class="hljs-string">'2025-01-01'</span>;

<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">WHERE</span> first_name = <span class="hljs-string">'John'</span>;
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> price &gt; <span class="hljs-number">100</span> / <span class="hljs-number">1.1</span>;

<span class="hljs-comment">-- Use EXISTS instead of IN for better performance</span>
<span class="hljs-comment">-- Bad: IN with subquery</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> customer_id <span class="hljs-keyword">IN</span> (
    <span class="hljs-keyword">SELECT</span> customer_id <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> order_date &gt;= <span class="hljs-string">'2024-01-01'</span>
);

<span class="hljs-comment">-- Good: EXISTS</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
      <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-string">'2024-01-01'</span>
);
</div></code></pre>
<h3 id="2-join-optimization">2. JOIN Optimization</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Ensure proper indexes on JOIN columns</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_orders_customer_id <span class="hljs-keyword">ON</span> orders(customer_id);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_order_items_order_id <span class="hljs-keyword">ON</span> order_items(order_id);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_order_items_product_id <span class="hljs-keyword">ON</span> order_items(product_id);

<span class="hljs-comment">-- Use appropriate JOIN types</span>
<span class="hljs-comment">-- INNER JOIN when you only want matching records</span>
<span class="hljs-keyword">SELECT</span> c.first_name, c.last_name, <span class="hljs-keyword">COUNT</span>(o.order_id)
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
<span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name;

<span class="hljs-comment">-- LEFT JOIN when you want all records from left table</span>
<span class="hljs-keyword">SELECT</span> c.first_name, c.last_name, <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">COUNT</span>(o.order_id), <span class="hljs-number">0</span>)
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
  <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name;
</div></code></pre>
<h3 id="3-limit-and-pagination-optimization">3. LIMIT and Pagination Optimization</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Bad: OFFSET becomes slow with large offsets</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span> <span class="hljs-keyword">OFFSET</span> <span class="hljs-number">10000</span>;  <span class="hljs-comment">-- Slow for large offsets</span>

<span class="hljs-comment">-- Good: Cursor-based pagination</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> order_date &lt; <span class="hljs-string">'2024-06-15 10:30:00'</span>  <span class="hljs-comment">-- Last order_date from previous page</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;

<span class="hljs-comment">-- Even better: Use indexed column for cursor</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> order_id &lt; <span class="hljs-number">12345</span>  <span class="hljs-comment">-- Last order_id from previous page</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_id <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;
</div></code></pre>
<h3 id="4-subquery-optimization">4. Subquery Optimization</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Convert correlated subqueries to JOINs when possible</span>
<span class="hljs-comment">-- Bad: Correlated subquery</span>
<span class="hljs-keyword">SELECT</span> c.*, (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*)
    <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">WHERE</span> o.customer_id = c.customer_id
      <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
) <span class="hljs-keyword">as</span> order_count
<span class="hljs-keyword">FROM</span> customers c;

<span class="hljs-comment">-- Good: JOIN with GROUP BY</span>
<span class="hljs-keyword">SELECT</span>
    c.*,
    <span class="hljs-keyword">COALESCE</span>(order_stats.order_count, <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> order_count
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span>
        customer_id,
        <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> order_count
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id
) order_stats <span class="hljs-keyword">ON</span> c.customer_id = order_stats.customer_id;
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%8A-performance-monitoring">ğŸ“Š Performance Monitoring</h2>
<h3 id="mysql-performance-monitoring">MySQL Performance Monitoring</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Enable slow query log</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> slow_query_log = <span class="hljs-string">'ON'</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> long_query_time = <span class="hljs-number">2</span>;  <span class="hljs-comment">-- Log queries taking more than 2 seconds</span>

<span class="hljs-comment">-- Check index usage</span>
<span class="hljs-keyword">SELECT</span>
    OBJECT_SCHEMA,
    OBJECT_NAME,
    INDEX_NAME,
    COUNT_FETCH,
    COUNT_INSERT,
    COUNT_UPDATE,
    COUNT_DELETE
<span class="hljs-keyword">FROM</span> performance_schema.table_io_waits_summary_by_index_usage
<span class="hljs-keyword">WHERE</span> OBJECT_SCHEMA = <span class="hljs-string">'your_database'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> COUNT_FETCH <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Find unused indexes</span>
<span class="hljs-keyword">SELECT</span>
    OBJECT_SCHEMA,
    OBJECT_NAME,
    INDEX_NAME
<span class="hljs-keyword">FROM</span> performance_schema.table_io_waits_summary_by_index_usage
<span class="hljs-keyword">WHERE</span> OBJECT_SCHEMA = <span class="hljs-string">'your_database'</span>
  <span class="hljs-keyword">AND</span> INDEX_NAME <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
  <span class="hljs-keyword">AND</span> COUNT_FETCH = <span class="hljs-number">0</span>
  <span class="hljs-keyword">AND</span> COUNT_INSERT = <span class="hljs-number">0</span>
  <span class="hljs-keyword">AND</span> COUNT_UPDATE = <span class="hljs-number">0</span>
  <span class="hljs-keyword">AND</span> COUNT_DELETE = <span class="hljs-number">0</span>;

<span class="hljs-comment">-- Query performance statistics</span>
<span class="hljs-keyword">SELECT</span>
    DIGEST_TEXT,
    COUNT_STAR,
    AVG_TIMER_WAIT/<span class="hljs-number">1000000000</span> <span class="hljs-keyword">as</span> avg_time_seconds,
    MAX_TIMER_WAIT/<span class="hljs-number">1000000000</span> <span class="hljs-keyword">as</span> max_time_seconds
<span class="hljs-keyword">FROM</span> performance_schema.events_statements_summary_by_digest
<span class="hljs-keyword">WHERE</span> DIGEST_TEXT <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> AVG_TIMER_WAIT <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;
</div></code></pre>
<h3 id="postgresql-performance-monitoring">PostgreSQL Performance Monitoring</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Enable query statistics</span>
<span class="hljs-comment">-- Add to postgresql.conf:</span>
<span class="hljs-comment">-- shared_preload_libraries = 'pg_stat_statements'</span>
<span class="hljs-comment">-- pg_stat_statements.track = all</span>

<span class="hljs-comment">-- Top slow queries</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">query</span>,
    calls,
    total_time,
    mean_time,
    <span class="hljs-keyword">rows</span>
<span class="hljs-keyword">FROM</span> pg_stat_statements
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> mean_time <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;

<span class="hljs-comment">-- Index usage statistics</span>
<span class="hljs-keyword">SELECT</span>
    schemaname,
    tablename,
    indexname,
    idx_tup_read,
    idx_tup_fetch,
    idx_scan
<span class="hljs-keyword">FROM</span> pg_stat_user_indexes
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> idx_scan <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Unused indexes</span>
<span class="hljs-keyword">SELECT</span>
    schemaname,
    tablename,
    indexname,
    idx_scan,
    pg_size_pretty(pg_relation_size(indexrelid)) <span class="hljs-keyword">as</span> <span class="hljs-keyword">size</span>
<span class="hljs-keyword">FROM</span> pg_stat_user_indexes
<span class="hljs-keyword">WHERE</span> idx_scan = <span class="hljs-number">0</span>
  <span class="hljs-keyword">AND</span> schemaname = <span class="hljs-string">'public'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> pg_relation_size(indexrelid) <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Table and index sizes</span>
<span class="hljs-keyword">SELECT</span>
    tablename,
    pg_size_pretty(pg_total_relation_size(tablename::regclass)) <span class="hljs-keyword">as</span> total_size,
    pg_size_pretty(pg_relation_size(tablename::regclass)) <span class="hljs-keyword">as</span> table_size,
    pg_size_pretty(pg_total_relation_size(tablename::regclass) - pg_relation_size(tablename::regclass)) <span class="hljs-keyword">as</span> index_size
<span class="hljs-keyword">FROM</span> pg_tables
<span class="hljs-keyword">WHERE</span> schemaname = <span class="hljs-string">'public'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> pg_total_relation_size(tablename::regclass) <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%92%A1-real-world-optimization-examples">ğŸ’¡ Real-World Optimization Examples</h2>
<h3 id="example-1-e-commerce-product-search-optimization">Example 1: E-commerce Product Search Optimization</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Slow product search query</span>
<span class="hljs-comment">-- Original slow query</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    p.price,
    c.category_name,
    <span class="hljs-keyword">AVG</span>(r.rating) <span class="hljs-keyword">as</span> avg_rating,
    <span class="hljs-keyword">COUNT</span>(r.review_id) <span class="hljs-keyword">as</span> review_count
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> reviews r <span class="hljs-keyword">ON</span> p.product_id = r.product_id
<span class="hljs-keyword">WHERE</span> p.product_name <span class="hljs-keyword">ILIKE</span> <span class="hljs-string">'%laptop%'</span>
  <span class="hljs-keyword">AND</span> p.status = <span class="hljs-string">'active'</span>
  <span class="hljs-keyword">AND</span> p.price <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">500</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">2000</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> p.product_id, p.product_name, p.price, c.category_name
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">AVG</span>(r.rating) &gt;= <span class="hljs-number">4.0</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> avg_rating <span class="hljs-keyword">DESC</span>, review_count <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;

<span class="hljs-comment">-- Optimization steps:</span>

<span class="hljs-comment">-- 1. Create appropriate indexes</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_products_status_price <span class="hljs-keyword">ON</span> products(<span class="hljs-keyword">status</span>, price);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_products_name_gin <span class="hljs-keyword">ON</span> products <span class="hljs-keyword">USING</span> GIN(to_tsvector(<span class="hljs-string">'english'</span>, product_name));  <span class="hljs-comment">-- PostgreSQL</span>
<span class="hljs-keyword">CREATE</span> FULLTEXT <span class="hljs-keyword">INDEX</span> idx_products_name_fulltext <span class="hljs-keyword">ON</span> products(product_name);  <span class="hljs-comment">-- MySQL</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_reviews_product_rating <span class="hljs-keyword">ON</span> reviews(product_id, rating);

<span class="hljs-comment">-- 2. Optimized query with better structure</span>
<span class="hljs-keyword">WITH</span> product_search <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        p.product_id,
        p.product_name,
        p.price,
        c.category_name
    <span class="hljs-keyword">FROM</span> products p
    <span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
    <span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
      <span class="hljs-keyword">AND</span> p.price <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">500</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">2000</span>
      <span class="hljs-keyword">AND</span> (
          <span class="hljs-comment">-- PostgreSQL full-text search</span>
          to_tsvector(<span class="hljs-string">'english'</span>, p.product_name) @@ to_tsquery(<span class="hljs-string">'english'</span>, <span class="hljs-string">'laptop'</span>)
          <span class="hljs-comment">-- OR MySQL full-text search</span>
          <span class="hljs-comment">-- MATCH(p.product_name) AGAINST('laptop' IN NATURAL LANGUAGE MODE)</span>
      )
),
product_ratings <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        product_id,
        <span class="hljs-keyword">AVG</span>(rating) <span class="hljs-keyword">as</span> avg_rating,
        <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> review_count
    <span class="hljs-keyword">FROM</span> reviews
    <span class="hljs-keyword">WHERE</span> product_id <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> product_id <span class="hljs-keyword">FROM</span> product_search)
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> product_id
    <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">AVG</span>(rating) &gt;= <span class="hljs-number">4.0</span>
)
<span class="hljs-keyword">SELECT</span>
    ps.product_id,
    ps.product_name,
    ps.price,
    ps.category_name,
    <span class="hljs-keyword">COALESCE</span>(pr.avg_rating, <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> avg_rating,
    <span class="hljs-keyword">COALESCE</span>(pr.review_count, <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> review_count
<span class="hljs-keyword">FROM</span> product_search ps
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> product_ratings pr <span class="hljs-keyword">ON</span> ps.product_id = pr.product_id
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> pr.avg_rating <span class="hljs-keyword">DESC</span> <span class="hljs-keyword">NULLS</span> <span class="hljs-keyword">LAST</span>, pr.review_count <span class="hljs-keyword">DESC</span> <span class="hljs-keyword">NULLS</span> <span class="hljs-keyword">LAST</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;
</div></code></pre>
<h3 id="example-2-customer-analytics-dashboard-optimization">Example 2: Customer Analytics Dashboard Optimization</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Slow customer analytics query</span>
<span class="hljs-comment">-- Original query taking 30+ seconds</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email,
    <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">as</span> total_orders,
    <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">as</span> total_spent,
    <span class="hljs-keyword">AVG</span>(o.total_amount) <span class="hljs-keyword">as</span> avg_order_value,
    <span class="hljs-keyword">MAX</span>(o.order_date) <span class="hljs-keyword">as</span> last_order_date,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> o.order_date)) <span class="hljs-keyword">as</span> active_months
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
  <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
  <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
<span class="hljs-keyword">WHERE</span> c.status = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name, c.email
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_spent <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Optimization approach:</span>

<span class="hljs-comment">-- 1. Create materialized view or summary table (PostgreSQL)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">MATERIALIZED</span> <span class="hljs-keyword">VIEW</span> customer_analytics_12m <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email,
    c.status,
    <span class="hljs-keyword">COALESCE</span>(order_stats.total_orders, <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> total_orders,
    <span class="hljs-keyword">COALESCE</span>(order_stats.total_spent, <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> total_spent,
    <span class="hljs-keyword">COALESCE</span>(order_stats.avg_order_value, <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> avg_order_value,
    order_stats.last_order_date,
    <span class="hljs-keyword">COALESCE</span>(order_stats.active_months, <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> active_months,
    <span class="hljs-keyword">CURRENT_DATE</span> <span class="hljs-keyword">as</span> last_updated
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span>
        customer_id,
        <span class="hljs-keyword">COUNT</span>(order_id) <span class="hljs-keyword">as</span> total_orders,
        <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">as</span> total_spent,
        <span class="hljs-keyword">AVG</span>(total_amount) <span class="hljs-keyword">as</span> avg_order_value,
        <span class="hljs-keyword">MAX</span>(order_date) <span class="hljs-keyword">as</span> last_order_date,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> order_date)) <span class="hljs-keyword">as</span> active_months
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
      <span class="hljs-keyword">AND</span> order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id
) order_stats <span class="hljs-keyword">ON</span> c.customer_id = order_stats.customer_id;

<span class="hljs-comment">-- Create index on materialized view</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_customer_analytics_spent <span class="hljs-keyword">ON</span> customer_analytics_12m(total_spent <span class="hljs-keyword">DESC</span>);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_customer_analytics_orders <span class="hljs-keyword">ON</span> customer_analytics_12m(total_orders <span class="hljs-keyword">DESC</span>);

<span class="hljs-comment">-- Refresh materialized view (can be automated)</span>
REFRESH MATERIALIZED VIEW customer_analytics_12m;

<span class="hljs-comment">-- Fast query using materialized view</span>
<span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> customer_analytics_12m
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_spent <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">100</span>;

<span class="hljs-comment">-- 2. Alternative: Create summary table with triggers (MySQL/PostgreSQL)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customer_summary (
    customer_id <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    total_orders <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    total_spent <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    avg_order_value <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    last_order_date <span class="hljs-built_in">DATE</span>,
    active_months <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    last_updated <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- Create indexes</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_customer_summary_spent <span class="hljs-keyword">ON</span> customer_summary(total_spent <span class="hljs-keyword">DESC</span>);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_customer_summary_updated <span class="hljs-keyword">ON</span> customer_summary(last_updated);
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-use-cases--interview-tips">ğŸ¯ Use Cases &amp; Interview Tips</h2>
<h3 id="common-interview-questions">Common Interview Questions:</h3>
<ol>
<li>
<p><strong>&quot;How do you identify slow queries?&quot;</strong></p>
<ul>
<li>Enable slow query logs</li>
<li>Use performance monitoring tools</li>
<li>Analyze execution plans</li>
<li>Monitor database metrics</li>
</ul>
</li>
<li>
<p><strong>&quot;When would you use a composite index vs multiple single-column indexes?&quot;</strong></p>
<ul>
<li>Composite: When queries filter on multiple columns together</li>
<li>Single: When queries typically filter on one column at a time</li>
<li>Consider query patterns and selectivity</li>
</ul>
</li>
<li>
<p><strong>&quot;How do you decide which columns to include in a covering index?&quot;</strong></p>
<ul>
<li>Include frequently accessed columns in SELECT clause</li>
<li>Balance between query performance and index size</li>
<li>Consider update frequency of included columns</li>
</ul>
</li>
<li>
<p><strong>&quot;What's the difference between clustered and non-clustered indexes?&quot;</strong></p>
<ul>
<li>Clustered: Data pages stored in order of index key (one per table)</li>
<li>Non-clustered: Separate structure pointing to data pages</li>
<li>MySQL InnoDB: Primary key is clustered index</li>
</ul>
</li>
</ol>
<h3 id="performance-tuning-best-practices">Performance Tuning Best Practices:</h3>
<ol>
<li><strong>Start with proper indexing strategy</strong></li>
<li><strong>Monitor and analyze query patterns</strong></li>
<li><strong>Use appropriate data types</strong></li>
<li><strong>Normalize appropriately (don't over-normalize)</strong></li>
<li><strong>Consider partitioning for very large tables</strong></li>
<li><strong>Regular maintenance (ANALYZE, VACUUM, etc.)</strong></li>
</ol>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-things-to-watch-out-for">âš ï¸ Things to Watch Out For</h2>
<h3 id="1-over-indexing">1. <strong>Over-Indexing</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Too many indexes slow down writes</span>
<span class="hljs-comment">-- Don't create indexes for every possible query</span>

<span class="hljs-comment">-- Bad: Redundant indexes</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx1 <span class="hljs-keyword">ON</span> orders(customer_id);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx2 <span class="hljs-keyword">ON</span> orders(customer_id, order_date);  <span class="hljs-comment">-- idx1 is redundant</span>

<span class="hljs-comment">-- Good: Use composite index that serves multiple purposes</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_orders_customer_date <span class="hljs-keyword">ON</span> orders(customer_id, order_date);
</div></code></pre>
<h3 id="2-wrong-column-order-in-composite-indexes">2. <strong>Wrong Column Order in Composite Indexes</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Bad: Low selectivity column first</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_bad <span class="hljs-keyword">ON</span> orders(<span class="hljs-keyword">status</span>, customer_id);  <span class="hljs-comment">-- status has few values</span>

<span class="hljs-comment">-- Good: High selectivity column first</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_good <span class="hljs-keyword">ON</span> orders(customer_id, <span class="hljs-keyword">status</span>);  <span class="hljs-comment">-- customer_id is more selective</span>
</div></code></pre>
<h3 id="3-ignoring-index-maintenance">3. <strong>Ignoring Index Maintenance</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- PostgreSQL: Regular maintenance</span>
<span class="hljs-keyword">ANALYZE</span>;  <span class="hljs-comment">-- Update statistics</span>
VACUUM;   <span class="hljs-comment">-- Reclaim space</span>
REINDEX;  <span class="hljs-comment">-- Rebuild indexes if needed</span>

<span class="hljs-comment">-- MySQL: Regular maintenance</span>
<span class="hljs-keyword">ANALYZE</span> <span class="hljs-keyword">TABLE</span> orders;
<span class="hljs-keyword">OPTIMIZE</span> <span class="hljs-keyword">TABLE</span> orders;  <span class="hljs-comment">-- For MyISAM tables</span>
</div></code></pre>
<h3 id="4-not-considering-query-patterns">4. <strong>Not Considering Query Patterns</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- If most queries are:</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> customer_id = ? <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>;

<span class="hljs-comment">-- Create index matching the query pattern:</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_orders_customer_status <span class="hljs-keyword">ON</span> orders(customer_id, <span class="hljs-keyword">status</span>);

<span class="hljs-comment">-- Not:</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_orders_status_customer <span class="hljs-keyword">ON</span> orders(<span class="hljs-keyword">status</span>, customer_id);
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%80-next-steps">ğŸš€ Next Steps</h2>
<p>In the next chapter, we'll explore <strong>Stored Procedures and Functions</strong> - reusable code blocks that can encapsulate business logic, improve performance, and provide better security. You'll learn how to create, manage, and optimize stored procedures and functions.</p>
<hr>
<h2 id="%F0%9F%93%9D-quick-practice">ğŸ“ Quick Practice</h2>
<p>Try these optimization exercises:</p>
<ol>
<li><strong>Index Analysis</strong>: Analyze a slow query and create appropriate indexes</li>
<li><strong>Execution Plans</strong>: Compare execution plans before and after optimization</li>
<li><strong>Composite Indexes</strong>: Design optimal composite indexes for complex queries</li>
<li><strong>Performance Monitoring</strong>: Set up monitoring for index usage and query performance</li>
<li><strong>Real-world Scenario</strong>: Optimize a dashboard query that aggregates large amounts of data</li>
</ol>
<p>Consider:</p>
<ul>
<li>Query patterns and frequency</li>
<li>Index maintenance overhead</li>
<li>Storage space vs. performance trade-offs</li>
<li>Different optimization strategies for OLTP vs. OLAP workloads</li>
</ul>
<h1 id="chapter-12-stored-procedures-and-functions">Chapter 12: Stored Procedures and Functions</h1>
<h2 id="%F0%9F%93%9A-what-youll-learn">ğŸ“š What You'll Learn</h2>
<p>Stored procedures and functions are reusable code blocks stored in the database that can encapsulate business logic, improve performance, and enhance security. This chapter covers how to create, manage, and optimize stored procedures and functions in both MySQL and PostgreSQL.</p>
<hr>
<h2 id="%F0%9F%8E%AF-learning-objectives">ğŸ¯ Learning Objectives</h2>
<p>By the end of this chapter, you will:</p>
<ul>
<li>Understand the difference between stored procedures and functions</li>
<li>Create and manage stored procedures and functions</li>
<li>Use parameters, variables, and control structures</li>
<li>Handle exceptions and errors</li>
<li>Implement business logic in the database layer</li>
<li>Understand security and performance implications</li>
</ul>
<hr>
<h2 id="%F0%9F%94%8D-concept-explanation">ğŸ” Concept Explanation</h2>
<h3 id="stored-procedures-vs-functions">Stored Procedures vs Functions</h3>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Stored Procedure</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Return Value</strong></td>
<td>Optional (via OUT parameters)</td>
<td>Must return a value</td>
</tr>
<tr>
<td><strong>Usage</strong></td>
<td>Called with CALL statement</td>
<td>Used in SELECT, WHERE, etc.</td>
</tr>
<tr>
<td><strong>Side Effects</strong></td>
<td>Can modify data</td>
<td>Should be read-only (best practice)</td>
</tr>
<tr>
<td><strong>Transaction Control</strong></td>
<td>Can use COMMIT/ROLLBACK</td>
<td>Limited transaction control</td>
</tr>
<tr>
<td><strong>Parameters</strong></td>
<td>IN, OUT, INOUT</td>
<td>IN parameters only (usually)</td>
</tr>
</tbody>
</table>
<h3 id="benefits">Benefits:</h3>
<ul>
<li><strong>Performance</strong>: Compiled once, executed many times</li>
<li><strong>Security</strong>: Controlled data access, SQL injection prevention</li>
<li><strong>Maintainability</strong>: Centralized business logic</li>
<li><strong>Network Traffic</strong>: Reduced client-server communication</li>
<li><strong>Consistency</strong>: Standardized operations across applications</li>
</ul>
<hr>
<h2 id="%F0%9F%9B%A0%EF%B8%8F-syntax-comparison">ğŸ› ï¸ Syntax Comparison</h2>
<h3 id="mysql-vs-postgresql-differences">MySQL vs PostgreSQL Differences</h3>
<table>
<thead>
<tr>
<th>Feature</th>
<th>MySQL</th>
<th>PostgreSQL</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Language</strong></td>
<td>SQL, limited procedural</td>
<td>SQL, PL/pgSQL, Python, etc.</td>
</tr>
<tr>
<td><strong>Function Types</strong></td>
<td>Limited</td>
<td>Scalar, Table, Aggregate</td>
</tr>
<tr>
<td><strong>Exception Handling</strong></td>
<td>DECLARE HANDLER</td>
<td>BEGIN/EXCEPTION blocks</td>
</tr>
<tr>
<td><strong>Cursors</strong></td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td><strong>Triggers</strong></td>
<td>âœ…</td>
<td>âœ… (more advanced)</td>
</tr>
<tr>
<td><strong>Packages</strong></td>
<td>âŒ</td>
<td>âœ… (Schemas)</td>
</tr>
<tr>
<td><strong>Overloading</strong></td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="%F0%9F%93%9D-basic-stored-procedures">ğŸ“ Basic Stored Procedures</h2>
<h3 id="mysql-stored-procedures">MySQL Stored Procedures</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Simple procedure without parameters</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> GetCustomerCount()
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> total_customers <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>;
<span class="hljs-keyword">END</span> //
DELIMITER ;

<span class="hljs-comment">-- Call the procedure</span>
<span class="hljs-keyword">CALL</span> GetCustomerCount();

<span class="hljs-comment">-- Procedure with IN parameters</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> GetCustomerOrders(
    <span class="hljs-keyword">IN</span> customer_id_param <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">IN</span> start_date <span class="hljs-built_in">DATE</span>,
    <span class="hljs-keyword">IN</span> end_date <span class="hljs-built_in">DATE</span>
)
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span>
        o.order_id,
        o.order_date,
        o.total_amount,
        o.status
    <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">WHERE</span> o.customer_id = customer_id_param
      <span class="hljs-keyword">AND</span> o.order_date <span class="hljs-keyword">BETWEEN</span> start_date <span class="hljs-keyword">AND</span> end_date
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> o.order_date <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span> //
DELIMITER ;

<span class="hljs-comment">-- Call with parameters</span>
<span class="hljs-keyword">CALL</span> GetCustomerOrders(<span class="hljs-number">123</span>, <span class="hljs-string">'2024-01-01'</span>, <span class="hljs-string">'2024-12-31'</span>);

<span class="hljs-comment">-- Procedure with OUT parameters</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> GetCustomerStats(
    <span class="hljs-keyword">IN</span> customer_id_param <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">OUT</span> total_orders <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">OUT</span> total_spent <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    <span class="hljs-keyword">OUT</span> avg_order_value <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
)
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span>
        <span class="hljs-keyword">COUNT</span>(order_id),
        <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(total_amount), <span class="hljs-number">0</span>),
        <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">AVG</span>(total_amount), <span class="hljs-number">0</span>)
    <span class="hljs-keyword">INTO</span> total_orders, total_spent, avg_order_value
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> customer_id = customer_id_param
      <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>;
<span class="hljs-keyword">END</span> //
DELIMITER ;

<span class="hljs-comment">-- Call and get output</span>
<span class="hljs-keyword">CALL</span> GetCustomerStats(<span class="hljs-number">123</span>, @orders, @spent, @<span class="hljs-keyword">avg</span>);
<span class="hljs-keyword">SELECT</span> @orders <span class="hljs-keyword">as</span> total_orders, @spent <span class="hljs-keyword">as</span> total_spent, @<span class="hljs-keyword">avg</span> <span class="hljs-keyword">as</span> avg_order_value;
</div></code></pre>
<h3 id="postgresql-stored-procedures">PostgreSQL Stored Procedures</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Simple procedure (PostgreSQL 11+)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">PROCEDURE</span> get_customer_count()
<span class="hljs-keyword">LANGUAGE</span> plpgsql
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">RAISE</span> <span class="hljs-keyword">NOTICE</span> <span class="hljs-string">'Total active customers: %'</span>, (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>);
<span class="hljs-keyword">END</span>;
$$;

<span class="hljs-comment">-- Call the procedure</span>
<span class="hljs-keyword">CALL</span> get_customer_count();

<span class="hljs-comment">-- Procedure with parameters</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">PROCEDURE</span> get_customer_orders(
    customer_id_param <span class="hljs-built_in">INT</span>,
    start_date <span class="hljs-built_in">DATE</span>,
    end_date <span class="hljs-built_in">DATE</span>
)
<span class="hljs-keyword">LANGUAGE</span> plpgsql
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    order_record <span class="hljs-built_in">RECORD</span>;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">FOR</span> order_record <span class="hljs-keyword">IN</span>
        <span class="hljs-keyword">SELECT</span>
            o.order_id,
            o.order_date,
            o.total_amount,
            o.status
        <span class="hljs-keyword">FROM</span> orders o
        <span class="hljs-keyword">WHERE</span> o.customer_id = customer_id_param
          <span class="hljs-keyword">AND</span> o.order_date <span class="hljs-keyword">BETWEEN</span> start_date <span class="hljs-keyword">AND</span> end_date
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> o.order_date <span class="hljs-keyword">DESC</span>
    <span class="hljs-keyword">LOOP</span>
        <span class="hljs-keyword">RAISE</span> <span class="hljs-keyword">NOTICE</span> <span class="hljs-string">'Order ID: %, Date: %, Amount: %'</span>,
            order_record.order_id,
            order_record.order_date,
            order_record.total_amount;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;
<span class="hljs-keyword">END</span>;
$$;

<span class="hljs-comment">-- Call with parameters</span>
<span class="hljs-keyword">CALL</span> get_customer_orders(<span class="hljs-number">123</span>, <span class="hljs-string">'2024-01-01'</span>, <span class="hljs-string">'2024-12-31'</span>);

<span class="hljs-comment">-- Procedure with INOUT parameters</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">PROCEDURE</span> get_customer_stats(
    INOUT customer_id_param <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">OUT</span> total_orders <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">OUT</span> total_spent <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    <span class="hljs-keyword">OUT</span> avg_order_value <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
)
<span class="hljs-keyword">LANGUAGE</span> plpgsql
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span>
        <span class="hljs-keyword">COUNT</span>(order_id),
        <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(total_amount), <span class="hljs-number">0</span>),
        <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">AVG</span>(total_amount), <span class="hljs-number">0</span>)
    <span class="hljs-keyword">INTO</span> total_orders, total_spent, avg_order_value
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> customer_id = customer_id_param
      <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>;
<span class="hljs-keyword">END</span>;
$$;

<span class="hljs-comment">-- Call and get output</span>
<span class="hljs-keyword">CALL</span> get_customer_stats(<span class="hljs-number">123</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%A7-functions">ğŸ”§ Functions</h2>
<h3 id="mysql-functions">MySQL Functions</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Scalar function</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> CalculateDiscount(
    order_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    customer_tier <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>)
) <span class="hljs-keyword">RETURNS</span> <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
<span class="hljs-keyword">READS</span> <span class="hljs-keyword">SQL</span> <span class="hljs-keyword">DATA</span>
<span class="hljs-keyword">DETERMINISTIC</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> discount_rate <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">5</span>,<span class="hljs-number">4</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>;

    CASE customer_tier
        WHEN 'VIP' THEN <span class="hljs-keyword">SET</span> discount_rate = <span class="hljs-number">0.15</span>;
        WHEN 'Premium' THEN <span class="hljs-keyword">SET</span> discount_rate = <span class="hljs-number">0.10</span>;
        WHEN 'Regular' THEN <span class="hljs-keyword">SET</span> discount_rate = <span class="hljs-number">0.05</span>;
        ELSE <span class="hljs-keyword">SET</span> discount_rate = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">CASE</span>;

    IF order_amount &gt;= 1000 THEN
        <span class="hljs-keyword">SET</span> discount_rate = discount_rate + <span class="hljs-number">0.05</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    RETURN order_amount * discount_rate;
<span class="hljs-keyword">END</span> //
DELIMITER ;

<span class="hljs-comment">-- Use the function</span>
<span class="hljs-keyword">SELECT</span>
    order_id,
    total_amount,
    CalculateDiscount(total_amount, <span class="hljs-string">'VIP'</span>) <span class="hljs-keyword">as</span> discount_amount,
    total_amount - CalculateDiscount(total_amount, <span class="hljs-string">'VIP'</span>) <span class="hljs-keyword">as</span> final_amount
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">123</span>;

<span class="hljs-comment">-- Function with complex logic</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> GetCustomerTier(
    customer_id_param <span class="hljs-built_in">INT</span>
) <span class="hljs-keyword">RETURNS</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>)
<span class="hljs-keyword">READS</span> <span class="hljs-keyword">SQL</span> <span class="hljs-keyword">DATA</span>
<span class="hljs-keyword">DETERMINISTIC</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> total_spent <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">DECLARE</span> order_count <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">DECLARE</span> <span class="hljs-keyword">tier</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'Basic'</span>;

    <span class="hljs-keyword">SELECT</span>
        <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(total_amount), <span class="hljs-number">0</span>),
        <span class="hljs-keyword">COUNT</span>(order_id)
    <span class="hljs-keyword">INTO</span> total_spent, order_count
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> customer_id = customer_id_param
      <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
      <span class="hljs-keyword">AND</span> order_date &gt;= <span class="hljs-keyword">DATE_SUB</span>(<span class="hljs-keyword">CURDATE</span>(), <span class="hljs-built_in">INTERVAL</span> <span class="hljs-number">12</span> <span class="hljs-keyword">MONTH</span>);

    IF total_spent &gt;= 5000 OR order_count &gt;= 20 THEN
        <span class="hljs-keyword">SET</span> <span class="hljs-keyword">tier</span> = <span class="hljs-string">'VIP'</span>;
    ELSEIF total_spent &gt;= 2000 OR order_count &gt;= 10 THEN
        <span class="hljs-keyword">SET</span> <span class="hljs-keyword">tier</span> = <span class="hljs-string">'Premium'</span>;
    ELSEIF total_spent &gt;= 500 OR order_count &gt;= 3 THEN
        <span class="hljs-keyword">SET</span> <span class="hljs-keyword">tier</span> = <span class="hljs-string">'Regular'</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    RETURN tier;
<span class="hljs-keyword">END</span> //
DELIMITER ;

<span class="hljs-comment">-- Use in queries</span>
<span class="hljs-keyword">SELECT</span>
    customer_id,
    first_name,
    last_name,
    GetCustomerTier(customer_id) <span class="hljs-keyword">as</span> <span class="hljs-keyword">tier</span>
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;
</div></code></pre>
<h3 id="postgresql-functions">PostgreSQL Functions</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Scalar function</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> calculate_discount(
    order_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    customer_tier <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>)
) <span class="hljs-keyword">RETURNS</span> <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
<span class="hljs-keyword">LANGUAGE</span> plpgsql
IMMUTABLE
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    discount_rate <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">5</span>,<span class="hljs-number">4</span>) := <span class="hljs-number">0</span>;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">CASE</span> customer_tier
        <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'VIP'</span> <span class="hljs-keyword">THEN</span> discount_rate := <span class="hljs-number">0.15</span>;
        WHEN 'Premium' THEN discount_rate := 0.10;
        WHEN 'Regular' THEN discount_rate := 0.05;
        ELSE discount_rate := 0;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">CASE</span>;

    IF order_amount &gt;= 1000 THEN
        discount_rate := discount_rate + 0.05;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    RETURN order_amount * discount_rate;
<span class="hljs-keyword">END</span>;
$$;

<span class="hljs-comment">-- Use the function</span>
<span class="hljs-keyword">SELECT</span>
    order_id,
    total_amount,
    calculate_discount(total_amount, <span class="hljs-string">'VIP'</span>) <span class="hljs-keyword">as</span> discount_amount,
    total_amount - calculate_discount(total_amount, <span class="hljs-string">'VIP'</span>) <span class="hljs-keyword">as</span> final_amount
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">123</span>;

<span class="hljs-comment">-- Table-valued function</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> get_top_customers(
    limit_count <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">10</span>
) <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TABLE</span>(
    customer_id <span class="hljs-built_in">INT</span>,
    full_name <span class="hljs-built_in">TEXT</span>,
    total_orders <span class="hljs-built_in">BIGINT</span>,
    total_spent <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    avg_order_value <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
)
<span class="hljs-keyword">LANGUAGE</span> plpgsql
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">RETURN</span> <span class="hljs-keyword">QUERY</span>
    <span class="hljs-keyword">SELECT</span>
        c.customer_id,
        c.first_name || <span class="hljs-string">' '</span> || c.last_name <span class="hljs-keyword">as</span> full_name,
        <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">as</span> total_orders,
        <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(o.total_amount), <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> total_spent,
        <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">AVG</span>(o.total_amount), <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> avg_order_value
    <span class="hljs-keyword">FROM</span> customers c
    <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
        <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
        <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
    <span class="hljs-keyword">WHERE</span> c.status = <span class="hljs-string">'active'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_spent <span class="hljs-keyword">DESC</span>
    <span class="hljs-keyword">LIMIT</span> limit_count;
<span class="hljs-keyword">END</span>;
$$;

<span class="hljs-comment">-- Use table-valued function</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> get_top_customers(<span class="hljs-number">5</span>);

<span class="hljs-comment">-- Function with complex return type</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TYPE</span> customer_summary <span class="hljs-keyword">AS</span> (
    customer_id <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">tier</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    total_spent <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    order_count <span class="hljs-built_in">INT</span>,
    last_order_date <span class="hljs-built_in">DATE</span>
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> get_customer_summary(
    customer_id_param <span class="hljs-built_in">INT</span>
) <span class="hljs-keyword">RETURNS</span> customer_summary
<span class="hljs-keyword">LANGUAGE</span> plpgsql
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    <span class="hljs-keyword">result</span> customer_summary;
    total_spent DECIMAL(10,2);
    order_count INT;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span>
        <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(total_amount), <span class="hljs-number">0</span>),
        <span class="hljs-keyword">COUNT</span>(order_id),
        <span class="hljs-keyword">MAX</span>(order_date)
    <span class="hljs-keyword">INTO</span> total_spent, order_count, result.last_order_date
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> customer_id = customer_id_param
      <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
      <span class="hljs-keyword">AND</span> order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>;

    result.customer_id := customer_id_param;
    result.total_spent := total_spent;
    result.order_count := order_count;

    <span class="hljs-comment">-- Determine tier</span>
    IF total_spent &gt;= 5000 OR order_count &gt;= 20 THEN
        result.tier := 'VIP';
    ELSIF total_spent &gt;= 2000 OR order_count &gt;= 10 THEN
        result.tier := 'Premium';
    ELSIF total_spent &gt;= 500 OR order_count &gt;= 3 THEN
        result.tier := 'Regular';
    ELSE
        result.tier := 'Basic';
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    RETURN result;
<span class="hljs-keyword">END</span>;
$$;

<span class="hljs-comment">-- Use complex function</span>
<span class="hljs-keyword">SELECT</span> (get_customer_summary(<span class="hljs-number">123</span>)).*;
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%84-control-structures">ğŸ”„ Control Structures</h2>
<h3 id="conditional-logic">Conditional Logic</h3>
<p><strong>MySQL:</strong></p>
<pre class="hljs"><code><div>DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> ProcessOrder(
    <span class="hljs-keyword">IN</span> order_id_param <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">OUT</span> result_message <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>)
)
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> order_status <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>);
    <span class="hljs-keyword">DECLARE</span> order_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>);
    <span class="hljs-keyword">DECLARE</span> customer_credit <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>);

    <span class="hljs-comment">-- Get order details</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">status</span>, total_amount <span class="hljs-keyword">INTO</span> order_status, order_amount
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> order_id = order_id_param;

    <span class="hljs-comment">-- Check if order exists</span>
    IF order_status IS NULL THEN
        <span class="hljs-keyword">SET</span> result_message = <span class="hljs-string">'Order not found'</span>;
    ELSEIF order_status != 'pending' THEN
        <span class="hljs-keyword">SET</span> result_message = <span class="hljs-string">'Order already processed'</span>;
    ELSE
        <span class="hljs-comment">-- Get customer credit</span>
        <span class="hljs-keyword">SELECT</span> credit_limit <span class="hljs-keyword">INTO</span> customer_credit
        <span class="hljs-keyword">FROM</span> customers c
        <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
        <span class="hljs-keyword">WHERE</span> o.order_id = order_id_param;

        IF order_amount &lt;= customer_credit THEN
            <span class="hljs-keyword">UPDATE</span> orders <span class="hljs-keyword">SET</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'approved'</span> <span class="hljs-keyword">WHERE</span> order_id = order_id_param;
            <span class="hljs-keyword">SET</span> result_message = <span class="hljs-string">'Order approved'</span>;
        ELSE
            <span class="hljs-keyword">UPDATE</span> orders <span class="hljs-keyword">SET</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'rejected'</span> <span class="hljs-keyword">WHERE</span> order_id = order_id_param;
            <span class="hljs-keyword">SET</span> result_message = <span class="hljs-string">'Order rejected - insufficient credit'</span>;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
<span class="hljs-keyword">END</span> //
DELIMITER ;
</div></code></pre>
<p><strong>PostgreSQL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> process_order(
    order_id_param <span class="hljs-built_in">INT</span>
) <span class="hljs-keyword">RETURNS</span> <span class="hljs-built_in">TEXT</span>
<span class="hljs-keyword">LANGUAGE</span> plpgsql
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    order_status <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>);
    order_amount DECIMAL(10,2);
    customer_credit DECIMAL(10,2);
    result_message TEXT;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- Get order details</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">status</span>, total_amount <span class="hljs-keyword">INTO</span> order_status, order_amount
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> order_id = order_id_param;

    <span class="hljs-comment">-- Check if order exists</span>
    IF NOT FOUND THEN
        RETURN 'Order not found';
    ELSIF order_status != 'pending' THEN
        RETURN 'Order already processed';
    ELSE
        <span class="hljs-comment">-- Get customer credit</span>
        <span class="hljs-keyword">SELECT</span> c.credit_limit <span class="hljs-keyword">INTO</span> customer_credit
        <span class="hljs-keyword">FROM</span> customers c
        <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id
        <span class="hljs-keyword">WHERE</span> o.order_id = order_id_param;

        IF order_amount &lt;= customer_credit THEN
            <span class="hljs-keyword">UPDATE</span> orders <span class="hljs-keyword">SET</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'approved'</span> <span class="hljs-keyword">WHERE</span> order_id = order_id_param;
            result_message := 'Order approved';
        ELSE
            <span class="hljs-keyword">UPDATE</span> orders <span class="hljs-keyword">SET</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'rejected'</span> <span class="hljs-keyword">WHERE</span> order_id = order_id_param;
            result_message := 'Order rejected - insufficient credit';
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    RETURN result_message;
<span class="hljs-keyword">END</span>;
$$;
</div></code></pre>
<h3 id="loops">Loops</h3>
<p><strong>MySQL:</strong></p>
<pre class="hljs"><code><div>DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> GenerateMonthlyReport(
    <span class="hljs-keyword">IN</span> year_param <span class="hljs-built_in">INT</span>
)
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> month_counter <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">DECLARE</span> monthly_revenue <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>);

    <span class="hljs-comment">-- Create temporary table for results</span>
    <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> monthly_report (
        month_num <span class="hljs-built_in">INT</span>,
        month_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
        revenue <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
    );

    <span class="hljs-comment">-- Clear previous data</span>
    <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> monthly_report;

    WHILE month_counter &lt;= 12 <span class="hljs-keyword">DO</span>
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(total_amount), <span class="hljs-number">0</span>) <span class="hljs-keyword">INTO</span> monthly_revenue
        <span class="hljs-keyword">FROM</span> orders
        <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">YEAR</span>(order_date) = year_param
          <span class="hljs-keyword">AND</span> <span class="hljs-keyword">MONTH</span>(order_date) = month_counter
          <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>;

        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> monthly_report <span class="hljs-keyword">VALUES</span> (
            month_counter,
            MONTHNAME(<span class="hljs-keyword">STR_TO_DATE</span>(month_counter, <span class="hljs-string">'%m'</span>)),
            monthly_revenue
        );

        <span class="hljs-keyword">SET</span> month_counter = month_counter + <span class="hljs-number">1</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">WHILE</span>;

    <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> monthly_report <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> month_num;
<span class="hljs-keyword">END</span> //
DELIMITER ;
</div></code></pre>
<p><strong>PostgreSQL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> generate_monthly_report(
    year_param <span class="hljs-built_in">INT</span>
) <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TABLE</span>(
    month_num <span class="hljs-built_in">INT</span>,
    month_name <span class="hljs-built_in">TEXT</span>,
    revenue <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
)
<span class="hljs-keyword">LANGUAGE</span> plpgsql
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    month_counter <span class="hljs-built_in">INT</span>;
    monthly_revenue DECIMAL(10,2);
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">FOR</span> month_counter <span class="hljs-keyword">IN</span> <span class="hljs-number">1.</span><span class="hljs-number">.12</span> <span class="hljs-keyword">LOOP</span>
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(total_amount), <span class="hljs-number">0</span>) <span class="hljs-keyword">INTO</span> monthly_revenue
        <span class="hljs-keyword">FROM</span> orders
        <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> order_date) = year_param
          <span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> order_date) = month_counter
          <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>;

        month_num := month_counter;
        month_name := TO_CHAR(TO_DATE(month_counter::TEXT, 'MM'), 'Month');
        revenue := monthly_revenue;

        RETURN NEXT;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;
<span class="hljs-keyword">END</span>;
$$;

<span class="hljs-comment">-- Use the function</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> generate_monthly_report(<span class="hljs-number">2024</span>);
</div></code></pre>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-error-handling">âš ï¸ Error Handling</h2>
<h3 id="mysql-error-handling">MySQL Error Handling</h3>
<pre class="hljs"><code><div>DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> SafeTransferFunds(
    <span class="hljs-keyword">IN</span> from_account <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">IN</span> to_account <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">IN</span> amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    <span class="hljs-keyword">OUT</span> result_message <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>)
)
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> account_balance <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>);
    <span class="hljs-keyword">DECLARE</span> exit_handler_called <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>;

    <span class="hljs-comment">-- Error handlers</span>
    <span class="hljs-keyword">DECLARE</span> CONTINUE <span class="hljs-keyword">HANDLER</span> <span class="hljs-keyword">FOR</span> SQLEXCEPTION
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">SET</span> exit_handler_called = <span class="hljs-literal">TRUE</span>;
        <span class="hljs-keyword">ROLLBACK</span>;
        <span class="hljs-keyword">SET</span> result_message = <span class="hljs-string">'Transaction failed due to error'</span>;
    <span class="hljs-keyword">END</span>;

    <span class="hljs-keyword">DECLARE</span> CONTINUE <span class="hljs-keyword">HANDLER</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">FOUND</span>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">SET</span> exit_handler_called = <span class="hljs-literal">TRUE</span>;
        <span class="hljs-keyword">ROLLBACK</span>;
        <span class="hljs-keyword">SET</span> result_message = <span class="hljs-string">'Account not found'</span>;
    <span class="hljs-keyword">END</span>;

    <span class="hljs-keyword">START</span> <span class="hljs-keyword">TRANSACTION</span>;

    <span class="hljs-comment">-- Check source account balance</span>
    <span class="hljs-keyword">SELECT</span> balance <span class="hljs-keyword">INTO</span> account_balance
    <span class="hljs-keyword">FROM</span> accounts
    <span class="hljs-keyword">WHERE</span> account_id = from_account
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;

    IF exit_handler_called THEN
        LEAVE;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    IF account_balance &lt; amount THEN
        <span class="hljs-keyword">ROLLBACK</span>;
        <span class="hljs-keyword">SET</span> result_message = <span class="hljs-string">'Insufficient funds'</span>;
    ELSE
        <span class="hljs-comment">-- Debit source account</span>
        <span class="hljs-keyword">UPDATE</span> accounts
        <span class="hljs-keyword">SET</span> balance = balance - amount
        <span class="hljs-keyword">WHERE</span> account_id = from_account;

        <span class="hljs-comment">-- Credit destination account</span>
        <span class="hljs-keyword">UPDATE</span> accounts
        <span class="hljs-keyword">SET</span> balance = balance + amount
        <span class="hljs-keyword">WHERE</span> account_id = to_account;

        IF exit_handler_called THEN
            LEAVE;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-keyword">COMMIT</span>;
        <span class="hljs-keyword">SET</span> result_message = <span class="hljs-string">'Transfer completed successfully'</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
<span class="hljs-keyword">END</span> //
DELIMITER ;
</div></code></pre>
<h3 id="postgresql-error-handling">PostgreSQL Error Handling</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> safe_transfer_funds(
    from_account <span class="hljs-built_in">INT</span>,
    to_account <span class="hljs-built_in">INT</span>,
    amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
) <span class="hljs-keyword">RETURNS</span> <span class="hljs-built_in">TEXT</span>
<span class="hljs-keyword">LANGUAGE</span> plpgsql
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    account_balance <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>);
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-comment">-- Check source account balance</span>
        <span class="hljs-keyword">SELECT</span> balance <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">STRICT</span> account_balance
        <span class="hljs-keyword">FROM</span> accounts
        <span class="hljs-keyword">WHERE</span> account_id = from_account
        <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;

        IF account_balance &lt; amount THEN
            RETURN 'Insufficient funds';
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-comment">-- Debit source account</span>
        <span class="hljs-keyword">UPDATE</span> accounts
        <span class="hljs-keyword">SET</span> balance = balance - amount
        <span class="hljs-keyword">WHERE</span> account_id = from_account;

        <span class="hljs-comment">-- Credit destination account</span>
        <span class="hljs-keyword">UPDATE</span> accounts
        <span class="hljs-keyword">SET</span> balance = balance + amount
        <span class="hljs-keyword">WHERE</span> account_id = to_account;

        IF NOT FOUND THEN
            RAISE EXCEPTION 'Destination account not found';
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        RETURN 'Transfer completed successfully';

    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            RETURN 'Source account not found';
        WHEN TOO_MANY_ROWS THEN
            RETURN 'Multiple accounts found - data integrity issue';
        WHEN OTHERS THEN
            RETURN 'Transaction failed: ' || SQLERRM;
    <span class="hljs-keyword">END</span>;
<span class="hljs-keyword">END</span>;
$$;
</div></code></pre>
<hr>
<h2 id="%F0%9F%92%A1-real-world-business-examples">ğŸ’¡ Real-World Business Examples</h2>
<h3 id="example-1-e-commerce-order-processing-system">Example 1: E-commerce Order Processing System</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- PostgreSQL comprehensive order processing</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> process_ecommerce_order(
    customer_id_param <span class="hljs-built_in">INT</span>,
    items JSONB,  <span class="hljs-comment">-- [{"product_id": 1, "quantity": 2, "unit_price": 29.99}, ...]</span>
    shipping_address JSONB,
    payment_method <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>)
) <span class="hljs-keyword">RETURNS</span> JSONB
<span class="hljs-keyword">LANGUAGE</span> plpgsql
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    new_order_id <span class="hljs-built_in">INT</span>;
    item JSONB;
    product_stock INT;
    order_total DECIMAL(10,2) := 0;
    tax_amount DECIMAL(10,2);
    shipping_cost DECIMAL(10,2) := 9.99;
    customer_tier VARCHAR(20);
    discount_amount DECIMAL(10,2) := 0;
    result JSONB;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- Validate customer</span>
    <span class="hljs-keyword">SELECT</span> get_customer_tier(customer_id_param) <span class="hljs-keyword">INTO</span> customer_tier;

    IF customer_tier IS NULL THEN
        RETURN jsonb_build_object(
            'success', false,
            'error', 'Invalid customer ID'
        );
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-comment">-- Create order</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (customer_id, order_date, <span class="hljs-keyword">status</span>, shipping_address, payment_method)
        <span class="hljs-keyword">VALUES</span> (customer_id_param, <span class="hljs-keyword">CURRENT_TIMESTAMP</span>, <span class="hljs-string">'pending'</span>, shipping_address, payment_method)
        <span class="hljs-keyword">RETURNING</span> order_id <span class="hljs-keyword">INTO</span> new_order_id;

        <span class="hljs-comment">-- Process each item</span>
        FOR item IN <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> jsonb_array_elements(items)
        <span class="hljs-keyword">LOOP</span>
            <span class="hljs-comment">-- Check stock</span>
            <span class="hljs-keyword">SELECT</span> stock_quantity <span class="hljs-keyword">INTO</span> product_stock
            <span class="hljs-keyword">FROM</span> products
            <span class="hljs-keyword">WHERE</span> product_id = (item-&gt;&gt;<span class="hljs-string">'product_id'</span>)::<span class="hljs-built_in">INT</span>
              <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>
            <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;

            IF NOT FOUND THEN
                RAISE EXCEPTION 'Product % not found or inactive', item-&gt;&gt;'product_id';
            <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

            IF product_stock &lt; (item-&gt;&gt;'quantity')::INT THEN
                RAISE EXCEPTION 'Insufficient stock for product %. Available: %, Requested: %',
                    item-&gt;&gt;'product_id', product_stock, item-&gt;&gt;'quantity';
            <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

            <span class="hljs-comment">-- Add order item</span>
            <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> order_items (order_id, product_id, quantity, unit_price)
            <span class="hljs-keyword">VALUES</span> (
                new_order_id,
                (item-&gt;&gt;<span class="hljs-string">'product_id'</span>)::<span class="hljs-built_in">INT</span>,
                (item-&gt;&gt;<span class="hljs-string">'quantity'</span>)::<span class="hljs-built_in">INT</span>,
                (item-&gt;&gt;<span class="hljs-string">'unit_price'</span>)::<span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
            );

            <span class="hljs-comment">-- Update stock</span>
            <span class="hljs-keyword">UPDATE</span> products
            <span class="hljs-keyword">SET</span> stock_quantity = stock_quantity - (item-&gt;&gt;<span class="hljs-string">'quantity'</span>)::<span class="hljs-built_in">INT</span>
            <span class="hljs-keyword">WHERE</span> product_id = (item-&gt;&gt;<span class="hljs-string">'product_id'</span>)::<span class="hljs-built_in">INT</span>;

            <span class="hljs-comment">-- Add to order total</span>
            order_total := order_total + ((item-&gt;&gt;'quantity')::INT * (item-&gt;&gt;'unit_price')::DECIMAL(10,2));
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;

        <span class="hljs-comment">-- Calculate discount</span>
        discount_amount := calculate_discount(order_total, customer_tier);

        <span class="hljs-comment">-- Calculate tax (8.5%)</span>
        tax_amount := (order_total - discount_amount) * 0.085;

        <span class="hljs-comment">-- Free shipping for orders over $100 or VIP customers</span>
        IF order_total &gt;= 100 OR customer_tier = 'VIP' THEN
            shipping_cost := 0;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-comment">-- Update order totals</span>
        <span class="hljs-keyword">UPDATE</span> orders
        <span class="hljs-keyword">SET</span>
            subtotal = order_total,
            discount_amount = discount_amount,
            tax_amount = tax_amount,
            shipping_cost = shipping_cost,
            total_amount = order_total - discount_amount + tax_amount + shipping_cost,
            <span class="hljs-keyword">status</span> = <span class="hljs-string">'confirmed'</span>
        <span class="hljs-keyword">WHERE</span> order_id = new_order_id;

        <span class="hljs-comment">-- Return success result</span>
        result := jsonb_build_object(
            'success', true,
            'order_id', new_order_id,
            'subtotal', order_total,
            'discount', discount_amount,
            'tax', tax_amount,
            'shipping', shipping_cost,
            'total', order_total - discount_amount + tax_amount + shipping_cost,
            'customer_tier', customer_tier
        );

        RETURN result;

    EXCEPTION
        WHEN OTHERS THEN
            <span class="hljs-comment">-- Rollback is automatic in PostgreSQL functions</span>
            RETURN jsonb_build_object(
                'success', false,
                'error', SQLERRM
            );
    <span class="hljs-keyword">END</span>;
<span class="hljs-keyword">END</span>;
$$;

<span class="hljs-comment">-- Usage example</span>
<span class="hljs-keyword">SELECT</span> process_ecommerce_order(
    <span class="hljs-number">123</span>,  <span class="hljs-comment">-- customer_id</span>
    <span class="hljs-string">'[{"product_id": 1, "quantity": 2, "unit_price": 29.99},
      {"product_id": 5, "quantity": 1, "unit_price": 149.99}]'</span>::jsonb,
    <span class="hljs-string">'{"street": "123 Main St", "city": "Anytown", "state": "CA", "zip": "12345"}'</span>::jsonb,
    <span class="hljs-string">'credit_card'</span>
);
</div></code></pre>
<h3 id="example-2-customer-analytics-and-segmentation">Example 2: Customer Analytics and Segmentation</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL customer analytics procedure</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> AnalyzeCustomerSegments(
    <span class="hljs-keyword">IN</span> analysis_date <span class="hljs-built_in">DATE</span>
)
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> done <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>;
    <span class="hljs-keyword">DECLARE</span> customer_id_var <span class="hljs-built_in">INT</span>;
    <span class="hljs-keyword">DECLARE</span> total_spent <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>);
    <span class="hljs-keyword">DECLARE</span> order_count <span class="hljs-built_in">INT</span>;
    <span class="hljs-keyword">DECLARE</span> avg_order_value <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>);
    <span class="hljs-keyword">DECLARE</span> last_order_date <span class="hljs-built_in">DATE</span>;
    <span class="hljs-keyword">DECLARE</span> days_since_last_order <span class="hljs-built_in">INT</span>;
    <span class="hljs-keyword">DECLARE</span> customer_tier <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>);
    <span class="hljs-keyword">DECLARE</span> lifecycle_stage <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>);
    <span class="hljs-keyword">DECLARE</span> churn_risk <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>);

    <span class="hljs-comment">-- Cursor for active customers</span>
    <span class="hljs-keyword">DECLARE</span> customer_cursor <span class="hljs-keyword">CURSOR</span> <span class="hljs-keyword">FOR</span>
        <span class="hljs-keyword">SELECT</span> customer_id <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>;

    <span class="hljs-keyword">DECLARE</span> CONTINUE <span class="hljs-keyword">HANDLER</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">FOUND</span> <span class="hljs-keyword">SET</span> done = <span class="hljs-literal">TRUE</span>;

    <span class="hljs-comment">-- Create or clear analytics table</span>
    <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> customer_analytics (
        customer_id <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
        analysis_date <span class="hljs-built_in">DATE</span>,
        total_spent <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
        order_count <span class="hljs-built_in">INT</span>,
        avg_order_value <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
        last_order_date <span class="hljs-built_in">DATE</span>,
        days_since_last_order <span class="hljs-built_in">INT</span>,
        customer_tier <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
        lifecycle_stage <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
        churn_risk <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
        created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
    );

    <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> customer_analytics <span class="hljs-keyword">WHERE</span> analysis_date = analysis_date;

    OPEN customer_cursor;

    customer_loop: LOOP
        FETCH customer_cursor INTO customer_id_var;

        IF done THEN
            LEAVE customer_loop;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-comment">-- Calculate customer metrics</span>
        <span class="hljs-keyword">SELECT</span>
            <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(total_amount), <span class="hljs-number">0</span>),
            <span class="hljs-keyword">COUNT</span>(order_id),
            <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">AVG</span>(total_amount), <span class="hljs-number">0</span>),
            <span class="hljs-keyword">MAX</span>(order_date)
        <span class="hljs-keyword">INTO</span> total_spent, order_count, avg_order_value, last_order_date
        <span class="hljs-keyword">FROM</span> orders
        <span class="hljs-keyword">WHERE</span> customer_id = customer_id_var
          <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
          <span class="hljs-keyword">AND</span> order_date &gt;= <span class="hljs-keyword">DATE_SUB</span>(analysis_date, <span class="hljs-built_in">INTERVAL</span> <span class="hljs-number">12</span> <span class="hljs-keyword">MONTH</span>);

        <span class="hljs-comment">-- Calculate days since last order</span>
        IF last_order_date IS NOT NULL THEN
            <span class="hljs-keyword">SET</span> days_since_last_order = <span class="hljs-keyword">DATEDIFF</span>(analysis_date, last_order_date);
        ELSE
            <span class="hljs-keyword">SET</span> days_since_last_order = <span class="hljs-literal">NULL</span>;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-comment">-- Determine customer tier</span>
        IF total_spent &gt;= 5000 OR order_count &gt;= 20 THEN
            <span class="hljs-keyword">SET</span> customer_tier = <span class="hljs-string">'VIP'</span>;
        ELSEIF total_spent &gt;= 2000 OR order_count &gt;= 10 THEN
            <span class="hljs-keyword">SET</span> customer_tier = <span class="hljs-string">'Premium'</span>;
        ELSEIF total_spent &gt;= 500 OR order_count &gt;= 3 THEN
            <span class="hljs-keyword">SET</span> customer_tier = <span class="hljs-string">'Regular'</span>;
        ELSE
            <span class="hljs-keyword">SET</span> customer_tier = <span class="hljs-string">'Basic'</span>;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-comment">-- Determine lifecycle stage</span>
        IF order_count = 0 THEN
            <span class="hljs-keyword">SET</span> lifecycle_stage = <span class="hljs-string">'Prospect'</span>;
        ELSEIF order_count = 1 THEN
            <span class="hljs-keyword">SET</span> lifecycle_stage = <span class="hljs-string">'New Customer'</span>;
        ELSEIF order_count &lt;= 5 THEN
            <span class="hljs-keyword">SET</span> lifecycle_stage = <span class="hljs-string">'Developing'</span>;
        ELSE
            <span class="hljs-keyword">SET</span> lifecycle_stage = <span class="hljs-string">'Established'</span>;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-comment">-- Determine churn risk</span>
        IF days_since_last_order IS NULL THEN
            <span class="hljs-keyword">SET</span> churn_risk = <span class="hljs-string">'Never Purchased'</span>;
        ELSEIF days_since_last_order &lt;= 30 THEN
            <span class="hljs-keyword">SET</span> churn_risk = <span class="hljs-string">'Low'</span>;
        ELSEIF days_since_last_order &lt;= 90 THEN
            <span class="hljs-keyword">SET</span> churn_risk = <span class="hljs-string">'Medium'</span>;
        ELSEIF days_since_last_order &lt;= 180 THEN
            <span class="hljs-keyword">SET</span> churn_risk = <span class="hljs-string">'High'</span>;
        ELSE
            <span class="hljs-keyword">SET</span> churn_risk = <span class="hljs-string">'Very High'</span>;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-comment">-- Insert analytics record</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customer_analytics (
            customer_id, analysis_date, total_spent, order_count, avg_order_value,
            last_order_date, days_since_last_order, customer_tier, lifecycle_stage, churn_risk
        ) <span class="hljs-keyword">VALUES</span> (
            customer_id_var, analysis_date, total_spent, order_count, avg_order_value,
            last_order_date, days_since_last_order, customer_tier, lifecycle_stage, churn_risk
        );

    <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;

    CLOSE customer_cursor;

    <span class="hljs-comment">-- Return summary</span>
    <span class="hljs-keyword">SELECT</span>
        customer_tier,
        lifecycle_stage,
        churn_risk,
        <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> customer_count,
        <span class="hljs-keyword">AVG</span>(total_spent) <span class="hljs-keyword">as</span> avg_spent,
        <span class="hljs-keyword">AVG</span>(order_count) <span class="hljs-keyword">as</span> avg_orders
    <span class="hljs-keyword">FROM</span> customer_analytics
    <span class="hljs-keyword">WHERE</span> analysis_date = analysis_date
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_tier, lifecycle_stage, churn_risk
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> customer_tier, lifecycle_stage, churn_risk;
<span class="hljs-keyword">END</span> //
DELIMITER ;

<span class="hljs-comment">-- Run the analysis</span>
<span class="hljs-keyword">CALL</span> AnalyzeCustomerSegments(<span class="hljs-keyword">CURDATE</span>());
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-use-cases--interview-tips">ğŸ¯ Use Cases &amp; Interview Tips</h2>
<h3 id="common-interview-questions">Common Interview Questions:</h3>
<ol>
<li>
<p><strong>&quot;When would you use a stored procedure vs a function?&quot;</strong></p>
<ul>
<li>Procedures: Complex business logic, data modifications, transaction control</li>
<li>Functions: Calculations, data transformations, reusable logic in queries</li>
<li>Consider maintainability and where business logic should reside</li>
</ul>
</li>
<li>
<p><strong>&quot;How do you handle errors in stored procedures?&quot;</strong></p>
<ul>
<li>MySQL: DECLARE HANDLER statements</li>
<li>PostgreSQL: BEGIN/EXCEPTION blocks</li>
<li>Always consider transaction rollback and cleanup</li>
</ul>
</li>
<li>
<p><strong>&quot;What are the performance implications of stored procedures?&quot;</strong></p>
<ul>
<li>Pros: Compiled once, reduced network traffic, optimized execution plans</li>
<li>Cons: Database server load, harder to scale horizontally, debugging complexity</li>
</ul>
</li>
<li>
<p><strong>&quot;How do you secure stored procedures?&quot;</strong></p>
<ul>
<li>Grant specific EXECUTE permissions</li>
<li>Use DEFINER vs INVOKER rights</li>
<li>Validate all input parameters</li>
<li>Avoid dynamic SQL construction</li>
</ul>
</li>
</ol>
<h3 id="best-practices">Best Practices:</h3>
<ol>
<li><strong>Keep procedures focused and single-purpose</strong></li>
<li><strong>Use proper error handling and logging</strong></li>
<li><strong>Validate all input parameters</strong></li>
<li><strong>Use transactions appropriately</strong></li>
<li><strong>Document complex business logic</strong></li>
<li><strong>Consider version control for database objects</strong></li>
</ol>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-things-to-watch-out-for">âš ï¸ Things to Watch Out For</h2>
<h3 id="1-sql-injection-in-dynamic-sql">1. <strong>SQL Injection in Dynamic SQL</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Bad: Vulnerable to SQL injection</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> BadSearch(<span class="hljs-keyword">IN</span> search_term <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>))
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SET</span> @<span class="hljs-keyword">sql</span> = <span class="hljs-keyword">CONCAT</span>(<span class="hljs-string">'SELECT * FROM products WHERE product_name LIKE "%'</span>, search_term, <span class="hljs-string">'%"'</span>);
    <span class="hljs-keyword">PREPARE</span> stmt <span class="hljs-keyword">FROM</span> @<span class="hljs-keyword">sql</span>;
    <span class="hljs-keyword">EXECUTE</span> stmt;
    <span class="hljs-keyword">DEALLOCATE</span> <span class="hljs-keyword">PREPARE</span> stmt;
<span class="hljs-keyword">END</span> //
DELIMITER ;

<span class="hljs-comment">-- Good: Use parameters</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> GoodSearch(<span class="hljs-keyword">IN</span> search_term <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>))
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products
    <span class="hljs-keyword">WHERE</span> product_name <span class="hljs-keyword">LIKE</span> <span class="hljs-keyword">CONCAT</span>(<span class="hljs-string">'%'</span>, search_term, <span class="hljs-string">'%'</span>);
<span class="hljs-keyword">END</span> //
DELIMITER ;
</div></code></pre>
<h3 id="2-transaction-management">2. <strong>Transaction Management</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Be careful with transaction boundaries</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> risky_function()
<span class="hljs-keyword">RETURNS</span> <span class="hljs-built_in">VOID</span>
<span class="hljs-keyword">LANGUAGE</span> plpgsql
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- This function should not control transactions</span>
    <span class="hljs-comment">-- if it's called within another transaction</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> audit_log <span class="hljs-keyword">VALUES</span> (...);

    <span class="hljs-comment">-- Don't do this in a function:</span>
    <span class="hljs-comment">-- COMMIT;  -- This would commit the entire transaction</span>
<span class="hljs-keyword">END</span>;
$$;
</div></code></pre>
<h3 id="3-performance-issues">3. <strong>Performance Issues</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Avoid cursor loops when set-based operations work</span>
<span class="hljs-comment">-- Bad: Cursor-based processing</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> SlowUpdate()
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> done <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>;
    <span class="hljs-keyword">DECLARE</span> order_id_var <span class="hljs-built_in">INT</span>;
    <span class="hljs-keyword">DECLARE</span> order_cursor <span class="hljs-keyword">CURSOR</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> order_id <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'pending'</span>;
    <span class="hljs-keyword">DECLARE</span> CONTINUE <span class="hljs-keyword">HANDLER</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">FOUND</span> <span class="hljs-keyword">SET</span> done = <span class="hljs-literal">TRUE</span>;

    OPEN order_cursor;
    order_loop: LOOP
        FETCH order_cursor INTO order_id_var;
        IF done THEN LEAVE order_loop; <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-keyword">UPDATE</span> orders <span class="hljs-keyword">SET</span> processed_date = <span class="hljs-keyword">NOW</span>() <span class="hljs-keyword">WHERE</span> order_id = order_id_var;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;
    CLOSE order_cursor;
<span class="hljs-keyword">END</span> //
DELIMITER ;

<span class="hljs-comment">-- Good: Set-based operation</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> FastUpdate()
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">UPDATE</span> orders <span class="hljs-keyword">SET</span> processed_date = <span class="hljs-keyword">NOW</span>() <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'pending'</span>;
<span class="hljs-keyword">END</span> //
DELIMITER ;
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%80-next-steps">ğŸš€ Next Steps</h2>
<p>In the next chapter, we'll explore <strong>Triggers and Events</strong> - special stored procedures that automatically execute in response to database events. You'll learn how to create audit trails, enforce business rules, and automate database maintenance tasks.</p>
<hr>
<h2 id="%F0%9F%93%9D-quick-practice">ğŸ“ Quick Practice</h2>
<p>Try these stored procedure exercises:</p>
<ol>
<li><strong>Basic Procedure</strong>: Create a procedure to calculate monthly sales totals</li>
<li><strong>Function</strong>: Write a function to determine shipping cost based on weight and distance</li>
<li><strong>Error Handling</strong>: Implement a safe money transfer procedure with proper error handling</li>
<li><strong>Business Logic</strong>: Create a customer loyalty points calculation system</li>
<li><strong>Complex Processing</strong>: Build an order fulfillment procedure that handles inventory, pricing, and notifications</li>
</ol>
<p>Consider:</p>
<ul>
<li>When to use procedures vs functions</li>
<li>Proper error handling strategies</li>
<li>Transaction management</li>
<li>Security implications</li>
<li>Performance optimization techniques</li>
</ul>
<h1 id="chapter-13-triggers-and-events">Chapter 13: Triggers and Events</h1>
<h2 id="%F0%9F%93%9A-what-youll-learn">ğŸ“š What You'll Learn</h2>
<p>Triggers are special stored procedures that automatically execute (&quot;fire&quot;) in response to specific database events. Events are scheduled tasks that run at predetermined times. This chapter covers how to create, manage, and optimize triggers and events for automation, auditing, and business rule enforcement.</p>
<hr>
<h2 id="%F0%9F%8E%AF-learning-objectives">ğŸ¯ Learning Objectives</h2>
<p>By the end of this chapter, you will:</p>
<ul>
<li>Understand different types of triggers and their use cases</li>
<li>Create BEFORE, AFTER, and INSTEAD OF triggers</li>
<li>Implement audit trails and data validation</li>
<li>Use events for scheduled database maintenance</li>
<li>Handle trigger performance and avoid common pitfalls</li>
<li>Implement complex business rules with triggers</li>
</ul>
<hr>
<h2 id="%F0%9F%94%8D-concept-explanation">ğŸ” Concept Explanation</h2>
<h3 id="what-are-triggers">What are Triggers?</h3>
<p>Triggers are special stored procedures that automatically execute in response to specific database events such as INSERT, UPDATE, or DELETE operations. They cannot be called directly and run within the same transaction as the triggering statement.</p>
<p><strong>Types of Triggers:</strong></p>
<ul>
<li><strong>BEFORE</strong>: Execute before the triggering event</li>
<li><strong>AFTER</strong>: Execute after the triggering event</li>
<li><strong>INSTEAD OF</strong>: Replace the triggering event (views only)</li>
</ul>
<p><strong>Common Use Cases:</strong></p>
<ul>
<li>Audit trails and logging</li>
<li>Data validation and business rules</li>
<li>Automatic calculations and updates</li>
<li>Maintaining derived data</li>
<li>Security and access control</li>
</ul>
<h3 id="what-are-events">What are Events?</h3>
<p>Events are scheduled tasks that run automatically at specified times or intervals. They're useful for database maintenance, reporting, and batch processing.</p>
<hr>
<h2 id="%F0%9F%9B%A0%EF%B8%8F-syntax-comparison">ğŸ› ï¸ Syntax Comparison</h2>
<h3 id="mysql-vs-postgresql-triggers">MySQL vs PostgreSQL Triggers</h3>
<table>
<thead>
<tr>
<th>Feature</th>
<th>MySQL</th>
<th>PostgreSQL</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Trigger Types</strong></td>
<td>BEFORE, AFTER</td>
<td>BEFORE, AFTER, INSTEAD OF</td>
</tr>
<tr>
<td><strong>Row vs Statement</strong></td>
<td>Row-level only</td>
<td>Both row and statement level</td>
</tr>
<tr>
<td><strong>Multiple Triggers</strong></td>
<td>âœ… (5.7+)</td>
<td>âœ…</td>
</tr>
<tr>
<td><strong>Trigger Functions</strong></td>
<td>Inline SQL</td>
<td>Separate functions</td>
</tr>
<tr>
<td><strong>OLD/NEW References</strong></td>
<td>OLD, NEW</td>
<td>OLD, NEW</td>
</tr>
<tr>
<td><strong>Conditional Logic</strong></td>
<td>WHEN clause (5.7+)</td>
<td>WHEN clause</td>
</tr>
<tr>
<td><strong>Events/Scheduling</strong></td>
<td>Event Scheduler</td>
<td>pg_cron extension</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="%F0%9F%94%A5-basic-triggers">ğŸ”¥ Basic Triggers</h2>
<h3 id="mysql-triggers">MySQL Triggers</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Simple audit trigger</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> audit_customer_changes
    <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> customers
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customer_audit (
        customer_id,
        action_type,
        old_email,
        new_email,
        old_status,
        new_status,
        changed_by,
        changed_at
    ) <span class="hljs-keyword">VALUES</span> (
        NEW.customer_id,
        <span class="hljs-string">'UPDATE'</span>,
        OLD.email,
        NEW.email,
        OLD.status,
        NEW.status,
        <span class="hljs-keyword">USER</span>(),
        <span class="hljs-keyword">NOW</span>()
    );
<span class="hljs-keyword">END</span> //
DELIMITER ;

<span class="hljs-comment">-- BEFORE trigger for data validation</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> validate_order_before_insert
    <span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> orders
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- Validate customer exists and is active</span>
    <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">WHERE</span> customer_id = NEW.customer_id <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>) <span class="hljs-keyword">THEN</span>
        SIGNAL <span class="hljs-keyword">SQLSTATE</span> <span class="hljs-string">'45000'</span> <span class="hljs-keyword">SET</span> MESSAGE_TEXT = <span class="hljs-string">'Customer does not exist or is inactive'</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-comment">-- Set default values</span>
    IF NEW.order_date IS NULL THEN
        <span class="hljs-keyword">SET</span> NEW.order_date = <span class="hljs-keyword">NOW</span>();
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    IF NEW.status IS NULL THEN
        <span class="hljs-keyword">SET</span> NEW.status = <span class="hljs-string">'pending'</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-comment">-- Validate order amount</span>
    IF NEW.total_amount &lt; 0 THEN
        SIGNAL SQLSTATE '45000' <span class="hljs-keyword">SET</span> MESSAGE_TEXT = <span class="hljs-string">'Order amount cannot be negative'</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
<span class="hljs-keyword">END</span> //
DELIMITER ;

<span class="hljs-comment">-- AFTER trigger for automatic updates</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> update_customer_stats_after_order
    <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> orders
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- Update customer statistics</span>
    <span class="hljs-keyword">UPDATE</span> customer_stats
    <span class="hljs-keyword">SET</span>
        total_orders = total_orders + <span class="hljs-number">1</span>,
        total_spent = total_spent + NEW.total_amount,
        last_order_date = NEW.order_date
    <span class="hljs-keyword">WHERE</span> customer_id = NEW.customer_id;

    <span class="hljs-comment">-- Insert if customer stats don't exist</span>
    IF ROW_COUNT() = 0 THEN
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customer_stats (customer_id, total_orders, total_spent, last_order_date)
        <span class="hljs-keyword">VALUES</span> (NEW.customer_id, <span class="hljs-number">1</span>, NEW.total_amount, NEW.order_date);
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
<span class="hljs-keyword">END</span> //
DELIMITER ;
</div></code></pre>
<h3 id="postgresql-triggers">PostgreSQL Triggers</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Create trigger function first</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> audit_customer_changes()
<span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TRIGGER</span>
<span class="hljs-keyword">LANGUAGE</span> plpgsql
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">IF</span> TG_OP = <span class="hljs-string">'UPDATE'</span> <span class="hljs-keyword">THEN</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customer_audit (
            customer_id,
            action_type,
            old_email,
            new_email,
            old_status,
            new_status,
            changed_by,
            changed_at
        ) <span class="hljs-keyword">VALUES</span> (
            NEW.customer_id,
            <span class="hljs-string">'UPDATE'</span>,
            OLD.email,
            NEW.email,
            OLD.status,
            NEW.status,
            <span class="hljs-keyword">current_user</span>,
            <span class="hljs-keyword">current_timestamp</span>
        );
        RETURN NEW;
    ELSIF TG_OP = '<span class="hljs-keyword">INSERT</span><span class="hljs-string">' THEN
        INSERT INTO customer_audit (
            customer_id,
            action_type,
            new_email,
            new_status,
            changed_by,
            changed_at
        ) VALUES (
            NEW.customer_id,
            '</span><span class="hljs-keyword">INSERT</span><span class="hljs-string">',
            NEW.email,
            NEW.status,
            current_user,
            current_timestamp
        );
        RETURN NEW;
    ELSIF TG_OP = '</span><span class="hljs-keyword">DELETE</span><span class="hljs-string">' THEN
        INSERT INTO customer_audit (
            customer_id,
            action_type,
            old_email,
            old_status,
            changed_by,
            changed_at
        ) VALUES (
            OLD.customer_id,
            '</span><span class="hljs-keyword">DELETE</span><span class="hljs-string">',
            OLD.email,
            OLD.status,
            current_user,
            current_timestamp
        );
        RETURN OLD;
    END IF;

    RETURN NULL;
END;
$$;

-- Create the trigger
CREATE TRIGGER audit_customer_changes
    AFTER INSERT OR UPDATE OR DELETE ON customers
    FOR EACH ROW
    EXECUTE FUNCTION audit_customer_changes();

-- BEFORE trigger for validation
CREATE OR REPLACE FUNCTION validate_order_before_insert()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
    -- Validate customer exists and is active
    IF NOT EXISTS (SELECT 1 FROM customers WHERE customer_id = NEW.customer_id AND status = '</span>active<span class="hljs-string">') THEN
        RAISE EXCEPTION '</span>Customer does <span class="hljs-keyword">not</span> exist <span class="hljs-keyword">or</span> <span class="hljs-keyword">is</span> inactive<span class="hljs-string">';
    END IF;

    -- Set default values
    IF NEW.order_date IS NULL THEN
        NEW.order_date := current_timestamp;
    END IF;

    IF NEW.status IS NULL THEN
        NEW.status := '</span>pending<span class="hljs-string">';
    END IF;

    -- Validate order amount
    IF NEW.total_amount &lt; 0 THEN
        RAISE EXCEPTION '</span><span class="hljs-keyword">Order</span> amount cannot be negative<span class="hljs-string">';
    END IF;

    RETURN NEW;
END;
$$;

CREATE TRIGGER validate_order_before_insert
    BEFORE INSERT ON orders
    FOR EACH ROW
    EXECUTE FUNCTION validate_order_before_insert();

-- Statement-level trigger (PostgreSQL only)
CREATE OR REPLACE FUNCTION log_bulk_operations()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
    INSERT INTO operation_log (table_name, operation, row_count, timestamp)
    VALUES (TG_TABLE_NAME, TG_OP, TG_LEVEL, current_timestamp);

    RETURN NULL;
END;
$$;

CREATE TRIGGER log_bulk_operations
    AFTER INSERT OR UPDATE OR DELETE ON orders
    FOR EACH STATEMENT
    EXECUTE FUNCTION log_bulk_operations();
</span></div></code></pre>
<hr>
<h2 id="%F0%9F%93%8A-advanced-trigger-examples">ğŸ“Š Advanced Trigger Examples</h2>
<h3 id="inventory-management-system">Inventory Management System</h3>
<p><strong>MySQL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Create inventory tracking tables</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> inventory_movements (
    movement_id <span class="hljs-built_in">INT</span> AUTO_INCREMENT PRIMARY <span class="hljs-keyword">KEY</span>,
    product_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    movement_type ENUM(<span class="hljs-string">'IN'</span>, <span class="hljs-string">'OUT'</span>, <span class="hljs-string">'ADJUSTMENT'</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    quantity <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    reference_type <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    reference_id <span class="hljs-built_in">INT</span>,
    movement_date <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    notes <span class="hljs-built_in">TEXT</span>
);

<span class="hljs-comment">-- Trigger to track inventory movements</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> track_inventory_on_order_item_insert
    <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> order_items
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> current_stock <span class="hljs-built_in">INT</span>;

    <span class="hljs-comment">-- Check current stock</span>
    <span class="hljs-keyword">SELECT</span> stock_quantity <span class="hljs-keyword">INTO</span> current_stock
    <span class="hljs-keyword">FROM</span> products
    <span class="hljs-keyword">WHERE</span> product_id = NEW.product_id;

    <span class="hljs-comment">-- Validate sufficient stock</span>
    IF current_stock &lt; NEW.quantity THEN
        SIGNAL SQLSTATE '45000'
        <span class="hljs-keyword">SET</span> MESSAGE_TEXT = <span class="hljs-keyword">CONCAT</span>(<span class="hljs-string">'Insufficient stock. Available: '</span>, current_stock, <span class="hljs-string">', Requested: '</span>, NEW.quantity);
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-comment">-- Update product stock</span>
    <span class="hljs-keyword">UPDATE</span> products
    <span class="hljs-keyword">SET</span> stock_quantity = stock_quantity - NEW.quantity
    <span class="hljs-keyword">WHERE</span> product_id = NEW.product_id;

    <span class="hljs-comment">-- Record inventory movement</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> inventory_movements (
        product_id,
        movement_type,
        quantity,
        reference_type,
        reference_id,
        notes
    ) <span class="hljs-keyword">VALUES</span> (
        NEW.product_id,
        <span class="hljs-string">'OUT'</span>,
        NEW.quantity,
        <span class="hljs-string">'ORDER'</span>,
        NEW.order_id,
        <span class="hljs-keyword">CONCAT</span>(<span class="hljs-string">'Order item for order #'</span>, NEW.order_id)
    );
<span class="hljs-keyword">END</span> //
DELIMITER ;

<span class="hljs-comment">-- Trigger to handle order cancellations</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> restore_inventory_on_order_cancel
    <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> orders
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- Only process if order status changed to cancelled</span>
    <span class="hljs-keyword">IF</span> OLD.status != <span class="hljs-string">'cancelled'</span> <span class="hljs-keyword">AND</span> NEW.status = <span class="hljs-string">'cancelled'</span> <span class="hljs-keyword">THEN</span>
        <span class="hljs-comment">-- Restore inventory for all order items</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> inventory_movements (product_id, movement_type, quantity, reference_type, reference_id, notes)
        <span class="hljs-keyword">SELECT</span>
            oi.product_id,
            <span class="hljs-string">'IN'</span>,
            oi.quantity,
            <span class="hljs-string">'ORDER_CANCEL'</span>,
            NEW.order_id,
            <span class="hljs-keyword">CONCAT</span>(<span class="hljs-string">'Inventory restored from cancelled order #'</span>, NEW.order_id)
        <span class="hljs-keyword">FROM</span> order_items oi
        <span class="hljs-keyword">WHERE</span> oi.order_id = NEW.order_id;

        <span class="hljs-comment">-- Update product stock</span>
        <span class="hljs-keyword">UPDATE</span> products p
        <span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> p.product_id = oi.product_id
        <span class="hljs-keyword">SET</span> p.stock_quantity = p.stock_quantity + oi.quantity
        <span class="hljs-keyword">WHERE</span> oi.order_id = NEW.order_id;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
<span class="hljs-keyword">END</span> //
DELIMITER ;
</div></code></pre>
<p><strong>PostgreSQL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Comprehensive inventory management trigger</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> manage_inventory()
<span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TRIGGER</span>
<span class="hljs-keyword">LANGUAGE</span> plpgsql
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    current_stock <span class="hljs-built_in">INT</span>;
    item_record RECORD;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">IF</span> TG_TABLE_NAME = <span class="hljs-string">'order_items'</span> <span class="hljs-keyword">THEN</span>
        <span class="hljs-keyword">IF</span> TG_OP = <span class="hljs-string">'INSERT'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-comment">-- Check and update stock for new order item</span>
            <span class="hljs-keyword">SELECT</span> stock_quantity <span class="hljs-keyword">INTO</span> current_stock
            <span class="hljs-keyword">FROM</span> products
            <span class="hljs-keyword">WHERE</span> product_id = NEW.product_id
            <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;

            IF NOT FOUND THEN
                RAISE EXCEPTION 'Product % not found', NEW.product_id;
            <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

            IF current_stock &lt; NEW.quantity THEN
                RAISE EXCEPTION 'Insufficient stock. Available: %, Requested: %', current_stock, NEW.quantity;
            <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

            <span class="hljs-comment">-- Update stock</span>
            <span class="hljs-keyword">UPDATE</span> products
            <span class="hljs-keyword">SET</span> stock_quantity = stock_quantity - NEW.quantity
            <span class="hljs-keyword">WHERE</span> product_id = NEW.product_id;

            <span class="hljs-comment">-- Record movement</span>
            <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> inventory_movements (
                product_id, movement_type, quantity, reference_type, reference_id, notes
            ) <span class="hljs-keyword">VALUES</span> (
                NEW.product_id, <span class="hljs-string">'OUT'</span>, NEW.quantity, <span class="hljs-string">'ORDER'</span>, NEW.order_id,
                <span class="hljs-string">'Order item for order #'</span> || NEW.order_id
            );

            RETURN NEW;

        ELSIF TG_OP = '<span class="hljs-keyword">DELETE</span><span class="hljs-string">' THEN
            -- Restore stock when order item is deleted
            UPDATE products
            SET stock_quantity = stock_quantity + OLD.quantity
            WHERE product_id = OLD.product_id;

            INSERT INTO inventory_movements (
                product_id, movement_type, quantity, reference_type, reference_id, notes
            ) VALUES (
                OLD.product_id, '</span><span class="hljs-keyword">IN</span><span class="hljs-string">', OLD.quantity, '</span>ORDER_ITEM_DELETE<span class="hljs-string">', OLD.order_id,
                '</span>Stock restored <span class="hljs-keyword">from</span> deleted <span class="hljs-keyword">order</span> item<span class="hljs-string">'
            );

            RETURN OLD;
        END IF;

    ELSIF TG_TABLE_NAME = '</span>orders<span class="hljs-string">' THEN
        IF TG_OP = '</span><span class="hljs-keyword">UPDATE</span><span class="hljs-string">' AND OLD.status != '</span>cancelled<span class="hljs-string">' AND NEW.status = '</span>cancelled<span class="hljs-string">' THEN
            -- Restore inventory for cancelled orders
            FOR item_record IN
                SELECT product_id, quantity FROM order_items WHERE order_id = NEW.order_id
            LOOP
                UPDATE products
                SET stock_quantity = stock_quantity + item_record.quantity
                WHERE product_id = item_record.product_id;

                INSERT INTO inventory_movements (
                    product_id, movement_type, quantity, reference_type, reference_id, notes
                ) VALUES (
                    item_record.product_id, '</span><span class="hljs-keyword">IN</span><span class="hljs-string">', item_record.quantity, '</span>ORDER_CANCEL<span class="hljs-string">', NEW.order_id,
                    '</span>Inventory restored <span class="hljs-keyword">from</span> cancelled <span class="hljs-keyword">order</span> <span class="hljs-comment">#' || NEW.order_id</span>
                );
            <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        RETURN NEW;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    RETURN NULL;
<span class="hljs-keyword">END</span>;
$$;

<span class="hljs-comment">-- Create triggers</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> manage_inventory_order_items
    <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">ON</span> order_items
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
    <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">FUNCTION</span> manage_inventory();

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> manage_inventory_orders
    <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> orders
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
    <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">FUNCTION</span> manage_inventory();
</div></code></pre>
<h3 id="comprehensive-audit-system">Comprehensive Audit System</h3>
<p><strong>PostgreSQL Advanced Audit:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Generic audit function</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> audit_trigger()
<span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TRIGGER</span>
<span class="hljs-keyword">LANGUAGE</span> plpgsql
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    old_data JSONB;
    new_data JSONB;
    changed_fields JSONB;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- Convert row data to JSON</span>
    <span class="hljs-keyword">IF</span> TG_OP = <span class="hljs-string">'DELETE'</span> <span class="hljs-keyword">THEN</span>
        old_data := to_jsonb(<span class="hljs-keyword">OLD</span>);
        new_data := NULL;
    ELSIF TG_OP = '<span class="hljs-keyword">INSERT</span><span class="hljs-string">' THEN
        old_data := NULL;
        new_data := to_jsonb(NEW);
    ELSIF TG_OP = '</span><span class="hljs-keyword">UPDATE</span><span class="hljs-string">' THEN
        old_data := to_jsonb(OLD);
        new_data := to_jsonb(NEW);

        -- Calculate changed fields
        SELECT jsonb_object_agg(key, jsonb_build_object(
            '</span><span class="hljs-keyword">old</span><span class="hljs-string">', old_data-&gt;key,
            '</span><span class="hljs-keyword">new</span><span class="hljs-string">', new_data-&gt;key
        )) INTO changed_fields
        FROM jsonb_each(new_data)
        WHERE new_data-&gt;key IS DISTINCT FROM old_data-&gt;key;
    END IF;

    -- Insert audit record
    INSERT INTO audit_log (
        table_name,
        operation,
        record_id,
        old_data,
        new_data,
        changed_fields,
        user_name,
        timestamp,
        application_name,
        client_addr
    ) VALUES (
        TG_TABLE_NAME,
        TG_OP,
        COALESCE(NEW.id, OLD.id),  -- Assumes '</span><span class="hljs-keyword">id</span><span class="hljs-string">' column exists
        old_data,
        new_data,
        changed_fields,
        current_user,
        current_timestamp,
        current_setting('</span>application_name<span class="hljs-string">', true),
        inet_client_addr()
    );

    IF TG_OP = '</span><span class="hljs-keyword">DELETE</span><span class="hljs-string">' THEN
        RETURN OLD;
    ELSE
        RETURN NEW;
    END IF;
END;
$$;

-- Apply audit trigger to multiple tables
CREATE TRIGGER audit_customers
    AFTER INSERT OR UPDATE OR DELETE ON customers
    FOR EACH ROW
    EXECUTE FUNCTION audit_trigger();

CREATE TRIGGER audit_orders
    AFTER INSERT OR UPDATE OR DELETE ON orders
    FOR EACH ROW
    EXECUTE FUNCTION audit_trigger();

CREATE TRIGGER audit_products
    AFTER INSERT OR UPDATE OR DELETE ON products
    FOR EACH ROW
    EXECUTE FUNCTION audit_trigger();
</span></div></code></pre>
<hr>
<h2 id="%E2%8F%B0-events-and-scheduled-tasks">â° Events and Scheduled Tasks</h2>
<h3 id="mysql-event-scheduler">MySQL Event Scheduler</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Enable event scheduler</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> event_scheduler = <span class="hljs-keyword">ON</span>;

<span class="hljs-comment">-- Daily cleanup event</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">EVENT</span> daily_cleanup
<span class="hljs-keyword">ON</span> SCHEDULE EVERY <span class="hljs-number">1</span> <span class="hljs-keyword">DAY</span>
STARTS <span class="hljs-string">'2024-01-01 02:00:00'</span>
<span class="hljs-keyword">DO</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- Clean up old audit records (keep 1 year)</span>
    <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> audit_log
    <span class="hljs-keyword">WHERE</span> created_at &lt; <span class="hljs-keyword">DATE_SUB</span>(<span class="hljs-keyword">NOW</span>(), <span class="hljs-built_in">INTERVAL</span> <span class="hljs-number">1</span> <span class="hljs-keyword">YEAR</span>);

    <span class="hljs-comment">-- Clean up expired sessions</span>
    <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> user_sessions
    <span class="hljs-keyword">WHERE</span> expires_at &lt; <span class="hljs-keyword">NOW</span>();

    <span class="hljs-comment">-- Update customer statistics</span>
    <span class="hljs-keyword">CALL</span> UpdateCustomerStatistics();

    <span class="hljs-comment">-- Log cleanup completion</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> maintenance_log (task_name, completion_time, records_affected)
    <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'daily_cleanup'</span>, <span class="hljs-keyword">NOW</span>(), <span class="hljs-keyword">ROW_COUNT</span>());
<span class="hljs-keyword">END</span> //
DELIMITER ;

<span class="hljs-comment">-- Weekly report generation</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">EVENT</span> weekly_sales_report
<span class="hljs-keyword">ON</span> SCHEDULE EVERY <span class="hljs-number">1</span> <span class="hljs-keyword">WEEK</span>
STARTS <span class="hljs-string">'2024-01-01 06:00:00'</span>
<span class="hljs-keyword">DO</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> report_start_date <span class="hljs-built_in">DATE</span>;
    <span class="hljs-keyword">DECLARE</span> report_end_date <span class="hljs-built_in">DATE</span>;

    <span class="hljs-keyword">SET</span> report_end_date = <span class="hljs-keyword">DATE_SUB</span>(<span class="hljs-keyword">CURDATE</span>(), <span class="hljs-built_in">INTERVAL</span> <span class="hljs-number">1</span> <span class="hljs-keyword">DAY</span>);
    <span class="hljs-keyword">SET</span> report_start_date = <span class="hljs-keyword">DATE_SUB</span>(report_end_date, <span class="hljs-built_in">INTERVAL</span> <span class="hljs-number">6</span> <span class="hljs-keyword">DAY</span>);

    <span class="hljs-comment">-- Generate weekly sales summary</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> weekly_sales_reports (
        report_week,
        start_date,
        end_date,
        total_orders,
        total_revenue,
        avg_order_value,
        new_customers,
        generated_at
    )
    <span class="hljs-keyword">SELECT</span>
        <span class="hljs-keyword">YEARWEEK</span>(report_end_date),
        report_start_date,
        report_end_date,
        <span class="hljs-keyword">COUNT</span>(o.order_id),
        <span class="hljs-keyword">SUM</span>(o.total_amount),
        <span class="hljs-keyword">AVG</span>(o.total_amount),
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> c.created_at &gt;= report_start_date <span class="hljs-keyword">THEN</span> c.customer_id <span class="hljs-keyword">END</span>),
        <span class="hljs-keyword">NOW</span>()
    <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">JOIN</span> customers c <span class="hljs-keyword">ON</span> o.customer_id = c.customer_id
    <span class="hljs-keyword">WHERE</span> o.order_date <span class="hljs-keyword">BETWEEN</span> report_start_date <span class="hljs-keyword">AND</span> report_end_date
      <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>;
<span class="hljs-keyword">END</span> //
DELIMITER ;

<span class="hljs-comment">-- Monthly maintenance event</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">EVENT</span> monthly_maintenance
<span class="hljs-keyword">ON</span> SCHEDULE EVERY <span class="hljs-number">1</span> <span class="hljs-keyword">MONTH</span>
STARTS <span class="hljs-string">'2024-01-01 01:00:00'</span>
<span class="hljs-keyword">DO</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- Optimize tables</span>
    <span class="hljs-keyword">OPTIMIZE</span> <span class="hljs-keyword">TABLE</span> customers, orders, order_items, products;

    <span class="hljs-comment">-- Update table statistics</span>
    <span class="hljs-keyword">ANALYZE</span> <span class="hljs-keyword">TABLE</span> customers, orders, order_items, products;

    <span class="hljs-comment">-- Archive old data</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders_archive
    <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> order_date &lt; <span class="hljs-keyword">DATE_SUB</span>(<span class="hljs-keyword">NOW</span>(), <span class="hljs-built_in">INTERVAL</span> <span class="hljs-number">2</span> <span class="hljs-keyword">YEAR</span>)
      <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'cancelled'</span>);

    <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> order_date &lt; <span class="hljs-keyword">DATE_SUB</span>(<span class="hljs-keyword">NOW</span>(), <span class="hljs-built_in">INTERVAL</span> <span class="hljs-number">2</span> <span class="hljs-keyword">YEAR</span>)
      <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'cancelled'</span>);

    <span class="hljs-comment">-- Log maintenance completion</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> maintenance_log (task_name, completion_time, records_affected)
    <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'monthly_maintenance'</span>, <span class="hljs-keyword">NOW</span>(), <span class="hljs-keyword">ROW_COUNT</span>());
<span class="hljs-keyword">END</span> //
DELIMITER ;

<span class="hljs-comment">-- View and manage events</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">EVENTS</span>;

<span class="hljs-comment">-- Disable an event</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">EVENT</span> daily_cleanup <span class="hljs-keyword">DISABLE</span>;

<span class="hljs-comment">-- Enable an event</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">EVENT</span> daily_cleanup <span class="hljs-keyword">ENABLE</span>;

<span class="hljs-comment">-- Drop an event</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">EVENT</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> old_event;
</div></code></pre>
<h3 id="postgresql-scheduled-tasks-pgcron">PostgreSQL Scheduled Tasks (pg_cron)</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Install pg_cron extension (requires superuser)</span>
<span class="hljs-keyword">CREATE</span> EXTENSION <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> pg_cron;

<span class="hljs-comment">-- Schedule daily cleanup (runs at 2 AM every day)</span>
<span class="hljs-keyword">SELECT</span> cron.schedule(<span class="hljs-string">'daily-cleanup'</span>, <span class="hljs-string">'0 2 * * *'</span>, $$
    <span class="hljs-comment">-- Clean up old audit records</span>
    <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> audit_log <span class="hljs-keyword">WHERE</span> <span class="hljs-built_in">timestamp</span> &lt; <span class="hljs-keyword">NOW</span>() - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'1 year'</span>;

    <span class="hljs-comment">-- Clean up expired sessions</span>
    <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> user_sessions <span class="hljs-keyword">WHERE</span> expires_at &lt; <span class="hljs-keyword">NOW</span>();

    <span class="hljs-comment">-- Update materialized views</span>
    REFRESH MATERIALIZED VIEW customer_analytics_12m;

    <span class="hljs-comment">-- Log completion</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> maintenance_log (task_name, completion_time)
    <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'daily_cleanup'</span>, <span class="hljs-keyword">NOW</span>());
$$);

<span class="hljs-comment">-- Schedule weekly report (runs at 6 AM every Monday)</span>
<span class="hljs-keyword">SELECT</span> cron.schedule(<span class="hljs-string">'weekly-report'</span>, <span class="hljs-string">'0 6 * * 1'</span>, $$
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> weekly_sales_reports (
        report_week,
        start_date,
        end_date,
        total_orders,
        total_revenue,
        avg_order_value,
        new_customers,
        generated_at
    )
    <span class="hljs-keyword">SELECT</span>
        <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">WEEK</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'1 week'</span>)),
        <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'1 week'</span>,
        <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'1 day'</span>,
        <span class="hljs-keyword">COUNT</span>(o.order_id),
        <span class="hljs-keyword">SUM</span>(o.total_amount),
        <span class="hljs-keyword">AVG</span>(o.total_amount),
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> c.created_at &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'1 week'</span> <span class="hljs-keyword">THEN</span> c.customer_id <span class="hljs-keyword">END</span>),
        <span class="hljs-keyword">NOW</span>()
    <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">JOIN</span> customers c <span class="hljs-keyword">ON</span> o.customer_id = c.customer_id
    <span class="hljs-keyword">WHERE</span> o.order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'1 week'</span>
      <span class="hljs-keyword">AND</span> o.order_date &lt; <span class="hljs-keyword">CURRENT_DATE</span>
      <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>;
$$);

<span class="hljs-comment">-- Schedule monthly maintenance (runs at 1 AM on the 1st of each month)</span>
<span class="hljs-keyword">SELECT</span> cron.schedule(<span class="hljs-string">'monthly-maintenance'</span>, <span class="hljs-string">'0 1 1 * *'</span>, $$
    <span class="hljs-comment">-- Vacuum and analyze tables</span>
    VACUUM <span class="hljs-keyword">ANALYZE</span> customers;
    VACUUM <span class="hljs-keyword">ANALYZE</span> orders;
    VACUUM <span class="hljs-keyword">ANALYZE</span> order_items;
    VACUUM <span class="hljs-keyword">ANALYZE</span> products;

    <span class="hljs-comment">-- Reindex if needed</span>
    REINDEX INDEX CONCURRENTLY idx_orders_customer_date;

    <span class="hljs-comment">-- Archive old data</span>
    <span class="hljs-keyword">WITH</span> archived_orders <span class="hljs-keyword">AS</span> (
        <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> orders
        <span class="hljs-keyword">WHERE</span> order_date &lt; <span class="hljs-keyword">NOW</span>() - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'2 years'</span>
          <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'completed'</span>, <span class="hljs-string">'cancelled'</span>)
        <span class="hljs-keyword">RETURNING</span> *
    )
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders_archive <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> archived_orders;
$$);

<span class="hljs-comment">-- View scheduled jobs</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> cron.job;

<span class="hljs-comment">-- Unschedule a job</span>
<span class="hljs-keyword">SELECT</span> cron.unschedule(<span class="hljs-string">'daily-cleanup'</span>);
</div></code></pre>
<hr>
<h2 id="%F0%9F%92%A1-real-world-business-examples">ğŸ’¡ Real-World Business Examples</h2>
<h3 id="example-1-e-commerce-price-change-tracking">Example 1: E-commerce Price Change Tracking</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- PostgreSQL: Track price changes and notify stakeholders</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> price_history (
    price_history_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    product_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    old_price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    new_price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    price_change_percent <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">5</span>,<span class="hljs-number">2</span>),
    changed_by <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    changed_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    reason <span class="hljs-built_in">TEXT</span>
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> price_alerts (
    alert_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    product_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    alert_type <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    message <span class="hljs-built_in">TEXT</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    processed <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> track_price_changes()
<span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TRIGGER</span>
<span class="hljs-keyword">LANGUAGE</span> plpgsql
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    price_change_percent <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">5</span>,<span class="hljs-number">2</span>);
    alert_message TEXT;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- Only process if price actually changed</span>
    <span class="hljs-keyword">IF</span> OLD.price <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> NEW.price <span class="hljs-keyword">THEN</span>
        <span class="hljs-comment">-- Calculate percentage change</span>
        <span class="hljs-keyword">IF</span> OLD.price &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
            price_change_percent := ((NEW.price - OLD.price) / OLD.price) * <span class="hljs-number">100</span>;
        ELSE
            price_change_percent := 100;  <span class="hljs-comment">-- New product</span>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-comment">-- Record price history</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> price_history (
            product_id,
            old_price,
            new_price,
            price_change_percent,
            changed_by
        ) <span class="hljs-keyword">VALUES</span> (
            NEW.product_id,
            OLD.price,
            NEW.price,
            price_change_percent,
            <span class="hljs-keyword">current_user</span>
        );

        <span class="hljs-comment">-- Generate alerts for significant changes</span>
        IF ABS(price_change_percent) &gt;= 10 THEN
            alert_message := format(
                'Significant price <span class="hljs-keyword">change</span> <span class="hljs-keyword">for</span> product %s (%s): %s â†’ %s (%<span class="hljs-number">.1</span>f%% %s)<span class="hljs-string">',
                NEW.product_name,
                NEW.sku,
                OLD.price,
                NEW.price,
                ABS(price_change_percent),
                CASE WHEN price_change_percent &gt; 0 THEN '</span>increase<span class="hljs-string">' ELSE '</span>decrease<span class="hljs-string">' END
            );

            INSERT INTO price_alerts (product_id, alert_type, message)
            VALUES (NEW.product_id, '</span>SIGNIFICANT_CHANGE<span class="hljs-string">', alert_message);
        END IF;

        -- Alert for products going out of stock
        IF OLD.stock_quantity &gt; 0 AND NEW.stock_quantity = 0 THEN
            INSERT INTO price_alerts (product_id, alert_type, message)
            VALUES (NEW.product_id, '</span>OUT_OF_STOCK<span class="hljs-string">',
                   format('</span>Product %s (%s) <span class="hljs-keyword">is</span> <span class="hljs-keyword">now</span> <span class="hljs-keyword">out</span> <span class="hljs-keyword">of</span> stock<span class="hljs-string">', NEW.product_name, NEW.sku));
        END IF;

        -- Alert for products coming back in stock
        IF OLD.stock_quantity = 0 AND NEW.stock_quantity &gt; 0 THEN
            INSERT INTO price_alerts (product_id, alert_type, message)
            VALUES (NEW.product_id, '</span>BACK_IN_STOCK<span class="hljs-string">',
                   format('</span>Product %s (%s) <span class="hljs-keyword">is</span> back <span class="hljs-keyword">in</span> stock (%s units)<span class="hljs-string">',
                          NEW.product_name, NEW.sku, NEW.stock_quantity));
        END IF;
    END IF;

    RETURN NEW;
END;
$$;

CREATE TRIGGER track_price_changes
    AFTER UPDATE ON products
    FOR EACH ROW
    EXECUTE FUNCTION track_price_changes();
</span></div></code></pre>
<h3 id="example-2-customer-loyalty-points-system">Example 2: Customer Loyalty Points System</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL: Automatic loyalty points calculation</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customer_loyalty (
    customer_id <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    total_points <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    <span class="hljs-keyword">tier</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'Bronze'</span>,
    tier_start_date <span class="hljs-built_in">DATE</span>,
    lifetime_points <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    last_updated <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> points_transactions (
    transaction_id <span class="hljs-built_in">INT</span> AUTO_INCREMENT PRIMARY <span class="hljs-keyword">KEY</span>,
    customer_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    points_earned <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    points_redeemed <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    transaction_type <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    reference_id <span class="hljs-built_in">INT</span>,
    description <span class="hljs-built_in">TEXT</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);

DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> calculate_loyalty_points
    <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> orders
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> points_earned <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">DECLARE</span> current_tier <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>);
    <span class="hljs-keyword">DECLARE</span> new_tier <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>);
    <span class="hljs-keyword">DECLARE</span> total_lifetime_points <span class="hljs-built_in">INT</span>;

    <span class="hljs-comment">-- Only process completed orders</span>
    IF NEW.status = 'completed' THEN
        <span class="hljs-comment">-- Calculate base points (1 point per dollar)</span>
        <span class="hljs-keyword">SET</span> points_earned = <span class="hljs-keyword">FLOOR</span>(NEW.total_amount);

        <span class="hljs-comment">-- Get current customer tier</span>
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">tier</span> <span class="hljs-keyword">INTO</span> current_tier
        <span class="hljs-keyword">FROM</span> customer_loyalty
        <span class="hljs-keyword">WHERE</span> customer_id = NEW.customer_id;

        <span class="hljs-comment">-- Apply tier multipliers</span>
        CASE current_tier
            WHEN 'Gold' THEN <span class="hljs-keyword">SET</span> points_earned = points_earned * <span class="hljs-number">2</span>;
            WHEN 'Silver' THEN <span class="hljs-keyword">SET</span> points_earned = <span class="hljs-keyword">FLOOR</span>(points_earned * <span class="hljs-number">1.5</span>);
            WHEN 'Bronze' THEN <span class="hljs-keyword">SET</span> points_earned = points_earned * <span class="hljs-number">1</span>;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">CASE</span>;

        <span class="hljs-comment">-- Bonus points for large orders</span>
        IF NEW.total_amount &gt;= 500 THEN
            <span class="hljs-keyword">SET</span> points_earned = points_earned + <span class="hljs-number">100</span>;
        ELSEIF NEW.total_amount &gt;= 200 THEN
            <span class="hljs-keyword">SET</span> points_earned = points_earned + <span class="hljs-number">50</span>;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-comment">-- Update customer loyalty record</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customer_loyalty (customer_id, total_points, lifetime_points, <span class="hljs-keyword">tier</span>, tier_start_date)
        <span class="hljs-keyword">VALUES</span> (NEW.customer_id, points_earned, points_earned, <span class="hljs-string">'Bronze'</span>, <span class="hljs-keyword">CURDATE</span>())
        <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DUPLICATE</span> <span class="hljs-keyword">KEY</span> <span class="hljs-keyword">UPDATE</span>
            total_points = total_points + points_earned,
            lifetime_points = lifetime_points + points_earned;

        <span class="hljs-comment">-- Check for tier upgrade</span>
        <span class="hljs-keyword">SELECT</span> lifetime_points <span class="hljs-keyword">INTO</span> total_lifetime_points
        <span class="hljs-keyword">FROM</span> customer_loyalty
        <span class="hljs-keyword">WHERE</span> customer_id = NEW.customer_id;

        IF total_lifetime_points &gt;= 10000 THEN
            <span class="hljs-keyword">SET</span> new_tier = <span class="hljs-string">'Gold'</span>;
        ELSEIF total_lifetime_points &gt;= 5000 THEN
            <span class="hljs-keyword">SET</span> new_tier = <span class="hljs-string">'Silver'</span>;
        ELSE
            <span class="hljs-keyword">SET</span> new_tier = <span class="hljs-string">'Bronze'</span>;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-comment">-- Update tier if changed</span>
        IF new_tier != current_tier THEN
            <span class="hljs-keyword">UPDATE</span> customer_loyalty
            <span class="hljs-keyword">SET</span> <span class="hljs-keyword">tier</span> = new_tier, tier_start_date = <span class="hljs-keyword">CURDATE</span>()
            <span class="hljs-keyword">WHERE</span> customer_id = NEW.customer_id;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-comment">-- Record points transaction</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> points_transactions (
            customer_id,
            points_earned,
            transaction_type,
            reference_id,
            description
        ) <span class="hljs-keyword">VALUES</span> (
            NEW.customer_id,
            points_earned,
            <span class="hljs-string">'ORDER_PURCHASE'</span>,
            NEW.order_id,
            <span class="hljs-keyword">CONCAT</span>(<span class="hljs-string">'Points earned from order #'</span>, NEW.order_id, <span class="hljs-string">' ($'</span>, NEW.total_amount, <span class="hljs-string">')'</span>)
        );
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
<span class="hljs-keyword">END</span> //
DELIMITER ;

<span class="hljs-comment">-- Trigger for points redemption</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> handle_points_redemption
    <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> points_redemptions
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> current_points <span class="hljs-built_in">INT</span>;

    <span class="hljs-comment">-- Check if customer has enough points</span>
    <span class="hljs-keyword">SELECT</span> total_points <span class="hljs-keyword">INTO</span> current_points
    <span class="hljs-keyword">FROM</span> customer_loyalty
    <span class="hljs-keyword">WHERE</span> customer_id = NEW.customer_id;

    IF current_points &gt;= NEW.points_redeemed THEN
        <span class="hljs-comment">-- Deduct points</span>
        <span class="hljs-keyword">UPDATE</span> customer_loyalty
        <span class="hljs-keyword">SET</span> total_points = total_points - NEW.points_redeemed
        <span class="hljs-keyword">WHERE</span> customer_id = NEW.customer_id;

        <span class="hljs-comment">-- Record transaction</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> points_transactions (
            customer_id,
            points_redeemed,
            transaction_type,
            reference_id,
            description
        ) <span class="hljs-keyword">VALUES</span> (
            NEW.customer_id,
            NEW.points_redeemed,
            <span class="hljs-string">'REDEMPTION'</span>,
            NEW.redemption_id,
            NEW.description
        );
    ELSE
        SIGNAL SQLSTATE '45000'
        <span class="hljs-keyword">SET</span> MESSAGE_TEXT = <span class="hljs-string">'Insufficient loyalty points for redemption'</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
<span class="hljs-keyword">END</span> //
DELIMITER ;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-use-cases--interview-tips">ğŸ¯ Use Cases &amp; Interview Tips</h2>
<h3 id="common-interview-questions">Common Interview Questions:</h3>
<ol>
<li>
<p><strong>&quot;What's the difference between BEFORE and AFTER triggers?&quot;</strong></p>
<ul>
<li>BEFORE: Can modify NEW values, prevent operations, validation</li>
<li>AFTER: Cannot modify data, used for logging, cascading updates</li>
<li>INSTEAD OF: Replace the operation (views only)</li>
</ul>
</li>
<li>
<p><strong>&quot;How do you handle recursive triggers?&quot;</strong></p>
<ul>
<li>Use conditional logic to prevent infinite loops</li>
<li>Set flags or use session variables</li>
<li>Consider using statement-level triggers</li>
</ul>
</li>
<li>
<p><strong>&quot;What are the performance implications of triggers?&quot;</strong></p>
<ul>
<li>Triggers add overhead to DML operations</li>
<li>Can slow down bulk operations</li>
<li>Consider batching and asynchronous processing</li>
</ul>
</li>
<li>
<p><strong>&quot;When would you use triggers vs stored procedures?&quot;</strong></p>
<ul>
<li>Triggers: Automatic, event-driven, data integrity</li>
<li>Procedures: Manual execution, complex business logic, better control</li>
</ul>
</li>
</ol>
<h3 id="best-practices">Best Practices:</h3>
<ol>
<li><strong>Keep triggers simple and fast</strong></li>
<li><strong>Avoid complex business logic in triggers</strong></li>
<li><strong>Use proper error handling</strong></li>
<li><strong>Document trigger behavior thoroughly</strong></li>
<li><strong>Test trigger interactions carefully</strong></li>
<li><strong>Consider alternatives for heavy processing</strong></li>
</ol>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-things-to-watch-out-for">âš ï¸ Things to Watch Out For</h2>
<h3 id="1-recursive-triggers">1. <strong>Recursive Triggers</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Infinite loop</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> update_timestamp
    <span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> orders
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
    <span class="hljs-keyword">SET</span> NEW.updated_at = <span class="hljs-keyword">NOW</span>();

<span class="hljs-comment">-- This trigger fires on every update, including its own!</span>

<span class="hljs-comment">-- Solution: Add condition</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> update_timestamp_safe
    <span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> orders
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">IF</span> NEW.updated_at = OLD.updated_at <span class="hljs-keyword">THEN</span>
        <span class="hljs-keyword">SET</span> NEW.updated_at = <span class="hljs-keyword">NOW</span>();
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
<span class="hljs-keyword">END</span> //
DELIMITER ;
</div></code></pre>
<h3 id="2-performance-issues-with-bulk-operations">2. <strong>Performance Issues with Bulk Operations</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Row-level trigger on bulk insert</span>
<span class="hljs-comment">-- This will fire once for each of 10,000 rows</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (customer_id, total_amount)
<span class="hljs-keyword">SELECT</span> customer_id, <span class="hljs-number">100</span>
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10000</span>;

<span class="hljs-comment">-- Solution: Use statement-level triggers (PostgreSQL)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> bulk_operation_log
    <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> orders
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">STATEMENT</span>
    <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">FUNCTION</span> log_bulk_insert();
</div></code></pre>
<h3 id="3-transaction-rollback-issues">3. <strong>Transaction Rollback Issues</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Be careful with error handling in triggers</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> risky_trigger()
<span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TRIGGER</span>
<span class="hljs-keyword">LANGUAGE</span> plpgsql
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- This could cause the entire transaction to rollback</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> external_api_log <span class="hljs-keyword">VALUES</span> (...);

    <span class="hljs-comment">-- Better: Use exception handling</span>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> external_api_log <span class="hljs-keyword">VALUES</span> (...);
    EXCEPTION
        WHEN OTHERS THEN
            <span class="hljs-comment">-- Log error but don't fail the main operation</span>
            <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> error_log <span class="hljs-keyword">VALUES</span> (SQLERRM);
    <span class="hljs-keyword">END</span>;

    RETURN NEW;
<span class="hljs-keyword">END</span>;
$$;
</div></code></pre>
<h3 id="4-trigger-order-dependencies">4. <strong>Trigger Order Dependencies</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Multiple triggers on same table can have order issues</span>
<span class="hljs-comment">-- MySQL: Use naming convention or FOLLOWS/PRECEDES (5.7+)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> audit_first
    <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> customers
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
    <span class="hljs-comment">-- This should run first</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> audit_log <span class="hljs-keyword">VALUES</span> (...);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> update_stats_second
    <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> customers
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
    <span class="hljs-keyword">FOLLOWS</span> audit_first  <span class="hljs-comment">-- MySQL 5.7+</span>
    <span class="hljs-comment">-- This runs after audit_first</span>
    <span class="hljs-keyword">UPDATE</span> customer_stats <span class="hljs-keyword">SET</span> ...;
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%80-next-steps">ğŸš€ Next Steps</h2>
<p>In the next chapter, we'll explore <strong>Views and CTEs (Common Table Expressions)</strong> - powerful tools for creating virtual tables, simplifying complex queries, and organizing data access. You'll learn how to create updatable views, recursive CTEs, and use them for security and abstraction.</p>
<hr>
<h2 id="%F0%9F%93%9D-quick-practice">ğŸ“ Quick Practice</h2>
<p>Try these trigger and event exercises:</p>
<ol>
<li><strong>Audit System</strong>: Create a comprehensive audit trail for all table changes</li>
<li><strong>Inventory Management</strong>: Build triggers to automatically manage product stock levels</li>
<li><strong>Business Rules</strong>: Implement complex validation rules using triggers</li>
<li><strong>Scheduled Maintenance</strong>: Create events for database cleanup and optimization</li>
<li><strong>Real-time Analytics</strong>: Use triggers to maintain real-time summary tables</li>
</ol>
<p>Consider:</p>
<ul>
<li>When to use triggers vs application logic</li>
<li>Performance implications of trigger complexity</li>
<li>Error handling and transaction management</li>
<li>Testing strategies for trigger-dependent systems</li>
<li>Alternatives like message queues for heavy processing</li>
</ul>
<h1 id="chapter-14-views-and-ctes-common-table-expressions">Chapter 14: Views and CTEs (Common Table Expressions)</h1>
<h2 id="%F0%9F%93%9A-what-youll-learn">ğŸ“š What You'll Learn</h2>
<p>Views and CTEs are powerful tools for creating virtual tables, simplifying complex queries, and organizing data access. Views provide a persistent virtual layer over your data, while CTEs offer temporary, query-scoped virtual tables. This chapter covers creating, managing, and optimizing both for better database design and query organization.</p>
<hr>
<h2 id="%F0%9F%8E%AF-learning-objectives">ğŸ¯ Learning Objectives</h2>
<p>By the end of this chapter, you will:</p>
<ul>
<li>Understand the differences between views and CTEs</li>
<li>Create simple and complex views with proper security</li>
<li>Build recursive and non-recursive CTEs</li>
<li>Implement updatable views and understand their limitations</li>
<li>Use views for data abstraction and security</li>
<li>Optimize view and CTE performance</li>
<li>Handle view dependencies and maintenance</li>
</ul>
<hr>
<h2 id="%F0%9F%94%8D-concept-explanation">ğŸ” Concept Explanation</h2>
<h3 id="what-are-views">What are Views?</h3>
<p>Views are virtual tables that don't store data themselves but provide a saved query that can be referenced like a table. They're useful for:</p>
<ul>
<li><strong>Data Abstraction</strong>: Hide complex joins and calculations</li>
<li><strong>Security</strong>: Restrict access to specific columns/rows</li>
<li><strong>Simplification</strong>: Provide user-friendly interfaces to complex data</li>
<li><strong>Consistency</strong>: Ensure consistent data access patterns</li>
</ul>
<p><strong>Types of Views:</strong></p>
<ul>
<li><strong>Simple Views</strong>: Based on single table, usually updatable</li>
<li><strong>Complex Views</strong>: Multiple tables, aggregations, may not be updatable</li>
<li><strong>Materialized Views</strong>: Physically store results (PostgreSQL)</li>
<li><strong>Indexed Views</strong>: Materialized with indexes (SQL Server)</li>
</ul>
<h3 id="what-are-ctes">What are CTEs?</h3>
<p>Common Table Expressions (CTEs) are temporary named result sets that exist only within the scope of a single query. They're excellent for:</p>
<ul>
<li><strong>Query Organization</strong>: Break complex queries into readable parts</li>
<li><strong>Recursive Operations</strong>: Tree traversal, hierarchical data</li>
<li><strong>Avoiding Repetition</strong>: Reference the same subquery multiple times</li>
<li><strong>Readability</strong>: Make complex logic more understandable</li>
</ul>
<p><strong>Types of CTEs:</strong></p>
<ul>
<li><strong>Non-Recursive</strong>: Simple temporary result sets</li>
<li><strong>Recursive</strong>: Self-referencing for hierarchical data</li>
<li><strong>Multiple CTEs</strong>: Several CTEs in one query</li>
</ul>
<hr>
<h2 id="%F0%9F%9B%A0%EF%B8%8F-syntax-comparison">ğŸ› ï¸ Syntax Comparison</h2>
<h3 id="mysql-vs-postgresql-views">MySQL vs PostgreSQL Views</h3>
<table>
<thead>
<tr>
<th>Feature</th>
<th>MySQL</th>
<th>PostgreSQL</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Basic Views</strong></td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td><strong>Updatable Views</strong></td>
<td>âœ… (limited)</td>
<td>âœ… (more flexible)</td>
</tr>
<tr>
<td><strong>Materialized Views</strong></td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
<tr>
<td><strong>Recursive Views</strong></td>
<td>âŒ</td>
<td>âœ… (via recursive CTEs)</td>
</tr>
<tr>
<td><strong>View Dependencies</strong></td>
<td>Limited tracking</td>
<td>Full dependency tracking</td>
</tr>
<tr>
<td><strong>Security Options</strong></td>
<td>Basic</td>
<td>Advanced (RLS, policies)</td>
</tr>
<tr>
<td><strong>WITH CHECK OPTION</strong></td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td><strong>CTEs</strong></td>
<td>âœ… (8.0+)</td>
<td>âœ…</td>
</tr>
<tr>
<td><strong>Recursive CTEs</strong></td>
<td>âœ… (8.0+)</td>
<td>âœ…</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="%F0%9F%91%81%EF%B8%8F-basic-views">ğŸ‘ï¸ Basic Views</h2>
<h3 id="creating-simple-views">Creating Simple Views</h3>
<p><strong>MySQL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Simple customer view with calculated fields</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> customer_summary <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    customer_id,
    <span class="hljs-keyword">CONCAT</span>(first_name, <span class="hljs-string">' '</span>, last_name) <span class="hljs-keyword">AS</span> full_name,
    email,
    phone,
    <span class="hljs-keyword">status</span>,
    created_at,
    <span class="hljs-keyword">DATEDIFF</span>(<span class="hljs-keyword">CURDATE</span>(), created_at) <span class="hljs-keyword">AS</span> days_since_registration
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>;

<span class="hljs-comment">-- Product catalog view with pricing</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> product_catalog <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    p.sku,
    c.category_name,
    p.price,
    p.stock_quantity,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> p.stock_quantity = <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Out of Stock'</span>
        <span class="hljs-keyword">WHEN</span> p.stock_quantity &lt; <span class="hljs-number">10</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Low Stock'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'In Stock'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> stock_status,
    p.created_at
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>;

<span class="hljs-comment">-- Order details view with customer info</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> order_details_view <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    o.order_id,
    o.order_date,
    <span class="hljs-keyword">CONCAT</span>(c.first_name, <span class="hljs-string">' '</span>, c.last_name) <span class="hljs-keyword">AS</span> customer_name,
    c.email <span class="hljs-keyword">AS</span> customer_email,
    o.status,
    o.total_amount,
    <span class="hljs-keyword">COUNT</span>(oi.order_item_id) <span class="hljs-keyword">AS</span> item_count,
    <span class="hljs-keyword">GROUP_CONCAT</span>(p.product_name SEPARATOR <span class="hljs-string">', '</span>) <span class="hljs-keyword">AS</span> products
<span class="hljs-keyword">FROM</span> orders o
<span class="hljs-keyword">JOIN</span> customers c <span class="hljs-keyword">ON</span> o.customer_id = c.customer_id
<span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> o.order_id = oi.order_id
<span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> oi.product_id = p.product_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> o.order_id, o.order_date, c.first_name, c.last_name, c.email, o.status, o.total_amount;

<span class="hljs-comment">-- Using views</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customer_summary <span class="hljs-keyword">WHERE</span> days_since_registration &gt; <span class="hljs-number">365</span>;

<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> product_catalog <span class="hljs-keyword">WHERE</span> stock_status = <span class="hljs-string">'Low Stock'</span>;

<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> order_details_view <span class="hljs-keyword">WHERE</span> order_date &gt;= <span class="hljs-string">'2024-01-01'</span>;
</div></code></pre>
<p><strong>PostgreSQL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Customer analytics view with window functions</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> customer_analytics <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name || <span class="hljs-string">' '</span> || c.last_name <span class="hljs-keyword">AS</span> full_name,
    c.email,
    c.status,
    c.created_at,
    <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">DAYS</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">CURRENT_DATE</span> - c.created_at)) <span class="hljs-keyword">AS</span> days_since_registration,
    <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">AS</span> total_orders,
    <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(o.total_amount), <span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> total_spent,
    <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">AVG</span>(o.total_amount), <span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> avg_order_value,
    <span class="hljs-keyword">MAX</span>(o.order_date) <span class="hljs-keyword">AS</span> last_order_date,
    <span class="hljs-keyword">RANK</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(o.total_amount), <span class="hljs-number">0</span>) <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> spending_rank
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name, c.email, c.status, c.created_at;

<span class="hljs-comment">-- Product performance view</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> product_performance <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    p.sku,
    c.category_name,
    p.price,
    p.stock_quantity,
    <span class="hljs-keyword">COUNT</span>(oi.order_item_id) <span class="hljs-keyword">AS</span> times_ordered,
    <span class="hljs-keyword">SUM</span>(oi.quantity) <span class="hljs-keyword">AS</span> total_quantity_sold,
    <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">AS</span> total_revenue,
    <span class="hljs-keyword">AVG</span>(oi.unit_price) <span class="hljs-keyword">AS</span> avg_selling_price,
    (p.price - <span class="hljs-keyword">AVG</span>(oi.unit_price)) <span class="hljs-keyword">AS</span> avg_discount,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COUNT</span>(oi.order_item_id) = <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Never Ordered'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COUNT</span>(oi.order_item_id) &lt; <span class="hljs-number">5</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Low Demand'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COUNT</span>(oi.order_item_id) &lt; <span class="hljs-number">20</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Medium Demand'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'High Demand'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> demand_category
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> p.product_id = oi.product_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> p.product_id, p.product_name, p.sku, c.category_name, p.price, p.stock_quantity;

<span class="hljs-comment">-- Monthly sales summary view</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> monthly_sales_summary <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    DATE_TRUNC(<span class="hljs-string">'month'</span>, o.order_date) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">month</span>,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.order_id) <span class="hljs-keyword">AS</span> total_orders,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.customer_id) <span class="hljs-keyword">AS</span> unique_customers,
    <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">AS</span> total_revenue,
    <span class="hljs-keyword">AVG</span>(o.total_amount) <span class="hljs-keyword">AS</span> avg_order_value,
    <span class="hljs-keyword">SUM</span>(oi.quantity) <span class="hljs-keyword">AS</span> total_items_sold,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> oi.product_id) <span class="hljs-keyword">AS</span> unique_products_sold
<span class="hljs-keyword">FROM</span> orders o
<span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> o.order_id = oi.order_id
<span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> DATE_TRUNC(<span class="hljs-string">'month'</span>, o.order_date)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>;
</div></code></pre>
<h3 id="updatable-views">Updatable Views</h3>
<p><strong>MySQL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Simple updatable view</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> active_customers <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    customer_id,
    first_name,
    last_name,
    email,
    phone,
    <span class="hljs-keyword">status</span>
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">WITH</span> <span class="hljs-keyword">CHECK</span> <span class="hljs-keyword">OPTION</span>;

<span class="hljs-comment">-- Update through view</span>
<span class="hljs-keyword">UPDATE</span> active_customers
<span class="hljs-keyword">SET</span> phone = <span class="hljs-string">'555-0123'</span>
<span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">1</span>;

<span class="hljs-comment">-- Insert through view (will enforce WHERE condition due to WITH CHECK OPTION)</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> active_customers (first_name, last_name, email, <span class="hljs-keyword">status</span>)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'John'</span>, <span class="hljs-string">'Doe'</span>, <span class="hljs-string">'john.doe@email.com'</span>, <span class="hljs-string">'active'</span>);

<span class="hljs-comment">-- This would fail due to WITH CHECK OPTION</span>
<span class="hljs-comment">-- INSERT INTO active_customers (first_name, last_name, email, status)</span>
<span class="hljs-comment">-- VALUES ('Jane', 'Smith', 'jane@email.com', 'inactive');</span>

<span class="hljs-comment">-- View with calculated columns (not updatable)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> customer_stats <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    customer_id,
    first_name,
    last_name,
    email,
    (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> customer_id = c.customer_id) <span class="hljs-keyword">AS</span> order_count,
    (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> customer_id = c.customer_id) <span class="hljs-keyword">AS</span> total_spent
<span class="hljs-keyword">FROM</span> customers c;

<span class="hljs-comment">-- This view is not updatable due to subqueries</span>
</div></code></pre>
<p><strong>PostgreSQL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Updatable view with rules</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> active_products <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    product_id,
    product_name,
    sku,
    price,
    stock_quantity,
    category_id
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>;

<span class="hljs-comment">-- Create rules for complex update behavior</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> RULE active_products_update <span class="hljs-keyword">AS</span>
    <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">TO</span> active_products
    <span class="hljs-keyword">DO</span> INSTEAD
    <span class="hljs-keyword">UPDATE</span> products
    <span class="hljs-keyword">SET</span>
        product_name = NEW.product_name,
        sku = NEW.sku,
        price = NEW.price,
        stock_quantity = NEW.stock_quantity,
        category_id = NEW.category_id,
        updated_at = <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
    <span class="hljs-keyword">WHERE</span> product_id = OLD.product_id
      <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> RULE active_products_insert <span class="hljs-keyword">AS</span>
    <span class="hljs-keyword">ON</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">TO</span> active_products
    <span class="hljs-keyword">DO</span> INSTEAD
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> products (product_name, sku, price, stock_quantity, category_id, <span class="hljs-keyword">status</span>, created_at)
    <span class="hljs-keyword">VALUES</span> (NEW.product_name, NEW.sku, NEW.price, NEW.stock_quantity, NEW.category_id, <span class="hljs-string">'active'</span>, <span class="hljs-keyword">CURRENT_TIMESTAMP</span>);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> RULE active_products_delete <span class="hljs-keyword">AS</span>
    <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">TO</span> active_products
    <span class="hljs-keyword">DO</span> INSTEAD
    <span class="hljs-keyword">UPDATE</span> products
    <span class="hljs-keyword">SET</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'inactive'</span>, updated_at = <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
    <span class="hljs-keyword">WHERE</span> product_id = OLD.product_id;

<span class="hljs-comment">-- Using the updatable view</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> active_products (product_name, sku, price, stock_quantity, category_id)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'New Product'</span>, <span class="hljs-string">'NP001'</span>, <span class="hljs-number">29.99</span>, <span class="hljs-number">100</span>, <span class="hljs-number">1</span>);

<span class="hljs-keyword">UPDATE</span> active_products
<span class="hljs-keyword">SET</span> price = <span class="hljs-number">24.99</span>
<span class="hljs-keyword">WHERE</span> sku = <span class="hljs-string">'NP001'</span>;

<span class="hljs-comment">-- "Delete" (actually sets status to inactive)</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> active_products <span class="hljs-keyword">WHERE</span> sku = <span class="hljs-string">'NP001'</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%84-common-table-expressions-ctes">ğŸ”„ Common Table Expressions (CTEs)</h2>
<h3 id="non-recursive-ctes">Non-Recursive CTEs</h3>
<p><strong>MySQL 8.0+ and PostgreSQL:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Single CTE for customer segmentation</span>
<span class="hljs-keyword">WITH</span> customer_segments <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        c.customer_id,
        c.first_name,
        c.last_name,
        c.email,
        <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">AS</span> order_count,
        <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">AS</span> total_spent,
        <span class="hljs-keyword">CASE</span>
            <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">SUM</span>(o.total_amount) &gt;= <span class="hljs-number">1000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'VIP'</span>
            <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">SUM</span>(o.total_amount) &gt;= <span class="hljs-number">500</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Premium'</span>
            <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">SUM</span>(o.total_amount) &gt;= <span class="hljs-number">100</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Regular'</span>
            <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'New'</span>
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">segment</span>
    <span class="hljs-keyword">FROM</span> customers c
    <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name, c.email
)
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">segment</span>,
    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">AS</span> customer_count,
    <span class="hljs-keyword">AVG</span>(total_spent) <span class="hljs-keyword">AS</span> avg_spent,
    <span class="hljs-keyword">MIN</span>(total_spent) <span class="hljs-keyword">AS</span> min_spent,
    <span class="hljs-keyword">MAX</span>(total_spent) <span class="hljs-keyword">AS</span> max_spent
<span class="hljs-keyword">FROM</span> customer_segments
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">segment</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> avg_spent <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Multiple CTEs for complex analysis</span>
<span class="hljs-keyword">WITH</span>
<span class="hljs-comment">-- CTE 1: Monthly sales</span>
monthly_sales <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        <span class="hljs-keyword">DATE_FORMAT</span>(order_date, <span class="hljs-string">'%Y-%m'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">month</span>,
        <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">AS</span> monthly_revenue,
        <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">AS</span> monthly_orders
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
      <span class="hljs-keyword">AND</span> order_date &gt;= <span class="hljs-keyword">DATE_SUB</span>(<span class="hljs-keyword">CURDATE</span>(), <span class="hljs-built_in">INTERVAL</span> <span class="hljs-number">12</span> <span class="hljs-keyword">MONTH</span>)
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">DATE_FORMAT</span>(order_date, <span class="hljs-string">'%Y-%m'</span>)
),
<span class="hljs-comment">-- CTE 2: Product categories performance</span>
category_performance <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        c.category_name,
        <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">AS</span> category_revenue,
        <span class="hljs-keyword">SUM</span>(oi.quantity) <span class="hljs-keyword">AS</span> items_sold
    <span class="hljs-keyword">FROM</span> categories c
    <span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> c.category_id = p.category_id
    <span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> p.product_id = oi.product_id
    <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
    <span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
      <span class="hljs-keyword">AND</span> o.order_date &gt;= <span class="hljs-keyword">DATE_SUB</span>(<span class="hljs-keyword">CURDATE</span>(), <span class="hljs-built_in">INTERVAL</span> <span class="hljs-number">12</span> <span class="hljs-keyword">MONTH</span>)
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.category_id, c.category_name
),
<span class="hljs-comment">-- CTE 3: Customer acquisition by month</span>
customer_acquisition <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        <span class="hljs-keyword">DATE_FORMAT</span>(created_at, <span class="hljs-string">'%Y-%m'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">month</span>,
        <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">AS</span> new_customers
    <span class="hljs-keyword">FROM</span> customers
    <span class="hljs-keyword">WHERE</span> created_at &gt;= <span class="hljs-keyword">DATE_SUB</span>(<span class="hljs-keyword">CURDATE</span>(), <span class="hljs-built_in">INTERVAL</span> <span class="hljs-number">12</span> <span class="hljs-keyword">MONTH</span>)
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">DATE_FORMAT</span>(created_at, <span class="hljs-string">'%Y-%m'</span>)
)
<span class="hljs-comment">-- Main query combining all CTEs</span>
<span class="hljs-keyword">SELECT</span>
    ms.month,
    ms.monthly_revenue,
    ms.monthly_orders,
    ca.new_customers,
    <span class="hljs-keyword">ROUND</span>(ms.monthly_revenue / ms.monthly_orders, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> avg_order_value,
    <span class="hljs-keyword">ROUND</span>(ms.monthly_revenue / ca.new_customers, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> revenue_per_new_customer
<span class="hljs-keyword">FROM</span> monthly_sales ms
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> customer_acquisition ca <span class="hljs-keyword">ON</span> ms.month = ca.month
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ms.month;

<span class="hljs-comment">-- CTE for window function calculations</span>
<span class="hljs-keyword">WITH</span> sales_with_running_totals <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        order_date,
        total_amount,
        <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">OVER</span> (
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date
            <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">PRECEDING</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">ROW</span>
        ) <span class="hljs-keyword">AS</span> running_total,
        <span class="hljs-keyword">AVG</span>(total_amount) <span class="hljs-keyword">OVER</span> (
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date
            <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">6</span> <span class="hljs-keyword">PRECEDING</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">ROW</span>
        ) <span class="hljs-keyword">AS</span> moving_avg_7_days,
        LAG(total_amount, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date) <span class="hljs-keyword">AS</span> prev_day_sales,
        <span class="hljs-keyword">LEAD</span>(total_amount, <span class="hljs-number">1</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date) <span class="hljs-keyword">AS</span> next_day_sales
    <span class="hljs-keyword">FROM</span> (
        <span class="hljs-keyword">SELECT</span>
            <span class="hljs-built_in">DATE</span>(order_date) <span class="hljs-keyword">AS</span> order_date,
            <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">AS</span> total_amount
        <span class="hljs-keyword">FROM</span> orders
        <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
        <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">DATE</span>(order_date)
    ) daily_sales
)
<span class="hljs-keyword">SELECT</span>
    order_date,
    total_amount,
    running_total,
    <span class="hljs-keyword">ROUND</span>(moving_avg_7_days, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> moving_avg_7_days,
    <span class="hljs-keyword">ROUND</span>(((total_amount - prev_day_sales) / prev_day_sales) * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> day_over_day_growth
<span class="hljs-keyword">FROM</span> sales_with_running_totals
<span class="hljs-keyword">WHERE</span> order_date &gt;= <span class="hljs-keyword">DATE_SUB</span>(<span class="hljs-keyword">CURDATE</span>(), <span class="hljs-built_in">INTERVAL</span> <span class="hljs-number">30</span> <span class="hljs-keyword">DAY</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_date;
</div></code></pre>
<h3 id="recursive-ctes">Recursive CTEs</h3>
<p><strong>Organizational Hierarchy:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Create employee hierarchy table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> employees (
    employee_id <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    first_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    last_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    title <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    manager_id <span class="hljs-built_in">INT</span>,
    salary <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    hire_date <span class="hljs-built_in">DATE</span>,
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (manager_id) <span class="hljs-keyword">REFERENCES</span> employees(employee_id)
);

<span class="hljs-comment">-- Sample data</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> employees <span class="hljs-keyword">VALUES</span>
(<span class="hljs-number">1</span>, <span class="hljs-string">'John'</span>, <span class="hljs-string">'CEO'</span>, <span class="hljs-string">'Chief Executive Officer'</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">200000</span>, <span class="hljs-string">'2020-01-01'</span>),
(<span class="hljs-number">2</span>, <span class="hljs-string">'Jane'</span>, <span class="hljs-string">'Smith'</span>, <span class="hljs-string">'VP Sales'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">150000</span>, <span class="hljs-string">'2020-02-01'</span>),
(<span class="hljs-number">3</span>, <span class="hljs-string">'Bob'</span>, <span class="hljs-string">'Johnson'</span>, <span class="hljs-string">'VP Engineering'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">160000</span>, <span class="hljs-string">'2020-02-15'</span>),
(<span class="hljs-number">4</span>, <span class="hljs-string">'Alice'</span>, <span class="hljs-string">'Brown'</span>, <span class="hljs-string">'Sales Manager'</span>, <span class="hljs-number">2</span>, <span class="hljs-number">80000</span>, <span class="hljs-string">'2020-03-01'</span>),
(<span class="hljs-number">5</span>, <span class="hljs-string">'Charlie'</span>, <span class="hljs-string">'Davis'</span>, <span class="hljs-string">'Senior Developer'</span>, <span class="hljs-number">3</span>, <span class="hljs-number">90000</span>, <span class="hljs-string">'2020-03-15'</span>),
(<span class="hljs-number">6</span>, <span class="hljs-string">'Diana'</span>, <span class="hljs-string">'Wilson'</span>, <span class="hljs-string">'Sales Rep'</span>, <span class="hljs-number">4</span>, <span class="hljs-number">50000</span>, <span class="hljs-string">'2020-04-01'</span>),
(<span class="hljs-number">7</span>, <span class="hljs-string">'Eve'</span>, <span class="hljs-string">'Miller'</span>, <span class="hljs-string">'Junior Developer'</span>, <span class="hljs-number">5</span>, <span class="hljs-number">60000</span>, <span class="hljs-string">'2020-05-01'</span>);

<span class="hljs-comment">-- Recursive CTE to get full hierarchy</span>
<span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> employee_hierarchy <span class="hljs-keyword">AS</span> (
    <span class="hljs-comment">-- Base case: top-level employees (CEOs)</span>
    <span class="hljs-keyword">SELECT</span>
        employee_id,
        first_name,
        last_name,
        title,
        manager_id,
        salary,
        <span class="hljs-number">0</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">level</span>,
        <span class="hljs-keyword">CAST</span>(first_name || <span class="hljs-string">' '</span> || last_name <span class="hljs-keyword">AS</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">1000</span>)) <span class="hljs-keyword">AS</span> hierarchy_path,
        <span class="hljs-keyword">CAST</span>(employee_id <span class="hljs-keyword">AS</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">1000</span>)) <span class="hljs-keyword">AS</span> id_path
    <span class="hljs-keyword">FROM</span> employees
    <span class="hljs-keyword">WHERE</span> manager_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>

    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>

    <span class="hljs-comment">-- Recursive case: employees with managers</span>
    <span class="hljs-keyword">SELECT</span>
        e.employee_id,
        e.first_name,
        e.last_name,
        e.title,
        e.manager_id,
        e.salary,
        eh.level + <span class="hljs-number">1</span>,
        eh.hierarchy_path || <span class="hljs-string">' -&gt; '</span> || e.first_name || <span class="hljs-string">' '</span> || e.last_name,
        eh.id_path || <span class="hljs-string">','</span> || e.employee_id
    <span class="hljs-keyword">FROM</span> employees e
    <span class="hljs-keyword">JOIN</span> employee_hierarchy eh <span class="hljs-keyword">ON</span> e.manager_id = eh.employee_id
)
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">REPEAT</span>(<span class="hljs-string">'  '</span>, <span class="hljs-keyword">level</span>) || first_name || <span class="hljs-string">' '</span> || last_name <span class="hljs-keyword">AS</span> indented_name,
    title,
    salary,
    <span class="hljs-keyword">level</span>,
    hierarchy_path
<span class="hljs-keyword">FROM</span> employee_hierarchy
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> id_path;

<span class="hljs-comment">-- Get all subordinates of a specific manager</span>
<span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> subordinates <span class="hljs-keyword">AS</span> (
    <span class="hljs-comment">-- Start with the manager</span>
    <span class="hljs-keyword">SELECT</span>
        employee_id,
        first_name,
        last_name,
        title,
        manager_id,
        salary,
        <span class="hljs-number">0</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">level</span>
    <span class="hljs-keyword">FROM</span> employees
    <span class="hljs-keyword">WHERE</span> employee_id = <span class="hljs-number">2</span>  <span class="hljs-comment">-- VP Sales</span>

    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>

    <span class="hljs-comment">-- Get all direct and indirect reports</span>
    <span class="hljs-keyword">SELECT</span>
        e.employee_id,
        e.first_name,
        e.last_name,
        e.title,
        e.manager_id,
        e.salary,
        s.level + <span class="hljs-number">1</span>
    <span class="hljs-keyword">FROM</span> employees e
    <span class="hljs-keyword">JOIN</span> subordinates s <span class="hljs-keyword">ON</span> e.manager_id = s.employee_id
)
<span class="hljs-keyword">SELECT</span>
    first_name || <span class="hljs-string">' '</span> || last_name <span class="hljs-keyword">AS</span> <span class="hljs-keyword">name</span>,
    title,
    salary,
    <span class="hljs-keyword">level</span>,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">level</span> = <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Manager'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">level</span> = <span class="hljs-number">1</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Direct Report'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Indirect Report (Level '</span> || <span class="hljs-keyword">level</span> || <span class="hljs-string">')'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> relationship
<span class="hljs-keyword">FROM</span> subordinates
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">level</span>, last_name;

<span class="hljs-comment">-- Calculate total team salary for each manager</span>
<span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> team_hierarchy <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        employee_id,
        first_name,
        last_name,
        title,
        manager_id,
        salary,
        employee_id <span class="hljs-keyword">AS</span> root_manager
    <span class="hljs-keyword">FROM</span> employees
    <span class="hljs-keyword">WHERE</span> manager_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>

    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>

    <span class="hljs-keyword">SELECT</span>
        e.employee_id,
        e.first_name,
        e.last_name,
        e.title,
        e.manager_id,
        e.salary,
        th.root_manager
    <span class="hljs-keyword">FROM</span> employees e
    <span class="hljs-keyword">JOIN</span> team_hierarchy th <span class="hljs-keyword">ON</span> e.manager_id = th.employee_id
)
<span class="hljs-keyword">SELECT</span>
    m.first_name || <span class="hljs-string">' '</span> || m.last_name <span class="hljs-keyword">AS</span> manager_name,
    m.title <span class="hljs-keyword">AS</span> manager_title,
    <span class="hljs-keyword">COUNT</span>(th.employee_id) - <span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> team_size,  <span class="hljs-comment">-- Subtract 1 to exclude manager</span>
    <span class="hljs-keyword">SUM</span>(th.salary) <span class="hljs-keyword">AS</span> total_team_salary,
    <span class="hljs-keyword">AVG</span>(th.salary) <span class="hljs-keyword">AS</span> avg_team_salary,
    m.salary <span class="hljs-keyword">AS</span> manager_salary
<span class="hljs-keyword">FROM</span> team_hierarchy th
<span class="hljs-keyword">JOIN</span> employees m <span class="hljs-keyword">ON</span> th.root_manager = m.employee_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> m.employee_id, m.first_name, m.last_name, m.title, m.salary
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_team_salary <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<p><strong>Category Tree Navigation:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Create category hierarchy table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> category_tree (
    category_id <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    category_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    parent_category_id <span class="hljs-built_in">INT</span>,
    sort_order <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (parent_category_id) <span class="hljs-keyword">REFERENCES</span> category_tree(category_id)
);

<span class="hljs-comment">-- Sample hierarchical categories</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> category_tree <span class="hljs-keyword">VALUES</span>
(<span class="hljs-number">1</span>, <span class="hljs-string">'Electronics'</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>),
(<span class="hljs-number">2</span>, <span class="hljs-string">'Clothing'</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">2</span>),
(<span class="hljs-number">3</span>, <span class="hljs-string">'Home &amp; Garden'</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">3</span>),
(<span class="hljs-number">4</span>, <span class="hljs-string">'Computers'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>),
(<span class="hljs-number">5</span>, <span class="hljs-string">'Mobile Phones'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>),
(<span class="hljs-number">6</span>, <span class="hljs-string">'Audio'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>),
(<span class="hljs-number">7</span>, <span class="hljs-string">'Laptops'</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>),
(<span class="hljs-number">8</span>, <span class="hljs-string">'Desktops'</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>),
(<span class="hljs-number">9</span>, <span class="hljs-string">'Gaming Laptops'</span>, <span class="hljs-number">7</span>, <span class="hljs-number">1</span>),
(<span class="hljs-number">10</span>, <span class="hljs-string">'Business Laptops'</span>, <span class="hljs-number">7</span>, <span class="hljs-number">2</span>),
(<span class="hljs-number">11</span>, <span class="hljs-string">'Men\'</span>s Clothing<span class="hljs-string">', 2, 1),
(12, '</span>Women\<span class="hljs-string">'s Clothing'</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>),
(<span class="hljs-number">13</span>, <span class="hljs-string">'Shirts'</span>, <span class="hljs-number">11</span>, <span class="hljs-number">1</span>),
(<span class="hljs-number">14</span>, <span class="hljs-string">'Pants'</span>, <span class="hljs-number">11</span>, <span class="hljs-number">2</span>);

<span class="hljs-comment">-- Get full category tree with breadcrumbs</span>
<span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> category_breadcrumbs <span class="hljs-keyword">AS</span> (
    <span class="hljs-comment">-- Root categories</span>
    <span class="hljs-keyword">SELECT</span>
        category_id,
        category_name,
        parent_category_id,
        sort_order,
        <span class="hljs-number">0</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">level</span>,
        category_name <span class="hljs-keyword">AS</span> breadcrumb,
        <span class="hljs-keyword">LPAD</span>(<span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'  '</span>) || category_name <span class="hljs-keyword">AS</span> indented_name,
        <span class="hljs-keyword">CAST</span>(sort_order <span class="hljs-keyword">AS</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">1000</span>)) <span class="hljs-keyword">AS</span> sort_path
    <span class="hljs-keyword">FROM</span> category_tree
    <span class="hljs-keyword">WHERE</span> parent_category_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>

    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>

    <span class="hljs-comment">-- Child categories</span>
    <span class="hljs-keyword">SELECT</span>
        ct.category_id,
        ct.category_name,
        ct.parent_category_id,
        ct.sort_order,
        cb.level + <span class="hljs-number">1</span>,
        cb.breadcrumb || <span class="hljs-string">' &gt; '</span> || ct.category_name,
        <span class="hljs-keyword">LPAD</span>(<span class="hljs-string">''</span>, (cb.level + <span class="hljs-number">1</span>) * <span class="hljs-number">2</span>, <span class="hljs-string">'  '</span>) || ct.category_name,
        cb.sort_path || <span class="hljs-string">'.'</span> || <span class="hljs-keyword">LPAD</span>(ct.sort_order::<span class="hljs-built_in">TEXT</span>, <span class="hljs-number">3</span>, <span class="hljs-string">'0'</span>)
    <span class="hljs-keyword">FROM</span> category_tree ct
    <span class="hljs-keyword">JOIN</span> category_breadcrumbs cb <span class="hljs-keyword">ON</span> ct.parent_category_id = cb.category_id
)
<span class="hljs-keyword">SELECT</span>
    category_id,
    indented_name <span class="hljs-keyword">AS</span> category_hierarchy,
    breadcrumb,
    <span class="hljs-keyword">level</span>
<span class="hljs-keyword">FROM</span> category_breadcrumbs
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sort_path;

<span class="hljs-comment">-- Find all products in a category and its subcategories</span>
<span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> category_descendants <span class="hljs-keyword">AS</span> (
    <span class="hljs-comment">-- Start with specific category</span>
    <span class="hljs-keyword">SELECT</span> category_id
    <span class="hljs-keyword">FROM</span> category_tree
    <span class="hljs-keyword">WHERE</span> category_id = <span class="hljs-number">1</span>  <span class="hljs-comment">-- Electronics</span>

    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>

    <span class="hljs-comment">-- Get all descendant categories</span>
    <span class="hljs-keyword">SELECT</span> ct.category_id
    <span class="hljs-keyword">FROM</span> category_tree ct
    <span class="hljs-keyword">JOIN</span> category_descendants cd <span class="hljs-keyword">ON</span> ct.parent_category_id = cd.category_id
)
<span class="hljs-keyword">SELECT</span>
    p.product_id,
    p.product_name,
    p.price,
    ct.category_name,
    cb.breadcrumb <span class="hljs-keyword">AS</span> category_path
<span class="hljs-keyword">FROM</span> products p
<span class="hljs-keyword">JOIN</span> category_descendants cd <span class="hljs-keyword">ON</span> p.category_id = cd.category_id
<span class="hljs-keyword">JOIN</span> category_tree ct <span class="hljs-keyword">ON</span> p.category_id = ct.category_id
<span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> category_breadcrumbs <span class="hljs-keyword">AS</span> (
        <span class="hljs-keyword">SELECT</span>
            category_id,
            category_name,
            parent_category_id,
            category_name <span class="hljs-keyword">AS</span> breadcrumb
        <span class="hljs-keyword">FROM</span> category_tree
        <span class="hljs-keyword">WHERE</span> parent_category_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>

        <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>

        <span class="hljs-keyword">SELECT</span>
            ct.category_id,
            ct.category_name,
            ct.parent_category_id,
            cb.breadcrumb || <span class="hljs-string">' &gt; '</span> || ct.category_name
        <span class="hljs-keyword">FROM</span> category_tree ct
        <span class="hljs-keyword">JOIN</span> category_breadcrumbs cb <span class="hljs-keyword">ON</span> ct.parent_category_id = cb.category_id
    )
    <span class="hljs-keyword">SELECT</span> category_id, breadcrumb <span class="hljs-keyword">FROM</span> category_breadcrumbs
) cb <span class="hljs-keyword">ON</span> p.category_id = cb.category_id
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> cb.breadcrumb, p.product_name;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8F%97%EF%B8%8F-materialized-views-postgresql">ğŸ—ï¸ Materialized Views (PostgreSQL)</h2>
<pre class="hljs"><code><div><span class="hljs-comment">-- Create materialized view for expensive analytics</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">MATERIALIZED</span> <span class="hljs-keyword">VIEW</span> customer_analytics_materialized <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name || <span class="hljs-string">' '</span> || c.last_name <span class="hljs-keyword">AS</span> full_name,
    c.email,
    c.created_at <span class="hljs-keyword">AS</span> registration_date,
    <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">AS</span> total_orders,
    <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(o.total_amount), <span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> lifetime_value,
    <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">AVG</span>(o.total_amount), <span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> avg_order_value,
    <span class="hljs-keyword">MAX</span>(o.order_date) <span class="hljs-keyword">AS</span> last_order_date,
    <span class="hljs-keyword">MIN</span>(o.order_date) <span class="hljs-keyword">AS</span> first_order_date,
    <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">DAYS</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">MAX</span>(o.order_date) - <span class="hljs-keyword">MIN</span>(o.order_date))) <span class="hljs-keyword">AS</span> customer_lifespan_days,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> DATE_TRUNC(<span class="hljs-string">'month'</span>, o.order_date)) <span class="hljs-keyword">AS</span> active_months,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COUNT</span>(o.order_id) = <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Never Purchased'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">MAX</span>(o.order_date) &lt; <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 months'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Inactive'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COUNT</span>(o.order_id) = <span class="hljs-number">1</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'One-time Buyer'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">2</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">5</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Occasional Buyer'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">6</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">15</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Regular Customer'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'VIP Customer'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> customer_segment,
    <span class="hljs-comment">-- RFM Analysis components</span>
    <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">DAYS</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-keyword">MAX</span>(o.order_date))) <span class="hljs-keyword">AS</span> recency_days,
    <span class="hljs-keyword">COUNT</span>(o.order_id) <span class="hljs-keyword">AS</span> frequency,
    <span class="hljs-keyword">COALESCE</span>(<span class="hljs-keyword">SUM</span>(o.total_amount), <span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> monetary
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.customer_id = o.customer_id <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.customer_id, c.first_name, c.last_name, c.email, c.created_at;

<span class="hljs-comment">-- Create index on materialized view</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_customer_analytics_segment <span class="hljs-keyword">ON</span> customer_analytics_materialized(customer_segment);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_customer_analytics_ltv <span class="hljs-keyword">ON</span> customer_analytics_materialized(lifetime_value);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_customer_analytics_recency <span class="hljs-keyword">ON</span> customer_analytics_materialized(recency_days);

<span class="hljs-comment">-- Refresh materialized view</span>
REFRESH MATERIALIZED VIEW customer_analytics_materialized;

<span class="hljs-comment">-- Concurrent refresh (non-blocking)</span>
REFRESH MATERIALIZED VIEW CONCURRENTLY customer_analytics_materialized;

<span class="hljs-comment">-- Create materialized view for product recommendations</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">MATERIALIZED</span> <span class="hljs-keyword">VIEW</span> product_recommendations <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">WITH</span> product_pairs <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        oi1.product_id <span class="hljs-keyword">AS</span> product_a,
        oi2.product_id <span class="hljs-keyword">AS</span> product_b,
        <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">AS</span> co_occurrence_count
    <span class="hljs-keyword">FROM</span> order_items oi1
    <span class="hljs-keyword">JOIN</span> order_items oi2 <span class="hljs-keyword">ON</span> oi1.order_id = oi2.order_id
    <span class="hljs-keyword">WHERE</span> oi1.product_id &lt; oi2.product_id  <span class="hljs-comment">-- Avoid duplicates</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> oi1.product_id, oi2.product_id
    <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">COUNT</span>(*) &gt;= <span class="hljs-number">3</span>  <span class="hljs-comment">-- Minimum co-occurrence threshold</span>
),
product_stats <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        product_id,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> order_id) <span class="hljs-keyword">AS</span> total_orders
    <span class="hljs-keyword">FROM</span> order_items
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> product_id
)
<span class="hljs-keyword">SELECT</span>
    pp.product_a,
    pa.product_name <span class="hljs-keyword">AS</span> product_a_name,
    pp.product_b,
    pb.product_name <span class="hljs-keyword">AS</span> product_b_name,
    pp.co_occurrence_count,
    psa.total_orders <span class="hljs-keyword">AS</span> product_a_orders,
    psb.total_orders <span class="hljs-keyword">AS</span> product_b_orders,
    <span class="hljs-keyword">ROUND</span>(
        pp.co_occurrence_count::<span class="hljs-built_in">DECIMAL</span> / <span class="hljs-keyword">LEAST</span>(psa.total_orders, psb.total_orders),
        <span class="hljs-number">3</span>
    ) <span class="hljs-keyword">AS</span> confidence_score,
    <span class="hljs-keyword">ROUND</span>(
        pp.co_occurrence_count::<span class="hljs-built_in">DECIMAL</span> / (psa.total_orders + psb.total_orders - pp.co_occurrence_count),
        <span class="hljs-number">3</span>
    ) <span class="hljs-keyword">AS</span> jaccard_similarity
<span class="hljs-keyword">FROM</span> product_pairs pp
<span class="hljs-keyword">JOIN</span> products pa <span class="hljs-keyword">ON</span> pp.product_a = pa.product_id
<span class="hljs-keyword">JOIN</span> products pb <span class="hljs-keyword">ON</span> pp.product_b = pb.product_id
<span class="hljs-keyword">JOIN</span> product_stats psa <span class="hljs-keyword">ON</span> pp.product_a = psa.product_id
<span class="hljs-keyword">JOIN</span> product_stats psb <span class="hljs-keyword">ON</span> pp.product_b = psb.product_id
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> confidence_score <span class="hljs-keyword">DESC</span>, co_occurrence_count <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Schedule automatic refresh using pg_cron</span>
<span class="hljs-keyword">SELECT</span> cron.schedule(<span class="hljs-string">'refresh-analytics'</span>, <span class="hljs-string">'0 2 * * *'</span>,
    <span class="hljs-string">'REFRESH MATERIALIZED VIEW CONCURRENTLY customer_analytics_materialized;'</span>);

<span class="hljs-keyword">SELECT</span> cron.schedule(<span class="hljs-string">'refresh-recommendations'</span>, <span class="hljs-string">'0 3 * * 0'</span>,
    <span class="hljs-string">'REFRESH MATERIALIZED VIEW CONCURRENTLY product_recommendations;'</span>);
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%92-security-views">ğŸ”’ Security Views</h2>
<pre class="hljs"><code><div><span class="hljs-comment">-- PostgreSQL Row Level Security with Views</span>

<span class="hljs-comment">-- Create user roles</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> sales_manager;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> sales_rep;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> customer_service;

<span class="hljs-comment">-- Create secure customer view for customer service</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> customer_service_view <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    customer_id,
    first_name,
    last_name,
    email,
    phone,
    <span class="hljs-keyword">status</span>,
    created_at,
    <span class="hljs-comment">-- Mask sensitive information</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">LENGTH</span>(phone) &gt;= <span class="hljs-number">10</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-keyword">SUBSTRING</span>(phone, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>) || <span class="hljs-string">'-XXX-'</span> || <span class="hljs-keyword">SUBSTRING</span>(phone, <span class="hljs-number">-4</span>)
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'XXX-XXXX'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> masked_phone
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'active'</span>, <span class="hljs-string">'inactive'</span>);  <span class="hljs-comment">-- Exclude deleted customers</span>

<span class="hljs-comment">-- Grant appropriate permissions</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> customer_service_view <span class="hljs-keyword">TO</span> customer_service;

<span class="hljs-comment">-- Create sales view with territory restrictions</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> sales_territory_view <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    o.order_id,
    o.order_date,
    o.status,
    o.total_amount,
    c.customer_id,
    c.first_name || <span class="hljs-string">' '</span> || c.last_name <span class="hljs-keyword">AS</span> customer_name,
    c.email,
    c.territory,
    u.username <span class="hljs-keyword">AS</span> sales_rep
<span class="hljs-keyword">FROM</span> orders o
<span class="hljs-keyword">JOIN</span> customers c <span class="hljs-keyword">ON</span> o.customer_id = c.customer_id
<span class="hljs-keyword">JOIN</span> <span class="hljs-keyword">users</span> u <span class="hljs-keyword">ON</span> o.sales_rep_id = u.user_id
<span class="hljs-keyword">WHERE</span>
    <span class="hljs-comment">-- Only show orders for current user's territory</span>
    c.territory = <span class="hljs-keyword">COALESCE</span>(
        (<span class="hljs-keyword">SELECT</span> territory <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> username = <span class="hljs-keyword">current_user</span>),
        c.territory  <span class="hljs-comment">-- Fallback for managers</span>
    )
    <span class="hljs-keyword">OR</span>
    <span class="hljs-comment">-- Or if user is a manager</span>
    <span class="hljs-keyword">EXISTS</span> (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span>
        <span class="hljs-keyword">WHERE</span> username = <span class="hljs-keyword">current_user</span>
          <span class="hljs-keyword">AND</span> <span class="hljs-keyword">role</span> = <span class="hljs-string">'sales_manager'</span>
    );

<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> sales_territory_view <span class="hljs-keyword">TO</span> sales_rep, sales_manager;

<span class="hljs-comment">-- Create financial summary view for managers only</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> financial_summary_view <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    DATE_TRUNC(<span class="hljs-string">'month'</span>, order_date) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">month</span>,
    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">AS</span> total_orders,
    <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">AS</span> total_revenue,
    <span class="hljs-keyword">AVG</span>(total_amount) <span class="hljs-keyword">AS</span> avg_order_value,
    <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span> <span class="hljs-keyword">THEN</span> total_amount <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> completed_revenue,
    <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'cancelled'</span> <span class="hljs-keyword">THEN</span> total_amount <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> cancelled_revenue,
    <span class="hljs-keyword">ROUND</span>(
        <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span> <span class="hljs-keyword">THEN</span> total_amount <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) /
        <span class="hljs-keyword">NULLIF</span>(<span class="hljs-keyword">SUM</span>(total_amount), <span class="hljs-number">0</span>) * <span class="hljs-number">100</span>,
        <span class="hljs-number">2</span>
    ) <span class="hljs-keyword">AS</span> completion_rate
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> order_date &gt;= DATE_TRUNC(<span class="hljs-string">'year'</span>, <span class="hljs-keyword">CURRENT_DATE</span>)
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> DATE_TRUNC(<span class="hljs-string">'month'</span>, order_date)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">month</span>;

<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> financial_summary_view <span class="hljs-keyword">TO</span> sales_manager;

<span class="hljs-comment">-- MySQL equivalent using views for security</span>
<span class="hljs-comment">-- (MySQL doesn't have RLS, so we use application-level security)</span>

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> mysql_customer_service_view <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    customer_id,
    first_name,
    last_name,
    email,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">CHAR_LENGTH</span>(phone) &gt;= <span class="hljs-number">10</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-keyword">CONCAT</span>(<span class="hljs-keyword">LEFT</span>(phone, <span class="hljs-number">3</span>), <span class="hljs-string">'-XXX-'</span>, <span class="hljs-keyword">RIGHT</span>(phone, <span class="hljs-number">4</span>))
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'XXX-XXXX'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> masked_phone,
    <span class="hljs-keyword">status</span>,
    created_at
<span class="hljs-keyword">FROM</span> customers
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'active'</span>, <span class="hljs-string">'inactive'</span>);

<span class="hljs-comment">-- Create application user context table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_context (
    session_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) PRIMARY <span class="hljs-keyword">KEY</span>,
    user_id <span class="hljs-built_in">INT</span>,
    username <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    <span class="hljs-keyword">role</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    territory <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    expires_at <span class="hljs-built_in">TIMESTAMP</span>
);

<span class="hljs-comment">-- Territory-based sales view (requires application to set context)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> mysql_sales_territory_view <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    o.order_id,
    o.order_date,
    o.status,
    o.total_amount,
    c.customer_id,
    <span class="hljs-keyword">CONCAT</span>(c.first_name, <span class="hljs-string">' '</span>, c.last_name) <span class="hljs-keyword">AS</span> customer_name,
    c.email,
    c.territory
<span class="hljs-keyword">FROM</span> orders o
<span class="hljs-keyword">JOIN</span> customers c <span class="hljs-keyword">ON</span> o.customer_id = c.customer_id
<span class="hljs-keyword">JOIN</span> user_context uc <span class="hljs-keyword">ON</span> uc.expires_at &gt; <span class="hljs-keyword">NOW</span>()
<span class="hljs-keyword">WHERE</span>
    (c.territory = uc.territory <span class="hljs-keyword">OR</span> uc.role = <span class="hljs-string">'sales_manager'</span>)
    <span class="hljs-keyword">AND</span> uc.session_id = @session_id;  <span class="hljs-comment">-- Application sets this variable</span>
</div></code></pre>
<hr>
<h2 id="%F0%9F%92%A1-real-world-business-examples">ğŸ’¡ Real-World Business Examples</h2>
<h3 id="example-1-executive-dashboard-views">Example 1: Executive Dashboard Views</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- PostgreSQL: Comprehensive executive dashboard</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> executive_dashboard <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">WITH</span>
<span class="hljs-comment">-- Current month metrics</span>
current_month <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.order_id) <span class="hljs-keyword">AS</span> orders_this_month,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.customer_id) <span class="hljs-keyword">AS</span> customers_this_month,
        <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">AS</span> revenue_this_month,
        <span class="hljs-keyword">AVG</span>(o.total_amount) <span class="hljs-keyword">AS</span> avg_order_this_month
    <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">WHERE</span> DATE_TRUNC(<span class="hljs-string">'month'</span>, o.order_date) = DATE_TRUNC(<span class="hljs-string">'month'</span>, <span class="hljs-keyword">CURRENT_DATE</span>)
      <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
),
<span class="hljs-comment">-- Previous month metrics</span>
previous_month <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.order_id) <span class="hljs-keyword">AS</span> orders_last_month,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.customer_id) <span class="hljs-keyword">AS</span> customers_last_month,
        <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">AS</span> revenue_last_month,
        <span class="hljs-keyword">AVG</span>(o.total_amount) <span class="hljs-keyword">AS</span> avg_order_last_month
    <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">WHERE</span> DATE_TRUNC(<span class="hljs-string">'month'</span>, o.order_date) = DATE_TRUNC(<span class="hljs-string">'month'</span>, <span class="hljs-keyword">CURRENT_DATE</span>) - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'1 month'</span>
      <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
),
<span class="hljs-comment">-- Year-to-date metrics</span>
ytd_metrics <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.order_id) <span class="hljs-keyword">AS</span> orders_ytd,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.customer_id) <span class="hljs-keyword">AS</span> customers_ytd,
        <span class="hljs-keyword">SUM</span>(o.total_amount) <span class="hljs-keyword">AS</span> revenue_ytd,
        <span class="hljs-keyword">AVG</span>(o.total_amount) <span class="hljs-keyword">AS</span> avg_order_ytd
    <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">WHERE</span> DATE_TRUNC(<span class="hljs-string">'year'</span>, o.order_date) = DATE_TRUNC(<span class="hljs-string">'year'</span>, <span class="hljs-keyword">CURRENT_DATE</span>)
      <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
),
<span class="hljs-comment">-- Customer metrics</span>
customer_metrics <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">AS</span> total_customers,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> created_at &gt;= DATE_TRUNC(<span class="hljs-string">'month'</span>, <span class="hljs-keyword">CURRENT_DATE</span>) <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> new_customers_this_month,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> active_customers
    <span class="hljs-keyword">FROM</span> customers
),
<span class="hljs-comment">-- Product metrics</span>
product_metrics <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">AS</span> total_products,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> stock_quantity = <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> out_of_stock_products,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> stock_quantity &lt; <span class="hljs-number">10</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> low_stock_products
    <span class="hljs-keyword">FROM</span> products
    <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>
)
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-comment">-- Current month</span>
    cm.orders_this_month,
    cm.customers_this_month,
    cm.revenue_this_month,
    <span class="hljs-keyword">ROUND</span>(cm.avg_order_this_month, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> avg_order_this_month,

    <span class="hljs-comment">-- Month-over-month growth</span>
    <span class="hljs-keyword">ROUND</span>(
        ((cm.orders_this_month - pm.orders_last_month)::<span class="hljs-built_in">DECIMAL</span> /
         <span class="hljs-keyword">NULLIF</span>(pm.orders_last_month, <span class="hljs-number">0</span>)) * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>
    ) <span class="hljs-keyword">AS</span> orders_mom_growth,
    <span class="hljs-keyword">ROUND</span>(
        ((cm.revenue_this_month - pm.revenue_last_month)::<span class="hljs-built_in">DECIMAL</span> /
         <span class="hljs-keyword">NULLIF</span>(pm.revenue_last_month, <span class="hljs-number">0</span>)) * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>
    ) <span class="hljs-keyword">AS</span> revenue_mom_growth,

    <span class="hljs-comment">-- Year-to-date</span>
    ytd.orders_ytd,
    ytd.revenue_ytd,
    <span class="hljs-keyword">ROUND</span>(ytd.avg_order_ytd, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> avg_order_ytd,

    <span class="hljs-comment">-- Customer metrics</span>
    cust.total_customers,
    cust.new_customers_this_month,
    cust.active_customers,
    <span class="hljs-keyword">ROUND</span>(
        (cust.active_customers::<span class="hljs-built_in">DECIMAL</span> / cust.total_customers) * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>
    ) <span class="hljs-keyword">AS</span> customer_retention_rate,

    <span class="hljs-comment">-- Product metrics</span>
    prod.total_products,
    prod.out_of_stock_products,
    prod.low_stock_products,
    <span class="hljs-keyword">ROUND</span>(
        ((prod.total_products - prod.out_of_stock_products)::<span class="hljs-built_in">DECIMAL</span> /
         prod.total_products) * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>
    ) <span class="hljs-keyword">AS</span> product_availability_rate

<span class="hljs-keyword">FROM</span> current_month cm
<span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span> previous_month pm
<span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span> ytd_metrics ytd
<span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span> customer_metrics cust
<span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span> product_metrics prod;

<span class="hljs-comment">-- Create view for top performing products</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> top_products_dashboard <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">WITH</span> product_performance <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        p.product_id,
        p.product_name,
        p.sku,
        c.category_name,
        p.price,
        p.stock_quantity,
        <span class="hljs-keyword">COUNT</span>(oi.order_item_id) <span class="hljs-keyword">AS</span> times_ordered,
        <span class="hljs-keyword">SUM</span>(oi.quantity) <span class="hljs-keyword">AS</span> total_quantity_sold,
        <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">AS</span> total_revenue,
        <span class="hljs-keyword">AVG</span>(oi.unit_price) <span class="hljs-keyword">AS</span> avg_selling_price,
        <span class="hljs-keyword">RANK</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> revenue_rank,
        <span class="hljs-keyword">RANK</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">SUM</span>(oi.quantity) <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> quantity_rank
    <span class="hljs-keyword">FROM</span> products p
    <span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
    <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> p.product_id = oi.product_id
    <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> oi.order_id = o.order_id
        <span class="hljs-keyword">AND</span> o.status = <span class="hljs-string">'completed'</span>
        <span class="hljs-keyword">AND</span> o.order_date &gt;= DATE_TRUNC(<span class="hljs-string">'month'</span>, <span class="hljs-keyword">CURRENT_DATE</span>) - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'11 months'</span>
    <span class="hljs-keyword">WHERE</span> p.status = <span class="hljs-string">'active'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> p.product_id, p.product_name, p.sku, c.category_name, p.price, p.stock_quantity
)
<span class="hljs-keyword">SELECT</span>
    product_id,
    product_name,
    sku,
    category_name,
    price,
    stock_quantity,
    times_ordered,
    total_quantity_sold,
    <span class="hljs-keyword">ROUND</span>(total_revenue, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> total_revenue,
    <span class="hljs-keyword">ROUND</span>(avg_selling_price, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> avg_selling_price,
    revenue_rank,
    quantity_rank,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> stock_quantity = <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Out of Stock'</span>
        <span class="hljs-keyword">WHEN</span> stock_quantity &lt; <span class="hljs-number">10</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Low Stock'</span>
        <span class="hljs-keyword">WHEN</span> stock_quantity &lt; <span class="hljs-number">50</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Medium Stock'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Well Stocked'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> stock_status
<span class="hljs-keyword">FROM</span> product_performance
<span class="hljs-keyword">WHERE</span> revenue_rank &lt;= <span class="hljs-number">50</span> <span class="hljs-keyword">OR</span> quantity_rank &lt;= <span class="hljs-number">50</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_revenue <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<h3 id="example-2-customer-360-view">Example 2: Customer 360 View</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Comprehensive customer 360 view</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> customer_360_view <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">WITH</span>
<span class="hljs-comment">-- Customer order history</span>
customer_orders <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        customer_id,
        <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">AS</span> total_orders,
        <span class="hljs-keyword">SUM</span>(total_amount) <span class="hljs-keyword">AS</span> lifetime_value,
        <span class="hljs-keyword">AVG</span>(total_amount) <span class="hljs-keyword">AS</span> avg_order_value,
        <span class="hljs-keyword">MIN</span>(order_date) <span class="hljs-keyword">AS</span> first_order_date,
        <span class="hljs-keyword">MAX</span>(order_date) <span class="hljs-keyword">AS</span> last_order_date,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> completed_orders,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'cancelled'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> cancelled_orders,
        <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> order_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span> <span class="hljs-keyword">THEN</span> total_amount <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> value_12m
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id
),
<span class="hljs-comment">-- Customer product preferences</span>
customer_categories <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        o.customer_id,
        c.category_name,
        <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">AS</span> category_orders,
        <span class="hljs-keyword">SUM</span>(oi.quantity * oi.unit_price) <span class="hljs-keyword">AS</span> category_spend,
        ROW_NUMBER() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> o.customer_id <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> preference_rank
    <span class="hljs-keyword">FROM</span> orders o
    <span class="hljs-keyword">JOIN</span> order_items oi <span class="hljs-keyword">ON</span> o.order_id = oi.order_id
    <span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> oi.product_id = p.product_id
    <span class="hljs-keyword">JOIN</span> categories c <span class="hljs-keyword">ON</span> p.category_id = c.category_id
    <span class="hljs-keyword">WHERE</span> o.status = <span class="hljs-string">'completed'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> o.customer_id, c.category_id, c.category_name
),
<span class="hljs-comment">-- Customer communication preferences</span>
customer_communications <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        customer_id,
        <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">AS</span> total_communications,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> communication_type = <span class="hljs-string">'email'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> email_count,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> communication_type = <span class="hljs-string">'phone'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> phone_count,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> communication_type = <span class="hljs-string">'chat'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> chat_count,
        <span class="hljs-keyword">MAX</span>(communication_date) <span class="hljs-keyword">AS</span> last_communication_date
    <span class="hljs-keyword">FROM</span> customer_communications
    <span class="hljs-keyword">WHERE</span> communication_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id
),
<span class="hljs-comment">-- Customer support tickets</span>
customer_support <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span>
        customer_id,
        <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">AS</span> total_tickets,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'resolved'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> resolved_tickets,
        <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">priority</span> = <span class="hljs-string">'high'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> high_priority_tickets,
        <span class="hljs-keyword">AVG</span>(<span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">DAYS</span> <span class="hljs-keyword">FROM</span> (resolved_date - created_date))) <span class="hljs-keyword">AS</span> avg_resolution_days
    <span class="hljs-keyword">FROM</span> support_tickets
    <span class="hljs-keyword">WHERE</span> created_date &gt;= <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id
)
<span class="hljs-keyword">SELECT</span>
    c.customer_id,
    c.first_name || <span class="hljs-string">' '</span> || c.last_name <span class="hljs-keyword">AS</span> full_name,
    c.email,
    c.phone,
    c.status,
    c.created_at <span class="hljs-keyword">AS</span> registration_date,
    <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">DAYS</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">CURRENT_DATE</span> - c.created_at)) <span class="hljs-keyword">AS</span> days_since_registration,

    <span class="hljs-comment">-- Order metrics</span>
    <span class="hljs-keyword">COALESCE</span>(co.total_orders, <span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> total_orders,
    <span class="hljs-keyword">COALESCE</span>(co.lifetime_value, <span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> lifetime_value,
    <span class="hljs-keyword">COALESCE</span>(co.avg_order_value, <span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> avg_order_value,
    co.first_order_date,
    co.last_order_date,
    <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">DAYS</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">CURRENT_DATE</span> - co.last_order_date)) <span class="hljs-keyword">AS</span> days_since_last_order,
    <span class="hljs-keyword">COALESCE</span>(co.value_12m, <span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> value_12m,

    <span class="hljs-comment">-- Customer segmentation</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> co.total_orders <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Never Purchased'</span>
        <span class="hljs-keyword">WHEN</span> co.last_order_date &lt; <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'12 months'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Inactive'</span>
        <span class="hljs-keyword">WHEN</span> co.total_orders = <span class="hljs-number">1</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'One-time Buyer'</span>
        <span class="hljs-keyword">WHEN</span> co.lifetime_value &gt;= <span class="hljs-number">1000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'VIP'</span>
        <span class="hljs-keyword">WHEN</span> co.lifetime_value &gt;= <span class="hljs-number">500</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'High Value'</span>
        <span class="hljs-keyword">WHEN</span> co.total_orders &gt;= <span class="hljs-number">5</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Loyal'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Regular'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> customer_segment,

    <span class="hljs-comment">-- Preferences</span>
    cc.category_name <span class="hljs-keyword">AS</span> preferred_category,
    cc.category_spend <span class="hljs-keyword">AS</span> preferred_category_spend,

    <span class="hljs-comment">-- Communication metrics</span>
    <span class="hljs-keyword">COALESCE</span>(comm.total_communications, <span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> total_communications,
    <span class="hljs-keyword">COALESCE</span>(comm.email_count, <span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> email_communications,
    <span class="hljs-keyword">COALESCE</span>(comm.phone_count, <span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> phone_communications,
    <span class="hljs-keyword">COALESCE</span>(comm.chat_count, <span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> chat_communications,
    comm.last_communication_date,

    <span class="hljs-comment">-- Support metrics</span>
    <span class="hljs-keyword">COALESCE</span>(cs.total_tickets, <span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> total_support_tickets,
    <span class="hljs-keyword">COALESCE</span>(cs.resolved_tickets, <span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> resolved_tickets,
    <span class="hljs-keyword">COALESCE</span>(cs.high_priority_tickets, <span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> high_priority_tickets,
    <span class="hljs-keyword">ROUND</span>(<span class="hljs-keyword">COALESCE</span>(cs.avg_resolution_days, <span class="hljs-number">0</span>), <span class="hljs-number">1</span>) <span class="hljs-keyword">AS</span> avg_resolution_days,

    <span class="hljs-comment">-- Risk indicators</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> co.cancelled_orders &gt; co.completed_orders <span class="hljs-keyword">THEN</span> <span class="hljs-string">'High Risk'</span>
        <span class="hljs-keyword">WHEN</span> cs.high_priority_tickets &gt; <span class="hljs-number">2</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Support Risk'</span>
        <span class="hljs-keyword">WHEN</span> co.last_order_date &lt; <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 months'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Churn Risk'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Low Risk'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> risk_level

<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> customer_orders co <span class="hljs-keyword">ON</span> c.customer_id = co.customer_id
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> customer_categories cc <span class="hljs-keyword">ON</span> c.customer_id = cc.customer_id <span class="hljs-keyword">AND</span> cc.preference_rank = <span class="hljs-number">1</span>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> customer_communications comm <span class="hljs-keyword">ON</span> c.customer_id = comm.customer_id
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> customer_support cs <span class="hljs-keyword">ON</span> c.customer_id = cs.customer_id;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-use-cases--interview-tips">ğŸ¯ Use Cases &amp; Interview Tips</h2>
<h3 id="common-interview-questions">Common Interview Questions:</h3>
<ol>
<li>
<p><strong>&quot;What's the difference between views and CTEs?&quot;</strong></p>
<ul>
<li>Views: Persistent, reusable, can be indexed (materialized)</li>
<li>CTEs: Query-scoped, temporary, better for complex query organization</li>
<li>Use views for consistent data access, CTEs for query readability</li>
</ul>
</li>
<li>
<p><strong>&quot;When would you use a materialized view?&quot;</strong></p>
<ul>
<li>Expensive aggregations that don't need real-time data</li>
<li>Complex joins across large tables</li>
<li>Reporting and analytics workloads</li>
<li>When query performance is more important than data freshness</li>
</ul>
</li>
<li>
<p><strong>&quot;How do you handle view dependencies?&quot;</strong></p>
<ul>
<li>Document dependencies clearly</li>
<li>Use dependency tracking tools</li>
<li>Consider impact when modifying base tables</li>
<li>Plan migration strategies for schema changes</li>
</ul>
</li>
<li>
<p><strong>&quot;What are the limitations of updatable views?&quot;</strong></p>
<ul>
<li>Must be based on single table (usually)</li>
<li>Cannot contain aggregations, DISTINCT, GROUP BY</li>
<li>Cannot have calculated columns in UPDATE</li>
<li>Complex views may require INSTEAD OF triggers</li>
</ul>
</li>
</ol>
<h3 id="best-practices">Best Practices:</h3>
<ol>
<li><strong>Use descriptive names for views and CTEs</strong></li>
<li><strong>Document complex view logic thoroughly</strong></li>
<li><strong>Consider performance implications of nested views</strong></li>
<li><strong>Use materialized views for expensive operations</strong></li>
<li><strong>Implement proper security through views</strong></li>
<li><strong>Test view updates and dependencies</strong></li>
</ol>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-things-to-watch-out-for">âš ï¸ Things to Watch Out For</h2>
<h3 id="1-view-performance-issues">1. <strong>View Performance Issues</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Nested views can cause performance issues</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> slow_nested_view <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> expensive_view
<span class="hljs-keyword">WHERE</span> some_condition = <span class="hljs-string">'value'</span>;

<span class="hljs-comment">-- Solution: Flatten the query or use materialized views</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">MATERIALIZED</span> <span class="hljs-keyword">VIEW</span> optimized_view <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-comment">-- Direct query instead of nesting views</span>
    column1, column2, calculated_field
<span class="hljs-keyword">FROM</span> base_table
<span class="hljs-keyword">WHERE</span> conditions
  <span class="hljs-keyword">AND</span> some_condition = <span class="hljs-string">'value'</span>;
</div></code></pre>
<h3 id="2-cte-recursion-limits">2. <strong>CTE Recursion Limits</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Infinite recursion</span>
<span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> infinite_loop <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> n
    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
    <span class="hljs-keyword">SELECT</span> n + <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> infinite_loop  <span class="hljs-comment">-- No termination condition!</span>
)
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> infinite_loop;

<span class="hljs-comment">-- Solution: Add proper termination conditions</span>
<span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> safe_recursion <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> n, <span class="hljs-number">0</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">level</span>
    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
    <span class="hljs-keyword">SELECT</span> n + <span class="hljs-number">1</span>, <span class="hljs-keyword">level</span> + <span class="hljs-number">1</span>
    <span class="hljs-keyword">FROM</span> safe_recursion
    <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">level</span> &lt; <span class="hljs-number">100</span>  <span class="hljs-comment">-- Termination condition</span>
)
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> safe_recursion;
</div></code></pre>
<h3 id="3-materialized-view-staleness">3. <strong>Materialized View Staleness</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Forgetting to refresh materialized views</span>
<span class="hljs-comment">-- Data becomes stale and reports are inaccurate</span>

<span class="hljs-comment">-- Solution: Set up automatic refresh schedules</span>
<span class="hljs-keyword">SELECT</span> cron.schedule(<span class="hljs-string">'refresh-daily-analytics'</span>, <span class="hljs-string">'0 2 * * *'</span>,
    <span class="hljs-string">'REFRESH MATERIALIZED VIEW CONCURRENTLY daily_analytics;'</span>);

<span class="hljs-comment">-- Or use triggers for critical data</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> refresh_customer_stats()
<span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">REFRESH</span> <span class="hljs-keyword">MATERIALIZED</span> <span class="hljs-keyword">VIEW</span> CONCURRENTLY customer_stats_mv;
    RETURN NULL;
<span class="hljs-keyword">END</span>;
$$ LANGUAGE plpgsql;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> refresh_stats_on_order
    <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">ON</span> orders
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">STATEMENT</span>
    <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">FUNCTION</span> refresh_customer_stats();
</div></code></pre>
<h3 id="4-security-through-obscurity">4. <strong>Security Through Obscurity</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Relying only on views for security</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> public_customers <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> customer_id, first_name, last_name
<span class="hljs-keyword">FROM</span> customers;
<span class="hljs-comment">-- Users can still access the base table!</span>

<span class="hljs-comment">-- Solution: Combine with proper permissions</span>
<span class="hljs-keyword">REVOKE</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">ON</span> customers <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">public</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> public_customers <span class="hljs-keyword">TO</span> application_role;

<span class="hljs-comment">-- Or use Row Level Security (PostgreSQL)</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> customers <span class="hljs-keyword">ENABLE</span> <span class="hljs-keyword">ROW</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">SECURITY</span>;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> customer_access_policy <span class="hljs-keyword">ON</span> customers
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">TO</span> application_role
    <span class="hljs-keyword">USING</span> (customer_id = current_setting(<span class="hljs-string">'app.current_customer_id'</span>)::<span class="hljs-built_in">INT</span>);
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%80-next-steps">ğŸš€ Next Steps</h2>
<p>In the next chapter, we'll explore <strong>Transactions and Concurrency Control</strong> - essential concepts for maintaining data integrity in multi-user environments. You'll learn about ACID properties, isolation levels, locking mechanisms, and how to handle concurrent access to your database.</p>
<hr>
<h2 id="%F0%9F%93%9D-quick-practice">ğŸ“ Quick Practice</h2>
<p>Try these view and CTE exercises:</p>
<ol>
<li><strong>Business Intelligence Views</strong>: Create a set of views for executive reporting</li>
<li><strong>Security Views</strong>: Implement role-based data access through views</li>
<li><strong>Recursive CTEs</strong>: Build hierarchical data navigation (org charts, categories)</li>
<li><strong>Materialized Views</strong>: Create and maintain analytics tables</li>
<li><strong>Complex CTEs</strong>: Break down complex analytical queries into readable parts</li>
</ol>
<p>Consider:</p>
<ul>
<li>When to use views vs CTEs vs materialized views</li>
<li>Performance implications of your design choices</li>
<li>Security and access control requirements</li>
<li>Maintenance and refresh strategies for materialized views</li>
<li>Documentation and dependency management</li>
</ul>
<h1 id="chapter-15-transactions-and-concurrency-control">Chapter 15: Transactions and Concurrency Control</h1>
<h2 id="%F0%9F%93%9A-what-youll-learn">ğŸ“š What You'll Learn</h2>
<p>Transactions are fundamental to database integrity, ensuring that operations either complete successfully or fail completely. Concurrency control manages how multiple users access the same data simultaneously. This chapter covers ACID properties, isolation levels, locking mechanisms, and strategies for handling concurrent database access.</p>
<hr>
<h2 id="%F0%9F%8E%AF-learning-objectives">ğŸ¯ Learning Objectives</h2>
<p>By the end of this chapter, you will:</p>
<ul>
<li>Understand ACID properties and their importance</li>
<li>Master transaction control statements (BEGIN, COMMIT, ROLLBACK)</li>
<li>Implement proper error handling in transactions</li>
<li>Configure and use different isolation levels</li>
<li>Handle deadlocks and concurrency issues</li>
<li>Optimize transaction performance</li>
<li>Implement distributed transactions</li>
</ul>
<hr>
<h2 id="%F0%9F%94%8D-concept-explanation">ğŸ” Concept Explanation</h2>
<h3 id="what-are-transactions">What are Transactions?</h3>
<p>A transaction is a sequence of database operations that are treated as a single unit of work. Transactions ensure data integrity by following the ACID properties:</p>
<p><strong>ACID Properties:</strong></p>
<ul>
<li><strong>Atomicity</strong>: All operations succeed or all fail (all-or-nothing)</li>
<li><strong>Consistency</strong>: Database remains in a valid state before and after</li>
<li><strong>Isolation</strong>: Concurrent transactions don't interfere with each other</li>
<li><strong>Durability</strong>: Committed changes persist even after system failure</li>
</ul>
<h3 id="concurrency-control">Concurrency Control</h3>
<p>Concurrency control manages simultaneous access to data by multiple users/processes:</p>
<p><strong>Common Issues:</strong></p>
<ul>
<li><strong>Dirty Reads</strong>: Reading uncommitted changes</li>
<li><strong>Non-repeatable Reads</strong>: Same query returns different results</li>
<li><strong>Phantom Reads</strong>: New rows appear between reads</li>
<li><strong>Lost Updates</strong>: Concurrent updates overwrite each other</li>
</ul>
<p><strong>Solutions:</strong></p>
<ul>
<li><strong>Locking</strong>: Prevent concurrent access to data</li>
<li><strong>Isolation Levels</strong>: Control what changes are visible</li>
<li><strong>Optimistic Concurrency</strong>: Detect conflicts at commit time</li>
<li><strong>Pessimistic Concurrency</strong>: Prevent conflicts with locks</li>
</ul>
<hr>
<h2 id="%F0%9F%9B%A0%EF%B8%8F-syntax-comparison">ğŸ› ï¸ Syntax Comparison</h2>
<h3 id="mysql-vs-postgresql-transactions">MySQL vs PostgreSQL Transactions</h3>
<table>
<thead>
<tr>
<th>Feature</th>
<th>MySQL</th>
<th>PostgreSQL</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Auto-commit</strong></td>
<td>ON by default</td>
<td>OFF by default</td>
</tr>
<tr>
<td><strong>Transaction Start</strong></td>
<td>START TRANSACTION, BEGIN</td>
<td>BEGIN, START TRANSACTION</td>
</tr>
<tr>
<td><strong>Savepoints</strong></td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td><strong>Nested Transactions</strong></td>
<td>âŒ</td>
<td>âœ… (via savepoints)</td>
</tr>
<tr>
<td><strong>Isolation Levels</strong></td>
<td>4 standard levels</td>
<td>4 standard + custom</td>
</tr>
<tr>
<td><strong>Lock Types</strong></td>
<td>Table, row, metadata</td>
<td>Table, row, advisory</td>
</tr>
<tr>
<td><strong>Deadlock Detection</strong></td>
<td>âœ… Automatic</td>
<td>âœ… Automatic</td>
</tr>
<tr>
<td><strong>MVCC</strong></td>
<td>âœ… (InnoDB)</td>
<td>âœ… Native</td>
</tr>
<tr>
<td><strong>Read Committed</strong></td>
<td>Default</td>
<td>Default</td>
</tr>
<tr>
<td><strong>Serializable</strong></td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="%F0%9F%94%84-basic-transaction-control">ğŸ”„ Basic Transaction Control</h2>
<h3 id="mysql-transactions">MySQL Transactions</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Basic transaction structure</span>
<span class="hljs-keyword">START</span> <span class="hljs-keyword">TRANSACTION</span>;

<span class="hljs-comment">-- Your SQL operations here</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customers (first_name, last_name, email)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'John'</span>, <span class="hljs-string">'Doe'</span>, <span class="hljs-string">'john.doe@email.com'</span>);

<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance = balance - <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">1</span>;
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance = balance + <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">2</span>;

<span class="hljs-comment">-- Commit if everything is successful</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- Example with rollback on error</span>
<span class="hljs-keyword">START</span> <span class="hljs-keyword">TRANSACTION</span>;

<span class="hljs-keyword">DECLARE</span> <span class="hljs-keyword">EXIT</span> <span class="hljs-keyword">HANDLER</span> <span class="hljs-keyword">FOR</span> SQLEXCEPTION
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">ROLLBACK</span>;
    RESIGNAL;
<span class="hljs-keyword">END</span>;

<span class="hljs-comment">-- Transfer money between accounts</span>
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance = balance - <span class="hljs-number">500</span> <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">1</span>;
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance = balance + <span class="hljs-number">500</span> <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">2</span>;

<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- Using savepoints</span>
<span class="hljs-keyword">START</span> <span class="hljs-keyword">TRANSACTION</span>;

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (customer_id, total_amount) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">100.00</span>);
<span class="hljs-keyword">SAVEPOINT</span> order_created;

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> order_items (order_id, product_id, quantity, unit_price)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-keyword">LAST_INSERT_ID</span>(), <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">25.00</span>);
<span class="hljs-keyword">SAVEPOINT</span> items_added;

<span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> stock_quantity = stock_quantity - <span class="hljs-number">2</span> <span class="hljs-keyword">WHERE</span> product_id = <span class="hljs-number">1</span>;

<span class="hljs-comment">-- If stock update fails, rollback to savepoint</span>
IF ROW_COUNT() = 0 THEN
    <span class="hljs-keyword">ROLLBACK</span> <span class="hljs-keyword">TO</span> <span class="hljs-keyword">SAVEPOINT</span> items_added;
    <span class="hljs-comment">-- Handle insufficient stock</span>
<span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- Auto-commit control</span>
<span class="hljs-keyword">SET</span> autocommit = <span class="hljs-number">0</span>;  <span class="hljs-comment">-- Disable auto-commit</span>
<span class="hljs-keyword">SELECT</span> @@autocommit; <span class="hljs-comment">-- Check current setting</span>

<span class="hljs-comment">-- Manual transaction without START TRANSACTION</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customers (first_name, last_name, email)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'Jane'</span>, <span class="hljs-string">'Smith'</span>, <span class="hljs-string">'jane.smith@email.com'</span>);
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-keyword">SET</span> autocommit = <span class="hljs-number">1</span>;  <span class="hljs-comment">-- Re-enable auto-commit</span>
</div></code></pre>
<h3 id="postgresql-transactions">PostgreSQL Transactions</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Basic transaction structure</span>
<span class="hljs-keyword">BEGIN</span>;

<span class="hljs-comment">-- Your SQL operations here</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customers (first_name, last_name, email)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'John'</span>, <span class="hljs-string">'Doe'</span>, <span class="hljs-string">'john.doe@email.com'</span>);

<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance = balance - <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">1</span>;
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance = balance + <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">2</span>;

<span class="hljs-comment">-- Commit if everything is successful</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- Example with exception handling</span>
<span class="hljs-keyword">DO</span> $$
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-comment">-- Start transaction block</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (customer_id, total_amount) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">100.00</span>);

        <span class="hljs-comment">-- This might fail</span>
        <span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> stock_quantity = stock_quantity - <span class="hljs-number">10</span>
        <span class="hljs-keyword">WHERE</span> product_id = <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> stock_quantity &gt;= <span class="hljs-number">10</span>;

        IF NOT FOUND THEN
            RAISE EXCEPTION 'Insufficient stock for product %', 1;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-comment">-- If we get here, commit</span>
        <span class="hljs-keyword">COMMIT</span>;

    EXCEPTION
        WHEN OTHERS THEN
            <span class="hljs-keyword">ROLLBACK</span>;
            RAISE NOTICE 'Transaction failed: %', SQLERRM;
    <span class="hljs-keyword">END</span>;
<span class="hljs-keyword">END</span> $$;

<span class="hljs-comment">-- Using savepoints (nested transactions)</span>
<span class="hljs-keyword">BEGIN</span>;

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (customer_id, total_amount) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">100.00</span>);
<span class="hljs-keyword">SAVEPOINT</span> order_created;

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> order_items (order_id, product_id, quantity, unit_price)
<span class="hljs-keyword">VALUES</span> (currval(<span class="hljs-string">'orders_order_id_seq'</span>), <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">25.00</span>);
<span class="hljs-keyword">SAVEPOINT</span> items_added;

<span class="hljs-comment">-- Try to update stock</span>
<span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> stock_quantity = stock_quantity - <span class="hljs-number">2</span>
<span class="hljs-keyword">WHERE</span> product_id = <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> stock_quantity &gt;= <span class="hljs-number">2</span>;

IF NOT FOUND THEN
    <span class="hljs-comment">-- Rollback to savepoint and handle error</span>
    <span class="hljs-keyword">ROLLBACK</span> <span class="hljs-keyword">TO</span> <span class="hljs-keyword">SAVEPOINT</span> items_added;
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> order_items (order_id, product_id, quantity, unit_price, <span class="hljs-keyword">status</span>)
    <span class="hljs-keyword">VALUES</span> (currval(<span class="hljs-string">'orders_order_id_seq'</span>), <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">25.00</span>, <span class="hljs-string">'backordered'</span>);
<span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- Transaction isolation levels</span>
<span class="hljs-keyword">BEGIN</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">READ</span> COMMITTED;
<span class="hljs-comment">-- or</span>
<span class="hljs-keyword">BEGIN</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> REPEATABLE <span class="hljs-keyword">READ</span>;
<span class="hljs-comment">-- or</span>
<span class="hljs-keyword">BEGIN</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">SERIALIZABLE</span>;

<span class="hljs-comment">-- Set isolation level for session</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">SERIALIZABLE</span>;

<span class="hljs-comment">-- Check current isolation level</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%92-isolation-levels">ğŸ”’ Isolation Levels</h2>
<h3 id="understanding-isolation-levels">Understanding Isolation Levels</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- READ UNCOMMITTED (lowest isolation)</span>
<span class="hljs-comment">-- Can see uncommitted changes from other transactions</span>
<span class="hljs-comment">-- Allows: Dirty reads, non-repeatable reads, phantom reads</span>

<span class="hljs-comment">-- Session 1</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">READ</span> UNCOMMITTED;
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> balance <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">1</span>; <span class="hljs-comment">-- Shows 1000</span>

<span class="hljs-comment">-- Session 2 (concurrent)</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance = <span class="hljs-number">500</span> <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">1</span>;
<span class="hljs-comment">-- Don't commit yet</span>

<span class="hljs-comment">-- Back to Session 1</span>
<span class="hljs-keyword">SELECT</span> balance <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">1</span>; <span class="hljs-comment">-- Shows 500 (dirty read!)</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- READ COMMITTED (default in most databases)</span>
<span class="hljs-comment">-- Only sees committed changes</span>
<span class="hljs-comment">-- Prevents: Dirty reads</span>
<span class="hljs-comment">-- Allows: Non-repeatable reads, phantom reads</span>

<span class="hljs-comment">-- Session 1</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">READ</span> COMMITTED;
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> balance <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">1</span>; <span class="hljs-comment">-- Shows 1000</span>

<span class="hljs-comment">-- Session 2</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance = <span class="hljs-number">500</span> <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">1</span>;
<span class="hljs-keyword">COMMIT</span>; <span class="hljs-comment">-- Now committed</span>

<span class="hljs-comment">-- Back to Session 1</span>
<span class="hljs-keyword">SELECT</span> balance <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">1</span>; <span class="hljs-comment">-- Shows 500 (non-repeatable read)</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- REPEATABLE READ</span>
<span class="hljs-comment">-- Same reads return same results within transaction</span>
<span class="hljs-comment">-- Prevents: Dirty reads, non-repeatable reads</span>
<span class="hljs-comment">-- Allows: Phantom reads</span>

<span class="hljs-comment">-- Session 1</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> REPEATABLE <span class="hljs-keyword">READ</span>;
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">WHERE</span> city = <span class="hljs-string">'New York'</span>; <span class="hljs-comment">-- Shows 10</span>

<span class="hljs-comment">-- Session 2</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customers (first_name, last_name, city)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'New'</span>, <span class="hljs-string">'Customer'</span>, <span class="hljs-string">'New York'</span>);
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- Back to Session 1</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">WHERE</span> city = <span class="hljs-string">'New York'</span>; <span class="hljs-comment">-- Still shows 10</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">WHERE</span> city = <span class="hljs-string">'New York'</span>; <span class="hljs-comment">-- Might show 11 rows (phantom read)</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- SERIALIZABLE (highest isolation)</span>
<span class="hljs-comment">-- Transactions appear to run sequentially</span>
<span class="hljs-comment">-- Prevents: All concurrency issues</span>
<span class="hljs-comment">-- May cause: More deadlocks and performance issues</span>

<span class="hljs-comment">-- Session 1</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">SERIALIZABLE</span>;
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">SUM</span>(balance) <span class="hljs-keyword">FROM</span> accounts; <span class="hljs-comment">-- Shows total</span>

<span class="hljs-comment">-- Session 2</span>
<span class="hljs-keyword">BEGIN</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">SERIALIZABLE</span>;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> accounts (customer_id, balance) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">999</span>, <span class="hljs-number">1000</span>);
<span class="hljs-comment">-- This might block or cause serialization failure</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- Back to Session 1</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">SUM</span>(balance) <span class="hljs-keyword">FROM</span> accounts; <span class="hljs-comment">-- Same result as before</span>
<span class="hljs-keyword">COMMIT</span>;
</div></code></pre>
<h3 id="practical-isolation-level-examples">Practical Isolation Level Examples</h3>
<p><strong>E-commerce Order Processing:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- PostgreSQL: Handling concurrent order processing</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> process_order(
    p_customer_id <span class="hljs-built_in">INT</span>,
    p_product_id <span class="hljs-built_in">INT</span>,
    p_quantity <span class="hljs-built_in">INT</span>
) <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TABLE</span>(
    order_id <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">status</span> <span class="hljs-built_in">TEXT</span>,
    message <span class="hljs-built_in">TEXT</span>
) <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    v_order_id <span class="hljs-built_in">INT</span>;
    v_available_stock INT;
    v_unit_price DECIMAL(10,2);
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- Use REPEATABLE READ to ensure consistent stock checks</span>
    <span class="hljs-keyword">SET</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> REPEATABLE <span class="hljs-keyword">READ</span>;

    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-comment">-- Check product availability and get price</span>
        <span class="hljs-keyword">SELECT</span> stock_quantity, price <span class="hljs-keyword">INTO</span> v_available_stock, v_unit_price
        <span class="hljs-keyword">FROM</span> products
        <span class="hljs-keyword">WHERE</span> product_id = p_product_id <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>
        <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>; <span class="hljs-comment">-- Lock the row</span>

        IF NOT FOUND THEN
            RETURN QUERY <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">NULL</span>::<span class="hljs-built_in">INT</span>, <span class="hljs-string">'ERROR'</span>::<span class="hljs-built_in">TEXT</span>, <span class="hljs-string">'Product not found'</span>::<span class="hljs-built_in">TEXT</span>;
            RETURN;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        IF v_available_stock &lt; p_quantity THEN
            RETURN QUERY <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">NULL</span>::<span class="hljs-built_in">INT</span>, <span class="hljs-string">'ERROR'</span>::<span class="hljs-built_in">TEXT</span>,
                <span class="hljs-keyword">format</span>(<span class="hljs-string">'Insufficient stock. Available: %s, Requested: %s'</span>,
                       v_available_stock, p_quantity)::<span class="hljs-built_in">TEXT</span>;
            RETURN;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-comment">-- Create order</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (customer_id, total_amount, <span class="hljs-keyword">status</span>, order_date)
        <span class="hljs-keyword">VALUES</span> (p_customer_id, v_unit_price * p_quantity, <span class="hljs-string">'pending'</span>, <span class="hljs-keyword">CURRENT_TIMESTAMP</span>)
        <span class="hljs-keyword">RETURNING</span> orders.order_id <span class="hljs-keyword">INTO</span> v_order_id;

        <span class="hljs-comment">-- Add order item</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> order_items (order_id, product_id, quantity, unit_price)
        <span class="hljs-keyword">VALUES</span> (v_order_id, p_product_id, p_quantity, v_unit_price);

        <span class="hljs-comment">-- Update stock</span>
        <span class="hljs-keyword">UPDATE</span> products
        <span class="hljs-keyword">SET</span> stock_quantity = stock_quantity - p_quantity
        <span class="hljs-keyword">WHERE</span> product_id = p_product_id;

        <span class="hljs-comment">-- Update order status</span>
        <span class="hljs-keyword">UPDATE</span> orders <span class="hljs-keyword">SET</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'confirmed'</span> <span class="hljs-keyword">WHERE</span> orders.order_id = v_order_id;

        RETURN QUERY <span class="hljs-keyword">SELECT</span> v_order_id, <span class="hljs-string">'SUCCESS'</span>::<span class="hljs-built_in">TEXT</span>, <span class="hljs-string">'Order processed successfully'</span>::<span class="hljs-built_in">TEXT</span>;

    EXCEPTION
        WHEN serialization_failure THEN
            RETURN QUERY <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">NULL</span>::<span class="hljs-built_in">INT</span>, <span class="hljs-string">'RETRY'</span>::<span class="hljs-built_in">TEXT</span>, <span class="hljs-string">'Serialization conflict, please retry'</span>::<span class="hljs-built_in">TEXT</span>;
        WHEN OTHERS THEN
            RETURN QUERY <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">NULL</span>::<span class="hljs-built_in">INT</span>, <span class="hljs-string">'ERROR'</span>::<span class="hljs-built_in">TEXT</span>, SQLERRM::<span class="hljs-built_in">TEXT</span>;
    <span class="hljs-keyword">END</span>;
<span class="hljs-keyword">END</span>;
$$ LANGUAGE plpgsql;

<span class="hljs-comment">-- Usage with retry logic</span>
<span class="hljs-keyword">DO</span> $$
<span class="hljs-keyword">DECLARE</span>
    <span class="hljs-keyword">result</span> <span class="hljs-built_in">RECORD</span>;
    retry_count INT := 0;
    max_retries INT := 3;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">LOOP</span>
        <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">result</span> <span class="hljs-keyword">FROM</span> process_order(<span class="hljs-number">1</span>, <span class="hljs-number">101</span>, <span class="hljs-number">2</span>);

        IF result.status = 'SUCCESS' THEN
            RAISE NOTICE 'Order processed: %', result.message;
            EXIT;
        ELSIF result.status = 'RETRY' AND retry_count &lt; max_retries THEN
            retry_count := retry_count + 1;
            RAISE NOTICE 'Retrying... Attempt %', retry_count;
            PERFORM pg_sleep(0.1); <span class="hljs-comment">-- Brief delay</span>
        ELSE
            RAISE NOTICE 'Order failed: %', result.message;
            EXIT;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;
<span class="hljs-keyword">END</span> $$;
</div></code></pre>
<p><strong>Banking Transfer with Deadlock Prevention:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL: Safe money transfer with deadlock prevention</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> transfer_money(
    <span class="hljs-keyword">IN</span> from_account <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">IN</span> to_account <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">IN</span> amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    <span class="hljs-keyword">OUT</span> result_status <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    <span class="hljs-keyword">OUT</span> result_message <span class="hljs-built_in">TEXT</span>
)
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> from_balance <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>);
    <span class="hljs-keyword">DECLARE</span> account1 <span class="hljs-built_in">INT</span>;
    <span class="hljs-keyword">DECLARE</span> account2 <span class="hljs-built_in">INT</span>;
    <span class="hljs-keyword">DECLARE</span> <span class="hljs-keyword">EXIT</span> <span class="hljs-keyword">HANDLER</span> <span class="hljs-keyword">FOR</span> SQLEXCEPTION
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">ROLLBACK</span>;
        GET DIAGNOSTICS CONDITION 1
            result_message = MESSAGE_TEXT;
        <span class="hljs-keyword">SET</span> result_status = <span class="hljs-string">'ERROR'</span>;
    <span class="hljs-keyword">END</span>;

    <span class="hljs-comment">-- Prevent deadlocks by always locking accounts in same order</span>
    IF from_account &lt; to_account THEN
        <span class="hljs-keyword">SET</span> account1 = from_account;
        <span class="hljs-keyword">SET</span> account2 = to_account;
    ELSE
        <span class="hljs-keyword">SET</span> account1 = to_account;
        <span class="hljs-keyword">SET</span> account2 = from_account;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-keyword">START</span> <span class="hljs-keyword">TRANSACTION</span>;

    <span class="hljs-comment">-- Lock accounts in consistent order</span>
    <span class="hljs-keyword">SELECT</span> balance <span class="hljs-keyword">INTO</span> from_balance
    <span class="hljs-keyword">FROM</span> accounts
    <span class="hljs-keyword">WHERE</span> account_id = account1
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;

    <span class="hljs-keyword">SELECT</span> balance <span class="hljs-keyword">INTO</span> @temp
    <span class="hljs-keyword">FROM</span> accounts
    <span class="hljs-keyword">WHERE</span> account_id = account2
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;

    <span class="hljs-comment">-- Check sufficient funds</span>
    <span class="hljs-keyword">SELECT</span> balance <span class="hljs-keyword">INTO</span> from_balance
    <span class="hljs-keyword">FROM</span> accounts
    <span class="hljs-keyword">WHERE</span> account_id = from_account;

    IF from_balance &lt; amount THEN
        <span class="hljs-keyword">SET</span> result_status = <span class="hljs-string">'INSUFFICIENT_FUNDS'</span>;
        <span class="hljs-keyword">SET</span> result_message = <span class="hljs-keyword">CONCAT</span>(<span class="hljs-string">'Insufficient funds. Available: '</span>, from_balance, <span class="hljs-string">', Requested: '</span>, amount);
        <span class="hljs-keyword">ROLLBACK</span>;
    ELSE
        <span class="hljs-comment">-- Perform transfer</span>
        <span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance = balance - amount <span class="hljs-keyword">WHERE</span> account_id = from_account;
        <span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance = balance + amount <span class="hljs-keyword">WHERE</span> account_id = to_account;

        <span class="hljs-comment">-- Log transaction</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> transaction_log (from_account, to_account, amount, transaction_date)
        <span class="hljs-keyword">VALUES</span> (from_account, to_account, amount, <span class="hljs-keyword">NOW</span>());

        <span class="hljs-keyword">SET</span> result_status = <span class="hljs-string">'SUCCESS'</span>;
        <span class="hljs-keyword">SET</span> result_message = <span class="hljs-keyword">CONCAT</span>(<span class="hljs-string">'Transfer completed: $'</span>, amount, <span class="hljs-string">' from account '</span>, from_account, <span class="hljs-string">' to account '</span>, to_account);

        <span class="hljs-keyword">COMMIT</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
<span class="hljs-keyword">END</span> //
DELIMITER ;

<span class="hljs-comment">-- Usage</span>
<span class="hljs-keyword">CALL</span> transfer_money(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">500.00</span>, @<span class="hljs-keyword">status</span>, @message);
<span class="hljs-keyword">SELECT</span> @<span class="hljs-keyword">status</span>, @message;
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%90-locking-mechanisms">ğŸ” Locking Mechanisms</h2>
<h3 id="explicit-locking">Explicit Locking</h3>
<p><strong>MySQL Locking:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Table-level locking</span>
<span class="hljs-keyword">LOCK</span> <span class="hljs-keyword">TABLES</span> customers <span class="hljs-keyword">READ</span>, orders WRITE;
<span class="hljs-comment">-- Perform operations</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">1</span>;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (customer_id, total_amount) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">100.00</span>);
<span class="hljs-keyword">UNLOCK</span> <span class="hljs-keyword">TABLES</span>;

<span class="hljs-comment">-- Row-level locking with SELECT FOR UPDATE</span>
<span class="hljs-keyword">START</span> <span class="hljs-keyword">TRANSACTION</span>;

<span class="hljs-comment">-- Lock specific rows for update</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">WHERE</span> category_id = <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> stock_quantity &gt; <span class="hljs-number">0</span>
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;

<span class="hljs-comment">-- Update the locked rows</span>
<span class="hljs-keyword">UPDATE</span> products
<span class="hljs-keyword">SET</span> stock_quantity = stock_quantity - <span class="hljs-number">1</span>
<span class="hljs-keyword">WHERE</span> category_id = <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> stock_quantity &gt; <span class="hljs-number">0</span>;

<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- Shared locks (SELECT FOR SHARE)</span>
<span class="hljs-keyword">START</span> <span class="hljs-keyword">TRANSACTION</span>;

<span class="hljs-comment">-- Multiple transactions can hold shared locks</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">1</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SHARE</span>;

<span class="hljs-comment">-- This allows other SELECT FOR SHARE but blocks SELECT FOR UPDATE</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- Lock with timeout (MySQL 8.0+)</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> product_id = <span class="hljs-number">1</span>
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">NOWAIT</span>; <span class="hljs-comment">-- Fail immediately if can't lock</span>

<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> product_id = <span class="hljs-number">1</span>
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">SKIP</span> <span class="hljs-keyword">LOCKED</span>; <span class="hljs-comment">-- Skip locked rows</span>
</div></code></pre>
<p><strong>PostgreSQL Locking:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Table-level locking</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">LOCK</span> <span class="hljs-keyword">TABLE</span> customers <span class="hljs-keyword">IN</span> <span class="hljs-keyword">ACCESS</span> <span class="hljs-keyword">SHARE</span> <span class="hljs-keyword">MODE</span>; <span class="hljs-comment">-- Least restrictive</span>
<span class="hljs-keyword">LOCK</span> <span class="hljs-keyword">TABLE</span> orders <span class="hljs-keyword">IN</span> <span class="hljs-keyword">ROW</span> EXCLUSIVE <span class="hljs-keyword">MODE</span>;   <span class="hljs-comment">-- For INSERT/UPDATE/DELETE</span>
<span class="hljs-keyword">LOCK</span> <span class="hljs-keyword">TABLE</span> products <span class="hljs-keyword">IN</span> EXCLUSIVE <span class="hljs-keyword">MODE</span>;     <span class="hljs-comment">-- Most restrictive</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- Row-level locking</span>
<span class="hljs-keyword">BEGIN</span>;

<span class="hljs-comment">-- FOR UPDATE (exclusive row lock)</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">1</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;

<span class="hljs-comment">-- FOR NO KEY UPDATE (allows foreign key references)</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">1</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">NO</span> <span class="hljs-keyword">KEY</span> <span class="hljs-keyword">UPDATE</span>;

<span class="hljs-comment">-- FOR SHARE (shared row lock)</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> product_id = <span class="hljs-number">1</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SHARE</span>;

<span class="hljs-comment">-- FOR KEY SHARE (weakest row lock)</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> categories <span class="hljs-keyword">WHERE</span> category_id = <span class="hljs-number">1</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">KEY</span> <span class="hljs-keyword">SHARE</span>;

<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- Advisory locks (application-level)</span>
<span class="hljs-keyword">SELECT</span> pg_advisory_lock(<span class="hljs-number">12345</span>); <span class="hljs-comment">-- Block until lock acquired</span>
<span class="hljs-keyword">SELECT</span> pg_try_advisory_lock(<span class="hljs-number">12345</span>); <span class="hljs-comment">-- Return immediately (true/false)</span>

<span class="hljs-comment">-- Perform application logic</span>
<span class="hljs-comment">-- ...</span>

<span class="hljs-keyword">SELECT</span> pg_advisory_unlock(<span class="hljs-number">12345</span>);

<span class="hljs-comment">-- Session-level advisory locks</span>
<span class="hljs-keyword">SELECT</span> pg_advisory_lock_shared(<span class="hljs-number">12345</span>); <span class="hljs-comment">-- Shared advisory lock</span>
<span class="hljs-keyword">SELECT</span> pg_advisory_unlock_shared(<span class="hljs-number">12345</span>);

<span class="hljs-comment">-- Lock with timeout</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SET</span> lock_timeout = <span class="hljs-string">'5s'</span>;
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> product_id = <span class="hljs-number">1</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
<span class="hljs-keyword">COMMIT</span>;
</div></code></pre>
<h3 id="deadlock-handling">Deadlock Handling</h3>
<p><strong>Deadlock Detection and Resolution:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- PostgreSQL: Deadlock detection example</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> safe_transfer(
    from_acc <span class="hljs-built_in">INT</span>,
    to_acc <span class="hljs-built_in">INT</span>,
    amount <span class="hljs-built_in">DECIMAL</span>
) <span class="hljs-keyword">RETURNS</span> <span class="hljs-built_in">TEXT</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    retry_count <span class="hljs-built_in">INT</span> := <span class="hljs-number">0</span>;
    max_retries INT := 3;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">LOOP</span>
        <span class="hljs-keyword">BEGIN</span>
            <span class="hljs-comment">-- Always lock accounts in same order to prevent deadlocks</span>
            <span class="hljs-keyword">IF</span> from_acc &lt; to_acc <span class="hljs-keyword">THEN</span>
                PERFORM * <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> account_id = from_acc <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
                PERFORM * FROM accounts WHERE account_id = to_acc FOR <span class="hljs-keyword">UPDATE</span>;
            ELSE
                PERFORM * FROM accounts WHERE account_id = to_acc FOR <span class="hljs-keyword">UPDATE</span>;
                PERFORM * FROM accounts WHERE account_id = from_acc FOR <span class="hljs-keyword">UPDATE</span>;
            <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

            <span class="hljs-comment">-- Perform transfer</span>
            <span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance = balance - amount <span class="hljs-keyword">WHERE</span> account_id = from_acc;
            <span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance = balance + amount <span class="hljs-keyword">WHERE</span> account_id = to_acc;

            RETURN 'Transfer completed successfully';

        EXCEPTION
            WHEN deadlock_detected THEN
                retry_count := retry_count + 1;
                IF retry_count &gt;= max_retries THEN
                    RAISE EXCEPTION 'Transfer failed after % retries due to deadlocks', max_retries;
                <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

                <span class="hljs-comment">-- Random delay to reduce deadlock probability</span>
                PERFORM pg_sleep(random() * 0.1);

        <span class="hljs-keyword">END</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;
<span class="hljs-keyword">END</span>;
$$ LANGUAGE plpgsql;

<span class="hljs-comment">-- MySQL: Deadlock handling</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> safe_update_inventory(
    <span class="hljs-keyword">IN</span> product_id_1 <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">IN</span> quantity_1 <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">IN</span> product_id_2 <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">IN</span> quantity_2 <span class="hljs-built_in">INT</span>
)
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> deadlock_count <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">DECLARE</span> max_retries <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">3</span>;
    <span class="hljs-keyword">DECLARE</span> done <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>;

    retry_loop: LOOP
        <span class="hljs-keyword">BEGIN</span>
            <span class="hljs-keyword">DECLARE</span> <span class="hljs-keyword">EXIT</span> <span class="hljs-keyword">HANDLER</span> <span class="hljs-keyword">FOR</span> <span class="hljs-number">1213</span> <span class="hljs-comment">-- Deadlock error code</span>
            <span class="hljs-keyword">BEGIN</span>
                <span class="hljs-keyword">SET</span> deadlock_count = deadlock_count + <span class="hljs-number">1</span>;
                IF deadlock_count &gt;= max_retries THEN
                    RESIGNAL;
                <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
                <span class="hljs-keyword">ROLLBACK</span>;
                <span class="hljs-comment">-- Random delay</span>
                <span class="hljs-keyword">DO</span> <span class="hljs-keyword">SLEEP</span>(<span class="hljs-keyword">RAND</span>() * <span class="hljs-number">0.1</span>);
            <span class="hljs-keyword">END</span>;

            <span class="hljs-keyword">START</span> <span class="hljs-keyword">TRANSACTION</span>;

            <span class="hljs-comment">-- Lock products in consistent order</span>
            IF product_id_1 &lt; product_id_2 THEN
                <span class="hljs-keyword">SELECT</span> stock_quantity <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> product_id = product_id_1 <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
                <span class="hljs-keyword">SELECT</span> stock_quantity <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> product_id = product_id_2 <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
            ELSE
                <span class="hljs-keyword">SELECT</span> stock_quantity <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> product_id = product_id_2 <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
                <span class="hljs-keyword">SELECT</span> stock_quantity <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> product_id = product_id_1 <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
            <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

            <span class="hljs-comment">-- Update inventory</span>
            <span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> stock_quantity = stock_quantity - quantity_1 <span class="hljs-keyword">WHERE</span> product_id = product_id_1;
            <span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> stock_quantity = stock_quantity - quantity_2 <span class="hljs-keyword">WHERE</span> product_id = product_id_2;

            <span class="hljs-keyword">COMMIT</span>;
            <span class="hljs-keyword">SET</span> done = <span class="hljs-literal">TRUE</span>;

        <span class="hljs-keyword">END</span>;

        IF done THEN
            LEAVE retry_loop;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;
<span class="hljs-keyword">END</span> //
DELIMITER ;
</div></code></pre>
<hr>
<h2 id="%E2%9A%A1-performance-optimization">âš¡ Performance Optimization</h2>
<h3 id="transaction-best-practices">Transaction Best Practices</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Keep transactions short</span>
<span class="hljs-comment">-- BAD: Long-running transaction</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> large_table; <span class="hljs-comment">-- Long-running query</span>
<span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> price = price * <span class="hljs-number">1.1</span>; <span class="hljs-comment">-- Locks many rows</span>
<span class="hljs-comment">-- User input or external API call</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- GOOD: Short, focused transaction</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> price = price * <span class="hljs-number">1.1</span> <span class="hljs-keyword">WHERE</span> category_id = <span class="hljs-number">1</span>;
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- Batch processing for large operations</span>
<span class="hljs-comment">-- PostgreSQL: Process large updates in batches</span>
<span class="hljs-keyword">DO</span> $$
<span class="hljs-keyword">DECLARE</span>
    batch_size <span class="hljs-built_in">INT</span> := <span class="hljs-number">1000</span>;
    processed INT := 0;
    total_rows INT;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> total_rows <span class="hljs-keyword">FROM</span> old_orders <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'pending'</span>;

    WHILE processed &lt; total_rows LOOP
        <span class="hljs-keyword">BEGIN</span>
            <span class="hljs-keyword">UPDATE</span> old_orders
            <span class="hljs-keyword">SET</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'expired'</span>
            <span class="hljs-keyword">WHERE</span> order_id <span class="hljs-keyword">IN</span> (
                <span class="hljs-keyword">SELECT</span> order_id
                <span class="hljs-keyword">FROM</span> old_orders
                <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'pending'</span>
                  <span class="hljs-keyword">AND</span> order_date &lt; <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'30 days'</span>
                <span class="hljs-keyword">LIMIT</span> batch_size
            );

            processed := processed + batch_size;

            <span class="hljs-comment">-- Commit each batch</span>
            <span class="hljs-keyword">COMMIT</span>;

            <span class="hljs-comment">-- Brief pause to allow other transactions</span>
            PERFORM pg_sleep(0.01);

        EXCEPTION
            WHEN OTHERS THEN
                <span class="hljs-keyword">ROLLBACK</span>;
                RAISE NOTICE 'Batch failed at row %: %', processed, SQLERRM;
                EXIT;
        <span class="hljs-keyword">END</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;

    RAISE NOTICE 'Processed % rows in batches of %', processed, batch_size;
<span class="hljs-keyword">END</span> $$;

<span class="hljs-comment">-- MySQL: Batch processing with cursor</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> batch_update_prices()
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> done <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>;
    <span class="hljs-keyword">DECLARE</span> batch_count <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">DECLARE</span> product_cursor <span class="hljs-keyword">CURSOR</span> <span class="hljs-keyword">FOR</span>
        <span class="hljs-keyword">SELECT</span> product_id <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> last_updated &lt; <span class="hljs-keyword">DATE_SUB</span>(<span class="hljs-keyword">NOW</span>(), <span class="hljs-built_in">INTERVAL</span> <span class="hljs-number">1</span> <span class="hljs-keyword">YEAR</span>);
    <span class="hljs-keyword">DECLARE</span> CONTINUE <span class="hljs-keyword">HANDLER</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">FOUND</span> <span class="hljs-keyword">SET</span> done = <span class="hljs-literal">TRUE</span>;

    OPEN product_cursor;

    read_loop: LOOP
        <span class="hljs-keyword">START</span> <span class="hljs-keyword">TRANSACTION</span>;

        <span class="hljs-keyword">SET</span> batch_count = <span class="hljs-number">0</span>;

        batch_loop: LOOP
            FETCH product_cursor INTO @product_id;

            IF done OR batch_count &gt;= 100 THEN
                LEAVE batch_loop;
            <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

            <span class="hljs-keyword">UPDATE</span> products
            <span class="hljs-keyword">SET</span> price = price * <span class="hljs-number">1.05</span>, last_updated = <span class="hljs-keyword">NOW</span>()
            <span class="hljs-keyword">WHERE</span> product_id = @product_id;

            <span class="hljs-keyword">SET</span> batch_count = batch_count + <span class="hljs-number">1</span>;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;

        <span class="hljs-keyword">COMMIT</span>;

        IF done THEN
            LEAVE read_loop;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-comment">-- Brief pause</span>
        <span class="hljs-keyword">DO</span> <span class="hljs-keyword">SLEEP</span>(<span class="hljs-number">0.01</span>);
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;

    CLOSE product_cursor;
<span class="hljs-keyword">END</span> //
DELIMITER ;
</div></code></pre>
<h3 id="connection-pooling-and-transaction-management">Connection Pooling and Transaction Management</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- PostgreSQL: Connection pooling considerations</span>
<span class="hljs-comment">-- Set appropriate timeout values</span>
<span class="hljs-keyword">SET</span> statement_timeout = <span class="hljs-string">'30s'</span>;
<span class="hljs-keyword">SET</span> lock_timeout = <span class="hljs-string">'10s'</span>;
<span class="hljs-keyword">SET</span> idle_in_transaction_session_timeout = <span class="hljs-string">'60s'</span>;

<span class="hljs-comment">-- Monitor long-running transactions</span>
<span class="hljs-keyword">SELECT</span>
    pid,
    <span class="hljs-keyword">now</span>() - pg_stat_activity.query_start <span class="hljs-keyword">AS</span> <span class="hljs-keyword">duration</span>,
    <span class="hljs-keyword">query</span>,
    state,
    wait_event_type,
    wait_event
<span class="hljs-keyword">FROM</span> pg_stat_activity
<span class="hljs-keyword">WHERE</span> state <span class="hljs-keyword">IN</span> (<span class="hljs-string">'active'</span>, <span class="hljs-string">'idle in transaction'</span>)
  <span class="hljs-keyword">AND</span> <span class="hljs-keyword">now</span>() - pg_stat_activity.query_start &gt; <span class="hljs-built_in">interval</span> <span class="hljs-string">'5 minutes'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">duration</span> <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Kill long-running transactions if needed</span>
<span class="hljs-keyword">SELECT</span> pg_terminate_backend(pid)
<span class="hljs-keyword">FROM</span> pg_stat_activity
<span class="hljs-keyword">WHERE</span> state = <span class="hljs-string">'idle in transaction'</span>
  <span class="hljs-keyword">AND</span> <span class="hljs-keyword">now</span>() - query_start &gt; <span class="hljs-built_in">interval</span> <span class="hljs-string">'1 hour'</span>;

<span class="hljs-comment">-- MySQL: Transaction monitoring</span>
<span class="hljs-comment">-- Check for long-running transactions</span>
<span class="hljs-keyword">SELECT</span>
    trx_id,
    trx_state,
    trx_started,
    <span class="hljs-keyword">TIMESTAMPDIFF</span>(<span class="hljs-keyword">SECOND</span>, trx_started, <span class="hljs-keyword">NOW</span>()) <span class="hljs-keyword">AS</span> duration_seconds,
    trx_mysql_thread_id,
    trx_query
<span class="hljs-keyword">FROM</span> information_schema.INNODB_TRX
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">TIMESTAMPDIFF</span>(<span class="hljs-keyword">SECOND</span>, trx_started, <span class="hljs-keyword">NOW</span>()) &gt; <span class="hljs-number">300</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> duration_seconds <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Check for locks</span>
<span class="hljs-keyword">SELECT</span>
    r.trx_id <span class="hljs-keyword">AS</span> waiting_trx_id,
    r.trx_mysql_thread_id <span class="hljs-keyword">AS</span> waiting_thread,
    r.trx_query <span class="hljs-keyword">AS</span> waiting_query,
    b.trx_id <span class="hljs-keyword">AS</span> blocking_trx_id,
    b.trx_mysql_thread_id <span class="hljs-keyword">AS</span> blocking_thread,
    b.trx_query <span class="hljs-keyword">AS</span> blocking_query
<span class="hljs-keyword">FROM</span> information_schema.INNODB_LOCK_WAITS w
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> information_schema.INNODB_TRX b <span class="hljs-keyword">ON</span> b.trx_id = w.blocking_trx_id
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> information_schema.INNODB_TRX r <span class="hljs-keyword">ON</span> r.trx_id = w.requesting_trx_id;

<span class="hljs-comment">-- Kill blocking transaction if needed</span>
<span class="hljs-keyword">KILL</span> <span class="hljs-number">12345</span>; <span class="hljs-comment">-- Replace with actual thread ID</span>
</div></code></pre>
<hr>
<h2 id="%F0%9F%8C%90-distributed-transactions">ğŸŒ Distributed Transactions</h2>
<h3 id="two-phase-commit-2pc">Two-Phase Commit (2PC)</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- PostgreSQL: Prepared transactions (2PC)</span>
<span class="hljs-comment">-- Phase 1: Prepare</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (customer_id, total_amount) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">100.00</span>);
<span class="hljs-keyword">UPDATE</span> inventory <span class="hljs-keyword">SET</span> quantity = quantity - <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> product_id = <span class="hljs-number">1</span>;
<span class="hljs-keyword">PREPARE</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-string">'order_txn_12345'</span>;

<span class="hljs-comment">-- Phase 2: Commit or Rollback</span>
<span class="hljs-comment">-- On success:</span>
<span class="hljs-keyword">COMMIT</span> PREPARED <span class="hljs-string">'order_txn_12345'</span>;

<span class="hljs-comment">-- On failure:</span>
<span class="hljs-keyword">ROLLBACK</span> PREPARED <span class="hljs-string">'order_txn_12345'</span>;

<span class="hljs-comment">-- Check prepared transactions</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pg_prepared_xacts;

<span class="hljs-comment">-- Cleanup orphaned prepared transactions</span>
<span class="hljs-keyword">SELECT</span>
    gid,
    prepared,
    owner,
    <span class="hljs-keyword">database</span>
<span class="hljs-keyword">FROM</span> pg_prepared_xacts
<span class="hljs-keyword">WHERE</span> prepared &lt; <span class="hljs-keyword">NOW</span>() - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'1 hour'</span>;

<span class="hljs-comment">-- Example distributed transaction coordinator</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> distributed_order_process(
    p_customer_id <span class="hljs-built_in">INT</span>,
    p_product_id <span class="hljs-built_in">INT</span>,
    p_quantity <span class="hljs-built_in">INT</span>
) <span class="hljs-keyword">RETURNS</span> <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    txn_id <span class="hljs-built_in">TEXT</span>;
    inventory_success BOOLEAN := FALSE;
    payment_success BOOLEAN := FALSE;
<span class="hljs-keyword">BEGIN</span>
    txn_id := <span class="hljs-string">'order_'</span> || p_customer_id || <span class="hljs-string">'_'</span> || <span class="hljs-keyword">extract</span>(epoch <span class="hljs-keyword">from</span> <span class="hljs-keyword">now</span>());

    <span class="hljs-comment">-- Phase 1: Prepare all participants</span>
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-comment">-- Prepare inventory transaction</span>
        <span class="hljs-keyword">BEGIN</span>;
        <span class="hljs-keyword">UPDATE</span> inventory <span class="hljs-keyword">SET</span> quantity = quantity - p_quantity
        <span class="hljs-keyword">WHERE</span> product_id = p_product_id <span class="hljs-keyword">AND</span> quantity &gt;= p_quantity;

        IF NOT FOUND THEN
            <span class="hljs-keyword">ROLLBACK</span>;
            RETURN FALSE;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-keyword">PREPARE</span> <span class="hljs-keyword">TRANSACTION</span> txn_id || <span class="hljs-string">'_inventory'</span>;
        inventory_success := TRUE;

        <span class="hljs-comment">-- Prepare payment transaction</span>
        <span class="hljs-keyword">BEGIN</span>;
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (customer_id, product_id, quantity, <span class="hljs-keyword">status</span>)
        <span class="hljs-keyword">VALUES</span> (p_customer_id, p_product_id, p_quantity, <span class="hljs-string">'pending'</span>);

        <span class="hljs-comment">-- Simulate payment processing</span>
        IF random() &gt; 0.1 THEN <span class="hljs-comment">-- 90% success rate</span>
            <span class="hljs-keyword">PREPARE</span> <span class="hljs-keyword">TRANSACTION</span> txn_id || <span class="hljs-string">'_payment'</span>;
            payment_success := TRUE;
        ELSE
            <span class="hljs-keyword">ROLLBACK</span>;
            payment_success := FALSE;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    EXCEPTION
        WHEN OTHERS THEN
            <span class="hljs-comment">-- Cleanup on error</span>
            IF inventory_success THEN
                <span class="hljs-keyword">ROLLBACK</span> PREPARED txn_id || <span class="hljs-string">'_inventory'</span>;
            <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
            RETURN FALSE;
    <span class="hljs-keyword">END</span>;

    <span class="hljs-comment">-- Phase 2: Commit or rollback all</span>
    IF inventory_success AND payment_success THEN
        <span class="hljs-keyword">COMMIT</span> PREPARED txn_id || <span class="hljs-string">'_inventory'</span>;
        <span class="hljs-keyword">COMMIT</span> PREPARED txn_id || <span class="hljs-string">'_payment'</span>;
        RETURN TRUE;
    ELSE
        IF inventory_success THEN
            <span class="hljs-keyword">ROLLBACK</span> PREPARED txn_id || <span class="hljs-string">'_inventory'</span>;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
        IF payment_success THEN
            <span class="hljs-keyword">ROLLBACK</span> PREPARED txn_id || <span class="hljs-string">'_payment'</span>;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
        RETURN FALSE;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
<span class="hljs-keyword">END</span>;
$$ LANGUAGE plpgsql;
</div></code></pre>
<h3 id="saga-pattern-alternative-to-2pc">Saga Pattern (Alternative to 2PC)</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- PostgreSQL: Saga pattern implementation</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> saga_transactions (
    saga_id <span class="hljs-keyword">UUID</span> PRIMARY <span class="hljs-keyword">KEY</span> <span class="hljs-keyword">DEFAULT</span> gen_random_uuid(),
    saga_type <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">status</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'started'</span>,
    current_step <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>,
    total_steps <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">data</span> JSONB,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    updated_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> saga_steps (
    step_id <span class="hljs-keyword">UUID</span> PRIMARY <span class="hljs-keyword">KEY</span> <span class="hljs-keyword">DEFAULT</span> gen_random_uuid(),
    saga_id <span class="hljs-keyword">UUID</span> <span class="hljs-keyword">REFERENCES</span> saga_transactions(saga_id),
    step_number <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    step_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">status</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'pending'</span>,
    forward_action <span class="hljs-built_in">TEXT</span>,
    compensate_action <span class="hljs-built_in">TEXT</span>,
    <span class="hljs-keyword">result</span> JSONB,
    executed_at <span class="hljs-built_in">TIMESTAMP</span>,
    compensated_at <span class="hljs-built_in">TIMESTAMP</span>
);

<span class="hljs-comment">-- Order processing saga</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> start_order_saga(
    p_customer_id <span class="hljs-built_in">INT</span>,
    p_product_id <span class="hljs-built_in">INT</span>,
    p_quantity <span class="hljs-built_in">INT</span>,
    p_amount <span class="hljs-built_in">DECIMAL</span>
) <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">UUID</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    saga_id <span class="hljs-keyword">UUID</span>;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- Create saga transaction</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> saga_transactions (saga_type, total_steps, <span class="hljs-keyword">data</span>)
    <span class="hljs-keyword">VALUES</span> (
        <span class="hljs-string">'order_processing'</span>,
        <span class="hljs-number">4</span>,
        jsonb_build_object(
            <span class="hljs-string">'customer_id'</span>, p_customer_id,
            <span class="hljs-string">'product_id'</span>, p_product_id,
            <span class="hljs-string">'quantity'</span>, p_quantity,
            <span class="hljs-string">'amount'</span>, p_amount
        )
    ) <span class="hljs-keyword">RETURNING</span> saga_transactions.saga_id <span class="hljs-keyword">INTO</span> saga_id;

    <span class="hljs-comment">-- Define saga steps</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> saga_steps (saga_id, step_number, step_name, forward_action, compensate_action)
    <span class="hljs-keyword">VALUES</span>
    (saga_id, <span class="hljs-number">1</span>, <span class="hljs-string">'reserve_inventory'</span>, <span class="hljs-string">'reserve_product_inventory'</span>, <span class="hljs-string">'release_product_inventory'</span>),
    (saga_id, <span class="hljs-number">2</span>, <span class="hljs-string">'process_payment'</span>, <span class="hljs-string">'charge_customer_payment'</span>, <span class="hljs-string">'refund_customer_payment'</span>),
    (saga_id, <span class="hljs-number">3</span>, <span class="hljs-string">'create_order'</span>, <span class="hljs-string">'create_customer_order'</span>, <span class="hljs-string">'cancel_customer_order'</span>),
    (saga_id, <span class="hljs-number">4</span>, <span class="hljs-string">'send_confirmation'</span>, <span class="hljs-string">'send_order_confirmation'</span>, <span class="hljs-string">'send_cancellation_notice'</span>);

    <span class="hljs-comment">-- Start processing</span>
    PERFORM process_saga_step(saga_id, 1);

    RETURN saga_id;
<span class="hljs-keyword">END</span>;
$$ LANGUAGE plpgsql;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> process_saga_step(
    p_saga_id <span class="hljs-keyword">UUID</span>,
    p_step_number <span class="hljs-built_in">INT</span>
) <span class="hljs-keyword">RETURNS</span> <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    saga_data JSONB;
    step_record RECORD;
    success BOOLEAN := FALSE;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- Get saga data</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">INTO</span> saga_data <span class="hljs-keyword">FROM</span> saga_transactions <span class="hljs-keyword">WHERE</span> saga_id = p_saga_id;

    <span class="hljs-comment">-- Get step details</span>
    <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">INTO</span> step_record <span class="hljs-keyword">FROM</span> saga_steps
    <span class="hljs-keyword">WHERE</span> saga_id = p_saga_id <span class="hljs-keyword">AND</span> step_number = p_step_number;

    <span class="hljs-comment">-- Execute step based on step name</span>
    CASE step_record.step_name
        WHEN 'reserve_inventory' THEN
            success := execute_inventory_reservation(saga_data);
        WHEN 'process_payment' THEN
            success := execute_payment_processing(saga_data);
        WHEN 'create_order' THEN
            success := execute_order_creation(saga_data);
        WHEN 'send_confirmation' THEN
            success := execute_confirmation_sending(saga_data);
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">CASE</span>;

    <span class="hljs-comment">-- Update step status</span>
    <span class="hljs-keyword">UPDATE</span> saga_steps
    <span class="hljs-keyword">SET</span> <span class="hljs-keyword">status</span> = <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">success</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'completed'</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'failed'</span> <span class="hljs-keyword">END</span>,
        executed_at = <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
    <span class="hljs-keyword">WHERE</span> saga_id = p_saga_id <span class="hljs-keyword">AND</span> step_number = p_step_number;

    IF success THEN
        <span class="hljs-comment">-- Move to next step or complete saga</span>
        IF p_step_number &lt; (<span class="hljs-keyword">SELECT</span> total_steps <span class="hljs-keyword">FROM</span> saga_transactions <span class="hljs-keyword">WHERE</span> saga_id = p_saga_id) <span class="hljs-keyword">THEN</span>
            <span class="hljs-keyword">UPDATE</span> saga_transactions
            <span class="hljs-keyword">SET</span> current_step = p_step_number + <span class="hljs-number">1</span>
            <span class="hljs-keyword">WHERE</span> saga_id = p_saga_id;

            PERFORM process_saga_step(p_saga_id, p_step_number + 1);
        ELSE
            <span class="hljs-keyword">UPDATE</span> saga_transactions
            <span class="hljs-keyword">SET</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
            <span class="hljs-keyword">WHERE</span> saga_id = p_saga_id;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
    ELSE
        <span class="hljs-comment">-- Start compensation</span>
        <span class="hljs-keyword">UPDATE</span> saga_transactions
        <span class="hljs-keyword">SET</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'compensating'</span>
        <span class="hljs-keyword">WHERE</span> saga_id = p_saga_id;

        PERFORM compensate_saga(p_saga_id, p_step_number - 1);
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    RETURN success;
<span class="hljs-keyword">END</span>;
$$ LANGUAGE plpgsql;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> compensate_saga(
    p_saga_id <span class="hljs-keyword">UUID</span>,
    p_from_step <span class="hljs-built_in">INT</span>
) <span class="hljs-keyword">RETURNS</span> <span class="hljs-built_in">VOID</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    step_record <span class="hljs-built_in">RECORD</span>;
    saga_data JSONB;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">INTO</span> saga_data <span class="hljs-keyword">FROM</span> saga_transactions <span class="hljs-keyword">WHERE</span> saga_id = p_saga_id;

    <span class="hljs-comment">-- Compensate steps in reverse order</span>
    FOR step_record IN
        <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> saga_steps
        <span class="hljs-keyword">WHERE</span> saga_id = p_saga_id
          <span class="hljs-keyword">AND</span> step_number &lt;= p_from_step
          <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> step_number <span class="hljs-keyword">DESC</span>
    <span class="hljs-keyword">LOOP</span>
        <span class="hljs-comment">-- Execute compensation action</span>
        <span class="hljs-keyword">CASE</span> step_record.step_name
            <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'reserve_inventory'</span> <span class="hljs-keyword">THEN</span>
                PERFORM compensate_inventory_reservation(saga_data);
            WHEN 'process_payment' THEN
                PERFORM compensate_payment_processing(saga_data);
            WHEN 'create_order' THEN
                PERFORM compensate_order_creation(saga_data);
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">CASE</span>;

        <span class="hljs-keyword">UPDATE</span> saga_steps
        <span class="hljs-keyword">SET</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'compensated'</span>,
            compensated_at = <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
        <span class="hljs-keyword">WHERE</span> step_id = step_record.step_id;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;

    <span class="hljs-keyword">UPDATE</span> saga_transactions
    <span class="hljs-keyword">SET</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'compensated'</span>
    <span class="hljs-keyword">WHERE</span> saga_id = p_saga_id;
<span class="hljs-keyword">END</span>;
$$ LANGUAGE plpgsql;
</div></code></pre>
<hr>
<h2 id="%F0%9F%92%A1-real-world-business-examples">ğŸ’¡ Real-World Business Examples</h2>
<h3 id="example-1-e-commerce-checkout-process">Example 1: E-commerce Checkout Process</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Complete checkout transaction with multiple validations</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> process_checkout(
    p_customer_id <span class="hljs-built_in">INT</span>,
    p_cart_items JSONB,
    p_payment_method <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    p_shipping_address JSONB
) <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TABLE</span>(
    <span class="hljs-keyword">success</span> <span class="hljs-built_in">BOOLEAN</span>,
    order_id <span class="hljs-built_in">INT</span>,
    message <span class="hljs-built_in">TEXT</span>,
    total_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
) <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    v_order_id <span class="hljs-built_in">INT</span>;
    v_total_amount DECIMAL(10,2) := 0;
    v_item JSONB;
    v_product RECORD;
    v_customer RECORD;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- Start transaction with appropriate isolation level</span>
    <span class="hljs-keyword">SET</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> REPEATABLE <span class="hljs-keyword">READ</span>;

    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-comment">-- Validate customer</span>
        <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">INTO</span> v_customer <span class="hljs-keyword">FROM</span> customers
        <span class="hljs-keyword">WHERE</span> customer_id = p_customer_id <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>;

        IF NOT FOUND THEN
            RETURN QUERY <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">FALSE</span>, <span class="hljs-literal">NULL</span>::<span class="hljs-built_in">INT</span>, <span class="hljs-string">'Invalid customer'</span>::<span class="hljs-built_in">TEXT</span>, <span class="hljs-number">0</span>::<span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>);
            RETURN;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-comment">-- Create order</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (customer_id, <span class="hljs-keyword">status</span>, order_date, shipping_address)
        <span class="hljs-keyword">VALUES</span> (p_customer_id, <span class="hljs-string">'processing'</span>, <span class="hljs-keyword">CURRENT_TIMESTAMP</span>, p_shipping_address)
        <span class="hljs-keyword">RETURNING</span> orders.order_id <span class="hljs-keyword">INTO</span> v_order_id;

        <span class="hljs-comment">-- Process each cart item</span>
        FOR v_item IN <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> jsonb_array_elements(p_cart_items)
        <span class="hljs-keyword">LOOP</span>
            <span class="hljs-comment">-- Lock and validate product</span>
            <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">INTO</span> v_product <span class="hljs-keyword">FROM</span> products
            <span class="hljs-keyword">WHERE</span> product_id = (v_item-&gt;&gt;<span class="hljs-string">'product_id'</span>)::<span class="hljs-built_in">INT</span>
              <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>
            <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;

            IF NOT FOUND THEN
                RAISE EXCEPTION 'Product % not found', v_item-&gt;&gt;'product_id';
            <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

            <span class="hljs-comment">-- Check stock</span>
            IF v_product.stock_quantity &lt; (v_item-&gt;&gt;'quantity')::INT THEN
                RAISE EXCEPTION 'Insufficient stock for product %. Available: %, Requested: %',
                    v_product.product_name, v_product.stock_quantity, v_item-&gt;&gt;'quantity';
            <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

            <span class="hljs-comment">-- Add order item</span>
            <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> order_items (
                order_id, product_id, quantity, unit_price, total_price
            ) <span class="hljs-keyword">VALUES</span> (
                v_order_id,
                v_product.product_id,
                (v_item-&gt;&gt;<span class="hljs-string">'quantity'</span>)::<span class="hljs-built_in">INT</span>,
                v_product.price,
                v_product.price * (v_item-&gt;&gt;<span class="hljs-string">'quantity'</span>)::<span class="hljs-built_in">INT</span>
            );

            <span class="hljs-comment">-- Update stock</span>
            <span class="hljs-keyword">UPDATE</span> products
            <span class="hljs-keyword">SET</span> stock_quantity = stock_quantity - (v_item-&gt;&gt;<span class="hljs-string">'quantity'</span>)::<span class="hljs-built_in">INT</span>
            <span class="hljs-keyword">WHERE</span> product_id = v_product.product_id;

            <span class="hljs-comment">-- Add to total</span>
            v_total_amount := v_total_amount + (v_product.price * (v_item-&gt;&gt;'quantity')::INT);
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;

        <span class="hljs-comment">-- Update order total</span>
        <span class="hljs-keyword">UPDATE</span> orders <span class="hljs-keyword">SET</span> total_amount = v_total_amount <span class="hljs-keyword">WHERE</span> order_id = v_order_id;

        <span class="hljs-comment">-- Process payment (simplified)</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> payments (
            order_id, customer_id, amount, payment_method, <span class="hljs-keyword">status</span>, processed_at
        ) <span class="hljs-keyword">VALUES</span> (
            v_order_id, p_customer_id, v_total_amount, p_payment_method, <span class="hljs-string">'completed'</span>, <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
        );

        <span class="hljs-comment">-- Update order status</span>
        <span class="hljs-keyword">UPDATE</span> orders <span class="hljs-keyword">SET</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'confirmed'</span> <span class="hljs-keyword">WHERE</span> order_id = v_order_id;

        <span class="hljs-comment">-- Update customer stats</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> customer_stats (customer_id, total_orders, total_spent, last_order_date)
        <span class="hljs-keyword">VALUES</span> (p_customer_id, <span class="hljs-number">1</span>, v_total_amount, <span class="hljs-keyword">CURRENT_DATE</span>)
        <span class="hljs-keyword">ON</span> CONFLICT (customer_id) <span class="hljs-keyword">DO</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">SET</span>
            total_orders = customer_stats.total_orders + <span class="hljs-number">1</span>,
            total_spent = customer_stats.total_spent + v_total_amount,
            last_order_date = <span class="hljs-keyword">CURRENT_DATE</span>;

        RETURN QUERY <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">TRUE</span>, v_order_id, <span class="hljs-string">'Order processed successfully'</span>::<span class="hljs-built_in">TEXT</span>, v_total_amount;

    EXCEPTION
        WHEN OTHERS THEN
            RETURN QUERY <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">FALSE</span>, <span class="hljs-literal">NULL</span>::<span class="hljs-built_in">INT</span>, SQLERRM::<span class="hljs-built_in">TEXT</span>, <span class="hljs-number">0</span>::<span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>);
    <span class="hljs-keyword">END</span>;
<span class="hljs-keyword">END</span>;
$$ LANGUAGE plpgsql;

<span class="hljs-comment">-- Usage with retry logic for serialization failures</span>
<span class="hljs-keyword">DO</span> $$
<span class="hljs-keyword">DECLARE</span>
    <span class="hljs-keyword">result</span> <span class="hljs-built_in">RECORD</span>;
    retry_count INT := 0;
    max_retries INT := 3;
    cart_data JSONB := '[
        {"product_id": 1, "quantity": 2},
        {"product_id": 3, "quantity": 1}
    ]';
    shipping_addr JSONB := '{
        "street": "123 Main St",
        "city": "Anytown",
        "state": "CA",
        "zip": "12345"
    }';
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">LOOP</span>
        <span class="hljs-keyword">BEGIN</span>
            <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">result</span> <span class="hljs-keyword">FROM</span> process_checkout(
                <span class="hljs-number">1</span>, <span class="hljs-comment">-- customer_id</span>
                cart_data,
                <span class="hljs-string">'credit_card'</span>,
                shipping_addr
            );

            IF result.success THEN
                RAISE NOTICE 'Checkout successful! Order ID: %, Total: $%',
                    result.order_id, result.total_amount;
                EXIT;
            ELSE
                RAISE NOTICE 'Checkout failed: %', result.message;
                EXIT;
            <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        EXCEPTION
            WHEN serialization_failure THEN
                retry_count := retry_count + 1;
                IF retry_count &gt;= max_retries THEN
                    RAISE NOTICE 'Checkout failed after % retries due to serialization conflicts', max_retries;
                    EXIT;
                <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

                RAISE NOTICE 'Serialization conflict, retrying... (attempt %)', retry_count;
                PERFORM pg_sleep(random() * 0.1);
        <span class="hljs-keyword">END</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;
<span class="hljs-keyword">END</span> $$;
</div></code></pre>
<h3 id="example-2-banking-system-with-audit-trail">Example 2: Banking System with Audit Trail</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Comprehensive banking transaction system</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> accounts (
    account_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    customer_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    account_number <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    account_type <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    balance <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">15</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    <span class="hljs-keyword">status</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'active'</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    updated_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> transactions (
    transaction_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    from_account_id <span class="hljs-built_in">INT</span>,
    to_account_id <span class="hljs-built_in">INT</span>,
    transaction_type <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">15</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    description <span class="hljs-built_in">TEXT</span>,
    reference_number <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span>,
    <span class="hljs-keyword">status</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'pending'</span>,
    processed_at <span class="hljs-built_in">TIMESTAMP</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (from_account_id) <span class="hljs-keyword">REFERENCES</span> accounts(account_id),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (to_account_id) <span class="hljs-keyword">REFERENCES</span> accounts(account_id)
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> transaction_audit (
    audit_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    transaction_id <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">action</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    old_values JSONB,
    new_values JSONB,
    user_id <span class="hljs-built_in">INT</span>,
    ip_address INET,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- Secure money transfer function</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> transfer_funds(
    p_from_account <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    p_to_account <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    p_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">15</span>,<span class="hljs-number">2</span>),
    p_description <span class="hljs-built_in">TEXT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,
    p_user_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>
) <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TABLE</span>(
    <span class="hljs-keyword">success</span> <span class="hljs-built_in">BOOLEAN</span>,
    transaction_id <span class="hljs-built_in">INT</span>,
    reference_number <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    message <span class="hljs-built_in">TEXT</span>
) <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    v_from_account_id <span class="hljs-built_in">INT</span>;
    v_to_account_id INT;
    v_from_balance DECIMAL(15,2);
    v_to_balance DECIMAL(15,2);
    v_transaction_id INT;
    v_reference_number VARCHAR(50);
    v_from_account_rec RECORD;
    v_to_account_rec RECORD;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- Generate unique reference number</span>
    v_reference_number := <span class="hljs-string">'TXN'</span> || to_char(<span class="hljs-keyword">CURRENT_TIMESTAMP</span>, <span class="hljs-string">'YYYYMMDDHH24MISS'</span>) ||
                         <span class="hljs-keyword">lpad</span>(<span class="hljs-keyword">floor</span>(random() * <span class="hljs-number">1000</span>)::<span class="hljs-built_in">text</span>, <span class="hljs-number">3</span>, <span class="hljs-string">'0'</span>);

    <span class="hljs-comment">-- Use serializable isolation for consistency</span>
    <span class="hljs-keyword">SET</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">SERIALIZABLE</span>;

    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-comment">-- Lock and validate accounts in consistent order to prevent deadlocks</span>
        <span class="hljs-keyword">IF</span> p_from_account &lt; p_to_account <span class="hljs-keyword">THEN</span>
            <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">INTO</span> v_from_account_rec <span class="hljs-keyword">FROM</span> accounts
            <span class="hljs-keyword">WHERE</span> account_number = p_from_account <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;

            <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">INTO</span> v_to_account_rec <span class="hljs-keyword">FROM</span> accounts
            <span class="hljs-keyword">WHERE</span> account_number = p_to_account <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
        ELSE
            <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">INTO</span> v_to_account_rec <span class="hljs-keyword">FROM</span> accounts
            <span class="hljs-keyword">WHERE</span> account_number = p_to_account <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;

            <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">INTO</span> v_from_account_rec <span class="hljs-keyword">FROM</span> accounts
            <span class="hljs-keyword">WHERE</span> account_number = p_from_account <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-comment">-- Validate accounts exist</span>
        IF v_from_account_rec.account_id IS NULL THEN
            RETURN QUERY <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">FALSE</span>, <span class="hljs-literal">NULL</span>::<span class="hljs-built_in">INT</span>, <span class="hljs-literal">NULL</span>::<span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
                <span class="hljs-string">'Source account not found or inactive'</span>::<span class="hljs-built_in">TEXT</span>;
            RETURN;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        IF v_to_account_rec.account_id IS NULL THEN
            RETURN QUERY <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">FALSE</span>, <span class="hljs-literal">NULL</span>::<span class="hljs-built_in">INT</span>, <span class="hljs-literal">NULL</span>::<span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
                <span class="hljs-string">'Destination account not found or inactive'</span>::<span class="hljs-built_in">TEXT</span>;
            RETURN;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-comment">-- Validate amount</span>
        IF p_amount &lt;= 0 THEN
            RETURN QUERY <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">FALSE</span>, <span class="hljs-literal">NULL</span>::<span class="hljs-built_in">INT</span>, <span class="hljs-literal">NULL</span>::<span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
                <span class="hljs-string">'Transfer amount must be positive'</span>::<span class="hljs-built_in">TEXT</span>;
            RETURN;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-comment">-- Check sufficient funds</span>
        IF v_from_account_rec.balance &lt; p_amount THEN
            RETURN QUERY <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">FALSE</span>, <span class="hljs-literal">NULL</span>::<span class="hljs-built_in">INT</span>, <span class="hljs-literal">NULL</span>::<span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
                <span class="hljs-keyword">format</span>(<span class="hljs-string">'Insufficient funds. Available: $%.2f, Requested: $%.2f'</span>,
                       v_from_account_rec.balance, p_amount)::<span class="hljs-built_in">TEXT</span>;
            RETURN;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-comment">-- Create transaction record</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> transactions (
            from_account_id, to_account_id, transaction_type, amount,
            description, reference_number, <span class="hljs-keyword">status</span>
        ) <span class="hljs-keyword">VALUES</span> (
            v_from_account_rec.account_id, v_to_account_rec.account_id, <span class="hljs-string">'transfer'</span>,
            p_amount, p_description, v_reference_number, <span class="hljs-string">'processing'</span>
        ) <span class="hljs-keyword">RETURNING</span> transactions.transaction_id <span class="hljs-keyword">INTO</span> v_transaction_id;

        <span class="hljs-comment">-- Audit: Transaction created</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> transaction_audit (
            transaction_id, <span class="hljs-keyword">action</span>, new_values, user_id, ip_address
        ) <span class="hljs-keyword">VALUES</span> (
            v_transaction_id, <span class="hljs-string">'created'</span>,
            jsonb_build_object(
                <span class="hljs-string">'from_account'</span>, p_from_account,
                <span class="hljs-string">'to_account'</span>, p_to_account,
                <span class="hljs-string">'amount'</span>, p_amount,
                <span class="hljs-string">'reference'</span>, v_reference_number
            ),
            p_user_id, inet_client_addr()
        );

        <span class="hljs-comment">-- Update account balances</span>
        <span class="hljs-keyword">UPDATE</span> accounts
        <span class="hljs-keyword">SET</span> balance = balance - p_amount, updated_at = <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
        <span class="hljs-keyword">WHERE</span> account_id = v_from_account_rec.account_id;

        <span class="hljs-keyword">UPDATE</span> accounts
        <span class="hljs-keyword">SET</span> balance = balance + p_amount, updated_at = <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
        <span class="hljs-keyword">WHERE</span> account_id = v_to_account_rec.account_id;

        <span class="hljs-comment">-- Update transaction status</span>
        <span class="hljs-keyword">UPDATE</span> transactions
        <span class="hljs-keyword">SET</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'completed'</span>, processed_at = <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
        <span class="hljs-keyword">WHERE</span> transaction_id = v_transaction_id;

        <span class="hljs-comment">-- Audit: Transaction completed</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> transaction_audit (
            transaction_id, <span class="hljs-keyword">action</span>, new_values, user_id, ip_address
        ) <span class="hljs-keyword">VALUES</span> (
            v_transaction_id, <span class="hljs-string">'completed'</span>,
            jsonb_build_object(
                <span class="hljs-string">'from_balance_after'</span>, v_from_account_rec.balance - p_amount,
                <span class="hljs-string">'to_balance_after'</span>, v_to_account_rec.balance + p_amount,
                <span class="hljs-string">'processed_at'</span>, <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
            ),
            p_user_id, inet_client_addr()
        );

        RETURN QUERY <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">TRUE</span>, v_transaction_id, v_reference_number,
            <span class="hljs-keyword">format</span>(<span class="hljs-string">'Transfer completed successfully. Reference: %s'</span>, v_reference_number)::<span class="hljs-built_in">TEXT</span>;

    EXCEPTION
        WHEN serialization_failure THEN
            <span class="hljs-comment">-- Update transaction status to failed</span>
            IF v_transaction_id IS NOT NULL THEN
                <span class="hljs-keyword">UPDATE</span> transactions
                <span class="hljs-keyword">SET</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'failed'</span>
                <span class="hljs-keyword">WHERE</span> transaction_id = v_transaction_id;

                <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> transaction_audit (
                    transaction_id, <span class="hljs-keyword">action</span>, new_values, user_id, ip_address
                ) <span class="hljs-keyword">VALUES</span> (
                    v_transaction_id, <span class="hljs-string">'failed'</span>,
                    jsonb_build_object(<span class="hljs-string">'error'</span>, <span class="hljs-string">'serialization_failure'</span>),
                    p_user_id, inet_client_addr()
                );
            <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

            RETURN QUERY <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">FALSE</span>, v_transaction_id, v_reference_number,
                <span class="hljs-string">'Transfer failed due to concurrent access. Please retry.'</span>::<span class="hljs-built_in">TEXT</span>;

        WHEN OTHERS THEN
            <span class="hljs-comment">-- Update transaction status to failed</span>
            IF v_transaction_id IS NOT NULL THEN
                <span class="hljs-keyword">UPDATE</span> transactions
                <span class="hljs-keyword">SET</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'failed'</span>
                <span class="hljs-keyword">WHERE</span> transaction_id = v_transaction_id;

                <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> transaction_audit (
                    transaction_id, <span class="hljs-keyword">action</span>, new_values, user_id, ip_address
                ) <span class="hljs-keyword">VALUES</span> (
                    v_transaction_id, <span class="hljs-string">'failed'</span>,
                    jsonb_build_object(<span class="hljs-string">'error'</span>, SQLERRM),
                    p_user_id, inet_client_addr()
                );
            <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

            RETURN QUERY <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">FALSE</span>, v_transaction_id, v_reference_number,
                <span class="hljs-keyword">format</span>(<span class="hljs-string">'Transfer failed: %s'</span>, SQLERRM)::<span class="hljs-built_in">TEXT</span>;
    <span class="hljs-keyword">END</span>;
<span class="hljs-keyword">END</span>;
$$ LANGUAGE plpgsql SECURITY DEFINER;

<span class="hljs-comment">-- Usage example with retry logic</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> safe_transfer_with_retry(
    p_from_account <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    p_to_account <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    p_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">15</span>,<span class="hljs-number">2</span>),
    p_description <span class="hljs-built_in">TEXT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,
    p_user_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>
) <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TABLE</span>(
    <span class="hljs-keyword">success</span> <span class="hljs-built_in">BOOLEAN</span>,
    transaction_id <span class="hljs-built_in">INT</span>,
    reference_number <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    message <span class="hljs-built_in">TEXT</span>,
    attempts <span class="hljs-built_in">INT</span>
) <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    <span class="hljs-keyword">result</span> <span class="hljs-built_in">RECORD</span>;
    retry_count INT := 0;
    max_retries INT := 3;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">LOOP</span>
        <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">result</span> <span class="hljs-keyword">FROM</span> transfer_funds(
            p_from_account, p_to_account, p_amount, p_description, p_user_id
        );

        IF result.success OR retry_count &gt;= max_retries THEN
            RETURN QUERY <span class="hljs-keyword">SELECT</span> result.success, result.transaction_id,
                result.reference_number, result.message, retry_count + <span class="hljs-number">1</span>;
            RETURN;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

        <span class="hljs-comment">-- Only retry on serialization failures</span>
        IF result.message LIKE '%concurrent access%' THEN
            retry_count := retry_count + 1;
            PERFORM pg_sleep(random() * 0.1); <span class="hljs-comment">-- Random delay</span>
        ELSE
            RETURN QUERY <span class="hljs-keyword">SELECT</span> result.success, result.transaction_id,
                result.reference_number, result.message, retry_count + <span class="hljs-number">1</span>;
            RETURN;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;
<span class="hljs-keyword">END</span>;
$$ LANGUAGE plpgsql;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-use-cases--interview-tips">ğŸ¯ Use Cases &amp; Interview Tips</h2>
<h3 id="common-interview-questions">Common Interview Questions:</h3>
<ol>
<li>
<p><strong>&quot;Explain the ACID properties with examples.&quot;</strong></p>
<ul>
<li><strong>Atomicity</strong>: Bank transfer - both debit and credit must succeed</li>
<li><strong>Consistency</strong>: Account balances must follow business rules</li>
<li><strong>Isolation</strong>: Concurrent transfers don't interfere</li>
<li><strong>Durability</strong>: Committed transactions survive system crashes</li>
</ul>
</li>
<li>
<p><strong>&quot;What's the difference between optimistic and pessimistic locking?&quot;</strong></p>
<ul>
<li><strong>Pessimistic</strong>: Lock data when reading (SELECT FOR UPDATE)</li>
<li><strong>Optimistic</strong>: Check for conflicts at commit time (version numbers)</li>
<li><strong>Use pessimistic</strong> for high contention, critical data</li>
<li><strong>Use optimistic</strong> for low contention, better performance</li>
</ul>
</li>
<li>
<p><strong>&quot;How do you handle deadlocks?&quot;</strong></p>
<ul>
<li><strong>Prevention</strong>: Lock resources in consistent order</li>
<li><strong>Detection</strong>: Database automatically detects and resolves</li>
<li><strong>Recovery</strong>: Retry failed transactions with exponential backoff</li>
<li><strong>Monitoring</strong>: Track deadlock frequency and patterns</li>
</ul>
</li>
<li>
<p><strong>&quot;When would you use different isolation levels?&quot;</strong></p>
<ul>
<li><strong>READ UNCOMMITTED</strong>: Rarely, only for approximate analytics</li>
<li><strong>READ COMMITTED</strong>: Default for most applications</li>
<li><strong>REPEATABLE READ</strong>: Financial calculations, reporting</li>
<li><strong>SERIALIZABLE</strong>: Critical business logic, audit requirements</li>
</ul>
</li>
</ol>
<h3 id="best-practices">Best Practices:</h3>
<ol>
<li><strong>Keep transactions short and focused</strong></li>
<li><strong>Use appropriate isolation levels</strong></li>
<li><strong>Handle deadlocks gracefully with retries</strong></li>
<li><strong>Implement proper error handling and logging</strong></li>
<li><strong>Monitor transaction performance and blocking</strong></li>
<li><strong>Use connection pooling effectively</strong></li>
</ol>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-things-to-watch-out-for">âš ï¸ Things to Watch Out For</h2>
<h3 id="1-long-running-transactions">1. <strong>Long-Running Transactions</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Transaction holds locks too long</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>; <span class="hljs-comment">-- Locks all products</span>
<span class="hljs-comment">-- Long processing time or user input</span>
<span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> price = price * <span class="hljs-number">1.1</span>;
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- Solution: Minimize lock time</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> product_id, price <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> category_id = <span class="hljs-number">1</span>;
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- Process data in application</span>

<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> price = new_price <span class="hljs-keyword">WHERE</span> product_id = specific_id;
<span class="hljs-keyword">COMMIT</span>;
</div></code></pre>
<h3 id="2-implicit-transactions">2. <strong>Implicit Transactions</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Forgetting about auto-commit behavior</span>
<span class="hljs-comment">-- MySQL (auto-commit ON by default)</span>
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance = balance - <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">1</span>;
<span class="hljs-comment">-- This commits immediately!</span>
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance = balance + <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">2</span>;
<span class="hljs-comment">-- If this fails, first update is already committed</span>

<span class="hljs-comment">-- Solution: Explicit transaction control</span>
<span class="hljs-keyword">START</span> <span class="hljs-keyword">TRANSACTION</span>;
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance = balance - <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">1</span>;
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance = balance + <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">2</span>;
<span class="hljs-keyword">COMMIT</span>;
</div></code></pre>
<h3 id="3-nested-transaction-confusion">3. <strong>Nested Transaction Confusion</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Misunderstanding nested transactions</span>
<span class="hljs-comment">-- PostgreSQL doesn't support true nested transactions</span>
<span class="hljs-keyword">BEGIN</span>;
  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders <span class="hljs-keyword">VALUES</span> (...);
  <span class="hljs-keyword">BEGIN</span>; <span class="hljs-comment">-- This is ignored!</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> order_items <span class="hljs-keyword">VALUES</span> (...);
  <span class="hljs-keyword">ROLLBACK</span>; <span class="hljs-comment">-- This rolls back the entire transaction!</span>
<span class="hljs-keyword">COMMIT</span>; <span class="hljs-comment">-- This will fail because transaction was rolled back</span>

<span class="hljs-comment">-- Solution: Use savepoints</span>
<span class="hljs-keyword">BEGIN</span>;
  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders <span class="hljs-keyword">VALUES</span> (...);
  <span class="hljs-keyword">SAVEPOINT</span> order_created;
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> order_items <span class="hljs-keyword">VALUES</span> (...);
  <span class="hljs-keyword">ROLLBACK</span> <span class="hljs-keyword">TO</span> <span class="hljs-keyword">SAVEPOINT</span> order_created; <span class="hljs-comment">-- Only rolls back to savepoint</span>
  <span class="hljs-comment">-- Order insert is still valid</span>
<span class="hljs-keyword">COMMIT</span>;
</div></code></pre>
<h3 id="4-deadlock-prone-code-patterns">4. <strong>Deadlock-Prone Code Patterns</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Inconsistent lock ordering</span>
<span class="hljs-comment">-- Session 1:</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance = balance - <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">1</span>;
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance = balance + <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">2</span>;
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- Session 2 (concurrent):</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance = balance - <span class="hljs-number">50</span> <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">2</span>;
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance = balance + <span class="hljs-number">50</span> <span class="hljs-keyword">WHERE</span> account_id = <span class="hljs-number">1</span>;
<span class="hljs-keyword">COMMIT</span>;
<span class="hljs-comment">-- Deadlock!</span>

<span class="hljs-comment">-- Solution: Consistent lock ordering</span>
<span class="hljs-comment">-- Both sessions:</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-comment">-- Always lock lower account_id first</span>
IF from_account &lt; to_account THEN
  <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> account_id = from_account <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
  <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> account_id = to_account <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
ELSE
  <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> account_id = to_account <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
  <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> account_id = from_account <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
<span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
<span class="hljs-comment">-- Perform updates</span>
<span class="hljs-keyword">COMMIT</span>;
</div></code></pre>
<h3 id="5-isolation-level-misunderstanding">5. <strong>Isolation Level Misunderstanding</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Using wrong isolation level</span>
<span class="hljs-comment">-- Using SERIALIZABLE for everything (performance impact)</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">SERIALIZABLE</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">FROM</span> page_views; <span class="hljs-comment">-- Simple analytics query</span>

<span class="hljs-comment">-- Solution: Use appropriate isolation level</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">READ</span> COMMITTED;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">FROM</span> page_views; <span class="hljs-comment">-- Sufficient for analytics</span>

<span class="hljs-comment">-- Use SERIALIZABLE only when necessary</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">SERIALIZABLE</span>;
<span class="hljs-comment">-- Critical financial calculations</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">SUM</span>(balance) <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-number">123</span>;
</div></code></pre>
<h3 id="6-connection-pool-exhaustion">6. <strong>Connection Pool Exhaustion</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Holding connections too long</span>
<span class="hljs-comment">-- Application code (pseudo-code):</span>
connection = get_connection()
connection.begin()
<span class="hljs-keyword">result</span> = connection.execute(<span class="hljs-string">"SELECT * FROM large_table"</span>)
<span class="hljs-comment">-- Long processing time</span>
process_large_result_set(<span class="hljs-keyword">result</span>)
connection.commit()
connection.close()

<span class="hljs-comment">-- Solution: Minimize connection hold time</span>
<span class="hljs-keyword">connection</span> = get_connection()
<span class="hljs-keyword">result</span> = connection.execute(<span class="hljs-string">"SELECT * FROM large_table"</span>)
connection.close()

<span class="hljs-comment">-- Process data without holding connection</span>
process_large_result_set(<span class="hljs-keyword">result</span>)

<span class="hljs-comment">-- New connection for updates</span>
<span class="hljs-keyword">connection</span> = get_connection()
connection.begin()
connection.execute(<span class="hljs-string">"UPDATE table SET ..."</span>)
connection.commit()
connection.close()
</div></code></pre>
<h3 id="7-phantom-read-confusion">7. <strong>Phantom Read Confusion</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Not understanding phantom reads</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> REPEATABLE <span class="hljs-keyword">READ</span>;
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'pending'</span>; <span class="hljs-comment">-- Returns 10</span>

<span class="hljs-comment">-- Another session inserts new pending order</span>

<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'pending'</span>; <span class="hljs-comment">-- Might show 11 rows!</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- Solution: Use SERIALIZABLE if phantom reads are problematic</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">SERIALIZABLE</span>;
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'pending'</span>;
<span class="hljs-comment">-- New inserts will be blocked or cause serialization failure</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'pending'</span>;
<span class="hljs-keyword">COMMIT</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%9A-summary">ğŸ“š Summary</h2>
<p>Transactions and concurrency control are fundamental to maintaining data integrity in multi-user database systems. Key takeaways:</p>
<ul>
<li><strong>ACID properties</strong> ensure reliable transaction processing</li>
<li><strong>Isolation levels</strong> control what changes are visible between transactions</li>
<li><strong>Locking mechanisms</strong> prevent data corruption from concurrent access</li>
<li><strong>Deadlock prevention</strong> requires consistent resource ordering</li>
<li><strong>Performance optimization</strong> involves keeping transactions short and using appropriate isolation levels</li>
<li><strong>Error handling</strong> must account for serialization failures and deadlocks</li>
<li><strong>Monitoring</strong> helps identify performance bottlenecks and blocking issues</li>
</ul>
<p>Master these concepts to build robust, scalable database applications that handle concurrent users safely and efficiently.</p>
<hr>
<h2 id="%F0%9F%94%97-next-steps">ğŸ”— Next Steps</h2>
<p>In the next chapter, we'll explore <strong>Database Security and User Management</strong>, covering authentication, authorization, encryption, and security best practices for protecting sensitive data.</p>
<hr>
<p><em>Remember: Transactions are not just about data consistencyâ€”they're about building trust in your application's reliability.</em></p>
<h1 id="chapter-16-database-security-and-user-management">Chapter 16: Database Security and User Management</h1>
<h2 id="%F0%9F%93%9A-what-youll-learn">ğŸ“š What You'll Learn</h2>
<p>Database security is critical for protecting sensitive data and ensuring compliance with regulations. This chapter covers authentication, authorization, encryption, auditing, and security best practices for MySQL and PostgreSQL.</p>
<hr>
<h2 id="%F0%9F%8E%AF-learning-objectives">ğŸ¯ Learning Objectives</h2>
<p>By the end of this chapter, you will:</p>
<ul>
<li>Understand database security fundamentals</li>
<li>Create and manage database users and roles</li>
<li>Implement proper access control and permissions</li>
<li>Configure SSL/TLS encryption</li>
<li>Set up database auditing and monitoring</li>
<li>Apply security best practices</li>
<li>Handle common security vulnerabilities</li>
<li>Implement data masking and anonymization</li>
</ul>
<hr>
<h2 id="%F0%9F%94%8D-concept-explanation">ğŸ” Concept Explanation</h2>
<h3 id="database-security-fundamentals">Database Security Fundamentals</h3>
<p><strong>The CIA Triad:</strong></p>
<ul>
<li><strong>Confidentiality</strong>: Data is accessible only to authorized users</li>
<li><strong>Integrity</strong>: Data remains accurate and unmodified</li>
<li><strong>Availability</strong>: Data is accessible when needed</li>
</ul>
<p><strong>Security Layers:</strong></p>
<ol>
<li><strong>Network Security</strong>: Firewalls, VPNs, network segmentation</li>
<li><strong>Authentication</strong>: Verifying user identity</li>
<li><strong>Authorization</strong>: Controlling what users can do</li>
<li><strong>Encryption</strong>: Protecting data in transit and at rest</li>
<li><strong>Auditing</strong>: Tracking database activities</li>
<li><strong>Application Security</strong>: Preventing SQL injection, etc.</li>
</ol>
<h3 id="authentication-vs-authorization">Authentication vs Authorization</h3>
<p><strong>Authentication</strong> (&quot;Who are you?&quot;):</p>
<ul>
<li>Password-based authentication</li>
<li>Certificate-based authentication</li>
<li>Multi-factor authentication (MFA)</li>
<li>LDAP/Active Directory integration</li>
<li>OAuth/SAML integration</li>
</ul>
<p><strong>Authorization</strong> (&quot;What can you do?&quot;):</p>
<ul>
<li>Role-based access control (RBAC)</li>
<li>Attribute-based access control (ABAC)</li>
<li>Principle of least privilege</li>
<li>Granular permissions</li>
</ul>
<hr>
<h2 id="%F0%9F%9B%A0%EF%B8%8F-user-and-role-management">ğŸ› ï¸ User and Role Management</h2>
<h3 id="mysql-user-management">MySQL User Management</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Create users</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'app_user'</span>@<span class="hljs-string">'localhost'</span> <span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'SecurePassword123!'</span>;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'readonly_user'</span>@<span class="hljs-string">'%'</span> <span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'ReadOnlyPass456!'</span>;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'admin_user'</span>@<span class="hljs-string">'10.0.0.%'</span> <span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'AdminPass789!'</span>;

<span class="hljs-comment">-- Create user with SSL requirement</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'secure_user'</span>@<span class="hljs-string">'%'</span>
<span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'SecurePass123!'</span>
REQUIRE SSL;

<span class="hljs-comment">-- Create user with certificate authentication</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'cert_user'</span>@<span class="hljs-string">'%'</span>
<span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'CertPass123!'</span>
REQUIRE X509;

<span class="hljs-comment">-- View users</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">User</span>, Host, ssl_type, ssl_cipher, x509_issuer, x509_subject
<span class="hljs-keyword">FROM</span> mysql.user;

<span class="hljs-comment">-- Modify user password</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'app_user'</span>@<span class="hljs-string">'localhost'</span> <span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'NewSecurePassword123!'</span>;

<span class="hljs-comment">-- Set password expiration</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'app_user'</span>@<span class="hljs-string">'localhost'</span> <span class="hljs-keyword">PASSWORD</span> <span class="hljs-keyword">EXPIRE</span> <span class="hljs-built_in">INTERVAL</span> <span class="hljs-number">90</span> <span class="hljs-keyword">DAY</span>;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'temp_user'</span>@<span class="hljs-string">'localhost'</span> <span class="hljs-keyword">PASSWORD</span> <span class="hljs-keyword">EXPIRE</span>;

<span class="hljs-comment">-- Account locking</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'suspicious_user'</span>@<span class="hljs-string">'%'</span> <span class="hljs-keyword">ACCOUNT</span> <span class="hljs-keyword">LOCK</span>;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'suspicious_user'</span>@<span class="hljs-string">'%'</span> <span class="hljs-keyword">ACCOUNT</span> <span class="hljs-keyword">UNLOCK</span>;

<span class="hljs-comment">-- Drop user</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'old_user'</span>@<span class="hljs-string">'localhost'</span>;

<span class="hljs-comment">-- Create roles (MySQL 8.0+)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> <span class="hljs-string">'app_read'</span>, <span class="hljs-string">'app_write'</span>, <span class="hljs-string">'app_admin'</span>;

<span class="hljs-comment">-- Grant privileges to roles</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> ecommerce.* <span class="hljs-keyword">TO</span> <span class="hljs-string">'app_read'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, <span class="hljs-keyword">INSERT</span>, <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> ecommerce.* <span class="hljs-keyword">TO</span> <span class="hljs-string">'app_write'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">PRIVILEGES</span> <span class="hljs-keyword">ON</span> ecommerce.* <span class="hljs-keyword">TO</span> <span class="hljs-string">'app_admin'</span>;

<span class="hljs-comment">-- Grant roles to users</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-string">'app_read'</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">'readonly_user'</span>@<span class="hljs-string">'%'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-string">'app_write'</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">'app_user'</span>@<span class="hljs-string">'localhost'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-string">'app_admin'</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">'admin_user'</span>@<span class="hljs-string">'10.0.0.%'</span>;

<span class="hljs-comment">-- Set default roles</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">ROLE</span> <span class="hljs-string">'app_read'</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">'readonly_user'</span>@<span class="hljs-string">'%'</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">ROLE</span> <span class="hljs-string">'app_write'</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">'app_user'</span>@<span class="hljs-string">'localhost'</span>;

<span class="hljs-comment">-- Activate roles in session</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">ROLE</span> <span class="hljs-string">'app_admin'</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">ROLE</span> <span class="hljs-keyword">ALL</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">ROLE</span> <span class="hljs-keyword">NONE</span>;

<span class="hljs-comment">-- View current roles</span>
<span class="hljs-keyword">SELECT</span> CURRENT_ROLE();
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">GRANTS</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">CURRENT_USER</span>();
</div></code></pre>
<h3 id="postgresql-user-management">PostgreSQL User Management</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Create users (roles)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> app_user <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">PASSWORD</span> <span class="hljs-string">'SecurePassword123!'</span>;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> readonly_user <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">PASSWORD</span> <span class="hljs-string">'ReadOnlyPass456!'</span>;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> admin_user <span class="hljs-keyword">WITH</span> LOGIN <span class="hljs-keyword">PASSWORD</span> <span class="hljs-string">'AdminPass789!'</span>;

<span class="hljs-comment">-- Create user with connection limits</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> limited_user <span class="hljs-keyword">WITH</span>
  <span class="hljs-keyword">PASSWORD</span> <span class="hljs-string">'LimitedPass123!'</span>
  <span class="hljs-keyword">CONNECTION</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">5</span>;

<span class="hljs-comment">-- Create user with expiration</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> temp_user <span class="hljs-keyword">WITH</span>
  <span class="hljs-keyword">PASSWORD</span> <span class="hljs-string">'TempPass123!'</span>
  VALID <span class="hljs-keyword">UNTIL</span> <span class="hljs-string">'2024-12-31'</span>;

<span class="hljs-comment">-- Create role without login (for grouping permissions)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> app_readers;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> app_writers;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> app_admins;

<span class="hljs-comment">-- Grant role membership</span>
<span class="hljs-keyword">GRANT</span> app_readers <span class="hljs-keyword">TO</span> readonly_user;
<span class="hljs-keyword">GRANT</span> app_writers <span class="hljs-keyword">TO</span> app_user;
<span class="hljs-keyword">GRANT</span> app_admins <span class="hljs-keyword">TO</span> admin_user;

<span class="hljs-comment">-- Create role with inheritance</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> manager <span class="hljs-keyword">WITH</span>
  LOGIN
  <span class="hljs-keyword">PASSWORD</span> <span class="hljs-string">'ManagerPass123!'</span>
  INHERIT; <span class="hljs-comment">-- Can use privileges of granted roles automatically</span>

<span class="hljs-comment">-- Create role without inheritance</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> auditor <span class="hljs-keyword">WITH</span>
  LOGIN
  <span class="hljs-keyword">PASSWORD</span> <span class="hljs-string">'AuditorPass123!'</span>
  NOINHERIT; <span class="hljs-comment">-- Must explicitly SET ROLE to use granted privileges</span>

<span class="hljs-comment">-- Modify user attributes</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> app_user <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">PASSWORD</span> <span class="hljs-string">'NewSecurePassword123!'</span>;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> app_user VALID <span class="hljs-keyword">UNTIL</span> <span class="hljs-string">'2025-12-31'</span>;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> app_user <span class="hljs-keyword">CONNECTION</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;

<span class="hljs-comment">-- Disable/enable user</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> suspicious_user <span class="hljs-keyword">WITH</span> NOLOGIN;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> suspicious_user <span class="hljs-keyword">WITH</span> LOGIN;

<span class="hljs-comment">-- View users and roles</span>
\du
<span class="hljs-comment">-- or</span>
<span class="hljs-keyword">SELECT</span> rolname, rolsuper, rolinherit, rolcreaterole, rolcreatedb,
       rolcanlogin, rolconnlimit, rolvaliduntil
<span class="hljs-keyword">FROM</span> pg_roles;

<span class="hljs-comment">-- Drop user/role</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">USER</span> old_user;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">ROLE</span> old_role;

<span class="hljs-comment">-- Set role in session</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">ROLE</span> app_admins;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">ROLE</span> <span class="hljs-keyword">NONE</span>;
<span class="hljs-keyword">RESET</span> <span class="hljs-keyword">ROLE</span>;

<span class="hljs-comment">-- View current user and roles</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">current_user</span>, <span class="hljs-keyword">session_user</span>;
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pg_roles <span class="hljs-keyword">WHERE</span> pg_has_role(<span class="hljs-keyword">current_user</span>, <span class="hljs-keyword">oid</span>, <span class="hljs-string">'member'</span>);
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%90-permissions-and-privileges">ğŸ” Permissions and Privileges</h2>
<h3 id="mysql-privilege-system">MySQL Privilege System</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Database-level privileges</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">PRIVILEGES</span> <span class="hljs-keyword">ON</span> ecommerce.* <span class="hljs-keyword">TO</span> <span class="hljs-string">'admin_user'</span>@<span class="hljs-string">'10.0.0.%'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, <span class="hljs-keyword">INSERT</span>, <span class="hljs-keyword">UPDATE</span>, <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">ON</span> ecommerce.* <span class="hljs-keyword">TO</span> <span class="hljs-string">'app_user'</span>@<span class="hljs-string">'localhost'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> ecommerce.* <span class="hljs-keyword">TO</span> <span class="hljs-string">'readonly_user'</span>@<span class="hljs-string">'%'</span>;

<span class="hljs-comment">-- Table-level privileges</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, <span class="hljs-keyword">INSERT</span>, <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> ecommerce.customers <span class="hljs-keyword">TO</span> <span class="hljs-string">'customer_service'</span>@<span class="hljs-string">'%'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> ecommerce.orders <span class="hljs-keyword">TO</span> <span class="hljs-string">'reporting_user'</span>@<span class="hljs-string">'%'</span>;

<span class="hljs-comment">-- Column-level privileges</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> (customer_id, first_name, last_name, email)
<span class="hljs-keyword">ON</span> ecommerce.customers <span class="hljs-keyword">TO</span> <span class="hljs-string">'limited_user'</span>@<span class="hljs-string">'%'</span>;

<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">UPDATE</span> (<span class="hljs-keyword">status</span>, updated_at)
<span class="hljs-keyword">ON</span> ecommerce.orders <span class="hljs-keyword">TO</span> <span class="hljs-string">'order_processor'</span>@<span class="hljs-string">'%'</span>;

<span class="hljs-comment">-- Stored procedure privileges</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">PROCEDURE</span> ecommerce.process_order <span class="hljs-keyword">TO</span> <span class="hljs-string">'app_user'</span>@<span class="hljs-string">'localhost'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">FUNCTION</span> ecommerce.calculate_tax <span class="hljs-keyword">TO</span> <span class="hljs-string">'app_user'</span>@<span class="hljs-string">'localhost'</span>;

<span class="hljs-comment">-- Administrative privileges</span>
<span class="hljs-keyword">GRANT</span> RELOAD, PROCESS, <span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">DATABASES</span> <span class="hljs-keyword">ON</span> *.* <span class="hljs-keyword">TO</span> <span class="hljs-string">'monitor_user'</span>@<span class="hljs-string">'localhost'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">REPLICATION</span> <span class="hljs-keyword">SLAVE</span> <span class="hljs-keyword">ON</span> *.* <span class="hljs-keyword">TO</span> <span class="hljs-string">'replica_user'</span>@<span class="hljs-string">'replica.example.com'</span>;

<span class="hljs-comment">-- Grant with grant option (allows user to grant privileges to others)</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> ecommerce.products <span class="hljs-keyword">TO</span> <span class="hljs-string">'team_lead'</span>@<span class="hljs-string">'%'</span> <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">OPTION</span>;

<span class="hljs-comment">-- Revoke privileges</span>
<span class="hljs-keyword">REVOKE</span> <span class="hljs-keyword">INSERT</span>, <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> ecommerce.customers <span class="hljs-keyword">FROM</span> <span class="hljs-string">'customer_service'</span>@<span class="hljs-string">'%'</span>;
<span class="hljs-keyword">REVOKE</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">PRIVILEGES</span> <span class="hljs-keyword">ON</span> ecommerce.* <span class="hljs-keyword">FROM</span> <span class="hljs-string">'old_user'</span>@<span class="hljs-string">'%'</span>;

<span class="hljs-comment">-- View privileges</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">GRANTS</span> <span class="hljs-keyword">FOR</span> <span class="hljs-string">'app_user'</span>@<span class="hljs-string">'localhost'</span>;
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">GRANTS</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">CURRENT_USER</span>();

<span class="hljs-comment">-- View all user privileges</span>
<span class="hljs-keyword">SELECT</span>
    GRANTEE,
    TABLE_SCHEMA,
    TABLE_NAME,
    PRIVILEGE_TYPE,
    IS_GRANTABLE
<span class="hljs-keyword">FROM</span> information_schema.TABLE_PRIVILEGES
<span class="hljs-keyword">WHERE</span> GRANTEE = <span class="hljs-string">"'app_user'@'localhost'"</span>;

<span class="hljs-comment">-- Complex privilege example: E-commerce application</span>
<span class="hljs-comment">-- Create specialized roles</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> <span class="hljs-string">'ecommerce_customer_service'</span>;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> <span class="hljs-string">'ecommerce_inventory_manager'</span>;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> <span class="hljs-string">'ecommerce_financial_analyst'</span>;

<span class="hljs-comment">-- Customer service role</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> ecommerce.customers <span class="hljs-keyword">TO</span> <span class="hljs-string">'ecommerce_customer_service'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> ecommerce.orders <span class="hljs-keyword">TO</span> <span class="hljs-string">'ecommerce_customer_service'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> ecommerce.order_items <span class="hljs-keyword">TO</span> <span class="hljs-string">'ecommerce_customer_service'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> ecommerce.customer_support_tickets <span class="hljs-keyword">TO</span> <span class="hljs-string">'ecommerce_customer_service'</span>;

<span class="hljs-comment">-- Inventory manager role</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, <span class="hljs-keyword">INSERT</span>, <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> ecommerce.products <span class="hljs-keyword">TO</span> <span class="hljs-string">'ecommerce_inventory_manager'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, <span class="hljs-keyword">INSERT</span>, <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> ecommerce.inventory <span class="hljs-keyword">TO</span> <span class="hljs-string">'ecommerce_inventory_manager'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> ecommerce.orders <span class="hljs-keyword">TO</span> <span class="hljs-string">'ecommerce_inventory_manager'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> ecommerce.order_items <span class="hljs-keyword">TO</span> <span class="hljs-string">'ecommerce_inventory_manager'</span>;

<span class="hljs-comment">-- Financial analyst role (read-only with specific tables)</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> ecommerce.orders <span class="hljs-keyword">TO</span> <span class="hljs-string">'ecommerce_financial_analyst'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> ecommerce.payments <span class="hljs-keyword">TO</span> <span class="hljs-string">'ecommerce_financial_analyst'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> ecommerce.refunds <span class="hljs-keyword">TO</span> <span class="hljs-string">'ecommerce_financial_analyst'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> (customer_id, total_spent, registration_date)
<span class="hljs-keyword">ON</span> ecommerce.customers <span class="hljs-keyword">TO</span> <span class="hljs-string">'ecommerce_financial_analyst'</span>;

<span class="hljs-comment">-- Assign roles to users</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-string">'ecommerce_customer_service'</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">'cs_agent1'</span>@<span class="hljs-string">'%'</span>, <span class="hljs-string">'cs_agent2'</span>@<span class="hljs-string">'%'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-string">'ecommerce_inventory_manager'</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">'inventory_mgr'</span>@<span class="hljs-string">'%'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-string">'ecommerce_financial_analyst'</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">'finance_team'</span>@<span class="hljs-string">'%'</span>;
</div></code></pre>
<h3 id="postgresql-privilege-system">PostgreSQL Privilege System</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Database-level privileges</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">PRIVILEGES</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DATABASE</span> ecommerce <span class="hljs-keyword">TO</span> admin_user;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DATABASE</span> ecommerce <span class="hljs-keyword">TO</span> app_user;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DATABASE</span> ecommerce <span class="hljs-keyword">TO</span> readonly_user;

<span class="hljs-comment">-- Schema-level privileges</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">SCHEMA</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">TO</span> admin_user;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">USAGE</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">SCHEMA</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">TO</span> app_user;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">USAGE</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">SCHEMA</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">TO</span> readonly_user;

<span class="hljs-comment">-- Table-level privileges</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">PRIVILEGES</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">TABLES</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">SCHEMA</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">TO</span> admin_user;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, <span class="hljs-keyword">INSERT</span>, <span class="hljs-keyword">UPDATE</span>, <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">TABLES</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">SCHEMA</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">TO</span> app_user;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">TABLES</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">SCHEMA</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">TO</span> readonly_user;

<span class="hljs-comment">-- Grant on future tables</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">PRIVILEGES</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">SCHEMA</span> <span class="hljs-keyword">public</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, <span class="hljs-keyword">INSERT</span>, <span class="hljs-keyword">UPDATE</span>, <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLES</span> <span class="hljs-keyword">TO</span> app_user;

<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">PRIVILEGES</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">SCHEMA</span> <span class="hljs-keyword">public</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">TABLES</span> <span class="hljs-keyword">TO</span> readonly_user;

<span class="hljs-comment">-- Sequence privileges (for auto-increment)</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">USAGE</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">ALL</span> SEQUENCES <span class="hljs-keyword">IN</span> <span class="hljs-keyword">SCHEMA</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">TO</span> app_user;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">PRIVILEGES</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">SCHEMA</span> <span class="hljs-keyword">public</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">USAGE</span> <span class="hljs-keyword">ON</span> SEQUENCES <span class="hljs-keyword">TO</span> app_user;

<span class="hljs-comment">-- Function/procedure privileges</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">ALL</span> FUNCTIONS <span class="hljs-keyword">IN</span> <span class="hljs-keyword">SCHEMA</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">TO</span> app_user;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">PRIVILEGES</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">SCHEMA</span> <span class="hljs-keyword">public</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">ON</span> FUNCTIONS <span class="hljs-keyword">TO</span> app_user;

<span class="hljs-comment">-- Column-level privileges</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> (customer_id, first_name, last_name, email)
<span class="hljs-keyword">ON</span> customers <span class="hljs-keyword">TO</span> limited_user;

<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">UPDATE</span> (<span class="hljs-keyword">status</span>, updated_at)
<span class="hljs-keyword">ON</span> orders <span class="hljs-keyword">TO</span> order_processor;

<span class="hljs-comment">-- Row-level security (RLS)</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> customers <span class="hljs-keyword">ENABLE</span> <span class="hljs-keyword">ROW</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">SECURITY</span>;

<span class="hljs-comment">-- Create policies</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> customer_isolation <span class="hljs-keyword">ON</span> customers
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">TO</span> app_user
    <span class="hljs-keyword">USING</span> (customer_id = current_setting(<span class="hljs-string">'app.current_customer_id'</span>)::<span class="hljs-built_in">int</span>);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> admin_all_access <span class="hljs-keyword">ON</span> customers
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">TO</span> admin_user
    <span class="hljs-keyword">USING</span> (<span class="hljs-literal">true</span>);

<span class="hljs-comment">-- Enable RLS for specific users</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> customers <span class="hljs-keyword">FORCE</span> <span class="hljs-keyword">ROW</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">SECURITY</span>;

<span class="hljs-comment">-- Revoke privileges</span>
<span class="hljs-keyword">REVOKE</span> <span class="hljs-keyword">INSERT</span>, <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> customers <span class="hljs-keyword">FROM</span> customer_service;
<span class="hljs-keyword">REVOKE</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">PRIVILEGES</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DATABASE</span> ecommerce <span class="hljs-keyword">FROM</span> old_user;

<span class="hljs-comment">-- View privileges</span>
\dp customers
<span class="hljs-comment">-- or</span>
<span class="hljs-keyword">SELECT</span>
    grantee,
    table_schema,
    table_name,
    privilege_type,
    is_grantable
<span class="hljs-keyword">FROM</span> information_schema.table_privileges
<span class="hljs-keyword">WHERE</span> grantee = <span class="hljs-string">'app_user'</span>;

<span class="hljs-comment">-- View row-level security policies</span>
\d+ customers
<span class="hljs-comment">-- or</span>
<span class="hljs-keyword">SELECT</span> schemaname, tablename, policyname, permissive, <span class="hljs-keyword">roles</span>, cmd, qual
<span class="hljs-keyword">FROM</span> pg_policies
<span class="hljs-keyword">WHERE</span> tablename = <span class="hljs-string">'customers'</span>;

<span class="hljs-comment">-- Complex example: Multi-tenant application</span>
<span class="hljs-comment">-- Create tenant-specific roles</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> tenant_admin;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> tenant_user;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> tenant_readonly;

<span class="hljs-comment">-- Set up row-level security for multi-tenancy</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> orders <span class="hljs-keyword">ENABLE</span> <span class="hljs-keyword">ROW</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">SECURITY</span>;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> customers <span class="hljs-keyword">ENABLE</span> <span class="hljs-keyword">ROW</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">SECURITY</span>;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> products <span class="hljs-keyword">ENABLE</span> <span class="hljs-keyword">ROW</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">SECURITY</span>;

<span class="hljs-comment">-- Tenant isolation policies</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> tenant_orders <span class="hljs-keyword">ON</span> orders
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">TO</span> tenant_user, tenant_readonly
    <span class="hljs-keyword">USING</span> (tenant_id = current_setting(<span class="hljs-string">'app.current_tenant_id'</span>)::<span class="hljs-built_in">int</span>);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> tenant_customers <span class="hljs-keyword">ON</span> customers
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">TO</span> tenant_user, tenant_readonly
    <span class="hljs-keyword">USING</span> (tenant_id = current_setting(<span class="hljs-string">'app.current_tenant_id'</span>)::<span class="hljs-built_in">int</span>);

<span class="hljs-comment">-- Admin can see all</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> admin_all_orders <span class="hljs-keyword">ON</span> orders
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">TO</span> tenant_admin
    <span class="hljs-keyword">USING</span> (<span class="hljs-literal">true</span>);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> admin_all_customers <span class="hljs-keyword">ON</span> customers
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">TO</span> tenant_admin
    <span class="hljs-keyword">USING</span> (<span class="hljs-literal">true</span>);

<span class="hljs-comment">-- Set tenant context in application</span>
<span class="hljs-comment">-- This would be done by the application before each request</span>
<span class="hljs-keyword">SET</span> app.current_tenant_id = <span class="hljs-string">'123'</span>;

<span class="hljs-comment">-- Now queries will only return data for tenant 123</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders; <span class="hljs-comment">-- Only shows orders for tenant 123</span>
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%92-ssltls-encryption">ğŸ”’ SSL/TLS Encryption</h2>
<h3 id="mysql-ssl-configuration">MySQL SSL Configuration</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Check SSL status</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">VARIABLES</span> <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%ssl%'</span>;
STATUS; <span class="hljs-comment">-- Shows SSL status in client</span>

<span class="hljs-comment">-- Check if SSL is enabled</span>
<span class="hljs-keyword">SELECT</span> @@have_ssl;

<span class="hljs-comment">-- View SSL certificates</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">STATUS</span> <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'Ssl%'</span>;

<span class="hljs-comment">-- Create user requiring SSL</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'ssl_user'</span>@<span class="hljs-string">'%'</span>
<span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'SecurePass123!'</span>
REQUIRE SSL;

<span class="hljs-comment">-- Create user requiring specific SSL certificate</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'cert_user'</span>@<span class="hljs-string">'%'</span>
<span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'CertPass123!'</span>
REQUIRE X509;

<span class="hljs-comment">-- Create user requiring specific certificate attributes</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'specific_cert_user'</span>@<span class="hljs-string">'%'</span>
<span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'SpecificCertPass123!'</span>
REQUIRE ISSUER <span class="hljs-string">'/C=US/ST=CA/L=San Francisco/O=MyCompany/CN=MyCA'</span>
<span class="hljs-keyword">AND</span> SUBJECT <span class="hljs-string">'/C=US/ST=CA/L=San Francisco/O=MyCompany/CN=client'</span>;

<span class="hljs-comment">-- Modify existing user to require SSL</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'existing_user'</span>@<span class="hljs-string">'%'</span> REQUIRE SSL;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'existing_user'</span>@<span class="hljs-string">'%'</span> REQUIRE <span class="hljs-keyword">NONE</span>; <span class="hljs-comment">-- Remove SSL requirement</span>

<span class="hljs-comment">-- Check user SSL requirements</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">User</span>, Host, ssl_type, ssl_cipher, x509_issuer, x509_subject
<span class="hljs-keyword">FROM</span> mysql.user
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">User</span> = <span class="hljs-string">'ssl_user'</span>;

<span class="hljs-comment">-- Connect with SSL (command line)</span>
<span class="hljs-comment">-- mysql --ssl-mode=REQUIRED -u ssl_user -p</span>
<span class="hljs-comment">-- mysql --ssl-ca=ca.pem --ssl-cert=client-cert.pem --ssl-key=client-key.pem -u cert_user -p</span>
</div></code></pre>
<h3 id="postgresql-ssl-configuration">PostgreSQL SSL Configuration</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Check SSL status</span>
<span class="hljs-keyword">SHOW</span> ssl;
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pg_stat_ssl <span class="hljs-keyword">WHERE</span> pid = pg_backend_pid();

<span class="hljs-comment">-- View SSL connection info</span>
<span class="hljs-keyword">SELECT</span>
    pid,
    usename,
    application_name,
    client_addr,
    ssl,
    ssl_version,
    ssl_cipher
<span class="hljs-keyword">FROM</span> pg_stat_ssl
<span class="hljs-keyword">JOIN</span> pg_stat_activity <span class="hljs-keyword">USING</span> (pid)
<span class="hljs-keyword">WHERE</span> ssl = <span class="hljs-literal">true</span>;

<span class="hljs-comment">-- Configure SSL in postgresql.conf</span>
<span class="hljs-comment">-- ssl = on</span>
<span class="hljs-comment">-- ssl_cert_file = 'server.crt'</span>
<span class="hljs-comment">-- ssl_key_file = 'server.key'</span>
<span class="hljs-comment">-- ssl_ca_file = 'ca.crt'</span>
<span class="hljs-comment">-- ssl_crl_file = 'root.crl'</span>

<span class="hljs-comment">-- Configure client authentication in pg_hba.conf</span>
<span class="hljs-comment">-- hostssl all all 0.0.0.0/0 md5</span>
<span class="hljs-comment">-- hostssl all ssl_users 0.0.0.0/0 cert</span>

<span class="hljs-comment">-- Create user requiring SSL</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> ssl_user <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">PASSWORD</span> <span class="hljs-string">'SecurePass123!'</span>;
<span class="hljs-comment">-- Then configure in pg_hba.conf:</span>
<span class="hljs-comment">-- hostssl ecommerce ssl_user 0.0.0.0/0 md5</span>

<span class="hljs-comment">-- Create user requiring client certificate</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> cert_user;
<span class="hljs-comment">-- Configure in pg_hba.conf:</span>
<span class="hljs-comment">-- hostssl ecommerce cert_user 0.0.0.0/0 cert</span>

<span class="hljs-comment">-- Connect with SSL (command line)</span>
<span class="hljs-comment">-- psql "sslmode=require host=localhost dbname=ecommerce user=ssl_user"</span>
<span class="hljs-comment">-- psql "sslmode=require sslcert=client.crt sslkey=client.key sslrootcert=ca.crt host=localhost dbname=ecommerce user=cert_user"</span>
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%8A-database-auditing">ğŸ“Š Database Auditing</h2>
<h3 id="mysql-audit-logging">MySQL Audit Logging</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Enable general query log</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> general_log = <span class="hljs-string">'ON'</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> general_log_file = <span class="hljs-string">'/var/log/mysql/general.log'</span>;
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">VARIABLES</span> <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'general_log%'</span>;

<span class="hljs-comment">-- Enable slow query log</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> slow_query_log = <span class="hljs-string">'ON'</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> slow_query_log_file = <span class="hljs-string">'/var/log/mysql/slow.log'</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> long_query_time = <span class="hljs-number">2</span>; <span class="hljs-comment">-- Log queries taking more than 2 seconds</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">VARIABLES</span> <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'slow_query_log%'</span>;

<span class="hljs-comment">-- Enable binary log (for replication and point-in-time recovery)</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">VARIABLES</span> <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'log_bin%'</span>;
<span class="hljs-keyword">SHOW</span> <span class="hljs-built_in">BINARY</span> <span class="hljs-keyword">LOGS</span>;
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">BINLOG</span> <span class="hljs-keyword">EVENTS</span> <span class="hljs-keyword">IN</span> <span class="hljs-string">'mysql-bin.000001'</span>;

<span class="hljs-comment">-- MySQL Enterprise Audit (commercial feature)</span>
<span class="hljs-comment">-- Install audit plugin</span>
<span class="hljs-comment">-- INSTALL PLUGIN audit_log SONAME 'audit_log.so';</span>

<span class="hljs-comment">-- Configure audit logging</span>
<span class="hljs-comment">-- SET GLOBAL audit_log_policy = 'ALL';</span>
<span class="hljs-comment">-- SET GLOBAL audit_log_format = 'JSON';</span>
<span class="hljs-comment">-- SET GLOBAL audit_log_file = '/var/log/mysql/audit.log';</span>

<span class="hljs-comment">-- View audit log status</span>
<span class="hljs-comment">-- SHOW STATUS LIKE 'audit_log%';</span>

<span class="hljs-comment">-- Custom audit table approach</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> audit_log (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">BIGINT</span> AUTO_INCREMENT PRIMARY <span class="hljs-keyword">KEY</span>,
    user_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    host_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    command_type <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    table_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    query_text <span class="hljs-built_in">TEXT</span>,
    <span class="hljs-built_in">timestamp</span> <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    affected_rows <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">INDEX</span> idx_user_time (user_name, <span class="hljs-built_in">timestamp</span>),
    <span class="hljs-keyword">INDEX</span> idx_table_time (table_name, <span class="hljs-built_in">timestamp</span>)
);

<span class="hljs-comment">-- Create audit trigger</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> customers_audit_insert
<span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> customers
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> audit_log (user_name, host_name, command_type, table_name, query_text, affected_rows)
    <span class="hljs-keyword">VALUES</span> (<span class="hljs-keyword">USER</span>(), CONNECTION_ID(), <span class="hljs-string">'INSERT'</span>, <span class="hljs-string">'customers'</span>,
            <span class="hljs-keyword">CONCAT</span>(<span class="hljs-string">'INSERT INTO customers VALUES ('</span>, NEW.customer_id, <span class="hljs-string">', "'</span>, NEW.first_name, <span class="hljs-string">'", ...)'</span>), <span class="hljs-number">1</span>);
<span class="hljs-keyword">END</span> //

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> customers_audit_update
<span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> customers
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> audit_log (user_name, host_name, command_type, table_name, query_text, affected_rows)
    <span class="hljs-keyword">VALUES</span> (<span class="hljs-keyword">USER</span>(), CONNECTION_ID(), <span class="hljs-string">'UPDATE'</span>, <span class="hljs-string">'customers'</span>,
            <span class="hljs-keyword">CONCAT</span>(<span class="hljs-string">'UPDATE customers SET ... WHERE customer_id = '</span>, NEW.customer_id), <span class="hljs-number">1</span>);
<span class="hljs-keyword">END</span> //

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> customers_audit_delete
<span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">ON</span> customers
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> audit_log (user_name, host_name, command_type, table_name, query_text, affected_rows)
    <span class="hljs-keyword">VALUES</span> (<span class="hljs-keyword">USER</span>(), CONNECTION_ID(), <span class="hljs-string">'DELETE'</span>, <span class="hljs-string">'customers'</span>,
            <span class="hljs-keyword">CONCAT</span>(<span class="hljs-string">'DELETE FROM customers WHERE customer_id = '</span>, OLD.customer_id), <span class="hljs-number">1</span>);
<span class="hljs-keyword">END</span> //
DELIMITER ;

<span class="hljs-comment">-- Query audit log</span>
<span class="hljs-keyword">SELECT</span>
    user_name,
    command_type,
    table_name,
    <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">as</span> operation_count,
    <span class="hljs-keyword">MIN</span>(<span class="hljs-built_in">timestamp</span>) <span class="hljs-keyword">as</span> first_operation,
    <span class="hljs-keyword">MAX</span>(<span class="hljs-built_in">timestamp</span>) <span class="hljs-keyword">as</span> last_operation
<span class="hljs-keyword">FROM</span> audit_log
<span class="hljs-keyword">WHERE</span> <span class="hljs-built_in">timestamp</span> &gt;= <span class="hljs-keyword">DATE_SUB</span>(<span class="hljs-keyword">NOW</span>(), <span class="hljs-built_in">INTERVAL</span> <span class="hljs-number">24</span> <span class="hljs-keyword">HOUR</span>)
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> user_name, command_type, table_name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> operation_count <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<h3 id="postgresql-audit-logging">PostgreSQL Audit Logging</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Enable logging in postgresql.conf</span>
<span class="hljs-comment">-- log_statement = 'all'  # Log all statements</span>
<span class="hljs-comment">-- log_min_duration_statement = 1000  # Log slow queries (1 second)</span>
<span class="hljs-comment">-- log_connections = on</span>
<span class="hljs-comment">-- log_disconnections = on</span>
<span class="hljs-comment">-- log_duration = on</span>
<span class="hljs-comment">-- log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '</span>

<span class="hljs-comment">-- Check current logging settings</span>
<span class="hljs-keyword">SHOW</span> log_statement;
<span class="hljs-keyword">SHOW</span> log_min_duration_statement;
<span class="hljs-keyword">SHOW</span> log_connections;

<span class="hljs-comment">-- pgAudit extension (third-party)</span>
<span class="hljs-comment">-- CREATE EXTENSION pgaudit;</span>

<span class="hljs-comment">-- Configure pgAudit</span>
<span class="hljs-comment">-- SET pgaudit.log = 'all';</span>
<span class="hljs-comment">-- SET pgaudit.log_catalog = off;</span>
<span class="hljs-comment">-- SET pgaudit.log_parameter = on;</span>
<span class="hljs-comment">-- SET pgaudit.log_relation = on;</span>
<span class="hljs-comment">-- SET pgaudit.log_statement_once = on;</span>

<span class="hljs-comment">-- Custom audit table approach</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> audit_log (
    <span class="hljs-keyword">id</span> BIGSERIAL PRIMARY <span class="hljs-keyword">KEY</span>,
    schema_name <span class="hljs-built_in">TEXT</span>,
    table_name <span class="hljs-built_in">TEXT</span>,
    user_name <span class="hljs-built_in">TEXT</span>,
    <span class="hljs-keyword">action</span> <span class="hljs-built_in">TEXT</span>,
    original_data JSONB,
    new_data JSONB,
    <span class="hljs-keyword">query</span> <span class="hljs-built_in">TEXT</span>,
    <span class="hljs-built_in">timestamp</span> <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">WITH</span> <span class="hljs-built_in">TIME</span> ZONE <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_audit_log_table_time <span class="hljs-keyword">ON</span> audit_log (table_name, <span class="hljs-built_in">timestamp</span>);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_audit_log_user_time <span class="hljs-keyword">ON</span> audit_log (user_name, <span class="hljs-built_in">timestamp</span>);

<span class="hljs-comment">-- Create audit function</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> audit_trigger_function()
<span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">IF</span> TG_OP = <span class="hljs-string">'INSERT'</span> <span class="hljs-keyword">THEN</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> audit_log (schema_name, table_name, user_name, <span class="hljs-keyword">action</span>, new_data, <span class="hljs-keyword">query</span>)
        <span class="hljs-keyword">VALUES</span> (TG_TABLE_SCHEMA, TG_TABLE_NAME, <span class="hljs-keyword">current_user</span>, TG_OP, row_to_json(<span class="hljs-keyword">NEW</span>), current_query());
        RETURN NEW;
    ELSIF TG_OP = '<span class="hljs-keyword">UPDATE</span><span class="hljs-string">' THEN
        INSERT INTO audit_log (schema_name, table_name, user_name, action, original_data, new_data, query)
        VALUES (TG_TABLE_SCHEMA, TG_TABLE_NAME, current_user, TG_OP, row_to_json(OLD), row_to_json(NEW), current_query());
        RETURN NEW;
    ELSIF TG_OP = '</span><span class="hljs-keyword">DELETE</span><span class="hljs-string">' THEN
        INSERT INTO audit_log (schema_name, table_name, user_name, action, original_data, query)
        VALUES (TG_TABLE_SCHEMA, TG_TABLE_NAME, current_user, TG_OP, row_to_json(OLD), current_query());
        RETURN OLD;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Apply audit trigger to tables
CREATE TRIGGER customers_audit_trigger
    AFTER INSERT OR UPDATE OR DELETE ON customers
    FOR EACH ROW EXECUTE FUNCTION audit_trigger_function();

CREATE TRIGGER orders_audit_trigger
    AFTER INSERT OR UPDATE OR DELETE ON orders
    FOR EACH ROW EXECUTE FUNCTION audit_trigger_function();

-- Query audit log
SELECT
    user_name,
    table_name,
    action,
    COUNT(*) as operation_count,
    MIN(timestamp) as first_operation,
    MAX(timestamp) as last_operation
FROM audit_log
WHERE timestamp &gt;= CURRENT_TIMESTAMP - INTERVAL '</span><span class="hljs-number">24</span> <span class="hljs-keyword">hours</span><span class="hljs-string">'
GROUP BY user_name, table_name, action
ORDER BY operation_count DESC;

-- View specific changes
SELECT
    timestamp,
    user_name,
    action,
    original_data,
    new_data
FROM audit_log
WHERE table_name = '</span>customers<span class="hljs-string">'
  AND timestamp &gt;= CURRENT_TIMESTAMP - INTERVAL '</span><span class="hljs-number">1</span> <span class="hljs-keyword">hour</span><span class="hljs-string">'
ORDER BY timestamp DESC;
</span></div></code></pre>
<hr>
<h2 id="%F0%9F%9B%A1%EF%B8%8F-security-best-practices">ğŸ›¡ï¸ Security Best Practices</h2>
<h3 id="1-password-security">1. <strong>Password Security</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL: Password validation</span>
<span class="hljs-comment">-- Install password validation plugin</span>
<span class="hljs-keyword">INSTALL</span> <span class="hljs-keyword">PLUGIN</span> validate_password <span class="hljs-keyword">SONAME</span> <span class="hljs-string">'validate_password.so'</span>;

<span class="hljs-comment">-- Configure password policy</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> validate_password.policy = <span class="hljs-string">'STRONG'</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> validate_password.length = <span class="hljs-number">12</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> validate_password.mixed_case_count = <span class="hljs-number">1</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> validate_password.number_count = <span class="hljs-number">1</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> validate_password.special_char_count = <span class="hljs-number">1</span>;

<span class="hljs-comment">-- Check password strength</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">VALIDATE_PASSWORD_STRENGTH</span>(<span class="hljs-string">'WeakPass'</span>);
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">VALIDATE_PASSWORD_STRENGTH</span>(<span class="hljs-string">'StrongP@ssw0rd123!'</span>);

<span class="hljs-comment">-- PostgreSQL: Password encryption</span>
<span class="hljs-comment">-- Set password encryption method</span>
<span class="hljs-keyword">SET</span> password_encryption = <span class="hljs-string">'scram-sha-256'</span>;

<span class="hljs-comment">-- Create user with strong password</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> secure_user <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">PASSWORD</span> <span class="hljs-string">'StrongP@ssw0rd123!'</span>;

<span class="hljs-comment">-- Check password encryption method</span>
<span class="hljs-keyword">SELECT</span> rolname, rolpassword <span class="hljs-keyword">FROM</span> pg_authid <span class="hljs-keyword">WHERE</span> rolname = <span class="hljs-string">'secure_user'</span>;
</div></code></pre>
<h3 id="2-network-security">2. <strong>Network Security</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL: Bind to specific interfaces</span>
<span class="hljs-comment">-- In my.cnf:</span>
<span class="hljs-comment">-- bind-address = 127.0.0.1  # Local only</span>
<span class="hljs-comment">-- bind-address = 10.0.0.5   # Specific IP</span>

<span class="hljs-comment">-- Skip name resolution for better security</span>
<span class="hljs-comment">-- skip-name-resolve = 1</span>

<span class="hljs-comment">-- PostgreSQL: Configure allowed connections</span>
<span class="hljs-comment">-- In postgresql.conf:</span>
<span class="hljs-comment">-- listen_addresses = 'localhost'  # Local only</span>
<span class="hljs-comment">-- listen_addresses = '10.0.0.5'   # Specific IP</span>
<span class="hljs-comment">-- port = 5432</span>

<span class="hljs-comment">-- In pg_hba.conf:</span>
<span class="hljs-comment">-- # TYPE  DATABASE        USER            ADDRESS                 METHOD</span>
<span class="hljs-comment">-- local   all             all                                     peer</span>
<span class="hljs-comment">-- host    all             all             127.0.0.1/32            md5</span>
<span class="hljs-comment">-- host    all             all             10.0.0.0/24             md5</span>
<span class="hljs-comment">-- hostssl all             all             0.0.0.0/0               md5</span>

<span class="hljs-comment">-- Disable remote root/superuser access</span>
<span class="hljs-comment">-- host    all             postgres        0.0.0.0/0               reject</span>
</div></code></pre>
<h3 id="3-principle-of-least-privilege">3. <strong>Principle of Least Privilege</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Create application-specific database</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> ecommerce_app;

<span class="hljs-comment">-- Create dedicated user for application</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'ecommerce_app'</span>@<span class="hljs-string">'app-server.example.com'</span>
<span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'SecureAppPassword123!'</span>;

<span class="hljs-comment">-- Grant only necessary privileges</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, <span class="hljs-keyword">INSERT</span>, <span class="hljs-keyword">UPDATE</span>, <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">ON</span> ecommerce_app.* <span class="hljs-keyword">TO</span> <span class="hljs-string">'ecommerce_app'</span>@<span class="hljs-string">'app-server.example.com'</span>;

<span class="hljs-comment">-- Don't grant:</span>
<span class="hljs-comment">-- - CREATE, DROP (structure changes)</span>
<span class="hljs-comment">-- - GRANT OPTION (privilege escalation)</span>
<span class="hljs-comment">-- - SUPER, RELOAD (administrative functions)</span>
<span class="hljs-comment">-- - FILE (file system access)</span>

<span class="hljs-comment">-- Create read-only user for reporting</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'reporting_user'</span>@<span class="hljs-string">'report-server.example.com'</span>
<span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'ReportingPassword123!'</span>;

<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> ecommerce_app.orders <span class="hljs-keyword">TO</span> <span class="hljs-string">'reporting_user'</span>@<span class="hljs-string">'report-server.example.com'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> ecommerce_app.customers <span class="hljs-keyword">TO</span> <span class="hljs-string">'reporting_user'</span>@<span class="hljs-string">'report-server.example.com'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> ecommerce_app.products <span class="hljs-keyword">TO</span> <span class="hljs-string">'reporting_user'</span>@<span class="hljs-string">'report-server.example.com'</span>;

<span class="hljs-comment">-- Create backup user with minimal privileges</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'backup_user'</span>@<span class="hljs-string">'backup-server.example.com'</span>
<span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'BackupPassword123!'</span>;

<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, <span class="hljs-keyword">LOCK</span> <span class="hljs-keyword">TABLES</span> <span class="hljs-keyword">ON</span> ecommerce_app.* <span class="hljs-keyword">TO</span> <span class="hljs-string">'backup_user'</span>@<span class="hljs-string">'backup-server.example.com'</span>;
<span class="hljs-keyword">GRANT</span> RELOAD <span class="hljs-keyword">ON</span> *.* <span class="hljs-keyword">TO</span> <span class="hljs-string">'backup_user'</span>@<span class="hljs-string">'backup-server.example.com'</span>;
</div></code></pre>
<h3 id="4-sql-injection-prevention">4. <strong>SQL Injection Prevention</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Use parameterized queries (application level)</span>
<span class="hljs-comment">-- BAD (vulnerable to SQL injection):</span>
<span class="hljs-comment">-- query = "SELECT * FROM users WHERE username = '" + username + "' AND password = '" + password + "'"</span>

<span class="hljs-comment">-- GOOD (parameterized query):</span>
<span class="hljs-comment">-- query = "SELECT * FROM users WHERE username = ? AND password = ?"</span>
<span class="hljs-comment">-- execute(query, [username, password])</span>

<span class="hljs-comment">-- Database-level protections</span>
<span class="hljs-comment">-- Disable dangerous functions if not needed</span>
<span class="hljs-comment">-- SET GLOBAL local_infile = 0;  -- MySQL</span>

<span class="hljs-comment">-- Use stored procedures for complex operations</span>
DELIMITER //
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> authenticate_user(
    <span class="hljs-keyword">IN</span> p_username <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    <span class="hljs-keyword">IN</span> p_password <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    <span class="hljs-keyword">OUT</span> p_user_id <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">OUT</span> p_is_valid <span class="hljs-built_in">BOOLEAN</span>
)
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> v_stored_password <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>);
    <span class="hljs-keyword">DECLARE</span> v_user_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>;

    <span class="hljs-comment">-- Get stored password hash</span>
    <span class="hljs-keyword">SELECT</span> user_id, password_hash <span class="hljs-keyword">INTO</span> v_user_id, v_stored_password
    <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span>
    <span class="hljs-keyword">WHERE</span> username = p_username <span class="hljs-keyword">AND</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>;

    <span class="hljs-comment">-- Verify password (use proper hashing function)</span>
    IF v_user_id IS NOT NULL AND v_stored_password = SHA2(CONCAT(p_password, 'salt'), 256) THEN
        <span class="hljs-keyword">SET</span> p_user_id = v_user_id;
        <span class="hljs-keyword">SET</span> p_is_valid = <span class="hljs-literal">TRUE</span>;

        <span class="hljs-comment">-- Log successful login</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> login_log (user_id, login_time, ip_address, <span class="hljs-keyword">status</span>)
        <span class="hljs-keyword">VALUES</span> (v_user_id, <span class="hljs-keyword">NOW</span>(), CONNECTION_ID(), <span class="hljs-string">'success'</span>);
    ELSE
        <span class="hljs-keyword">SET</span> p_user_id = <span class="hljs-literal">NULL</span>;
        <span class="hljs-keyword">SET</span> p_is_valid = <span class="hljs-literal">FALSE</span>;

        <span class="hljs-comment">-- Log failed login attempt</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> login_log (username, login_time, ip_address, <span class="hljs-keyword">status</span>)
        <span class="hljs-keyword">VALUES</span> (p_username, <span class="hljs-keyword">NOW</span>(), CONNECTION_ID(), <span class="hljs-string">'failed'</span>);
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
<span class="hljs-keyword">END</span> //
DELIMITER ;

<span class="hljs-comment">-- Grant execute permission only</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">PROCEDURE</span> authenticate_user <span class="hljs-keyword">TO</span> <span class="hljs-string">'app_user'</span>@<span class="hljs-string">'%'</span>;
</div></code></pre>
<h3 id="5-data-encryption-at-rest">5. <strong>Data Encryption at Rest</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL: Transparent Data Encryption (TDE)</span>
<span class="hljs-comment">-- Enable encryption for new tables</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> sensitive_data (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span> AUTO_INCREMENT PRIMARY <span class="hljs-keyword">KEY</span>,
    ssn <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">11</span>),
    credit_card <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">16</span>),
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
) ENCRYPTION=<span class="hljs-string">'Y'</span>;

<span class="hljs-comment">-- Encrypt existing table</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> customers ENCRYPTION=<span class="hljs-string">'Y'</span>;

<span class="hljs-comment">-- Check encryption status</span>
<span class="hljs-keyword">SELECT</span>
    TABLE_SCHEMA,
    TABLE_NAME,
    CREATE_OPTIONS
<span class="hljs-keyword">FROM</span> information_schema.TABLES
<span class="hljs-keyword">WHERE</span> CREATE_OPTIONS <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%ENCRYPTION%'</span>;

<span class="hljs-comment">-- PostgreSQL: Column-level encryption</span>
<span class="hljs-comment">-- Install pgcrypto extension</span>
<span class="hljs-keyword">CREATE</span> EXTENSION <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> pgcrypto;

<span class="hljs-comment">-- Encrypt sensitive data</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> sensitive_data (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    ssn_encrypted BYTEA,
    credit_card_encrypted BYTEA,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- Insert encrypted data</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> sensitive_data (ssn_encrypted, credit_card_encrypted)
<span class="hljs-keyword">VALUES</span> (
    pgp_sym_encrypt(<span class="hljs-string">'123-45-6789'</span>, <span class="hljs-string">'encryption_key'</span>),
    pgp_sym_encrypt(<span class="hljs-string">'1234-5678-9012-3456'</span>, <span class="hljs-string">'encryption_key'</span>)
);

<span class="hljs-comment">-- Decrypt data</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">id</span>,
    pgp_sym_decrypt(ssn_encrypted, <span class="hljs-string">'encryption_key'</span>) <span class="hljs-keyword">AS</span> ssn,
    pgp_sym_decrypt(credit_card_encrypted, <span class="hljs-string">'encryption_key'</span>) <span class="hljs-keyword">AS</span> credit_card
<span class="hljs-keyword">FROM</span> sensitive_data;

<span class="hljs-comment">-- Create function for secure access</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> get_customer_sensitive_data(
    p_customer_id <span class="hljs-built_in">INT</span>,
    p_encryption_key <span class="hljs-built_in">TEXT</span>
) <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TABLE</span>(
    customer_id <span class="hljs-built_in">INT</span>,
    ssn <span class="hljs-built_in">TEXT</span>,
    credit_card <span class="hljs-built_in">TEXT</span>
) <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- Check if user has permission</span>
    <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> pg_has_role(<span class="hljs-keyword">current_user</span>, <span class="hljs-string">'sensitive_data_access'</span>, <span class="hljs-string">'member'</span>) <span class="hljs-keyword">THEN</span>
        <span class="hljs-keyword">RAISE</span> <span class="hljs-keyword">EXCEPTION</span> <span class="hljs-string">'Access denied: insufficient privileges'</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    RETURN QUERY
    <span class="hljs-keyword">SELECT</span>
        sd.id,
        pgp_sym_decrypt(sd.ssn_encrypted, p_encryption_key),
        pgp_sym_decrypt(sd.credit_card_encrypted, p_encryption_key)
    <span class="hljs-keyword">FROM</span> sensitive_data sd
    <span class="hljs-keyword">WHERE</span> sd.id = p_customer_id;
<span class="hljs-keyword">END</span>;
$$ LANGUAGE plpgsql SECURITY DEFINER;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AD-data-masking-and-anonymization">ğŸ­ Data Masking and Anonymization</h2>
<h3 id="dynamic-data-masking">Dynamic Data Masking</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL: Create masked views for sensitive data</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> customers_masked <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    customer_id,
    first_name,
    last_name,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">CURRENT_USER</span>() <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%admin%'</span> <span class="hljs-keyword">THEN</span> email
        <span class="hljs-keyword">ELSE</span> <span class="hljs-keyword">CONCAT</span>(<span class="hljs-keyword">LEFT</span>(email, <span class="hljs-number">2</span>), <span class="hljs-string">'***@'</span>, SUBSTRING_INDEX(email, <span class="hljs-string">'@'</span>, <span class="hljs-number">-1</span>))
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> email,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">CURRENT_USER</span>() <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%admin%'</span> <span class="hljs-keyword">THEN</span> phone
        <span class="hljs-keyword">ELSE</span> <span class="hljs-keyword">CONCAT</span>(<span class="hljs-string">'***-***-'</span>, <span class="hljs-keyword">RIGHT</span>(phone, <span class="hljs-number">4</span>))
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> phone,
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">CURRENT_USER</span>() <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%admin%'</span> <span class="hljs-keyword">THEN</span> address
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Address Hidden'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> address,
    registration_date
<span class="hljs-keyword">FROM</span> customers;

<span class="hljs-comment">-- Grant access to masked view instead of table</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> customers_masked <span class="hljs-keyword">TO</span> <span class="hljs-string">'customer_service'</span>@<span class="hljs-string">'%'</span>;
<span class="hljs-keyword">REVOKE</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> customers <span class="hljs-keyword">FROM</span> <span class="hljs-string">'customer_service'</span>@<span class="hljs-string">'%'</span>;

<span class="hljs-comment">-- PostgreSQL: Row-level security with masking</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> mask_sensitive_data()
<span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- Check if user should see masked data</span>
    <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> pg_has_role(<span class="hljs-keyword">current_user</span>, <span class="hljs-string">'full_data_access'</span>, <span class="hljs-string">'member'</span>) <span class="hljs-keyword">THEN</span>
        NEW.email := regexp_replace(NEW.email, <span class="hljs-string">'^(.{2}).*(@.*)$'</span>, <span class="hljs-string">'\1***\2'</span>);
        NEW.phone := regexp_replace(NEW.phone, '^(.{3}).*(.{4})$', '\1-***-\2');
        NEW.ssn := '***-**-' || right(NEW.ssn, 4);
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    RETURN NEW;
<span class="hljs-keyword">END</span>;
$$ LANGUAGE plpgsql;

<span class="hljs-comment">-- Apply masking trigger</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> mask_customer_data
    <span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> customers
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
    <span class="hljs-keyword">WHEN</span> (<span class="hljs-keyword">NOT</span> pg_has_role(<span class="hljs-keyword">current_user</span>, <span class="hljs-string">'full_data_access'</span>, <span class="hljs-string">'member'</span>))
    <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">FUNCTION</span> mask_sensitive_data();
</div></code></pre>
<h3 id="data-anonymization-for-testing">Data Anonymization for Testing</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Create anonymized copy of production data</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customers_test <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    customer_id,
    <span class="hljs-keyword">CONCAT</span>(<span class="hljs-string">'TestUser'</span>, customer_id) <span class="hljs-keyword">AS</span> first_name,
    <span class="hljs-keyword">CONCAT</span>(<span class="hljs-string">'TestLast'</span>, customer_id) <span class="hljs-keyword">AS</span> last_name,
    <span class="hljs-keyword">CONCAT</span>(<span class="hljs-string">'test'</span>, customer_id, <span class="hljs-string">'@example.com'</span>) <span class="hljs-keyword">AS</span> email,
    <span class="hljs-keyword">CONCAT</span>(<span class="hljs-string">'555-'</span>, <span class="hljs-keyword">LPAD</span>(<span class="hljs-keyword">FLOOR</span>(<span class="hljs-keyword">RAND</span>() * <span class="hljs-number">10000</span>), <span class="hljs-number">4</span>, <span class="hljs-string">'0'</span>), <span class="hljs-string">'-'</span>, <span class="hljs-keyword">LPAD</span>(<span class="hljs-keyword">FLOOR</span>(<span class="hljs-keyword">RAND</span>() * <span class="hljs-number">10000</span>), <span class="hljs-number">4</span>, <span class="hljs-string">'0'</span>)) <span class="hljs-keyword">AS</span> phone,
    <span class="hljs-keyword">CONCAT</span>(<span class="hljs-keyword">FLOOR</span>(<span class="hljs-keyword">RAND</span>() * <span class="hljs-number">9999</span>) + <span class="hljs-number">1</span>, <span class="hljs-string">' Test St, Test City, TS '</span>, <span class="hljs-keyword">LPAD</span>(<span class="hljs-keyword">FLOOR</span>(<span class="hljs-keyword">RAND</span>() * <span class="hljs-number">100000</span>), <span class="hljs-number">5</span>, <span class="hljs-string">'0'</span>)) <span class="hljs-keyword">AS</span> address,
    registration_date,
    <span class="hljs-keyword">status</span>
<span class="hljs-keyword">FROM</span> customers;

<span class="hljs-comment">-- PostgreSQL: More sophisticated anonymization</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customers_anonymized <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    customer_id,
    <span class="hljs-string">'Anonymous'</span> || customer_id <span class="hljs-keyword">AS</span> first_name,
    <span class="hljs-string">'User'</span> || customer_id <span class="hljs-keyword">AS</span> last_name,
    <span class="hljs-string">'user'</span> || customer_id || <span class="hljs-string">'@testdomain.com'</span> <span class="hljs-keyword">AS</span> email,
    <span class="hljs-string">'555-'</span> || <span class="hljs-keyword">lpad</span>((random() * <span class="hljs-number">10000</span>)::<span class="hljs-built_in">int</span>::<span class="hljs-built_in">text</span>, <span class="hljs-number">4</span>, <span class="hljs-string">'0'</span>) || <span class="hljs-string">'-'</span> || <span class="hljs-keyword">lpad</span>((random() * <span class="hljs-number">10000</span>)::<span class="hljs-built_in">int</span>::<span class="hljs-built_in">text</span>, <span class="hljs-number">4</span>, <span class="hljs-string">'0'</span>) <span class="hljs-keyword">AS</span> phone,
    (random() * <span class="hljs-number">9999</span> + <span class="hljs-number">1</span>)::<span class="hljs-built_in">int</span> || <span class="hljs-string">' Anonymous St, Test City, TS '</span> || <span class="hljs-keyword">lpad</span>((random() * <span class="hljs-number">100000</span>)::<span class="hljs-built_in">int</span>::<span class="hljs-built_in">text</span>, <span class="hljs-number">5</span>, <span class="hljs-string">'0'</span>) <span class="hljs-keyword">AS</span> address,
    registration_date + (random() * <span class="hljs-built_in">interval</span> <span class="hljs-string">'365 days'</span>) <span class="hljs-keyword">AS</span> registration_date, <span class="hljs-comment">-- Shift dates</span>
    <span class="hljs-keyword">status</span>
<span class="hljs-keyword">FROM</span> customers;

<span class="hljs-comment">-- Anonymize order amounts while preserving patterns</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders_anonymized <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    order_id,
    customer_id,
    <span class="hljs-comment">-- Multiply by random factor to preserve relative amounts</span>
    (total_amount * (<span class="hljs-number">0.5</span> + random()))::<span class="hljs-built_in">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> total_amount,
    order_date + (random() * <span class="hljs-built_in">interval</span> <span class="hljs-string">'365 days'</span>) <span class="hljs-keyword">AS</span> order_date,
    <span class="hljs-keyword">status</span>
<span class="hljs-keyword">FROM</span> orders;
</div></code></pre>
<hr>
<h2 id="%F0%9F%92%A1-real-world-security-examples">ğŸ’¡ Real-World Security Examples</h2>
<h3 id="example-1-healthcare-database-security">Example 1: Healthcare Database Security</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- HIPAA-compliant patient data system</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> patients (
    patient_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    medical_record_number <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    first_name_encrypted BYTEA,
    last_name_encrypted BYTEA,
    ssn_encrypted BYTEA,
    date_of_birth_encrypted BYTEA,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    created_by <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    last_accessed <span class="hljs-built_in">TIMESTAMP</span>,
    last_accessed_by <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>)
);

<span class="hljs-comment">-- Enable row-level security</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> patients <span class="hljs-keyword">ENABLE</span> <span class="hljs-keyword">ROW</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">SECURITY</span>;

<span class="hljs-comment">-- Create roles</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> healthcare_provider;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> nurse;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> admin_staff;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> billing_staff;

<span class="hljs-comment">-- Doctors can see all patient data</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> doctor_full_access <span class="hljs-keyword">ON</span> patients
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">TO</span> healthcare_provider
    <span class="hljs-keyword">USING</span> (<span class="hljs-literal">true</span>);

<span class="hljs-comment">-- Nurses can only see patients they're assigned to</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> nurse_assigned_patients <span class="hljs-keyword">ON</span> patients
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">TO</span> nurse
    <span class="hljs-keyword">USING</span> (
        patient_id <span class="hljs-keyword">IN</span> (
            <span class="hljs-keyword">SELECT</span> patient_id <span class="hljs-keyword">FROM</span> patient_assignments
            <span class="hljs-keyword">WHERE</span> nurse_id = current_setting(<span class="hljs-string">'app.current_user_id'</span>)::<span class="hljs-built_in">int</span>
        )
    );

<span class="hljs-comment">-- Billing staff can only see billing-relevant data</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> billing_limited_access <span class="hljs-keyword">ON</span> patients
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">TO</span> billing_staff
    <span class="hljs-keyword">USING</span> (<span class="hljs-literal">true</span>); <span class="hljs-comment">-- But they'll use a view with limited columns</span>

<span class="hljs-comment">-- Create secure view for billing</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> patients_billing <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    patient_id,
    medical_record_number,
    <span class="hljs-string">'PROTECTED'</span> <span class="hljs-keyword">AS</span> first_name,
    <span class="hljs-string">'PROTECTED'</span> <span class="hljs-keyword">AS</span> last_name,
    created_at
<span class="hljs-keyword">FROM</span> patients;

<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> patients_billing <span class="hljs-keyword">TO</span> billing_staff;

<span class="hljs-comment">-- Audit access to patient data</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> audit_patient_access()
<span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> patient_access_log (
        patient_id,
        accessed_by,
        access_type,
        access_time,
        ip_address
    ) <span class="hljs-keyword">VALUES</span> (
        <span class="hljs-keyword">COALESCE</span>(NEW.patient_id, OLD.patient_id),
        <span class="hljs-keyword">current_user</span>,
        TG_OP,
        <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
        inet_client_addr()
    );

    <span class="hljs-comment">-- Update last accessed info</span>
    IF TG_OP = '<span class="hljs-keyword">SELECT</span><span class="hljs-string">' OR TG_OP = '</span><span class="hljs-keyword">UPDATE</span><span class="hljs-string">' THEN
        UPDATE patients
        SET last_accessed = CURRENT_TIMESTAMP,
            last_accessed_by = current_user
        WHERE patient_id = NEW.patient_id;
    END IF;

    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER patient_access_audit
    AFTER SELECT OR INSERT OR UPDATE OR DELETE ON patients
    FOR EACH ROW EXECUTE FUNCTION audit_patient_access();
</span></div></code></pre>
<h3 id="example-2-financial-services-security">Example 2: Financial Services Security</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Bank account system with strict security</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> accounts (
    account_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    account_number <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    customer_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    account_type <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    balance_encrypted BYTEA <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">status</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'active'</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    last_transaction_at <span class="hljs-built_in">TIMESTAMP</span>
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> transactions (
    transaction_id <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    from_account_id <span class="hljs-built_in">INT</span>,
    to_account_id <span class="hljs-built_in">INT</span>,
    amount_encrypted BYTEA <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    transaction_type <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    description_encrypted BYTEA,
    reference_number <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">status</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'pending'</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    processed_at <span class="hljs-built_in">TIMESTAMP</span>,
    processed_by <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>)
);

<span class="hljs-comment">-- Create security roles</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> bank_teller;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> account_manager;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> compliance_officer;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span> system_admin;

<span class="hljs-comment">-- Tellers can only see basic account info</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> teller_account_access <span class="hljs-keyword">ON</span> accounts
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">TO</span> bank_teller
    <span class="hljs-keyword">USING</span> (
        customer_id <span class="hljs-keyword">IN</span> (
            <span class="hljs-keyword">SELECT</span> customer_id <span class="hljs-keyword">FROM</span> teller_assignments
            <span class="hljs-keyword">WHERE</span> teller_id = current_setting(<span class="hljs-string">'app.current_user_id'</span>)::<span class="hljs-built_in">int</span>
        )
    );

<span class="hljs-comment">-- Account managers can see their assigned customers</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> manager_account_access <span class="hljs-keyword">ON</span> accounts
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">TO</span> account_manager
    <span class="hljs-keyword">USING</span> (
        customer_id <span class="hljs-keyword">IN</span> (
            <span class="hljs-keyword">SELECT</span> customer_id <span class="hljs-keyword">FROM</span> customer_assignments
            <span class="hljs-keyword">WHERE</span> manager_id = current_setting(<span class="hljs-string">'app.current_user_id'</span>)::<span class="hljs-built_in">int</span>
        )
    );

<span class="hljs-comment">-- Compliance officers can see all data but read-only</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> compliance_read_access <span class="hljs-keyword">ON</span> accounts
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">TO</span> compliance_officer
    <span class="hljs-keyword">USING</span> (<span class="hljs-literal">true</span>);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> compliance_read_transactions <span class="hljs-keyword">ON</span> transactions
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">TO</span> compliance_officer
    <span class="hljs-keyword">USING</span> (<span class="hljs-literal">true</span>);

<span class="hljs-comment">-- Secure transaction function</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> secure_transfer(
    p_from_account <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    p_to_account <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    p_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">15</span>,<span class="hljs-number">2</span>),
    p_description <span class="hljs-built_in">TEXT</span>,
    p_encryption_key <span class="hljs-built_in">TEXT</span>
) <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TABLE</span>(
    <span class="hljs-keyword">success</span> <span class="hljs-built_in">BOOLEAN</span>,
    transaction_id <span class="hljs-built_in">INT</span>,
    message <span class="hljs-built_in">TEXT</span>
) <span class="hljs-keyword">SECURITY</span> DEFINER <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    v_from_balance <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">15</span>,<span class="hljs-number">2</span>);
    v_transaction_id INT;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- Verify user has transfer privileges</span>
    <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> pg_has_role(<span class="hljs-keyword">current_user</span>, <span class="hljs-string">'transfer_authorized'</span>, <span class="hljs-string">'member'</span>) <span class="hljs-keyword">THEN</span>
        <span class="hljs-keyword">RETURN</span> <span class="hljs-keyword">QUERY</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">FALSE</span>, <span class="hljs-literal">NULL</span>::<span class="hljs-built_in">INT</span>, <span class="hljs-string">'Unauthorized: Transfer privilege required'</span>;
        RETURN;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-comment">-- Additional security checks</span>
    IF p_amount &gt; 10000 AND NOT pg_has_role(current_user, 'high_value_transfer', 'member') THEN
        RETURN QUERY <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">FALSE</span>, <span class="hljs-literal">NULL</span>::<span class="hljs-built_in">INT</span>, <span class="hljs-string">'Unauthorized: High value transfer requires special authorization'</span>;
        RETURN;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-comment">-- Proceed with secure transfer logic</span>
    <span class="hljs-comment">-- (Implementation similar to previous examples but with encryption)</span>

    RETURN QUERY <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">TRUE</span>, v_transaction_id, <span class="hljs-string">'Transfer completed successfully'</span>;
<span class="hljs-keyword">END</span>;
$$ LANGUAGE plpgsql;

<span class="hljs-comment">-- Grant execute permission only to authorized roles</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">FUNCTION</span> secure_transfer <span class="hljs-keyword">TO</span> bank_teller, account_manager;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-use-cases--interview-tips">ğŸ¯ Use Cases &amp; Interview Tips</h2>
<h3 id="common-interview-questions">Common Interview Questions:</h3>
<ol>
<li>
<p><strong>&quot;How do you secure a database?&quot;</strong></p>
<ul>
<li><strong>Network</strong>: Firewalls, VPNs, SSL/TLS</li>
<li><strong>Authentication</strong>: Strong passwords, MFA, certificates</li>
<li><strong>Authorization</strong>: RBAC, principle of least privilege</li>
<li><strong>Encryption</strong>: Data at rest and in transit</li>
<li><strong>Auditing</strong>: Log all access and changes</li>
<li><strong>Monitoring</strong>: Detect suspicious activities</li>
</ul>
</li>
<li>
<p><strong>&quot;What's the difference between authentication and authorization?&quot;</strong></p>
<ul>
<li><strong>Authentication</strong>: Verifying identity (&quot;Who are you?&quot;)</li>
<li><strong>Authorization</strong>: Controlling access (&quot;What can you do?&quot;)</li>
<li>Example: Login (authentication) â†’ Check permissions (authorization)</li>
</ul>
</li>
<li>
<p><strong>&quot;How do you prevent SQL injection?&quot;</strong></p>
<ul>
<li><strong>Parameterized queries</strong>: Use placeholders for user input</li>
<li><strong>Input validation</strong>: Sanitize and validate all inputs</li>
<li><strong>Stored procedures</strong>: Encapsulate database logic</li>
<li><strong>Least privilege</strong>: Limit database user permissions</li>
<li><strong>WAF</strong>: Web Application Firewall for additional protection</li>
</ul>
</li>
<li>
<p><strong>&quot;Explain row-level security.&quot;</strong></p>
<ul>
<li><strong>Concept</strong>: Filter rows based on user context</li>
<li><strong>Implementation</strong>: Policies that define access rules</li>
<li><strong>Use cases</strong>: Multi-tenant applications, data privacy</li>
<li><strong>Performance</strong>: Consider impact on query performance</li>
</ul>
</li>
</ol>
<h3 id="security-best-practices">Security Best Practices:</h3>
<ol>
<li><strong>Defense in depth</strong>: Multiple security layers</li>
<li><strong>Regular updates</strong>: Keep database software current</li>
<li><strong>Strong authentication</strong>: Complex passwords, MFA</li>
<li><strong>Principle of least privilege</strong>: Minimal necessary access</li>
<li><strong>Encryption everywhere</strong>: Data at rest and in transit</li>
<li><strong>Comprehensive auditing</strong>: Log all database activities</li>
<li><strong>Regular security assessments</strong>: Penetration testing, vulnerability scans</li>
<li><strong>Incident response plan</strong>: Prepare for security breaches</li>
</ol>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-things-to-watch-out-for">âš ï¸ Things to Watch Out For</h2>
<h3 id="1-overprivileged-users">1. <strong>Overprivileged Users</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Giving too many privileges</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">PRIVILEGES</span> <span class="hljs-keyword">ON</span> *.* <span class="hljs-keyword">TO</span> <span class="hljs-string">'app_user'</span>@<span class="hljs-string">'%'</span>; <span class="hljs-comment">-- Too broad!</span>

<span class="hljs-comment">-- Solution: Grant specific privileges</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, <span class="hljs-keyword">INSERT</span>, <span class="hljs-keyword">UPDATE</span>, <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">ON</span> ecommerce.* <span class="hljs-keyword">TO</span> <span class="hljs-string">'app_user'</span>@<span class="hljs-string">'%'</span>;
</div></code></pre>
<h3 id="2-weak-password-policies">2. <strong>Weak Password Policies</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Weak passwords</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'admin'</span>@<span class="hljs-string">'%'</span> <span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'123456'</span>;

<span class="hljs-comment">-- Solution: Strong password requirements</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'admin'</span>@<span class="hljs-string">'%'</span> <span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'StrongP@ssw0rd123!'</span>;
</div></code></pre>
<h3 id="3-unencrypted-connections">3. <strong>Unencrypted Connections</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Allowing unencrypted connections</span>
<span class="hljs-comment">-- host all all 0.0.0.0/0 md5</span>

<span class="hljs-comment">-- Solution: Require SSL</span>
<span class="hljs-comment">-- hostssl all all 0.0.0.0/0 md5</span>
</div></code></pre>
<h3 id="4-missing-audit-trails">4. <strong>Missing Audit Trails</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: No logging of sensitive operations</span>
<span class="hljs-comment">-- Solution: Comprehensive audit logging</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> audit_sensitive_table
    <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">ON</span> sensitive_table
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span> <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">FUNCTION</span> audit_function();
</div></code></pre>
<h3 id="5-storing-sensitive-data-in-plain-text">5. <strong>Storing Sensitive Data in Plain Text</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Plain text sensitive data</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span>,
    username <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    <span class="hljs-keyword">password</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>), <span class="hljs-comment">-- Plain text!</span>
    ssn <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">11</span>)       <span class="hljs-comment">-- Plain text!</span>
);

<span class="hljs-comment">-- Solution: Encrypt sensitive data</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span>,
    username <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    password_hash <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>), <span class="hljs-comment">-- Hashed</span>
    ssn_encrypted BYTEA         <span class="hljs-comment">-- Encrypted</span>
);
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%9A-summary">ğŸ“š Summary</h2>
<p>Database security is a multi-layered approach that requires:</p>
<ul>
<li><strong>Strong authentication</strong> and authorization mechanisms</li>
<li><strong>Proper user and role management</strong> with least privilege</li>
<li><strong>Encryption</strong> for data protection at rest and in transit</li>
<li><strong>Comprehensive auditing</strong> for compliance and monitoring</li>
<li><strong>Regular security assessments</strong> and updates</li>
<li><strong>Defense in depth</strong> strategy with multiple security layers</li>
</ul>
<p>Implementing these security measures protects sensitive data, ensures compliance with regulations, and maintains user trust in your applications.</p>
<hr>
<h2 id="%F0%9F%94%97-next-steps">ğŸ”— Next Steps</h2>
<p>In the next chapter, we'll explore <strong><a href="./17-backup-recovery.md">Backup and Recovery</a></strong>, covering backup strategies, point-in-time recovery, disaster recovery planning, and high availability configurations.</p>
<hr>
<p><em>Remember: Security is not a one-time setupâ€”it's an ongoing process that requires constant vigilance and updates.</em></p>
<h1 id="chapter-17-backup-and-recovery">Chapter 17: Backup and Recovery</h1>
<h2 id="%F0%9F%93%9A-what-youll-learn">ğŸ“š What You'll Learn</h2>
<p>Database backup and recovery are critical for protecting data against hardware failures, human errors, corruption, and disasters. This chapter covers comprehensive backup strategies, recovery procedures, and high availability configurations for MySQL and PostgreSQL.</p>
<hr>
<h2 id="%F0%9F%8E%AF-learning-objectives">ğŸ¯ Learning Objectives</h2>
<p>By the end of this chapter, you will:</p>
<ul>
<li>Understand different types of database backups</li>
<li>Implement automated backup strategies</li>
<li>Perform point-in-time recovery</li>
<li>Configure high availability and replication</li>
<li>Plan disaster recovery procedures</li>
<li>Monitor backup integrity and performance</li>
<li>Handle various failure scenarios</li>
</ul>
<hr>
<h2 id="%F0%9F%94%8D-concept-explanation">ğŸ” Concept Explanation</h2>
<h3 id="why-backup-and-recovery-matter">Why Backup and Recovery Matter</h3>
<p><strong>Data Loss Scenarios:</strong></p>
<ul>
<li><strong>Hardware Failures</strong>: Disk crashes, server failures</li>
<li><strong>Human Errors</strong>: Accidental deletions, wrong updates</li>
<li><strong>Software Bugs</strong>: Application errors, corruption</li>
<li><strong>Security Breaches</strong>: Malicious attacks, ransomware</li>
<li><strong>Natural Disasters</strong>: Fire, flood, earthquakes</li>
</ul>
<p><strong>Business Impact:</strong></p>
<ul>
<li><strong>Downtime Costs</strong>: Lost revenue, productivity</li>
<li><strong>Data Loss</strong>: Irreplaceable business information</li>
<li><strong>Compliance</strong>: Legal and regulatory requirements</li>
<li><strong>Reputation</strong>: Customer trust and brand damage</li>
</ul>
<h3 id="key-concepts">Key Concepts</h3>
<p><strong>Recovery Point Objective (RPO)</strong>: Maximum acceptable data loss
<strong>Recovery Time Objective (RTO)</strong>: Maximum acceptable downtime
<strong>Backup Types</strong>: Full, incremental, differential
<strong>Recovery Types</strong>: Complete, point-in-time, partial</p>
<hr>
<h2 id="%F0%9F%9B%A0%EF%B8%8F-backup-strategies">ğŸ› ï¸ Backup Strategies</h2>
<h3 id="mysql-backup-methods">MySQL Backup Methods</h3>
<h4 id="1-logical-backups-with-mysqldump">1. Logical Backups with mysqldump</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Full database backup</span>
mysqldump -u root -p --all-databases &gt; full_backup.sql

<span class="hljs-comment"># Single database backup</span>
mysqldump -u root -p ecommerce_db &gt; ecommerce_backup.sql

<span class="hljs-comment"># Backup with additional options</span>
mysqldump -u root -p \
  --single-transaction \
  --routines \
  --triggers \
  --events \
  --all-databases &gt; complete_backup.sql

<span class="hljs-comment"># Compressed backup</span>
mysqldump -u root -p ecommerce_db | gzip &gt; ecommerce_backup.sql.gz

<span class="hljs-comment"># Backup specific tables</span>
mysqldump -u root -p ecommerce_db customers orders &gt; tables_backup.sql
</div></code></pre>
<h4 id="2-physical-backups">2. Physical Backups</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># MySQL Enterprise Backup (Commercial)</span>
mysqlbackup --user=root --password \
  --backup-dir=/backup/mysql \
  backup-and-apply-log

<span class="hljs-comment"># Percona XtraBackup (Open Source)</span>
xtrabackup --user=root --password=password \
  --backup --target-dir=/backup/mysql/

<span class="hljs-comment"># Hot backup with XtraBackup</span>
xtrabackup --user=root --password=password \
  --backup \
  --target-dir=/backup/mysql/$(date +%Y%m%d_%H%M%S)
</div></code></pre>
<h4 id="3-binary-log-backups">3. Binary Log Backups</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Enable binary logging in my.cnf</span>
[mysqld]
log-bin=mysql-bin
server-id=1
binlog-format=ROW
expire_logs_days=7

<span class="hljs-comment">-- Flush and backup binary logs</span>
<span class="hljs-keyword">FLUSH</span> <span class="hljs-keyword">LOGS</span>;

<span class="hljs-comment">-- Copy binary log files</span>
<span class="hljs-comment">-- mysql-bin.000001, mysql-bin.000002, etc.</span>
</div></code></pre>
<h3 id="postgresql-backup-methods">PostgreSQL Backup Methods</h3>
<h4 id="1-logical-backups-with-pgdump">1. Logical Backups with pg_dump</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Full database backup</span>
pg_dump -U postgres -h localhost ecommerce_db &gt; ecommerce_backup.sql

<span class="hljs-comment"># Compressed backup</span>
pg_dump -U postgres -h localhost -Fc ecommerce_db &gt; ecommerce_backup.dump

<span class="hljs-comment"># All databases backup</span>
pg_dumpall -U postgres -h localhost &gt; all_databases.sql

<span class="hljs-comment"># Backup with specific options</span>
pg_dump -U postgres -h localhost \
  --verbose \
  --clean \
  --<span class="hljs-keyword">if</span>-exists \
  --format=custom \
  ecommerce_db &gt; ecommerce_backup.dump

<span class="hljs-comment"># Parallel backup (faster for large databases)</span>
pg_dump -U postgres -h localhost \
  --format=directory \
  --<span class="hljs-built_in">jobs</span>=4 \
  --file=ecommerce_backup_dir \
  ecommerce_db
</div></code></pre>
<h4 id="2-physical-backups-with-pgbasebackup">2. Physical Backups with pg_basebackup</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Base backup</span>
pg_basebackup -U postgres -h localhost \
  -D /backup/postgresql/base \
  -Ft -z -P

<span class="hljs-comment"># Streaming backup</span>
pg_basebackup -U postgres -h localhost \
  -D /backup/postgresql/$(date +%Y%m%d_%H%M%S) \
  -X stream -P

<span class="hljs-comment"># WAL archiving setup in postgresql.conf</span>
wal_level = replica
archive_mode = on
archive_command = <span class="hljs-string">'cp %p /backup/postgresql/wal/%f'</span>
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%84-automated-backup-scripts">ğŸ”„ Automated Backup Scripts</h2>
<h3 id="mysql-automated-backup-script">MySQL Automated Backup Script</h3>
<pre class="hljs"><code><div><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># mysql_backup.sh</span>

<span class="hljs-comment"># Configuration</span>
DB_USER=<span class="hljs-string">"backup_user"</span>
DB_PASS=<span class="hljs-string">"secure_password"</span>
BACKUP_DIR=<span class="hljs-string">"/backup/mysql"</span>
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

<span class="hljs-comment"># Create backup directory</span>
mkdir -p <span class="hljs-variable">$BACKUP_DIR</span>

<span class="hljs-comment"># Function to backup database</span>
<span class="hljs-function"><span class="hljs-title">backup_database</span></span>() {
    <span class="hljs-built_in">local</span> db_name=<span class="hljs-variable">$1</span>
    <span class="hljs-built_in">local</span> backup_file=<span class="hljs-string">"<span class="hljs-variable">$BACKUP_DIR</span>/<span class="hljs-variable">${db_name}</span>_<span class="hljs-variable">${DATE}</span>.sql.gz"</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Backing up database: <span class="hljs-variable">$db_name</span>"</span>
    mysqldump -u <span class="hljs-variable">$DB_USER</span> -p<span class="hljs-variable">$DB_PASS</span> \
        --single-transaction \
        --routines \
        --triggers \
        --events \
        <span class="hljs-variable">$db_name</span> | gzip &gt; <span class="hljs-variable">$backup_file</span>

    <span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Backup successful: <span class="hljs-variable">$backup_file</span>"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Backup failed for: <span class="hljs-variable">$db_name</span>"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># Backup all databases</span>
DATABASES=$(mysql -u <span class="hljs-variable">$DB_USER</span> -p<span class="hljs-variable">$DB_PASS</span> -e <span class="hljs-string">"SHOW DATABASES;"</span> | grep -Ev <span class="hljs-string">"^(Database|information_schema|performance_schema|mysql|sys)$"</span>)

<span class="hljs-keyword">for</span> db <span class="hljs-keyword">in</span> <span class="hljs-variable">$DATABASES</span>; <span class="hljs-keyword">do</span>
    backup_database <span class="hljs-variable">$db</span>
<span class="hljs-keyword">done</span>

<span class="hljs-comment"># Clean old backups</span>
find <span class="hljs-variable">$BACKUP_DIR</span> -name <span class="hljs-string">"*.sql.gz"</span> -mtime +<span class="hljs-variable">$RETENTION_DAYS</span> -delete

<span class="hljs-built_in">echo</span> <span class="hljs-string">"Backup process completed at <span class="hljs-variable">$(date)</span>"</span>
</div></code></pre>
<h3 id="postgresql-automated-backup-script">PostgreSQL Automated Backup Script</h3>
<pre class="hljs"><code><div><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># postgresql_backup.sh</span>

<span class="hljs-comment"># Configuration</span>
<span class="hljs-built_in">export</span> PGUSER=<span class="hljs-string">"postgres"</span>
<span class="hljs-built_in">export</span> PGPASSWORD=<span class="hljs-string">"secure_password"</span>
BACKUP_DIR=<span class="hljs-string">"/backup/postgresql"</span>
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

<span class="hljs-comment"># Create backup directory</span>
mkdir -p <span class="hljs-variable">$BACKUP_DIR</span>

<span class="hljs-comment"># Function to backup database</span>
<span class="hljs-function"><span class="hljs-title">backup_database</span></span>() {
    <span class="hljs-built_in">local</span> db_name=<span class="hljs-variable">$1</span>
    <span class="hljs-built_in">local</span> backup_file=<span class="hljs-string">"<span class="hljs-variable">$BACKUP_DIR</span>/<span class="hljs-variable">${db_name}</span>_<span class="hljs-variable">${DATE}</span>.dump"</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Backing up database: <span class="hljs-variable">$db_name</span>"</span>
    pg_dump -h localhost \
        --format=custom \
        --compress=9 \
        --verbose \
        --file=<span class="hljs-variable">$backup_file</span> \
        <span class="hljs-variable">$db_name</span>

    <span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Backup successful: <span class="hljs-variable">$backup_file</span>"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Backup failed for: <span class="hljs-variable">$db_name</span>"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># Get list of databases</span>
DATABASES=$(psql -h localhost -t -c <span class="hljs-string">"SELECT datname FROM pg_database WHERE NOT datistemplate AND datname != 'postgres';"</span>)

<span class="hljs-keyword">for</span> db <span class="hljs-keyword">in</span> <span class="hljs-variable">$DATABASES</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-comment"># Remove whitespace</span>
    db=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$db</span> | xargs)
    backup_database <span class="hljs-variable">$db</span>
<span class="hljs-keyword">done</span>

<span class="hljs-comment"># Clean old backups</span>
find <span class="hljs-variable">$BACKUP_DIR</span> -name <span class="hljs-string">"*.dump"</span> -mtime +<span class="hljs-variable">$RETENTION_DAYS</span> -delete

<span class="hljs-built_in">echo</span> <span class="hljs-string">"Backup process completed at <span class="hljs-variable">$(date)</span>"</span>
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%A7-recovery-procedures">ğŸ”§ Recovery Procedures</h2>
<h3 id="mysql-recovery">MySQL Recovery</h3>
<h4 id="1-full-database-restore">1. Full Database Restore</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Restore from mysqldump</span>
mysql -u root -p &lt; full_backup.sql

<span class="hljs-comment"># Restore specific database</span>
mysql -u root -p ecommerce_db &lt; ecommerce_backup.sql

<span class="hljs-comment"># Restore compressed backup</span>
gunzip &lt; ecommerce_backup.sql.gz | mysql -u root -p ecommerce_db
</div></code></pre>
<h4 id="2-point-in-time-recovery">2. Point-in-Time Recovery</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Step 1: Restore from full backup</span>
mysql -u root -p &lt; full_backup_20241201_020000.sql

<span class="hljs-comment"># Step 2: Apply binary logs up to specific time</span>
mysqlbinlog --stop-datetime=<span class="hljs-string">"2024-12-01 14:30:00"</span> \
    mysql-bin.000001 mysql-bin.000002 | mysql -u root -p

<span class="hljs-comment"># Alternative: Stop at specific position</span>
mysqlbinlog --stop-position=12345 \
    mysql-bin.000001 | mysql -u root -p
</div></code></pre>
<h4 id="3-xtrabackup-recovery">3. XtraBackup Recovery</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Prepare the backup</span>
xtrabackup --prepare --target-dir=/backup/mysql/20241201_020000

<span class="hljs-comment"># Stop MySQL service</span>
sudo systemctl stop mysql

<span class="hljs-comment"># Remove old data directory</span>
sudo rm -rf /var/lib/mysql/*

<span class="hljs-comment"># Copy backup to data directory</span>
xtrabackup --copy-back --target-dir=/backup/mysql/20241201_020000

<span class="hljs-comment"># Fix permissions</span>
sudo chown -R mysql:mysql /var/lib/mysql

<span class="hljs-comment"># Start MySQL service</span>
sudo systemctl start mysql
</div></code></pre>
<h3 id="postgresql-recovery">PostgreSQL Recovery</h3>
<h4 id="1-database-restore">1. Database Restore</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Restore from pg_dump (SQL format)</span>
psql -U postgres -h localhost -d ecommerce_db &lt; ecommerce_backup.sql

<span class="hljs-comment"># Restore from custom format</span>
pg_restore -U postgres -h localhost \
    --dbname=ecommerce_db \
    --verbose \
    ecommerce_backup.dump

<span class="hljs-comment"># Restore with parallel jobs</span>
pg_restore -U postgres -h localhost \
    --dbname=ecommerce_db \
    --<span class="hljs-built_in">jobs</span>=4 \
    --verbose \
    ecommerce_backup_dir

<span class="hljs-comment"># Create database and restore</span>
createdb -U postgres ecommerce_db_restored
pg_restore -U postgres -h localhost \
    --dbname=ecommerce_db_restored \
    ecommerce_backup.dump
</div></code></pre>
<h4 id="2-point-in-time-recovery-pitr">2. Point-in-Time Recovery (PITR)</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Step 1: Stop PostgreSQL</span>
sudo systemctl stop postgresql

<span class="hljs-comment"># Step 2: Restore base backup</span>
rm -rf /var/lib/postgresql/13/main/*
tar -xzf base_backup.tar.gz -C /var/lib/postgresql/13/main/

<span class="hljs-comment"># Step 3: Create recovery.conf (PostgreSQL &lt; 12) or recovery.signal (PostgreSQL &gt;= 12)</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"restore_command = 'cp /backup/postgresql/wal/%f %p'"</span> &gt; /var/lib/postgresql/13/main/recovery.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"recovery_target_time = '2024-12-01 14:30:00'"</span> &gt;&gt; /var/lib/postgresql/13/main/recovery.conf

<span class="hljs-comment"># For PostgreSQL &gt;= 12</span>
touch /var/lib/postgresql/13/main/recovery.signal
<span class="hljs-built_in">echo</span> <span class="hljs-string">"restore_command = 'cp /backup/postgresql/wal/%f %p'"</span> &gt;&gt; /var/lib/postgresql/13/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"recovery_target_time = '2024-12-01 14:30:00'"</span> &gt;&gt; /var/lib/postgresql/13/main/postgresql.conf

<span class="hljs-comment"># Step 4: Start PostgreSQL</span>
sudo systemctl start postgresql
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%84-high-availability-and-replication">ğŸ”„ High Availability and Replication</h2>
<h3 id="mysql-replication">MySQL Replication</h3>
<h4 id="master-slave-replication-setup">Master-Slave Replication Setup</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Master configuration (my.cnf)</span>
[mysqld]
server-id=1
log-bin=mysql-bin
binlog-format=ROW
binlog-<span class="hljs-keyword">do</span>-db=ecommerce_db

<span class="hljs-comment">-- Create replication user on master</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'replication'</span>@<span class="hljs-string">'%'</span> <span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'secure_password'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">REPLICATION</span> <span class="hljs-keyword">SLAVE</span> <span class="hljs-keyword">ON</span> *.* <span class="hljs-keyword">TO</span> <span class="hljs-string">'replication'</span>@<span class="hljs-string">'%'</span>;
<span class="hljs-keyword">FLUSH</span> <span class="hljs-keyword">PRIVILEGES</span>;

<span class="hljs-comment">-- Get master status</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">MASTER</span> <span class="hljs-keyword">STATUS</span>;
<span class="hljs-comment">-- <span class="hljs-doctag">Note:</span> File and Position values</span>

<span class="hljs-comment">-- Slave configuration (my.cnf)</span>
[mysqld]
server-id=2
relay-log=mysql-relay-bin
read-only=1

<span class="hljs-comment">-- Configure slave</span>
<span class="hljs-keyword">CHANGE</span> <span class="hljs-keyword">MASTER</span> <span class="hljs-keyword">TO</span>
    MASTER_HOST=<span class="hljs-string">'master_ip'</span>,
    MASTER_USER=<span class="hljs-string">'replication'</span>,
    MASTER_PASSWORD=<span class="hljs-string">'secure_password'</span>,
    MASTER_LOG_FILE=<span class="hljs-string">'mysql-bin.000001'</span>,
    MASTER_LOG_POS=<span class="hljs-number">12345</span>;

<span class="hljs-comment">-- Start replication</span>
<span class="hljs-keyword">START</span> <span class="hljs-keyword">SLAVE</span>;

<span class="hljs-comment">-- Check slave status</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">SLAVE</span> <span class="hljs-keyword">STATUS</span>\G
</div></code></pre>
<h4 id="mysql-group-replication">MySQL Group Replication</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Install Group Replication plugin</span>
<span class="hljs-keyword">INSTALL</span> <span class="hljs-keyword">PLUGIN</span> group_replication <span class="hljs-keyword">SONAME</span> <span class="hljs-string">'group_replication.so'</span>;

<span class="hljs-comment">-- Configure Group Replication</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> group_replication_group_name=<span class="hljs-string">"aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> group_replication_start_on_boot=<span class="hljs-keyword">off</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> group_replication_local_address=<span class="hljs-string">"192.168.1.10:33061"</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> group_replication_group_seeds=<span class="hljs-string">"192.168.1.10:33061,192.168.1.11:33061,192.168.1.12:33061"</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> group_replication_bootstrap_group=<span class="hljs-keyword">on</span>;

<span class="hljs-comment">-- Start Group Replication</span>
<span class="hljs-keyword">START</span> GROUP_REPLICATION;

<span class="hljs-comment">-- Check group members</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> performance_schema.replication_group_members;
</div></code></pre>
<h3 id="postgresql-replication">PostgreSQL Replication</h3>
<h4 id="streaming-replication-setup">Streaming Replication Setup</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Primary server configuration (postgresql.conf)</span>
wal_level = replica
max_wal_senders = 3
wal_keep_segments = 64
archive_mode = on
archive_command = <span class="hljs-string">'cp %p /backup/postgresql/wal/%f'</span>

<span class="hljs-comment"># Create replication user</span>
psql -U postgres -c <span class="hljs-string">"CREATE USER replication REPLICATION LOGIN PASSWORD 'secure_password';"</span>

<span class="hljs-comment"># Configure pg_hba.conf on primary</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"host replication replication 192.168.1.0/24 md5"</span> &gt;&gt; /etc/postgresql/13/main/pg_hba.conf

<span class="hljs-comment"># Setup standby server</span>
pg_basebackup -h primary_ip -D /var/lib/postgresql/13/main -U replication -P -W

<span class="hljs-comment"># Configure standby (postgresql.conf)</span>
hot_standby = on

<span class="hljs-comment"># Create standby.signal file</span>
touch /var/lib/postgresql/13/main/standby.signal

<span class="hljs-comment"># Configure primary connection info</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"primary_conninfo = 'host=primary_ip port=5432 user=replication password=secure_password'"</span> &gt;&gt; /var/lib/postgresql/13/main/postgresql.conf
</div></code></pre>
<h4 id="postgresql-logical-replication">PostgreSQL Logical Replication</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Publisher setup</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> wal_level = <span class="hljs-keyword">logical</span>;
<span class="hljs-keyword">SELECT</span> pg_reload_conf();

<span class="hljs-comment">-- Create publication</span>
<span class="hljs-keyword">CREATE</span> PUBLICATION ecommerce_pub <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">TABLE</span> customers, orders, products;

<span class="hljs-comment">-- Subscriber setup</span>
<span class="hljs-keyword">CREATE</span> SUBSCRIPTION ecommerce_sub
<span class="hljs-keyword">CONNECTION</span> <span class="hljs-string">'host=publisher_ip dbname=ecommerce_db user=replication password=secure_password'</span>
PUBLICATION ecommerce_pub;

<span class="hljs-comment">-- Monitor replication</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pg_stat_replication;
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pg_stat_subscription;
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%8A-monitoring-and-maintenance">ğŸ“Š Monitoring and Maintenance</h2>
<h3 id="backup-monitoring">Backup Monitoring</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- MySQL: Check binary log status</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-built_in">BINARY</span> <span class="hljs-keyword">LOGS</span>;
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">MASTER</span> <span class="hljs-keyword">STATUS</span>;

<span class="hljs-comment">-- Check slave lag</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">SLAVE</span> <span class="hljs-keyword">STATUS</span>\G

<span class="hljs-comment">-- PostgreSQL: Check WAL status</span>
<span class="hljs-keyword">SELECT</span> pg_current_wal_lsn();
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pg_stat_archiver;

<span class="hljs-comment">-- Check replication lag</span>
<span class="hljs-keyword">SELECT</span>
    client_addr,
    state,
    pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) <span class="hljs-keyword">as</span> send_lag,
    pg_wal_lsn_diff(sent_lsn, flush_lsn) <span class="hljs-keyword">as</span> receive_lag
<span class="hljs-keyword">FROM</span> pg_stat_replication;
</div></code></pre>
<h3 id="backup-verification-script">Backup Verification Script</h3>
<pre class="hljs"><code><div><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># verify_backup.sh</span>

BACKUP_FILE=<span class="hljs-variable">$1</span>
TEST_DB=<span class="hljs-string">"backup_test_<span class="hljs-variable">$(date +%s)</span>"</span>

<span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$BACKUP_FILE</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Usage: <span class="hljs-variable">$0</span> &lt;backup_file&gt;"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"Verifying backup: <span class="hljs-variable">$BACKUP_FILE</span>"</span>

<span class="hljs-comment"># Create test database</span>
mysql -u root -p -e <span class="hljs-string">"CREATE DATABASE <span class="hljs-variable">$TEST_DB</span>;"</span>

<span class="hljs-comment"># Restore backup to test database</span>
<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$BACKUP_FILE</span> == *.gz ]]; <span class="hljs-keyword">then</span>
    gunzip &lt; <span class="hljs-variable">$BACKUP_FILE</span> | mysql -u root -p <span class="hljs-variable">$TEST_DB</span>
<span class="hljs-keyword">else</span>
    mysql -u root -p <span class="hljs-variable">$TEST_DB</span> &lt; <span class="hljs-variable">$BACKUP_FILE</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Backup verification successful"</span>
    <span class="hljs-comment"># Run basic integrity checks</span>
    mysql -u root -p <span class="hljs-variable">$TEST_DB</span> -e <span class="hljs-string">"CHECK TABLE customers, orders, products;"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Backup verification failed"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># Cleanup</span>
mysql -u root -p -e <span class="hljs-string">"DROP DATABASE <span class="hljs-variable">$TEST_DB</span>;"</span>
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%A8-disaster-recovery-planning">ğŸš¨ Disaster Recovery Planning</h2>
<h3 id="recovery-time-objectives-rto-and-recovery-point-objectives-rpo">Recovery Time Objectives (RTO) and Recovery Point Objectives (RPO)</h3>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>RTO Target</th>
<th>RPO Target</th>
<th>Strategy</th>
</tr>
</thead>
<tbody>
<tr>
<td>Hardware Failure</td>
<td>&lt; 1 hour</td>
<td>&lt; 15 minutes</td>
<td>Hot standby with replication</td>
</tr>
<tr>
<td>Data Corruption</td>
<td>&lt; 4 hours</td>
<td>&lt; 1 hour</td>
<td>Point-in-time recovery</td>
</tr>
<tr>
<td>Site Disaster</td>
<td>&lt; 24 hours</td>
<td>&lt; 1 hour</td>
<td>Geographic replication</td>
</tr>
<tr>
<td>Human Error</td>
<td>&lt; 2 hours</td>
<td>&lt; 30 minutes</td>
<td>Transaction log replay</td>
</tr>
</tbody>
</table>
<h3 id="disaster-recovery-checklist">Disaster Recovery Checklist</h3>
<pre class="hljs"><code><div><span class="hljs-section">## Pre-Disaster Preparation</span>
<span class="hljs-bullet">
- </span>[ ] Document all backup procedures
<span class="hljs-bullet">- </span>[ ] Test recovery procedures monthly
<span class="hljs-bullet">- </span>[ ] Maintain off-site backup copies
<span class="hljs-bullet">- </span>[ ] Configure monitoring and alerting
<span class="hljs-bullet">- </span>[ ] Train staff on recovery procedures
<span class="hljs-bullet">- </span>[ ] Maintain emergency contact list

<span class="hljs-section">## During Disaster</span>
<span class="hljs-bullet">
- </span>[ ] Assess the scope of the problem
<span class="hljs-bullet">- </span>[ ] Activate disaster recovery team
<span class="hljs-bullet">- </span>[ ] Communicate with stakeholders
<span class="hljs-bullet">- </span>[ ] Execute recovery procedures
<span class="hljs-bullet">- </span>[ ] Document all actions taken
<span class="hljs-bullet">- </span>[ ] Monitor recovery progress

<span class="hljs-section">## Post-Disaster</span>
<span class="hljs-bullet">
- </span>[ ] Verify data integrity
<span class="hljs-bullet">- </span>[ ] Test application functionality
<span class="hljs-bullet">- </span>[ ] Update documentation
<span class="hljs-bullet">- </span>[ ] Conduct post-mortem analysis
<span class="hljs-bullet">- </span>[ ] Improve procedures based on lessons learned
</div></code></pre>
<h3 id="cloud-backup-strategies">Cloud Backup Strategies</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># AWS S3 backup</span>
aws s3 cp backup.sql.gz s3://company-db-backups/mysql/$(date +%Y/%m/%d)/

<span class="hljs-comment"># Google Cloud Storage</span>
gsutil cp backup.sql.gz gs://company-db-backups/mysql/$(date +%Y/%m/%d)/

<span class="hljs-comment"># Azure Blob Storage</span>
az storage blob upload \
    --account-name companystorage \
    --container-name db-backups \
    --name mysql/$(date +%Y/%m/%d)/backup.sql.gz \
    --file backup.sql.gz
</div></code></pre>
<hr>
<h2 id="%F0%9F%92%A1-real-world-examples">ğŸ’¡ Real-World Examples</h2>
<h3 id="example-1-e-commerce-platform-recovery">Example 1: E-commerce Platform Recovery</h3>
<p><strong>Scenario</strong>: Online store database corruption during peak shopping season</p>
<pre class="hljs"><code><div><span class="hljs-comment"># 1. Immediate response</span>
<span class="hljs-comment"># Switch to read-only mode</span>
mysql -u root -p -e <span class="hljs-string">"SET GLOBAL read_only = ON;"</span>

<span class="hljs-comment"># 2. Assess damage</span>
mysql -u root -p ecommerce_db -e <span class="hljs-string">"CHECK TABLE orders, customers, products;"</span>

<span class="hljs-comment"># 3. Point-in-time recovery to just before corruption</span>
<span class="hljs-comment"># Restore from last good backup (2 hours ago)</span>
mysql -u root -p &lt; ecommerce_backup_20241201_140000.sql

<span class="hljs-comment"># Apply binary logs up to corruption point</span>
mysqlbinlog --stop-datetime=<span class="hljs-string">"2024-12-01 16:25:00"</span> \
    mysql-bin.000015 | mysql -u root -p ecommerce_db

<span class="hljs-comment"># 4. Verify data integrity</span>
mysql -u root -p ecommerce_db -e <span class="hljs-string">"
    SELECT COUNT(*) FROM orders WHERE order_date = CURDATE();
    SELECT COUNT(*) FROM customers WHERE created_at = CURDATE();
"</span>

<span class="hljs-comment"># 5. Resume normal operations</span>
mysql -u root -p -e <span class="hljs-string">"SET GLOBAL read_only = OFF;"</span>
</div></code></pre>
<h3 id="example-2-postgresql-failover">Example 2: PostgreSQL Failover</h3>
<p><strong>Scenario</strong>: Primary database server hardware failure</p>
<pre class="hljs"><code><div><span class="hljs-comment"># 1. Promote standby to primary</span>
psql -U postgres -c <span class="hljs-string">"SELECT pg_promote();"</span>

<span class="hljs-comment"># 2. Update application connection strings</span>
<span class="hljs-comment"># Point applications to new primary server</span>

<span class="hljs-comment"># 3. Verify replication status</span>
psql -U postgres -c <span class="hljs-string">"SELECT pg_is_in_recovery();"</span>

<span class="hljs-comment"># 4. Setup new standby server</span>
pg_basebackup -h new_primary_ip -D /var/lib/postgresql/13/main -U replication -P -W

<span class="hljs-comment"># 5. Configure new standby</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"primary_conninfo = 'host=new_primary_ip port=5432 user=replication'"</span> &gt;&gt; postgresql.conf
touch standby.signal
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-use-cases--interview-tips">ğŸ¯ Use Cases &amp; Interview Tips</h2>
<h3 id="common-interview-questions">Common Interview Questions</h3>
<ol>
<li>
<p><strong>&quot;How would you design a backup strategy for a 24/7 e-commerce application?&quot;</strong></p>
<ul>
<li>Continuous replication for high availability</li>
<li>Automated daily full backups</li>
<li>Hourly incremental backups</li>
<li>Off-site backup storage</li>
<li>Regular recovery testing</li>
</ul>
</li>
<li>
<p><strong>&quot;What's the difference between hot, warm, and cold backups?&quot;</strong></p>
<ul>
<li><strong>Hot</strong>: Database remains online and accessible</li>
<li><strong>Warm</strong>: Database is online but in read-only mode</li>
<li><strong>Cold</strong>: Database is shut down during backup</li>
</ul>
</li>
<li>
<p><strong>&quot;How do you ensure backup integrity?&quot;</strong></p>
<ul>
<li>Checksum verification</li>
<li>Regular restore testing</li>
<li>Backup validation scripts</li>
<li>Monitoring backup completion</li>
<li>Multiple backup copies</li>
</ul>
</li>
<li>
<p><strong>&quot;Explain point-in-time recovery.&quot;</strong></p>
<ul>
<li>Restore from full backup</li>
<li>Apply transaction logs up to specific time</li>
<li>Useful for recovering from human errors</li>
<li>Requires continuous log archiving</li>
</ul>
</li>
</ol>
<h3 id="best-practices">Best Practices</h3>
<ol>
<li><strong>3-2-1 Rule</strong>: 3 copies of data, 2 different media types, 1 off-site</li>
<li><strong>Test Regularly</strong>: Recovery procedures should be tested monthly</li>
<li><strong>Automate Everything</strong>: Reduce human error with automation</li>
<li><strong>Monitor Continuously</strong>: Alert on backup failures immediately</li>
<li><strong>Document Thoroughly</strong>: Clear procedures for emergency situations</li>
</ol>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-things-to-watch-out-for">âš ï¸ Things to Watch Out For</h2>
<h3 id="common-backup-mistakes">Common Backup Mistakes</h3>
<ol>
<li>
<p><strong>Not Testing Restores</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Bad: Only creating backups</span>
mysqldump -u root -p database &gt; backup.sql

<span class="hljs-comment"># Good: Testing restore process</span>
mysql -u root -p test_db &lt; backup.sql
</div></code></pre>
</li>
<li>
<p><strong>Insufficient Retention</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Bad: Only keeping recent backups</span>
find /backup -name <span class="hljs-string">"*.sql"</span> -mtime +7 -delete

<span class="hljs-comment"># Good: Graduated retention policy</span>
<span class="hljs-comment"># Keep daily for 30 days, weekly for 12 weeks, monthly for 12 months</span>
</div></code></pre>
</li>
<li>
<p><strong>No Off-site Storage</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Bad: All backups on same server</span>
cp backup.sql /<span class="hljs-built_in">local</span>/backup/

<span class="hljs-comment"># Good: Remote storage</span>
rsync backup.sql remote-server:/backup/
aws s3 cp backup.sql s3://backup-bucket/
</div></code></pre>
</li>
<li>
<p><strong>Ignoring Binary Logs</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Bad: Only full backups</span>
mysqldump <span class="hljs-comment">--all-databases &gt; backup.sql</span>

<span class="hljs-comment">-- Good: Enable binary logging for point-in-time recovery</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> log_bin = <span class="hljs-keyword">ON</span>;
</div></code></pre>
</li>
</ol>
<h3 id="security-considerations">Security Considerations</h3>
<ol>
<li>
<p><strong>Encrypt Backup Files</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Encrypt during backup</span>
mysqldump -u root -p database | gpg --encrypt -r backup@company.com &gt; backup.sql.gpg

<span class="hljs-comment"># Decrypt during restore</span>
gpg --decrypt backup.sql.gpg | mysql -u root -p database
</div></code></pre>
</li>
<li>
<p><strong>Secure Backup Storage</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Set proper permissions</span>
chmod 600 backup.sql
chown backup:backup backup.sql

<span class="hljs-comment"># Use secure transfer protocols</span>
scp backup.sql backup-server:/secure/location/
</div></code></pre>
</li>
<li>
<p><strong>Backup User Privileges</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">-- Create dedicated backup user with minimal privileges</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'backup_user'</span>@<span class="hljs-string">'localhost'</span> <span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'secure_password'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, <span class="hljs-keyword">LOCK</span> <span class="hljs-keyword">TABLES</span>, <span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">VIEW</span>, <span class="hljs-keyword">EVENT</span>, <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">ON</span> *.* <span class="hljs-keyword">TO</span> <span class="hljs-string">'backup_user'</span>@<span class="hljs-string">'localhost'</span>;
</div></code></pre>
</li>
</ol>
<hr>
<h2 id="%F0%9F%94%97-next-steps">ğŸ”— Next Steps</h2>
<p>ğŸ‰ <strong>Congratulations!</strong> You've now completed the comprehensive SQL learning path covering all essential database topics!</p>
<h3 id="%F0%9F%9A%80-youve-mastered">ğŸš€ You've Mastered:</h3>
<ul>
<li><strong>Database Fundamentals</strong> (RDBMS, ACID properties)</li>
<li><strong>Core SQL Operations</strong> (CRUD, joins, subqueries)</li>
<li><strong>Advanced Analytics</strong> (Window functions, CTEs)</li>
<li><strong>Performance Optimization</strong> (Indexes, query tuning)</li>
<li><strong>Database Programming</strong> (Stored procedures, triggers)</li>
<li><strong>Enterprise Features</strong> (Transactions, security, user management)</li>
<li><strong>Backup and Recovery</strong> (Disaster recovery, high availability)</li>
</ul>
<h3 id="%F0%9F%8E%AF-whats-next">ğŸ¯ What's Next?</h3>
<ul>
<li><strong>Practice Projects</strong>: Build real-world applications using your SQL skills</li>
<li><strong>Specialization</strong>: Choose MySQL or PostgreSQL for deeper expertise</li>
<li><strong>Integration</strong>: Learn how SQL works with programming languages (Python, Node.js, etc.)</li>
<li><strong>Advanced Topics</strong>: Explore database administration, replication, and cloud databases</li>
<li><strong>Certification</strong>: Consider MySQL or PostgreSQL certification exams</li>
</ul>
<h3 id="%F0%9F%93%9A-continue-learning">ğŸ“š Continue Learning:</h3>
<ul>
<li>Check out other branches in this repository (JavaScript, React, etc.)</li>
<li>Build full-stack applications combining SQL with web technologies</li>
<li>Explore NoSQL databases for comparison and broader database knowledge</li>
<li>Learn about database DevOps and infrastructure as code</li>
</ul>
<p><strong>You're now ready to work as a confident database professional!</strong> ğŸŠ</p>
<hr>
<p><em>This completes the comprehensive SQL learning journey. You now have the knowledge and skills to design, implement, optimize, and maintain production database systems.</em></p>
<h1 id="chapter-18-database-replication--high-availability">Chapter 18: Database Replication &amp; High Availability</h1>
<h2 id="%F0%9F%93%9A-what-youll-learn">ğŸ“š What You'll Learn</h2>
<p>Database replication and high availability are critical for production systems that require minimal downtime and data protection. This chapter covers master-slave replication, clustering, failover strategies, and load balancing for both MySQL and PostgreSQL.</p>
<hr>
<h2 id="%F0%9F%8E%AF-learning-objectives">ğŸ¯ Learning Objectives</h2>
<ul>
<li><strong>Master-Slave Replication</strong>: Understand primary-replica architecture</li>
<li><strong>Master-Master Replication</strong>: Bidirectional data synchronization</li>
<li><strong>Read Replicas</strong>: Scale read operations across multiple servers</li>
<li><strong>Failover Strategies</strong>: Automatic and manual failover procedures</li>
<li><strong>Load Balancing</strong>: Distribute database load effectively</li>
<li><strong>Monitoring</strong>: Track replication lag and health</li>
<li><strong>Conflict Resolution</strong>: Handle replication conflicts</li>
</ul>
<hr>
<h2 id="%F0%9F%93%96-concept-explanation">ğŸ“– Concept Explanation</h2>
<h3 id="what-is-database-replication">What is Database Replication?</h3>
<p><strong>Database replication</strong> is the process of copying and maintaining database objects in multiple database instances. It ensures data availability, improves performance, and provides disaster recovery capabilities.</p>
<h3 id="master-slave-vs-master-master">Master-Slave vs Master-Master</h3>
<p><strong>Master-Slave (Primary-Replica)</strong>:</p>
<ul>
<li>One primary server handles writes</li>
<li>Multiple replica servers handle reads</li>
<li>Unidirectional data flow</li>
<li>Simpler to manage, less conflict potential</li>
</ul>
<p><strong>Master-Master (Multi-Master)</strong>:</p>
<ul>
<li>Multiple servers can handle writes</li>
<li>Bidirectional data synchronization</li>
<li>More complex, requires conflict resolution</li>
<li>Higher availability but increased complexity</li>
</ul>
<hr>
<h2 id="%F0%9F%94%A7-mysql-replication">ğŸ”§ MySQL Replication</h2>
<h3 id="setting-up-master-slave-replication">Setting Up Master-Slave Replication</h3>
<h4 id="1-configure-master-server">1. Configure Master Server</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Edit /etc/mysql/mysql.conf.d/mysqld.cnf</span>
[mysqld]
server-id = 1
log-bin = mysql-bin
binlog-format = ROW
binlog-<span class="hljs-keyword">do</span>-db = production_db

<span class="hljs-comment">-- Restart MySQL service</span>
<span class="hljs-comment">-- sudo systemctl restart mysql</span>
</div></code></pre>
<h4 id="2-create-replication-user">2. Create Replication User</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- On Master server</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'replication_user'</span>@<span class="hljs-string">'%'</span>
<span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'strong_password'</span>;

<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">REPLICATION</span> <span class="hljs-keyword">SLAVE</span> <span class="hljs-keyword">ON</span> *.*
<span class="hljs-keyword">TO</span> <span class="hljs-string">'replication_user'</span>@<span class="hljs-string">'%'</span>;

<span class="hljs-keyword">FLUSH</span> <span class="hljs-keyword">PRIVILEGES</span>;

<span class="hljs-comment">-- Get master status</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">MASTER</span> <span class="hljs-keyword">STATUS</span>;
<span class="hljs-comment">-- <span class="hljs-doctag">Note:</span> File and Position values</span>
</div></code></pre>
<h4 id="3-configure-slave-server">3. Configure Slave Server</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Edit /etc/mysql/mysql.conf.d/mysqld.cnf</span>
[mysqld]
server-id = 2
relay-log = relay-bin
log-slave-updates = 1
read-only = 1

<span class="hljs-comment">-- Restart MySQL service</span>
</div></code></pre>
<h4 id="4-start-replication">4. Start Replication</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- On Slave server</span>
<span class="hljs-keyword">CHANGE</span> <span class="hljs-keyword">MASTER</span> <span class="hljs-keyword">TO</span>
  MASTER_HOST = <span class="hljs-string">'192.168.1.100'</span>,
  MASTER_USER = <span class="hljs-string">'replication_user'</span>,
  MASTER_PASSWORD = <span class="hljs-string">'strong_password'</span>,
  MASTER_LOG_FILE = <span class="hljs-string">'mysql-bin.000001'</span>,
  MASTER_LOG_POS = <span class="hljs-number">154</span>;

<span class="hljs-keyword">START</span> <span class="hljs-keyword">SLAVE</span>;

<span class="hljs-comment">-- Check replication status</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">SLAVE</span> <span class="hljs-keyword">STATUS</span>\G
</div></code></pre>
<h3 id="mysql-group-replication-master-master">MySQL Group Replication (Master-Master)</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Install Group Replication plugin</span>
<span class="hljs-keyword">INSTALL</span> <span class="hljs-keyword">PLUGIN</span> group_replication <span class="hljs-keyword">SONAME</span> <span class="hljs-string">'group_replication.so'</span>;

<span class="hljs-comment">-- Configure group replication</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> group_replication_group_name = <span class="hljs-string">'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa'</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> group_replication_start_on_boot = <span class="hljs-keyword">OFF</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> group_replication_local_address = <span class="hljs-string">'192.168.1.100:33061'</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> group_replication_group_seeds = <span class="hljs-string">'192.168.1.100:33061,192.168.1.101:33061'</span>;

<span class="hljs-comment">-- Start group replication</span>
<span class="hljs-keyword">START</span> GROUP_REPLICATION;
</div></code></pre>
<hr>
<h2 id="%F0%9F%90%98-postgresql-replication">ğŸ˜ PostgreSQL Replication</h2>
<h3 id="setting-up-streaming-replication">Setting Up Streaming Replication</h3>
<h4 id="1-configure-primary-server">1. Configure Primary Server</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Edit postgresql.conf</span>
wal_level = replica
max_wal_senders = 3
max_replication_slots = 3
archive_mode = on
archive_command = 'cp %p /var/lib/postgresql/archive/%f'

<span class="hljs-comment">-- Edit pg_hba.conf</span>
host replication replication_user 192.168.1.0/24 md5
</div></code></pre>
<h4 id="2-create-replication-user">2. Create Replication User</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- On Primary server</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> replication_user <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">REPLICATION</span> <span class="hljs-keyword">PASSWORD</span> <span class="hljs-string">'strong_password'</span>;

<span class="hljs-comment">-- Create replication slot</span>
<span class="hljs-keyword">SELECT</span> pg_create_physical_replication_slot(<span class="hljs-string">'replica_slot'</span>);
</div></code></pre>
<h4 id="3-set-up-standby-server">3. Set Up Standby Server</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Stop PostgreSQL on standby</span>
sudo systemctl stop postgresql

<span class="hljs-comment"># Remove existing data directory</span>
sudo rm -rf /var/lib/postgresql/13/main/*

<span class="hljs-comment"># Create base backup</span>
sudo -u postgres pg_basebackup -h 192.168.1.100 -D /var/lib/postgresql/13/main -U replication_user -P -W -R

<span class="hljs-comment"># Start PostgreSQL</span>
sudo systemctl start postgresql
</div></code></pre>
<h4 id="4-configure-standby">4. Configure Standby</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- standby.signal file is created automatically by pg_basebackup -R</span>
<span class="hljs-comment">-- Edit postgresql.conf on standby</span>
primary_conninfo = 'host=192.168.1.100 port=5432 user=replication_user password=strong_password'
primary_slot_name = 'replica_slot'
hot_standby = on
</div></code></pre>
<h3 id="postgresql-logical-replication">PostgreSQL Logical Replication</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- On Publisher (Primary)</span>
<span class="hljs-keyword">CREATE</span> PUBLICATION my_publication <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">TABLES</span>;

<span class="hljs-comment">-- On Subscriber (Replica)</span>
<span class="hljs-keyword">CREATE</span> SUBSCRIPTION my_subscription
<span class="hljs-keyword">CONNECTION</span> <span class="hljs-string">'host=192.168.1.100 dbname=mydb user=replication_user password=strong_password'</span>
PUBLICATION my_publication;

<span class="hljs-comment">-- Monitor replication</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pg_stat_replication;
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pg_stat_subscription;
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%84-failover-strategies">ğŸ”„ Failover Strategies</h2>
<h3 id="automatic-failover-with-mysql">Automatic Failover with MySQL</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Using MySQL Router for automatic failover</span>
mysqlrouter --bootstrap root@mysql-cluster --user=mysqlrouter

<span class="hljs-comment"># Start MySQL Router</span>
mysqlrouter &amp;

<span class="hljs-comment"># Application connects to router port (6446 for read-write, 6447 for read-only)</span>
</div></code></pre>
<h3 id="postgresql-automatic-failover">PostgreSQL Automatic Failover</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Using Patroni for automatic failover</span>
<span class="hljs-comment"># Install Patroni</span>
pip install patroni[etcd]

<span class="hljs-comment"># Configure patroni.yml</span>
scope: postgres-cluster
namespace: /db/
name: node1

restapi:
  listen: 0.0.0.0:8008
  connect_address: 192.168.1.100:8008

etcd:
  hosts: 192.168.1.100:2379,192.168.1.101:2379

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 30
    maximum_lag_on_failover: 1048576

postgresql:
  listen: 0.0.0.0:5432
  connect_address: 192.168.1.100:5432
  data_dir: /var/lib/postgresql/13/main
  bin_dir: /usr/lib/postgresql/13/bin
</div></code></pre>
<hr>
<h2 id="%E2%9A%96%EF%B8%8F-load-balancing">âš–ï¸ Load Balancing</h2>
<h3 id="haproxy-configuration">HAProxy Configuration</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># /etc/haproxy/haproxy.cfg</span>
global
    daemon
    maxconn 4096

defaults
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

<span class="hljs-comment"># MySQL Load Balancing</span>
listen mysql-cluster
    <span class="hljs-built_in">bind</span> *:3306
    mode tcp
    balance roundrobin
    option mysql-check user haproxy_check
    server mysql1 192.168.1.100:3306 check
    server mysql2 192.168.1.101:3306 check backup

<span class="hljs-comment"># PostgreSQL Load Balancing</span>
listen postgres-cluster
    <span class="hljs-built_in">bind</span> *:5432
    mode tcp
    balance roundrobin
    option pgsql-check user haproxy_check
    server postgres1 192.168.1.100:5432 check
    server postgres2 192.168.1.101:5432 check backup
</div></code></pre>
<h3 id="application-level-load-balancing">Application-Level Load Balancing</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Python example with read/write splitting</span>
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseRouter</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.write_engine = create_engine(<span class="hljs-string">'mysql://user:pass@master:3306/db'</span>)
        self.read_engines = [
            create_engine(<span class="hljs-string">'mysql://user:pass@slave1:3306/db'</span>),
            create_engine(<span class="hljs-string">'mysql://user:pass@slave2:3306/db'</span>)
        ]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_write_connection</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-keyword">return</span> self.write_engine.connect()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_read_connection</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-keyword">return</span> random.choice(self.read_engines).connect()

<span class="hljs-comment"># Usage</span>
db_router = DatabaseRouter()

<span class="hljs-comment"># For writes</span>
<span class="hljs-keyword">with</span> db_router.get_write_connection() <span class="hljs-keyword">as</span> conn:
    conn.execute(<span class="hljs-string">"INSERT INTO users (name) VALUES ('John')"</span>)

<span class="hljs-comment"># For reads</span>
<span class="hljs-keyword">with</span> db_router.get_read_connection() <span class="hljs-keyword">as</span> conn:
    result = conn.execute(<span class="hljs-string">"SELECT * FROM users"</span>)
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%8A-monitoring-replication">ğŸ“Š Monitoring Replication</h2>
<h3 id="mysql-monitoring">MySQL Monitoring</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Check master status</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">MASTER</span> <span class="hljs-keyword">STATUS</span>;

<span class="hljs-comment">-- Check slave status</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">SLAVE</span> <span class="hljs-keyword">STATUS</span>\G

<span class="hljs-comment">-- Monitor replication lag</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> Slave_lag_seconds <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'No Delay'</span>
        <span class="hljs-keyword">WHEN</span> Slave_lag_seconds = <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'No Delay'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-keyword">CONCAT</span>(Slave_lag_seconds, <span class="hljs-string">' seconds'</span>)
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> replication_delay
<span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span>
        <span class="hljs-keyword">CASE</span>
            <span class="hljs-keyword">WHEN</span> Seconds_Behind_Master <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span> <span class="hljs-literal">NULL</span>
            <span class="hljs-keyword">ELSE</span> Seconds_Behind_Master
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> Slave_lag_seconds
    <span class="hljs-keyword">FROM</span> INFORMATION_SCHEMA.REPLICA_HOST_STATUS
) <span class="hljs-keyword">AS</span> lag_info;

<span class="hljs-comment">-- Check binary log status</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-built_in">BINARY</span> <span class="hljs-keyword">LOGS</span>;
</div></code></pre>
<h3 id="postgresql-monitoring">PostgreSQL Monitoring</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Check replication status on primary</span>
<span class="hljs-keyword">SELECT</span>
    client_addr,
    state,
    sent_lsn,
    write_lsn,
    flush_lsn,
    replay_lsn,
    write_lag,
    flush_lag,
    replay_lag
<span class="hljs-keyword">FROM</span> pg_stat_replication;

<span class="hljs-comment">-- Check replication status on standby</span>
<span class="hljs-keyword">SELECT</span>
    pg_is_in_recovery() <span class="hljs-keyword">AS</span> is_standby,
    pg_last_wal_receive_lsn() <span class="hljs-keyword">AS</span> last_received,
    pg_last_wal_replay_lsn() <span class="hljs-keyword">AS</span> last_replayed,
    pg_last_xact_replay_timestamp() <span class="hljs-keyword">AS</span> last_replay_time;

<span class="hljs-comment">-- Calculate replication lag</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">EXTRACT</span>(EPOCH <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">now</span>() - pg_last_xact_replay_timestamp())) <span class="hljs-keyword">AS</span> lag_seconds;
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%A8-conflict-resolution">ğŸš¨ Conflict Resolution</h2>
<h3 id="mysql-conflict-resolution">MySQL Conflict Resolution</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Skip replication errors (use carefully)</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> sql_slave_skip_counter = <span class="hljs-number">1</span>;
<span class="hljs-keyword">START</span> <span class="hljs-keyword">SLAVE</span>;

<span class="hljs-comment">-- Or set slave to ignore specific errors</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> slave_skip_errors = <span class="hljs-string">'1062,1053'</span>;

<span class="hljs-comment">-- Check for duplicate key errors</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">SLAVE</span> <span class="hljs-keyword">STATUS</span>\G
<span class="hljs-comment">-- Look for Last_SQL_Error field</span>
</div></code></pre>
<h3 id="postgresql-conflict-resolution">PostgreSQL Conflict Resolution</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Monitor conflicts</span>
<span class="hljs-keyword">SELECT</span>
    datname,
    confl_tablespace,
    confl_lock,
    confl_snapshot,
    confl_bufferpin,
    confl_deadlock
<span class="hljs-keyword">FROM</span> pg_stat_database_conflicts;

<span class="hljs-comment">-- Handle logical replication conflicts</span>
<span class="hljs-keyword">SELECT</span>
    subname,
    received_lsn,
    latest_end_lsn,
    latest_end_time
<span class="hljs-keyword">FROM</span> pg_stat_subscription;

<span class="hljs-comment">-- Resolve conflicts by dropping and recreating subscription</span>
<span class="hljs-keyword">DROP</span> SUBSCRIPTION my_subscription;
<span class="hljs-keyword">CREATE</span> SUBSCRIPTION my_subscription
<span class="hljs-keyword">CONNECTION</span> <span class="hljs-string">'host=primary dbname=mydb user=replication_user'</span>
PUBLICATION my_publication;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8F%97%EF%B8%8F-real-world-example-e-commerce-high-availability">ğŸ—ï¸ Real-World Example: E-commerce High Availability</h2>
<h3 id="architecture-setup">Architecture Setup</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Master database (writes)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> ecommerce_master;
<span class="hljs-keyword">USE</span> ecommerce_master;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span> AUTO_INCREMENT,
    user_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    total_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    <span class="hljs-keyword">status</span> ENUM(<span class="hljs-string">'pending'</span>, <span class="hljs-string">'processing'</span>, <span class="hljs-string">'shipped'</span>, <span class="hljs-string">'delivered'</span>),
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    updated_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> order_items (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span> AUTO_INCREMENT,
    order_id <span class="hljs-built_in">INT</span>,
    product_id <span class="hljs-built_in">INT</span>,
    quantity <span class="hljs-built_in">INT</span>,
    price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (order_id) <span class="hljs-keyword">REFERENCES</span> orders(<span class="hljs-keyword">id</span>)
);

<span class="hljs-comment">-- Read replica optimization</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_orders_user_created <span class="hljs-keyword">ON</span> orders(user_id, created_at);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_orders_status <span class="hljs-keyword">ON</span> orders(<span class="hljs-keyword">status</span>);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_order_items_order <span class="hljs-keyword">ON</span> order_items(order_id);
</div></code></pre>
<h3 id="application-implementation">Application Implementation</h3>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EcommerceDatabase</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.master = create_engine(<span class="hljs-string">'mysql://user:pass@master:3306/ecommerce'</span>)
        self.slaves = [
            create_engine(<span class="hljs-string">'mysql://user:pass@slave1:3306/ecommerce'</span>),
            create_engine(<span class="hljs-string">'mysql://user:pass@slave2:3306/ecommerce'</span>)
        ]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_order</span><span class="hljs-params">(self, user_id, items)</span>:</span>
        <span class="hljs-string">"""Write operation - use master"""</span>
        <span class="hljs-keyword">with</span> self.master.connect() <span class="hljs-keyword">as</span> conn:
            <span class="hljs-keyword">with</span> conn.begin():
                <span class="hljs-comment"># Insert order</span>
                result = conn.execute(
                    <span class="hljs-string">"INSERT INTO orders (user_id, total_amount, status) VALUES (%s, %s, 'pending')"</span>,
                    (user_id, sum(item[<span class="hljs-string">'price'</span>] * item[<span class="hljs-string">'quantity'</span>] <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> items))
                )
                order_id = result.lastrowid

                <span class="hljs-comment"># Insert order items</span>
                <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> items:
                    conn.execute(
                        <span class="hljs-string">"INSERT INTO order_items (order_id, product_id, quantity, price) VALUES (%s, %s, %s, %s)"</span>,
                        (order_id, item[<span class="hljs-string">'product_id'</span>], item[<span class="hljs-string">'quantity'</span>], item[<span class="hljs-string">'price'</span>])
                    )

                <span class="hljs-keyword">return</span> order_id

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_user_orders</span><span class="hljs-params">(self, user_id)</span>:</span>
        <span class="hljs-string">"""Read operation - use slave"""</span>
        slave = random.choice(self.slaves)
        <span class="hljs-keyword">with</span> slave.connect() <span class="hljs-keyword">as</span> conn:
            <span class="hljs-keyword">return</span> conn.execute(
                <span class="hljs-string">"SELECT * FROM orders WHERE user_id = %s ORDER BY created_at DESC"</span>,
                (user_id,)
            ).fetchall()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_order_analytics</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Heavy read operation - use dedicated analytics slave"""</span>
        <span class="hljs-keyword">with</span> self.slaves[<span class="hljs-number">1</span>].connect() <span class="hljs-keyword">as</span> conn:  <span class="hljs-comment"># Dedicated analytics slave</span>
            <span class="hljs-keyword">return</span> conn.execute(<span class="hljs-string">"""
                SELECT
                    DATE(created_at) as order_date,
                    COUNT(*) as total_orders,
                    SUM(total_amount) as total_revenue,
                    AVG(total_amount) as avg_order_value
                FROM orders
                WHERE created_at &gt;= DATE_SUB(NOW(), INTERVAL 30 DAY)
                GROUP BY DATE(created_at)
                ORDER BY order_date DESC
            """</span>).fetchall()
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-interview-questions">ğŸ¯ Interview Questions</h2>
<h3 id="basic-questions">Basic Questions</h3>
<ol>
<li><strong>What is the difference between master-slave and master-master replication?</strong></li>
<li><strong>How do you handle replication lag?</strong></li>
<li><strong>What are the benefits of read replicas?</strong></li>
</ol>
<h3 id="intermediate-questions">Intermediate Questions</h3>
<ol>
<li><strong>How would you implement automatic failover?</strong></li>
<li><strong>What strategies would you use for conflict resolution in multi-master setup?</strong></li>
<li><strong>How do you monitor replication health?</strong></li>
</ol>
<h3 id="advanced-questions">Advanced Questions</h3>
<ol>
<li><strong>Design a high-availability architecture for a global e-commerce platform</strong></li>
<li><strong>How would you handle split-brain scenarios in database clustering?</strong></li>
<li><strong>What are the trade-offs between synchronous and asynchronous replication?</strong></li>
</ol>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-common-pitfalls">âš ï¸ Common Pitfalls</h2>
<h3 id="1-replication-lag-issues">1. <strong>Replication Lag Issues</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Reading immediately after write from replica</span>
<span class="hljs-comment">-- Solution: Use master for critical reads or implement read-after-write consistency</span>

<span class="hljs-comment">-- Check lag before critical reads</span>
<span class="hljs-keyword">SELECT</span> Seconds_Behind_Master <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">SLAVE</span> <span class="hljs-keyword">STATUS</span>;
</div></code></pre>
<h3 id="2-split-brain-scenarios">2. <strong>Split-Brain Scenarios</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Problem: Multiple masters in failover</span>
<span class="hljs-comment"># Solution: Use proper quorum and fencing</span>

<span class="hljs-comment"># Implement proper fencing in cluster configuration</span>
STONITH_enabled = <span class="hljs-literal">true</span>
no_quorum_policy = stop
</div></code></pre>
<h3 id="3-inadequate-monitoring">3. <strong>Inadequate Monitoring</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Not monitoring replication health</span>
<span class="hljs-comment">-- Solution: Implement comprehensive monitoring</span>

<span class="hljs-comment">-- Create monitoring queries</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> replication_health <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-string">'MySQL'</span> <span class="hljs-keyword">as</span> db_type,
    Slave_IO_Running,
    Slave_SQL_Running,
    Seconds_Behind_Master,
    Last_Error
<span class="hljs-keyword">FROM</span> <span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">SLAVE</span> <span class="hljs-keyword">STATUS</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-next-steps">ğŸ¯ Next Steps</h2>
<p>Congratulations! You've mastered database replication and high availability. You now understand:</p>
<p>âœ… <strong>Master-slave and master-master replication</strong><br>
âœ… <strong>Failover strategies and automation</strong><br>
âœ… <strong>Load balancing and read scaling</strong><br>
âœ… <strong>Monitoring and conflict resolution</strong><br>
âœ… <strong>Production-ready high availability architectures</strong></p>
<p><strong>Continue to</strong> â†’ <a href="./19-database-proxies-connection-pooling.md">Chapter 19: Database Proxies &amp; Connection Pooling</a></p>
<hr>
<p><em>You're now equipped to design and manage highly available database systems that can handle enterprise-scale workloads!</em> ğŸš€</p>
<h1 id="chapter-19-database-proxies--connection-pooling">Chapter 19: Database Proxies &amp; Connection Pooling</h1>
<h2 id="%F0%9F%93%9A-what-youll-learn">ğŸ“š What You'll Learn</h2>
<p>Database proxies and connection pooling are essential for scalable applications. This chapter covers proxy databases, connection management, load balancing, query routing, and performance optimization for both MySQL and PostgreSQL.</p>
<hr>
<h2 id="%F0%9F%8E%AF-learning-objectives">ğŸ¯ Learning Objectives</h2>
<ul>
<li><strong>Database Proxies</strong>: Understand proxy architecture and benefits</li>
<li><strong>Connection Pooling</strong>: Manage database connections efficiently</li>
<li><strong>Query Routing</strong>: Route queries based on type and load</li>
<li><strong>Load Balancing</strong>: Distribute database load across multiple servers</li>
<li><strong>Caching</strong>: Implement query result caching</li>
<li><strong>Monitoring</strong>: Track proxy performance and health</li>
<li><strong>Security</strong>: Secure proxy configurations and access control</li>
</ul>
<hr>
<h2 id="%F0%9F%93%96-concept-explanation">ğŸ“– Concept Explanation</h2>
<h3 id="what-is-a-database-proxy">What is a Database Proxy?</h3>
<p><strong>Database proxy</strong> is a middleware layer that sits between applications and database servers. It acts as an intermediary, providing:</p>
<ul>
<li><strong>Connection pooling</strong>: Reuse database connections</li>
<li><strong>Load balancing</strong>: Distribute queries across multiple databases</li>
<li><strong>Query routing</strong>: Direct queries to appropriate servers</li>
<li><strong>Caching</strong>: Store frequently accessed data</li>
<li><strong>Security</strong>: Centralized access control and monitoring</li>
<li><strong>Failover</strong>: Automatic switching to healthy servers</li>
</ul>
<h3 id="proxy-vs-direct-connection">Proxy vs Direct Connection</h3>
<p><strong>Direct Connection</strong>:</p>
<pre class="hljs"><code><div>Application â†’ Database Server
</div></code></pre>
<p><strong>Proxy Architecture</strong>:</p>
<pre class="hljs"><code><div>Application â†’ Database Proxy â†’ Database Server(s)
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%A7-mysql-proxy-solutions">ğŸ”§ MySQL Proxy Solutions</h2>
<h3 id="mysql-router">MySQL Router</h3>
<h4 id="installation-and-setup">Installation and Setup</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Install MySQL Router</span>
sudo apt-get install mysql-router

<span class="hljs-comment"># Bootstrap router for InnoDB Cluster</span>
mysqlrouter --bootstrap root@mysql-cluster --user=mysqlrouter

<span class="hljs-comment"># Start MySQL Router</span>
sudo systemctl start mysqlrouter
sudo systemctl <span class="hljs-built_in">enable</span> mysqlrouter
</div></code></pre>
<h4 id="configuration">Configuration</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># /etc/mysqlrouter/mysqlrouter.conf</span>
<span class="hljs-section">[DEFAULT]</span>
<span class="hljs-attr">logging_folder</span> = /var/log/mysqlrouter
<span class="hljs-attr">runtime_folder</span> = /var/run/mysqlrouter
<span class="hljs-attr">config_folder</span> = /etc/mysqlrouter

<span class="hljs-section">[logger]</span>
<span class="hljs-attr">level</span> = INFO

<span class="hljs-comment"># Read-Write connections</span>
<span class="hljs-section">[routing:primary]</span>
<span class="hljs-attr">bind_address</span> = <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>
<span class="hljs-attr">bind_port</span> = <span class="hljs-number">6446</span>
<span class="hljs-attr">destinations</span> = <span class="hljs-number">192.168</span>.<span class="hljs-number">1.100</span>:<span class="hljs-number">3306</span>,<span class="hljs-number">192.168</span>.<span class="hljs-number">1.101</span>:<span class="hljs-number">3306</span>
<span class="hljs-attr">routing_strategy</span> = first-available
<span class="hljs-attr">mode</span> = read-write

<span class="hljs-comment"># Read-Only connections</span>
<span class="hljs-section">[routing:secondary]</span>
<span class="hljs-attr">bind_address</span> = <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>
<span class="hljs-attr">bind_port</span> = <span class="hljs-number">6447</span>
<span class="hljs-attr">destinations</span> = <span class="hljs-number">192.168</span>.<span class="hljs-number">1.102</span>:<span class="hljs-number">3306</span>,<span class="hljs-number">192.168</span>.<span class="hljs-number">1.103</span>:<span class="hljs-number">3306</span>
<span class="hljs-attr">routing_strategy</span> = round-robin
<span class="hljs-attr">mode</span> = read-<span class="hljs-literal">on</span>ly

<span class="hljs-comment"># Connection pooling</span>
<span class="hljs-section">[connection_pool]</span>
<span class="hljs-attr">max_connections</span> = <span class="hljs-number">1000</span>
<span class="hljs-attr">max_idle_connections</span> = <span class="hljs-number">100</span>
<span class="hljs-attr">max_idle_time</span> = <span class="hljs-number">3600</span>
</div></code></pre>
<h3 id="proxysql">ProxySQL</h3>
<h4 id="installation">Installation</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Install ProxySQL</span>
wget https://github.com/sysown/proxysql/releases/download/v2.4.4/proxysql_2.4.4-ubuntu20_amd64.deb
sudo dpkg -i proxysql_2.4.4-ubuntu20_amd64.deb

<span class="hljs-comment"># Start ProxySQL</span>
sudo systemctl start proxysql
sudo systemctl <span class="hljs-built_in">enable</span> proxysql
</div></code></pre>
<h4 id="configuration">Configuration</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Connect to ProxySQL admin interface</span>
mysql -u admin -padmin -h 127.0.0.1 -P6032

<span class="hljs-comment">-- Add MySQL servers</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> mysql_servers(hostgroup_id, hostname, port, weight) <span class="hljs-keyword">VALUES</span>
(<span class="hljs-number">0</span>, <span class="hljs-string">'192.168.1.100'</span>, <span class="hljs-number">3306</span>, <span class="hljs-number">1000</span>),  <span class="hljs-comment">-- Master</span>
(<span class="hljs-number">1</span>, <span class="hljs-string">'192.168.1.101'</span>, <span class="hljs-number">3306</span>, <span class="hljs-number">900</span>),   <span class="hljs-comment">-- Slave 1</span>
(<span class="hljs-number">1</span>, <span class="hljs-string">'192.168.1.102'</span>, <span class="hljs-number">3306</span>, <span class="hljs-number">900</span>);   <span class="hljs-comment">-- Slave 2</span>

<span class="hljs-comment">-- Load servers to runtime</span>
<span class="hljs-keyword">LOAD</span> MYSQL SERVERS <span class="hljs-keyword">TO</span> RUNTIME;
SAVE MYSQL SERVERS TO DISK;

<span class="hljs-comment">-- Add users</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> mysql_users(username, <span class="hljs-keyword">password</span>, default_hostgroup) <span class="hljs-keyword">VALUES</span>
(<span class="hljs-string">'app_user'</span>, <span class="hljs-string">'password123'</span>, <span class="hljs-number">0</span>);

<span class="hljs-keyword">LOAD</span> MYSQL <span class="hljs-keyword">USERS</span> <span class="hljs-keyword">TO</span> RUNTIME;
SAVE MYSQL USERS TO DISK;

<span class="hljs-comment">-- Configure query routing rules</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> mysql_query_rules(rule_id, active, match_pattern, destination_hostgroup, <span class="hljs-keyword">apply</span>) <span class="hljs-keyword">VALUES</span>
(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'^SELECT.*'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>),  <span class="hljs-comment">-- Route SELECT to read replicas</span>
(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'^INSERT.*'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),  <span class="hljs-comment">-- Route INSERT to master</span>
(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'^UPDATE.*'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),  <span class="hljs-comment">-- Route UPDATE to master</span>
(<span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'^DELETE.*'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);  <span class="hljs-comment">-- Route DELETE to master</span>

<span class="hljs-keyword">LOAD</span> MYSQL <span class="hljs-keyword">QUERY</span> <span class="hljs-keyword">RULES</span> <span class="hljs-keyword">TO</span> RUNTIME;
SAVE MYSQL QUERY RULES TO DISK;

<span class="hljs-comment">-- Configure connection pooling</span>
<span class="hljs-keyword">SET</span> mysql-max_connections=<span class="hljs-number">2000</span>;
<span class="hljs-keyword">SET</span> mysql-default_query_timeout=<span class="hljs-number">3600000</span>;
<span class="hljs-keyword">SET</span> mysql-have_compress=<span class="hljs-literal">true</span>;
<span class="hljs-keyword">SET</span> mysql-poll_timeout=<span class="hljs-number">2000</span>;

<span class="hljs-keyword">LOAD</span> MYSQL <span class="hljs-keyword">VARIABLES</span> <span class="hljs-keyword">TO</span> RUNTIME;
SAVE MYSQL VARIABLES TO DISK;
</div></code></pre>
<hr>
<h2 id="%F0%9F%90%98-postgresql-proxy-solutions">ğŸ˜ PostgreSQL Proxy Solutions</h2>
<h3 id="pgbouncer">PgBouncer</h3>
<h4 id="installation">Installation</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Install PgBouncer</span>
sudo apt-get install pgbouncer

<span class="hljs-comment"># Create configuration directory</span>
sudo mkdir -p /etc/pgbouncer
</div></code></pre>
<h4 id="configuration">Configuration</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># /etc/pgbouncer/pgbouncer.ini</span>
<span class="hljs-section">[databases]</span>
<span class="hljs-attr">mydb</span> = host=<span class="hljs-number">192.168</span>.<span class="hljs-number">1.100</span> port=<span class="hljs-number">5432</span> dbname=production_db
<span class="hljs-attr">mydb_ro</span> = host=<span class="hljs-number">192.168</span>.<span class="hljs-number">1.101</span> port=<span class="hljs-number">5432</span> dbname=production_db

<span class="hljs-section">[pgbouncer]</span>
<span class="hljs-attr">listen_port</span> = <span class="hljs-number">6432</span>
<span class="hljs-attr">listen_addr</span> = *
<span class="hljs-attr">auth_type</span> = md5
<span class="hljs-attr">auth_file</span> = /etc/pgbouncer/userlist.txt
<span class="hljs-attr">logfile</span> = /var/log/pgbouncer/pgbouncer.log
<span class="hljs-attr">pidfile</span> = /var/run/pgbouncer/pgbouncer.pid

<span class="hljs-comment"># Connection pooling settings</span>
<span class="hljs-attr">pool_mode</span> = transaction
<span class="hljs-attr">max_client_conn</span> = <span class="hljs-number">1000</span>
<span class="hljs-attr">default_pool_size</span> = <span class="hljs-number">25</span>
<span class="hljs-attr">max_db_connections</span> = <span class="hljs-number">100</span>
<span class="hljs-attr">max_user_connections</span> = <span class="hljs-number">100</span>

<span class="hljs-comment"># Performance settings</span>
<span class="hljs-attr">server_reset_query</span> = DISCARD ALL
<span class="hljs-attr">server_check_query</span> = SELECT <span class="hljs-number">1</span>
<span class="hljs-attr">server_check_delay</span> = <span class="hljs-number">30</span>
<span class="hljs-attr">server_lifetime</span> = <span class="hljs-number">3600</span>
<span class="hljs-attr">server_idle_timeout</span> = <span class="hljs-number">600</span>

<span class="hljs-comment"># Security</span>
<span class="hljs-attr">ignore_startup_parameters</span> = extra_float_digits
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment"># /etc/pgbouncer/userlist.txt</span>
<span class="hljs-string">"app_user"</span> <span class="hljs-string">"md5d6a35858d61d85e4a82ab1fb044aba9d"</span>
<span class="hljs-string">"read_user"</span> <span class="hljs-string">"md5b6d767d2f8ed5d21a44b0e5886680cb9"</span>
</div></code></pre>
<h4 id="start-pgbouncer">Start PgBouncer</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Start PgBouncer</span>
sudo systemctl start pgbouncer
sudo systemctl <span class="hljs-built_in">enable</span> pgbouncer

<span class="hljs-comment"># Connect through PgBouncer</span>
psql -h localhost -p 6432 -U app_user mydb
</div></code></pre>
<h3 id="pgpool-ii">PgPool-II</h3>
<h4 id="installation">Installation</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Install PgPool-II</span>
sudo apt-get install pgpool2
</div></code></pre>
<h4 id="configuration">Configuration</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># /etc/pgpool2/pgpool.conf</span>

<span class="hljs-comment"># Connection settings</span>
listen_addresses = <span class="hljs-string">'*'</span>
port = 9999
pcp_listen_addresses = <span class="hljs-string">'*'</span>
pcp_port = 9898

<span class="hljs-comment"># Backend settings</span>
backend_hostname0 = <span class="hljs-string">'192.168.1.100'</span>
backend_port0 = 5432
backend_weight0 = 1
backend_data_directory0 = <span class="hljs-string">'/var/lib/postgresql/13/main'</span>
backend_flag0 = <span class="hljs-string">'ALLOW_TO_FAILOVER'</span>

backend_hostname1 = <span class="hljs-string">'192.168.1.101'</span>
backend_port1 = 5432
backend_weight1 = 1
backend_data_directory1 = <span class="hljs-string">'/var/lib/postgresql/13/main'</span>
backend_flag1 = <span class="hljs-string">'ALLOW_TO_FAILOVER'</span>

<span class="hljs-comment"># Load balancing</span>
load_balance_mode = on
ignore_leading_white_space = on
white_function_list = <span class="hljs-string">''</span>
black_function_list = <span class="hljs-string">'currval,lastval,nextval,setval'</span>

<span class="hljs-comment"># Connection pooling</span>
connection_cache = on
max_pool = 4
child_life_time = 300
child_max_connections = 0
connection_life_time = 0
client_idle_limit = 0

<span class="hljs-comment"># Failover</span>
failover_command = <span class="hljs-string">'/etc/pgpool2/failover.sh %d %h %p %D %m %H %M %P %r %R'</span>
failback_command = <span class="hljs-string">'/etc/pgpool2/failback.sh %d %h %p %D %m %H %M %P %r %R'</span>
fail_over_on_backend_error = on
search_primary_node_timeout = 10
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%84-connection-pooling-strategies">ğŸ”„ Connection Pooling Strategies</h2>
<h3 id="pool-modes">Pool Modes</h3>
<h4 id="1-session-pooling">1. Session Pooling</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Connection assigned for entire session</span>
<span class="hljs-comment">-- Best for: Applications with long-running transactions</span>
<span class="hljs-comment">-- Pros: Simple, maintains session state</span>
<span class="hljs-comment">-- Cons: Higher memory usage</span>

<span class="hljs-comment">-- PgBouncer configuration</span>
pool_mode = session
</div></code></pre>
<h4 id="2-transaction-pooling">2. Transaction Pooling</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Connection returned after each transaction</span>
<span class="hljs-comment">-- Best for: Web applications with short transactions</span>
<span class="hljs-comment">-- Pros: Better connection reuse</span>
<span class="hljs-comment">-- Cons: Cannot use session-level features</span>

<span class="hljs-comment">-- PgBouncer configuration</span>
pool_mode = transaction
</div></code></pre>
<h4 id="3-statement-pooling">3. Statement Pooling</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Connection returned after each statement</span>
<span class="hljs-comment">-- Best for: Simple query applications</span>
<span class="hljs-comment">-- Pros: Maximum connection reuse</span>
<span class="hljs-comment">-- Cons: Very limited functionality</span>

<span class="hljs-comment">-- PgBouncer configuration</span>
pool_mode = statement
</div></code></pre>
<h3 id="application-level-connection-pooling">Application-Level Connection Pooling</h3>
<h4 id="python-with-sqlalchemy">Python with SQLAlchemy</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine
<span class="hljs-keyword">from</span> sqlalchemy.pool <span class="hljs-keyword">import</span> QueuePool

<span class="hljs-comment"># Configure connection pool</span>
engine = create_engine(
    <span class="hljs-string">'postgresql://user:password@proxy:6432/mydb'</span>,
    poolclass=QueuePool,
    pool_size=<span class="hljs-number">20</span>,          <span class="hljs-comment"># Number of connections to maintain</span>
    max_overflow=<span class="hljs-number">30</span>,       <span class="hljs-comment"># Additional connections when needed</span>
    pool_pre_ping=<span class="hljs-literal">True</span>,    <span class="hljs-comment"># Validate connections before use</span>
    pool_recycle=<span class="hljs-number">3600</span>,     <span class="hljs-comment"># Recycle connections after 1 hour</span>
    echo=<span class="hljs-literal">False</span>
)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseManager</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.engine = engine

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">execute_query</span><span class="hljs-params">(self, query, params=None)</span>:</span>
        <span class="hljs-keyword">with</span> self.engine.connect() <span class="hljs-keyword">as</span> conn:
            <span class="hljs-keyword">return</span> conn.execute(query, params <span class="hljs-keyword">or</span> {})

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_pool_status</span><span class="hljs-params">(self)</span>:</span>
        pool = self.engine.pool
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'size'</span>: pool.size(),
            <span class="hljs-string">'checked_in'</span>: pool.checkedin(),
            <span class="hljs-string">'checked_out'</span>: pool.checkedout(),
            <span class="hljs-string">'overflow'</span>: pool.overflow(),
            <span class="hljs-string">'invalid'</span>: pool.invalid()
        }

<span class="hljs-comment"># Usage</span>
db = DatabaseManager()
result = db.execute_query(<span class="hljs-string">"SELECT * FROM users WHERE id = :id"</span>, {<span class="hljs-string">'id'</span>: <span class="hljs-number">123</span>})
print(<span class="hljs-string">f"Pool status: <span class="hljs-subst">{db.get_pool_status()}</span>"</span>)
</div></code></pre>
<h4 id="nodejs-with-pg-pool">Node.js with pg-pool</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> { Pool } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"pg"</span>);

<span class="hljs-comment">// Configure connection pool</span>
<span class="hljs-keyword">const</span> pool = <span class="hljs-keyword">new</span> Pool({
  <span class="hljs-attr">host</span>: <span class="hljs-string">"proxy-server"</span>,
  <span class="hljs-attr">port</span>: <span class="hljs-number">6432</span>,
  <span class="hljs-attr">database</span>: <span class="hljs-string">"mydb"</span>,
  <span class="hljs-attr">user</span>: <span class="hljs-string">"app_user"</span>,
  <span class="hljs-attr">password</span>: <span class="hljs-string">"password"</span>,
  <span class="hljs-attr">max</span>: <span class="hljs-number">20</span>, <span class="hljs-comment">// Maximum connections</span>
  <span class="hljs-attr">idleTimeoutMillis</span>: <span class="hljs-number">30000</span>, <span class="hljs-comment">// Close idle connections after 30s</span>
  <span class="hljs-attr">connectionTimeoutMillis</span>: <span class="hljs-number">2000</span>, <span class="hljs-comment">// Timeout when connecting</span>
  <span class="hljs-attr">maxUses</span>: <span class="hljs-number">7500</span>, <span class="hljs-comment">// Close connection after 7500 uses</span>
});

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseManager</span> </span>{
  <span class="hljs-keyword">async</span> executeQuery(query, params = []) {
    <span class="hljs-keyword">const</span> client = <span class="hljs-keyword">await</span> pool.connect();
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> client.query(query, params);
      <span class="hljs-keyword">return</span> result.rows;
    } <span class="hljs-keyword">finally</span> {
      client.release();
    }
  }

  getPoolStatus() {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">totalCount</span>: pool.totalCount,
      <span class="hljs-attr">idleCount</span>: pool.idleCount,
      <span class="hljs-attr">waitingCount</span>: pool.waitingCount,
    };
  }
}

<span class="hljs-comment">// Usage</span>
<span class="hljs-keyword">const</span> db = <span class="hljs-keyword">new</span> DatabaseManager();

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUser</span>(<span class="hljs-params">id</span>) </span>{
  <span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> db.executeQuery(<span class="hljs-string">"SELECT * FROM users WHERE id = $1"</span>, [
    id,
  ]);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Pool status:"</span>, db.getPoolStatus());
  <span class="hljs-keyword">return</span> users[<span class="hljs-number">0</span>];
}
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-query-routing-and-load-balancing">ğŸ¯ Query Routing and Load Balancing</h2>
<h3 id="readwrite-splitting">Read/Write Splitting</h3>
<h4 id="proxysql-query-routing">ProxySQL Query Routing</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Route based on query type</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> mysql_query_rules(rule_id, active, match_pattern, destination_hostgroup, <span class="hljs-keyword">apply</span>) <span class="hljs-keyword">VALUES</span>
(<span class="hljs-number">10</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'^SELECT.*FOR UPDATE'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),     <span class="hljs-comment">-- SELECT FOR UPDATE to master</span>
(<span class="hljs-number">20</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'^SELECT.*'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>),              <span class="hljs-comment">-- Regular SELECT to slaves</span>
(<span class="hljs-number">30</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'^INSERT.*'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),              <span class="hljs-comment">-- INSERT to master</span>
(<span class="hljs-number">40</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'^UPDATE.*'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),              <span class="hljs-comment">-- UPDATE to master</span>
(<span class="hljs-number">50</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'^DELETE.*'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),              <span class="hljs-comment">-- DELETE to master</span>
(<span class="hljs-number">60</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'^REPLACE.*'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),             <span class="hljs-comment">-- REPLACE to master</span>
(<span class="hljs-number">70</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'^CALL.*'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);                <span class="hljs-comment">-- Stored procedures to master</span>

<span class="hljs-comment">-- Route based on user</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> mysql_query_rules(rule_id, active, username, destination_hostgroup, <span class="hljs-keyword">apply</span>) <span class="hljs-keyword">VALUES</span>
(<span class="hljs-number">100</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'analytics_user'</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>);        <span class="hljs-comment">-- Analytics user to dedicated server</span>

<span class="hljs-comment">-- Route based on schema</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> mysql_query_rules(rule_id, active, schemaname, destination_hostgroup, <span class="hljs-keyword">apply</span>) <span class="hljs-keyword">VALUES</span>
(<span class="hljs-number">200</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'reporting_db'</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>);          <span class="hljs-comment">-- Reporting queries to analytics server</span>

<span class="hljs-keyword">LOAD</span> MYSQL <span class="hljs-keyword">QUERY</span> <span class="hljs-keyword">RULES</span> <span class="hljs-keyword">TO</span> RUNTIME;
SAVE MYSQL QUERY RULES TO DISK;
</div></code></pre>
<h4 id="application-level-routing">Application-Level Routing</h4>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SmartDatabaseRouter</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.write_pool = create_engine(<span class="hljs-string">'mysql://user:pass@master-proxy:6446/db'</span>)
        self.read_pool = create_engine(<span class="hljs-string">'mysql://user:pass@slave-proxy:6447/db'</span>)
        self.analytics_pool = create_engine(<span class="hljs-string">'mysql://user:pass@analytics-proxy:6448/db'</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">route_query</span><span class="hljs-params">(self, query, query_type=<span class="hljs-string">'auto'</span>)</span>:</span>
        <span class="hljs-keyword">if</span> query_type == <span class="hljs-string">'auto'</span>:
            query_type = self._detect_query_type(query)

        <span class="hljs-keyword">if</span> query_type == <span class="hljs-string">'write'</span>:
            <span class="hljs-keyword">return</span> self.write_pool
        <span class="hljs-keyword">elif</span> query_type == <span class="hljs-string">'analytics'</span>:
            <span class="hljs-keyword">return</span> self.analytics_pool
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> self.read_pool

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_detect_query_type</span><span class="hljs-params">(self, query)</span>:</span>
        query_upper = query.upper().strip()

        <span class="hljs-keyword">if</span> any(query_upper.startswith(cmd) <span class="hljs-keyword">for</span> cmd <span class="hljs-keyword">in</span> [<span class="hljs-string">'INSERT'</span>, <span class="hljs-string">'UPDATE'</span>, <span class="hljs-string">'DELETE'</span>, <span class="hljs-string">'REPLACE'</span>]):
            <span class="hljs-keyword">return</span> <span class="hljs-string">'write'</span>
        <span class="hljs-keyword">elif</span> <span class="hljs-string">'FOR UPDATE'</span> <span class="hljs-keyword">in</span> query_upper <span class="hljs-keyword">or</span> <span class="hljs-string">'LOCK IN SHARE MODE'</span> <span class="hljs-keyword">in</span> query_upper:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'write'</span>
        <span class="hljs-keyword">elif</span> any(func <span class="hljs-keyword">in</span> query_upper <span class="hljs-keyword">for</span> func <span class="hljs-keyword">in</span> [<span class="hljs-string">'COUNT(*)'</span>, <span class="hljs-string">'SUM('</span>, <span class="hljs-string">'AVG('</span>, <span class="hljs-string">'GROUP BY'</span>]):
            <span class="hljs-keyword">return</span> <span class="hljs-string">'analytics'</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'read'</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">execute</span><span class="hljs-params">(self, query, params=None)</span>:</span>
        engine = self.route_query(query)
        <span class="hljs-keyword">with</span> engine.connect() <span class="hljs-keyword">as</span> conn:
            <span class="hljs-keyword">return</span> conn.execute(query, params <span class="hljs-keyword">or</span> {})

<span class="hljs-comment"># Usage</span>
router = SmartDatabaseRouter()

<span class="hljs-comment"># Automatically routed to read replica</span>
users = router.execute(<span class="hljs-string">"SELECT * FROM users WHERE status = 'active'"</span>)

<span class="hljs-comment"># Automatically routed to master</span>
router.execute(<span class="hljs-string">"INSERT INTO users (name, email) VALUES ('John', 'john@example.com')"</span>)

<span class="hljs-comment"># Automatically routed to analytics server</span>
stats = router.execute(<span class="hljs-string">"SELECT COUNT(*), AVG(order_total) FROM orders GROUP BY DATE(created_at)"</span>)
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%80-caching-strategies">ğŸš€ Caching Strategies</h2>
<h3 id="query-result-caching">Query Result Caching</h3>
<h4 id="redis-integration-with-proxy">Redis Integration with Proxy</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> redis
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> hashlib
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> timedelta

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CachingDatabaseProxy</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.db = create_engine(<span class="hljs-string">'postgresql://user:pass@pgbouncer:6432/db'</span>)
        self.cache = redis.Redis(host=<span class="hljs-string">'redis-server'</span>, port=<span class="hljs-number">6379</span>, db=<span class="hljs-number">0</span>)
        self.default_ttl = <span class="hljs-number">300</span>  <span class="hljs-comment"># 5 minutes</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_generate_cache_key</span><span class="hljs-params">(self, query, params)</span>:</span>
        <span class="hljs-string">"""Generate unique cache key for query and parameters"""</span>
        query_hash = hashlib.md5(<span class="hljs-string">f"<span class="hljs-subst">{query}</span><span class="hljs-subst">{params}</span>"</span>.encode()).hexdigest()
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"query_cache:<span class="hljs-subst">{query_hash}</span>"</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_is_cacheable_query</span><span class="hljs-params">(self, query)</span>:</span>
        <span class="hljs-string">"""Determine if query results should be cached"""</span>
        query_upper = query.upper().strip()

        <span class="hljs-comment"># Only cache SELECT queries</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> query_upper.startswith(<span class="hljs-string">'SELECT'</span>):
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

        <span class="hljs-comment"># Don't cache queries with functions that return current time/data</span>
        non_cacheable = [<span class="hljs-string">'NOW()'</span>, <span class="hljs-string">'CURRENT_TIMESTAMP'</span>, <span class="hljs-string">'RANDOM()'</span>, <span class="hljs-string">'UUID()'</span>]
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">not</span> any(func <span class="hljs-keyword">in</span> query_upper <span class="hljs-keyword">for</span> func <span class="hljs-keyword">in</span> non_cacheable)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">execute_with_cache</span><span class="hljs-params">(self, query, params=None, ttl=None)</span>:</span>
        params = params <span class="hljs-keyword">or</span> {}
        ttl = ttl <span class="hljs-keyword">or</span> self.default_ttl

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self._is_cacheable_query(query):
            <span class="hljs-keyword">return</span> self._execute_direct(query, params)

        cache_key = self._generate_cache_key(query, params)

        <span class="hljs-comment"># Try to get from cache</span>
        cached_result = self.cache.get(cache_key)
        <span class="hljs-keyword">if</span> cached_result:
            <span class="hljs-keyword">return</span> json.loads(cached_result)

        <span class="hljs-comment"># Execute query and cache result</span>
        result = self._execute_direct(query, params)

        <span class="hljs-comment"># Cache the result</span>
        self.cache.setex(
            cache_key,
            ttl,
            json.dumps(result, default=str)
        )

        <span class="hljs-keyword">return</span> result

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_execute_direct</span><span class="hljs-params">(self, query, params)</span>:</span>
        <span class="hljs-keyword">with</span> self.db.connect() <span class="hljs-keyword">as</span> conn:
            result = conn.execute(query, params)
            <span class="hljs-keyword">return</span> [dict(row) <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> result]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">invalidate_cache_pattern</span><span class="hljs-params">(self, pattern)</span>:</span>
        <span class="hljs-string">"""Invalidate cache entries matching pattern"""</span>
        keys = self.cache.keys(<span class="hljs-string">f"query_cache:*<span class="hljs-subst">{pattern}</span>*"</span>)
        <span class="hljs-keyword">if</span> keys:
            self.cache.delete(*keys)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_cache_stats</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Get cache statistics"""</span>
        info = self.cache.info()
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'used_memory'</span>: info[<span class="hljs-string">'used_memory_human'</span>],
            <span class="hljs-string">'keyspace_hits'</span>: info[<span class="hljs-string">'keyspace_hits'</span>],
            <span class="hljs-string">'keyspace_misses'</span>: info[<span class="hljs-string">'keyspace_misses'</span>],
            <span class="hljs-string">'hit_rate'</span>: info[<span class="hljs-string">'keyspace_hits'</span>] / (info[<span class="hljs-string">'keyspace_hits'</span>] + info[<span class="hljs-string">'keyspace_misses'</span>]) * <span class="hljs-number">100</span>
        }

<span class="hljs-comment"># Usage</span>
caching_proxy = CachingDatabaseProxy()

<span class="hljs-comment"># This will be cached</span>
users = caching_proxy.execute_with_cache(
    <span class="hljs-string">"SELECT * FROM users WHERE department = :dept"</span>,
    {<span class="hljs-string">'dept'</span>: <span class="hljs-string">'engineering'</span>},
    ttl=<span class="hljs-number">600</span>  <span class="hljs-comment"># Cache for 10 minutes</span>
)

<span class="hljs-comment"># Invalidate cache when data changes</span>
caching_proxy.invalidate_cache_pattern(<span class="hljs-string">'users'</span>)

print(<span class="hljs-string">f"Cache stats: <span class="hljs-subst">{caching_proxy.get_cache_stats()}</span>"</span>)
</div></code></pre>
<h3 id="proxysql-query-caching">ProxySQL Query Caching</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Enable query caching in ProxySQL</span>
<span class="hljs-keyword">SET</span> mysql-query_cache_size_MB=<span class="hljs-number">256</span>;
<span class="hljs-keyword">SET</span> mysql-query_cache_stores_empty_result=<span class="hljs-literal">true</span>;

<span class="hljs-comment">-- Configure caching rules</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> mysql_query_rules(
    rule_id, active, match_pattern, cache_ttl, <span class="hljs-keyword">apply</span>
) <span class="hljs-keyword">VALUES</span>
(<span class="hljs-number">1000</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'^SELECT.*FROM products.*'</span>, <span class="hljs-number">300000</span>, <span class="hljs-number">1</span>),    <span class="hljs-comment">-- Cache product queries for 5 minutes</span>
(<span class="hljs-number">1001</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'^SELECT.*FROM categories.*'</span>, <span class="hljs-number">600000</span>, <span class="hljs-number">1</span>),   <span class="hljs-comment">-- Cache category queries for 10 minutes</span>
(<span class="hljs-number">1002</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'^SELECT COUNT\(\*\).*'</span>, <span class="hljs-number">60000</span>, <span class="hljs-number">1</span>);         <span class="hljs-comment">-- Cache count queries for 1 minute</span>

<span class="hljs-keyword">LOAD</span> MYSQL <span class="hljs-keyword">QUERY</span> <span class="hljs-keyword">RULES</span> <span class="hljs-keyword">TO</span> RUNTIME;
SAVE MYSQL QUERY RULES TO DISK;

<span class="hljs-comment">-- Monitor cache performance</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> stats_mysql_query_cache;
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%8A-monitoring-and-performance">ğŸ“Š Monitoring and Performance</h2>
<h3 id="proxysql-monitoring">ProxySQL Monitoring</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Connection statistics</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> stats_mysql_connection_pool;

<span class="hljs-comment">-- Query statistics</span>
<span class="hljs-keyword">SELECT</span>
    hostgroup,
    schemaname,
    username,
    digest_text,
    count_star,
    sum_time,
    avg_time
<span class="hljs-keyword">FROM</span> stats_mysql_query_digest
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sum_time <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;

<span class="hljs-comment">-- Backend server health</span>
<span class="hljs-keyword">SELECT</span>
    hostname,
    port,
    <span class="hljs-keyword">status</span>,
    ConnUsed,
    ConnFree,
    ConnOK,
    ConnERR,
    Queries,
    Bytes_data_sent,
    Bytes_data_recv
<span class="hljs-keyword">FROM</span> stats_mysql_servers;

<span class="hljs-comment">-- Query rules statistics</span>
<span class="hljs-keyword">SELECT</span>
    rule_id,
    hits,
    match_pattern,
    destination_hostgroup
<span class="hljs-keyword">FROM</span> stats_mysql_query_rules
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> hits <span class="hljs-keyword">DESC</span>;
</div></code></pre>
<h3 id="pgbouncer-monitoring">PgBouncer Monitoring</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Connect to PgBouncer admin</span>
psql -h localhost -p 6432 -U pgbouncer pgbouncer

<span class="hljs-comment">-- Show pool statistics</span>
<span class="hljs-keyword">SHOW</span> POOLS;

<span class="hljs-comment">-- Show client connections</span>
<span class="hljs-keyword">SHOW</span> CLIENTS;

<span class="hljs-comment">-- Show server connections</span>
<span class="hljs-keyword">SHOW</span> SERVERS;

<span class="hljs-comment">-- Show configuration</span>
<span class="hljs-keyword">SHOW</span> CONFIG;

<span class="hljs-comment">-- Show statistics</span>
<span class="hljs-keyword">SHOW</span> STATS;
</div></code></pre>
<h3 id="custom-monitoring-script">Custom Monitoring Script</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> psutil
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProxyMonitor</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, proxy_type=<span class="hljs-string">'pgbouncer'</span>)</span>:</span>
        self.proxy_type = proxy_type
        self.metrics = []

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">collect_system_metrics</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Collect system-level metrics"""</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'timestamp'</span>: datetime.now(),
            <span class="hljs-string">'cpu_percent'</span>: psutil.cpu_percent(),
            <span class="hljs-string">'memory_percent'</span>: psutil.virtual_memory().percent,
            <span class="hljs-string">'disk_io'</span>: psutil.disk_io_counters()._asdict(),
            <span class="hljs-string">'network_io'</span>: psutil.net_io_counters()._asdict()
        }

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">collect_pgbouncer_metrics</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Collect PgBouncer-specific metrics"""</span>
        <span class="hljs-keyword">import</span> psycopg2

        conn = psycopg2.connect(
            host=<span class="hljs-string">'localhost'</span>,
            port=<span class="hljs-number">6432</span>,
            user=<span class="hljs-string">'pgbouncer'</span>,
            database=<span class="hljs-string">'pgbouncer'</span>
        )

        <span class="hljs-keyword">with</span> conn.cursor() <span class="hljs-keyword">as</span> cur:
            <span class="hljs-comment"># Pool statistics</span>
            cur.execute(<span class="hljs-string">"SHOW POOLS"</span>)
            pools = cur.fetchall()

            <span class="hljs-comment"># Statistics</span>
            cur.execute(<span class="hljs-string">"SHOW STATS"</span>)
            stats = cur.fetchall()

        conn.close()

        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'pools'</span>: pools,
            <span class="hljs-string">'stats'</span>: stats
        }

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">collect_proxysql_metrics</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Collect ProxySQL-specific metrics"""</span>
        <span class="hljs-keyword">import</span> mysql.connector

        conn = mysql.connector.connect(
            host=<span class="hljs-string">'127.0.0.1'</span>,
            port=<span class="hljs-number">6032</span>,
            user=<span class="hljs-string">'admin'</span>,
            password=<span class="hljs-string">'admin'</span>
        )

        <span class="hljs-keyword">with</span> conn.cursor() <span class="hljs-keyword">as</span> cur:
            <span class="hljs-comment"># Connection pool stats</span>
            cur.execute(<span class="hljs-string">"SELECT * FROM stats_mysql_connection_pool"</span>)
            pool_stats = cur.fetchall()

            <span class="hljs-comment"># Query digest stats</span>
            cur.execute(<span class="hljs-string">"""
                SELECT hostgroup, count_star, sum_time, avg_time
                FROM stats_mysql_query_digest
                ORDER BY sum_time DESC LIMIT 10
            """</span>)
            query_stats = cur.fetchall()

        conn.close()

        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'pool_stats'</span>: pool_stats,
            <span class="hljs-string">'query_stats'</span>: query_stats
        }

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">monitor_continuously</span><span class="hljs-params">(self, interval=<span class="hljs-number">60</span>)</span>:</span>
        <span class="hljs-string">"""Continuously monitor proxy performance"""</span>
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            <span class="hljs-keyword">try</span>:
                metrics = {
                    <span class="hljs-string">'system'</span>: self.collect_system_metrics()
                }

                <span class="hljs-keyword">if</span> self.proxy_type == <span class="hljs-string">'pgbouncer'</span>:
                    metrics[<span class="hljs-string">'proxy'</span>] = self.collect_pgbouncer_metrics()
                <span class="hljs-keyword">elif</span> self.proxy_type == <span class="hljs-string">'proxysql'</span>:
                    metrics[<span class="hljs-string">'proxy'</span>] = self.collect_proxysql_metrics()

                self.metrics.append(metrics)

                <span class="hljs-comment"># Keep only last 1000 metrics</span>
                <span class="hljs-keyword">if</span> len(self.metrics) &gt; <span class="hljs-number">1000</span>:
                    self.metrics = self.metrics[<span class="hljs-number">-1000</span>:]

                print(<span class="hljs-string">f"Collected metrics at <span class="hljs-subst">{metrics[<span class="hljs-string">'system'</span>][<span class="hljs-string">'timestamp'</span>]}</span>"</span>)

            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                print(<span class="hljs-string">f"Error collecting metrics: <span class="hljs-subst">{e}</span>"</span>)

            time.sleep(interval)

<span class="hljs-comment"># Usage</span>
monitor = ProxyMonitor(<span class="hljs-string">'pgbouncer'</span>)
monitor.monitor_continuously(<span class="hljs-number">30</span>)  <span class="hljs-comment"># Monitor every 30 seconds</span>
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%92-security-considerations">ğŸ”’ Security Considerations</h2>
<h3 id="secure-proxy-configuration">Secure Proxy Configuration</h3>
<h4 id="ssltls-configuration">SSL/TLS Configuration</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># PgBouncer SSL configuration</span>
<span class="hljs-section">[pgbouncer]</span>
<span class="hljs-attr">server_tls_sslmode</span> = require
<span class="hljs-attr">server_tls_ca_file</span> = /etc/ssl/certs/ca-certificates.crt
<span class="hljs-attr">server_tls_key_file</span> = /etc/pgbouncer/server.key
<span class="hljs-attr">server_tls_cert_file</span> = /etc/pgbouncer/server.crt

<span class="hljs-attr">client_tls_sslmode</span> = require
<span class="hljs-attr">client_tls_ca_file</span> = /etc/ssl/certs/ca-certificates.crt
<span class="hljs-attr">client_tls_key_file</span> = /etc/pgbouncer/client.key
<span class="hljs-attr">client_tls_cert_file</span> = /etc/pgbouncer/client.crt
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">-- ProxySQL SSL configuration</span>
<span class="hljs-keyword">UPDATE</span> global_variables <span class="hljs-keyword">SET</span> variable_value=<span class="hljs-string">'true'</span> <span class="hljs-keyword">WHERE</span> variable_name=<span class="hljs-string">'mysql-have_ssl'</span>;
<span class="hljs-keyword">UPDATE</span> global_variables <span class="hljs-keyword">SET</span> variable_value=<span class="hljs-string">'/etc/proxysql/ssl/server-cert.pem'</span> <span class="hljs-keyword">WHERE</span> variable_name=<span class="hljs-string">'mysql-ssl_cert'</span>;
<span class="hljs-keyword">UPDATE</span> global_variables <span class="hljs-keyword">SET</span> variable_value=<span class="hljs-string">'/etc/proxysql/ssl/server-key.pem'</span> <span class="hljs-keyword">WHERE</span> variable_name=<span class="hljs-string">'mysql-ssl_key'</span>;
<span class="hljs-keyword">UPDATE</span> global_variables <span class="hljs-keyword">SET</span> variable_value=<span class="hljs-string">'/etc/proxysql/ssl/ca-cert.pem'</span> <span class="hljs-keyword">WHERE</span> variable_name=<span class="hljs-string">'mysql-ssl_ca'</span>;

<span class="hljs-keyword">LOAD</span> MYSQL <span class="hljs-keyword">VARIABLES</span> <span class="hljs-keyword">TO</span> RUNTIME;
SAVE MYSQL VARIABLES TO DISK;
</div></code></pre>
<h4 id="access-control">Access Control</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- ProxySQL user access control</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> mysql_users(username, <span class="hljs-keyword">password</span>, default_hostgroup, max_connections) <span class="hljs-keyword">VALUES</span>
(<span class="hljs-string">'app_user'</span>, <span class="hljs-string">'hashed_password'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>),
(<span class="hljs-string">'read_only_user'</span>, <span class="hljs-string">'hashed_password'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">50</span>),
(<span class="hljs-string">'analytics_user'</span>, <span class="hljs-string">'hashed_password'</span>, <span class="hljs-number">2</span>, <span class="hljs-number">10</span>);

<span class="hljs-comment">-- Restrict access by source IP</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> mysql_query_rules(rule_id, active, client_addr, <span class="hljs-keyword">apply</span>) <span class="hljs-keyword">VALUES</span>
(<span class="hljs-number">5000</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'192.168.1.0/24'</span>, <span class="hljs-number">1</span>);  <span class="hljs-comment">-- Only allow from internal network</span>

<span class="hljs-keyword">LOAD</span> MYSQL <span class="hljs-keyword">USERS</span> <span class="hljs-keyword">TO</span> RUNTIME;
<span class="hljs-keyword">LOAD</span> MYSQL <span class="hljs-keyword">QUERY</span> <span class="hljs-keyword">RULES</span> <span class="hljs-keyword">TO</span> RUNTIME;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8F%97%EF%B8%8F-real-world-example-e-commerce-proxy-architecture">ğŸ—ï¸ Real-World Example: E-commerce Proxy Architecture</h2>
<h3 id="architecture-design">Architecture Design</h3>
<pre class="hljs"><code><div>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web App       â”‚    â”‚   API Service   â”‚    â”‚  Analytics App  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚                      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      Load Balancer        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     Database Proxy        â”‚
                    â”‚    (ProxySQL/PgBouncer)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                        â”‚                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Master DB    â”‚    â”‚   Read Replica 1  â”‚    â”‚   Read Replica 2  â”‚
â”‚   (Writes)     â”‚    â”‚   (Reads)         â”‚    â”‚   (Analytics)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</div></code></pre>
<h3 id="implementation">Implementation</h3>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EcommerceProxyManager</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># Different connection pools for different workloads</span>
        self.write_pool = self._create_pool(<span class="hljs-string">'master-proxy:6446'</span>, pool_size=<span class="hljs-number">50</span>)
        self.read_pool = self._create_pool(<span class="hljs-string">'read-proxy:6447'</span>, pool_size=<span class="hljs-number">100</span>)
        self.analytics_pool = self._create_pool(<span class="hljs-string">'analytics-proxy:6448'</span>, pool_size=<span class="hljs-number">20</span>)

        <span class="hljs-comment"># Cache for frequently accessed data</span>
        self.cache = redis.Redis(host=<span class="hljs-string">'redis-cluster'</span>, port=<span class="hljs-number">6379</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_create_pool</span><span class="hljs-params">(self, host, pool_size)</span>:</span>
        <span class="hljs-keyword">return</span> create_engine(
            <span class="hljs-string">f'mysql://app_user:password@<span class="hljs-subst">{host}</span>/ecommerce'</span>,
            pool_size=pool_size,
            max_overflow=pool_size // <span class="hljs-number">2</span>,
            pool_pre_ping=<span class="hljs-literal">True</span>,
            pool_recycle=<span class="hljs-number">3600</span>
        )

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_order</span><span class="hljs-params">(self, user_id, items)</span>:</span>
        <span class="hljs-string">"""Write operation - use master"""</span>
        <span class="hljs-keyword">with</span> self.write_pool.connect() <span class="hljs-keyword">as</span> conn:
            <span class="hljs-keyword">with</span> conn.begin():
                <span class="hljs-comment"># Insert order</span>
                result = conn.execute(
                    <span class="hljs-string">"INSERT INTO orders (user_id, total_amount, status) VALUES (%s, %s, 'pending')"</span>,
                    (user_id, sum(item[<span class="hljs-string">'price'</span>] * item[<span class="hljs-string">'quantity'</span>] <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> items))
                )
                order_id = result.lastrowid

                <span class="hljs-comment"># Insert order items</span>
                <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> items:
                    conn.execute(
                        <span class="hljs-string">"INSERT INTO order_items (order_id, product_id, quantity, price) VALUES (%s, %s, %s, %s)"</span>,
                        (order_id, item[<span class="hljs-string">'product_id'</span>], item[<span class="hljs-string">'quantity'</span>], item[<span class="hljs-string">'price'</span>])
                    )

                <span class="hljs-comment"># Invalidate relevant caches</span>
                self.cache.delete(<span class="hljs-string">f"user_orders:<span class="hljs-subst">{user_id}</span>"</span>)
                self.cache.delete(<span class="hljs-string">"order_stats"</span>)

                <span class="hljs-keyword">return</span> order_id

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_user_orders</span><span class="hljs-params">(self, user_id)</span>:</span>
        <span class="hljs-string">"""Read operation with caching"""</span>
        cache_key = <span class="hljs-string">f"user_orders:<span class="hljs-subst">{user_id}</span>"</span>

        <span class="hljs-comment"># Try cache first</span>
        cached_orders = self.cache.get(cache_key)
        <span class="hljs-keyword">if</span> cached_orders:
            <span class="hljs-keyword">return</span> json.loads(cached_orders)

        <span class="hljs-comment"># Query from read replica</span>
        <span class="hljs-keyword">with</span> self.read_pool.connect() <span class="hljs-keyword">as</span> conn:
            orders = conn.execute(
                <span class="hljs-string">"SELECT * FROM orders WHERE user_id = %s ORDER BY created_at DESC LIMIT 50"</span>,
                (user_id,)
            ).fetchall()

            orders_list = [dict(order) <span class="hljs-keyword">for</span> order <span class="hljs-keyword">in</span> orders]

            <span class="hljs-comment"># Cache for 5 minutes</span>
            self.cache.setex(cache_key, <span class="hljs-number">300</span>, json.dumps(orders_list, default=str))

            <span class="hljs-keyword">return</span> orders_list

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_sales_analytics</span><span class="hljs-params">(self, start_date, end_date)</span>:</span>
        <span class="hljs-string">"""Analytics operation - use dedicated analytics server"""</span>
        <span class="hljs-keyword">with</span> self.analytics_pool.connect() <span class="hljs-keyword">as</span> conn:
            <span class="hljs-keyword">return</span> conn.execute(<span class="hljs-string">"""
                SELECT
                    DATE(created_at) as order_date,
                    COUNT(*) as total_orders,
                    SUM(total_amount) as total_revenue,
                    AVG(total_amount) as avg_order_value,
                    COUNT(DISTINCT user_id) as unique_customers
                FROM orders
                WHERE created_at BETWEEN %s AND %s
                GROUP BY DATE(created_at)
                ORDER BY order_date DESC
            """</span>, (start_date, end_date)).fetchall()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_connection_stats</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Monitor connection pool health"""</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'write_pool'</span>: {
                <span class="hljs-string">'size'</span>: self.write_pool.pool.size(),
                <span class="hljs-string">'checked_out'</span>: self.write_pool.pool.checkedout(),
                <span class="hljs-string">'overflow'</span>: self.write_pool.pool.overflow()
            },
            <span class="hljs-string">'read_pool'</span>: {
                <span class="hljs-string">'size'</span>: self.read_pool.pool.size(),
                <span class="hljs-string">'checked_out'</span>: self.read_pool.pool.checkedout(),
                <span class="hljs-string">'overflow'</span>: self.read_pool.pool.overflow()
            },
            <span class="hljs-string">'analytics_pool'</span>: {
                <span class="hljs-string">'size'</span>: self.analytics_pool.pool.size(),
                <span class="hljs-string">'checked_out'</span>: self.analytics_pool.pool.checkedout(),
                <span class="hljs-string">'overflow'</span>: self.analytics_pool.pool.overflow()
            }
        }

<span class="hljs-comment"># Usage</span>
ecommerce_proxy = EcommerceProxyManager()

<span class="hljs-comment"># Create order (routed to master)</span>
order_id = ecommerce_proxy.create_order(<span class="hljs-number">123</span>, [
    {<span class="hljs-string">'product_id'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'quantity'</span>: <span class="hljs-number">2</span>, <span class="hljs-string">'price'</span>: <span class="hljs-number">29.99</span>},
    {<span class="hljs-string">'product_id'</span>: <span class="hljs-number">2</span>, <span class="hljs-string">'quantity'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'price'</span>: <span class="hljs-number">49.99</span>}
])

<span class="hljs-comment"># Get user orders (routed to read replica, cached)</span>
orders = ecommerce_proxy.get_user_orders(<span class="hljs-number">123</span>)

<span class="hljs-comment"># Get analytics (routed to analytics server)</span>
stats = ecommerce_proxy.get_sales_analytics(<span class="hljs-string">'2024-01-01'</span>, <span class="hljs-string">'2024-01-31'</span>)

<span class="hljs-comment"># Monitor connection health</span>
print(<span class="hljs-string">f"Connection stats: <span class="hljs-subst">{ecommerce_proxy.get_connection_stats()}</span>"</span>)
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-interview-questions">ğŸ¯ Interview Questions</h2>
<h3 id="basic-questions">Basic Questions</h3>
<ol>
<li><strong>What is a database proxy and why would you use one?</strong></li>
<li><strong>Explain the difference between session, transaction, and statement pooling.</strong></li>
<li><strong>How does connection pooling improve application performance?</strong></li>
</ol>
<h3 id="intermediate-questions">Intermediate Questions</h3>
<ol>
<li><strong>How would you implement read/write splitting in a database proxy?</strong></li>
<li><strong>What are the trade-offs between application-level and proxy-level connection pooling?</strong></li>
<li><strong>How do you handle failover in a proxy configuration?</strong></li>
</ol>
<h3 id="advanced-questions">Advanced Questions</h3>
<ol>
<li><strong>Design a database proxy architecture for a global e-commerce platform</strong></li>
<li><strong>How would you implement query result caching in a database proxy?</strong></li>
<li><strong>What strategies would you use to monitor and optimize proxy performance?</strong></li>
</ol>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-common-pitfalls">âš ï¸ Common Pitfalls</h2>
<h3 id="1-inadequate-pool-sizing">1. <strong>Inadequate Pool Sizing</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Problem: Pool too small causes connection queuing</span>
pool_size = <span class="hljs-number">5</span>  <span class="hljs-comment"># Too small for high-traffic app</span>

<span class="hljs-comment"># Solution: Size based on concurrent users and query duration</span>
pool_size = min(<span class="hljs-number">100</span>, max(<span class="hljs-number">10</span>, concurrent_users * avg_query_time_seconds))
</div></code></pre>
<h3 id="2-ignoring-connection-leaks">2. <strong>Ignoring Connection Leaks</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Problem: Not properly releasing connections</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bad_query</span><span class="hljs-params">()</span>:</span>
    conn = pool.get_connection()
    result = conn.execute(<span class="hljs-string">"SELECT * FROM users"</span>)
    <span class="hljs-comment"># Connection never released!</span>
    <span class="hljs-keyword">return</span> result

<span class="hljs-comment"># Solution: Always use context managers</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">good_query</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">with</span> pool.get_connection() <span class="hljs-keyword">as</span> conn:
        <span class="hljs-keyword">return</span> conn.execute(<span class="hljs-string">"SELECT * FROM users"</span>)
</div></code></pre>
<h3 id="3-improper-query-routing">3. <strong>Improper Query Routing</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Routing read queries to master unnecessarily</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">123</span>;  <span class="hljs-comment">-- Could go to replica</span>

<span class="hljs-comment">-- Solution: Implement proper routing rules</span>
<span class="hljs-comment">-- Route only writes and critical reads to master</span>
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-next-steps">ğŸ¯ Next Steps</h2>
<p>Congratulations! You've mastered database proxies and connection pooling. You now understand:</p>
<p>âœ… <strong>Database proxy architecture and benefits</strong><br>
âœ… <strong>Connection pooling strategies and optimization</strong><br>
âœ… <strong>Query routing and load balancing</strong><br>
âœ… <strong>Caching and performance optimization</strong><br>
âœ… <strong>Monitoring and security best practices</strong></p>
<p><strong>Continue to</strong> â†’ <a href="./20-partitioning-sharding.md">Chapter 20: Partitioning &amp; Sharding</a></p>
<hr>
<p><em>You're now equipped to design and implement scalable database proxy architectures that can handle enterprise-scale workloads!</em> ğŸš€</p>
<h1 id="chapter-20-partitioning--sharding">Chapter 20: Partitioning &amp; Sharding</h1>
<h2 id="%F0%9F%93%9A-what-youll-learn">ğŸ“š What You'll Learn</h2>
<p>Partitioning and sharding are essential techniques for scaling databases beyond single-server limitations. This chapter covers horizontal and vertical partitioning, sharding strategies, data distribution, and managing distributed databases for both MySQL and PostgreSQL.</p>
<hr>
<h2 id="%F0%9F%8E%AF-learning-objectives">ğŸ¯ Learning Objectives</h2>
<ul>
<li><strong>Database Partitioning</strong>: Understand table partitioning strategies</li>
<li><strong>Horizontal Sharding</strong>: Distribute data across multiple servers</li>
<li><strong>Vertical Sharding</strong>: Split tables by columns or functionality</li>
<li><strong>Shard Key Selection</strong>: Choose optimal data distribution keys</li>
<li><strong>Cross-Shard Queries</strong>: Handle queries spanning multiple shards</li>
<li><strong>Rebalancing</strong>: Redistribute data as requirements change</li>
<li><strong>Consistency</strong>: Maintain data integrity across shards</li>
</ul>
<hr>
<h2 id="%F0%9F%93%96-concept-explanation">ğŸ“– Concept Explanation</h2>
<h3 id="what-is-partitioning">What is Partitioning?</h3>
<p><strong>Partitioning</strong> divides a large table into smaller, more manageable pieces called partitions, while keeping them within the same database instance.</p>
<h3 id="what-is-sharding">What is Sharding?</h3>
<p><strong>Sharding</strong> distributes data across multiple database servers (shards), where each shard contains a subset of the total data.</p>
<h3 id="partitioning-vs-sharding">Partitioning vs Sharding</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Partitioning</th>
<th>Sharding</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Scope</strong></td>
<td>Single database instance</td>
<td>Multiple database servers</td>
</tr>
<tr>
<td><strong>Complexity</strong></td>
<td>Lower</td>
<td>Higher</td>
</tr>
<tr>
<td><strong>Scalability</strong></td>
<td>Limited by single server</td>
<td>Unlimited horizontal scaling</td>
</tr>
<tr>
<td><strong>Queries</strong></td>
<td>Transparent to application</td>
<td>May require application changes</td>
</tr>
<tr>
<td><strong>Consistency</strong></td>
<td>ACID guaranteed</td>
<td>Eventual consistency challenges</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="%F0%9F%94%A7-mysql-partitioning">ğŸ”§ MySQL Partitioning</h2>
<h3 id="range-partitioning">Range Partitioning</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Partition orders by date range</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span> AUTO_INCREMENT,
    user_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    order_date <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    total_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    <span class="hljs-keyword">status</span> ENUM(<span class="hljs-string">'pending'</span>, <span class="hljs-string">'processing'</span>, <span class="hljs-string">'shipped'</span>, <span class="hljs-string">'delivered'</span>),
    PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-keyword">id</span>, order_date)
) <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span> (<span class="hljs-keyword">YEAR</span>(order_date)) (
    <span class="hljs-keyword">PARTITION</span> p2020 <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">LESS</span> <span class="hljs-keyword">THAN</span> (<span class="hljs-number">2021</span>),
    <span class="hljs-keyword">PARTITION</span> p2021 <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">LESS</span> <span class="hljs-keyword">THAN</span> (<span class="hljs-number">2022</span>),
    <span class="hljs-keyword">PARTITION</span> p2022 <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">LESS</span> <span class="hljs-keyword">THAN</span> (<span class="hljs-number">2023</span>),
    <span class="hljs-keyword">PARTITION</span> p2023 <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">LESS</span> <span class="hljs-keyword">THAN</span> (<span class="hljs-number">2024</span>),
    <span class="hljs-keyword">PARTITION</span> p2024 <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">LESS</span> <span class="hljs-keyword">THAN</span> (<span class="hljs-number">2025</span>),
    <span class="hljs-keyword">PARTITION</span> p_future <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">LESS</span> <span class="hljs-keyword">THAN</span> MAXVALUE
);

<span class="hljs-comment">-- Add new partition for 2025</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> orders <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">PARTITION</span> (
    <span class="hljs-keyword">PARTITION</span> p2025 <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">LESS</span> <span class="hljs-keyword">THAN</span> (<span class="hljs-number">2026</span>)
);

<span class="hljs-comment">-- Drop old partition</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> orders <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">PARTITION</span> p2020;
</div></code></pre>
<h3 id="hash-partitioning">Hash Partitioning</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Partition users by hash of user_id</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span> AUTO_INCREMENT,
    username <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-keyword">id</span>)
) <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">HASH</span>(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">PARTITIONS</span> <span class="hljs-number">8</span>;

<span class="hljs-comment">-- Partition by custom hash function</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_sessions (
    session_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">64</span>),
    user_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    expires_at <span class="hljs-built_in">TIMESTAMP</span>,
    PRIMARY <span class="hljs-keyword">KEY</span> (session_id, user_id)
) <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">HASH</span>(<span class="hljs-keyword">CRC32</span>(session_id)) <span class="hljs-keyword">PARTITIONS</span> <span class="hljs-number">16</span>;
</div></code></pre>
<h3 id="list-partitioning">List Partitioning</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Partition by specific values (regions)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> sales (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span> AUTO_INCREMENT,
    region <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    product_id <span class="hljs-built_in">INT</span>,
    amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    sale_date <span class="hljs-built_in">DATE</span>,
    PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-keyword">id</span>, region)
) <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">LIST</span> <span class="hljs-keyword">COLUMNS</span>(region) (
    <span class="hljs-keyword">PARTITION</span> p_north <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'north'</span>, <span class="hljs-string">'northeast'</span>, <span class="hljs-string">'northwest'</span>),
    <span class="hljs-keyword">PARTITION</span> p_south <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'south'</span>, <span class="hljs-string">'southeast'</span>, <span class="hljs-string">'southwest'</span>),
    <span class="hljs-keyword">PARTITION</span> p_east <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'east'</span>, <span class="hljs-string">'central_east'</span>),
    <span class="hljs-keyword">PARTITION</span> p_west <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'west'</span>, <span class="hljs-string">'central_west'</span>),
    <span class="hljs-keyword">PARTITION</span> p_international <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'europe'</span>, <span class="hljs-string">'asia'</span>, <span class="hljs-string">'africa'</span>)
);
</div></code></pre>
<h3 id="subpartitioning">Subpartitioning</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Combine range and hash partitioning</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> order_details (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span> AUTO_INCREMENT,
    order_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    product_id <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    quantity <span class="hljs-built_in">INT</span>,
    price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    order_date <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-keyword">id</span>, order_date, order_id)
) <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span> (<span class="hljs-keyword">YEAR</span>(order_date))
<span class="hljs-keyword">SUBPARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">HASH</span>(order_id)
<span class="hljs-keyword">SUBPARTITIONS</span> <span class="hljs-number">4</span> (
    <span class="hljs-keyword">PARTITION</span> p2023 <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">LESS</span> <span class="hljs-keyword">THAN</span> (<span class="hljs-number">2024</span>),
    <span class="hljs-keyword">PARTITION</span> p2024 <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">LESS</span> <span class="hljs-keyword">THAN</span> (<span class="hljs-number">2025</span>),
    <span class="hljs-keyword">PARTITION</span> p_future <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">LESS</span> <span class="hljs-keyword">THAN</span> MAXVALUE
);
</div></code></pre>
<hr>
<h2 id="%F0%9F%90%98-postgresql-partitioning">ğŸ˜ PostgreSQL Partitioning</h2>
<h3 id="declarative-partitioning-postgresql-10">Declarative Partitioning (PostgreSQL 10+)</h3>
<h4 id="range-partitioning">Range Partitioning</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Create parent table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">SERIAL</span>,
    user_id <span class="hljs-built_in">INTEGER</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    order_date <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    total_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    <span class="hljs-keyword">status</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>)
) <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span> (order_date);

<span class="hljs-comment">-- Create partitions</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders_2023 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> orders
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-string">'2023-01-01'</span>) <span class="hljs-keyword">TO</span> (<span class="hljs-string">'2024-01-01'</span>);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders_2024 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> orders
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-string">'2024-01-01'</span>) <span class="hljs-keyword">TO</span> (<span class="hljs-string">'2025-01-01'</span>);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders_default <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> orders <span class="hljs-keyword">DEFAULT</span>;

<span class="hljs-comment">-- Create indexes on partitions</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_orders_2023_user_date <span class="hljs-keyword">ON</span> orders_2023 (user_id, order_date);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_orders_2024_user_date <span class="hljs-keyword">ON</span> orders_2024 (user_id, order_date);
</div></code></pre>
<h4 id="hash-partitioning">Hash Partitioning</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Create hash-partitioned table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_activities (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">SERIAL</span>,
    user_id <span class="hljs-built_in">INTEGER</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    activity_type <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    activity_data JSONB,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NOW</span>()
) <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">HASH</span> (user_id);

<span class="hljs-comment">-- Create hash partitions</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_activities_0 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> user_activities
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">WITH</span> (modulus <span class="hljs-number">4</span>, <span class="hljs-keyword">remainder</span> <span class="hljs-number">0</span>);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_activities_1 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> user_activities
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">WITH</span> (modulus <span class="hljs-number">4</span>, <span class="hljs-keyword">remainder</span> <span class="hljs-number">1</span>);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_activities_2 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> user_activities
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">WITH</span> (modulus <span class="hljs-number">4</span>, <span class="hljs-keyword">remainder</span> <span class="hljs-number">2</span>);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_activities_3 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> user_activities
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">WITH</span> (modulus <span class="hljs-number">4</span>, <span class="hljs-keyword">remainder</span> <span class="hljs-number">3</span>);
</div></code></pre>
<h4 id="list-partitioning">List Partitioning</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Create list-partitioned table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">SERIAL</span>,
    <span class="hljs-keyword">name</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    <span class="hljs-keyword">category</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NOW</span>()
) <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">LIST</span> (<span class="hljs-keyword">category</span>);

<span class="hljs-comment">-- Create list partitions</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products_electronics <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> products
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'electronics'</span>, <span class="hljs-string">'computers'</span>, <span class="hljs-string">'phones'</span>);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products_clothing <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> products
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'clothing'</span>, <span class="hljs-string">'shoes'</span>, <span class="hljs-string">'accessories'</span>);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products_books <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> products
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'books'</span>, <span class="hljs-string">'ebooks'</span>, <span class="hljs-string">'audiobooks'</span>);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products_other <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> products <span class="hljs-keyword">DEFAULT</span>;
</div></code></pre>
<h3 id="partition-pruning-and-constraint-exclusion">Partition Pruning and Constraint Exclusion</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Enable constraint exclusion</span>
<span class="hljs-keyword">SET</span> constraint_exclusion = <span class="hljs-keyword">partition</span>;

<span class="hljs-comment">-- Query that benefits from partition pruning</span>
<span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">ANALYZE</span>, BUFFERS)
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> order_date <span class="hljs-keyword">BETWEEN</span> <span class="hljs-string">'2024-01-01'</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">'2024-03-31'</span>;

<span class="hljs-comment">-- Check partition pruning</span>
<span class="hljs-keyword">SELECT</span>
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation
<span class="hljs-keyword">FROM</span> pg_stats
<span class="hljs-keyword">WHERE</span> tablename <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'orders_%'</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8C%90-horizontal-sharding-strategies">ğŸŒ Horizontal Sharding Strategies</h2>
<h3 id="shard-key-selection">Shard Key Selection</h3>
<h4 id="1-user-id-sharding">1. User ID Sharding</h4>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserShardRouter</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, shard_count=<span class="hljs-number">4</span>)</span>:</span>
        self.shard_count = shard_count
        self.shards = {
            <span class="hljs-number">0</span>: create_engine(<span class="hljs-string">'mysql://user:pass@shard0:3306/app'</span>),
            <span class="hljs-number">1</span>: create_engine(<span class="hljs-string">'mysql://user:pass@shard1:3306/app'</span>),
            <span class="hljs-number">2</span>: create_engine(<span class="hljs-string">'mysql://user:pass@shard2:3306/app'</span>),
            <span class="hljs-number">3</span>: create_engine(<span class="hljs-string">'mysql://user:pass@shard3:3306/app'</span>)
        }

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_shard</span><span class="hljs-params">(self, user_id)</span>:</span>
        <span class="hljs-string">"""Route based on user_id hash"""</span>
        shard_id = hash(str(user_id)) % self.shard_count
        <span class="hljs-keyword">return</span> self.shards[shard_id]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_user</span><span class="hljs-params">(self, user_data)</span>:</span>
        <span class="hljs-string">"""Create user in appropriate shard"""</span>
        user_id = user_data[<span class="hljs-string">'id'</span>]
        shard = self.get_shard(user_id)

        <span class="hljs-keyword">with</span> shard.connect() <span class="hljs-keyword">as</span> conn:
            conn.execute(<span class="hljs-string">"""
                INSERT INTO users (id, username, email, created_at)
                VALUES (%(id)s, %(username)s, %(email)s, %(created_at)s)
            """</span>, user_data)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_user</span><span class="hljs-params">(self, user_id)</span>:</span>
        <span class="hljs-string">"""Get user from appropriate shard"""</span>
        shard = self.get_shard(user_id)

        <span class="hljs-keyword">with</span> shard.connect() <span class="hljs-keyword">as</span> conn:
            result = conn.execute(
                <span class="hljs-string">"SELECT * FROM users WHERE id = %s"</span>, (user_id,)
            )
            <span class="hljs-keyword">return</span> result.fetchone()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_user_orders</span><span class="hljs-params">(self, user_id)</span>:</span>
        <span class="hljs-string">"""Get orders for user from same shard"""</span>
        shard = self.get_shard(user_id)

        <span class="hljs-keyword">with</span> shard.connect() <span class="hljs-keyword">as</span> conn:
            result = conn.execute(<span class="hljs-string">"""
                SELECT o.*, oi.product_id, oi.quantity, oi.price
                FROM orders o
                JOIN order_items oi ON o.id = oi.order_id
                WHERE o.user_id = %s
                ORDER BY o.created_at DESC
            """</span>, (user_id,))
            <span class="hljs-keyword">return</span> result.fetchall()

<span class="hljs-comment"># Usage</span>
router = UserShardRouter()

<span class="hljs-comment"># Create user (automatically routed to correct shard)</span>
router.create_user({
    <span class="hljs-string">'id'</span>: <span class="hljs-number">12345</span>,
    <span class="hljs-string">'username'</span>: <span class="hljs-string">'john_doe'</span>,
    <span class="hljs-string">'email'</span>: <span class="hljs-string">'john@example.com'</span>,
    <span class="hljs-string">'created_at'</span>: datetime.now()
})

<span class="hljs-comment"># Get user (automatically routed to correct shard)</span>
user = router.get_user(<span class="hljs-number">12345</span>)
orders = router.get_user_orders(<span class="hljs-number">12345</span>)
</div></code></pre>
<h4 id="2-geographic-sharding">2. Geographic Sharding</h4>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GeographicShardRouter</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.region_shards = {
            <span class="hljs-string">'us_east'</span>: create_engine(<span class="hljs-string">'mysql://user:pass@us-east-shard:3306/app'</span>),
            <span class="hljs-string">'us_west'</span>: create_engine(<span class="hljs-string">'mysql://user:pass@us-west-shard:3306/app'</span>),
            <span class="hljs-string">'europe'</span>: create_engine(<span class="hljs-string">'mysql://user:pass@eu-shard:3306/app'</span>),
            <span class="hljs-string">'asia'</span>: create_engine(<span class="hljs-string">'mysql://user:pass@asia-shard:3306/app'</span>)
        }

        self.country_to_region = {
            <span class="hljs-string">'US'</span>: <span class="hljs-string">'us_east'</span>, <span class="hljs-string">'CA'</span>: <span class="hljs-string">'us_east'</span>,
            <span class="hljs-string">'GB'</span>: <span class="hljs-string">'europe'</span>, <span class="hljs-string">'DE'</span>: <span class="hljs-string">'europe'</span>, <span class="hljs-string">'FR'</span>: <span class="hljs-string">'europe'</span>,
            <span class="hljs-string">'JP'</span>: <span class="hljs-string">'asia'</span>, <span class="hljs-string">'CN'</span>: <span class="hljs-string">'asia'</span>, <span class="hljs-string">'IN'</span>: <span class="hljs-string">'asia'</span>
        }

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_shard_by_country</span><span class="hljs-params">(self, country_code)</span>:</span>
        <span class="hljs-string">"""Route based on country"""</span>
        region = self.country_to_region.get(country_code, <span class="hljs-string">'us_east'</span>)
        <span class="hljs-keyword">return</span> self.region_shards[region]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_order</span><span class="hljs-params">(self, order_data)</span>:</span>
        <span class="hljs-string">"""Create order in geographically appropriate shard"""</span>
        shard = self.get_shard_by_country(order_data[<span class="hljs-string">'country'</span>])

        <span class="hljs-keyword">with</span> shard.connect() <span class="hljs-keyword">as</span> conn:
            <span class="hljs-keyword">with</span> conn.begin():
                <span class="hljs-comment"># Insert order</span>
                result = conn.execute(<span class="hljs-string">"""
                    INSERT INTO orders (user_id, country, total_amount, created_at)
                    VALUES (%(user_id)s, %(country)s, %(total_amount)s, %(created_at)s)
                """</span>, order_data)

                order_id = result.lastrowid

                <span class="hljs-comment"># Insert order items</span>
                <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> order_data[<span class="hljs-string">'items'</span>]:
                    item[<span class="hljs-string">'order_id'</span>] = order_id
                    conn.execute(<span class="hljs-string">"""
                        INSERT INTO order_items (order_id, product_id, quantity, price)
                        VALUES (%(order_id)s, %(product_id)s, %(quantity)s, %(price)s)
                    """</span>, item)

                <span class="hljs-keyword">return</span> order_id

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_regional_analytics</span><span class="hljs-params">(self, region, start_date, end_date)</span>:</span>
        <span class="hljs-string">"""Get analytics for specific region"""</span>
        shard = self.region_shards[region]

        <span class="hljs-keyword">with</span> shard.connect() <span class="hljs-keyword">as</span> conn:
            <span class="hljs-keyword">return</span> conn.execute(<span class="hljs-string">"""
                SELECT
                    DATE(created_at) as order_date,
                    COUNT(*) as total_orders,
                    SUM(total_amount) as total_revenue,
                    AVG(total_amount) as avg_order_value
                FROM orders
                WHERE created_at BETWEEN %s AND %s
                GROUP BY DATE(created_at)
                ORDER BY order_date
            """</span>, (start_date, end_date)).fetchall()

<span class="hljs-comment"># Usage</span>
geo_router = GeographicShardRouter()

<span class="hljs-comment"># Create order (routed to appropriate geographic shard)</span>
order_id = geo_router.create_order({
    <span class="hljs-string">'user_id'</span>: <span class="hljs-number">12345</span>,
    <span class="hljs-string">'country'</span>: <span class="hljs-string">'US'</span>,
    <span class="hljs-string">'total_amount'</span>: <span class="hljs-number">99.99</span>,
    <span class="hljs-string">'created_at'</span>: datetime.now(),
    <span class="hljs-string">'items'</span>: [
        {<span class="hljs-string">'product_id'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'quantity'</span>: <span class="hljs-number">2</span>, <span class="hljs-string">'price'</span>: <span class="hljs-number">29.99</span>},
        {<span class="hljs-string">'product_id'</span>: <span class="hljs-number">2</span>, <span class="hljs-string">'quantity'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'price'</span>: <span class="hljs-number">39.99</span>}
    ]
})

<span class="hljs-comment"># Get regional analytics</span>
us_stats = geo_router.get_regional_analytics(<span class="hljs-string">'us_east'</span>, <span class="hljs-string">'2024-01-01'</span>, <span class="hljs-string">'2024-01-31'</span>)
</div></code></pre>
<h4 id="3-time-based-sharding">3. Time-Based Sharding</h4>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TimeBasedShardRouter</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.time_shards = {
            <span class="hljs-string">'2023'</span>: create_engine(<span class="hljs-string">'mysql://user:pass@shard-2023:3306/app'</span>),
            <span class="hljs-string">'2024'</span>: create_engine(<span class="hljs-string">'mysql://user:pass@shard-2024:3306/app'</span>),
            <span class="hljs-string">'2025'</span>: create_engine(<span class="hljs-string">'mysql://user:pass@shard-2025:3306/app'</span>)
        }

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_shard_by_date</span><span class="hljs-params">(self, date_obj)</span>:</span>
        <span class="hljs-string">"""Route based on year"""</span>
        year = str(date_obj.year)
        <span class="hljs-keyword">return</span> self.time_shards.get(year, self.time_shards[<span class="hljs-string">'2024'</span>])  <span class="hljs-comment"># Default to current</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_log_entry</span><span class="hljs-params">(self, log_data)</span>:</span>
        <span class="hljs-string">"""Create log entry in time-appropriate shard"""</span>
        shard = self.get_shard_by_date(log_data[<span class="hljs-string">'timestamp'</span>])

        <span class="hljs-keyword">with</span> shard.connect() <span class="hljs-keyword">as</span> conn:
            conn.execute(<span class="hljs-string">"""
                INSERT INTO activity_logs (user_id, action, details, timestamp)
                VALUES (%(user_id)s, %(action)s, %(details)s, %(timestamp)s)
            """</span>, log_data)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_logs_for_period</span><span class="hljs-params">(self, start_date, end_date)</span>:</span>
        <span class="hljs-string">"""Get logs across multiple time shards"""</span>
        all_logs = []

        <span class="hljs-comment"># Determine which shards to query</span>
        years = set()
        current_date = start_date
        <span class="hljs-keyword">while</span> current_date &lt;= end_date:
            years.add(str(current_date.year))
            current_date = current_date.replace(year=current_date.year + <span class="hljs-number">1</span>, month=<span class="hljs-number">1</span>, day=<span class="hljs-number">1</span>)

        <span class="hljs-comment"># Query each relevant shard</span>
        <span class="hljs-keyword">for</span> year <span class="hljs-keyword">in</span> years:
            <span class="hljs-keyword">if</span> year <span class="hljs-keyword">in</span> self.time_shards:
                shard = self.time_shards[year]
                <span class="hljs-keyword">with</span> shard.connect() <span class="hljs-keyword">as</span> conn:
                    logs = conn.execute(<span class="hljs-string">"""
                        SELECT * FROM activity_logs
                        WHERE timestamp BETWEEN %s AND %s
                        ORDER BY timestamp
                    """</span>, (start_date, end_date)).fetchall()
                    all_logs.extend(logs)

        <span class="hljs-comment"># Sort combined results</span>
        <span class="hljs-keyword">return</span> sorted(all_logs, key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-string">'timestamp'</span>])

<span class="hljs-comment"># Usage</span>
time_router = TimeBasedShardRouter()

<span class="hljs-comment"># Create log entry (routed to appropriate time shard)</span>
time_router.create_log_entry({
    <span class="hljs-string">'user_id'</span>: <span class="hljs-number">12345</span>,
    <span class="hljs-string">'action'</span>: <span class="hljs-string">'login'</span>,
    <span class="hljs-string">'details'</span>: {<span class="hljs-string">'ip'</span>: <span class="hljs-string">'192.168.1.100'</span>, <span class="hljs-string">'user_agent'</span>: <span class="hljs-string">'Chrome/91.0'</span>},
    <span class="hljs-string">'timestamp'</span>: datetime.now()
})

<span class="hljs-comment"># Get logs across time period (may query multiple shards)</span>
logs = time_router.get_logs_for_period(
    datetime(<span class="hljs-number">2023</span>, <span class="hljs-number">12</span>, <span class="hljs-number">1</span>),
    datetime(<span class="hljs-number">2024</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>)
)
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%84-cross-shard-operations">ğŸ”„ Cross-Shard Operations</h2>
<h3 id="distributed-queries">Distributed Queries</h3>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DistributedQueryManager</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, shard_router)</span>:</span>
        self.router = shard_router

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">aggregate_across_shards</span><span class="hljs-params">(self, query, params=None)</span>:</span>
        <span class="hljs-string">"""Execute query across all shards and aggregate results"""</span>
        all_results = []

        <span class="hljs-keyword">for</span> shard_id, shard <span class="hljs-keyword">in</span> self.router.shards.items():
            <span class="hljs-keyword">try</span>:
                <span class="hljs-keyword">with</span> shard.connect() <span class="hljs-keyword">as</span> conn:
                    result = conn.execute(query, params <span class="hljs-keyword">or</span> {})
                    shard_results = result.fetchall()

                    <span class="hljs-comment"># Add shard_id to each result</span>
                    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> shard_results:
                        row_dict = dict(row)
                        row_dict[<span class="hljs-string">'_shard_id'</span>] = shard_id
                        all_results.append(row_dict)

            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                print(<span class="hljs-string">f"Error querying shard <span class="hljs-subst">{shard_id}</span>: <span class="hljs-subst">{e}</span>"</span>)
                <span class="hljs-keyword">continue</span>

        <span class="hljs-keyword">return</span> all_results

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_global_user_count</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Get total user count across all shards"""</span>
        results = self.aggregate_across_shards(<span class="hljs-string">"SELECT COUNT(*) as user_count FROM users"</span>)
        <span class="hljs-keyword">return</span> sum(row[<span class="hljs-string">'user_count'</span>] <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> results)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_top_users_by_orders</span><span class="hljs-params">(self, limit=<span class="hljs-number">10</span>)</span>:</span>
        <span class="hljs-string">"""Get top users by order count across all shards"""</span>
        query = <span class="hljs-string">"""
            SELECT
                user_id,
                COUNT(*) as order_count,
                SUM(total_amount) as total_spent
            FROM orders
            GROUP BY user_id
            ORDER BY order_count DESC
            LIMIT %s
        """</span>

        all_results = self.aggregate_across_shards(query, (limit * <span class="hljs-number">2</span>,))  <span class="hljs-comment"># Get more from each shard</span>

        <span class="hljs-comment"># Aggregate results across shards</span>
        user_aggregates = {}
        <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> all_results:
            user_id = row[<span class="hljs-string">'user_id'</span>]
            <span class="hljs-keyword">if</span> user_id <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> user_aggregates:
                user_aggregates[user_id] = {
                    <span class="hljs-string">'user_id'</span>: user_id,
                    <span class="hljs-string">'order_count'</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">'total_spent'</span>: <span class="hljs-number">0</span>
                }

            user_aggregates[user_id][<span class="hljs-string">'order_count'</span>] += row[<span class="hljs-string">'order_count'</span>]
            user_aggregates[user_id][<span class="hljs-string">'total_spent'</span>] += row[<span class="hljs-string">'total_spent'</span>]

        <span class="hljs-comment"># Sort and return top users</span>
        sorted_users = sorted(
            user_aggregates.values(),
            key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-string">'order_count'</span>],
            reverse=<span class="hljs-literal">True</span>
        )

        <span class="hljs-keyword">return</span> sorted_users[:limit]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">search_users_by_email</span><span class="hljs-params">(self, email_pattern)</span>:</span>
        <span class="hljs-string">"""Search for users by email pattern across all shards"""</span>
        query = <span class="hljs-string">"SELECT * FROM users WHERE email LIKE %s"</span>
        <span class="hljs-keyword">return</span> self.aggregate_across_shards(query, (<span class="hljs-string">f"%<span class="hljs-subst">{email_pattern}</span>%"</span>,))

<span class="hljs-comment"># Usage</span>
dist_query = DistributedQueryManager(router)

<span class="hljs-comment"># Get global statistics</span>
total_users = dist_query.get_global_user_count()
top_users = dist_query.get_top_users_by_orders(<span class="hljs-number">10</span>)

<span class="hljs-comment"># Search across shards</span>
users = dist_query.search_users_by_email(<span class="hljs-string">"gmail.com"</span>)
</div></code></pre>
<h3 id="distributed-transactions">Distributed Transactions</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> contextmanager

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DistributedTransactionManager</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, shard_router)</span>:</span>
        self.router = shard_router

<span class="hljs-meta">    @contextmanager</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">distributed_transaction</span><span class="hljs-params">(self, shard_ids)</span>:</span>
        <span class="hljs-string">"""Two-phase commit across multiple shards"""</span>
        connections = {}
        transactions = {}

        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># Phase 1: Prepare all transactions</span>
            <span class="hljs-keyword">for</span> shard_id <span class="hljs-keyword">in</span> shard_ids:
                shard = self.router.shards[shard_id]
                conn = shard.connect()
                trans = conn.begin()

                connections[shard_id] = conn
                transactions[shard_id] = trans

            <span class="hljs-keyword">yield</span> connections

            <span class="hljs-comment"># Phase 2: Commit all transactions</span>
            <span class="hljs-keyword">for</span> shard_id <span class="hljs-keyword">in</span> shard_ids:
                transactions[shard_id].commit()

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-comment"># Rollback all transactions on error</span>
            <span class="hljs-keyword">for</span> shard_id <span class="hljs-keyword">in</span> shard_ids:
                <span class="hljs-keyword">if</span> shard_id <span class="hljs-keyword">in</span> transactions:
                    <span class="hljs-keyword">try</span>:
                        transactions[shard_id].rollback()
                    <span class="hljs-keyword">except</span>:
                        <span class="hljs-keyword">pass</span>
            <span class="hljs-keyword">raise</span> e

        <span class="hljs-keyword">finally</span>:
            <span class="hljs-comment"># Close all connections</span>
            <span class="hljs-keyword">for</span> conn <span class="hljs-keyword">in</span> connections.values():
                conn.close()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">transfer_user_data</span><span class="hljs-params">(self, from_user_id, to_user_id, amount)</span>:</span>
        <span class="hljs-string">"""Transfer data between users potentially on different shards"""</span>
        from_shard_id = hash(str(from_user_id)) % len(self.router.shards)
        to_shard_id = hash(str(to_user_id)) % len(self.router.shards)

        shard_ids = list(set([from_shard_id, to_shard_id]))

        <span class="hljs-keyword">with</span> self.distributed_transaction(shard_ids) <span class="hljs-keyword">as</span> connections:
            <span class="hljs-comment"># Deduct from source user</span>
            from_conn = connections[from_shard_id]
            from_conn.execute(<span class="hljs-string">"""
                UPDATE user_balances
                SET balance = balance - %s
                WHERE user_id = %s AND balance &gt;= %s
            """</span>, (amount, from_user_id, amount))

            <span class="hljs-comment"># Add to destination user</span>
            to_conn = connections[to_shard_id]
            to_conn.execute(<span class="hljs-string">"""
                UPDATE user_balances
                SET balance = balance + %s
                WHERE user_id = %s
            """</span>, (amount, to_user_id))

            <span class="hljs-comment"># Log transaction in both shards if different</span>
            <span class="hljs-keyword">if</span> from_shard_id != to_shard_id:
                from_conn.execute(<span class="hljs-string">"""
                    INSERT INTO transfer_logs (from_user_id, to_user_id, amount, type)
                    VALUES (%s, %s, %s, 'outgoing')
                """</span>, (from_user_id, to_user_id, amount))

                to_conn.execute(<span class="hljs-string">"""
                    INSERT INTO transfer_logs (from_user_id, to_user_id, amount, type)
                    VALUES (%s, %s, %s, 'incoming')
                """</span>, (from_user_id, to_user_id, amount))
            <span class="hljs-keyword">else</span>:
                from_conn.execute(<span class="hljs-string">"""
                    INSERT INTO transfer_logs (from_user_id, to_user_id, amount, type)
                    VALUES (%s, %s, %s, 'internal')
                """</span>, (from_user_id, to_user_id, amount))

<span class="hljs-comment"># Usage</span>
dist_tx = DistributedTransactionManager(router)

<span class="hljs-comment"># Transfer between users (potentially on different shards)</span>
<span class="hljs-keyword">try</span>:
    dist_tx.transfer_user_data(<span class="hljs-number">12345</span>, <span class="hljs-number">67890</span>, <span class="hljs-number">100.00</span>)
    print(<span class="hljs-string">"Transfer completed successfully"</span>)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    print(<span class="hljs-string">f"Transfer failed: <span class="hljs-subst">{e}</span>"</span>)
</div></code></pre>
<hr>
<h2 id="%E2%9A%96%EF%B8%8F-shard-rebalancing">âš–ï¸ Shard Rebalancing</h2>
<h3 id="consistent-hashing">Consistent Hashing</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> hashlib
<span class="hljs-keyword">import</span> bisect

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsistentHashRouter</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, shards, virtual_nodes=<span class="hljs-number">150</span>)</span>:</span>
        self.shards = shards
        self.virtual_nodes = virtual_nodes
        self.ring = {}
        self.sorted_keys = []

        self._build_ring()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_hash</span><span class="hljs-params">(self, key)</span>:</span>
        <span class="hljs-string">"""Hash function for consistent hashing"""</span>
        <span class="hljs-keyword">return</span> int(hashlib.md5(str(key).encode()).hexdigest(), <span class="hljs-number">16</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_build_ring</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Build the consistent hash ring"""</span>
        <span class="hljs-keyword">for</span> shard_id <span class="hljs-keyword">in</span> self.shards:
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(self.virtual_nodes):
                virtual_key = self._hash(<span class="hljs-string">f"<span class="hljs-subst">{shard_id}</span>:<span class="hljs-subst">{i}</span>"</span>)
                self.ring[virtual_key] = shard_id

        self.sorted_keys = sorted(self.ring.keys())

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_shard</span><span class="hljs-params">(self, key)</span>:</span>
        <span class="hljs-string">"""Get shard for given key"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.ring:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

        hash_key = self._hash(key)

        <span class="hljs-comment"># Find the first shard clockwise from the hash</span>
        idx = bisect.bisect_right(self.sorted_keys, hash_key)
        <span class="hljs-keyword">if</span> idx == len(self.sorted_keys):
            idx = <span class="hljs-number">0</span>

        <span class="hljs-keyword">return</span> self.ring[self.sorted_keys[idx]]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_shard</span><span class="hljs-params">(self, shard_id)</span>:</span>
        <span class="hljs-string">"""Add new shard to the ring"""</span>
        self.shards.append(shard_id)

        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(self.virtual_nodes):
            virtual_key = self._hash(<span class="hljs-string">f"<span class="hljs-subst">{shard_id}</span>:<span class="hljs-subst">{i}</span>"</span>)
            self.ring[virtual_key] = shard_id

        self.sorted_keys = sorted(self.ring.keys())

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">remove_shard</span><span class="hljs-params">(self, shard_id)</span>:</span>
        <span class="hljs-string">"""Remove shard from the ring"""</span>
        self.shards.remove(shard_id)

        <span class="hljs-comment"># Remove virtual nodes for this shard</span>
        keys_to_remove = []
        <span class="hljs-keyword">for</span> key, shard <span class="hljs-keyword">in</span> self.ring.items():
            <span class="hljs-keyword">if</span> shard == shard_id:
                keys_to_remove.append(key)

        <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> keys_to_remove:
            <span class="hljs-keyword">del</span> self.ring[key]

        self.sorted_keys = sorted(self.ring.keys())

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_affected_keys</span><span class="hljs-params">(self, old_shard, new_shard, key_range)</span>:</span>
        <span class="hljs-string">"""Get keys that need to be moved when rebalancing"""</span>
        affected_keys = []

        <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> key_range:
            current_shard = self.get_shard(key)
            <span class="hljs-keyword">if</span> current_shard != old_shard:
                affected_keys.append(key)

        <span class="hljs-keyword">return</span> affected_keys

<span class="hljs-comment"># Usage</span>
shards = [<span class="hljs-string">'shard0'</span>, <span class="hljs-string">'shard1'</span>, <span class="hljs-string">'shard2'</span>, <span class="hljs-string">'shard3'</span>]
consistent_router = ConsistentHashRouter(shards)

<span class="hljs-comment"># Test distribution</span>
user_ids = range(<span class="hljs-number">1</span>, <span class="hljs-number">10001</span>)
shard_distribution = {}

<span class="hljs-keyword">for</span> user_id <span class="hljs-keyword">in</span> user_ids:
    shard = consistent_router.get_shard(user_id)
    shard_distribution[shard] = shard_distribution.get(shard, <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>

print(<span class="hljs-string">"Distribution before adding shard:"</span>)
<span class="hljs-keyword">for</span> shard, count <span class="hljs-keyword">in</span> shard_distribution.items():
    print(<span class="hljs-string">f"<span class="hljs-subst">{shard}</span>: <span class="hljs-subst">{count}</span> users (<span class="hljs-subst">{count/len(user_ids)*<span class="hljs-number">100</span>:<span class="hljs-number">.1</span>f}</span>%)"</span>)

<span class="hljs-comment"># Add new shard</span>
consistent_router.add_shard(<span class="hljs-string">'shard4'</span>)

<span class="hljs-comment"># Check new distribution</span>
new_distribution = {}
<span class="hljs-keyword">for</span> user_id <span class="hljs-keyword">in</span> user_ids:
    shard = consistent_router.get_shard(user_id)
    new_distribution[shard] = new_distribution.get(shard, <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>

print(<span class="hljs-string">"\nDistribution after adding shard4:"</span>)
<span class="hljs-keyword">for</span> shard, count <span class="hljs-keyword">in</span> new_distribution.items():
    print(<span class="hljs-string">f"<span class="hljs-subst">{shard}</span>: <span class="hljs-subst">{count}</span> users (<span class="hljs-subst">{count/len(user_ids)*<span class="hljs-number">100</span>:<span class="hljs-number">.1</span>f}</span>%)"</span>)
</div></code></pre>
<h3 id="data-migration">Data Migration</h3>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShardMigrationManager</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, source_router, target_router)</span>:</span>
        self.source_router = source_router
        self.target_router = target_router

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">migrate_user_data</span><span class="hljs-params">(self, user_id)</span>:</span>
        <span class="hljs-string">"""Migrate single user's data between shards"""</span>
        source_shard = self.source_router.get_shard(user_id)
        target_shard = self.target_router.get_shard(user_id)

        <span class="hljs-keyword">if</span> source_shard == target_shard:
            <span class="hljs-keyword">return</span>  <span class="hljs-comment"># No migration needed</span>

        source_conn = self.source_router.shards[source_shard].connect()
        target_conn = self.target_router.shards[target_shard].connect()

        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> source_conn.begin() <span class="hljs-keyword">as</span> source_tx:
                <span class="hljs-keyword">with</span> target_conn.begin() <span class="hljs-keyword">as</span> target_tx:
                    <span class="hljs-comment"># Copy user data</span>
                    user_data = source_conn.execute(
                        <span class="hljs-string">"SELECT * FROM users WHERE id = %s"</span>, (user_id,)
                    ).fetchone()

                    <span class="hljs-keyword">if</span> user_data:
                        target_conn.execute(<span class="hljs-string">"""
                            INSERT INTO users (id, username, email, created_at)
                            VALUES (%(id)s, %(username)s, %(email)s, %(created_at)s)
                            ON DUPLICATE KEY UPDATE
                            username = VALUES(username),
                            email = VALUES(email)
                        """</span>, dict(user_data))

                    <span class="hljs-comment"># Copy user orders</span>
                    orders = source_conn.execute(
                        <span class="hljs-string">"SELECT * FROM orders WHERE user_id = %s"</span>, (user_id,)
                    ).fetchall()

                    <span class="hljs-keyword">for</span> order <span class="hljs-keyword">in</span> orders:
                        target_conn.execute(<span class="hljs-string">"""
                            INSERT INTO orders (id, user_id, total_amount, status, created_at)
                            VALUES (%(id)s, %(user_id)s, %(total_amount)s, %(status)s, %(created_at)s)
                            ON DUPLICATE KEY UPDATE
                            total_amount = VALUES(total_amount),
                            status = VALUES(status)
                        """</span>, dict(order))

                        <span class="hljs-comment"># Copy order items</span>
                        order_items = source_conn.execute(
                            <span class="hljs-string">"SELECT * FROM order_items WHERE order_id = %s"</span>, (order[<span class="hljs-string">'id'</span>],)
                        ).fetchall()

                        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> order_items:
                            target_conn.execute(<span class="hljs-string">"""
                                INSERT INTO order_items (id, order_id, product_id, quantity, price)
                                VALUES (%(id)s, %(order_id)s, %(product_id)s, %(quantity)s, %(price)s)
                                ON DUPLICATE KEY UPDATE
                                quantity = VALUES(quantity),
                                price = VALUES(price)
                            """</span>, dict(item))

                    <span class="hljs-comment"># Verify migration</span>
                    source_count = source_conn.execute(
                        <span class="hljs-string">"SELECT COUNT(*) FROM orders WHERE user_id = %s"</span>, (user_id,)
                    ).scalar()

                    target_count = target_conn.execute(
                        <span class="hljs-string">"SELECT COUNT(*) FROM orders WHERE user_id = %s"</span>, (user_id,)
                    ).scalar()

                    <span class="hljs-keyword">if</span> source_count != target_count:
                        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">f"Migration verification failed: <span class="hljs-subst">{source_count}</span> != <span class="hljs-subst">{target_count}</span>"</span>)

                    <span class="hljs-comment"># Delete from source after successful migration</span>
                    source_conn.execute(<span class="hljs-string">"DELETE FROM order_items WHERE order_id IN (SELECT id FROM orders WHERE user_id = %s)"</span>, (user_id,))
                    source_conn.execute(<span class="hljs-string">"DELETE FROM orders WHERE user_id = %s"</span>, (user_id,))
                    source_conn.execute(<span class="hljs-string">"DELETE FROM users WHERE id = %s"</span>, (user_id,))

        <span class="hljs-keyword">finally</span>:
            source_conn.close()
            target_conn.close()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">migrate_batch</span><span class="hljs-params">(self, user_ids, batch_size=<span class="hljs-number">100</span>)</span>:</span>
        <span class="hljs-string">"""Migrate users in batches"""</span>
        total_users = len(user_ids)
        migrated = <span class="hljs-number">0</span>

        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, total_users, batch_size):
            batch = user_ids[i:i + batch_size]

            <span class="hljs-keyword">for</span> user_id <span class="hljs-keyword">in</span> batch:
                <span class="hljs-keyword">try</span>:
                    self.migrate_user_data(user_id)
                    migrated += <span class="hljs-number">1</span>

                    <span class="hljs-keyword">if</span> migrated % <span class="hljs-number">10</span> == <span class="hljs-number">0</span>:
                        print(<span class="hljs-string">f"Migrated <span class="hljs-subst">{migrated}</span>/<span class="hljs-subst">{total_users}</span> users (<span class="hljs-subst">{migrated/total_users*<span class="hljs-number">100</span>:<span class="hljs-number">.1</span>f}</span>%)"</span>)

                <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                    print(<span class="hljs-string">f"Failed to migrate user <span class="hljs-subst">{user_id}</span>: <span class="hljs-subst">{e}</span>"</span>)

            <span class="hljs-comment"># Small delay between batches</span>
            time.sleep(<span class="hljs-number">0.1</span>)

        print(<span class="hljs-string">f"Migration completed: <span class="hljs-subst">{migrated}</span>/<span class="hljs-subst">{total_users}</span> users migrated"</span>)

<span class="hljs-comment"># Usage</span>
old_router = UserShardRouter(shard_count=<span class="hljs-number">4</span>)
new_router = UserShardRouter(shard_count=<span class="hljs-number">5</span>)  <span class="hljs-comment"># Added one more shard</span>

migration_manager = ShardMigrationManager(old_router, new_router)

<span class="hljs-comment"># Migrate specific users</span>
users_to_migrate = [<span class="hljs-number">12345</span>, <span class="hljs-number">67890</span>, <span class="hljs-number">11111</span>]
migration_manager.migrate_batch(users_to_migrate)
</div></code></pre>
<hr>
<h2 id="%F0%9F%8F%97%EF%B8%8F-real-world-example-e-commerce-sharding-architecture">ğŸ—ï¸ Real-World Example: E-commerce Sharding Architecture</h2>
<h3 id="multi-dimensional-sharding">Multi-Dimensional Sharding</h3>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EcommerceShardingStrategy</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># User shards (by user_id hash)</span>
        self.user_shards = {
            <span class="hljs-number">0</span>: create_engine(<span class="hljs-string">'mysql://user:pass@user-shard-0:3306/ecommerce'</span>),
            <span class="hljs-number">1</span>: create_engine(<span class="hljs-string">'mysql://user:pass@user-shard-1:3306/ecommerce'</span>),
            <span class="hljs-number">2</span>: create_engine(<span class="hljs-string">'mysql://user:pass@user-shard-2:3306/ecommerce'</span>),
            <span class="hljs-number">3</span>: create_engine(<span class="hljs-string">'mysql://user:pass@user-shard-3:3306/ecommerce'</span>)
        }

        <span class="hljs-comment"># Product shards (by category)</span>
        self.product_shards = {
            <span class="hljs-string">'electronics'</span>: create_engine(<span class="hljs-string">'mysql://user:pass@product-electronics:3306/ecommerce'</span>),
            <span class="hljs-string">'clothing'</span>: create_engine(<span class="hljs-string">'mysql://user:pass@product-clothing:3306/ecommerce'</span>),
            <span class="hljs-string">'books'</span>: create_engine(<span class="hljs-string">'mysql://user:pass@product-books:3306/ecommerce'</span>),
            <span class="hljs-string">'home'</span>: create_engine(<span class="hljs-string">'mysql://user:pass@product-home:3306/ecommerce'</span>)
        }

        <span class="hljs-comment"># Order shards (by time + user_id)</span>
        self.order_shards = {
            (<span class="hljs-string">'2024'</span>, <span class="hljs-number">0</span>): create_engine(<span class="hljs-string">'mysql://user:pass@orders-2024-0:3306/ecommerce'</span>),
            (<span class="hljs-string">'2024'</span>, <span class="hljs-number">1</span>): create_engine(<span class="hljs-string">'mysql://user:pass@orders-2024-1:3306/ecommerce'</span>),
            (<span class="hljs-string">'2024'</span>, <span class="hljs-number">2</span>): create_engine(<span class="hljs-string">'mysql://user:pass@orders-2024-2:3306/ecommerce'</span>),
            (<span class="hljs-string">'2024'</span>, <span class="hljs-number">3</span>): create_engine(<span class="hljs-string">'mysql://user:pass@orders-2024-3:3306/ecommerce'</span>)
        }

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_user_shard</span><span class="hljs-params">(self, user_id)</span>:</span>
        <span class="hljs-string">"""Get shard for user data"""</span>
        shard_id = hash(str(user_id)) % len(self.user_shards)
        <span class="hljs-keyword">return</span> self.user_shards[shard_id]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_product_shard</span><span class="hljs-params">(self, category)</span>:</span>
        <span class="hljs-string">"""Get shard for product data"""</span>
        <span class="hljs-keyword">return</span> self.product_shards.get(category, self.product_shards[<span class="hljs-string">'electronics'</span>])

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_order_shard</span><span class="hljs-params">(self, user_id, order_date)</span>:</span>
        <span class="hljs-string">"""Get shard for order data"""</span>
        year = str(order_date.year)
        user_shard_id = hash(str(user_id)) % <span class="hljs-number">4</span>
        <span class="hljs-keyword">return</span> self.order_shards.get((year, user_shard_id))

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_user</span><span class="hljs-params">(self, user_data)</span>:</span>
        <span class="hljs-string">"""Create user in appropriate shard"""</span>
        shard = self.get_user_shard(user_data[<span class="hljs-string">'id'</span>])

        <span class="hljs-keyword">with</span> shard.connect() <span class="hljs-keyword">as</span> conn:
            conn.execute(<span class="hljs-string">"""
                INSERT INTO users (id, username, email, country, created_at)
                VALUES (%(id)s, %(username)s, %(email)s, %(country)s, %(created_at)s)
            """</span>, user_data)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_product</span><span class="hljs-params">(self, product_data)</span>:</span>
        <span class="hljs-string">"""Create product in category-specific shard"""</span>
        shard = self.get_product_shard(product_data[<span class="hljs-string">'category'</span>])

        <span class="hljs-keyword">with</span> shard.connect() <span class="hljs-keyword">as</span> conn:
            conn.execute(<span class="hljs-string">"""
                INSERT INTO products (id, name, category, price, description, created_at)
                VALUES (%(id)s, %(name)s, %(category)s, %(price)s, %(description)s, %(created_at)s)
            """</span>, product_data)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_order</span><span class="hljs-params">(self, order_data)</span>:</span>
        <span class="hljs-string">"""Create order with items from multiple product shards"""</span>
        order_shard = self.get_order_shard(order_data[<span class="hljs-string">'user_id'</span>], order_data[<span class="hljs-string">'created_at'</span>])

        <span class="hljs-keyword">with</span> order_shard.connect() <span class="hljs-keyword">as</span> conn:
            <span class="hljs-keyword">with</span> conn.begin():
                <span class="hljs-comment"># Insert order</span>
                result = conn.execute(<span class="hljs-string">"""
                    INSERT INTO orders (user_id, total_amount, status, created_at)
                    VALUES (%(user_id)s, %(total_amount)s, %(status)s, %(created_at)s)
                """</span>, order_data)

                order_id = result.lastrowid

                <span class="hljs-comment"># Insert order items</span>
                <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> order_data[<span class="hljs-string">'items'</span>]:
                    item[<span class="hljs-string">'order_id'</span>] = order_id
                    conn.execute(<span class="hljs-string">"""
                        INSERT INTO order_items (order_id, product_id, quantity, price)
                        VALUES (%(order_id)s, %(product_id)s, %(quantity)s, %(price)s)
                    """</span>, item)

                <span class="hljs-keyword">return</span> order_id

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_user_orders</span><span class="hljs-params">(self, user_id, start_date=None, end_date=None)</span>:</span>
        <span class="hljs-string">"""Get user orders, potentially from multiple time shards"""</span>
        all_orders = []

        <span class="hljs-comment"># Determine which order shards to query</span>
        <span class="hljs-keyword">if</span> start_date <span class="hljs-keyword">and</span> end_date:
            years = set()
            current_year = start_date.year
            <span class="hljs-keyword">while</span> current_year &lt;= end_date.year:
                years.add(str(current_year))
                current_year += <span class="hljs-number">1</span>
        <span class="hljs-keyword">else</span>:
            years = [<span class="hljs-string">'2024'</span>]  <span class="hljs-comment"># Default to current year</span>

        user_shard_id = hash(str(user_id)) % <span class="hljs-number">4</span>

        <span class="hljs-keyword">for</span> year <span class="hljs-keyword">in</span> years:
            shard_key = (year, user_shard_id)
            <span class="hljs-keyword">if</span> shard_key <span class="hljs-keyword">in</span> self.order_shards:
                shard = self.order_shards[shard_key]

                <span class="hljs-keyword">with</span> shard.connect() <span class="hljs-keyword">as</span> conn:
                    query = <span class="hljs-string">"SELECT * FROM orders WHERE user_id = %s"</span>
                    params = [user_id]

                    <span class="hljs-keyword">if</span> start_date <span class="hljs-keyword">and</span> end_date:
                        query += <span class="hljs-string">" AND created_at BETWEEN %s AND %s"</span>
                        params.extend([start_date, end_date])

                    query += <span class="hljs-string">" ORDER BY created_at DESC"</span>

                    orders = conn.execute(query, params).fetchall()
                    all_orders.extend([dict(order) <span class="hljs-keyword">for</span> order <span class="hljs-keyword">in</span> orders])

        <span class="hljs-comment"># Sort combined results</span>
        <span class="hljs-keyword">return</span> sorted(all_orders, key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-string">'created_at'</span>], reverse=<span class="hljs-literal">True</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_product_analytics</span><span class="hljs-params">(self, category, start_date, end_date)</span>:</span>
        <span class="hljs-string">"""Get product analytics for specific category"""</span>
        product_shard = self.get_product_shard(category)

        <span class="hljs-comment"># Need to query across all order shards for this category</span>
        all_sales = []

        <span class="hljs-keyword">for</span> shard_key, order_shard <span class="hljs-keyword">in</span> self.order_shards.items():
            <span class="hljs-keyword">with</span> order_shard.connect() <span class="hljs-keyword">as</span> conn:
                sales = conn.execute(<span class="hljs-string">"""
                    SELECT
                        oi.product_id,
                        SUM(oi.quantity) as total_quantity,
                        SUM(oi.quantity * oi.price) as total_revenue
                    FROM order_items oi
                    JOIN orders o ON oi.order_id = o.id
                    WHERE o.created_at BETWEEN %s AND %s
                    GROUP BY oi.product_id
                """</span>, (start_date, end_date)).fetchall()

                all_sales.extend([dict(sale) <span class="hljs-keyword">for</span> sale <span class="hljs-keyword">in</span> sales])

        <span class="hljs-comment"># Aggregate sales across shards</span>
        product_totals = {}
        <span class="hljs-keyword">for</span> sale <span class="hljs-keyword">in</span> all_sales:
            product_id = sale[<span class="hljs-string">'product_id'</span>]
            <span class="hljs-keyword">if</span> product_id <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> product_totals:
                product_totals[product_id] = {
                    <span class="hljs-string">'product_id'</span>: product_id,
                    <span class="hljs-string">'total_quantity'</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">'total_revenue'</span>: <span class="hljs-number">0</span>
                }

            product_totals[product_id][<span class="hljs-string">'total_quantity'</span>] += sale[<span class="hljs-string">'total_quantity'</span>]
            product_totals[product_id][<span class="hljs-string">'total_revenue'</span>] += sale[<span class="hljs-string">'total_revenue'</span>]

        <span class="hljs-comment"># Get product details from product shard</span>
        <span class="hljs-keyword">with</span> product_shard.connect() <span class="hljs-keyword">as</span> conn:
            <span class="hljs-keyword">for</span> product_total <span class="hljs-keyword">in</span> product_totals.values():
                product = conn.execute(
                    <span class="hljs-string">"SELECT name, category FROM products WHERE id = %s"</span>,
                    (product_total[<span class="hljs-string">'product_id'</span>],)
                ).fetchone()

                <span class="hljs-keyword">if</span> product:
                    product_total.update(dict(product))

        <span class="hljs-keyword">return</span> list(product_totals.values())

<span class="hljs-comment"># Usage</span>
ecommerce_sharding = EcommerceShardingStrategy()

<span class="hljs-comment"># Create user (routed to user shard)</span>
ecommerce_sharding.create_user({
    <span class="hljs-string">'id'</span>: <span class="hljs-number">12345</span>,
    <span class="hljs-string">'username'</span>: <span class="hljs-string">'john_doe'</span>,
    <span class="hljs-string">'email'</span>: <span class="hljs-string">'john@example.com'</span>,
    <span class="hljs-string">'country'</span>: <span class="hljs-string">'US'</span>,
    <span class="hljs-string">'created_at'</span>: datetime.now()
})

<span class="hljs-comment"># Create products (routed to category shards)</span>
ecommerce_sharding.create_product({
    <span class="hljs-string">'id'</span>: <span class="hljs-number">1001</span>,
    <span class="hljs-string">'name'</span>: <span class="hljs-string">'iPhone 15'</span>,
    <span class="hljs-string">'category'</span>: <span class="hljs-string">'electronics'</span>,
    <span class="hljs-string">'price'</span>: <span class="hljs-number">999.99</span>,
    <span class="hljs-string">'description'</span>: <span class="hljs-string">'Latest iPhone model'</span>,
    <span class="hljs-string">'created_at'</span>: datetime.now()
})

<span class="hljs-comment"># Create order (routed to time+user shard)</span>
order_id = ecommerce_sharding.create_order({
    <span class="hljs-string">'user_id'</span>: <span class="hljs-number">12345</span>,
    <span class="hljs-string">'total_amount'</span>: <span class="hljs-number">1049.98</span>,
    <span class="hljs-string">'status'</span>: <span class="hljs-string">'pending'</span>,
    <span class="hljs-string">'created_at'</span>: datetime.now(),
    <span class="hljs-string">'items'</span>: [
        {<span class="hljs-string">'product_id'</span>: <span class="hljs-number">1001</span>, <span class="hljs-string">'quantity'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'price'</span>: <span class="hljs-number">999.99</span>},
        {<span class="hljs-string">'product_id'</span>: <span class="hljs-number">1002</span>, <span class="hljs-string">'quantity'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'price'</span>: <span class="hljs-number">49.99</span>}
    ]
})

<span class="hljs-comment"># Get user orders (may query multiple time shards)</span>
orders = ecommerce_sharding.get_user_orders(<span class="hljs-number">12345</span>)

<span class="hljs-comment"># Get analytics (aggregates across multiple shards)</span>
electronics_analytics = ecommerce_sharding.get_product_analytics(
    <span class="hljs-string">'electronics'</span>,
    datetime(<span class="hljs-number">2024</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>),
    datetime(<span class="hljs-number">2024</span>, <span class="hljs-number">1</span>, <span class="hljs-number">31</span>)
)
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-interview-questions">ğŸ¯ Interview Questions</h2>
<h3 id="basic-questions">Basic Questions</h3>
<ol>
<li><strong>What's the difference between partitioning and sharding?</strong></li>
<li><strong>What are the main types of partitioning strategies?</strong></li>
<li><strong>How do you choose a good shard key?</strong></li>
</ol>
<h3 id="intermediate-questions">Intermediate Questions</h3>
<ol>
<li><strong>How would you handle cross-shard queries efficiently?</strong></li>
<li><strong>What are the challenges of distributed transactions across shards?</strong></li>
<li><strong>How do you rebalance data when adding new shards?</strong></li>
</ol>
<h3 id="advanced-questions">Advanced Questions</h3>
<ol>
<li><strong>Design a sharding strategy for a global social media platform</strong></li>
<li><strong>How would you implement consistent hashing for dynamic shard management?</strong></li>
<li><strong>What are the trade-offs between different sharding strategies?</strong></li>
</ol>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-common-pitfalls">âš ï¸ Common Pitfalls</h2>
<h3 id="1-poor-shard-key-selection">1. <strong>Poor Shard Key Selection</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Problem: Hotspot sharding</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bad_shard_key</span><span class="hljs-params">(timestamp)</span>:</span>
    <span class="hljs-keyword">return</span> timestamp.hour % <span class="hljs-number">4</span>  <span class="hljs-comment"># All traffic goes to one shard during peak hours</span>

<span class="hljs-comment"># Solution: Combine multiple factors</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">good_shard_key</span><span class="hljs-params">(user_id, timestamp)</span>:</span>
    <span class="hljs-keyword">return</span> hash(<span class="hljs-string">f"<span class="hljs-subst">{user_id}</span>:<span class="hljs-subst">{timestamp.date()}</span>"</span>) % <span class="hljs-number">4</span>
</div></code></pre>
<h3 id="2-cross-shard-join-dependencies">2. <strong>Cross-Shard Join Dependencies</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Problem: Joins across shards are expensive</span>
<span class="hljs-keyword">SELECT</span> u.username, o.total_amount
<span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> u  <span class="hljs-comment">-- On user shard</span>
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> u.id = o.user_id  <span class="hljs-comment">-- On order shard</span>
<span class="hljs-keyword">WHERE</span> o.created_at &gt; <span class="hljs-string">'2024-01-01'</span>;

<span class="hljs-comment">-- Solution: Denormalize or use application-level joins</span>
<span class="hljs-comment">-- Store user info in order records</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> orders <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> username <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>);
</div></code></pre>
<h3 id="3-inadequate-monitoring">3. <strong>Inadequate Monitoring</strong></h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Problem: Not monitoring shard distribution</span>
<span class="hljs-comment"># Solution: Regular distribution analysis</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">analyze_shard_distribution</span><span class="hljs-params">(router, sample_keys)</span>:</span>
    distribution = {}
    <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> sample_keys:
        shard = router.get_shard(key)
        distribution[shard] = distribution.get(shard, <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>

    total = len(sample_keys)
    <span class="hljs-keyword">for</span> shard, count <span class="hljs-keyword">in</span> distribution.items():
        percentage = (count / total) * <span class="hljs-number">100</span>
        print(<span class="hljs-string">f"Shard <span class="hljs-subst">{shard}</span>: <span class="hljs-subst">{count}</span> keys (<span class="hljs-subst">{percentage:<span class="hljs-number">.1</span>f}</span>%)"</span>)

        <span class="hljs-keyword">if</span> percentage &gt; <span class="hljs-number">30</span>:  <span class="hljs-comment"># Alert if any shard has &gt;30% of data</span>
            print(<span class="hljs-string">f"WARNING: Shard <span class="hljs-subst">{shard}</span> is overloaded!"</span>)
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-next-steps">ğŸ¯ Next Steps</h2>
<p>Congratulations! You've mastered database partitioning and sharding. You now understand:</p>
<p>âœ… <strong>Table partitioning strategies and implementation</strong><br>
âœ… <strong>Horizontal and vertical sharding techniques</strong><br>
âœ… <strong>Shard key selection and distribution strategies</strong><br>
âœ… <strong>Cross-shard operations and distributed transactions</strong><br>
âœ… <strong>Rebalancing and migration strategies</strong><br>
âœ… <strong>Real-world sharding architectures</strong></p>
<p><strong>Continue to</strong> â†’ <a href="./21-etl-data-warehousing.md">Chapter 21: ETL &amp; Data Warehousing</a></p>
<hr>
<p><em>You're now equipped to design and implement scalable database architectures that can handle massive datasets across multiple servers!</em> ğŸš€</p>
<h1 id="chapter-21-etl--data-warehousing">Chapter 21: ETL &amp; Data Warehousing</h1>
<h2 id="%F0%9F%93%9A-what-youll-learn">ğŸ“š What You'll Learn</h2>
<p>ETL (Extract, Transform, Load) and data warehousing are fundamental for business intelligence and analytics. This chapter covers data extraction from multiple sources, transformation processes, loading strategies, dimensional modeling, and building robust data pipelines for both MySQL and PostgreSQL environments.</p>
<hr>
<h2 id="%F0%9F%8E%AF-learning-objectives">ğŸ¯ Learning Objectives</h2>
<ul>
<li><strong>ETL Fundamentals</strong>: Understand Extract, Transform, Load processes</li>
<li><strong>Data Extraction</strong>: Pull data from various sources (databases, APIs, files)</li>
<li><strong>Data Transformation</strong>: Clean, validate, and transform data</li>
<li><strong>Data Loading</strong>: Efficiently load data into warehouses</li>
<li><strong>Dimensional Modeling</strong>: Design star and snowflake schemas</li>
<li><strong>Data Pipelines</strong>: Build automated, scalable data workflows</li>
<li><strong>Performance Optimization</strong>: Optimize ETL processes for large datasets</li>
</ul>
<hr>
<h2 id="%F0%9F%93%96-concept-explanation">ğŸ“– Concept Explanation</h2>
<h3 id="what-is-etl">What is ETL?</h3>
<p><strong>ETL</strong> is a data integration process that:</p>
<ul>
<li><strong>Extract</strong>: Retrieves data from source systems</li>
<li><strong>Transform</strong>: Cleans, validates, and converts data</li>
<li><strong>Load</strong>: Inserts processed data into target systems</li>
</ul>
<h3 id="what-is-data-warehousing">What is Data Warehousing?</h3>
<p><strong>Data Warehousing</strong> involves:</p>
<ul>
<li>Centralized repository for integrated data</li>
<li>Optimized for analytical queries (OLAP)</li>
<li>Historical data storage</li>
<li>Support for business intelligence tools</li>
</ul>
<h3 id="etl-vs-elt">ETL vs ELT</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>ETL</th>
<th>ELT</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Processing</strong></td>
<td>Transform before loading</td>
<td>Transform after loading</td>
</tr>
<tr>
<td><strong>Performance</strong></td>
<td>Slower for large datasets</td>
<td>Faster initial loading</td>
</tr>
<tr>
<td><strong>Flexibility</strong></td>
<td>Less flexible</td>
<td>More flexible</td>
</tr>
<tr>
<td><strong>Storage</strong></td>
<td>Requires staging area</td>
<td>Uses target system storage</td>
</tr>
<tr>
<td><strong>Best For</strong></td>
<td>Traditional warehouses</td>
<td>Cloud/modern platforms</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="%F0%9F%94%A7-data-extraction">ğŸ”§ Data Extraction</h2>
<h3 id="database-extraction">Database Extraction</h3>
<h4 id="mysql-source-extraction">MySQL Source Extraction</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> mysql.connector
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta
<span class="hljs-keyword">import</span> logging

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MySQLExtractor</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, config)</span>:</span>
        self.config = config
        self.connection = <span class="hljs-literal">None</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">connect</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Establish database connection"""</span>
        <span class="hljs-keyword">try</span>:
            self.connection = mysql.connector.connect(**self.config)
            logging.info(<span class="hljs-string">"Connected to MySQL source"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logging.error(<span class="hljs-string">f"Failed to connect to MySQL: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_incremental</span><span class="hljs-params">(self, table, timestamp_column, last_extracted)</span>:</span>
        <span class="hljs-string">"""Extract data incrementally based on timestamp"""</span>
        query = <span class="hljs-string">f"""
            SELECT * FROM <span class="hljs-subst">{table}</span>
            WHERE <span class="hljs-subst">{timestamp_column}</span> &gt; %s
            ORDER BY <span class="hljs-subst">{timestamp_column}</span>
        """</span>

        <span class="hljs-keyword">try</span>:
            df = pd.read_sql(query, self.connection, params=[last_extracted])
            logging.info(<span class="hljs-string">f"Extracted <span class="hljs-subst">{len(df)}</span> rows from <span class="hljs-subst">{table}</span>"</span>)
            <span class="hljs-keyword">return</span> df
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logging.error(<span class="hljs-string">f"Failed to extract from <span class="hljs-subst">{table}</span>: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_full</span><span class="hljs-params">(self, table, batch_size=<span class="hljs-number">10000</span>)</span>:</span>
        <span class="hljs-string">"""Extract full table in batches"""</span>
        offset = <span class="hljs-number">0</span>
        all_data = []

        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            query = <span class="hljs-string">f"""
                SELECT * FROM <span class="hljs-subst">{table}</span>
                LIMIT <span class="hljs-subst">{batch_size}</span> OFFSET <span class="hljs-subst">{offset}</span>
            """</span>

            batch_df = pd.read_sql(query, self.connection)

            <span class="hljs-keyword">if</span> batch_df.empty:
                <span class="hljs-keyword">break</span>

            all_data.append(batch_df)
            offset += batch_size
            logging.info(<span class="hljs-string">f"Extracted batch <span class="hljs-subst">{offset//batch_size}</span>, <span class="hljs-subst">{len(batch_df)}</span> rows"</span>)

        <span class="hljs-keyword">if</span> all_data:
            <span class="hljs-keyword">return</span> pd.concat(all_data, ignore_index=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">return</span> pd.DataFrame()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_with_joins</span><span class="hljs-params">(self, query)</span>:</span>
        <span class="hljs-string">"""Extract data using complex queries with joins"""</span>
        <span class="hljs-keyword">try</span>:
            df = pd.read_sql(query, self.connection)
            logging.info(<span class="hljs-string">f"Extracted <span class="hljs-subst">{len(df)}</span> rows from custom query"</span>)
            <span class="hljs-keyword">return</span> df
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logging.error(<span class="hljs-string">f"Failed to execute custom query: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">close</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Close database connection"""</span>
        <span class="hljs-keyword">if</span> self.connection:
            self.connection.close()
            logging.info(<span class="hljs-string">"MySQL connection closed"</span>)

<span class="hljs-comment"># Usage</span>
mysql_config = {
    <span class="hljs-string">'host'</span>: <span class="hljs-string">'localhost'</span>,
    <span class="hljs-string">'user'</span>: <span class="hljs-string">'etl_user'</span>,
    <span class="hljs-string">'password'</span>: <span class="hljs-string">'password'</span>,
    <span class="hljs-string">'database'</span>: <span class="hljs-string">'ecommerce'</span>
}

extractor = MySQLExtractor(mysql_config)
extractor.connect()

<span class="hljs-comment"># Extract incremental data</span>
last_run = datetime.now() - timedelta(days=<span class="hljs-number">1</span>)
orders_df = extractor.extract_incremental(<span class="hljs-string">'orders'</span>, <span class="hljs-string">'created_at'</span>, last_run)

<span class="hljs-comment"># Extract with complex query</span>
customer_analytics_query = <span class="hljs-string">"""
    SELECT
        u.id as user_id,
        u.username,
        u.email,
        COUNT(o.id) as total_orders,
        SUM(o.total_amount) as total_spent,
        AVG(o.total_amount) as avg_order_value,
        MAX(o.created_at) as last_order_date
    FROM users u
    LEFT JOIN orders o ON u.id = o.user_id
    WHERE u.created_at &gt;= %s
    GROUP BY u.id, u.username, u.email
"""</span>

customer_df = extractor.extract_with_joins(customer_analytics_query)
extractor.close()
</div></code></pre>
<h4 id="postgresql-source-extraction">PostgreSQL Source Extraction</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> psycopg2
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostgreSQLExtractor</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, config)</span>:</span>
        self.config = config
        self.engine = <span class="hljs-literal">None</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">connect</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Create SQLAlchemy engine"""</span>
        connection_string = <span class="hljs-string">f"postgresql://<span class="hljs-subst">{self.config[<span class="hljs-string">'user'</span>]}</span>:<span class="hljs-subst">{self.config[<span class="hljs-string">'password'</span>]}</span>@<span class="hljs-subst">{self.config[<span class="hljs-string">'host'</span>]}</span>:<span class="hljs-subst">{self.config[<span class="hljs-string">'port'</span>]}</span>/<span class="hljs-subst">{self.config[<span class="hljs-string">'database'</span>]}</span>"</span>
        self.engine = create_engine(connection_string)
        logging.info(<span class="hljs-string">"Connected to PostgreSQL source"</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_with_cursor</span><span class="hljs-params">(self, query, chunk_size=<span class="hljs-number">10000</span>)</span>:</span>
        <span class="hljs-string">"""Extract large datasets using server-side cursor"""</span>
        connection = self.engine.raw_connection()
        cursor = connection.cursor(<span class="hljs-string">'server_side_cursor'</span>)

        <span class="hljs-keyword">try</span>:
            cursor.execute(query)

            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
                rows = cursor.fetchmany(chunk_size)
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> rows:
                    <span class="hljs-keyword">break</span>

                <span class="hljs-comment"># Convert to DataFrame</span>
                columns = [desc[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> desc <span class="hljs-keyword">in</span> cursor.description]
                chunk_df = pd.DataFrame(rows, columns=columns)

                <span class="hljs-keyword">yield</span> chunk_df

        <span class="hljs-keyword">finally</span>:
            cursor.close()
            connection.close()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_partitioned_table</span><span class="hljs-params">(self, table_name, partition_column, start_date, end_date)</span>:</span>
        <span class="hljs-string">"""Extract from partitioned table with date range"""</span>
        query = <span class="hljs-string">f"""
            SELECT * FROM <span class="hljs-subst">{table_name}</span>
            WHERE <span class="hljs-subst">{partition_column}</span> BETWEEN %s AND %s
            ORDER BY <span class="hljs-subst">{partition_column}</span>
        """</span>

        <span class="hljs-keyword">return</span> pd.read_sql(query, self.engine, params=[start_date, end_date])

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_json_data</span><span class="hljs-params">(self, table, json_column, json_path)</span>:</span>
        <span class="hljs-string">"""Extract and flatten JSON data"""</span>
        query = <span class="hljs-string">f"""
            SELECT
                id,
                <span class="hljs-subst">{json_column}</span>-&gt;&gt;'$.<span class="hljs-subst">{json_path}</span>' as extracted_value,
                <span class="hljs-subst">{json_column}</span>
            FROM <span class="hljs-subst">{table}</span>
            WHERE <span class="hljs-subst">{json_column}</span> IS NOT NULL
        """</span>

        <span class="hljs-keyword">return</span> pd.read_sql(query, self.engine)

<span class="hljs-comment"># Usage</span>
postgres_config = {
    <span class="hljs-string">'host'</span>: <span class="hljs-string">'localhost'</span>,
    <span class="hljs-string">'port'</span>: <span class="hljs-number">5432</span>,
    <span class="hljs-string">'user'</span>: <span class="hljs-string">'etl_user'</span>,
    <span class="hljs-string">'password'</span>: <span class="hljs-string">'password'</span>,
    <span class="hljs-string">'database'</span>: <span class="hljs-string">'analytics'</span>
}

pg_extractor = PostgreSQLExtractor(postgres_config)
pg_extractor.connect()

<span class="hljs-comment"># Extract large dataset in chunks</span>
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> pg_extractor.extract_with_cursor(<span class="hljs-string">"SELECT * FROM large_table"</span>):
    <span class="hljs-comment"># Process each chunk</span>
    print(<span class="hljs-string">f"Processing chunk with <span class="hljs-subst">{len(chunk)}</span> rows"</span>)
</div></code></pre>
<h3 id="api-data-extraction">API Data Extraction</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> List, Dict

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">APIExtractor</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, base_url, api_key=None, rate_limit=<span class="hljs-number">100</span>)</span>:</span>
        self.base_url = base_url
        self.api_key = api_key
        self.rate_limit = rate_limit
        self.session = requests.Session()

        <span class="hljs-keyword">if</span> api_key:
            self.session.headers.update({<span class="hljs-string">'Authorization'</span>: <span class="hljs-string">f'Bearer <span class="hljs-subst">{api_key}</span>'</span>})

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_paginated</span><span class="hljs-params">(self, endpoint, params=None, page_size=<span class="hljs-number">100</span>)</span>:</span>
        <span class="hljs-string">"""Extract data from paginated API"""</span>
        all_data = []
        page = <span class="hljs-number">1</span>

        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            request_params = params.copy() <span class="hljs-keyword">if</span> params <span class="hljs-keyword">else</span> {}
            request_params.update({
                <span class="hljs-string">'page'</span>: page,
                <span class="hljs-string">'per_page'</span>: page_size
            })

            response = self._make_request(endpoint, request_params)

            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> response <span class="hljs-keyword">or</span> <span class="hljs-string">'data'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> response:
                <span class="hljs-keyword">break</span>

            data = response[<span class="hljs-string">'data'</span>]
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data:
                <span class="hljs-keyword">break</span>

            all_data.extend(data)
            page += <span class="hljs-number">1</span>

            <span class="hljs-comment"># Rate limiting</span>
            time.sleep(<span class="hljs-number">1</span> / self.rate_limit)

            logging.info(<span class="hljs-string">f"Extracted page <span class="hljs-subst">{page<span class="hljs-number">-1</span>}</span>, total records: <span class="hljs-subst">{len(all_data)}</span>"</span>)

        <span class="hljs-keyword">return</span> all_data

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_with_cursor</span><span class="hljs-params">(self, endpoint, params=None)</span>:</span>
        <span class="hljs-string">"""Extract data using cursor-based pagination"""</span>
        all_data = []
        cursor = <span class="hljs-literal">None</span>

        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            request_params = params.copy() <span class="hljs-keyword">if</span> params <span class="hljs-keyword">else</span> {}
            <span class="hljs-keyword">if</span> cursor:
                request_params[<span class="hljs-string">'cursor'</span>] = cursor

            response = self._make_request(endpoint, request_params)

            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> response <span class="hljs-keyword">or</span> <span class="hljs-string">'data'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> response:
                <span class="hljs-keyword">break</span>

            data = response[<span class="hljs-string">'data'</span>]
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data:
                <span class="hljs-keyword">break</span>

            all_data.extend(data)
            cursor = response.get(<span class="hljs-string">'next_cursor'</span>)

            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> cursor:
                <span class="hljs-keyword">break</span>

            time.sleep(<span class="hljs-number">1</span> / self.rate_limit)

        <span class="hljs-keyword">return</span> all_data

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_make_request</span><span class="hljs-params">(self, endpoint, params=None)</span>:</span>
        <span class="hljs-string">"""Make HTTP request with error handling"""</span>
        url = <span class="hljs-string">f"<span class="hljs-subst">{self.base_url}</span>/<span class="hljs-subst">{endpoint}</span>"</span>

        <span class="hljs-keyword">try</span>:
            response = self.session.get(url, params=params, timeout=<span class="hljs-number">30</span>)
            response.raise_for_status()
            <span class="hljs-keyword">return</span> response.json()

        <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:
            logging.error(<span class="hljs-string">f"API request failed: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-comment"># Usage</span>
api_extractor = APIExtractor(<span class="hljs-string">'https://api.example.com/v1'</span>, api_key=<span class="hljs-string">'your_api_key'</span>)

<span class="hljs-comment"># Extract customer data</span>
customers = api_extractor.extract_paginated(<span class="hljs-string">'customers'</span>, {<span class="hljs-string">'status'</span>: <span class="hljs-string">'active'</span>})
customer_df = pd.DataFrame(customers)

<span class="hljs-comment"># Extract orders with cursor pagination</span>
orders = api_extractor.extract_with_cursor(<span class="hljs-string">'orders'</span>, {<span class="hljs-string">'date_from'</span>: <span class="hljs-string">'2024-01-01'</span>})
orders_df = pd.DataFrame(orders)
</div></code></pre>
<h3 id="file-data-extraction">File Data Extraction</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> xml.etree.ElementTree <span class="hljs-keyword">as</span> ET
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileExtractor</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, base_path)</span>:</span>
        self.base_path = Path(base_path)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_csv</span><span class="hljs-params">(self, filename, **kwargs)</span>:</span>
        <span class="hljs-string">"""Extract data from CSV files"""</span>
        file_path = self.base_path / filename

        <span class="hljs-keyword">try</span>:
            df = pd.read_csv(file_path, **kwargs)
            logging.info(<span class="hljs-string">f"Extracted <span class="hljs-subst">{len(df)}</span> rows from <span class="hljs-subst">{filename}</span>"</span>)
            <span class="hljs-keyword">return</span> df
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logging.error(<span class="hljs-string">f"Failed to read CSV <span class="hljs-subst">{filename}</span>: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_excel</span><span class="hljs-params">(self, filename, sheet_name=None)</span>:</span>
        <span class="hljs-string">"""Extract data from Excel files"""</span>
        file_path = self.base_path / filename

        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">if</span> sheet_name:
                df = pd.read_excel(file_path, sheet_name=sheet_name)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># Read all sheets</span>
                excel_file = pd.ExcelFile(file_path)
                dfs = {}
                <span class="hljs-keyword">for</span> sheet <span class="hljs-keyword">in</span> excel_file.sheet_names:
                    dfs[sheet] = pd.read_excel(file_path, sheet_name=sheet)
                <span class="hljs-keyword">return</span> dfs

            logging.info(<span class="hljs-string">f"Extracted <span class="hljs-subst">{len(df)}</span> rows from <span class="hljs-subst">{filename}</span>"</span>)
            <span class="hljs-keyword">return</span> df
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logging.error(<span class="hljs-string">f"Failed to read Excel <span class="hljs-subst">{filename}</span>: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_json</span><span class="hljs-params">(self, filename)</span>:</span>
        <span class="hljs-string">"""Extract data from JSON files"""</span>
        file_path = self.base_path / filename

        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> open(file_path, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> f:
                data = json.load(f)

            <span class="hljs-comment"># Convert to DataFrame if it's a list of objects</span>
            <span class="hljs-keyword">if</span> isinstance(data, list):
                df = pd.DataFrame(data)
                logging.info(<span class="hljs-string">f"Extracted <span class="hljs-subst">{len(df)}</span> rows from <span class="hljs-subst">{filename}</span>"</span>)
                <span class="hljs-keyword">return</span> df
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">return</span> data
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logging.error(<span class="hljs-string">f"Failed to read JSON <span class="hljs-subst">{filename}</span>: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_xml</span><span class="hljs-params">(self, filename, record_path)</span>:</span>
        <span class="hljs-string">"""Extract data from XML files"""</span>
        file_path = self.base_path / filename

        <span class="hljs-keyword">try</span>:
            tree = ET.parse(file_path)
            root = tree.getroot()

            records = []
            <span class="hljs-keyword">for</span> record <span class="hljs-keyword">in</span> root.findall(record_path):
                record_data = {}
                <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> record:
                    record_data[child.tag] = child.text
                records.append(record_data)

            df = pd.DataFrame(records)
            logging.info(<span class="hljs-string">f"Extracted <span class="hljs-subst">{len(df)}</span> rows from <span class="hljs-subst">{filename}</span>"</span>)
            <span class="hljs-keyword">return</span> df
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logging.error(<span class="hljs-string">f"Failed to read XML <span class="hljs-subst">{filename}</span>: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_multiple_files</span><span class="hljs-params">(self, pattern, extract_func)</span>:</span>
        <span class="hljs-string">"""Extract data from multiple files matching pattern"""</span>
        files = list(self.base_path.glob(pattern))
        all_data = []

        <span class="hljs-keyword">for</span> file_path <span class="hljs-keyword">in</span> files:
            <span class="hljs-keyword">try</span>:
                df = extract_func(file_path.name)
                df[<span class="hljs-string">'source_file'</span>] = file_path.name
                all_data.append(df)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                logging.error(<span class="hljs-string">f"Failed to process <span class="hljs-subst">{file_path}</span>: <span class="hljs-subst">{e}</span>"</span>)
                <span class="hljs-keyword">continue</span>

        <span class="hljs-keyword">if</span> all_data:
            combined_df = pd.concat(all_data, ignore_index=<span class="hljs-literal">True</span>)
            logging.info(<span class="hljs-string">f"Combined <span class="hljs-subst">{len(files)}</span> files, total <span class="hljs-subst">{len(combined_df)}</span> rows"</span>)
            <span class="hljs-keyword">return</span> combined_df

        <span class="hljs-keyword">return</span> pd.DataFrame()

<span class="hljs-comment"># Usage</span>
file_extractor = FileExtractor(<span class="hljs-string">'/data/sources'</span>)

<span class="hljs-comment"># Extract from single files</span>
sales_df = file_extractor.extract_csv(<span class="hljs-string">'sales_2024.csv'</span>)
products_df = file_extractor.extract_excel(<span class="hljs-string">'products.xlsx'</span>, sheet_name=<span class="hljs-string">'Products'</span>)
config_data = file_extractor.extract_json(<span class="hljs-string">'config.json'</span>)

<span class="hljs-comment"># Extract from multiple CSV files</span>
all_sales = file_extractor.extract_multiple_files(<span class="hljs-string">'sales_*.csv'</span>, file_extractor.extract_csv)
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%84-data-transformation">ğŸ”„ Data Transformation</h2>
<h3 id="data-cleaning-and-validation">Data Cleaning and Validation</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">import</span> re

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataTransformer</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.transformation_log = []

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clean_text_data</span><span class="hljs-params">(self, df, text_columns)</span>:</span>
        <span class="hljs-string">"""Clean and standardize text data"""</span>
        df_clean = df.copy()

        <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> text_columns:
            <span class="hljs-keyword">if</span> col <span class="hljs-keyword">in</span> df_clean.columns:
                <span class="hljs-comment"># Remove extra whitespace</span>
                df_clean[col] = df_clean[col].astype(str).str.strip()

                <span class="hljs-comment"># Standardize case</span>
                df_clean[col] = df_clean[col].str.title()

                <span class="hljs-comment"># Remove special characters (keep alphanumeric and spaces)</span>
                df_clean[col] = df_clean[col].str.replace(<span class="hljs-string">r'[^\w\s]'</span>, <span class="hljs-string">''</span>, regex=<span class="hljs-literal">True</span>)

                <span class="hljs-comment"># Replace multiple spaces with single space</span>
                df_clean[col] = df_clean[col].str.replace(<span class="hljs-string">r'\s+'</span>, <span class="hljs-string">' '</span>, regex=<span class="hljs-literal">True</span>)

        self._log_transformation(<span class="hljs-string">f"Cleaned text columns: <span class="hljs-subst">{text_columns}</span>"</span>)
        <span class="hljs-keyword">return</span> df_clean

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_email</span><span class="hljs-params">(self, df, email_column)</span>:</span>
        <span class="hljs-string">"""Validate and clean email addresses"""</span>
        df_clean = df.copy()

        email_pattern = <span class="hljs-string">r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'</span>

        <span class="hljs-comment"># Mark invalid emails</span>
        df_clean[<span class="hljs-string">'email_valid'</span>] = df_clean[email_column].str.match(email_pattern, na=<span class="hljs-literal">False</span>)

        <span class="hljs-comment"># Clean valid emails</span>
        df_clean[email_column] = df_clean[email_column].str.lower().str.strip()

        invalid_count = (~df_clean[<span class="hljs-string">'email_valid'</span>]).sum()
        self._log_transformation(<span class="hljs-string">f"Email validation: <span class="hljs-subst">{invalid_count}</span> invalid emails found"</span>)

        <span class="hljs-keyword">return</span> df_clean

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">standardize_phone_numbers</span><span class="hljs-params">(self, df, phone_column)</span>:</span>
        <span class="hljs-string">"""Standardize phone number format"""</span>
        df_clean = df.copy()

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clean_phone</span><span class="hljs-params">(phone)</span>:</span>
            <span class="hljs-keyword">if</span> pd.isna(phone):
                <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

            <span class="hljs-comment"># Remove all non-digit characters</span>
            digits = re.sub(<span class="hljs-string">r'\D'</span>, <span class="hljs-string">''</span>, str(phone))

            <span class="hljs-comment"># Handle different formats</span>
            <span class="hljs-keyword">if</span> len(digits) == <span class="hljs-number">10</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-string">f"(<span class="hljs-subst">{digits[:<span class="hljs-number">3</span>]}</span>) <span class="hljs-subst">{digits[<span class="hljs-number">3</span>:<span class="hljs-number">6</span>]}</span>-<span class="hljs-subst">{digits[<span class="hljs-number">6</span>:]}</span>"</span>
            <span class="hljs-keyword">elif</span> len(digits) == <span class="hljs-number">11</span> <span class="hljs-keyword">and</span> digits[<span class="hljs-number">0</span>] == <span class="hljs-string">'1'</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-string">f"(<span class="hljs-subst">{digits[<span class="hljs-number">1</span>:<span class="hljs-number">4</span>]}</span>) <span class="hljs-subst">{digits[<span class="hljs-number">4</span>:<span class="hljs-number">7</span>]}</span>-<span class="hljs-subst">{digits[<span class="hljs-number">7</span>:]}</span>"</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">return</span> digits  <span class="hljs-comment"># Return as-is if format is unclear</span>

        df_clean[<span class="hljs-string">f"<span class="hljs-subst">{phone_column}</span>_standardized"</span>] = df_clean[phone_column].apply(clean_phone)

        self._log_transformation(<span class="hljs-string">f"Standardized phone numbers in <span class="hljs-subst">{phone_column}</span>"</span>)
        <span class="hljs-keyword">return</span> df_clean

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_missing_values</span><span class="hljs-params">(self, df, strategies)</span>:</span>
        <span class="hljs-string">"""Handle missing values with different strategies"""</span>
        df_clean = df.copy()

        <span class="hljs-keyword">for</span> column, strategy <span class="hljs-keyword">in</span> strategies.items():
            <span class="hljs-keyword">if</span> column <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> df_clean.columns:
                <span class="hljs-keyword">continue</span>

            missing_count = df_clean[column].isna().sum()

            <span class="hljs-keyword">if</span> strategy == <span class="hljs-string">'drop'</span>:
                df_clean = df_clean.dropna(subset=[column])
            <span class="hljs-keyword">elif</span> strategy == <span class="hljs-string">'mean'</span>:
                df_clean[column].fillna(df_clean[column].mean(), inplace=<span class="hljs-literal">True</span>)
            <span class="hljs-keyword">elif</span> strategy == <span class="hljs-string">'median'</span>:
                df_clean[column].fillna(df_clean[column].median(), inplace=<span class="hljs-literal">True</span>)
            <span class="hljs-keyword">elif</span> strategy == <span class="hljs-string">'mode'</span>:
                mode_value = df_clean[column].mode().iloc[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> df_clean[column].mode().empty <span class="hljs-keyword">else</span> <span class="hljs-string">'Unknown'</span>
                df_clean[column].fillna(mode_value, inplace=<span class="hljs-literal">True</span>)
            <span class="hljs-keyword">elif</span> isinstance(strategy, (str, int, float)):
                df_clean[column].fillna(strategy, inplace=<span class="hljs-literal">True</span>)

            self._log_transformation(<span class="hljs-string">f"Handled <span class="hljs-subst">{missing_count}</span> missing values in <span class="hljs-subst">{column}</span> using <span class="hljs-subst">{strategy}</span>"</span>)

        <span class="hljs-keyword">return</span> df_clean

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">detect_outliers</span><span class="hljs-params">(self, df, numeric_columns, method=<span class="hljs-string">'iqr'</span>)</span>:</span>
        <span class="hljs-string">"""Detect outliers in numeric data"""</span>
        outliers_info = {}

        <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> numeric_columns:
            <span class="hljs-keyword">if</span> col <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> df.columns <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> pd.api.types.is_numeric_dtype(df[col]):
                <span class="hljs-keyword">continue</span>

            <span class="hljs-keyword">if</span> method == <span class="hljs-string">'iqr'</span>:
                Q1 = df[col].quantile(<span class="hljs-number">0.25</span>)
                Q3 = df[col].quantile(<span class="hljs-number">0.75</span>)
                IQR = Q3 - Q1
                lower_bound = Q1 - <span class="hljs-number">1.5</span> * IQR
                upper_bound = Q3 + <span class="hljs-number">1.5</span> * IQR

                outliers = df[(df[col] &lt; lower_bound) | (df[col] &gt; upper_bound)]

            <span class="hljs-keyword">elif</span> method == <span class="hljs-string">'zscore'</span>:
                z_scores = np.abs((df[col] - df[col].mean()) / df[col].std())
                outliers = df[z_scores &gt; <span class="hljs-number">3</span>]

            outliers_info[col] = {
                <span class="hljs-string">'count'</span>: len(outliers),
                <span class="hljs-string">'percentage'</span>: len(outliers) / len(df) * <span class="hljs-number">100</span>,
                <span class="hljs-string">'outlier_indices'</span>: outliers.index.tolist()
            }

        <span class="hljs-keyword">return</span> outliers_info

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_derived_columns</span><span class="hljs-params">(self, df, derivations)</span>:</span>
        <span class="hljs-string">"""Create derived columns based on existing data"""</span>
        df_enhanced = df.copy()

        <span class="hljs-keyword">for</span> new_col, formula <span class="hljs-keyword">in</span> derivations.items():
            <span class="hljs-keyword">try</span>:
                <span class="hljs-keyword">if</span> callable(formula):
                    df_enhanced[new_col] = formula(df_enhanced)
                <span class="hljs-keyword">else</span>:
                    df_enhanced[new_col] = eval(formula, {<span class="hljs-string">'df'</span>: df_enhanced, <span class="hljs-string">'pd'</span>: pd, <span class="hljs-string">'np'</span>: np})

                self._log_transformation(<span class="hljs-string">f"Created derived column: <span class="hljs-subst">{new_col}</span>"</span>)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                logging.error(<span class="hljs-string">f"Failed to create derived column <span class="hljs-subst">{new_col}</span>: <span class="hljs-subst">{e}</span>"</span>)

        <span class="hljs-keyword">return</span> df_enhanced

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_log_transformation</span><span class="hljs-params">(self, message)</span>:</span>
        <span class="hljs-string">"""Log transformation steps"""</span>
        timestamp = datetime.now().isoformat()
        self.transformation_log.append(<span class="hljs-string">f"<span class="hljs-subst">{timestamp}</span>: <span class="hljs-subst">{message}</span>"</span>)
        logging.info(message)

<span class="hljs-comment"># Usage</span>
transformer = DataTransformer()

<span class="hljs-comment"># Clean customer data</span>
customers_clean = transformer.clean_text_data(
    customers_df,
    [<span class="hljs-string">'first_name'</span>, <span class="hljs-string">'last_name'</span>, <span class="hljs-string">'company'</span>]
)

<span class="hljs-comment"># Validate emails</span>
customers_clean = transformer.validate_email(customers_clean, <span class="hljs-string">'email'</span>)

<span class="hljs-comment"># Standardize phone numbers</span>
customers_clean = transformer.standardize_phone_numbers(customers_clean, <span class="hljs-string">'phone'</span>)

<span class="hljs-comment"># Handle missing values</span>
missing_strategies = {
    <span class="hljs-string">'age'</span>: <span class="hljs-string">'median'</span>,
    <span class="hljs-string">'income'</span>: <span class="hljs-string">'mean'</span>,
    <span class="hljs-string">'city'</span>: <span class="hljs-string">'Unknown'</span>,
    <span class="hljs-string">'country'</span>: <span class="hljs-string">'US'</span>
}
customers_clean = transformer.handle_missing_values(customers_clean, missing_strategies)

<span class="hljs-comment"># Create derived columns</span>
derivations = {
    <span class="hljs-string">'full_name'</span>: <span class="hljs-keyword">lambda</span> df: df[<span class="hljs-string">'first_name'</span>] + <span class="hljs-string">' '</span> + df[<span class="hljs-string">'last_name'</span>],
    <span class="hljs-string">'age_group'</span>: <span class="hljs-keyword">lambda</span> df: pd.cut(df[<span class="hljs-string">'age'</span>], bins=[<span class="hljs-number">0</span>, <span class="hljs-number">25</span>, <span class="hljs-number">35</span>, <span class="hljs-number">50</span>, <span class="hljs-number">65</span>, <span class="hljs-number">100</span>], labels=[<span class="hljs-string">'18-25'</span>, <span class="hljs-string">'26-35'</span>, <span class="hljs-string">'36-50'</span>, <span class="hljs-string">'51-65'</span>, <span class="hljs-string">'65+'</span>]),
    <span class="hljs-string">'customer_lifetime_days'</span>: <span class="hljs-keyword">lambda</span> df: (pd.Timestamp.now() - pd.to_datetime(df[<span class="hljs-string">'created_at'</span>])).dt.days
}
customers_enhanced = transformer.create_derived_columns(customers_clean, derivations)

<span class="hljs-comment"># Check transformation log</span>
<span class="hljs-keyword">for</span> log_entry <span class="hljs-keyword">in</span> transformer.transformation_log:
    print(log_entry)
</div></code></pre>
<h3 id="data-type-conversions-and-formatting">Data Type Conversions and Formatting</h3>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataTypeConverter</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-keyword">pass</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_data_types</span><span class="hljs-params">(self, df, type_mapping)</span>:</span>
        <span class="hljs-string">"""Convert data types based on mapping"""</span>
        df_converted = df.copy()

        <span class="hljs-keyword">for</span> column, target_type <span class="hljs-keyword">in</span> type_mapping.items():
            <span class="hljs-keyword">if</span> column <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> df_converted.columns:
                <span class="hljs-keyword">continue</span>

            <span class="hljs-keyword">try</span>:
                <span class="hljs-keyword">if</span> target_type == <span class="hljs-string">'datetime'</span>:
                    df_converted[column] = pd.to_datetime(df_converted[column])
                <span class="hljs-keyword">elif</span> target_type == <span class="hljs-string">'category'</span>:
                    df_converted[column] = df_converted[column].astype(<span class="hljs-string">'category'</span>)
                <span class="hljs-keyword">elif</span> target_type == <span class="hljs-string">'numeric'</span>:
                    df_converted[column] = pd.to_numeric(df_converted[column], errors=<span class="hljs-string">'coerce'</span>)
                <span class="hljs-keyword">else</span>:
                    df_converted[column] = df_converted[column].astype(target_type)

                logging.info(<span class="hljs-string">f"Converted <span class="hljs-subst">{column}</span> to <span class="hljs-subst">{target_type}</span>"</span>)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                logging.error(<span class="hljs-string">f"Failed to convert <span class="hljs-subst">{column}</span> to <span class="hljs-subst">{target_type}</span>: <span class="hljs-subst">{e}</span>"</span>)

        <span class="hljs-keyword">return</span> df_converted

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">normalize_currency</span><span class="hljs-params">(self, df, currency_columns, target_currency=<span class="hljs-string">'USD'</span>)</span>:</span>
        <span class="hljs-string">"""Normalize currency values"""</span>
        <span class="hljs-comment"># Exchange rates (in real implementation, fetch from API)</span>
        exchange_rates = {
            <span class="hljs-string">'EUR'</span>: <span class="hljs-number">1.1</span>,
            <span class="hljs-string">'GBP'</span>: <span class="hljs-number">1.25</span>,
            <span class="hljs-string">'JPY'</span>: <span class="hljs-number">0.0067</span>,
            <span class="hljs-string">'CAD'</span>: <span class="hljs-number">0.74</span>
        }

        df_normalized = df.copy()

        <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> currency_columns:
            <span class="hljs-keyword">if</span> col <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> df_normalized.columns:
                <span class="hljs-keyword">continue</span>

            <span class="hljs-comment"># Assume currency is in a separate column or can be detected</span>
            currency_col = <span class="hljs-string">f"<span class="hljs-subst">{col}</span>_currency"</span>

            <span class="hljs-keyword">if</span> currency_col <span class="hljs-keyword">in</span> df_normalized.columns:
                <span class="hljs-keyword">for</span> currency, rate <span class="hljs-keyword">in</span> exchange_rates.items():
                    mask = df_normalized[currency_col] == currency
                    df_normalized.loc[mask, col] = df_normalized.loc[mask, col] * rate

                df_normalized[currency_col] = target_currency

            logging.info(<span class="hljs-string">f"Normalized currency for <span class="hljs-subst">{col}</span> to <span class="hljs-subst">{target_currency}</span>"</span>)

        <span class="hljs-keyword">return</span> df_normalized

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">standardize_dates</span><span class="hljs-params">(self, df, date_columns, target_format=<span class="hljs-string">'%Y-%m-%d'</span>)</span>:</span>
        <span class="hljs-string">"""Standardize date formats"""</span>
        df_standardized = df.copy()

        <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> date_columns:
            <span class="hljs-keyword">if</span> col <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> df_standardized.columns:
                <span class="hljs-keyword">continue</span>

            <span class="hljs-comment"># Convert to datetime first</span>
            df_standardized[col] = pd.to_datetime(df_standardized[col], errors=<span class="hljs-string">'coerce'</span>)

            <span class="hljs-comment"># Format as string if needed</span>
            <span class="hljs-keyword">if</span> target_format:
                df_standardized[<span class="hljs-string">f"<span class="hljs-subst">{col}</span>_formatted"</span>] = df_standardized[col].dt.strftime(target_format)

            logging.info(<span class="hljs-string">f"Standardized date format for <span class="hljs-subst">{col}</span>"</span>)

        <span class="hljs-keyword">return</span> df_standardized

<span class="hljs-comment"># Usage</span>
converter = DataTypeConverter()

<span class="hljs-comment"># Convert data types</span>
type_mapping = {
    <span class="hljs-string">'user_id'</span>: <span class="hljs-string">'int64'</span>,
    <span class="hljs-string">'created_at'</span>: <span class="hljs-string">'datetime'</span>,
    <span class="hljs-string">'status'</span>: <span class="hljs-string">'category'</span>,
    <span class="hljs-string">'amount'</span>: <span class="hljs-string">'numeric'</span>
}
orders_converted = converter.convert_data_types(orders_df, type_mapping)

<span class="hljs-comment"># Normalize currencies</span>
orders_normalized = converter.normalize_currency(orders_converted, [<span class="hljs-string">'amount'</span>, <span class="hljs-string">'tax'</span>])

<span class="hljs-comment"># Standardize dates</span>
orders_final = converter.standardize_dates(orders_normalized, [<span class="hljs-string">'created_at'</span>, <span class="hljs-string">'updated_at'</span>])
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%A5-data-loading">ğŸ“¥ Data Loading</h2>
<h3 id="bulk-loading-strategies">Bulk Loading Strategies</h3>
<h4 id="mysql-bulk-loading">MySQL Bulk Loading</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> mysql.connector
<span class="hljs-keyword">from</span> mysql.connector <span class="hljs-keyword">import</span> Error
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> csv
<span class="hljs-keyword">import</span> tempfile

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MySQLLoader</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, config)</span>:</span>
        self.config = config
        self.connection = <span class="hljs-literal">None</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">connect</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Establish database connection"""</span>
        <span class="hljs-keyword">try</span>:
            self.connection = mysql.connector.connect(**self.config)
            self.connection.autocommit = <span class="hljs-literal">False</span>
            logging.info(<span class="hljs-string">"Connected to MySQL target"</span>)
        <span class="hljs-keyword">except</span> Error <span class="hljs-keyword">as</span> e:
            logging.error(<span class="hljs-string">f"Failed to connect to MySQL: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bulk_insert_csv</span><span class="hljs-params">(self, df, table_name, batch_size=<span class="hljs-number">10000</span>)</span>:</span>
        <span class="hljs-string">"""Bulk insert using LOAD DATA INFILE"""</span>
        cursor = self.connection.cursor()

        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># Create temporary CSV file</span>
            <span class="hljs-keyword">with</span> tempfile.NamedTemporaryFile(mode=<span class="hljs-string">'w'</span>, delete=<span class="hljs-literal">False</span>, suffix=<span class="hljs-string">'.csv'</span>) <span class="hljs-keyword">as</span> temp_file:
                df.to_csv(temp_file.name, index=<span class="hljs-literal">False</span>, header=<span class="hljs-literal">False</span>)
                temp_file_path = temp_file.name

            <span class="hljs-comment"># Use LOAD DATA INFILE for fast bulk insert</span>
            load_query = <span class="hljs-string">f"""
                LOAD DATA INFILE '<span class="hljs-subst">{temp_file_path}</span>'
                INTO TABLE <span class="hljs-subst">{table_name}</span>
                FIELDS TERMINATED BY ','
                LINES TERMINATED BY '\n'
                IGNORE 1 LINES
            """</span>

            cursor.execute(load_query)
            self.connection.commit()

            logging.info(<span class="hljs-string">f"Bulk inserted <span class="hljs-subst">{len(df)}</span> rows into <span class="hljs-subst">{table_name}</span>"</span>)

        <span class="hljs-keyword">except</span> Error <span class="hljs-keyword">as</span> e:
            self.connection.rollback()
            logging.error(<span class="hljs-string">f"Bulk insert failed: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">finally</span>:
            cursor.close()
            <span class="hljs-comment"># Clean up temp file</span>
            <span class="hljs-keyword">import</span> os
            <span class="hljs-keyword">if</span> <span class="hljs-string">'temp_file_path'</span> <span class="hljs-keyword">in</span> locals():
                os.unlink(temp_file_path)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">batch_insert</span><span class="hljs-params">(self, df, table_name, batch_size=<span class="hljs-number">1000</span>, on_duplicate=<span class="hljs-string">'IGNORE'</span>)</span>:</span>
        <span class="hljs-string">"""Insert data in batches with duplicate handling"""</span>
        cursor = self.connection.cursor()

        <span class="hljs-keyword">try</span>:
            columns = <span class="hljs-string">', '</span>.join(df.columns)
            placeholders = <span class="hljs-string">', '</span>.join([<span class="hljs-string">'%s'</span>] * len(df.columns))

            <span class="hljs-keyword">if</span> on_duplicate == <span class="hljs-string">'UPDATE'</span>:
                update_clause = <span class="hljs-string">', '</span>.join([<span class="hljs-string">f"<span class="hljs-subst">{col}</span> = VALUES(<span class="hljs-subst">{col}</span>)"</span> <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> df.columns])
                query = <span class="hljs-string">f"""
                    INSERT INTO <span class="hljs-subst">{table_name}</span> (<span class="hljs-subst">{columns}</span>)
                    VALUES (<span class="hljs-subst">{placeholders}</span>)
                    ON DUPLICATE KEY UPDATE <span class="hljs-subst">{update_clause}</span>
                """</span>
            <span class="hljs-keyword">else</span>:
                query = <span class="hljs-string">f"""
                    INSERT <span class="hljs-subst">{on_duplicate}</span> INTO <span class="hljs-subst">{table_name}</span> (<span class="hljs-subst">{columns}</span>)
                    VALUES (<span class="hljs-subst">{placeholders}</span>)
                """</span>

            total_rows = len(df)
            inserted_rows = <span class="hljs-number">0</span>

            <span class="hljs-keyword">for</span> start_idx <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, total_rows, batch_size):
                end_idx = min(start_idx + batch_size, total_rows)
                batch_data = df.iloc[start_idx:end_idx].values.tolist()

                cursor.executemany(query, batch_data)
                inserted_rows += len(batch_data)

                logging.info(<span class="hljs-string">f"Inserted batch <span class="hljs-subst">{start_idx//batch_size + <span class="hljs-number">1</span>}</span>, <span class="hljs-subst">{inserted_rows}</span>/<span class="hljs-subst">{total_rows}</span> rows"</span>)

            self.connection.commit()
            logging.info(<span class="hljs-string">f"Successfully inserted <span class="hljs-subst">{inserted_rows}</span> rows into <span class="hljs-subst">{table_name}</span>"</span>)

        <span class="hljs-keyword">except</span> Error <span class="hljs-keyword">as</span> e:
            self.connection.rollback()
            logging.error(<span class="hljs-string">f"Batch insert failed: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">finally</span>:
            cursor.close()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upsert_data</span><span class="hljs-params">(self, df, table_name, key_columns)</span>:</span>
        <span class="hljs-string">"""Upsert data (insert or update based on key columns)"""</span>
        cursor = self.connection.cursor()

        <span class="hljs-keyword">try</span>:
            columns = <span class="hljs-string">', '</span>.join(df.columns)
            placeholders = <span class="hljs-string">', '</span>.join([<span class="hljs-string">'%s'</span>] * len(df.columns))

            <span class="hljs-comment"># Create update clause for non-key columns</span>
            non_key_columns = [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> df.columns <span class="hljs-keyword">if</span> col <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> key_columns]
            update_clause = <span class="hljs-string">', '</span>.join([<span class="hljs-string">f"<span class="hljs-subst">{col}</span> = VALUES(<span class="hljs-subst">{col}</span>)"</span> <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> non_key_columns])

            query = <span class="hljs-string">f"""
                INSERT INTO <span class="hljs-subst">{table_name}</span> (<span class="hljs-subst">{columns}</span>)
                VALUES (<span class="hljs-subst">{placeholders}</span>)
                ON DUPLICATE KEY UPDATE <span class="hljs-subst">{update_clause}</span>
            """</span>

            data = df.values.tolist()
            cursor.executemany(query, data)

            self.connection.commit()
            logging.info(<span class="hljs-string">f"Upserted <span class="hljs-subst">{len(df)}</span> rows into <span class="hljs-subst">{table_name}</span>"</span>)

        <span class="hljs-keyword">except</span> Error <span class="hljs-keyword">as</span> e:
            self.connection.rollback()
            logging.error(<span class="hljs-string">f"Upsert failed: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">finally</span>:
            cursor.close()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_staging_table</span><span class="hljs-params">(self, table_name, df)</span>:</span>
        <span class="hljs-string">"""Create staging table with same structure as DataFrame"""</span>
        cursor = self.connection.cursor()

        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># Drop staging table if exists</span>
            cursor.execute(<span class="hljs-string">f"DROP TABLE IF EXISTS <span class="hljs-subst">{table_name}</span>_staging"</span>)

            <span class="hljs-comment"># Create staging table structure</span>
            column_definitions = []
            <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> df.columns:
                dtype = df[col].dtype

                <span class="hljs-keyword">if</span> pd.api.types.is_integer_dtype(dtype):
                    sql_type = <span class="hljs-string">"BIGINT"</span>
                <span class="hljs-keyword">elif</span> pd.api.types.is_float_dtype(dtype):
                    sql_type = <span class="hljs-string">"DECIMAL(15,2)"</span>
                <span class="hljs-keyword">elif</span> pd.api.types.is_datetime64_any_dtype(dtype):
                    sql_type = <span class="hljs-string">"DATETIME"</span>
                <span class="hljs-keyword">else</span>:
                    sql_type = <span class="hljs-string">"TEXT"</span>

                column_definitions.append(<span class="hljs-string">f"`<span class="hljs-subst">{col}</span>` <span class="hljs-subst">{sql_type}</span>"</span>)

            create_query = <span class="hljs-string">f"""
                CREATE TABLE <span class="hljs-subst">{table_name}</span>_staging (
                    <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(column_definitions)}</span>
                )
            """</span>

            cursor.execute(create_query)
            self.connection.commit()

            logging.info(<span class="hljs-string">f"Created staging table <span class="hljs-subst">{table_name}</span>_staging"</span>)

        <span class="hljs-keyword">except</span> Error <span class="hljs-keyword">as</span> e:
            self.connection.rollback()
            logging.error(<span class="hljs-string">f"Failed to create staging table: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">finally</span>:
            cursor.close()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">close</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Close database connection"""</span>
        <span class="hljs-keyword">if</span> self.connection:
            self.connection.close()
            logging.info(<span class="hljs-string">"MySQL connection closed"</span>)

<span class="hljs-comment"># Usage</span>
mysql_loader = MySQLLoader(mysql_config)
mysql_loader.connect()

<span class="hljs-comment"># Create staging table</span>
mysql_loader.create_staging_table(<span class="hljs-string">'customers'</span>, customers_enhanced)

<span class="hljs-comment"># Bulk insert into staging</span>
mysql_loader.bulk_insert_csv(customers_enhanced, <span class="hljs-string">'customers_staging'</span>)

<span class="hljs-comment"># Upsert from staging to main table</span>
mysql_loader.upsert_data(customers_enhanced, <span class="hljs-string">'customers'</span>, [<span class="hljs-string">'id'</span>])

mysql_loader.close()
</div></code></pre>
<h4 id="postgresql-bulk-loading">PostgreSQL Bulk Loading</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> psycopg2
<span class="hljs-keyword">from</span> psycopg2.extras <span class="hljs-keyword">import</span> execute_values
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> StringIO

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostgreSQLLoader</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, config)</span>:</span>
        self.config = config
        self.connection = <span class="hljs-literal">None</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">connect</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Establish database connection"""</span>
        <span class="hljs-keyword">try</span>:
            self.connection = psycopg2.connect(**self.config)
            self.connection.autocommit = <span class="hljs-literal">False</span>
            logging.info(<span class="hljs-string">"Connected to PostgreSQL target"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logging.error(<span class="hljs-string">f"Failed to connect to PostgreSQL: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bulk_copy</span><span class="hljs-params">(self, df, table_name)</span>:</span>
        <span class="hljs-string">"""Bulk insert using COPY command"""</span>
        cursor = self.connection.cursor()

        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># Create CSV string buffer</span>
            output = StringIO()
            df.to_csv(output, sep=<span class="hljs-string">'\t'</span>, header=<span class="hljs-literal">False</span>, index=<span class="hljs-literal">False</span>, na_rep=<span class="hljs-string">'\\N'</span>)
            output.seek(<span class="hljs-number">0</span>)

            <span class="hljs-comment"># Use COPY command for fast bulk insert</span>
            cursor.copy_from(
                output,
                table_name,
                columns=df.columns.tolist(),
                sep=<span class="hljs-string">'\t'</span>,
                null=<span class="hljs-string">'\\N'</span>
            )

            self.connection.commit()
            logging.info(<span class="hljs-string">f"Bulk copied <span class="hljs-subst">{len(df)}</span> rows into <span class="hljs-subst">{table_name}</span>"</span>)

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            self.connection.rollback()
            logging.error(<span class="hljs-string">f"Bulk copy failed: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">finally</span>:
            cursor.close()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">batch_upsert</span><span class="hljs-params">(self, df, table_name, key_columns, batch_size=<span class="hljs-number">1000</span>)</span>:</span>
        <span class="hljs-string">"""Batch upsert using ON CONFLICT"""</span>
        cursor = self.connection.cursor()

        <span class="hljs-keyword">try</span>:
            columns = df.columns.tolist()
            placeholders = <span class="hljs-string">', '</span>.join([<span class="hljs-string">'%s'</span>] * len(columns))

            <span class="hljs-comment"># Create conflict resolution clause</span>
            non_key_columns = [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> columns <span class="hljs-keyword">if</span> col <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> key_columns]
            update_clause = <span class="hljs-string">', '</span>.join([<span class="hljs-string">f"<span class="hljs-subst">{col}</span> = EXCLUDED.<span class="hljs-subst">{col}</span>"</span> <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> non_key_columns])
            conflict_columns = <span class="hljs-string">', '</span>.join(key_columns)

            query = <span class="hljs-string">f"""
                INSERT INTO <span class="hljs-subst">{table_name}</span> (<span class="hljs-subst">{<span class="hljs-string">', '</span>.join(columns)}</span>)
                VALUES %s
                ON CONFLICT (<span class="hljs-subst">{conflict_columns}</span>)
                DO UPDATE SET <span class="hljs-subst">{update_clause}</span>
            """</span>

            total_rows = len(df)
            processed_rows = <span class="hljs-number">0</span>

            <span class="hljs-keyword">for</span> start_idx <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, total_rows, batch_size):
                end_idx = min(start_idx + batch_size, total_rows)
                batch_data = df.iloc[start_idx:end_idx].values.tolist()

                execute_values(
                    cursor,
                    query,
                    batch_data,
                    template=<span class="hljs-literal">None</span>,
                    page_size=batch_size
                )

                processed_rows += len(batch_data)
                logging.info(<span class="hljs-string">f"Upserted batch <span class="hljs-subst">{start_idx//batch_size + <span class="hljs-number">1</span>}</span>, <span class="hljs-subst">{processed_rows}</span>/<span class="hljs-subst">{total_rows}</span> rows"</span>)

            self.connection.commit()
            logging.info(<span class="hljs-string">f"Successfully upserted <span class="hljs-subst">{processed_rows}</span> rows into <span class="hljs-subst">{table_name}</span>"</span>)

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            self.connection.rollback()
            logging.error(<span class="hljs-string">f"Batch upsert failed: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">finally</span>:
            cursor.close()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_temp_table</span><span class="hljs-params">(self, table_name, df)</span>:</span>
        <span class="hljs-string">"""Create temporary table for staging"""</span>
        cursor = self.connection.cursor()

        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># Drop temp table if exists</span>
            cursor.execute(<span class="hljs-string">f"DROP TABLE IF EXISTS temp_<span class="hljs-subst">{table_name}</span>"</span>)

            <span class="hljs-comment"># Get column definitions from main table</span>
            cursor.execute(<span class="hljs-string">f"""
                SELECT column_name, data_type, character_maximum_length
                FROM information_schema.columns
                WHERE table_name = '<span class="hljs-subst">{table_name}</span>'
                ORDER BY ordinal_position
            """</span>)

            columns_info = cursor.fetchall()

            <span class="hljs-keyword">if</span> columns_info:
                <span class="hljs-comment"># Use existing table structure</span>
                cursor.execute(<span class="hljs-string">f"CREATE TEMP TABLE temp_<span class="hljs-subst">{table_name}</span> (LIKE <span class="hljs-subst">{table_name}</span>)"</span>)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># Create based on DataFrame structure</span>
                column_definitions = []
                <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> df.columns:
                    dtype = df[col].dtype

                    <span class="hljs-keyword">if</span> pd.api.types.is_integer_dtype(dtype):
                        sql_type = <span class="hljs-string">"BIGINT"</span>
                    <span class="hljs-keyword">elif</span> pd.api.types.is_float_dtype(dtype):
                        sql_type = <span class="hljs-string">"DECIMAL"</span>
                    <span class="hljs-keyword">elif</span> pd.api.types.is_datetime64_any_dtype(dtype):
                        sql_type = <span class="hljs-string">"TIMESTAMP"</span>
                    <span class="hljs-keyword">else</span>:
                        sql_type = <span class="hljs-string">"TEXT"</span>

                    column_definitions.append(<span class="hljs-string">f"<span class="hljs-subst">{col}</span> <span class="hljs-subst">{sql_type}</span>"</span>)

                create_query = <span class="hljs-string">f"""
                    CREATE TEMP TABLE temp_<span class="hljs-subst">{table_name}</span> (
                        <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(column_definitions)}</span>
                    )
                """</span>

                cursor.execute(create_query)

            self.connection.commit()
            logging.info(<span class="hljs-string">f"Created temporary table temp_<span class="hljs-subst">{table_name}</span>"</span>)

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            self.connection.rollback()
            logging.error(<span class="hljs-string">f"Failed to create temp table: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">finally</span>:
            cursor.close()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">merge_from_temp</span><span class="hljs-params">(self, table_name, key_columns)</span>:</span>
        <span class="hljs-string">"""Merge data from temp table to main table"""</span>
        cursor = self.connection.cursor()

        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># Get all columns from temp table</span>
            cursor.execute(<span class="hljs-string">f"""
                SELECT column_name
                FROM information_schema.columns
                WHERE table_name = 'temp_<span class="hljs-subst">{table_name}</span>'
                ORDER BY ordinal_position
            """</span>)

            columns = [row[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor.fetchall()]
            non_key_columns = [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> columns <span class="hljs-keyword">if</span> col <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> key_columns]

            <span class="hljs-comment"># Create merge query</span>
            merge_query = <span class="hljs-string">f"""
                INSERT INTO <span class="hljs-subst">{table_name}</span> (<span class="hljs-subst">{<span class="hljs-string">', '</span>.join(columns)}</span>)
                SELECT <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(columns)}</span>
                FROM temp_<span class="hljs-subst">{table_name}</span>
                ON CONFLICT (<span class="hljs-subst">{<span class="hljs-string">', '</span>.join(key_columns)}</span>)
                DO UPDATE SET
                <span class="hljs-subst">{<span class="hljs-string">', '</span>.join([<span class="hljs-string">f"<span class="hljs-subst">{col}</span> = EXCLUDED.<span class="hljs-subst">{col}</span>"</span> <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> non_key_columns])}</span>
            """</span>

            cursor.execute(merge_query)
            rows_affected = cursor.rowcount

            self.connection.commit()
            logging.info(<span class="hljs-string">f"Merged <span class="hljs-subst">{rows_affected}</span> rows from temp table to <span class="hljs-subst">{table_name}</span>"</span>)

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            self.connection.rollback()
            logging.error(<span class="hljs-string">f"Merge from temp table failed: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">finally</span>:
            cursor.close()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">close</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Close database connection"""</span>
        <span class="hljs-keyword">if</span> self.connection:
            self.connection.close()
            logging.info(<span class="hljs-string">"PostgreSQL connection closed"</span>)

<span class="hljs-comment"># Usage</span>
postgres_loader = PostgreSQLLoader(postgres_config)
postgres_loader.connect()

<span class="hljs-comment"># Create temp table and bulk load</span>
postgres_loader.create_temp_table(<span class="hljs-string">'orders'</span>, orders_final)
postgres_loader.bulk_copy(orders_final, <span class="hljs-string">'temp_orders'</span>)
postgres_loader.merge_from_temp(<span class="hljs-string">'orders'</span>, [<span class="hljs-string">'id'</span>])

postgres_loader.close()
</div></code></pre>
<hr>
<h2 id="%F0%9F%8F%97%EF%B8%8F-dimensional-modeling">ğŸ—ï¸ Dimensional Modeling</h2>
<h3 id="star-schema-design">Star Schema Design</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Fact Table: Sales</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> fact_sales (
    sale_id <span class="hljs-built_in">BIGINT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    date_key <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    customer_key <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    product_key <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    store_key <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    quantity <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    unit_price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    total_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    discount_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    tax_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    profit_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),

    <span class="hljs-comment">-- Foreign keys to dimension tables</span>
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (date_key) <span class="hljs-keyword">REFERENCES</span> dim_date(date_key),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (customer_key) <span class="hljs-keyword">REFERENCES</span> dim_customer(customer_key),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (product_key) <span class="hljs-keyword">REFERENCES</span> dim_product(product_key),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (store_key) <span class="hljs-keyword">REFERENCES</span> dim_store(store_key)
);

<span class="hljs-comment">-- Dimension Table: Date</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> dim_date (
    date_key <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    full_date <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    day_of_week <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    day_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    day_of_month <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    day_of_year <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    week_of_year <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    month_number <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    month_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">quarter</span> <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">year</span> <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    is_weekend <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    is_holiday <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>,
    fiscal_year <span class="hljs-built_in">INT</span>,
    fiscal_quarter <span class="hljs-built_in">INT</span>
);

<span class="hljs-comment">-- Dimension Table: Customer</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> dim_customer (
    customer_key <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    customer_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    first_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    last_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    full_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">200</span>),
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    phone <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    birth_date <span class="hljs-built_in">DATE</span>,
    age_group <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    gender <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">10</span>),
    address_line1 <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    address_line2 <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    city <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    state <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    postal_code <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    country <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    customer_segment <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    registration_date <span class="hljs-built_in">DATE</span>,
    is_active <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">TRUE</span>,

    <span class="hljs-comment">-- SCD Type 2 fields</span>
    effective_date <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    expiry_date <span class="hljs-built_in">DATE</span>,
    is_current <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">TRUE</span>,

    <span class="hljs-keyword">UNIQUE</span>(customer_id, effective_date)
);

<span class="hljs-comment">-- Dimension Table: Product</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> dim_product (
    product_key <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    product_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    product_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    product_description <span class="hljs-built_in">TEXT</span>,
    sku <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    brand <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    <span class="hljs-keyword">category</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    subcategory <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    product_line <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    <span class="hljs-keyword">size</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    color <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    weight <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">8</span>,<span class="hljs-number">2</span>),
    unit_cost <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    list_price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    supplier_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    is_active <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">TRUE</span>,

    <span class="hljs-comment">-- SCD Type 2 fields</span>
    effective_date <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    expiry_date <span class="hljs-built_in">DATE</span>,
    is_current <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">TRUE</span>,

    <span class="hljs-keyword">UNIQUE</span>(product_id, effective_date)
);

<span class="hljs-comment">-- Dimension Table: Store</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> dim_store (
    store_key <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    store_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    store_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    store_type <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    address_line1 <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    address_line2 <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    city <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    state <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    postal_code <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    country <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    region <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    district <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    manager_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    phone <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    opening_date <span class="hljs-built_in">DATE</span>,
    store_size_sqft <span class="hljs-built_in">INT</span>,
    is_active <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">TRUE</span>,

    <span class="hljs-comment">-- SCD Type 2 fields</span>
    effective_date <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    expiry_date <span class="hljs-built_in">DATE</span>,
    is_current <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">TRUE</span>,

    <span class="hljs-keyword">UNIQUE</span>(store_id, effective_date)
);

<span class="hljs-comment">-- Create indexes for performance</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_fact_sales_date <span class="hljs-keyword">ON</span> fact_sales(date_key);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_fact_sales_customer <span class="hljs-keyword">ON</span> fact_sales(customer_key);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_fact_sales_product <span class="hljs-keyword">ON</span> fact_sales(product_key);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_fact_sales_store <span class="hljs-keyword">ON</span> fact_sales(store_key);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_fact_sales_amount <span class="hljs-keyword">ON</span> fact_sales(total_amount);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_dim_date_full_date <span class="hljs-keyword">ON</span> dim_date(full_date);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_dim_date_year_month <span class="hljs-keyword">ON</span> dim_date(<span class="hljs-keyword">year</span>, month_number);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_dim_customer_id <span class="hljs-keyword">ON</span> dim_customer(customer_id);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_dim_customer_current <span class="hljs-keyword">ON</span> dim_customer(is_current);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_dim_customer_segment <span class="hljs-keyword">ON</span> dim_customer(customer_segment);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_dim_product_id <span class="hljs-keyword">ON</span> dim_product(product_id);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_dim_product_current <span class="hljs-keyword">ON</span> dim_product(is_current);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_dim_product_category <span class="hljs-keyword">ON</span> dim_product(<span class="hljs-keyword">category</span>, subcategory);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_dim_store_id <span class="hljs-keyword">ON</span> dim_store(store_id);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_dim_store_current <span class="hljs-keyword">ON</span> dim_store(is_current);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_dim_store_region <span class="hljs-keyword">ON</span> dim_store(region, district);
</div></code></pre>
<h3 id="slowly-changing-dimensions-scd">Slowly Changing Dimensions (SCD)</h3>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SCDManager</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, connection)</span>:</span>
        self.connection = connection

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_scd_type1</span><span class="hljs-params">(self, table_name, new_data, key_column)</span>:</span>
        <span class="hljs-string">"""Handle SCD Type 1 - Overwrite existing data"""</span>
        cursor = self.connection.cursor()

        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">for</span> _, row <span class="hljs-keyword">in</span> new_data.iterrows():
                <span class="hljs-comment"># Get non-key columns for update</span>
                columns = [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> new_data.columns <span class="hljs-keyword">if</span> col != key_column]
                set_clause = <span class="hljs-string">', '</span>.join([<span class="hljs-string">f"<span class="hljs-subst">{col}</span> = %s"</span> <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> columns])

                update_query = <span class="hljs-string">f"""
                    UPDATE <span class="hljs-subst">{table_name}</span>
                    SET <span class="hljs-subst">{set_clause}</span>
                    WHERE <span class="hljs-subst">{key_column}</span> = %s
                """</span>

                values = [row[col] <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> columns] + [row[key_column]]
                cursor.execute(update_query, values)

            self.connection.commit()
            logging.info(<span class="hljs-string">f"Updated <span class="hljs-subst">{len(new_data)}</span> records in <span class="hljs-subst">{table_name}</span> (SCD Type 1)"</span>)

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            self.connection.rollback()
            logging.error(<span class="hljs-string">f"SCD Type 1 update failed: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">finally</span>:
            cursor.close()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_scd_type2</span><span class="hljs-params">(self, table_name, new_data, key_column, effective_date)</span>:</span>
        <span class="hljs-string">"""Handle SCD Type 2 - Keep history with versioning"""</span>
        cursor = self.connection.cursor()

        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">for</span> _, row <span class="hljs-keyword">in</span> new_data.iterrows():
                <span class="hljs-comment"># Check if record exists and is current</span>
                cursor.execute(<span class="hljs-string">f"""
                    SELECT * FROM <span class="hljs-subst">{table_name}</span>
                    WHERE <span class="hljs-subst">{key_column}</span> = %s AND is_current = TRUE
                """</span>, (row[key_column],))

                existing_record = cursor.fetchone()

                <span class="hljs-keyword">if</span> existing_record:
                    <span class="hljs-comment"># Expire the current record</span>
                    cursor.execute(<span class="hljs-string">f"""
                        UPDATE <span class="hljs-subst">{table_name}</span>
                        SET expiry_date = %s, is_current = FALSE
                        WHERE <span class="hljs-subst">{key_column}</span> = %s AND is_current = TRUE
                    """</span>, (effective_date, row[key_column]))

                <span class="hljs-comment"># Insert new version</span>
                columns = list(new_data.columns) + [<span class="hljs-string">'effective_date'</span>, <span class="hljs-string">'expiry_date'</span>, <span class="hljs-string">'is_current'</span>]
                placeholders = <span class="hljs-string">', '</span>.join([<span class="hljs-string">'%s'</span>] * len(columns))

                insert_query = <span class="hljs-string">f"""
                    INSERT INTO <span class="hljs-subst">{table_name}</span> (<span class="hljs-subst">{<span class="hljs-string">', '</span>.join(columns)}</span>)
                    VALUES (<span class="hljs-subst">{placeholders}</span>)
                """</span>

                values = list(row.values) + [effective_date, <span class="hljs-literal">None</span>, <span class="hljs-literal">True</span>]
                cursor.execute(insert_query, values)

            self.connection.commit()
            logging.info(<span class="hljs-string">f"Processed <span class="hljs-subst">{len(new_data)}</span> records in <span class="hljs-subst">{table_name}</span> (SCD Type 2)"</span>)

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            self.connection.rollback()
            logging.error(<span class="hljs-string">f"SCD Type 2 processing failed: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">finally</span>:
            cursor.close()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_scd_type3</span><span class="hljs-params">(self, table_name, new_data, key_column, tracked_columns)</span>:</span>
        <span class="hljs-string">"""Handle SCD Type 3 - Keep limited history in same record"""</span>
        cursor = self.connection.cursor()

        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">for</span> _, row <span class="hljs-keyword">in</span> new_data.iterrows():
                <span class="hljs-comment"># For each tracked column, move current to previous and update current</span>
                set_clauses = []
                values = []

                <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> tracked_columns:
                    set_clauses.append(<span class="hljs-string">f"previous_<span class="hljs-subst">{col}</span> = <span class="hljs-subst">{col}</span>"</span>)
                    set_clauses.append(<span class="hljs-string">f"<span class="hljs-subst">{col}</span> = %s"</span>)
                    values.append(row[col])

                <span class="hljs-comment"># Add other non-tracked columns</span>
                other_columns = [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> new_data.columns
                               <span class="hljs-keyword">if</span> col <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> tracked_columns <span class="hljs-keyword">and</span> col != key_column]

                <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> other_columns:
                    set_clauses.append(<span class="hljs-string">f"<span class="hljs-subst">{col}</span> = %s"</span>)
                    values.append(row[col])

                values.append(row[key_column])

                update_query = <span class="hljs-string">f"""
                    UPDATE <span class="hljs-subst">{table_name}</span>
                    SET <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(set_clauses)}</span>
                    WHERE <span class="hljs-subst">{key_column}</span> = %s
                """</span>

                cursor.execute(update_query, values)

            self.connection.commit()
            logging.info(<span class="hljs-string">f"Updated <span class="hljs-subst">{len(new_data)}</span> records in <span class="hljs-subst">{table_name}</span> (SCD Type 3)"</span>)

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            self.connection.rollback()
            logging.error(<span class="hljs-string">f"SCD Type 3 update failed: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">finally</span>:
            cursor.close()

<span class="hljs-comment"># Usage</span>
scd_manager = SCDManager(postgres_loader.connection)

<span class="hljs-comment"># Handle customer dimension changes</span>
customer_changes = pd.DataFrame([
    {<span class="hljs-string">'customer_id'</span>: <span class="hljs-string">'CUST001'</span>, <span class="hljs-string">'email'</span>: <span class="hljs-string">'newemail@example.com'</span>, <span class="hljs-string">'city'</span>: <span class="hljs-string">'New York'</span>},
    {<span class="hljs-string">'customer_id'</span>: <span class="hljs-string">'CUST002'</span>, <span class="hljs-string">'phone'</span>: <span class="hljs-string">'+1-555-0199'</span>, <span class="hljs-string">'address_line1'</span>: <span class="hljs-string">'456 Oak St'</span>}
])

<span class="hljs-comment"># Type 2 SCD for customer changes (keep history)</span>
scd_manager.handle_scd_type2(
    <span class="hljs-string">'dim_customer'</span>,
    customer_changes,
    <span class="hljs-string">'customer_id'</span>,
    datetime.now().date()
)
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%84-etl-pipeline-orchestration">ğŸ”„ ETL Pipeline Orchestration</h2>
<h3 id="complete-etl-pipeline">Complete ETL Pipeline</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> schedule
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> List, Dict, Any

<span class="hljs-meta">@dataclass</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ETLConfig</span>:</span>
    source_configs: Dict[str, Any]
    target_config: Dict[str, Any]
    transformation_rules: Dict[str, Any]
    schedule_config: Dict[str, Any]
    notification_config: Dict[str, Any]

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ETLPipeline</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, config: ETLConfig)</span>:</span>
        self.config = config
        self.extractors = {}
        self.transformers = {}
        self.loaders = {}
        self.last_run_times = {}

        self._initialize_components()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_initialize_components</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Initialize ETL components"""</span>
        <span class="hljs-comment"># Initialize extractors</span>
        <span class="hljs-keyword">for</span> source_name, source_config <span class="hljs-keyword">in</span> self.config.source_configs.items():
            <span class="hljs-keyword">if</span> source_config[<span class="hljs-string">'type'</span>] == <span class="hljs-string">'mysql'</span>:
                self.extractors[source_name] = MySQLExtractor(source_config[<span class="hljs-string">'connection'</span>])
            <span class="hljs-keyword">elif</span> source_config[<span class="hljs-string">'type'</span>] == <span class="hljs-string">'postgresql'</span>:
                self.extractors[source_name] = PostgreSQLExtractor(source_config[<span class="hljs-string">'connection'</span>])
            <span class="hljs-keyword">elif</span> source_config[<span class="hljs-string">'type'</span>] == <span class="hljs-string">'api'</span>:
                self.extractors[source_name] = APIExtractor(
                    source_config[<span class="hljs-string">'base_url'</span>],
                    source_config.get(<span class="hljs-string">'api_key'</span>)
                )
            <span class="hljs-keyword">elif</span> source_config[<span class="hljs-string">'type'</span>] == <span class="hljs-string">'file'</span>:
                self.extractors[source_name] = FileExtractor(source_config[<span class="hljs-string">'base_path'</span>])

        <span class="hljs-comment"># Initialize transformer</span>
        self.transformer = DataTransformer()

        <span class="hljs-comment"># Initialize loader</span>
        <span class="hljs-keyword">if</span> self.config.target_config[<span class="hljs-string">'type'</span>] == <span class="hljs-string">'mysql'</span>:
            self.loader = MySQLLoader(self.config.target_config[<span class="hljs-string">'connection'</span>])
        <span class="hljs-keyword">elif</span> self.config.target_config[<span class="hljs-string">'type'</span>] == <span class="hljs-string">'postgresql'</span>:
            self.loader = PostgreSQLLoader(self.config.target_config[<span class="hljs-string">'connection'</span>])

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_data</span><span class="hljs-params">(self, source_name: str, extraction_config: Dict)</span> -&gt; pd.DataFrame:</span>
        <span class="hljs-string">"""Extract data from specified source"""</span>
        extractor = self.extractors[source_name]

        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">if</span> extraction_config[<span class="hljs-string">'method'</span>] == <span class="hljs-string">'incremental'</span>:
                last_run = self.last_run_times.get(source_name, datetime.now() - timedelta(days=<span class="hljs-number">1</span>))
                data = extractor.extract_incremental(
                    extraction_config[<span class="hljs-string">'table'</span>],
                    extraction_config[<span class="hljs-string">'timestamp_column'</span>],
                    last_run
                )
            <span class="hljs-keyword">elif</span> extraction_config[<span class="hljs-string">'method'</span>] == <span class="hljs-string">'full'</span>:
                data = extractor.extract_full(extraction_config[<span class="hljs-string">'table'</span>])
            <span class="hljs-keyword">elif</span> extraction_config[<span class="hljs-string">'method'</span>] == <span class="hljs-string">'custom'</span>:
                data = extractor.extract_with_joins(extraction_config[<span class="hljs-string">'query'</span>])

            logging.info(<span class="hljs-string">f"Extracted <span class="hljs-subst">{len(data)}</span> rows from <span class="hljs-subst">{source_name}</span>"</span>)
            <span class="hljs-keyword">return</span> data

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logging.error(<span class="hljs-string">f"Extraction failed for <span class="hljs-subst">{source_name}</span>: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">transform_data</span><span class="hljs-params">(self, data: pd.DataFrame, transformation_rules: Dict)</span> -&gt; pd.DataFrame:</span>
        <span class="hljs-string">"""Apply transformations to data"""</span>
        <span class="hljs-keyword">try</span>:
            transformed_data = data.copy()

            <span class="hljs-comment"># Apply data cleaning</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">'clean_text'</span> <span class="hljs-keyword">in</span> transformation_rules:
                transformed_data = self.transformer.clean_text_data(
                    transformed_data,
                    transformation_rules[<span class="hljs-string">'clean_text'</span>]
                )

            <span class="hljs-comment"># Handle missing values</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">'missing_values'</span> <span class="hljs-keyword">in</span> transformation_rules:
                transformed_data = self.transformer.handle_missing_values(
                    transformed_data,
                    transformation_rules[<span class="hljs-string">'missing_values'</span>]
                )

            <span class="hljs-comment"># Create derived columns</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">'derived_columns'</span> <span class="hljs-keyword">in</span> transformation_rules:
                transformed_data = self.transformer.create_derived_columns(
                    transformed_data,
                    transformation_rules[<span class="hljs-string">'derived_columns'</span>]
                )

            <span class="hljs-comment"># Data type conversions</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">'data_types'</span> <span class="hljs-keyword">in</span> transformation_rules:
                converter = DataTypeConverter()
                transformed_data = converter.convert_data_types(
                    transformed_data,
                    transformation_rules[<span class="hljs-string">'data_types'</span>]
                )

            logging.info(<span class="hljs-string">f"Transformed data: <span class="hljs-subst">{len(transformed_data)}</span> rows"</span>)
            <span class="hljs-keyword">return</span> transformed_data

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logging.error(<span class="hljs-string">f"Transformation failed: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_data</span><span class="hljs-params">(self, data: pd.DataFrame, load_config: Dict)</span>:</span>
        <span class="hljs-string">"""Load data to target system"""</span>
        <span class="hljs-keyword">try</span>:
            self.loader.connect()

            <span class="hljs-keyword">if</span> load_config[<span class="hljs-string">'method'</span>] == <span class="hljs-string">'bulk_insert'</span>:
                self.loader.bulk_insert_csv(data, load_config[<span class="hljs-string">'table'</span>])
            <span class="hljs-keyword">elif</span> load_config[<span class="hljs-string">'method'</span>] == <span class="hljs-string">'batch_insert'</span>:
                self.loader.batch_insert(
                    data,
                    load_config[<span class="hljs-string">'table'</span>],
                    batch_size=load_config.get(<span class="hljs-string">'batch_size'</span>, <span class="hljs-number">1000</span>)
                )
            <span class="hljs-keyword">elif</span> load_config[<span class="hljs-string">'method'</span>] == <span class="hljs-string">'upsert'</span>:
                self.loader.upsert_data(
                    data,
                    load_config[<span class="hljs-string">'table'</span>],
                    load_config[<span class="hljs-string">'key_columns'</span>]
                )

            logging.info(<span class="hljs-string">f"Loaded <span class="hljs-subst">{len(data)}</span> rows to <span class="hljs-subst">{load_config[<span class="hljs-string">'table'</span>]}</span>"</span>)

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logging.error(<span class="hljs-string">f"Loading failed: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">finally</span>:
            self.loader.close()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run_pipeline</span><span class="hljs-params">(self, pipeline_name: str)</span>:</span>
        <span class="hljs-string">"""Run complete ETL pipeline"""</span>
        start_time = datetime.now()
        logging.info(<span class="hljs-string">f"Starting ETL pipeline: <span class="hljs-subst">{pipeline_name}</span>"</span>)

        <span class="hljs-keyword">try</span>:
            pipeline_config = self.config.transformation_rules[pipeline_name]

            <span class="hljs-comment"># Extract phase</span>
            all_data = {}
            <span class="hljs-keyword">for</span> source_name, extraction_config <span class="hljs-keyword">in</span> pipeline_config[<span class="hljs-string">'sources'</span>].items():
                data = self.extract_data(source_name, extraction_config)
                all_data[source_name] = data

            <span class="hljs-comment"># Transform phase</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">'joins'</span> <span class="hljs-keyword">in</span> pipeline_config:
                <span class="hljs-comment"># Handle data joins</span>
                transformed_data = self._join_data(all_data, pipeline_config[<span class="hljs-string">'joins'</span>])
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># Single source transformation</span>
                source_name = list(all_data.keys())[<span class="hljs-number">0</span>]
                transformed_data = all_data[source_name]

            <span class="hljs-comment"># Apply transformations</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">'transformations'</span> <span class="hljs-keyword">in</span> pipeline_config:
                transformed_data = self.transform_data(
                    transformed_data,
                    pipeline_config[<span class="hljs-string">'transformations'</span>]
                )

            <span class="hljs-comment"># Load phase</span>
            self.load_data(transformed_data, pipeline_config[<span class="hljs-string">'target'</span>])

            <span class="hljs-comment"># Update last run time</span>
            self.last_run_times[pipeline_name] = start_time

            duration = datetime.now() - start_time
            logging.info(<span class="hljs-string">f"ETL pipeline <span class="hljs-subst">{pipeline_name}</span> completed in <span class="hljs-subst">{duration}</span>"</span>)

            <span class="hljs-comment"># Send success notification</span>
            self._send_notification(
                <span class="hljs-string">f"ETL Success: <span class="hljs-subst">{pipeline_name}</span>"</span>,
                <span class="hljs-string">f"Pipeline completed successfully. Processed <span class="hljs-subst">{len(transformed_data)}</span> rows in <span class="hljs-subst">{duration}</span>"</span>
            )

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            duration = datetime.now() - start_time
            logging.error(<span class="hljs-string">f"ETL pipeline <span class="hljs-subst">{pipeline_name}</span> failed after <span class="hljs-subst">{duration}</span>: <span class="hljs-subst">{e}</span>"</span>)

            <span class="hljs-comment"># Send failure notification</span>
            self._send_notification(
                <span class="hljs-string">f"ETL Failure: <span class="hljs-subst">{pipeline_name}</span>"</span>,
                <span class="hljs-string">f"Pipeline failed after <span class="hljs-subst">{duration}</span>. Error: <span class="hljs-subst">{str(e)}</span>"</span>
            )
            <span class="hljs-keyword">raise</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_join_data</span><span class="hljs-params">(self, data_sources: Dict[str, pd.DataFrame], join_config: List[Dict])</span> -&gt; pd.DataFrame:</span>
        <span class="hljs-string">"""Join multiple data sources"""</span>
        result_data = <span class="hljs-literal">None</span>

        <span class="hljs-keyword">for</span> join <span class="hljs-keyword">in</span> join_config:
            left_source = join[<span class="hljs-string">'left'</span>]
            right_source = join[<span class="hljs-string">'right'</span>]

            <span class="hljs-keyword">if</span> result_data <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                left_df = data_sources[left_source]
            <span class="hljs-keyword">else</span>:
                left_df = result_data

            right_df = data_sources[right_source]

            result_data = left_df.merge(
                right_df,
                left_on=join[<span class="hljs-string">'left_on'</span>],
                right_on=join[<span class="hljs-string">'right_on'</span>],
                how=join.get(<span class="hljs-string">'how'</span>, <span class="hljs-string">'inner'</span>),
                suffixes=join.get(<span class="hljs-string">'suffixes'</span>, (<span class="hljs-string">''</span>, <span class="hljs-string">'_right'</span>))
            )

        <span class="hljs-keyword">return</span> result_data

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_send_notification</span><span class="hljs-params">(self, subject: str, message: str)</span>:</span>
        <span class="hljs-string">"""Send notification about pipeline status"""</span>
        <span class="hljs-comment"># Implementation depends on notification method (email, Slack, etc.)</span>
        logging.info(<span class="hljs-string">f"Notification: <span class="hljs-subst">{subject}</span> - <span class="hljs-subst">{message}</span>"</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">schedule_pipelines</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Schedule ETL pipelines"""</span>
        <span class="hljs-keyword">for</span> pipeline_name, schedule_config <span class="hljs-keyword">in</span> self.config.schedule_config.items():
            <span class="hljs-keyword">if</span> schedule_config[<span class="hljs-string">'type'</span>] == <span class="hljs-string">'daily'</span>:
                schedule.every().day.at(schedule_config[<span class="hljs-string">'time'</span>]).do(
                    self.run_pipeline, pipeline_name
                )
            <span class="hljs-keyword">elif</span> schedule_config[<span class="hljs-string">'type'</span>] == <span class="hljs-string">'hourly'</span>:
                schedule.every().hour.do(self.run_pipeline, pipeline_name)
            <span class="hljs-keyword">elif</span> schedule_config[<span class="hljs-string">'type'</span>] == <span class="hljs-string">'weekly'</span>:
                getattr(schedule.every(), schedule_config[<span class="hljs-string">'day'</span>]).at(
                    schedule_config[<span class="hljs-string">'time'</span>]
                ).do(self.run_pipeline, pipeline_name)

        logging.info(<span class="hljs-string">"ETL pipelines scheduled"</span>)

        <span class="hljs-comment"># Keep the scheduler running</span>
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            schedule.run_pending()
            time.sleep(<span class="hljs-number">60</span>)  <span class="hljs-comment"># Check every minute</span>

<span class="hljs-comment"># ETL Configuration Example</span>
etl_config = ETLConfig(
    source_configs={
        <span class="hljs-string">'ecommerce_mysql'</span>: {
            <span class="hljs-string">'type'</span>: <span class="hljs-string">'mysql'</span>,
            <span class="hljs-string">'connection'</span>: {
                <span class="hljs-string">'host'</span>: <span class="hljs-string">'localhost'</span>,
                <span class="hljs-string">'user'</span>: <span class="hljs-string">'etl_user'</span>,
                <span class="hljs-string">'password'</span>: <span class="hljs-string">'password'</span>,
                <span class="hljs-string">'database'</span>: <span class="hljs-string">'ecommerce'</span>
            }
        },
        <span class="hljs-string">'analytics_api'</span>: {
            <span class="hljs-string">'type'</span>: <span class="hljs-string">'api'</span>,
            <span class="hljs-string">'base_url'</span>: <span class="hljs-string">'https://api.analytics.com/v1'</span>,
            <span class="hljs-string">'api_key'</span>: <span class="hljs-string">'your_api_key'</span>
        }
    },
    target_config={
        <span class="hljs-string">'type'</span>: <span class="hljs-string">'postgresql'</span>,
        <span class="hljs-string">'connection'</span>: {
            <span class="hljs-string">'host'</span>: <span class="hljs-string">'warehouse.company.com'</span>,
            <span class="hljs-string">'port'</span>: <span class="hljs-number">5432</span>,
            <span class="hljs-string">'user'</span>: <span class="hljs-string">'warehouse_user'</span>,
            <span class="hljs-string">'password'</span>: <span class="hljs-string">'warehouse_password'</span>,
            <span class="hljs-string">'database'</span>: <span class="hljs-string">'data_warehouse'</span>
        }
    },
    transformation_rules={
        <span class="hljs-string">'daily_sales_etl'</span>: {
            <span class="hljs-string">'sources'</span>: {
                <span class="hljs-string">'ecommerce_mysql'</span>: {
                    <span class="hljs-string">'method'</span>: <span class="hljs-string">'incremental'</span>,
                    <span class="hljs-string">'table'</span>: <span class="hljs-string">'orders'</span>,
                    <span class="hljs-string">'timestamp_column'</span>: <span class="hljs-string">'created_at'</span>
                }
            },
            <span class="hljs-string">'transformations'</span>: {
                <span class="hljs-string">'clean_text'</span>: [<span class="hljs-string">'customer_name'</span>, <span class="hljs-string">'product_name'</span>],
                <span class="hljs-string">'missing_values'</span>: {
                    <span class="hljs-string">'discount_amount'</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">'tax_amount'</span>: <span class="hljs-string">'mean'</span>
                },
                <span class="hljs-string">'derived_columns'</span>: {
                    <span class="hljs-string">'profit_margin'</span>: <span class="hljs-keyword">lambda</span> df: (df[<span class="hljs-string">'total_amount'</span>] - df[<span class="hljs-string">'cost_amount'</span>]) / df[<span class="hljs-string">'total_amount'</span>] * <span class="hljs-number">100</span>,
                    <span class="hljs-string">'order_month'</span>: <span class="hljs-keyword">lambda</span> df: pd.to_datetime(df[<span class="hljs-string">'created_at'</span>]).dt.to_period(<span class="hljs-string">'M'</span>)
                },
                <span class="hljs-string">'data_types'</span>: {
                    <span class="hljs-string">'created_at'</span>: <span class="hljs-string">'datetime'</span>,
                    <span class="hljs-string">'total_amount'</span>: <span class="hljs-string">'numeric'</span>
                }
            },
            <span class="hljs-string">'target'</span>: {
                <span class="hljs-string">'method'</span>: <span class="hljs-string">'upsert'</span>,
                <span class="hljs-string">'table'</span>: <span class="hljs-string">'fact_sales'</span>,
                <span class="hljs-string">'key_columns'</span>: [<span class="hljs-string">'order_id'</span>]
            }
        }
    },
    schedule_config={
        <span class="hljs-string">'daily_sales_etl'</span>: {
            <span class="hljs-string">'type'</span>: <span class="hljs-string">'daily'</span>,
            <span class="hljs-string">'time'</span>: <span class="hljs-string">'02:00'</span>
        }
    },
    notification_config={
        <span class="hljs-string">'email'</span>: {
            <span class="hljs-string">'smtp_server'</span>: <span class="hljs-string">'smtp.company.com'</span>,
            <span class="hljs-string">'recipients'</span>: [<span class="hljs-string">'data-team@company.com'</span>]
        }
    }
)

<span class="hljs-comment"># Usage</span>
etl_pipeline = ETLPipeline(etl_config)

<span class="hljs-comment"># Run single pipeline</span>
etl_pipeline.run_pipeline(<span class="hljs-string">'daily_sales_etl'</span>)

<span class="hljs-comment"># Schedule all pipelines</span>
<span class="hljs-comment"># etl_pipeline.schedule_pipelines()</span>
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%8A-data-quality-and-monitoring">ğŸ“Š Data Quality and Monitoring</h2>
<h3 id="data-quality-checks">Data Quality Checks</h3>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataQualityChecker</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.quality_rules = {}
        self.quality_results = []

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_rule</span><span class="hljs-params">(self, rule_name: str, rule_function, severity=<span class="hljs-string">'ERROR'</span>)</span>:</span>
        <span class="hljs-string">"""Add data quality rule"""</span>
        self.quality_rules[rule_name] = {
            <span class="hljs-string">'function'</span>: rule_function,
            <span class="hljs-string">'severity'</span>: severity
        }

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_completeness</span><span class="hljs-params">(self, df: pd.DataFrame, required_columns: List[str])</span> -&gt; Dict:</span>
        <span class="hljs-string">"""Check data completeness"""</span>
        results = {}

        <span class="hljs-keyword">for</span> column <span class="hljs-keyword">in</span> required_columns:
            <span class="hljs-keyword">if</span> column <span class="hljs-keyword">in</span> df.columns:
                null_count = df[column].isnull().sum()
                null_percentage = (null_count / len(df)) * <span class="hljs-number">100</span>

                results[<span class="hljs-string">f"<span class="hljs-subst">{column}</span>_completeness"</span>] = {
                    <span class="hljs-string">'passed'</span>: null_count == <span class="hljs-number">0</span>,
                    <span class="hljs-string">'null_count'</span>: null_count,
                    <span class="hljs-string">'null_percentage'</span>: null_percentage,
                    <span class="hljs-string">'message'</span>: <span class="hljs-string">f"<span class="hljs-subst">{column}</span> has <span class="hljs-subst">{null_count}</span> null values (<span class="hljs-subst">{null_percentage:<span class="hljs-number">.2</span>f}</span>%)"</span>
                }

        <span class="hljs-keyword">return</span> results

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_uniqueness</span><span class="hljs-params">(self, df: pd.DataFrame, unique_columns: List[str])</span> -&gt; Dict:</span>
        <span class="hljs-string">"""Check data uniqueness"""</span>
        results = {}

        <span class="hljs-keyword">for</span> column <span class="hljs-keyword">in</span> unique_columns:
            <span class="hljs-keyword">if</span> column <span class="hljs-keyword">in</span> df.columns:
                total_count = len(df)
                unique_count = df[column].nunique()
                duplicate_count = total_count - unique_count

                results[<span class="hljs-string">f"<span class="hljs-subst">{column}</span>_uniqueness"</span>] = {
                    <span class="hljs-string">'passed'</span>: duplicate_count == <span class="hljs-number">0</span>,
                    <span class="hljs-string">'duplicate_count'</span>: duplicate_count,
                    <span class="hljs-string">'uniqueness_percentage'</span>: (unique_count / total_count) * <span class="hljs-number">100</span>,
                    <span class="hljs-string">'message'</span>: <span class="hljs-string">f"<span class="hljs-subst">{column}</span> has <span class="hljs-subst">{duplicate_count}</span> duplicate values"</span>
                }

        <span class="hljs-keyword">return</span> results

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_data_types</span><span class="hljs-params">(self, df: pd.DataFrame, expected_types: Dict[str, str])</span> -&gt; Dict:</span>
        <span class="hljs-string">"""Check data types"""</span>
        results = {}

        <span class="hljs-keyword">for</span> column, expected_type <span class="hljs-keyword">in</span> expected_types.items():
            <span class="hljs-keyword">if</span> column <span class="hljs-keyword">in</span> df.columns:
                actual_type = str(df[column].dtype)
                type_match = self._types_match(actual_type, expected_type)

                results[<span class="hljs-string">f"<span class="hljs-subst">{column}</span>_data_type"</span>] = {
                    <span class="hljs-string">'passed'</span>: type_match,
                    <span class="hljs-string">'expected_type'</span>: expected_type,
                    <span class="hljs-string">'actual_type'</span>: actual_type,
                    <span class="hljs-string">'message'</span>: <span class="hljs-string">f"<span class="hljs-subst">{column}</span> type mismatch: expected <span class="hljs-subst">{expected_type}</span>, got <span class="hljs-subst">{actual_type}</span>"</span>
                }

        <span class="hljs-keyword">return</span> results

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_value_ranges</span><span class="hljs-params">(self, df: pd.DataFrame, range_rules: Dict[str, Dict])</span> -&gt; Dict:</span>
        <span class="hljs-string">"""Check value ranges"""</span>
        results = {}

        <span class="hljs-keyword">for</span> column, rule <span class="hljs-keyword">in</span> range_rules.items():
            <span class="hljs-keyword">if</span> column <span class="hljs-keyword">in</span> df.columns:
                <span class="hljs-keyword">if</span> <span class="hljs-string">'min'</span> <span class="hljs-keyword">in</span> rule:
                    below_min = (df[column] &lt; rule[<span class="hljs-string">'min'</span>]).sum()
                    results[<span class="hljs-string">f"<span class="hljs-subst">{column}</span>_min_range"</span>] = {
                        <span class="hljs-string">'passed'</span>: below_min == <span class="hljs-number">0</span>,
                        <span class="hljs-string">'violations'</span>: below_min,
                        <span class="hljs-string">'message'</span>: <span class="hljs-string">f"<span class="hljs-subst">{column}</span> has <span class="hljs-subst">{below_min}</span> values below minimum <span class="hljs-subst">{rule[<span class="hljs-string">'min'</span>]}</span>"</span>
                    }

                <span class="hljs-keyword">if</span> <span class="hljs-string">'max'</span> <span class="hljs-keyword">in</span> rule:
                    above_max = (df[column] &gt; rule[<span class="hljs-string">'max'</span>]).sum()
                    results[<span class="hljs-string">f"<span class="hljs-subst">{column}</span>_max_range"</span>] = {
                        <span class="hljs-string">'passed'</span>: above_max == <span class="hljs-number">0</span>,
                        <span class="hljs-string">'violations'</span>: above_max,
                        <span class="hljs-string">'message'</span>: <span class="hljs-string">f"<span class="hljs-subst">{column}</span> has <span class="hljs-subst">{above_max}</span> values above maximum <span class="hljs-subst">{rule[<span class="hljs-string">'max'</span>]}</span>"</span>
                    }

        <span class="hljs-keyword">return</span> results

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_referential_integrity</span><span class="hljs-params">(self, df: pd.DataFrame, reference_data: Dict[str, pd.DataFrame])</span> -&gt; Dict:</span>
        <span class="hljs-string">"""Check referential integrity"""</span>
        results = {}

        <span class="hljs-keyword">for</span> column, ref_df <span class="hljs-keyword">in</span> reference_data.items():
            <span class="hljs-keyword">if</span> column <span class="hljs-keyword">in</span> df.columns:
                ref_column = ref_df.columns[<span class="hljs-number">0</span>]  <span class="hljs-comment"># Assume first column is the key</span>
                valid_values = set(ref_df[ref_column].values)
                df_values = set(df[column].dropna().values)

                invalid_values = df_values - valid_values
                invalid_count = len(invalid_values)

                results[<span class="hljs-string">f"<span class="hljs-subst">{column}</span>_referential_integrity"</span>] = {
                    <span class="hljs-string">'passed'</span>: invalid_count == <span class="hljs-number">0</span>,
                    <span class="hljs-string">'invalid_count'</span>: invalid_count,
                    <span class="hljs-string">'invalid_values'</span>: list(invalid_values)[:<span class="hljs-number">10</span>],  <span class="hljs-comment"># Show first 10</span>
                    <span class="hljs-string">'message'</span>: <span class="hljs-string">f"<span class="hljs-subst">{column}</span> has <span class="hljs-subst">{invalid_count}</span> invalid reference values"</span>
                }

        <span class="hljs-keyword">return</span> results

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run_quality_checks</span><span class="hljs-params">(self, df: pd.DataFrame, rules_config: Dict)</span> -&gt; Dict:</span>
        <span class="hljs-string">"""Run all configured quality checks"""</span>
        all_results = {}

        <span class="hljs-keyword">if</span> <span class="hljs-string">'completeness'</span> <span class="hljs-keyword">in</span> rules_config:
            completeness_results = self.check_completeness(df, rules_config[<span class="hljs-string">'completeness'</span>])
            all_results.update(completeness_results)

        <span class="hljs-keyword">if</span> <span class="hljs-string">'uniqueness'</span> <span class="hljs-keyword">in</span> rules_config:
            uniqueness_results = self.check_uniqueness(df, rules_config[<span class="hljs-string">'uniqueness'</span>])
            all_results.update(uniqueness_results)

        <span class="hljs-keyword">if</span> <span class="hljs-string">'data_types'</span> <span class="hljs-keyword">in</span> rules_config:
            type_results = self.check_data_types(df, rules_config[<span class="hljs-string">'data_types'</span>])
            all_results.update(type_results)

        <span class="hljs-keyword">if</span> <span class="hljs-string">'value_ranges'</span> <span class="hljs-keyword">in</span> rules_config:
            range_results = self.check_value_ranges(df, rules_config[<span class="hljs-string">'value_ranges'</span>])
            all_results.update(range_results)

        <span class="hljs-keyword">if</span> <span class="hljs-string">'referential_integrity'</span> <span class="hljs-keyword">in</span> rules_config:
            ref_results = self.check_referential_integrity(df, rules_config[<span class="hljs-string">'referential_integrity'</span>])
            all_results.update(ref_results)

        <span class="hljs-comment"># Run custom rules</span>
        <span class="hljs-keyword">for</span> rule_name, rule_config <span class="hljs-keyword">in</span> self.quality_rules.items():
            <span class="hljs-keyword">try</span>:
                custom_result = rule_config[<span class="hljs-string">'function'</span>](df)
                all_results[rule_name] = {
                    <span class="hljs-string">'passed'</span>: custom_result,
                    <span class="hljs-string">'severity'</span>: rule_config[<span class="hljs-string">'severity'</span>],
                    <span class="hljs-string">'message'</span>: <span class="hljs-string">f"Custom rule <span class="hljs-subst">{rule_name}</span>: <span class="hljs-subst">{<span class="hljs-string">'PASSED'</span> <span class="hljs-keyword">if</span> custom_result <span class="hljs-keyword">else</span> <span class="hljs-string">'FAILED'</span>}</span>"</span>
                }
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                all_results[rule_name] = {
                    <span class="hljs-string">'passed'</span>: <span class="hljs-literal">False</span>,
                    <span class="hljs-string">'severity'</span>: <span class="hljs-string">'ERROR'</span>,
                    <span class="hljs-string">'message'</span>: <span class="hljs-string">f"Custom rule <span class="hljs-subst">{rule_name}</span> failed with error: <span class="hljs-subst">{str(e)}</span>"</span>
                }

        <span class="hljs-keyword">return</span> all_results

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_types_match</span><span class="hljs-params">(self, actual_type: str, expected_type: str)</span> -&gt; bool:</span>
        <span class="hljs-string">"""Check if data types match"""</span>
        type_mappings = {
            <span class="hljs-string">'int'</span>: [<span class="hljs-string">'int64'</span>, <span class="hljs-string">'int32'</span>, <span class="hljs-string">'int16'</span>, <span class="hljs-string">'int8'</span>],
            <span class="hljs-string">'float'</span>: [<span class="hljs-string">'float64'</span>, <span class="hljs-string">'float32'</span>],
            <span class="hljs-string">'string'</span>: [<span class="hljs-string">'object'</span>, <span class="hljs-string">'string'</span>],
            <span class="hljs-string">'datetime'</span>: [<span class="hljs-string">'datetime64[ns]'</span>, <span class="hljs-string">'datetime64'</span>],
            <span class="hljs-string">'bool'</span>: [<span class="hljs-string">'bool'</span>]
        }

        <span class="hljs-keyword">if</span> expected_type <span class="hljs-keyword">in</span> type_mappings:
            <span class="hljs-keyword">return</span> actual_type <span class="hljs-keyword">in</span> type_mappings[expected_type]

        <span class="hljs-keyword">return</span> actual_type == expected_type

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_quality_report</span><span class="hljs-params">(self, results: Dict)</span> -&gt; str:</span>
        <span class="hljs-string">"""Generate data quality report"""</span>
        report = [<span class="hljs-string">"\n=== DATA QUALITY REPORT ==="</span>]

        passed_count = sum(<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> results.values() <span class="hljs-keyword">if</span> result.get(<span class="hljs-string">'passed'</span>, <span class="hljs-literal">False</span>))
        total_count = len(results)

        report.append(<span class="hljs-string">f"\nOverall: <span class="hljs-subst">{passed_count}</span>/<span class="hljs-subst">{total_count}</span> checks passed (<span class="hljs-subst">{passed_count/total_count*<span class="hljs-number">100</span>:<span class="hljs-number">.1</span>f}</span>%)"</span>)

        <span class="hljs-comment"># Group by severity</span>
        errors = []
        warnings = []
        passed = []

        <span class="hljs-keyword">for</span> check_name, result <span class="hljs-keyword">in</span> results.items():
            <span class="hljs-keyword">if</span> result.get(<span class="hljs-string">'passed'</span>, <span class="hljs-literal">False</span>):
                passed.append((check_name, result))
            <span class="hljs-keyword">elif</span> result.get(<span class="hljs-string">'severity'</span>, <span class="hljs-string">'ERROR'</span>) == <span class="hljs-string">'ERROR'</span>:
                errors.append((check_name, result))
            <span class="hljs-keyword">else</span>:
                warnings.append((check_name, result))

        <span class="hljs-keyword">if</span> errors:
            report.append(<span class="hljs-string">"\nğŸ”´ ERRORS:"</span>)
            <span class="hljs-keyword">for</span> check_name, result <span class="hljs-keyword">in</span> errors:
                report.append(<span class="hljs-string">f"  - <span class="hljs-subst">{check_name}</span>: <span class="hljs-subst">{result[<span class="hljs-string">'message'</span>]}</span>"</span>)

        <span class="hljs-keyword">if</span> warnings:
            report.append(<span class="hljs-string">"\nğŸŸ¡ WARNINGS:"</span>)
            <span class="hljs-keyword">for</span> check_name, result <span class="hljs-keyword">in</span> warnings:
                report.append(<span class="hljs-string">f"  - <span class="hljs-subst">{check_name}</span>: <span class="hljs-subst">{result[<span class="hljs-string">'message'</span>]}</span>"</span>)

        <span class="hljs-keyword">if</span> passed:
            report.append(<span class="hljs-string">f"\nğŸŸ¢ PASSED: <span class="hljs-subst">{len(passed)}</span> checks"</span>)

        <span class="hljs-keyword">return</span> <span class="hljs-string">"\n"</span>.join(report)

<span class="hljs-comment"># Usage</span>
quality_checker = DataQualityChecker()

<span class="hljs-comment"># Add custom rule</span>
quality_checker.add_rule(
    <span class="hljs-string">'positive_amounts'</span>,
    <span class="hljs-keyword">lambda</span> df: (df[<span class="hljs-string">'total_amount'</span>] &gt; <span class="hljs-number">0</span>).all(),
    severity=<span class="hljs-string">'ERROR'</span>
)

<span class="hljs-comment"># Define quality rules</span>
quality_rules = {
    <span class="hljs-string">'completeness'</span>: [<span class="hljs-string">'customer_id'</span>, <span class="hljs-string">'order_date'</span>, <span class="hljs-string">'total_amount'</span>],
    <span class="hljs-string">'uniqueness'</span>: [<span class="hljs-string">'order_id'</span>],
    <span class="hljs-string">'data_types'</span>: {
        <span class="hljs-string">'customer_id'</span>: <span class="hljs-string">'int'</span>,
        <span class="hljs-string">'order_date'</span>: <span class="hljs-string">'datetime'</span>,
        <span class="hljs-string">'total_amount'</span>: <span class="hljs-string">'float'</span>
    },
    <span class="hljs-string">'value_ranges'</span>: {
        <span class="hljs-string">'total_amount'</span>: {<span class="hljs-string">'min'</span>: <span class="hljs-number">0</span>, <span class="hljs-string">'max'</span>: <span class="hljs-number">10000</span>},
        <span class="hljs-string">'quantity'</span>: {<span class="hljs-string">'min'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'max'</span>: <span class="hljs-number">100</span>}
    }
}

<span class="hljs-comment"># Run quality checks</span>
quality_results = quality_checker.run_quality_checks(orders_df, quality_rules)

<span class="hljs-comment"># Generate report</span>
report = quality_checker.generate_quality_report(quality_results)
print(report)
</div></code></pre>
<hr>
<h2 id="%F0%9F%8F%A2-data-warehousing-concepts">ğŸ¢ Data Warehousing Concepts</h2>
<h3 id="star-schema-design">Star Schema Design</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Fact Table: Sales</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> fact_sales (
    sale_id <span class="hljs-built_in">BIGINT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    date_key <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    customer_key <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    product_key <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    store_key <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    quantity <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    unit_price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    total_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    discount_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    tax_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    profit_amount <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,

    <span class="hljs-comment">-- Foreign Keys</span>
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (date_key) <span class="hljs-keyword">REFERENCES</span> dim_date(date_key),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (customer_key) <span class="hljs-keyword">REFERENCES</span> dim_customer(customer_key),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (product_key) <span class="hljs-keyword">REFERENCES</span> dim_product(product_key),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (store_key) <span class="hljs-keyword">REFERENCES</span> dim_store(store_key)
);

<span class="hljs-comment">-- Dimension Table: Date</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> dim_date (
    date_key <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    full_date <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    day_of_week <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">10</span>),
    day_of_month <span class="hljs-built_in">INT</span>,
    day_of_year <span class="hljs-built_in">INT</span>,
    week_of_year <span class="hljs-built_in">INT</span>,
    month_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">10</span>),
    month_number <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">quarter</span> <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">year</span> <span class="hljs-built_in">INT</span>,
    is_weekend <span class="hljs-built_in">BOOLEAN</span>,
    is_holiday <span class="hljs-built_in">BOOLEAN</span>,
    fiscal_year <span class="hljs-built_in">INT</span>,
    fiscal_quarter <span class="hljs-built_in">INT</span>
);

<span class="hljs-comment">-- Dimension Table: Customer</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> dim_customer (
    customer_key <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    customer_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    first_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    last_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    phone <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    birth_date <span class="hljs-built_in">DATE</span>,
    gender <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">10</span>),
    customer_segment <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    registration_date <span class="hljs-built_in">DATE</span>,
    city <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    state <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    country <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    postal_code <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    is_active <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">TRUE</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    updated_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- Dimension Table: Product</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> dim_product (
    product_key <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    product_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    product_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    brand <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    <span class="hljs-keyword">category</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    subcategory <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    product_line <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    unit_cost <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    unit_price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    product_size <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    product_color <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    product_weight <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">8</span>,<span class="hljs-number">2</span>),
    is_active <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">TRUE</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    updated_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- Dimension Table: Store</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> dim_store (
    store_key <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    store_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    store_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    store_type <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    manager_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    address <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    city <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    state <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    country <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    postal_code <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    phone <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">20</span>),
    opening_date <span class="hljs-built_in">DATE</span>,
    store_size_sqft <span class="hljs-built_in">INT</span>,
    is_active <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">TRUE</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    updated_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);
</div></code></pre>
<h3 id="snowflake-schema-example">Snowflake Schema Example</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Normalized Product Dimension</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> dim_product_category (
    category_key <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    category_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    category_description <span class="hljs-built_in">TEXT</span>,
    department <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>)
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> dim_product_brand (
    brand_key <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    brand_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    brand_description <span class="hljs-built_in">TEXT</span>,
    country_of_origin <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>)
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> dim_product_normalized (
    product_key <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    product_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    product_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    category_key <span class="hljs-built_in">INT</span>,
    brand_key <span class="hljs-built_in">INT</span>,
    unit_cost <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    unit_price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    is_active <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">TRUE</span>,

    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (category_key) <span class="hljs-keyword">REFERENCES</span> dim_product_category(category_key),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (brand_key) <span class="hljs-keyword">REFERENCES</span> dim_product_brand(brand_key)
);
</div></code></pre>
<h3 id="slowly-changing-dimensions-scd">Slowly Changing Dimensions (SCD)</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- SCD Type 1: Overwrite</span>
<span class="hljs-keyword">UPDATE</span> dim_customer
<span class="hljs-keyword">SET</span>
    email = <span class="hljs-string">'new_email@example.com'</span>,
    updated_at = <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
<span class="hljs-keyword">WHERE</span> customer_key = <span class="hljs-number">12345</span>;

<span class="hljs-comment">-- SCD Type 2: Add New Record</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> dim_customer_scd2 (
    customer_key <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    customer_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    first_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    last_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    customer_segment <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
    effective_date <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    expiration_date <span class="hljs-built_in">DATE</span>,
    is_current <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">TRUE</span>,
    version_number <span class="hljs-built_in">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>
);

<span class="hljs-comment">-- Insert new version for SCD Type 2</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> dim_customer_scd2 (
    customer_key, customer_id, first_name, last_name,
    email, customer_segment, effective_date, is_current, version_number
)
<span class="hljs-keyword">SELECT</span>
    (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">MAX</span>(customer_key) + <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> dim_customer_scd2),
    customer_id,
    first_name,
    last_name,
    <span class="hljs-string">'updated_email@example.com'</span>,
    <span class="hljs-string">'Premium'</span>,
    <span class="hljs-keyword">CURRENT_DATE</span>,
    <span class="hljs-literal">TRUE</span>,
    (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">MAX</span>(version_number) + <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> dim_customer_scd2 <span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-string">'CUST001'</span>)
<span class="hljs-keyword">FROM</span> dim_customer_scd2
<span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-string">'CUST001'</span> <span class="hljs-keyword">AND</span> is_current = <span class="hljs-literal">TRUE</span>;

<span class="hljs-comment">-- Update previous version</span>
<span class="hljs-keyword">UPDATE</span> dim_customer_scd2
<span class="hljs-keyword">SET</span>
    expiration_date = <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'1 day'</span>,
    is_current = <span class="hljs-literal">FALSE</span>
<span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-string">'CUST001'</span>
  <span class="hljs-keyword">AND</span> is_current = <span class="hljs-literal">TRUE</span>
  <span class="hljs-keyword">AND</span> customer_key != (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">MAX</span>(customer_key) <span class="hljs-keyword">FROM</span> dim_customer_scd2 <span class="hljs-keyword">WHERE</span> customer_id = <span class="hljs-string">'CUST001'</span>);

<span class="hljs-comment">-- SCD Type 3: Add New Column</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> dim_customer
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> previous_segment <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> segment_change_date <span class="hljs-built_in">DATE</span>;

<span class="hljs-keyword">UPDATE</span> dim_customer
<span class="hljs-keyword">SET</span>
    previous_segment = customer_segment,
    customer_segment = <span class="hljs-string">'Premium'</span>,
    segment_change_date = <span class="hljs-keyword">CURRENT_DATE</span>
<span class="hljs-keyword">WHERE</span> customer_key = <span class="hljs-number">12345</span>;
</div></code></pre>
<h3 id="data-mart-creation">Data Mart Creation</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Sales Data Mart</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> sales_data_mart <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    fs.sale_id,
    dd.full_date,
    dd.year,
    dd.quarter,
    dd.month_name,
    dc.customer_segment,
    dc.city <span class="hljs-keyword">as</span> customer_city,
    dc.country <span class="hljs-keyword">as</span> customer_country,
    dp.product_name,
    dp.category,
    dp.brand,
    ds.store_name,
    ds.store_type,
    ds.city <span class="hljs-keyword">as</span> store_city,
    fs.quantity,
    fs.unit_price,
    fs.total_amount,
    fs.discount_amount,
    fs.profit_amount,

    <span class="hljs-comment">-- Calculated measures</span>
    fs.total_amount - fs.discount_amount <span class="hljs-keyword">as</span> net_sales,
    fs.profit_amount / <span class="hljs-keyword">NULLIF</span>(fs.total_amount, <span class="hljs-number">0</span>) * <span class="hljs-number">100</span> <span class="hljs-keyword">as</span> profit_margin_pct,

    <span class="hljs-comment">-- Running totals</span>
    <span class="hljs-keyword">SUM</span>(fs.total_amount) <span class="hljs-keyword">OVER</span> (
        <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> dd.year, dd.month_number
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> dd.full_date
        <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">PRECEDING</span>
    ) <span class="hljs-keyword">as</span> running_monthly_sales

<span class="hljs-keyword">FROM</span> fact_sales fs
<span class="hljs-keyword">JOIN</span> dim_date dd <span class="hljs-keyword">ON</span> fs.date_key = dd.date_key
<span class="hljs-keyword">JOIN</span> dim_customer dc <span class="hljs-keyword">ON</span> fs.customer_key = dc.customer_key
<span class="hljs-keyword">JOIN</span> dim_product dp <span class="hljs-keyword">ON</span> fs.product_key = dp.product_key
<span class="hljs-keyword">JOIN</span> dim_store ds <span class="hljs-keyword">ON</span> fs.store_key = ds.store_key
<span class="hljs-keyword">WHERE</span> dd.year &gt;= <span class="hljs-keyword">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">CURRENT_DATE</span>) - <span class="hljs-number">2</span>;

<span class="hljs-comment">-- Customer Analytics Data Mart</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> customer_analytics_mart <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
    dc.customer_key,
    dc.customer_id,
    dc.customer_segment,
    dc.city,
    dc.country,

    <span class="hljs-comment">-- Customer metrics</span>
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> fs.sale_id) <span class="hljs-keyword">as</span> total_orders,
    <span class="hljs-keyword">SUM</span>(fs.total_amount) <span class="hljs-keyword">as</span> lifetime_value,
    <span class="hljs-keyword">AVG</span>(fs.total_amount) <span class="hljs-keyword">as</span> avg_order_value,
    <span class="hljs-keyword">MAX</span>(dd.full_date) <span class="hljs-keyword">as</span> last_purchase_date,
    <span class="hljs-keyword">MIN</span>(dd.full_date) <span class="hljs-keyword">as</span> first_purchase_date,

    <span class="hljs-comment">-- Customer behavior</span>
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> dd.year || <span class="hljs-string">'-'</span> || dd.month_number) <span class="hljs-keyword">as</span> active_months,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> dp.category) <span class="hljs-keyword">as</span> categories_purchased,

    <span class="hljs-comment">-- Recency, Frequency, Monetary (RFM)</span>
    <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-keyword">MAX</span>(dd.full_date) <span class="hljs-keyword">as</span> recency_days,
    <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> fs.sale_id) <span class="hljs-keyword">as</span> frequency,
    <span class="hljs-keyword">SUM</span>(fs.total_amount) <span class="hljs-keyword">as</span> monetary_value,

    <span class="hljs-comment">-- Customer classification</span>
    <span class="hljs-keyword">CASE</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">SUM</span>(fs.total_amount) &gt; <span class="hljs-number">10000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'High Value'</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">SUM</span>(fs.total_amount) &gt; <span class="hljs-number">5000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Medium Value'</span>
        <span class="hljs-keyword">ELSE</span> <span class="hljs-string">'Low Value'</span>
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> value_segment

<span class="hljs-keyword">FROM</span> dim_customer dc
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> fact_sales fs <span class="hljs-keyword">ON</span> dc.customer_key = fs.customer_key
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> dim_date dd <span class="hljs-keyword">ON</span> fs.date_key = dd.date_key
<span class="hljs-keyword">WHERE</span> dc.is_active = <span class="hljs-literal">TRUE</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
    dc.customer_key, dc.customer_id, dc.customer_segment,
    dc.city, dc.country;
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-real-world-etl-project-e-commerce-analytics">ğŸ¯ Real-World ETL Project: E-commerce Analytics</h2>
<h3 id="project-overview">Project Overview</h3>
<p>Build a complete ETL pipeline for an e-commerce company that:</p>
<ul>
<li>Extracts data from multiple sources (MySQL, APIs, CSV files)</li>
<li>Transforms data for analytics</li>
<li>Loads into a PostgreSQL data warehouse</li>
<li>Implements data quality checks</li>
<li>Provides automated reporting</li>
</ul>
<h3 id="implementation">Implementation</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Complete E-commerce ETL Project</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EcommerceETLProject</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.config = self._load_config()
        self.logger = self._setup_logging()
        self.quality_checker = DataQualityChecker()
        self.metrics = ETLMetrics()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_load_config</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'sources'</span>: {
                <span class="hljs-string">'orders_db'</span>: {
                    <span class="hljs-string">'type'</span>: <span class="hljs-string">'mysql'</span>,
                    <span class="hljs-string">'host'</span>: <span class="hljs-string">'prod-mysql.company.com'</span>,
                    <span class="hljs-string">'database'</span>: <span class="hljs-string">'ecommerce'</span>,
                    <span class="hljs-string">'tables'</span>: [<span class="hljs-string">'orders'</span>, <span class="hljs-string">'order_items'</span>, <span class="hljs-string">'customers'</span>, <span class="hljs-string">'products'</span>]
                },
                <span class="hljs-string">'web_analytics'</span>: {
                    <span class="hljs-string">'type'</span>: <span class="hljs-string">'api'</span>,
                    <span class="hljs-string">'base_url'</span>: <span class="hljs-string">'https://api.analytics.com/v1'</span>,
                    <span class="hljs-string">'endpoints'</span>: [<span class="hljs-string">'sessions'</span>, <span class="hljs-string">'page_views'</span>, <span class="hljs-string">'conversions'</span>]
                },
                <span class="hljs-string">'inventory_files'</span>: {
                    <span class="hljs-string">'type'</span>: <span class="hljs-string">'file'</span>,
                    <span class="hljs-string">'path'</span>: <span class="hljs-string">'/data/inventory/'</span>,
                    <span class="hljs-string">'format'</span>: <span class="hljs-string">'csv'</span>
                }
            },
            <span class="hljs-string">'target'</span>: {
                <span class="hljs-string">'type'</span>: <span class="hljs-string">'postgresql'</span>,
                <span class="hljs-string">'host'</span>: <span class="hljs-string">'warehouse.company.com'</span>,
                <span class="hljs-string">'database'</span>: <span class="hljs-string">'analytics_dw'</span>
            },
            <span class="hljs-string">'schedule'</span>: {
                <span class="hljs-string">'daily_sales'</span>: <span class="hljs-string">'02:00'</span>,
                <span class="hljs-string">'hourly_inventory'</span>: <span class="hljs-string">'*/1 * * * *'</span>,
                <span class="hljs-string">'weekly_customer_analysis'</span>: <span class="hljs-string">'0 6 * * 1'</span>
            }
        }

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_orders_data</span><span class="hljs-params">(self, start_date: str, end_date: str)</span>:</span>
        <span class="hljs-string">"""Extract orders data from MySQL"""</span>
        query = <span class="hljs-string">"""
        SELECT
            o.order_id,
            o.customer_id,
            o.order_date,
            o.status,
            o.total_amount,
            o.shipping_cost,
            o.tax_amount,
            oi.product_id,
            oi.quantity,
            oi.unit_price,
            oi.discount_amount,
            c.email,
            c.registration_date,
            c.customer_segment,
            p.product_name,
            p.category,
            p.brand
        FROM orders o
        JOIN order_items oi ON o.order_id = oi.order_id
        JOIN customers c ON o.customer_id = c.customer_id
        JOIN products p ON oi.product_id = p.product_id
        WHERE o.order_date BETWEEN %s AND %s
        """</span>

        extractor = MySQLExtractor(self.config[<span class="hljs-string">'sources'</span>][<span class="hljs-string">'orders_db'</span>])
        <span class="hljs-keyword">return</span> extractor.execute_query(query, (start_date, end_date))

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_web_analytics</span><span class="hljs-params">(self, date: str)</span>:</span>
        <span class="hljs-string">"""Extract web analytics data from API"""</span>
        api_extractor = APIExtractor(self.config[<span class="hljs-string">'sources'</span>][<span class="hljs-string">'web_analytics'</span>])

        sessions = api_extractor.get_data(<span class="hljs-string">f'sessions?date=<span class="hljs-subst">{date}</span>'</span>)
        page_views = api_extractor.get_data(<span class="hljs-string">f'page_views?date=<span class="hljs-subst">{date}</span>'</span>)
        conversions = api_extractor.get_data(<span class="hljs-string">f'conversions?date=<span class="hljs-subst">{date}</span>'</span>)

        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'sessions'</span>: pd.DataFrame(sessions),
            <span class="hljs-string">'page_views'</span>: pd.DataFrame(page_views),
            <span class="hljs-string">'conversions'</span>: pd.DataFrame(conversions)
        }

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">transform_sales_data</span><span class="hljs-params">(self, orders_df: pd.DataFrame)</span>:</span>
        <span class="hljs-string">"""Transform orders data for analytics"""</span>
        transformer = DataTransformer()

        <span class="hljs-comment"># Data cleaning</span>
        orders_df = transformer.clean_text_data(orders_df, [<span class="hljs-string">'email'</span>, <span class="hljs-string">'product_name'</span>])
        orders_df = transformer.handle_missing_values(orders_df, {
            <span class="hljs-string">'discount_amount'</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">'shipping_cost'</span>: <span class="hljs-string">'mean'</span>
        })

        <span class="hljs-comment"># Create derived columns</span>
        orders_df[<span class="hljs-string">'net_amount'</span>] = orders_df[<span class="hljs-string">'total_amount'</span>] - orders_df[<span class="hljs-string">'discount_amount'</span>]
        orders_df[<span class="hljs-string">'profit_amount'</span>] = orders_df[<span class="hljs-string">'net_amount'</span>] * <span class="hljs-number">0.3</span>  <span class="hljs-comment"># Assume 30% margin</span>
        orders_df[<span class="hljs-string">'order_year'</span>] = pd.to_datetime(orders_df[<span class="hljs-string">'order_date'</span>]).dt.year
        orders_df[<span class="hljs-string">'order_month'</span>] = pd.to_datetime(orders_df[<span class="hljs-string">'order_date'</span>]).dt.month
        orders_df[<span class="hljs-string">'order_quarter'</span>] = pd.to_datetime(orders_df[<span class="hljs-string">'order_date'</span>]).dt.quarter

        <span class="hljs-comment"># Customer segmentation</span>
        orders_df[<span class="hljs-string">'customer_value_segment'</span>] = orders_df.groupby(<span class="hljs-string">'customer_id'</span>)[<span class="hljs-string">'total_amount'</span>].transform(<span class="hljs-string">'sum'</span>).apply(
            <span class="hljs-keyword">lambda</span> x: <span class="hljs-string">'High'</span> <span class="hljs-keyword">if</span> x &gt; <span class="hljs-number">10000</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'Medium'</span> <span class="hljs-keyword">if</span> x &gt; <span class="hljs-number">5000</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'Low'</span>
        )

        <span class="hljs-comment"># Product performance metrics</span>
        orders_df[<span class="hljs-string">'product_revenue_rank'</span>] = orders_df.groupby([<span class="hljs-string">'order_year'</span>, <span class="hljs-string">'order_month'</span>])[<span class="hljs-string">'net_amount'</span>].rank(method=<span class="hljs-string">'dense'</span>, ascending=<span class="hljs-literal">False</span>)

        <span class="hljs-keyword">return</span> orders_df

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_dimensional_model</span><span class="hljs-params">(self, transformed_data: pd.DataFrame)</span>:</span>
        <span class="hljs-string">"""Create dimensional model from transformed data"""</span>

        <span class="hljs-comment"># Create dimension tables</span>
        dim_date = self._create_date_dimension()
        dim_customer = self._create_customer_dimension(transformed_data)
        dim_product = self._create_product_dimension(transformed_data)

        <span class="hljs-comment"># Create fact table</span>
        fact_sales = self._create_sales_fact(transformed_data, dim_date, dim_customer, dim_product)

        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'dim_date'</span>: dim_date,
            <span class="hljs-string">'dim_customer'</span>: dim_customer,
            <span class="hljs-string">'dim_product'</span>: dim_product,
            <span class="hljs-string">'fact_sales'</span>: fact_sales
        }

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_create_date_dimension</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Create date dimension"""</span>
        start_date = datetime(<span class="hljs-number">2020</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)
        end_date = datetime(<span class="hljs-number">2025</span>, <span class="hljs-number">12</span>, <span class="hljs-number">31</span>)

        dates = pd.date_range(start=start_date, end=end_date, freq=<span class="hljs-string">'D'</span>)

        dim_date = pd.DataFrame({
            <span class="hljs-string">'date_key'</span>: [int(d.strftime(<span class="hljs-string">'%Y%m%d'</span>)) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> dates],
            <span class="hljs-string">'full_date'</span>: dates,
            <span class="hljs-string">'day_of_week'</span>: dates.day_name(),
            <span class="hljs-string">'day_of_month'</span>: dates.day,
            <span class="hljs-string">'day_of_year'</span>: dates.dayofyear,
            <span class="hljs-string">'week_of_year'</span>: dates.isocalendar().week,
            <span class="hljs-string">'month_name'</span>: dates.month_name(),
            <span class="hljs-string">'month_number'</span>: dates.month,
            <span class="hljs-string">'quarter'</span>: dates.quarter,
            <span class="hljs-string">'year'</span>: dates.year,
            <span class="hljs-string">'is_weekend'</span>: dates.weekday &gt;= <span class="hljs-number">5</span>,
            <span class="hljs-string">'is_holiday'</span>: <span class="hljs-literal">False</span>  <span class="hljs-comment"># Would need holiday calendar integration</span>
        })

        <span class="hljs-keyword">return</span> dim_date

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_create_customer_dimension</span><span class="hljs-params">(self, data: pd.DataFrame)</span>:</span>
        <span class="hljs-string">"""Create customer dimension"""</span>
        customers = data.groupby(<span class="hljs-string">'customer_id'</span>).agg({
            <span class="hljs-string">'email'</span>: <span class="hljs-string">'first'</span>,
            <span class="hljs-string">'registration_date'</span>: <span class="hljs-string">'first'</span>,
            <span class="hljs-string">'customer_segment'</span>: <span class="hljs-string">'first'</span>,
            <span class="hljs-string">'customer_value_segment'</span>: <span class="hljs-string">'first'</span>,
            <span class="hljs-string">'total_amount'</span>: <span class="hljs-string">'sum'</span>
        }).reset_index()

        customers[<span class="hljs-string">'customer_key'</span>] = range(<span class="hljs-number">1</span>, len(customers) + <span class="hljs-number">1</span>)

        <span class="hljs-keyword">return</span> customers[[
            <span class="hljs-string">'customer_key'</span>, <span class="hljs-string">'customer_id'</span>, <span class="hljs-string">'email'</span>, <span class="hljs-string">'registration_date'</span>,
            <span class="hljs-string">'customer_segment'</span>, <span class="hljs-string">'customer_value_segment'</span>, <span class="hljs-string">'total_amount'</span>
        ]]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_create_product_dimension</span><span class="hljs-params">(self, data: pd.DataFrame)</span>:</span>
        <span class="hljs-string">"""Create product dimension"""</span>
        products = data.groupby(<span class="hljs-string">'product_id'</span>).agg({
            <span class="hljs-string">'product_name'</span>: <span class="hljs-string">'first'</span>,
            <span class="hljs-string">'category'</span>: <span class="hljs-string">'first'</span>,
            <span class="hljs-string">'brand'</span>: <span class="hljs-string">'first'</span>,
            <span class="hljs-string">'unit_price'</span>: <span class="hljs-string">'mean'</span>
        }).reset_index()

        products[<span class="hljs-string">'product_key'</span>] = range(<span class="hljs-number">1</span>, len(products) + <span class="hljs-number">1</span>)

        <span class="hljs-keyword">return</span> products[[
            <span class="hljs-string">'product_key'</span>, <span class="hljs-string">'product_id'</span>, <span class="hljs-string">'product_name'</span>,
            <span class="hljs-string">'category'</span>, <span class="hljs-string">'brand'</span>, <span class="hljs-string">'unit_price'</span>
        ]]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_create_sales_fact</span><span class="hljs-params">(self, data: pd.DataFrame, dim_date: pd.DataFrame,
                          dim_customer: pd.DataFrame, dim_product: pd.DataFrame)</span>:</span>
        <span class="hljs-string">"""Create sales fact table"""</span>

        <span class="hljs-comment"># Create date keys</span>
        data[<span class="hljs-string">'date_key'</span>] = pd.to_datetime(data[<span class="hljs-string">'order_date'</span>]).dt.strftime(<span class="hljs-string">'%Y%m%d'</span>).astype(int)

        <span class="hljs-comment"># Merge with dimensions to get keys</span>
        fact_sales = data.merge(
            dim_customer[[<span class="hljs-string">'customer_key'</span>, <span class="hljs-string">'customer_id'</span>]],
            on=<span class="hljs-string">'customer_id'</span>
        ).merge(
            dim_product[[<span class="hljs-string">'product_key'</span>, <span class="hljs-string">'product_id'</span>]],
            on=<span class="hljs-string">'product_id'</span>
        )

        <span class="hljs-keyword">return</span> fact_sales[[
            <span class="hljs-string">'order_id'</span>, <span class="hljs-string">'date_key'</span>, <span class="hljs-string">'customer_key'</span>, <span class="hljs-string">'product_key'</span>,
            <span class="hljs-string">'quantity'</span>, <span class="hljs-string">'unit_price'</span>, <span class="hljs-string">'total_amount'</span>, <span class="hljs-string">'discount_amount'</span>,
            <span class="hljs-string">'net_amount'</span>, <span class="hljs-string">'profit_amount'</span>
        ]]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run_quality_checks</span><span class="hljs-params">(self, data: Dict[str, pd.DataFrame])</span>:</span>
        <span class="hljs-string">"""Run comprehensive data quality checks"""</span>
        quality_results = {}

        <span class="hljs-comment"># Check fact table</span>
        fact_rules = {
            <span class="hljs-string">'completeness'</span>: [<span class="hljs-string">'order_id'</span>, <span class="hljs-string">'date_key'</span>, <span class="hljs-string">'customer_key'</span>, <span class="hljs-string">'product_key'</span>],
            <span class="hljs-string">'uniqueness'</span>: [<span class="hljs-string">'order_id'</span>],
            <span class="hljs-string">'value_ranges'</span>: {
                <span class="hljs-string">'quantity'</span>: {<span class="hljs-string">'min'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'max'</span>: <span class="hljs-number">1000</span>},
                <span class="hljs-string">'unit_price'</span>: {<span class="hljs-string">'min'</span>: <span class="hljs-number">0</span>, <span class="hljs-string">'max'</span>: <span class="hljs-number">10000</span>},
                <span class="hljs-string">'total_amount'</span>: {<span class="hljs-string">'min'</span>: <span class="hljs-number">0</span>, <span class="hljs-string">'max'</span>: <span class="hljs-number">100000</span>}
            }
        }

        quality_results[<span class="hljs-string">'fact_sales'</span>] = self.quality_checker.run_quality_checks(
            data[<span class="hljs-string">'fact_sales'</span>], fact_rules
        )

        <span class="hljs-comment"># Check dimension tables</span>
        dim_customer_rules = {
            <span class="hljs-string">'completeness'</span>: [<span class="hljs-string">'customer_id'</span>, <span class="hljs-string">'email'</span>],
            <span class="hljs-string">'uniqueness'</span>: [<span class="hljs-string">'customer_id'</span>, <span class="hljs-string">'email'</span>]
        }

        quality_results[<span class="hljs-string">'dim_customer'</span>] = self.quality_checker.run_quality_checks(
            data[<span class="hljs-string">'dim_customer'</span>], dim_customer_rules
        )

        <span class="hljs-keyword">return</span> quality_results

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_to_warehouse</span><span class="hljs-params">(self, dimensional_data: Dict[str, pd.DataFrame])</span>:</span>
        <span class="hljs-string">"""Load data to PostgreSQL warehouse"""</span>
        loader = PostgreSQLLoader(self.config[<span class="hljs-string">'target'</span>])
        loader.connect()

        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># Load dimensions first</span>
            <span class="hljs-keyword">for</span> table_name, df <span class="hljs-keyword">in</span> dimensional_data.items():
                <span class="hljs-keyword">if</span> table_name.startswith(<span class="hljs-string">'dim_'</span>):
                    loader.upsert_data(df, table_name, [<span class="hljs-string">'customer_id'</span>] <span class="hljs-keyword">if</span> <span class="hljs-string">'customer'</span> <span class="hljs-keyword">in</span> table_name <span class="hljs-keyword">else</span> [<span class="hljs-string">'product_id'</span>])

            <span class="hljs-comment"># Load fact table</span>
            loader.upsert_data(
                dimensional_data[<span class="hljs-string">'fact_sales'</span>],
                <span class="hljs-string">'fact_sales'</span>,
                [<span class="hljs-string">'order_id'</span>]
            )

            self.logger.info(<span class="hljs-string">"Data loaded successfully to warehouse"</span>)

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            self.logger.error(<span class="hljs-string">f"Failed to load data: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">finally</span>:
            loader.close()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_business_reports</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Generate automated business reports"""</span>
        warehouse_conn = PostgreSQLExtractor(self.config[<span class="hljs-string">'target'</span>])

        <span class="hljs-comment"># Daily sales report</span>
        daily_sales_query = <span class="hljs-string">"""
        SELECT
            dd.full_date,
            SUM(fs.total_amount) as total_sales,
            SUM(fs.profit_amount) as total_profit,
            COUNT(DISTINCT fs.order_id) as total_orders,
            AVG(fs.total_amount) as avg_order_value
        FROM fact_sales fs
        JOIN dim_date dd ON fs.date_key = dd.date_key
        WHERE dd.full_date &gt;= CURRENT_DATE - INTERVAL '30 days'
        GROUP BY dd.full_date
        ORDER BY dd.full_date DESC
        """</span>

        daily_sales = warehouse_conn.execute_query(daily_sales_query)

        <span class="hljs-comment"># Customer segment analysis</span>
        segment_analysis_query = <span class="hljs-string">"""
        SELECT
            dc.customer_segment,
            COUNT(DISTINCT dc.customer_id) as customer_count,
            SUM(fs.total_amount) as total_revenue,
            AVG(fs.total_amount) as avg_order_value,
            SUM(fs.profit_amount) as total_profit
        FROM dim_customer dc
        JOIN fact_sales fs ON dc.customer_key = fs.customer_key
        JOIN dim_date dd ON fs.date_key = dd.date_key
        WHERE dd.full_date &gt;= CURRENT_DATE - INTERVAL '90 days'
        GROUP BY dc.customer_segment
        ORDER BY total_revenue DESC
        """</span>

        segment_analysis = warehouse_conn.execute_query(segment_analysis_query)

        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'daily_sales'</span>: daily_sales,
            <span class="hljs-string">'segment_analysis'</span>: segment_analysis
        }

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run_full_pipeline</span><span class="hljs-params">(self, date: str)</span>:</span>
        <span class="hljs-string">"""Run the complete ETL pipeline"""</span>
        start_time = datetime.now()
        self.logger.info(<span class="hljs-string">f"Starting ETL pipeline for <span class="hljs-subst">{date}</span>"</span>)

        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># Extract</span>
            orders_data = self.extract_orders_data(date, date)
            web_data = self.extract_web_analytics(date)

            <span class="hljs-comment"># Transform</span>
            transformed_orders = self.transform_sales_data(orders_data)
            dimensional_data = self.create_dimensional_model(transformed_orders)

            <span class="hljs-comment"># Quality checks</span>
            quality_results = self.run_quality_checks(dimensional_data)

            <span class="hljs-comment"># Check if quality passed</span>
            failed_checks = sum(<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> table_results <span class="hljs-keyword">in</span> quality_results.values()
                              <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> table_results.values()
                              <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> result.get(<span class="hljs-string">'passed'</span>, <span class="hljs-literal">True</span>))

            <span class="hljs-keyword">if</span> failed_checks &gt; <span class="hljs-number">0</span>:
                self.logger.warning(<span class="hljs-string">f"Quality checks failed: <span class="hljs-subst">{failed_checks}</span> issues found"</span>)
                <span class="hljs-comment"># Decide whether to continue or halt</span>

            <span class="hljs-comment"># Load</span>
            self.load_to_warehouse(dimensional_data)

            <span class="hljs-comment"># Generate reports</span>
            reports = self.generate_business_reports()

            <span class="hljs-comment"># Record metrics</span>
            duration = datetime.now() - start_time
            self.metrics.record_pipeline_run({
                <span class="hljs-string">'pipeline_name'</span>: <span class="hljs-string">'ecommerce_etl'</span>,
                <span class="hljs-string">'date'</span>: date,
                <span class="hljs-string">'duration'</span>: duration,
                <span class="hljs-string">'records_processed'</span>: len(transformed_orders),
                <span class="hljs-string">'quality_score'</span>: (len([r <span class="hljs-keyword">for</span> table_results <span class="hljs-keyword">in</span> quality_results.values()
                                     <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> table_results.values()
                                     <span class="hljs-keyword">if</span> r.get(<span class="hljs-string">'passed'</span>, <span class="hljs-literal">True</span>)]) /
                                max(<span class="hljs-number">1</span>, sum(len(table_results) <span class="hljs-keyword">for</span> table_results <span class="hljs-keyword">in</span> quality_results.values()))) * <span class="hljs-number">100</span>
            })

            self.logger.info(<span class="hljs-string">f"ETL pipeline completed successfully in <span class="hljs-subst">{duration}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            self.logger.error(<span class="hljs-string">f"ETL pipeline failed: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

<span class="hljs-comment"># Usage</span>
etl_project = EcommerceETLProject()
etl_project.run_full_pipeline(<span class="hljs-string">'2024-01-15'</span>)
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%88-performance-optimization">ğŸ“ˆ Performance Optimization</h2>
<h3 id="etl-performance-best-practices">ETL Performance Best Practices</h3>
<ol>
<li><strong>Parallel Processing</strong></li>
</ol>
<pre class="hljs"><code><div><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor, ProcessPoolExecutor
<span class="hljs-keyword">import</span> multiprocessing <span class="hljs-keyword">as</span> mp

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParallelETL</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, max_workers=None)</span>:</span>
        self.max_workers = max_workers <span class="hljs-keyword">or</span> mp.cpu_count()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parallel_extract</span><span class="hljs-params">(self, source_configs)</span>:</span>
        <span class="hljs-string">"""Extract from multiple sources in parallel"""</span>
        <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=self.max_workers) <span class="hljs-keyword">as</span> executor:
            futures = {}
            <span class="hljs-keyword">for</span> source_name, config <span class="hljs-keyword">in</span> source_configs.items():
                future = executor.submit(self._extract_single_source, source_name, config)
                futures[source_name] = future

            results = {}
            <span class="hljs-keyword">for</span> source_name, future <span class="hljs-keyword">in</span> futures.items():
                results[source_name] = future.result()

            <span class="hljs-keyword">return</span> results

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parallel_transform</span><span class="hljs-params">(self, data_chunks)</span>:</span>
        <span class="hljs-string">"""Transform data chunks in parallel"""</span>
        <span class="hljs-keyword">with</span> ProcessPoolExecutor(max_workers=self.max_workers) <span class="hljs-keyword">as</span> executor:
            futures = [executor.submit(self._transform_chunk, chunk) <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> data_chunks]
            results = [future.result() <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> futures]

            <span class="hljs-comment"># Combine results</span>
            <span class="hljs-keyword">return</span> pd.concat(results, ignore_index=<span class="hljs-literal">True</span>)
</div></code></pre>
<ol start="2">
<li><strong>Incremental Loading</strong></li>
</ol>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IncrementalETL</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.watermark_table = <span class="hljs-string">'etl_watermarks'</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_last_watermark</span><span class="hljs-params">(self, table_name: str)</span> -&gt; datetime:</span>
        <span class="hljs-string">"""Get last processed timestamp"""</span>
        query = <span class="hljs-string">f"""
        SELECT last_processed_timestamp
        FROM <span class="hljs-subst">{self.watermark_table}</span>
        WHERE table_name = %s
        """</span>
        result = self.db.execute_query(query, (table_name,))
        <span class="hljs-keyword">return</span> result[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> result <span class="hljs-keyword">else</span> datetime(<span class="hljs-number">1900</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_watermark</span><span class="hljs-params">(self, table_name: str, timestamp: datetime)</span>:</span>
        <span class="hljs-string">"""Update watermark after successful processing"""</span>
        query = <span class="hljs-string">f"""
        INSERT INTO <span class="hljs-subst">{self.watermark_table}</span> (table_name, last_processed_timestamp)
        VALUES (%s, %s)
        ON DUPLICATE KEY UPDATE last_processed_timestamp = %s
        """</span>
        self.db.execute_query(query, (table_name, timestamp, timestamp))

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">incremental_extract</span><span class="hljs-params">(self, table_name: str, timestamp_column: str)</span>:</span>
        <span class="hljs-string">"""Extract only new/modified records"""</span>
        last_watermark = self.get_last_watermark(table_name)

        query = <span class="hljs-string">f"""
        SELECT * FROM <span class="hljs-subst">{table_name}</span>
        WHERE <span class="hljs-subst">{timestamp_column}</span> &gt; %s
        ORDER BY <span class="hljs-subst">{timestamp_column}</span>
        """</span>

        data = self.db.execute_query(query, (last_watermark,))

        <span class="hljs-keyword">if</span> data:
            max_timestamp = max(row[timestamp_column] <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> data)
            self.update_watermark(table_name, max_timestamp)

        <span class="hljs-keyword">return</span> data
</div></code></pre>
<ol start="3">
<li><strong>Batch Processing</strong></li>
</ol>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BatchProcessor</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, batch_size=<span class="hljs-number">10000</span>)</span>:</span>
        self.batch_size = batch_size

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_in_batches</span><span class="hljs-params">(self, data: pd.DataFrame, process_func)</span>:</span>
        <span class="hljs-string">"""Process large datasets in batches"""</span>
        total_rows = len(data)
        processed_rows = <span class="hljs-number">0</span>

        <span class="hljs-keyword">for</span> start_idx <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, total_rows, self.batch_size):
            end_idx = min(start_idx + self.batch_size, total_rows)
            batch = data.iloc[start_idx:end_idx]

            <span class="hljs-keyword">try</span>:
                process_func(batch)
                processed_rows += len(batch)

                <span class="hljs-comment"># Progress logging</span>
                progress = (processed_rows / total_rows) * <span class="hljs-number">100</span>
                logging.info(<span class="hljs-string">f"Processed <span class="hljs-subst">{processed_rows}</span>/<span class="hljs-subst">{total_rows}</span> rows (<span class="hljs-subst">{progress:<span class="hljs-number">.1</span>f}</span>%)"</span>)

            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                logging.error(<span class="hljs-string">f"Failed to process batch <span class="hljs-subst">{start_idx}</span>-<span class="hljs-subst">{end_idx}</span>: <span class="hljs-subst">{e}</span>"</span>)
                <span class="hljs-keyword">raise</span>
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%93-interview-questions--answers">ğŸ“ Interview Questions &amp; Answers</h2>
<h3 id="beginner-level">Beginner Level</h3>
<p><strong>Q1: What is ETL and why is it important?</strong></p>
<p><strong>A:</strong> ETL stands for Extract, Transform, Load. It's a data integration process that:</p>
<ul>
<li><strong>Extract</strong>: Retrieves data from various sources (databases, APIs, files)</li>
<li><strong>Transform</strong>: Cleans, validates, and converts data into the desired format</li>
<li><strong>Load</strong>: Stores the processed data into a target system (data warehouse, database)</li>
</ul>
<p>ETL is important because it enables organizations to consolidate data from multiple sources, ensure data quality, and make data available for analytics and reporting.</p>
<p><strong>Q2: What's the difference between ETL and ELT?</strong></p>
<p><strong>A:</strong></p>
<ul>
<li><strong>ETL</strong>: Transform data before loading into the target system. Better for complex transformations and when target system has limited processing power.</li>
<li><strong>ELT</strong>: Load raw data first, then transform within the target system. Better for cloud data warehouses with powerful processing capabilities like Snowflake, BigQuery.</li>
</ul>
<h3 id="intermediate-level">Intermediate Level</h3>
<p><strong>Q3: How do you handle slowly changing dimensions (SCD)?</strong></p>
<p><strong>A:</strong> There are three main types:</p>
<ul>
<li><strong>Type 1</strong>: Overwrite old values (no history preserved)</li>
<li><strong>Type 2</strong>: Create new records for changes (full history preserved)</li>
<li><strong>Type 3</strong>: Add columns for previous values (limited history)</li>
</ul>
<p>Choice depends on business requirements for historical data tracking.</p>
<p><strong>Q4: What are the key considerations for ETL performance optimization?</strong></p>
<p><strong>A:</strong></p>
<ul>
<li><strong>Parallel processing</strong>: Process multiple data streams simultaneously</li>
<li><strong>Incremental loading</strong>: Only process new/changed data</li>
<li><strong>Batch processing</strong>: Handle large datasets in manageable chunks</li>
<li><strong>Indexing</strong>: Optimize database queries with proper indexes</li>
<li><strong>Data partitioning</strong>: Distribute data across multiple storage units</li>
<li><strong>Compression</strong>: Reduce data transfer and storage costs</li>
</ul>
<h3 id="advanced-level">Advanced Level</h3>
<p><strong>Q5: How do you design an ETL pipeline for real-time data processing?</strong></p>
<p><strong>A:</strong> Real-time ETL requires:</p>
<ul>
<li><strong>Streaming platforms</strong>: Apache Kafka, Amazon Kinesis</li>
<li><strong>Stream processing</strong>: Apache Spark Streaming, Apache Flink</li>
<li><strong>Micro-batch processing</strong>: Process small batches frequently</li>
<li><strong>Change Data Capture (CDC)</strong>: Capture database changes in real-time</li>
<li><strong>Event-driven architecture</strong>: React to data changes immediately</li>
</ul>
<p><strong>Q6: How do you ensure data quality in ETL pipelines?</strong></p>
<p><strong>A:</strong></p>
<ul>
<li><strong>Data profiling</strong>: Understand data characteristics and patterns</li>
<li><strong>Validation rules</strong>: Check completeness, uniqueness, referential integrity</li>
<li><strong>Data lineage</strong>: Track data flow from source to destination</li>
<li><strong>Monitoring and alerting</strong>: Detect anomalies and failures</li>
<li><strong>Data quality metrics</strong>: Measure and report quality scores</li>
<li><strong>Automated testing</strong>: Unit tests for transformation logic</li>
</ul>
<hr>
<h2 id="%E2%9A%A0%EF%B8%8F-common-pitfalls">âš ï¸ Common Pitfalls</h2>
<ol>
<li>
<p><strong>Not handling data quality early</strong></p>
<ul>
<li>Always validate data at extraction point</li>
<li>Implement comprehensive quality checks</li>
</ul>
</li>
<li>
<p><strong>Ignoring incremental loading</strong></p>
<ul>
<li>Full loads become unsustainable with large datasets</li>
<li>Implement proper watermarking strategies</li>
</ul>
</li>
<li>
<p><strong>Poor error handling</strong></p>
<ul>
<li>ETL pipelines should be resilient to failures</li>
<li>Implement retry mechanisms and proper logging</li>
</ul>
</li>
<li>
<p><strong>Not considering data lineage</strong></p>
<ul>
<li>Track data flow for debugging and compliance</li>
<li>Document transformation logic</li>
</ul>
</li>
<li>
<p><strong>Inadequate monitoring</strong></p>
<ul>
<li>Monitor pipeline performance and data quality</li>
<li>Set up alerts for failures and anomalies</li>
</ul>
</li>
</ol>
<hr>
<h2 id="%F0%9F%8E%AF-next-steps">ğŸ¯ Next Steps</h2>
<p>Congratulations! You've completed Chapter 21 on ETL and Data Warehousing. You should now understand:</p>
<p>âœ… ETL vs ELT concepts and when to use each
âœ… Data extraction from multiple sources (databases, APIs, files)
âœ… Data transformation techniques and best practices
âœ… Data loading strategies (bulk, batch, incremental)
âœ… Data warehousing concepts (star schema, snowflake schema)
âœ… Slowly changing dimensions (SCD) implementation
âœ… Data quality management and monitoring
âœ… Performance optimization techniques
âœ… Real-world ETL project implementation</p>
<p><strong>Continue to:</strong> <a href="22-cloud-databases-dbaas.md">Chapter 22: Cloud Databases &amp; Database as a Service (DBaaS)</a></p>
<p><strong>Practice Projects:</strong></p>
<ol>
<li>Build an ETL pipeline for your own data sources</li>
<li>Implement a real-time streaming ETL with Kafka</li>
<li>Create a data quality monitoring dashboard</li>
<li>Design a multi-source data warehouse</li>
</ol>
<p><strong>Additional Resources:</strong></p>
<ul>
<li>Apache Airflow for workflow orchestration</li>
<li>dbt (data build tool) for transformation</li>
<li>Great Expectations for data quality</li>
<li>Apache Spark for big data processing</li>
</ul>
<h1 id="chapter-22-cloud-databases--database-as-a-service-dbaas">Chapter 22: Cloud Databases &amp; Database as a Service (DBaaS)</h1>
<h2 id="%F0%9F%93%9A-learning-objectives">ğŸ“š Learning Objectives</h2>
<p>By the end of this chapter, you will:</p>
<ul>
<li>Understand cloud database concepts and benefits</li>
<li>Learn about major cloud database providers (AWS, Azure, GCP)</li>
<li>Master database migration strategies to the cloud</li>
<li>Implement cloud-native database solutions</li>
<li>Understand serverless database concepts</li>
<li>Learn about multi-cloud and hybrid database architectures</li>
<li>Implement database monitoring and cost optimization in the cloud</li>
<li>Understand compliance and security in cloud databases</li>
</ul>
<hr>
<h2 id="%F0%9F%8C%90-introduction-to-cloud-databases">ğŸŒ Introduction to Cloud Databases</h2>
<h3 id="what-are-cloud-databases">What are Cloud Databases?</h3>
<p>Cloud databases are databases that run on cloud computing platforms, providing:</p>
<ul>
<li><strong>Scalability</strong>: Automatic scaling based on demand</li>
<li><strong>Availability</strong>: High availability with built-in redundancy</li>
<li><strong>Managed Services</strong>: Reduced operational overhead</li>
<li><strong>Global Reach</strong>: Deploy databases closer to users worldwide</li>
<li><strong>Cost Efficiency</strong>: Pay-as-you-use pricing models</li>
</ul>
<h3 id="types-of-cloud-database-services">Types of Cloud Database Services</h3>
<ol>
<li>
<p><strong>Infrastructure as a Service (IaaS)</strong></p>
<ul>
<li>Virtual machines with self-managed databases</li>
<li>Full control over database configuration</li>
<li>Examples: EC2 with MySQL, Azure VMs with SQL Server</li>
</ul>
</li>
<li>
<p><strong>Platform as a Service (PaaS)</strong></p>
<ul>
<li>Managed database services</li>
<li>Automated backups, updates, and scaling</li>
<li>Examples: AWS RDS, Azure SQL Database, Google Cloud SQL</li>
</ul>
</li>
<li>
<p><strong>Software as a Service (SaaS)</strong></p>
<ul>
<li>Fully managed database applications</li>
<li>No infrastructure management required</li>
<li>Examples: Salesforce, Office 365</li>
</ul>
</li>
<li>
<p><strong>Database as a Service (DBaaS)</strong></p>
<ul>
<li>Specialized managed database services</li>
<li>Optimized for specific use cases</li>
<li>Examples: MongoDB Atlas, Redis Cloud, Snowflake</li>
</ul>
</li>
</ol>
<hr>
<h2 id="%E2%98%81%EF%B8%8F-major-cloud-database-providers">â˜ï¸ Major Cloud Database Providers</h2>
<h3 id="amazon-web-services-aws">Amazon Web Services (AWS)</h3>
<h4 id="aws-rds-relational-database-service">AWS RDS (Relational Database Service)</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Creating an RDS MySQL instance via AWS CLI</span>
aws rds <span class="hljs-keyword">create</span>-db-<span class="hljs-keyword">instance</span> \
    <span class="hljs-comment">--db-instance-identifier myapp-mysql \</span>
    <span class="hljs-comment">--db-instance-class db.t3.micro \</span>
    <span class="hljs-comment">--engine mysql \</span>
    <span class="hljs-comment">--engine-version 8.0.35 \</span>
    <span class="hljs-comment">--master-username admin \</span>
    <span class="hljs-comment">--master-user-password MySecurePassword123! \</span>
    <span class="hljs-comment">--allocated-storage 20 \</span>
    <span class="hljs-comment">--storage-type gp2 \</span>
    <span class="hljs-comment">--vpc-security-group-ids sg-12345678 \</span>
    <span class="hljs-comment">--db-subnet-group-name myapp-subnet-group \</span>
    <span class="hljs-comment">--backup-retention-period 7 \</span>
    <span class="hljs-comment">--multi-az \</span>
    <span class="hljs-comment">--storage-encrypted \</span>
    <span class="hljs-comment">--tags Key=Environment,Value=Production Key=Application,Value=MyApp</span>

<span class="hljs-comment">-- Connecting to RDS MySQL</span>
mysql -h myapp-mysql.cluster-xyz.us-east<span class="hljs-number">-1.</span>rds.amazonaws.com \
       -u <span class="hljs-keyword">admin</span> \
       -p \
       -P <span class="hljs-number">3306</span> \
       myapp_database
</div></code></pre>
<h4 id="aws-aurora-mysqlpostgresql-compatible">AWS Aurora (MySQL/PostgreSQL Compatible)</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Creating Aurora Cluster</span>
aws rds <span class="hljs-keyword">create</span>-db-cluster \
    <span class="hljs-comment">--db-cluster-identifier myapp-aurora-cluster \</span>
    <span class="hljs-comment">--engine aurora-mysql \</span>
    <span class="hljs-comment">--engine-version 8.0.mysql_aurora.3.02.0 \</span>
    <span class="hljs-comment">--master-username admin \</span>
    <span class="hljs-comment">--master-user-password MySecurePassword123! \</span>
    <span class="hljs-comment">--vpc-security-group-ids sg-12345678 \</span>
    <span class="hljs-comment">--db-subnet-group-name myapp-subnet-group \</span>
    <span class="hljs-comment">--backup-retention-period 7 \</span>
    <span class="hljs-comment">--storage-encrypted \</span>
    <span class="hljs-comment">--enable-cloudwatch-logs-exports error general slowquery</span>

<span class="hljs-comment">-- Creating Aurora instances</span>
aws rds <span class="hljs-keyword">create</span>-db-<span class="hljs-keyword">instance</span> \
    <span class="hljs-comment">--db-instance-identifier myapp-aurora-writer \</span>
    <span class="hljs-comment">--db-instance-class db.r6g.large \</span>
    <span class="hljs-comment">--engine aurora-mysql \</span>
    <span class="hljs-comment">--db-cluster-identifier myapp-aurora-cluster</span>

aws rds <span class="hljs-keyword">create</span>-db-<span class="hljs-keyword">instance</span> \
    <span class="hljs-comment">--db-instance-identifier myapp-aurora-reader \</span>
    <span class="hljs-comment">--db-instance-class db.r6g.large \</span>
    <span class="hljs-comment">--engine aurora-mysql \</span>
    <span class="hljs-comment">--db-cluster-identifier myapp-aurora-cluster</span>
</div></code></pre>
<h4 id="aws-dynamodb-nosql">AWS DynamoDB (NoSQL)</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">from</span> boto3.dynamodb.conditions <span class="hljs-keyword">import</span> Key, Attr

<span class="hljs-comment"># Initialize DynamoDB client</span>
dynamodb = boto3.resource(<span class="hljs-string">'dynamodb'</span>, region_name=<span class="hljs-string">'us-east-1'</span>)

<span class="hljs-comment"># Create table</span>
table = dynamodb.create_table(
    TableName=<span class="hljs-string">'Users'</span>,
    KeySchema=[
        {
            <span class="hljs-string">'AttributeName'</span>: <span class="hljs-string">'user_id'</span>,
            <span class="hljs-string">'KeyType'</span>: <span class="hljs-string">'HASH'</span>  <span class="hljs-comment"># Partition key</span>
        },
        {
            <span class="hljs-string">'AttributeName'</span>: <span class="hljs-string">'created_at'</span>,
            <span class="hljs-string">'KeyType'</span>: <span class="hljs-string">'RANGE'</span>  <span class="hljs-comment"># Sort key</span>
        }
    ],
    AttributeDefinitions=[
        {
            <span class="hljs-string">'AttributeName'</span>: <span class="hljs-string">'user_id'</span>,
            <span class="hljs-string">'AttributeType'</span>: <span class="hljs-string">'S'</span>
        },
        {
            <span class="hljs-string">'AttributeName'</span>: <span class="hljs-string">'created_at'</span>,
            <span class="hljs-string">'AttributeType'</span>: <span class="hljs-string">'S'</span>
        },
        {
            <span class="hljs-string">'AttributeName'</span>: <span class="hljs-string">'email'</span>,
            <span class="hljs-string">'AttributeType'</span>: <span class="hljs-string">'S'</span>
        }
    ],
    GlobalSecondaryIndexes=[
        {
            <span class="hljs-string">'IndexName'</span>: <span class="hljs-string">'EmailIndex'</span>,
            <span class="hljs-string">'KeySchema'</span>: [
                {
                    <span class="hljs-string">'AttributeName'</span>: <span class="hljs-string">'email'</span>,
                    <span class="hljs-string">'KeyType'</span>: <span class="hljs-string">'HASH'</span>
                }
            ],
            <span class="hljs-string">'Projection'</span>: {
                <span class="hljs-string">'ProjectionType'</span>: <span class="hljs-string">'ALL'</span>
            },
            <span class="hljs-string">'BillingMode'</span>: <span class="hljs-string">'PAY_PER_REQUEST'</span>
        }
    ],
    BillingMode=<span class="hljs-string">'PAY_PER_REQUEST'</span>,
    Tags=[
        {
            <span class="hljs-string">'Key'</span>: <span class="hljs-string">'Environment'</span>,
            <span class="hljs-string">'Value'</span>: <span class="hljs-string">'Production'</span>
        }
    ]
)

<span class="hljs-comment"># Wait for table to be created</span>
table.wait_until_exists()

<span class="hljs-comment"># Insert data</span>
table = dynamodb.Table(<span class="hljs-string">'Users'</span>)
table.put_item(
    Item={
        <span class="hljs-string">'user_id'</span>: <span class="hljs-string">'user123'</span>,
        <span class="hljs-string">'created_at'</span>: <span class="hljs-string">'2024-01-15T10:30:00Z'</span>,
        <span class="hljs-string">'email'</span>: <span class="hljs-string">'user@example.com'</span>,
        <span class="hljs-string">'name'</span>: <span class="hljs-string">'John Doe'</span>,
        <span class="hljs-string">'age'</span>: <span class="hljs-number">30</span>,
        <span class="hljs-string">'preferences'</span>: {
            <span class="hljs-string">'theme'</span>: <span class="hljs-string">'dark'</span>,
            <span class="hljs-string">'notifications'</span>: <span class="hljs-literal">True</span>
        }
    }
)

<span class="hljs-comment"># Query data</span>
response = table.query(
    KeyConditionExpression=Key(<span class="hljs-string">'user_id'</span>).eq(<span class="hljs-string">'user123'</span>)
)

<span class="hljs-comment"># Scan with filter</span>
response = table.scan(
    FilterExpression=Attr(<span class="hljs-string">'age'</span>).gt(<span class="hljs-number">25</span>) &amp; Attr(<span class="hljs-string">'preferences.notifications'</span>).eq(<span class="hljs-literal">True</span>)
)

<span class="hljs-comment"># Update item</span>
table.update_item(
    Key={
        <span class="hljs-string">'user_id'</span>: <span class="hljs-string">'user123'</span>,
        <span class="hljs-string">'created_at'</span>: <span class="hljs-string">'2024-01-15T10:30:00Z'</span>
    },
    UpdateExpression=<span class="hljs-string">'SET age = :age, preferences.theme = :theme'</span>,
    ExpressionAttributeValues={
        <span class="hljs-string">':age'</span>: <span class="hljs-number">31</span>,
        <span class="hljs-string">':theme'</span>: <span class="hljs-string">'light'</span>
    }
)
</div></code></pre>
<h3 id="microsoft-azure">Microsoft Azure</h3>
<h4 id="azure-sql-database">Azure SQL Database</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Creating Azure SQL Database via Azure CLI</span>
az sql server <span class="hljs-keyword">create</span> \
    <span class="hljs-comment">--name myapp-sql-server \</span>
    <span class="hljs-comment">--resource-group myapp-rg \</span>
    <span class="hljs-comment">--location eastus \</span>
    <span class="hljs-comment">--admin-user sqladmin \</span>
    <span class="hljs-comment">--admin-password MySecurePassword123!</span>

az <span class="hljs-keyword">sql</span> db <span class="hljs-keyword">create</span> \
    <span class="hljs-comment">--resource-group myapp-rg \</span>
    <span class="hljs-comment">--server myapp-sql-server \</span>
    <span class="hljs-comment">--name myapp-database \</span>
    <span class="hljs-comment">--service-objective S2 \</span>
    <span class="hljs-comment">--backup-storage-redundancy Local</span>

<span class="hljs-comment">-- Connection string</span>
<span class="hljs-comment">-- Server=myapp-sql-server.database.windows.net;Database=myapp-database;User ID=sqladmin;Password=MySecurePassword123!;Encrypt=True;TrustServerCertificate=False;</span>

<span class="hljs-comment">-- Azure SQL Database specific features</span>
<span class="hljs-comment">-- Automatic tuning</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DATABASE</span> myapp_database <span class="hljs-keyword">SET</span> AUTOMATIC_TUNING (FORCE_LAST_GOOD_PLAN = <span class="hljs-keyword">ON</span>);
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DATABASE</span> myapp_database <span class="hljs-keyword">SET</span> AUTOMATIC_TUNING (CREATE_INDEX = <span class="hljs-keyword">ON</span>);
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DATABASE</span> myapp_database <span class="hljs-keyword">SET</span> AUTOMATIC_TUNING (DROP_INDEX = <span class="hljs-keyword">ON</span>);

<span class="hljs-comment">-- Query Store (automatically enabled)</span>
<span class="hljs-keyword">SELECT</span>
    qsq.query_id,
    qsq.query_sql_text,
    qrs.avg_duration/<span class="hljs-number">1000.0</span> <span class="hljs-keyword">as</span> avg_duration_ms,
    qrs.avg_cpu_time/<span class="hljs-number">1000.0</span> <span class="hljs-keyword">as</span> avg_cpu_time_ms,
    qrs.execution_count
<span class="hljs-keyword">FROM</span> sys.query_store_query qsq
<span class="hljs-keyword">JOIN</span> sys.query_store_plan qsp <span class="hljs-keyword">ON</span> qsq.query_id = qsp.query_id
<span class="hljs-keyword">JOIN</span> sys.query_store_runtime_stats qrs <span class="hljs-keyword">ON</span> qsp.plan_id = qrs.plan_id
<span class="hljs-keyword">WHERE</span> qrs.last_execution_time &gt; <span class="hljs-keyword">DATEADD</span>(<span class="hljs-keyword">hour</span>, <span class="hljs-number">-1</span>, <span class="hljs-keyword">GETUTCDATE</span>())
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> qrs.avg_duration <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Elastic Pool for multiple databases</span>
az sql elastic-pool <span class="hljs-keyword">create</span> \
    <span class="hljs-comment">--resource-group myapp-rg \</span>
    <span class="hljs-comment">--server myapp-sql-server \</span>
    <span class="hljs-comment">--name myapp-elastic-pool \</span>
    <span class="hljs-comment">--edition Standard \</span>
    <span class="hljs-comment">--dtu 100 \</span>
    <span class="hljs-comment">--db-dtu-max 20 \</span>
    <span class="hljs-comment">--db-dtu-min 5</span>
</div></code></pre>
<h4 id="azure-database-for-postgresql">Azure Database for PostgreSQL</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Creating Azure PostgreSQL via Azure CLI</span>
az postgres server <span class="hljs-keyword">create</span> \
    <span class="hljs-comment">--resource-group myapp-rg \</span>
    <span class="hljs-comment">--name myapp-postgres-server \</span>
    <span class="hljs-comment">--location eastus \</span>
    <span class="hljs-comment">--admin-user postgres \</span>
    <span class="hljs-comment">--admin-password MySecurePassword123! \</span>
    <span class="hljs-comment">--sku-name GP_Gen5_2 \</span>
    <span class="hljs-comment">--version 13</span>

az postgres db <span class="hljs-keyword">create</span> \
    <span class="hljs-comment">--resource-group myapp-rg \</span>
    <span class="hljs-comment">--server-name myapp-postgres-server \</span>
    <span class="hljs-comment">--name myapp_database</span>

<span class="hljs-comment">-- Connection via psql</span>
psql <span class="hljs-string">"host=myapp-postgres-server.postgres.database.azure.com port=5432 dbname=myapp_database user=postgres@myapp-postgres-server password=MySecurePassword123! sslmode=require"</span>

<span class="hljs-comment">-- Azure PostgreSQL specific features</span>
<span class="hljs-comment">-- Read replicas</span>
az postgres <span class="hljs-keyword">server</span> replica <span class="hljs-keyword">create</span> \
    <span class="hljs-comment">--name myapp-postgres-replica \</span>
    <span class="hljs-comment">--resource-group myapp-rg \</span>
    <span class="hljs-comment">--source-server myapp-postgres-server</span>

<span class="hljs-comment">-- Point-in-time restore</span>
az postgres <span class="hljs-keyword">server</span> <span class="hljs-keyword">restore</span> \
    <span class="hljs-comment">--resource-group myapp-rg \</span>
    <span class="hljs-comment">--name myapp-postgres-restored \</span>
    <span class="hljs-comment">--restore-point-in-time "2024-01-15T10:00:00Z" \</span>
    <span class="hljs-comment">--source-server myapp-postgres-server</span>
</div></code></pre>
<h3 id="google-cloud-platform-gcp">Google Cloud Platform (GCP)</h3>
<h4 id="google-cloud-sql">Google Cloud SQL</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Creating Cloud SQL MySQL via gcloud CLI</span>
gcloud sql instances <span class="hljs-keyword">create</span> myapp-mysql-<span class="hljs-keyword">instance</span> \
    <span class="hljs-comment">--database-version=MYSQL_8_0 \</span>
    <span class="hljs-comment">--tier=db-n1-standard-2 \</span>
    <span class="hljs-comment">--region=us-central1 \</span>
    <span class="hljs-comment">--root-password=MySecurePassword123! \</span>
    <span class="hljs-comment">--backup-start-time=03:00 \</span>
    <span class="hljs-comment">--enable-bin-log \</span>
    <span class="hljs-comment">--maintenance-window-day=SUN \</span>
    <span class="hljs-comment">--maintenance-window-hour=04 \</span>
    <span class="hljs-comment">--storage-auto-increase \</span>
    <span class="hljs-comment">--storage-size=20GB \</span>
    <span class="hljs-comment">--storage-type=SSD</span>

<span class="hljs-comment">-- Create database</span>
gcloud <span class="hljs-keyword">sql</span> <span class="hljs-keyword">databases</span> <span class="hljs-keyword">create</span> myapp_database \
    <span class="hljs-comment">--instance=myapp-mysql-instance</span>

<span class="hljs-comment">-- Create user</span>
gcloud <span class="hljs-keyword">sql</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">create</span> appuser \
    <span class="hljs-comment">--instance=myapp-mysql-instance \</span>
    <span class="hljs-comment">--password=AppUserPassword123!</span>

<span class="hljs-comment">-- Connection via Cloud SQL Proxy</span>
./cloud_sql_proxy -instances=myproject:us-central1:myapp-mysql-<span class="hljs-keyword">instance</span>=tcp:<span class="hljs-number">3306</span> &amp;
mysql -h <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> -u root -p myapp_database
</div></code></pre>
<h4 id="google-cloud-spanner-globally-distributed">Google Cloud Spanner (Globally Distributed)</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Creating Spanner instance via gcloud</span>
gcloud spanner instances <span class="hljs-keyword">create</span> myapp-spanner-<span class="hljs-keyword">instance</span> \
    <span class="hljs-comment">--config=regional-us-central1 \</span>
    <span class="hljs-comment">--description="MyApp Spanner Instance" \</span>
    <span class="hljs-comment">--nodes=1</span>

<span class="hljs-comment">-- Create database</span>
gcloud spanner <span class="hljs-keyword">databases</span> <span class="hljs-keyword">create</span> myapp_database \
    <span class="hljs-comment">--instance=myapp-spanner-instance</span>

<span class="hljs-comment">-- DDL for Spanner</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">Users</span> (
    UserId <span class="hljs-keyword">STRING</span>(<span class="hljs-number">36</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    Email <span class="hljs-keyword">STRING</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">Name</span> <span class="hljs-keyword">STRING</span>(<span class="hljs-number">100</span>),
    CreatedAt <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> OPTIONS (allow_commit_timestamp=<span class="hljs-literal">true</span>),
    UpdatedAt <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> OPTIONS (allow_commit_timestamp=<span class="hljs-literal">true</span>)
) PRIMARY <span class="hljs-keyword">KEY</span> (UserId);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> UsersByEmail <span class="hljs-keyword">ON</span> <span class="hljs-keyword">Users</span>(Email);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> Orders (
    OrderId <span class="hljs-keyword">STRING</span>(<span class="hljs-number">36</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    UserId <span class="hljs-keyword">STRING</span>(<span class="hljs-number">36</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    TotalAmount <span class="hljs-built_in">NUMERIC</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">Status</span> <span class="hljs-keyword">STRING</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    CreatedAt <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> OPTIONS (allow_commit_timestamp=<span class="hljs-literal">true</span>)
) PRIMARY <span class="hljs-keyword">KEY</span> (UserId, OrderId),
  INTERLEAVE <span class="hljs-keyword">IN</span> <span class="hljs-keyword">PARENT</span> <span class="hljs-keyword">Users</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">CASCADE</span>;

<span class="hljs-comment">-- Spanner-specific queries</span>
<span class="hljs-comment">-- Strong consistency read</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">Users</span> <span class="hljs-keyword">WHERE</span> UserId = @user_id;

<span class="hljs-comment">-- Stale read (for better performance)</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">Users</span> <span class="hljs-keyword">WHERE</span> Email = @email
OPTIONS (read_timestamp = <span class="hljs-keyword">CURRENT_TIMESTAMP</span>() - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-number">10</span> <span class="hljs-keyword">SECOND</span>);

<span class="hljs-comment">-- Partitioned DML for large updates</span>
PARTITION <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">Users</span> <span class="hljs-keyword">SET</span> UpdatedAt = PENDING_COMMIT_TIMESTAMP()
<span class="hljs-keyword">WHERE</span> CreatedAt &lt; TIMESTAMP_SUB(<span class="hljs-keyword">CURRENT_TIMESTAMP</span>(), <span class="hljs-built_in">INTERVAL</span> <span class="hljs-number">30</span> <span class="hljs-keyword">DAY</span>);
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%84-database-migration-to-cloud">ğŸ”„ Database Migration to Cloud</h2>
<h3 id="migration-strategies">Migration Strategies</h3>
<ol>
<li>
<p><strong>Lift and Shift</strong></p>
<ul>
<li>Move existing database to cloud VMs</li>
<li>Minimal changes required</li>
<li>Quick migration but limited cloud benefits</li>
</ul>
</li>
<li>
<p><strong>Re-platform</strong></p>
<ul>
<li>Move to managed database services</li>
<li>Some application changes may be needed</li>
<li>Better cloud integration</li>
</ul>
</li>
<li>
<p><strong>Re-architect</strong></p>
<ul>
<li>Redesign for cloud-native services</li>
<li>Significant changes but maximum benefits</li>
<li>Microservices, serverless, etc.</li>
</ul>
</li>
</ol>
<h3 id="aws-database-migration-service-dms">AWS Database Migration Service (DMS)</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">import</span> json

<span class="hljs-comment"># Initialize DMS client</span>
dms = boto3.client(<span class="hljs-string">'dms'</span>, region_name=<span class="hljs-string">'us-east-1'</span>)

<span class="hljs-comment"># Create replication subnet group</span>
response = dms.create_replication_subnet_group(
    ReplicationSubnetGroupIdentifier=<span class="hljs-string">'myapp-dms-subnet-group'</span>,
    ReplicationSubnetGroupDescription=<span class="hljs-string">'DMS subnet group for MyApp migration'</span>,
    SubnetIds=[
        <span class="hljs-string">'subnet-12345678'</span>,
        <span class="hljs-string">'subnet-87654321'</span>
    ],
    Tags=[
        {
            <span class="hljs-string">'Key'</span>: <span class="hljs-string">'Environment'</span>,
            <span class="hljs-string">'Value'</span>: <span class="hljs-string">'Migration'</span>
        }
    ]
)

<span class="hljs-comment"># Create replication instance</span>
response = dms.create_replication_instance(
    ReplicationInstanceIdentifier=<span class="hljs-string">'myapp-dms-instance'</span>,
    ReplicationInstanceClass=<span class="hljs-string">'dms.t3.micro'</span>,
    AllocatedStorage=<span class="hljs-number">20</span>,
    VpcSecurityGroupIds=[
        <span class="hljs-string">'sg-12345678'</span>
    ],
    ReplicationSubnetGroupIdentifier=<span class="hljs-string">'myapp-dms-subnet-group'</span>,
    MultiAZ=<span class="hljs-literal">False</span>,
    PubliclyAccessible=<span class="hljs-literal">False</span>,
    Tags=[
        {
            <span class="hljs-string">'Key'</span>: <span class="hljs-string">'Environment'</span>,
            <span class="hljs-string">'Value'</span>: <span class="hljs-string">'Migration'</span>
        }
    ]
)

<span class="hljs-comment"># Create source endpoint (on-premises MySQL)</span>
response = dms.create_endpoint(
    EndpointIdentifier=<span class="hljs-string">'myapp-source-mysql'</span>,
    EndpointType=<span class="hljs-string">'source'</span>,
    EngineName=<span class="hljs-string">'mysql'</span>,
    Username=<span class="hljs-string">'dms_user'</span>,
    Password=<span class="hljs-string">'dms_password'</span>,
    ServerName=<span class="hljs-string">'onprem-mysql.company.com'</span>,
    Port=<span class="hljs-number">3306</span>,
    DatabaseName=<span class="hljs-string">'myapp_production'</span>,
    ExtraConnectionAttributes=<span class="hljs-string">'initstmt=SET foreign_key_checks=0'</span>,
    Tags=[
        {
            <span class="hljs-string">'Key'</span>: <span class="hljs-string">'Type'</span>,
            <span class="hljs-string">'Value'</span>: <span class="hljs-string">'Source'</span>
        }
    ]
)

<span class="hljs-comment"># Create target endpoint (AWS RDS)</span>
response = dms.create_endpoint(
    EndpointIdentifier=<span class="hljs-string">'myapp-target-rds'</span>,
    EndpointType=<span class="hljs-string">'target'</span>,
    EngineName=<span class="hljs-string">'mysql'</span>,
    Username=<span class="hljs-string">'admin'</span>,
    Password=<span class="hljs-string">'MySecurePassword123!'</span>,
    ServerName=<span class="hljs-string">'myapp-mysql.cluster-xyz.us-east-1.rds.amazonaws.com'</span>,
    Port=<span class="hljs-number">3306</span>,
    DatabaseName=<span class="hljs-string">'myapp_production'</span>,
    Tags=[
        {
            <span class="hljs-string">'Key'</span>: <span class="hljs-string">'Type'</span>,
            <span class="hljs-string">'Value'</span>: <span class="hljs-string">'Target'</span>
        }
    ]
)

<span class="hljs-comment"># Create migration task</span>
table_mappings = {
    <span class="hljs-string">"rules"</span>: [
        {
            <span class="hljs-string">"rule-type"</span>: <span class="hljs-string">"selection"</span>,
            <span class="hljs-string">"rule-id"</span>: <span class="hljs-string">"1"</span>,
            <span class="hljs-string">"rule-name"</span>: <span class="hljs-string">"1"</span>,
            <span class="hljs-string">"object-locator"</span>: {
                <span class="hljs-string">"schema-name"</span>: <span class="hljs-string">"myapp_production"</span>,
                <span class="hljs-string">"table-name"</span>: <span class="hljs-string">"%"</span>
            },
            <span class="hljs-string">"rule-action"</span>: <span class="hljs-string">"include"</span>
        },
        {
            <span class="hljs-string">"rule-type"</span>: <span class="hljs-string">"transformation"</span>,
            <span class="hljs-string">"rule-id"</span>: <span class="hljs-string">"2"</span>,
            <span class="hljs-string">"rule-name"</span>: <span class="hljs-string">"2"</span>,
            <span class="hljs-string">"rule-target"</span>: <span class="hljs-string">"table"</span>,
            <span class="hljs-string">"object-locator"</span>: {
                <span class="hljs-string">"schema-name"</span>: <span class="hljs-string">"myapp_production"</span>,
                <span class="hljs-string">"table-name"</span>: <span class="hljs-string">"user_sessions"</span>
            },
            <span class="hljs-string">"rule-action"</span>: <span class="hljs-string">"exclude"</span>
        }
    ]
}

response = dms.create_replication_task(
    ReplicationTaskIdentifier=<span class="hljs-string">'myapp-migration-task'</span>,
    SourceEndpointArn=<span class="hljs-string">'arn:aws:dms:us-east-1:123456789012:endpoint:myapp-source-mysql'</span>,
    TargetEndpointArn=<span class="hljs-string">'arn:aws:dms:us-east-1:123456789012:endpoint:myapp-target-rds'</span>,
    ReplicationInstanceArn=<span class="hljs-string">'arn:aws:dms:us-east-1:123456789012:rep:myapp-dms-instance'</span>,
    MigrationType=<span class="hljs-string">'full-load-and-cdc'</span>,
    TableMappings=json.dumps(table_mappings),
    ReplicationTaskSettings=json.dumps({
        <span class="hljs-string">"TargetMetadata"</span>: {
            <span class="hljs-string">"TargetSchema"</span>: <span class="hljs-string">""</span>,
            <span class="hljs-string">"SupportLobs"</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">"FullLobMode"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"LobChunkSize"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"LimitedSizeLobMode"</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">"LobMaxSize"</span>: <span class="hljs-number">32</span>,
            <span class="hljs-string">"InlineLobMaxSize"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"LoadMaxFileSize"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"ParallelLoadThreads"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"ParallelLoadBufferSize"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"BatchApplyEnabled"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"TaskRecoveryTableEnabled"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"ParallelApplyThreads"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"ParallelApplyBufferSize"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"ParallelApplyQueuesPerThread"</span>: <span class="hljs-number">0</span>
        },
        <span class="hljs-string">"FullLoadSettings"</span>: {
            <span class="hljs-string">"TargetTablePrepMode"</span>: <span class="hljs-string">"DROP_AND_CREATE"</span>,
            <span class="hljs-string">"CreatePkAfterFullLoad"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"StopTaskCachedChangesApplied"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"StopTaskCachedChangesNotApplied"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"MaxFullLoadSubTasks"</span>: <span class="hljs-number">8</span>,
            <span class="hljs-string">"TransactionConsistencyTimeout"</span>: <span class="hljs-number">600</span>,
            <span class="hljs-string">"CommitRate"</span>: <span class="hljs-number">10000</span>
        },
        <span class="hljs-string">"Logging"</span>: {
            <span class="hljs-string">"EnableLogging"</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">"LogComponents"</span>: [
                {
                    <span class="hljs-string">"Id"</span>: <span class="hljs-string">"SOURCE_UNLOAD"</span>,
                    <span class="hljs-string">"Severity"</span>: <span class="hljs-string">"LOGGER_SEVERITY_DEFAULT"</span>
                },
                {
                    <span class="hljs-string">"Id"</span>: <span class="hljs-string">"TARGET_LOAD"</span>,
                    <span class="hljs-string">"Severity"</span>: <span class="hljs-string">"LOGGER_SEVERITY_DEFAULT"</span>
                }
            ]
        }
    }),
    Tags=[
        {
            <span class="hljs-string">'Key'</span>: <span class="hljs-string">'Environment'</span>,
            <span class="hljs-string">'Value'</span>: <span class="hljs-string">'Migration'</span>
        }
    ]
)

<span class="hljs-comment"># Start migration task</span>
response = dms.start_replication_task(
    ReplicationTaskArn=<span class="hljs-string">'arn:aws:dms:us-east-1:123456789012:task:myapp-migration-task'</span>,
    StartReplicationTaskType=<span class="hljs-string">'start-replication'</span>
)

<span class="hljs-comment"># Monitor migration progress</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_migration_status</span><span class="hljs-params">(task_arn)</span>:</span>
    response = dms.describe_replication_tasks(
        Filters=[
            {
                <span class="hljs-string">'Name'</span>: <span class="hljs-string">'replication-task-arn'</span>,
                <span class="hljs-string">'Values'</span>: [task_arn]
            }
        ]
    )

    task = response[<span class="hljs-string">'ReplicationTasks'</span>][<span class="hljs-number">0</span>]
    status = task[<span class="hljs-string">'Status'</span>]

    <span class="hljs-keyword">if</span> <span class="hljs-string">'ReplicationTaskStats'</span> <span class="hljs-keyword">in</span> task:
        stats = task[<span class="hljs-string">'ReplicationTaskStats'</span>]
        print(<span class="hljs-string">f"Status: <span class="hljs-subst">{status}</span>"</span>)
        print(<span class="hljs-string">f"Full Load Progress: <span class="hljs-subst">{stats.get(<span class="hljs-string">'FullLoadProgressPercent'</span>, <span class="hljs-number">0</span>)}</span>%"</span>)
        print(<span class="hljs-string">f"Tables Loaded: <span class="hljs-subst">{stats.get(<span class="hljs-string">'TablesLoaded'</span>, <span class="hljs-number">0</span>)}</span>"</span>)
        print(<span class="hljs-string">f"Tables Loading: <span class="hljs-subst">{stats.get(<span class="hljs-string">'TablesLoading'</span>, <span class="hljs-number">0</span>)}</span>"</span>)
        print(<span class="hljs-string">f"Tables Queued: <span class="hljs-subst">{stats.get(<span class="hljs-string">'TablesQueued'</span>, <span class="hljs-number">0</span>)}</span>"</span>)
        print(<span class="hljs-string">f"Tables Errored: <span class="hljs-subst">{stats.get(<span class="hljs-string">'TablesErrored'</span>, <span class="hljs-number">0</span>)}</span>"</span>)

    <span class="hljs-keyword">return</span> status

<span class="hljs-comment"># Usage</span>
status = check_migration_status(<span class="hljs-string">'arn:aws:dms:us-east-1:123456789012:task:myapp-migration-task'</span>)
</div></code></pre>
<h3 id="schema-conversion-tool-sct">Schema Conversion Tool (SCT)</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># AWS SCT automation script</span>
<span class="hljs-keyword">import</span> subprocess
<span class="hljs-keyword">import</span> json

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AWSSchemaConversionTool</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, sct_path)</span>:</span>
        self.sct_path = sct_path

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_project</span><span class="hljs-params">(self, project_name, source_config, target_config)</span>:</span>
        <span class="hljs-string">"""Create SCT project"""</span>
        project_config = {
            <span class="hljs-string">"projectName"</span>: project_name,
            <span class="hljs-string">"sourceDatabase"</span>: source_config,
            <span class="hljs-string">"targetDatabase"</span>: target_config
        }

        <span class="hljs-keyword">with</span> open(<span class="hljs-string">f"<span class="hljs-subst">{project_name}</span>_config.json"</span>, <span class="hljs-string">'w'</span>) <span class="hljs-keyword">as</span> f:
            json.dump(project_config, f, indent=<span class="hljs-number">2</span>)

        cmd = [
            self.sct_path,
            <span class="hljs-string">"--create-project"</span>,
            <span class="hljs-string">f"<span class="hljs-subst">{project_name}</span>_config.json"</span>
        ]

        result = subprocess.run(cmd, capture_output=<span class="hljs-literal">True</span>, text=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">return</span> result.returncode == <span class="hljs-number">0</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_schema</span><span class="hljs-params">(self, project_file, output_dir)</span>:</span>
        <span class="hljs-string">"""Convert database schema"""</span>
        cmd = [
            self.sct_path,
            <span class="hljs-string">"--project"</span>, project_file,
            <span class="hljs-string">"--convert-schema"</span>,
            <span class="hljs-string">"--output-dir"</span>, output_dir
        ]

        result = subprocess.run(cmd, capture_output=<span class="hljs-literal">True</span>, text=<span class="hljs-literal">True</span>)

        <span class="hljs-keyword">if</span> result.returncode == <span class="hljs-number">0</span>:
            print(<span class="hljs-string">"Schema conversion completed successfully"</span>)
            print(<span class="hljs-string">f"Converted files saved to: <span class="hljs-subst">{output_dir}</span>"</span>)
        <span class="hljs-keyword">else</span>:
            print(<span class="hljs-string">f"Schema conversion failed: <span class="hljs-subst">{result.stderr}</span>"</span>)

        <span class="hljs-keyword">return</span> result.returncode == <span class="hljs-number">0</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_assessment_report</span><span class="hljs-params">(self, project_file, report_path)</span>:</span>
        <span class="hljs-string">"""Generate migration assessment report"""</span>
        cmd = [
            self.sct_path,
            <span class="hljs-string">"--project"</span>, project_file,
            <span class="hljs-string">"--assessment-report"</span>,
            <span class="hljs-string">"--output"</span>, report_path
        ]

        result = subprocess.run(cmd, capture_output=<span class="hljs-literal">True</span>, text=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">return</span> result.returncode == <span class="hljs-number">0</span>

<span class="hljs-comment"># Usage example</span>
sct = AWSSchemaConversionTool(<span class="hljs-string">"/opt/aws-schema-conversion-tool/bin/aws-sct"</span>)

<span class="hljs-comment"># Source database configuration (Oracle)</span>
source_config = {
    <span class="hljs-string">"engine"</span>: <span class="hljs-string">"oracle"</span>,
    <span class="hljs-string">"host"</span>: <span class="hljs-string">"oracle.company.com"</span>,
    <span class="hljs-string">"port"</span>: <span class="hljs-number">1521</span>,
    <span class="hljs-string">"database"</span>: <span class="hljs-string">"ORCL"</span>,
    <span class="hljs-string">"username"</span>: <span class="hljs-string">"hr"</span>,
    <span class="hljs-string">"password"</span>: <span class="hljs-string">"password"</span>,
    <span class="hljs-string">"schemas"</span>: [<span class="hljs-string">"HR"</span>, <span class="hljs-string">"SALES"</span>]
}

<span class="hljs-comment"># Target database configuration (PostgreSQL)</span>
target_config = {
    <span class="hljs-string">"engine"</span>: <span class="hljs-string">"postgresql"</span>,
    <span class="hljs-string">"host"</span>: <span class="hljs-string">"myapp-postgres.cluster-xyz.us-east-1.rds.amazonaws.com"</span>,
    <span class="hljs-string">"port"</span>: <span class="hljs-number">5432</span>,
    <span class="hljs-string">"database"</span>: <span class="hljs-string">"myapp_production"</span>,
    <span class="hljs-string">"username"</span>: <span class="hljs-string">"postgres"</span>,
    <span class="hljs-string">"password"</span>: <span class="hljs-string">"MySecurePassword123!"</span>
}

<span class="hljs-comment"># Create project and convert</span>
sct.create_project(<span class="hljs-string">"oracle_to_postgres_migration"</span>, source_config, target_config)
sct.convert_schema(<span class="hljs-string">"oracle_to_postgres_migration.sct"</span>, <span class="hljs-string">"./converted_schema"</span>)
sct.generate_assessment_report(<span class="hljs-string">"oracle_to_postgres_migration.sct"</span>, <span class="hljs-string">"./assessment_report.html"</span>)
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%80-serverless-databases">ğŸš€ Serverless Databases</h2>
<h3 id="aws-aurora-serverless">AWS Aurora Serverless</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> botocore.exceptions <span class="hljs-keyword">import</span> ClientError

<span class="hljs-comment"># Initialize RDS Data API client</span>
rds_data = boto3.client(<span class="hljs-string">'rds-data'</span>, region_name=<span class="hljs-string">'us-east-1'</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuroraServerlessManager</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, cluster_arn, secret_arn, database_name)</span>:</span>
        self.cluster_arn = cluster_arn
        self.secret_arn = secret_arn
        self.database_name = database_name
        self.client = boto3.client(<span class="hljs-string">'rds-data'</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">execute_sql</span><span class="hljs-params">(self, sql, parameters=None)</span>:</span>
        <span class="hljs-string">"""Execute SQL statement using Data API"""</span>
        <span class="hljs-keyword">try</span>:
            kwargs = {
                <span class="hljs-string">'resourceArn'</span>: self.cluster_arn,
                <span class="hljs-string">'secretArn'</span>: self.secret_arn,
                <span class="hljs-string">'database'</span>: self.database_name,
                <span class="hljs-string">'sql'</span>: sql
            }

            <span class="hljs-keyword">if</span> parameters:
                kwargs[<span class="hljs-string">'parameters'</span>] = parameters

            response = self.client.execute_statement(**kwargs)
            <span class="hljs-keyword">return</span> response

        <span class="hljs-keyword">except</span> ClientError <span class="hljs-keyword">as</span> e:
            print(<span class="hljs-string">f"Error executing SQL: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">begin_transaction</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Begin a transaction"""</span>
        response = self.client.begin_transaction(
            resourceArn=self.cluster_arn,
            secretArn=self.secret_arn,
            database=self.database_name
        )
        <span class="hljs-keyword">return</span> response[<span class="hljs-string">'transactionId'</span>]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">commit_transaction</span><span class="hljs-params">(self, transaction_id)</span>:</span>
        <span class="hljs-string">"""Commit a transaction"""</span>
        response = self.client.commit_transaction(
            resourceArn=self.cluster_arn,
            secretArn=self.secret_arn,
            transactionId=transaction_id
        )
        <span class="hljs-keyword">return</span> response

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rollback_transaction</span><span class="hljs-params">(self, transaction_id)</span>:</span>
        <span class="hljs-string">"""Rollback a transaction"""</span>
        response = self.client.rollback_transaction(
            resourceArn=self.cluster_arn,
            secretArn=self.secret_arn,
            transactionId=transaction_id
        )
        <span class="hljs-keyword">return</span> response

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">batch_execute_sql</span><span class="hljs-params">(self, sql, parameter_sets)</span>:</span>
        <span class="hljs-string">"""Execute SQL with multiple parameter sets"""</span>
        response = self.client.batch_execute_statement(
            resourceArn=self.cluster_arn,
            secretArn=self.secret_arn,
            database=self.database_name,
            sql=sql,
            parameterSets=parameter_sets
        )
        <span class="hljs-keyword">return</span> response

<span class="hljs-comment"># Usage example</span>
aurora_manager = AuroraServerlessManager(
    cluster_arn=<span class="hljs-string">'arn:aws:rds:us-east-1:123456789012:cluster:myapp-aurora-serverless'</span>,
    secret_arn=<span class="hljs-string">'arn:aws:secretsmanager:us-east-1:123456789012:secret:myapp-aurora-secret'</span>,
    database_name=<span class="hljs-string">'myapp_production'</span>
)

<span class="hljs-comment"># Create table</span>
create_table_sql = <span class="hljs-string">"""
CREATE TABLE IF NOT EXISTS users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
)
"""</span>

aurora_manager.execute_sql(create_table_sql)

<span class="hljs-comment"># Insert data with parameters</span>
insert_sql = <span class="hljs-string">"INSERT INTO users (email, name) VALUES (:email, :name)"</span>
parameters = [
    {<span class="hljs-string">'name'</span>: <span class="hljs-string">'email'</span>, <span class="hljs-string">'value'</span>: {<span class="hljs-string">'stringValue'</span>: <span class="hljs-string">'john@example.com'</span>}},
    {<span class="hljs-string">'name'</span>: <span class="hljs-string">'name'</span>, <span class="hljs-string">'value'</span>: {<span class="hljs-string">'stringValue'</span>: <span class="hljs-string">'John Doe'</span>}}
]

result = aurora_manager.execute_sql(insert_sql, parameters)
print(<span class="hljs-string">f"Inserted user with ID: <span class="hljs-subst">{result[<span class="hljs-string">'generatedFields'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'longValue'</span>]}</span>"</span>)

<span class="hljs-comment"># Batch insert</span>
batch_insert_sql = <span class="hljs-string">"INSERT INTO users (email, name) VALUES (:email, :name)"</span>
batch_parameters = [
    [
        {<span class="hljs-string">'name'</span>: <span class="hljs-string">'email'</span>, <span class="hljs-string">'value'</span>: {<span class="hljs-string">'stringValue'</span>: <span class="hljs-string">'alice@example.com'</span>}},
        {<span class="hljs-string">'name'</span>: <span class="hljs-string">'name'</span>, <span class="hljs-string">'value'</span>: {<span class="hljs-string">'stringValue'</span>: <span class="hljs-string">'Alice Smith'</span>}}
    ],
    [
        {<span class="hljs-string">'name'</span>: <span class="hljs-string">'email'</span>, <span class="hljs-string">'value'</span>: {<span class="hljs-string">'stringValue'</span>: <span class="hljs-string">'bob@example.com'</span>}},
        {<span class="hljs-string">'name'</span>: <span class="hljs-string">'name'</span>, <span class="hljs-string">'value'</span>: {<span class="hljs-string">'stringValue'</span>: <span class="hljs-string">'Bob Johnson'</span>}}
    ]
]

aurora_manager.batch_execute_sql(batch_insert_sql, batch_parameters)

<span class="hljs-comment"># Query data</span>
select_sql = <span class="hljs-string">"SELECT id, email, name, created_at FROM users WHERE email LIKE :email_pattern"</span>
query_parameters = [
    {<span class="hljs-string">'name'</span>: <span class="hljs-string">'email_pattern'</span>, <span class="hljs-string">'value'</span>: {<span class="hljs-string">'stringValue'</span>: <span class="hljs-string">'%@example.com'</span>}}
]

result = aurora_manager.execute_sql(select_sql, query_parameters)

<span class="hljs-keyword">for</span> record <span class="hljs-keyword">in</span> result[<span class="hljs-string">'records'</span>]:
    user_id = record[<span class="hljs-number">0</span>][<span class="hljs-string">'longValue'</span>]
    email = record[<span class="hljs-number">1</span>][<span class="hljs-string">'stringValue'</span>]
    name = record[<span class="hljs-number">2</span>][<span class="hljs-string">'stringValue'</span>]
    created_at = record[<span class="hljs-number">3</span>][<span class="hljs-string">'stringValue'</span>]
    print(<span class="hljs-string">f"User <span class="hljs-subst">{user_id}</span>: <span class="hljs-subst">{name}</span> (<span class="hljs-subst">{email}</span>) - Created: <span class="hljs-subst">{created_at}</span>"</span>)

<span class="hljs-comment"># Transaction example</span>
transaction_id = aurora_manager.begin_transaction()

<span class="hljs-keyword">try</span>:
    <span class="hljs-comment"># Update user</span>
    update_sql = <span class="hljs-string">"UPDATE users SET name = :name WHERE email = :email"</span>
    update_params = [
        {<span class="hljs-string">'name'</span>: <span class="hljs-string">'name'</span>, <span class="hljs-string">'value'</span>: {<span class="hljs-string">'stringValue'</span>: <span class="hljs-string">'John Smith'</span>}},
        {<span class="hljs-string">'name'</span>: <span class="hljs-string">'email'</span>, <span class="hljs-string">'value'</span>: {<span class="hljs-string">'stringValue'</span>: <span class="hljs-string">'john@example.com'</span>}}
    ]

    aurora_manager.execute_sql(update_sql, update_params)

    <span class="hljs-comment"># Insert audit log</span>
    audit_sql = <span class="hljs-string">"INSERT INTO audit_log (action, table_name, record_id) VALUES (:action, :table_name, :record_id)"</span>
    audit_params = [
        {<span class="hljs-string">'name'</span>: <span class="hljs-string">'action'</span>, <span class="hljs-string">'value'</span>: {<span class="hljs-string">'stringValue'</span>: <span class="hljs-string">'UPDATE'</span>}},
        {<span class="hljs-string">'name'</span>: <span class="hljs-string">'table_name'</span>, <span class="hljs-string">'value'</span>: {<span class="hljs-string">'stringValue'</span>: <span class="hljs-string">'users'</span>}},
        {<span class="hljs-string">'name'</span>: <span class="hljs-string">'record_id'</span>, <span class="hljs-string">'value'</span>: {<span class="hljs-string">'longValue'</span>: <span class="hljs-number">1</span>}}
    ]

    aurora_manager.execute_sql(audit_sql, audit_params)

    <span class="hljs-comment"># Commit transaction</span>
    aurora_manager.commit_transaction(transaction_id)
    print(<span class="hljs-string">"Transaction committed successfully"</span>)

<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-comment"># Rollback on error</span>
    aurora_manager.rollback_transaction(transaction_id)
    print(<span class="hljs-string">f"Transaction rolled back due to error: <span class="hljs-subst">{e}</span>"</span>)
</div></code></pre>
<h3 id="azure-sql-database-serverless">Azure SQL Database Serverless</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Creating Azure SQL Database Serverless</span>
az sql db <span class="hljs-keyword">create</span> \
    <span class="hljs-comment">--resource-group myapp-rg \</span>
    <span class="hljs-comment">--server myapp-sql-server \</span>
    <span class="hljs-comment">--name myapp-serverless-db \</span>
    <span class="hljs-comment">--edition GeneralPurpose \</span>
    <span class="hljs-comment">--compute-model Serverless \</span>
    <span class="hljs-comment">--family Gen5 \</span>
    <span class="hljs-comment">--capacity 1 \</span>
    <span class="hljs-comment">--auto-pause-delay 60 \</span>
    <span class="hljs-comment">--min-capacity 0.5</span>

<span class="hljs-comment">-- Monitor serverless database usage</span>
<span class="hljs-keyword">SELECT</span>
    start_time,
    end_time,
    avg_cpu_percent,
    avg_data_io_percent,
    avg_log_write_percent,
    max_worker_percent,
    max_session_percent
<span class="hljs-keyword">FROM</span> sys.dm_db_resource_stats
<span class="hljs-keyword">WHERE</span> start_time &gt; <span class="hljs-keyword">DATEADD</span>(<span class="hljs-keyword">hour</span>, <span class="hljs-number">-24</span>, <span class="hljs-keyword">GETUTCDATE</span>())
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> start_time <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Check auto-pause status</span>
<span class="hljs-keyword">SELECT</span>
    database_id,
    <span class="hljs-keyword">name</span>,
    state_desc,
    create_date
<span class="hljs-keyword">FROM</span> sys.databases
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">name</span> = <span class="hljs-string">'myapp-serverless-db'</span>;
</div></code></pre>
<hr>
<h2 id="%F0%9F%94%90-security-and-compliance">ğŸ” Security and Compliance</h2>
<h3 id="encryption-at-rest-and-in-transit">Encryption at Rest and in Transit</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># AWS RDS Encryption</span>
<span class="hljs-keyword">import</span> boto3

rds = boto3.client(<span class="hljs-string">'rds'</span>)

<span class="hljs-comment"># Create encrypted RDS instance</span>
response = rds.create_db_instance(
    DBInstanceIdentifier=<span class="hljs-string">'myapp-encrypted-db'</span>,
    DBInstanceClass=<span class="hljs-string">'db.t3.micro'</span>,
    Engine=<span class="hljs-string">'mysql'</span>,
    MasterUsername=<span class="hljs-string">'admin'</span>,
    MasterUserPassword=<span class="hljs-string">'MySecurePassword123!'</span>,
    AllocatedStorage=<span class="hljs-number">20</span>,
    StorageEncrypted=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># Enable encryption at rest</span>
    KmsKeyId=<span class="hljs-string">'arn:aws:kms:us-east-1:123456789012:key/12345678-1234-1234-1234-123456789012'</span>,
    VpcSecurityGroupIds=[<span class="hljs-string">'sg-12345678'</span>],
    BackupRetentionPeriod=<span class="hljs-number">7</span>,
    MultiAZ=<span class="hljs-literal">True</span>,
    Tags=[
        {
            <span class="hljs-string">'Key'</span>: <span class="hljs-string">'Environment'</span>,
            <span class="hljs-string">'Value'</span>: <span class="hljs-string">'Production'</span>
        },
        {
            <span class="hljs-string">'Key'</span>: <span class="hljs-string">'Encryption'</span>,
            <span class="hljs-string">'Value'</span>: <span class="hljs-string">'Enabled'</span>
        }
    ]
)

<span class="hljs-comment"># SSL/TLS connection configuration</span>
connection_config = {
    <span class="hljs-string">'host'</span>: <span class="hljs-string">'myapp-encrypted-db.cluster-xyz.us-east-1.rds.amazonaws.com'</span>,
    <span class="hljs-string">'user'</span>: <span class="hljs-string">'admin'</span>,
    <span class="hljs-string">'password'</span>: <span class="hljs-string">'MySecurePassword123!'</span>,
    <span class="hljs-string">'database'</span>: <span class="hljs-string">'myapp_production'</span>,
    <span class="hljs-string">'ssl_ca'</span>: <span class="hljs-string">'/path/to/rds-ca-2019-root.pem'</span>,
    <span class="hljs-string">'ssl_verify_cert'</span>: <span class="hljs-literal">True</span>,
    <span class="hljs-string">'ssl_verify_identity'</span>: <span class="hljs-literal">True</span>
}
</div></code></pre>
<h3 id="identity-and-access-management-iam">Identity and Access Management (IAM)</h3>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"Version"</span>: <span class="hljs-string">"2012-10-17"</span>,
  <span class="hljs-attr">"Statement"</span>: [
    {
      <span class="hljs-attr">"Sid"</span>: <span class="hljs-string">"AllowRDSAccess"</span>,
      <span class="hljs-attr">"Effect"</span>: <span class="hljs-string">"Allow"</span>,
      <span class="hljs-attr">"Principal"</span>: {
        <span class="hljs-attr">"AWS"</span>: <span class="hljs-string">"arn:aws:iam::123456789012:role/MyAppDatabaseRole"</span>
      },
      <span class="hljs-attr">"Action"</span>: [<span class="hljs-string">"rds-db:connect"</span>],
      <span class="hljs-attr">"Resource"</span>: [
        <span class="hljs-string">"arn:aws:rds-db:us-east-1:123456789012:dbuser:myapp-mysql-instance/myapp_user"</span>
      ]
    },
    {
      <span class="hljs-attr">"Sid"</span>: <span class="hljs-string">"AllowSecretsManagerAccess"</span>,
      <span class="hljs-attr">"Effect"</span>: <span class="hljs-string">"Allow"</span>,
      <span class="hljs-attr">"Action"</span>: [
        <span class="hljs-string">"secretsmanager:GetSecretValue"</span>,
        <span class="hljs-string">"secretsmanager:DescribeSecret"</span>
      ],
      <span class="hljs-attr">"Resource"</span>: [
        <span class="hljs-string">"arn:aws:secretsmanager:us-east-1:123456789012:secret:myapp/database/credentials-*"</span>
      ]
    }
  ]
}
</div></code></pre>
<h3 id="database-activity-monitoring">Database Activity Monitoring</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># AWS RDS Performance Insights</span>
<span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta

pi = boto3.client(<span class="hljs-string">'pi'</span>, region_name=<span class="hljs-string">'us-east-1'</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PerformanceInsightsMonitor</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, resource_id)</span>:</span>
        self.resource_id = resource_id
        self.client = pi

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_top_sql_statements</span><span class="hljs-params">(self, hours=<span class="hljs-number">1</span>)</span>:</span>
        <span class="hljs-string">"""Get top SQL statements by CPU usage"""</span>
        end_time = datetime.utcnow()
        start_time = end_time - timedelta(hours=hours)

        response = self.client.get_dimension_key_details(
            ServiceType=<span class="hljs-string">'RDS'</span>,
            Identifier=self.resource_id,
            Group=<span class="hljs-string">'db.SQL_Innodb.Innodb_rows_read.avg'</span>,
            RequestedDimensions=[<span class="hljs-string">'db.sql.Innodb_rows_read.avg'</span>]
        )

        <span class="hljs-keyword">return</span> response

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_resource_metrics</span><span class="hljs-params">(self, metric_queries, hours=<span class="hljs-number">1</span>)</span>:</span>
        <span class="hljs-string">"""Get resource metrics"""</span>
        end_time = datetime.utcnow()
        start_time = end_time - timedelta(hours=hours)

        response = self.client.get_resource_metrics(
            ServiceType=<span class="hljs-string">'RDS'</span>,
            Identifier=self.resource_id,
            MetricQueries=metric_queries,
            StartTime=start_time,
            EndTime=end_time,
            PeriodInSeconds=<span class="hljs-number">300</span>
        )

        <span class="hljs-keyword">return</span> response

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">analyze_performance</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Analyze database performance"""</span>
        <span class="hljs-comment"># Define metric queries</span>
        metric_queries = [
            {
                <span class="hljs-string">'Metric'</span>: <span class="hljs-string">'db.CPU.Innodb_rows_read.avg'</span>,
                <span class="hljs-string">'GroupBy'</span>: {
                    <span class="hljs-string">'Group'</span>: <span class="hljs-string">'db.sql_tokenized'</span>,
                    <span class="hljs-string">'Limit'</span>: <span class="hljs-number">10</span>
                }
            },
            {
                <span class="hljs-string">'Metric'</span>: <span class="hljs-string">'db.IO.Innodb_data_read.avg'</span>,
                <span class="hljs-string">'GroupBy'</span>: {
                    <span class="hljs-string">'Group'</span>: <span class="hljs-string">'db.sql_tokenized'</span>,
                    <span class="hljs-string">'Limit'</span>: <span class="hljs-number">10</span>
                }
            }
        ]

        metrics = self.get_resource_metrics(metric_queries)

        print(<span class="hljs-string">"Performance Analysis Results:"</span>)
        <span class="hljs-keyword">for</span> metric_result <span class="hljs-keyword">in</span> metrics[<span class="hljs-string">'MetricList'</span>]:
            print(<span class="hljs-string">f"\nMetric: <span class="hljs-subst">{metric_result[<span class="hljs-string">'Key'</span>][<span class="hljs-string">'Metric'</span>]}</span>"</span>)
            <span class="hljs-keyword">for</span> data_point <span class="hljs-keyword">in</span> metric_result[<span class="hljs-string">'DataPoints'</span>]:
                timestamp = data_point[<span class="hljs-string">'Timestamp'</span>]
                value = data_point[<span class="hljs-string">'Value'</span>]
                print(<span class="hljs-string">f"  <span class="hljs-subst">{timestamp}</span>: <span class="hljs-subst">{value}</span>"</span>)

<span class="hljs-comment"># Usage</span>
monitor = PerformanceInsightsMonitor(<span class="hljs-string">'myapp-mysql-instance'</span>)
monitor.analyze_performance()
</div></code></pre>
<hr>
<h2 id="%F0%9F%92%B0-cost-optimization">ğŸ’° Cost Optimization</h2>
<h3 id="right-sizing-database-instances">Right-sizing Database Instances</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseCostOptimizer</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.rds = boto3.client(<span class="hljs-string">'rds'</span>)
        self.cloudwatch = boto3.client(<span class="hljs-string">'cloudwatch'</span>)
        self.pricing = boto3.client(<span class="hljs-string">'pricing'</span>, region_name=<span class="hljs-string">'us-east-1'</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_db_instances</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Get all RDS instances"""</span>
        response = self.rds.describe_db_instances()
        <span class="hljs-keyword">return</span> response[<span class="hljs-string">'DBInstances'</span>]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_cpu_utilization</span><span class="hljs-params">(self, instance_id, days=<span class="hljs-number">30</span>)</span>:</span>
        <span class="hljs-string">"""Get average CPU utilization"""</span>
        end_time = datetime.utcnow()
        start_time = end_time - timedelta(days=days)

        response = self.cloudwatch.get_metric_statistics(
            Namespace=<span class="hljs-string">'AWS/RDS'</span>,
            MetricName=<span class="hljs-string">'CPUUtilization'</span>,
            Dimensions=[
                {
                    <span class="hljs-string">'Name'</span>: <span class="hljs-string">'DBInstanceIdentifier'</span>,
                    <span class="hljs-string">'Value'</span>: instance_id
                }
            ],
            StartTime=start_time,
            EndTime=end_time,
            Period=<span class="hljs-number">3600</span>,  <span class="hljs-comment"># 1 hour</span>
            Statistics=[<span class="hljs-string">'Average'</span>]
        )

        <span class="hljs-keyword">if</span> response[<span class="hljs-string">'Datapoints'</span>]:
            avg_cpu = sum(dp[<span class="hljs-string">'Average'</span>] <span class="hljs-keyword">for</span> dp <span class="hljs-keyword">in</span> response[<span class="hljs-string">'Datapoints'</span>]) / len(response[<span class="hljs-string">'Datapoints'</span>])
            <span class="hljs-keyword">return</span> avg_cpu
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_connection_count</span><span class="hljs-params">(self, instance_id, days=<span class="hljs-number">30</span>)</span>:</span>
        <span class="hljs-string">"""Get average connection count"""</span>
        end_time = datetime.utcnow()
        start_time = end_time - timedelta(days=days)

        response = self.cloudwatch.get_metric_statistics(
            Namespace=<span class="hljs-string">'AWS/RDS'</span>,
            MetricName=<span class="hljs-string">'DatabaseConnections'</span>,
            Dimensions=[
                {
                    <span class="hljs-string">'Name'</span>: <span class="hljs-string">'DBInstanceIdentifier'</span>,
                    <span class="hljs-string">'Value'</span>: instance_id
                }
            ],
            StartTime=start_time,
            EndTime=end_time,
            Period=<span class="hljs-number">3600</span>,
            Statistics=[<span class="hljs-string">'Average'</span>]
        )

        <span class="hljs-keyword">if</span> response[<span class="hljs-string">'Datapoints'</span>]:
            avg_connections = sum(dp[<span class="hljs-string">'Average'</span>] <span class="hljs-keyword">for</span> dp <span class="hljs-keyword">in</span> response[<span class="hljs-string">'Datapoints'</span>]) / len(response[<span class="hljs-string">'Datapoints'</span>])
            <span class="hljs-keyword">return</span> avg_connections
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">recommend_instance_size</span><span class="hljs-params">(self, instance)</span>:</span>
        <span class="hljs-string">"""Recommend optimal instance size"""</span>
        instance_id = instance[<span class="hljs-string">'DBInstanceIdentifier'</span>]
        current_class = instance[<span class="hljs-string">'DBInstanceClass'</span>]

        avg_cpu = self.get_cpu_utilization(instance_id)
        avg_connections = self.get_connection_count(instance_id)

        recommendations = []

        <span class="hljs-comment"># CPU-based recommendations</span>
        <span class="hljs-keyword">if</span> avg_cpu &lt; <span class="hljs-number">20</span>:
            recommendations.append({
                <span class="hljs-string">'type'</span>: <span class="hljs-string">'downsize'</span>,
                <span class="hljs-string">'reason'</span>: <span class="hljs-string">f'Low CPU utilization (<span class="hljs-subst">{avg_cpu:<span class="hljs-number">.1</span>f}</span>%)'</span>,
                <span class="hljs-string">'suggested_action'</span>: <span class="hljs-string">'Consider smaller instance class'</span>
            })
        <span class="hljs-keyword">elif</span> avg_cpu &gt; <span class="hljs-number">80</span>:
            recommendations.append({
                <span class="hljs-string">'type'</span>: <span class="hljs-string">'upsize'</span>,
                <span class="hljs-string">'reason'</span>: <span class="hljs-string">f'High CPU utilization (<span class="hljs-subst">{avg_cpu:<span class="hljs-number">.1</span>f}</span>%)'</span>,
                <span class="hljs-string">'suggested_action'</span>: <span class="hljs-string">'Consider larger instance class'</span>
            })

        <span class="hljs-comment"># Connection-based recommendations</span>
        <span class="hljs-keyword">if</span> avg_connections &lt; <span class="hljs-number">10</span>:
            recommendations.append({
                <span class="hljs-string">'type'</span>: <span class="hljs-string">'optimize'</span>,
                <span class="hljs-string">'reason'</span>: <span class="hljs-string">f'Low connection count (<span class="hljs-subst">{avg_connections:<span class="hljs-number">.1</span>f}</span>)'</span>,
                <span class="hljs-string">'suggested_action'</span>: <span class="hljs-string">'Consider connection pooling or smaller instance'</span>
            })

        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'instance_id'</span>: instance_id,
            <span class="hljs-string">'current_class'</span>: current_class,
            <span class="hljs-string">'avg_cpu'</span>: avg_cpu,
            <span class="hljs-string">'avg_connections'</span>: avg_connections,
            <span class="hljs-string">'recommendations'</span>: recommendations
        }

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">analyze_all_instances</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Analyze all RDS instances for cost optimization"""</span>
        instances = self.get_db_instances()
        analysis_results = []

        <span class="hljs-keyword">for</span> instance <span class="hljs-keyword">in</span> instances:
            <span class="hljs-keyword">if</span> instance[<span class="hljs-string">'DBInstanceStatus'</span>] == <span class="hljs-string">'available'</span>:
                result = self.recommend_instance_size(instance)
                analysis_results.append(result)

        <span class="hljs-keyword">return</span> analysis_results

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_cost_report</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Generate cost optimization report"""</span>
        results = self.analyze_all_instances()

        print(<span class="hljs-string">"=== RDS Cost Optimization Report ==="</span>)
        print(<span class="hljs-string">f"Analysis Date: <span class="hljs-subst">{datetime.now().strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>)}</span>"</span>)
        print(<span class="hljs-string">f"Total Instances Analyzed: <span class="hljs-subst">{len(results)}</span>"</span>)
        print()

        total_recommendations = <span class="hljs-number">0</span>

        <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> results:
            print(<span class="hljs-string">f"Instance: <span class="hljs-subst">{result[<span class="hljs-string">'instance_id'</span>]}</span>"</span>)
            print(<span class="hljs-string">f"  Current Class: <span class="hljs-subst">{result[<span class="hljs-string">'current_class'</span>]}</span>"</span>)
            print(<span class="hljs-string">f"  Avg CPU: <span class="hljs-subst">{result[<span class="hljs-string">'avg_cpu'</span>]:<span class="hljs-number">.1</span>f}</span>%"</span>)
            print(<span class="hljs-string">f"  Avg Connections: <span class="hljs-subst">{result[<span class="hljs-string">'avg_connections'</span>]:<span class="hljs-number">.1</span>f}</span>"</span>)

            <span class="hljs-keyword">if</span> result[<span class="hljs-string">'recommendations'</span>]:
                print(<span class="hljs-string">"  Recommendations:"</span>)
                <span class="hljs-keyword">for</span> rec <span class="hljs-keyword">in</span> result[<span class="hljs-string">'recommendations'</span>]:
                    print(<span class="hljs-string">f"    - <span class="hljs-subst">{rec[<span class="hljs-string">'type'</span>].upper()}</span>: <span class="hljs-subst">{rec[<span class="hljs-string">'reason'</span>]}</span>"</span>)
                    print(<span class="hljs-string">f"      Action: <span class="hljs-subst">{rec[<span class="hljs-string">'suggested_action'</span>]}</span>"</span>)
                total_recommendations += len(result[<span class="hljs-string">'recommendations'</span>])
            <span class="hljs-keyword">else</span>:
                print(<span class="hljs-string">"  No recommendations - instance appears optimally sized"</span>)
            print()

        print(<span class="hljs-string">f"Total Optimization Opportunities: <span class="hljs-subst">{total_recommendations}</span>"</span>)

<span class="hljs-comment"># Usage</span>
optimizer = DatabaseCostOptimizer()
optimizer.generate_cost_report()
</div></code></pre>
<h3 id="reserved-instances-and-savings-plans">Reserved Instances and Savings Plans</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># AWS RDS Reserved Instance management</span>
<span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RDSReservedInstanceManager</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.rds = boto3.client(<span class="hljs-string">'rds'</span>)
        self.ce = boto3.client(<span class="hljs-string">'ce'</span>)  <span class="hljs-comment"># Cost Explorer</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_current_usage</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Get current RDS usage patterns"""</span>
        instances = self.rds.describe_db_instances()

        usage_summary = {}

        <span class="hljs-keyword">for</span> instance <span class="hljs-keyword">in</span> instances[<span class="hljs-string">'DBInstances'</span>]:
            <span class="hljs-keyword">if</span> instance[<span class="hljs-string">'DBInstanceStatus'</span>] == <span class="hljs-string">'available'</span>:
                instance_class = instance[<span class="hljs-string">'DBInstanceClass'</span>]
                engine = instance[<span class="hljs-string">'Engine'</span>]
                multi_az = instance[<span class="hljs-string">'MultiAZ'</span>]

                key = <span class="hljs-string">f"<span class="hljs-subst">{engine}</span>_<span class="hljs-subst">{instance_class}</span>_<span class="hljs-subst">{multi_az}</span>"</span>

                <span class="hljs-keyword">if</span> key <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> usage_summary:
                    usage_summary[key] = {
                        <span class="hljs-string">'engine'</span>: engine,
                        <span class="hljs-string">'instance_class'</span>: instance_class,
                        <span class="hljs-string">'multi_az'</span>: multi_az,
                        <span class="hljs-string">'count'</span>: <span class="hljs-number">0</span>,
                        <span class="hljs-string">'instances'</span>: []
                    }

                usage_summary[key][<span class="hljs-string">'count'</span>] += <span class="hljs-number">1</span>
                usage_summary[key][<span class="hljs-string">'instances'</span>].append(instance[<span class="hljs-string">'DBInstanceIdentifier'</span>])

        <span class="hljs-keyword">return</span> usage_summary

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_reserved_instances</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Get current reserved instances"""</span>
        response = self.rds.describe_reserved_db_instances()
        <span class="hljs-keyword">return</span> response[<span class="hljs-string">'ReservedDBInstances'</span>]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_available_offerings</span><span class="hljs-params">(self, engine, instance_class)</span>:</span>
        <span class="hljs-string">"""Get available reserved instance offerings"""</span>
        response = self.rds.describe_reserved_db_instances_offerings(
            DBInstanceClass=instance_class,
            ProductDescription=engine,
            MultiAZ=<span class="hljs-literal">True</span>
        )
        <span class="hljs-keyword">return</span> response[<span class="hljs-string">'ReservedDBInstancesOfferings'</span>]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">calculate_savings</span><span class="hljs-params">(self, usage_summary)</span>:</span>
        <span class="hljs-string">"""Calculate potential savings with reserved instances"""</span>
        savings_analysis = []

        <span class="hljs-keyword">for</span> usage_key, usage_data <span class="hljs-keyword">in</span> usage_summary.items():
            <span class="hljs-keyword">if</span> usage_data[<span class="hljs-string">'count'</span>] &gt; <span class="hljs-number">0</span>:
                offerings = self.get_available_offerings(
                    usage_data[<span class="hljs-string">'engine'</span>],
                    usage_data[<span class="hljs-string">'instance_class'</span>]
                )

                <span class="hljs-keyword">for</span> offering <span class="hljs-keyword">in</span> offerings:
                    <span class="hljs-keyword">if</span> offering[<span class="hljs-string">'Duration'</span>] == <span class="hljs-number">31536000</span>:  <span class="hljs-comment"># 1 year</span>
                        upfront_cost = offering.get(<span class="hljs-string">'FixedPrice'</span>, <span class="hljs-number">0</span>)
                        hourly_cost = offering.get(<span class="hljs-string">'UsagePrice'</span>, <span class="hljs-number">0</span>)

                        <span class="hljs-comment"># Calculate annual costs</span>
                        annual_reserved_cost = upfront_cost + (hourly_cost * <span class="hljs-number">8760</span>)  <span class="hljs-comment"># 8760 hours/year</span>
                        annual_on_demand_cost = self.get_on_demand_cost(
                            usage_data[<span class="hljs-string">'engine'</span>],
                            usage_data[<span class="hljs-string">'instance_class'</span>]
                        ) * <span class="hljs-number">8760</span>

                        annual_savings = (annual_on_demand_cost - annual_reserved_cost) * usage_data[<span class="hljs-string">'count'</span>]
                        savings_percentage = (annual_savings / (annual_on_demand_cost * usage_data[<span class="hljs-string">'count'</span>])) * <span class="hljs-number">100</span>

                        savings_analysis.append({
                            <span class="hljs-string">'usage_key'</span>: usage_key,
                            <span class="hljs-string">'engine'</span>: usage_data[<span class="hljs-string">'engine'</span>],
                            <span class="hljs-string">'instance_class'</span>: usage_data[<span class="hljs-string">'instance_class'</span>],
                            <span class="hljs-string">'instance_count'</span>: usage_data[<span class="hljs-string">'count'</span>],
                            <span class="hljs-string">'offering_id'</span>: offering[<span class="hljs-string">'ReservedDBInstancesOfferingId'</span>],
                            <span class="hljs-string">'duration'</span>: offering[<span class="hljs-string">'Duration'</span>],
                            <span class="hljs-string">'payment_option'</span>: offering[<span class="hljs-string">'PaymentOption'</span>],
                            <span class="hljs-string">'upfront_cost'</span>: upfront_cost,
                            <span class="hljs-string">'hourly_cost'</span>: hourly_cost,
                            <span class="hljs-string">'annual_savings'</span>: annual_savings,
                            <span class="hljs-string">'savings_percentage'</span>: savings_percentage
                        })

        <span class="hljs-keyword">return</span> sorted(savings_analysis, key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-string">'annual_savings'</span>], reverse=<span class="hljs-literal">True</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_on_demand_cost</span><span class="hljs-params">(self, engine, instance_class)</span>:</span>
        <span class="hljs-string">"""Get on-demand hourly cost (simplified - would need pricing API)"""</span>
        <span class="hljs-comment"># This is a simplified example - in practice, you'd use the AWS Pricing API</span>
        pricing_map = {
            <span class="hljs-string">'mysql'</span>: {
                <span class="hljs-string">'db.t3.micro'</span>: <span class="hljs-number">0.017</span>,
                <span class="hljs-string">'db.t3.small'</span>: <span class="hljs-number">0.034</span>,
                <span class="hljs-string">'db.t3.medium'</span>: <span class="hljs-number">0.068</span>,
                <span class="hljs-string">'db.r5.large'</span>: <span class="hljs-number">0.24</span>,
                <span class="hljs-string">'db.r5.xlarge'</span>: <span class="hljs-number">0.48</span>
            },
            <span class="hljs-string">'postgres'</span>: {
                <span class="hljs-string">'db.t3.micro'</span>: <span class="hljs-number">0.018</span>,
                <span class="hljs-string">'db.t3.small'</span>: <span class="hljs-number">0.036</span>,
                <span class="hljs-string">'db.t3.medium'</span>: <span class="hljs-number">0.072</span>,
                <span class="hljs-string">'db.r5.large'</span>: <span class="hljs-number">0.252</span>,
                <span class="hljs-string">'db.r5.xlarge'</span>: <span class="hljs-number">0.504</span>
            }
        }

        <span class="hljs-keyword">return</span> pricing_map.get(engine, {}).get(instance_class, <span class="hljs-number">0</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">purchase_reserved_instance</span><span class="hljs-params">(self, offering_id, instance_count)</span>:</span>
        <span class="hljs-string">"""Purchase reserved instance"""</span>
        <span class="hljs-keyword">try</span>:
            response = self.rds.purchase_reserved_db_instances_offering(
                ReservedDBInstancesOfferingId=offering_id,
                DBInstanceCount=instance_count,
                Tags=[
                    {
                        <span class="hljs-string">'Key'</span>: <span class="hljs-string">'PurchaseDate'</span>,
                        <span class="hljs-string">'Value'</span>: datetime.now().strftime(<span class="hljs-string">'%Y-%m-%d'</span>)
                    },
                    {
                        <span class="hljs-string">'Key'</span>: <span class="hljs-string">'Environment'</span>,
                        <span class="hljs-string">'Value'</span>: <span class="hljs-string">'Production'</span>
                    }
                ]
            )
            <span class="hljs-keyword">return</span> response
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            print(<span class="hljs-string">f"Error purchasing reserved instance: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_ri_recommendation_report</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Generate reserved instance recommendation report"""</span>
        usage_summary = self.get_current_usage()
        current_ris = self.get_reserved_instances()
        savings_analysis = self.calculate_savings(usage_summary)

        print(<span class="hljs-string">"=== RDS Reserved Instance Recommendation Report ==="</span>)
        print(<span class="hljs-string">f"Report Date: <span class="hljs-subst">{datetime.now().strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>)}</span>"</span>)
        print()

        print(<span class="hljs-string">"Current Usage Summary:"</span>)
        <span class="hljs-keyword">for</span> usage_key, usage_data <span class="hljs-keyword">in</span> usage_summary.items():
            print(<span class="hljs-string">f"  <span class="hljs-subst">{usage_data[<span class="hljs-string">'engine'</span>]}</span> <span class="hljs-subst">{usage_data[<span class="hljs-string">'instance_class'</span>]}</span> (Multi-AZ: <span class="hljs-subst">{usage_data[<span class="hljs-string">'multi_az'</span>]}</span>): <span class="hljs-subst">{usage_data[<span class="hljs-string">'count'</span>]}</span> instances"</span>)
        print()

        print(<span class="hljs-string">"Current Reserved Instances:"</span>)
        <span class="hljs-keyword">if</span> current_ris:
            <span class="hljs-keyword">for</span> ri <span class="hljs-keyword">in</span> current_ris:
                print(<span class="hljs-string">f"  <span class="hljs-subst">{ri[<span class="hljs-string">'ProductDescription'</span>]}</span> <span class="hljs-subst">{ri[<span class="hljs-string">'DBInstanceClass'</span>]}</span>: <span class="hljs-subst">{ri[<span class="hljs-string">'DBInstanceCount'</span>]}</span> instances"</span>)
                print(<span class="hljs-string">f"    State: <span class="hljs-subst">{ri[<span class="hljs-string">'State'</span>]}</span>, Remaining: <span class="hljs-subst">{ri[<span class="hljs-string">'Duration'</span>]}</span> seconds"</span>)
        <span class="hljs-keyword">else</span>:
            print(<span class="hljs-string">"  No reserved instances found"</span>)
        print()

        print(<span class="hljs-string">"Savings Opportunities:"</span>)
        total_potential_savings = <span class="hljs-number">0</span>

        <span class="hljs-keyword">for</span> analysis <span class="hljs-keyword">in</span> savings_analysis[:<span class="hljs-number">5</span>]:  <span class="hljs-comment"># Top 5 opportunities</span>
            print(<span class="hljs-string">f"  <span class="hljs-subst">{analysis[<span class="hljs-string">'engine'</span>]}</span> <span class="hljs-subst">{analysis[<span class="hljs-string">'instance_class'</span>]}</span>:"</span>)
            print(<span class="hljs-string">f"    Instance Count: <span class="hljs-subst">{analysis[<span class="hljs-string">'instance_count'</span>]}</span>"</span>)
            print(<span class="hljs-string">f"    Payment Option: <span class="hljs-subst">{analysis[<span class="hljs-string">'payment_option'</span>]}</span>"</span>)
            print(<span class="hljs-string">f"    Annual Savings: $<span class="hljs-subst">{analysis[<span class="hljs-string">'annual_savings'</span>]:,<span class="hljs-number">.2</span>f}</span> (<span class="hljs-subst">{analysis[<span class="hljs-string">'savings_percentage'</span>]:<span class="hljs-number">.1</span>f}</span>%)"</span>)
            print(<span class="hljs-string">f"    Upfront Cost: $<span class="hljs-subst">{analysis[<span class="hljs-string">'upfront_cost'</span>]:,<span class="hljs-number">.2</span>f}</span>"</span>)
            print(<span class="hljs-string">f"    Hourly Cost: $<span class="hljs-subst">{analysis[<span class="hljs-string">'hourly_cost'</span>]:<span class="hljs-number">.4</span>f}</span>"</span>)
            print()

            total_potential_savings += analysis[<span class="hljs-string">'annual_savings'</span>]

        print(<span class="hljs-string">f"Total Potential Annual Savings: $<span class="hljs-subst">{total_potential_savings:,<span class="hljs-number">.2</span>f}</span>"</span>)

<span class="hljs-comment"># Usage</span>
ri_manager = RDSReservedInstanceManager()
ri_manager.generate_ri_recommendation_report()
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-next-steps">ğŸ¯ Next Steps</h2>
<p>Congratulations! You've completed Chapter 22 on Cloud Databases &amp; Database as a Service (DBaaS). You should now understand:</p>
<p>âœ… Cloud database concepts and service models (IaaS, PaaS, SaaS, DBaaS)
âœ… Major cloud providers (AWS, Azure, GCP) and their database offerings
âœ… Database migration strategies and tools (DMS, SCT)
âœ… Serverless database concepts and implementation
âœ… Cloud database security and compliance
âœ… Cost optimization strategies and reserved instances
âœ… Multi-cloud and hybrid database architectures
âœ… Monitoring and performance optimization in the cloud</p>
<p><strong>Continue to:</strong> <a href="23-database-devops-cicd.md">Chapter 23: Database DevOps &amp; CI/CD</a></p>
<p><strong>Practice Projects:</strong></p>
<ol>
<li>Migrate an on-premises database to the cloud</li>
<li>Implement a serverless application with Aurora Serverless</li>
<li>Set up multi-region database replication</li>
<li>Create a cost optimization dashboard for cloud databases</li>
<li>Implement database monitoring and alerting</li>
</ol>
<p><strong>Additional Resources:</strong></p>
<ul>
<li>AWS Database Migration Service documentation</li>
<li>Azure Database Migration Guide</li>
<li>Google Cloud Database Migration documentation</li>
<li>Cloud database security best practices</li>
<li>Serverless database design patterns</li>
</ul>
<h1 id="chapter-23-database-devops--cicd">Chapter 23: Database DevOps &amp; CI/CD</h1>
<h2 id="%F0%9F%93%9A-learning-objectives">ğŸ“š Learning Objectives</h2>
<p>By the end of this chapter, you will:</p>
<ul>
<li>Understand Database DevOps principles and practices</li>
<li>Learn database version control and schema migration strategies</li>
<li>Implement CI/CD pipelines for database changes</li>
<li>Master database testing strategies (unit, integration, performance)</li>
<li>Understand Infrastructure as Code (IaC) for databases</li>
<li>Learn database monitoring and observability in DevOps</li>
<li>Implement automated database deployment strategies</li>
<li>Understand database rollback and disaster recovery in CI/CD</li>
</ul>
<hr>
<h2 id="%F0%9F%94%84-introduction-to-database-devops">ğŸ”„ Introduction to Database DevOps</h2>
<h3 id="what-is-database-devops">What is Database DevOps?</h3>
<p>Database DevOps extends traditional DevOps practices to database development and operations:</p>
<ul>
<li><strong>Version Control</strong>: Track database schema and data changes</li>
<li><strong>Automated Testing</strong>: Ensure database changes don't break functionality</li>
<li><strong>Continuous Integration</strong>: Automatically validate database changes</li>
<li><strong>Continuous Deployment</strong>: Safely deploy database changes to production</li>
<li><strong>Monitoring</strong>: Track database performance and health</li>
<li><strong>Collaboration</strong>: Bridge the gap between developers and DBAs</li>
</ul>
<h3 id="key-principles">Key Principles</h3>
<ol>
<li><strong>Everything as Code</strong>: Database schemas, configurations, and deployments</li>
<li><strong>Automation</strong>: Reduce manual processes and human error</li>
<li><strong>Collaboration</strong>: Shared responsibility between teams</li>
<li><strong>Continuous Feedback</strong>: Monitor and improve continuously</li>
<li><strong>Fail Fast</strong>: Detect issues early in the development cycle</li>
</ol>
<hr>
<h2 id="%F0%9F%93%9D-database-version-control">ğŸ“ Database Version Control</h2>
<h3 id="schema-migration-tools">Schema Migration Tools</h3>
<h4 id="flyway-java-based">Flyway (Java-based)</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- V1__Create_users_table.sql</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">BIGINT</span> AUTO_INCREMENT PRIMARY <span class="hljs-keyword">KEY</span>,
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">name</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    updated_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_users_email <span class="hljs-keyword">ON</span> <span class="hljs-keyword">users</span>(email);
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">-- V2__Add_user_preferences.sql</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> preferences <span class="hljs-keyword">JSON</span>;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_sessions (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">BIGINT</span> AUTO_INCREMENT PRIMARY <span class="hljs-keyword">KEY</span>,
    user_id <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    session_token <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    expires_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    created_at <span class="hljs-built_in">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (user_id) <span class="hljs-keyword">REFERENCES</span> <span class="hljs-keyword">users</span>(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">CASCADE</span>
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_user_sessions_token <span class="hljs-keyword">ON</span> user_sessions(session_token);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_user_sessions_user_id <span class="hljs-keyword">ON</span> user_sessions(user_id);
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment"># flyway.conf</span>
<span class="hljs-meta">flyway.url</span>=<span class="hljs-string">jdbc:mysql://localhost:3306/myapp_dev</span>
<span class="hljs-meta">flyway.user</span>=<span class="hljs-string">flyway_user</span>
<span class="hljs-meta">flyway.password</span>=<span class="hljs-string">flyway_password</span>
<span class="hljs-meta">flyway.locations</span>=<span class="hljs-string">filesystem:./migrations</span>
<span class="hljs-meta">flyway.baselineOnMigrate</span>=<span class="hljs-string">true</span>
<span class="hljs-meta">flyway.validateOnMigrate</span>=<span class="hljs-string">true</span>
<span class="hljs-meta">flyway.cleanDisabled</span>=<span class="hljs-string">true</span>
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># flyway-migrate.sh</span>

<span class="hljs-built_in">set</span> -e

ENVIRONMENT=<span class="hljs-variable">${1:-dev}</span>
CONFIG_FILE=<span class="hljs-string">"flyway-<span class="hljs-variable">${ENVIRONMENT}</span>.conf"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"Running Flyway migration for environment: <span class="hljs-variable">$ENVIRONMENT</span>"</span>

<span class="hljs-comment"># Validate configuration</span>
<span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Error: Configuration file <span class="hljs-variable">$CONFIG_FILE</span> not found"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># Run migration</span>
flyway -configFiles=<span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>"</span> info
flyway -configFiles=<span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>"</span> migrate

<span class="hljs-built_in">echo</span> <span class="hljs-string">"Migration completed successfully"</span>
</div></code></pre>
<h4 id="liquibase-xmlyamljsonsql">Liquibase (XML/YAML/JSON/SQL)</h4>
<pre class="hljs"><code><div><span class="hljs-comment">&lt;!-- db.changelog-master.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">databaseChangeLog</span>
    <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.liquibase.org/xml/ns/dbchangelog"</span>
    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.0.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">file</span>=<span class="hljs-string">"db/changelog/001-create-users-table.xml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">file</span>=<span class="hljs-string">"db/changelog/002-add-user-preferences.xml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">file</span>=<span class="hljs-string">"db/changelog/003-create-orders-table.xml"</span>/&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">databaseChangeLog</span>&gt;</span>
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">&lt;!-- db/changelog/001-create-users-table.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">databaseChangeLog</span>
    <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.liquibase.org/xml/ns/dbchangelog"</span>
    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.0.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">changeSet</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"001-create-users-table"</span> <span class="hljs-attr">author</span>=<span class="hljs-string">"developer"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">createTable</span> <span class="hljs-attr">tableName</span>=<span class="hljs-string">"users"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"BIGINT"</span> <span class="hljs-attr">autoIncrement</span>=<span class="hljs-string">"true"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">constraints</span> <span class="hljs-attr">primaryKey</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">nullable</span>=<span class="hljs-string">"false"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">column</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"VARCHAR(255)"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">constraints</span> <span class="hljs-attr">nullable</span>=<span class="hljs-string">"false"</span> <span class="hljs-attr">unique</span>=<span class="hljs-string">"true"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">column</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"VARCHAR(100)"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">constraints</span> <span class="hljs-attr">nullable</span>=<span class="hljs-string">"false"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">column</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"created_at"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"TIMESTAMP"</span> <span class="hljs-attr">defaultValueComputed</span>=<span class="hljs-string">"CURRENT_TIMESTAMP"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">constraints</span> <span class="hljs-attr">nullable</span>=<span class="hljs-string">"false"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">column</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"updated_at"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"TIMESTAMP"</span> <span class="hljs-attr">defaultValueComputed</span>=<span class="hljs-string">"CURRENT_TIMESTAMP"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">constraints</span> <span class="hljs-attr">nullable</span>=<span class="hljs-string">"false"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">column</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">createTable</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">createIndex</span> <span class="hljs-attr">tableName</span>=<span class="hljs-string">"users"</span> <span class="hljs-attr">indexName</span>=<span class="hljs-string">"idx_users_email"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"email"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">createIndex</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">rollback</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dropTable</span> <span class="hljs-attr">tableName</span>=<span class="hljs-string">"users"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">rollback</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">changeSet</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">databaseChangeLog</span>&gt;</span>
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment"># liquibase.yml</span>
<span class="hljs-attr">databaseChangeLog:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">changeSet:</span>
      <span class="hljs-attr">id:</span> <span class="hljs-number">002</span><span class="hljs-string">-add-user-preferences</span>
      <span class="hljs-attr">author:</span> <span class="hljs-string">developer</span>
      <span class="hljs-attr">changes:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">addColumn:</span>
            <span class="hljs-attr">tableName:</span> <span class="hljs-string">users</span>
            <span class="hljs-attr">columns:</span>
              <span class="hljs-bullet">-</span> <span class="hljs-attr">column:</span>
                  <span class="hljs-attr">name:</span> <span class="hljs-string">preferences</span>
                  <span class="hljs-attr">type:</span> <span class="hljs-string">JSON</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">createTable:</span>
            <span class="hljs-attr">tableName:</span> <span class="hljs-string">user_sessions</span>
            <span class="hljs-attr">columns:</span>
              <span class="hljs-bullet">-</span> <span class="hljs-attr">column:</span>
                  <span class="hljs-attr">name:</span> <span class="hljs-string">id</span>
                  <span class="hljs-attr">type:</span> <span class="hljs-string">BIGINT</span>
                  <span class="hljs-attr">autoIncrement:</span> <span class="hljs-literal">true</span>
                  <span class="hljs-attr">constraints:</span>
                    <span class="hljs-attr">primaryKey:</span> <span class="hljs-literal">true</span>
                    <span class="hljs-attr">nullable:</span> <span class="hljs-literal">false</span>
              <span class="hljs-bullet">-</span> <span class="hljs-attr">column:</span>
                  <span class="hljs-attr">name:</span> <span class="hljs-string">user_id</span>
                  <span class="hljs-attr">type:</span> <span class="hljs-string">BIGINT</span>
                  <span class="hljs-attr">constraints:</span>
                    <span class="hljs-attr">nullable:</span> <span class="hljs-literal">false</span>
              <span class="hljs-bullet">-</span> <span class="hljs-attr">column:</span>
                  <span class="hljs-attr">name:</span> <span class="hljs-string">session_token</span>
                  <span class="hljs-attr">type:</span> <span class="hljs-string">VARCHAR(255)</span>
                  <span class="hljs-attr">constraints:</span>
                    <span class="hljs-attr">nullable:</span> <span class="hljs-literal">false</span>
                    <span class="hljs-attr">unique:</span> <span class="hljs-literal">true</span>
              <span class="hljs-bullet">-</span> <span class="hljs-attr">column:</span>
                  <span class="hljs-attr">name:</span> <span class="hljs-string">expires_at</span>
                  <span class="hljs-attr">type:</span> <span class="hljs-string">TIMESTAMP</span>
                  <span class="hljs-attr">constraints:</span>
                    <span class="hljs-attr">nullable:</span> <span class="hljs-literal">false</span>
              <span class="hljs-bullet">-</span> <span class="hljs-attr">column:</span>
                  <span class="hljs-attr">name:</span> <span class="hljs-string">created_at</span>
                  <span class="hljs-attr">type:</span> <span class="hljs-string">TIMESTAMP</span>
                  <span class="hljs-attr">defaultValueComputed:</span> <span class="hljs-string">CURRENT_TIMESTAMP</span>
                  <span class="hljs-attr">constraints:</span>
                    <span class="hljs-attr">nullable:</span> <span class="hljs-literal">false</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">addForeignKeyConstraint:</span>
            <span class="hljs-attr">baseTableName:</span> <span class="hljs-string">user_sessions</span>
            <span class="hljs-attr">baseColumnNames:</span> <span class="hljs-string">user_id</span>
            <span class="hljs-attr">referencedTableName:</span> <span class="hljs-string">users</span>
            <span class="hljs-attr">referencedColumnNames:</span> <span class="hljs-string">id</span>
            <span class="hljs-attr">constraintName:</span> <span class="hljs-string">fk_user_sessions_user_id</span>
            <span class="hljs-attr">onDelete:</span> <span class="hljs-string">CASCADE</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">createIndex:</span>
            <span class="hljs-attr">tableName:</span> <span class="hljs-string">user_sessions</span>
            <span class="hljs-attr">indexName:</span> <span class="hljs-string">idx_user_sessions_token</span>
            <span class="hljs-attr">columns:</span>
              <span class="hljs-bullet">-</span> <span class="hljs-attr">column:</span>
                  <span class="hljs-attr">name:</span> <span class="hljs-string">session_token</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">createIndex:</span>
            <span class="hljs-attr">tableName:</span> <span class="hljs-string">user_sessions</span>
            <span class="hljs-attr">indexName:</span> <span class="hljs-string">idx_user_sessions_user_id</span>
            <span class="hljs-attr">columns:</span>
              <span class="hljs-bullet">-</span> <span class="hljs-attr">column:</span>
                  <span class="hljs-attr">name:</span> <span class="hljs-string">user_id</span>
      <span class="hljs-attr">rollback:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">dropTable:</span>
            <span class="hljs-attr">tableName:</span> <span class="hljs-string">user_sessions</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">dropColumn:</span>
            <span class="hljs-attr">tableName:</span> <span class="hljs-string">users</span>
            <span class="hljs-attr">columnName:</span> <span class="hljs-string">preferences</span>
</div></code></pre>
<h3 id="git-based-database-workflows">Git-based Database Workflows</h3>
<pre class="hljs"><code><div><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># git-db-workflow.sh</span>

<span class="hljs-built_in">set</span> -e

<span class="hljs-comment"># Database development workflow</span>
<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">db_feature_start</span></span>() {
    <span class="hljs-built_in">local</span> feature_name=<span class="hljs-variable">$1</span>

    <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$feature_name</span>"</span> ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Usage: db_feature_start &lt;feature_name&gt;"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>

    <span class="hljs-comment"># Create feature branch</span>
    git checkout -b <span class="hljs-string">"feature/db-<span class="hljs-variable">$feature_name</span>"</span>

    <span class="hljs-comment"># Create migration directory</span>
    mkdir -p <span class="hljs-string">"migrations/<span class="hljs-variable">$(date +%Y%m%d)</span>_<span class="hljs-variable">$feature_name</span>"</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Database feature branch created: feature/db-<span class="hljs-variable">$feature_name</span>"</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">db_feature_test</span></span>() {
    <span class="hljs-comment"># Run database tests</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Running database tests..."</span>

    <span class="hljs-comment"># Create test database</span>
    mysql -u root -p -e <span class="hljs-string">"DROP DATABASE IF EXISTS myapp_test; CREATE DATABASE myapp_test;"</span>

    <span class="hljs-comment"># Run migrations on test database</span>
    flyway -configFiles=flyway-test.conf migrate

    <span class="hljs-comment"># Run database unit tests</span>
    npm run <span class="hljs-built_in">test</span>:db

    <span class="hljs-comment"># Run integration tests</span>
    npm run <span class="hljs-built_in">test</span>:integration

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Database tests completed successfully"</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">db_feature_finish</span></span>() {
    <span class="hljs-built_in">local</span> feature_name=<span class="hljs-variable">$1</span>

    <span class="hljs-comment"># Run tests</span>
    db_feature_test

    <span class="hljs-comment"># Merge to develop</span>
    git checkout develop
    git merge <span class="hljs-string">"feature/db-<span class="hljs-variable">$feature_name</span>"</span>

    <span class="hljs-comment"># Clean up</span>
    git branch -d <span class="hljs-string">"feature/db-<span class="hljs-variable">$feature_name</span>"</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Database feature merged and cleaned up"</span>
}

<span class="hljs-comment"># Parse command line arguments</span>
<span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> <span class="hljs-keyword">in</span>
    <span class="hljs-string">"start"</span>)
        db_feature_start <span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
        ;;
    <span class="hljs-string">"test"</span>)
        db_feature_test
        ;;
    <span class="hljs-string">"finish"</span>)
        db_feature_finish <span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
        ;;
    *)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Usage: <span class="hljs-variable">$0</span> {start|test|finish} [feature_name]"</span>
        <span class="hljs-built_in">exit</span> 1
        ;;
<span class="hljs-keyword">esac</span>
</div></code></pre>
<hr>
<h2 id="%F0%9F%A7%AA-database-testing-strategies">ğŸ§ª Database Testing Strategies</h2>
<h3 id="unit-testing-for-database-objects">Unit Testing for Database Objects</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- tests/test_user_functions.sql</span>
<span class="hljs-comment">-- Unit tests for user-related stored procedures and functions</span>

DELIMITER //

<span class="hljs-comment">-- Test setup procedure</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> test_setup()
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- Clean test data</span>
    <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> user_sessions <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> email <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%test%'</span>);
    <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> email <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%test%'</span>;

    <span class="hljs-comment">-- Insert test data</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">users</span> (email, <span class="hljs-keyword">name</span>) <span class="hljs-keyword">VALUES</span>
        (<span class="hljs-string">'test1@example.com'</span>, <span class="hljs-string">'Test User 1'</span>),
        (<span class="hljs-string">'test2@example.com'</span>, <span class="hljs-string">'Test User 2'</span>);
<span class="hljs-keyword">END</span>//

<span class="hljs-comment">-- Test teardown procedure</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> test_teardown()
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> user_sessions <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> email <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%test%'</span>);
    <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> email <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%test%'</span>;
<span class="hljs-keyword">END</span>//

<span class="hljs-comment">-- Test create_user_session function</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> test_create_user_session()
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> user_id <span class="hljs-built_in">BIGINT</span>;
    <span class="hljs-keyword">DECLARE</span> session_token <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>);
    <span class="hljs-keyword">DECLARE</span> session_count <span class="hljs-built_in">INT</span>;

    <span class="hljs-comment">-- Setup</span>
    <span class="hljs-keyword">CALL</span> test_setup();

    <span class="hljs-comment">-- Get test user ID</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">INTO</span> user_id <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> email = <span class="hljs-string">'test1@example.com'</span>;

    <span class="hljs-comment">-- Test: Create user session</span>
    <span class="hljs-keyword">CALL</span> create_user_session(user_id, session_token);

    <span class="hljs-comment">-- Verify: Session was created</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> session_count
    <span class="hljs-keyword">FROM</span> user_sessions
    <span class="hljs-keyword">WHERE</span> user_id = user_id <span class="hljs-keyword">AND</span> session_token = session_token;

    IF session_count != 1 THEN
        SIGNAL SQLSTATE '45000' <span class="hljs-keyword">SET</span> MESSAGE_TEXT = <span class="hljs-string">'Test failed: Session not created'</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-comment">-- Verify: Session token is not null</span>
    IF session_token IS NULL OR LENGTH(session_token) = 0 THEN
        SIGNAL SQLSTATE '45000' <span class="hljs-keyword">SET</span> MESSAGE_TEXT = <span class="hljs-string">'Test failed: Invalid session token'</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-comment">-- Cleanup</span>
    <span class="hljs-keyword">CALL</span> test_teardown();

    <span class="hljs-keyword">SELECT</span> <span class="hljs-string">'test_create_user_session PASSED'</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span>;
<span class="hljs-keyword">END</span>//

<span class="hljs-comment">-- Test validate_user_session function</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> test_validate_user_session()
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> user_id <span class="hljs-built_in">BIGINT</span>;
    <span class="hljs-keyword">DECLARE</span> session_token <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>);
    <span class="hljs-keyword">DECLARE</span> is_valid <span class="hljs-built_in">BOOLEAN</span>;

    <span class="hljs-comment">-- Setup</span>
    <span class="hljs-keyword">CALL</span> test_setup();

    <span class="hljs-comment">-- Get test user ID</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">INTO</span> user_id <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> email = <span class="hljs-string">'test1@example.com'</span>;

    <span class="hljs-comment">-- Create a session</span>
    <span class="hljs-keyword">CALL</span> create_user_session(user_id, session_token);

    <span class="hljs-comment">-- Test: Validate valid session</span>
    <span class="hljs-keyword">SELECT</span> validate_user_session(session_token) <span class="hljs-keyword">INTO</span> is_valid;

    IF NOT is_valid THEN
        SIGNAL SQLSTATE '45000' <span class="hljs-keyword">SET</span> MESSAGE_TEXT = <span class="hljs-string">'Test failed: Valid session not recognized'</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-comment">-- Test: Validate invalid session</span>
    <span class="hljs-keyword">SELECT</span> validate_user_session(<span class="hljs-string">'invalid_token'</span>) <span class="hljs-keyword">INTO</span> is_valid;

    IF is_valid THEN
        SIGNAL SQLSTATE '45000' <span class="hljs-keyword">SET</span> MESSAGE_TEXT = <span class="hljs-string">'Test failed: Invalid session recognized as valid'</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;

    <span class="hljs-comment">-- Cleanup</span>
    <span class="hljs-keyword">CALL</span> test_teardown();

    <span class="hljs-keyword">SELECT</span> <span class="hljs-string">'test_validate_user_session PASSED'</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span>;
<span class="hljs-keyword">END</span>//

DELIMITER ;

<span class="hljs-comment">-- Run all tests</span>
<span class="hljs-keyword">CALL</span> test_create_user_session();
<span class="hljs-keyword">CALL</span> test_validate_user_session();
</div></code></pre>
<h3 id="integration-testing-with-python">Integration Testing with Python</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># tests/test_database_integration.py</span>
<span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">import</span> mysql.connector
<span class="hljs-keyword">from</span> mysql.connector <span class="hljs-keyword">import</span> Error
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta
<span class="hljs-keyword">import</span> json

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseIntegrationTest</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.connection = <span class="hljs-literal">None</span>
        self.cursor = <span class="hljs-literal">None</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setup_method</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Setup test database connection"""</span>
        <span class="hljs-keyword">try</span>:
            self.connection = mysql.connector.connect(
                host=os.getenv(<span class="hljs-string">'DB_TEST_HOST'</span>, <span class="hljs-string">'localhost'</span>),
                database=os.getenv(<span class="hljs-string">'DB_TEST_NAME'</span>, <span class="hljs-string">'myapp_test'</span>),
                user=os.getenv(<span class="hljs-string">'DB_TEST_USER'</span>, <span class="hljs-string">'test_user'</span>),
                password=os.getenv(<span class="hljs-string">'DB_TEST_PASSWORD'</span>, <span class="hljs-string">'test_password'</span>)
            )
            self.cursor = self.connection.cursor(dictionary=<span class="hljs-literal">True</span>)

            <span class="hljs-comment"># Clean test data</span>
            self.cleanup_test_data()

        <span class="hljs-keyword">except</span> Error <span class="hljs-keyword">as</span> e:
            pytest.fail(<span class="hljs-string">f"Failed to connect to test database: <span class="hljs-subst">{e}</span>"</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">teardown_method</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Cleanup after test"""</span>
        <span class="hljs-keyword">if</span> self.connection <span class="hljs-keyword">and</span> self.connection.is_connected():
            self.cleanup_test_data()
            self.cursor.close()
            self.connection.close()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cleanup_test_data</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Remove test data"""</span>
        cleanup_queries = [
            <span class="hljs-string">"DELETE FROM user_sessions WHERE user_id IN (SELECT id FROM users WHERE email LIKE '%test%')"</span>,
            <span class="hljs-string">"DELETE FROM users WHERE email LIKE '%test%'"</span>
        ]

        <span class="hljs-keyword">for</span> query <span class="hljs-keyword">in</span> cleanup_queries:
            self.cursor.execute(query)

        self.connection.commit()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_user_creation_and_retrieval</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Test user creation and retrieval"""</span>
        <span class="hljs-comment"># Insert test user</span>
        insert_query = <span class="hljs-string">"""
        INSERT INTO users (email, name, preferences)
        VALUES (%s, %s, %s)
        """</span>

        test_preferences = json.dumps({
            <span class="hljs-string">"theme"</span>: <span class="hljs-string">"dark"</span>,
            <span class="hljs-string">"notifications"</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">"language"</span>: <span class="hljs-string">"en"</span>
        })

        self.cursor.execute(insert_query, (
            <span class="hljs-string">'integration_test@example.com'</span>,
            <span class="hljs-string">'Integration Test User'</span>,
            test_preferences
        ))

        user_id = self.cursor.lastrowid
        self.connection.commit()

        <span class="hljs-comment"># Retrieve user</span>
        select_query = <span class="hljs-string">"SELECT * FROM users WHERE id = %s"</span>
        self.cursor.execute(select_query, (user_id,))
        user = self.cursor.fetchone()

        <span class="hljs-comment"># Assertions</span>
        <span class="hljs-keyword">assert</span> user <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>
        <span class="hljs-keyword">assert</span> user[<span class="hljs-string">'email'</span>] == <span class="hljs-string">'integration_test@example.com'</span>
        <span class="hljs-keyword">assert</span> user[<span class="hljs-string">'name'</span>] == <span class="hljs-string">'Integration Test User'</span>
        <span class="hljs-keyword">assert</span> json.loads(user[<span class="hljs-string">'preferences'</span>])[<span class="hljs-string">'theme'</span>] == <span class="hljs-string">'dark'</span>
        <span class="hljs-keyword">assert</span> user[<span class="hljs-string">'created_at'</span>] <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>
        <span class="hljs-keyword">assert</span> user[<span class="hljs-string">'updated_at'</span>] <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_user_session_workflow</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Test complete user session workflow"""</span>
        <span class="hljs-comment"># Create user</span>
        insert_user_query = <span class="hljs-string">"""
        INSERT INTO users (email, name)
        VALUES (%s, %s)
        """</span>

        self.cursor.execute(insert_user_query, (
            <span class="hljs-string">'session_test@example.com'</span>,
            <span class="hljs-string">'Session Test User'</span>
        ))

        user_id = self.cursor.lastrowid
        self.connection.commit()

        <span class="hljs-comment"># Create session using stored procedure</span>
        session_token = <span class="hljs-literal">None</span>
        create_session_query = <span class="hljs-string">"CALL create_user_session(%s, @session_token)"</span>
        self.cursor.execute(create_session_query, (user_id,))

        <span class="hljs-comment"># Get the session token</span>
        self.cursor.execute(<span class="hljs-string">"SELECT @session_token AS session_token"</span>)
        result = self.cursor.fetchone()
        session_token = result[<span class="hljs-string">'session_token'</span>]

        self.connection.commit()

        <span class="hljs-comment"># Verify session exists</span>
        verify_query = <span class="hljs-string">"""
        SELECT * FROM user_sessions
        WHERE user_id = %s AND session_token = %s
        """</span>

        self.cursor.execute(verify_query, (user_id, session_token))
        session = self.cursor.fetchone()

        <span class="hljs-keyword">assert</span> session <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>
        <span class="hljs-keyword">assert</span> session[<span class="hljs-string">'user_id'</span>] == user_id
        <span class="hljs-keyword">assert</span> session[<span class="hljs-string">'session_token'</span>] == session_token
        <span class="hljs-keyword">assert</span> session[<span class="hljs-string">'expires_at'</span>] &gt; datetime.now()

        <span class="hljs-comment"># Validate session using function</span>
        validate_query = <span class="hljs-string">"SELECT validate_user_session(%s) AS is_valid"</span>
        self.cursor.execute(validate_query, (session_token,))
        validation_result = self.cursor.fetchone()

        <span class="hljs-keyword">assert</span> validation_result[<span class="hljs-string">'is_valid'</span>] == <span class="hljs-number">1</span>

        <span class="hljs-comment"># Test invalid session</span>
        self.cursor.execute(validate_query, (<span class="hljs-string">'invalid_token'</span>,))
        invalid_result = self.cursor.fetchone()

        <span class="hljs-keyword">assert</span> invalid_result[<span class="hljs-string">'is_valid'</span>] == <span class="hljs-number">0</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_database_constraints</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Test database constraints and error handling"""</span>
        <span class="hljs-comment"># Test unique constraint on email</span>
        insert_query = <span class="hljs-string">"""
        INSERT INTO users (email, name)
        VALUES (%s, %s)
        """</span>

        <span class="hljs-comment"># Insert first user</span>
        self.cursor.execute(insert_query, (
            <span class="hljs-string">'constraint_test@example.com'</span>,
            <span class="hljs-string">'Constraint Test User 1'</span>
        ))
        self.connection.commit()

        <span class="hljs-comment"># Try to insert duplicate email</span>
        <span class="hljs-keyword">with</span> pytest.raises(mysql.connector.IntegrityError):
            self.cursor.execute(insert_query, (
                <span class="hljs-string">'constraint_test@example.com'</span>,
                <span class="hljs-string">'Constraint Test User 2'</span>
            ))
            self.connection.commit()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_transaction_rollback</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Test transaction rollback functionality"""</span>
        <span class="hljs-comment"># Start transaction</span>
        self.connection.start_transaction()

        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># Insert user</span>
            insert_user_query = <span class="hljs-string">"""
            INSERT INTO users (email, name)
            VALUES (%s, %s)
            """</span>

            self.cursor.execute(insert_user_query, (
                <span class="hljs-string">'transaction_test@example.com'</span>,
                <span class="hljs-string">'Transaction Test User'</span>
            ))

            user_id = self.cursor.lastrowid

            <span class="hljs-comment"># Insert session</span>
            insert_session_query = <span class="hljs-string">"""
            INSERT INTO user_sessions (user_id, session_token, expires_at)
            VALUES (%s, %s, %s)
            """</span>

            self.cursor.execute(insert_session_query, (
                user_id,
                <span class="hljs-string">'test_session_token'</span>,
                datetime.now() + timedelta(hours=<span class="hljs-number">1</span>)
            ))

            <span class="hljs-comment"># Simulate error condition</span>
            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">"Simulated error"</span>)

        <span class="hljs-keyword">except</span> Exception:
            <span class="hljs-comment"># Rollback transaction</span>
            self.connection.rollback()

        <span class="hljs-comment"># Verify no data was inserted</span>
        check_user_query = <span class="hljs-string">"SELECT COUNT(*) as count FROM users WHERE email = %s"</span>
        self.cursor.execute(check_user_query, (<span class="hljs-string">'transaction_test@example.com'</span>,))
        user_count = self.cursor.fetchone()[<span class="hljs-string">'count'</span>]

        check_session_query = <span class="hljs-string">"SELECT COUNT(*) as count FROM user_sessions WHERE session_token = %s"</span>
        self.cursor.execute(check_session_query, (<span class="hljs-string">'test_session_token'</span>,))
        session_count = self.cursor.fetchone()[<span class="hljs-string">'count'</span>]

        <span class="hljs-keyword">assert</span> user_count == <span class="hljs-number">0</span>
        <span class="hljs-keyword">assert</span> session_count == <span class="hljs-number">0</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_performance_with_indexes</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Test query performance with indexes"""</span>
        <span class="hljs-keyword">import</span> time

        <span class="hljs-comment"># Insert test data</span>
        insert_query = <span class="hljs-string">"""
        INSERT INTO users (email, name)
        VALUES (%s, %s)
        """</span>

        test_users = [
            (<span class="hljs-string">f'perf_test_<span class="hljs-subst">{i}</span>@example.com'</span>, <span class="hljs-string">f'Performance Test User <span class="hljs-subst">{i}</span>'</span>)
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1000</span>)
        ]

        self.cursor.executemany(insert_query, test_users)
        self.connection.commit()

        <span class="hljs-comment"># Test query performance with index</span>
        start_time = time.time()

        search_query = <span class="hljs-string">"SELECT * FROM users WHERE email = %s"</span>
        self.cursor.execute(search_query, (<span class="hljs-string">'perf_test_500@example.com'</span>,))
        result = self.cursor.fetchone()

        end_time = time.time()
        query_time = end_time - start_time

        <span class="hljs-comment"># Assert query completed quickly (should be fast with index)</span>
        <span class="hljs-keyword">assert</span> query_time &lt; <span class="hljs-number">0.1</span>  <span class="hljs-comment"># Less than 100ms</span>
        <span class="hljs-keyword">assert</span> result <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>
        <span class="hljs-keyword">assert</span> result[<span class="hljs-string">'email'</span>] == <span class="hljs-string">'perf_test_500@example.com'</span>

<span class="hljs-comment"># Run tests</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    pytest.main([__file__, <span class="hljs-string">'-v'</span>])
</div></code></pre>
<h3 id="performance-testing">Performance Testing</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># tests/test_database_performance.py</span>
<span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">import</span> mysql.connector
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> statistics
<span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor, as_completed
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">import</span> string

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabasePerformanceTest</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.connection_pool = <span class="hljs-literal">None</span>
        self.setup_connection_pool()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setup_connection_pool</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Setup connection pool for performance testing"""</span>
        config = {
            <span class="hljs-string">'host'</span>: <span class="hljs-string">'localhost'</span>,
            <span class="hljs-string">'database'</span>: <span class="hljs-string">'myapp_test'</span>,
            <span class="hljs-string">'user'</span>: <span class="hljs-string">'test_user'</span>,
            <span class="hljs-string">'password'</span>: <span class="hljs-string">'test_password'</span>,
            <span class="hljs-string">'pool_name'</span>: <span class="hljs-string">'performance_test_pool'</span>,
            <span class="hljs-string">'pool_size'</span>: <span class="hljs-number">10</span>,
            <span class="hljs-string">'pool_reset_session'</span>: <span class="hljs-literal">True</span>
        }

        self.connection_pool = mysql.connector.pooling.MySQLConnectionPool(**config)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_connection</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Get connection from pool"""</span>
        <span class="hljs-keyword">return</span> self.connection_pool.get_connection()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_test_data</span><span class="hljs-params">(self, count=<span class="hljs-number">10000</span>)</span>:</span>
        <span class="hljs-string">"""Generate test data for performance testing"""</span>
        connection = self.get_connection()
        cursor = connection.cursor()

        <span class="hljs-comment"># Clean existing test data</span>
        cursor.execute(<span class="hljs-string">"DELETE FROM users WHERE email LIKE 'perf_%'"</span>)

        <span class="hljs-comment"># Generate test users</span>
        test_users = []
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(count):
            email = <span class="hljs-string">f'perf_<span class="hljs-subst">{i}</span>@example.com'</span>
            name = <span class="hljs-string">f'Performance User <span class="hljs-subst">{i}</span>'</span>
            test_users.append((email, name))

        <span class="hljs-comment"># Batch insert</span>
        insert_query = <span class="hljs-string">"INSERT INTO users (email, name) VALUES (%s, %s)"</span>
        cursor.executemany(insert_query, test_users)

        connection.commit()
        cursor.close()
        connection.close()

        print(<span class="hljs-string">f"Generated <span class="hljs-subst">{count}</span> test users"</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_single_query_performance</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Test single query performance"""</span>
        connection = self.get_connection()
        cursor = connection.cursor()

        <span class="hljs-comment"># Test different query types</span>
        queries = [
            (<span class="hljs-string">"SELECT * FROM users WHERE email = 'perf_5000@example.com'"</span>, <span class="hljs-string">"Indexed lookup"</span>),
            (<span class="hljs-string">"SELECT COUNT(*) FROM users WHERE name LIKE 'Performance%'"</span>, <span class="hljs-string">"Pattern matching"</span>),
            (<span class="hljs-string">"SELECT * FROM users ORDER BY created_at DESC LIMIT 100"</span>, <span class="hljs-string">"Ordered limit"</span>),
            (<span class="hljs-string">"SELECT name, COUNT(*) FROM users GROUP BY name HAVING COUNT(*) &gt; 1"</span>, <span class="hljs-string">"Aggregation"</span>)
        ]

        results = []

        <span class="hljs-keyword">for</span> query, description <span class="hljs-keyword">in</span> queries:
            times = []

            <span class="hljs-comment"># Run query multiple times</span>
            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>):
                start_time = time.time()
                cursor.execute(query)
                cursor.fetchall()
                end_time = time.time()

                times.append(end_time - start_time)

            avg_time = statistics.mean(times)
            min_time = min(times)
            max_time = max(times)

            results.append({
                <span class="hljs-string">'description'</span>: description,
                <span class="hljs-string">'avg_time'</span>: avg_time,
                <span class="hljs-string">'min_time'</span>: min_time,
                <span class="hljs-string">'max_time'</span>: max_time,
                <span class="hljs-string">'query'</span>: query
            })

            print(<span class="hljs-string">f"<span class="hljs-subst">{description}</span>: Avg <span class="hljs-subst">{avg_time:<span class="hljs-number">.4</span>f}</span>s, Min <span class="hljs-subst">{min_time:<span class="hljs-number">.4</span>f}</span>s, Max <span class="hljs-subst">{max_time:<span class="hljs-number">.4</span>f}</span>s"</span>)

        cursor.close()
        connection.close()

        <span class="hljs-comment"># Assert performance thresholds</span>
        <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> results:
            <span class="hljs-keyword">assert</span> result[<span class="hljs-string">'avg_time'</span>] &lt; <span class="hljs-number">1.0</span>, <span class="hljs-string">f"Query too slow: <span class="hljs-subst">{result[<span class="hljs-string">'description'</span>]}</span>"</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_concurrent_query_performance</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Test concurrent query performance"""</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">execute_query</span><span class="hljs-params">(query_id)</span>:</span>
            <span class="hljs-string">"""Execute a query and return timing"""</span>
            connection = self.get_connection()
            cursor = connection.cursor()

            start_time = time.time()

            <span class="hljs-comment"># Random user lookup</span>
            user_id = random.randint(<span class="hljs-number">1</span>, <span class="hljs-number">1000</span>)
            cursor.execute(<span class="hljs-string">"SELECT * FROM users WHERE email = %s"</span>, (<span class="hljs-string">f'perf_<span class="hljs-subst">{user_id}</span>@example.com'</span>,))
            result = cursor.fetchone()

            end_time = time.time()

            cursor.close()
            connection.close()

            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">'query_id'</span>: query_id,
                <span class="hljs-string">'execution_time'</span>: end_time - start_time,
                <span class="hljs-string">'success'</span>: result <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>
            }

        <span class="hljs-comment"># Test with different concurrency levels</span>
        concurrency_levels = [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>]

        <span class="hljs-keyword">for</span> concurrency <span class="hljs-keyword">in</span> concurrency_levels:
            print(<span class="hljs-string">f"\nTesting with <span class="hljs-subst">{concurrency}</span> concurrent connections..."</span>)

            start_time = time.time()

            <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=concurrency) <span class="hljs-keyword">as</span> executor:
                futures = [executor.submit(execute_query, i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">100</span>)]
                results = [future.result() <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> as_completed(futures)]

            end_time = time.time()
            total_time = end_time - start_time

            <span class="hljs-comment"># Calculate statistics</span>
            execution_times = [r[<span class="hljs-string">'execution_time'</span>] <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results]
            success_count = sum(<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results <span class="hljs-keyword">if</span> r[<span class="hljs-string">'success'</span>])

            avg_query_time = statistics.mean(execution_times)
            throughput = len(results) / total_time

            print(<span class="hljs-string">f"  Total time: <span class="hljs-subst">{total_time:<span class="hljs-number">.2</span>f}</span>s"</span>)
            print(<span class="hljs-string">f"  Average query time: <span class="hljs-subst">{avg_query_time:<span class="hljs-number">.4</span>f}</span>s"</span>)
            print(<span class="hljs-string">f"  Throughput: <span class="hljs-subst">{throughput:<span class="hljs-number">.2</span>f}</span> queries/second"</span>)
            print(<span class="hljs-string">f"  Success rate: <span class="hljs-subst">{success_count}</span>/<span class="hljs-subst">{len(results)}</span> (<span class="hljs-subst">{success_count/len(results)*<span class="hljs-number">100</span>:<span class="hljs-number">.1</span>f}</span>%)"</span>)

            <span class="hljs-comment"># Assert performance thresholds</span>
            <span class="hljs-keyword">assert</span> success_count == len(results), <span class="hljs-string">"Some queries failed"</span>
            <span class="hljs-keyword">assert</span> avg_query_time &lt; <span class="hljs-number">0.5</span>, <span class="hljs-string">f"Average query time too high: <span class="hljs-subst">{avg_query_time:<span class="hljs-number">.4</span>f}</span>s"</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_bulk_operations_performance</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Test bulk operations performance"""</span>
        connection = self.get_connection()
        cursor = connection.cursor()

        <span class="hljs-comment"># Test bulk insert</span>
        print(<span class="hljs-string">"Testing bulk insert performance..."</span>)

        bulk_data = []
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1000</span>):
            email = <span class="hljs-string">f'bulk_<span class="hljs-subst">{i}</span>@example.com'</span>
            name = <span class="hljs-string">f'Bulk User <span class="hljs-subst">{i}</span>'</span>
            bulk_data.append((email, name))

        start_time = time.time()

        insert_query = <span class="hljs-string">"INSERT INTO users (email, name) VALUES (%s, %s)"</span>
        cursor.executemany(insert_query, bulk_data)
        connection.commit()

        end_time = time.time()
        insert_time = end_time - start_time

        print(<span class="hljs-string">f"Bulk insert of 1000 records: <span class="hljs-subst">{insert_time:<span class="hljs-number">.2</span>f}</span>s (<span class="hljs-subst">{<span class="hljs-number">1000</span>/insert_time:<span class="hljs-number">.0</span>f}</span> records/second)"</span>)

        <span class="hljs-comment"># Test bulk update</span>
        print(<span class="hljs-string">"Testing bulk update performance..."</span>)

        start_time = time.time()

        update_query = <span class="hljs-string">"UPDATE users SET name = CONCAT(name, ' - Updated') WHERE email LIKE 'bulk_%'"</span>
        cursor.execute(update_query)
        updated_rows = cursor.rowcount
        connection.commit()

        end_time = time.time()
        update_time = end_time - start_time

        print(<span class="hljs-string">f"Bulk update of <span class="hljs-subst">{updated_rows}</span> records: <span class="hljs-subst">{update_time:<span class="hljs-number">.2</span>f}</span>s (<span class="hljs-subst">{updated_rows/update_time:<span class="hljs-number">.0</span>f}</span> records/second)"</span>)

        <span class="hljs-comment"># Test bulk delete</span>
        print(<span class="hljs-string">"Testing bulk delete performance..."</span>)

        start_time = time.time()

        delete_query = <span class="hljs-string">"DELETE FROM users WHERE email LIKE 'bulk_%'"</span>
        cursor.execute(delete_query)
        deleted_rows = cursor.rowcount
        connection.commit()

        end_time = time.time()
        delete_time = end_time - start_time

        print(<span class="hljs-string">f"Bulk delete of <span class="hljs-subst">{deleted_rows}</span> records: <span class="hljs-subst">{delete_time:<span class="hljs-number">.2</span>f}</span>s (<span class="hljs-subst">{deleted_rows/delete_time:<span class="hljs-number">.0</span>f}</span> records/second)"</span>)

        cursor.close()
        connection.close()

        <span class="hljs-comment"># Assert performance thresholds</span>
        <span class="hljs-keyword">assert</span> insert_time &lt; <span class="hljs-number">5.0</span>, <span class="hljs-string">f"Bulk insert too slow: <span class="hljs-subst">{insert_time:<span class="hljs-number">.2</span>f}</span>s"</span>
        <span class="hljs-keyword">assert</span> update_time &lt; <span class="hljs-number">2.0</span>, <span class="hljs-string">f"Bulk update too slow: <span class="hljs-subst">{update_time:<span class="hljs-number">.2</span>f}</span>s"</span>
        <span class="hljs-keyword">assert</span> delete_time &lt; <span class="hljs-number">1.0</span>, <span class="hljs-string">f"Bulk delete too slow: <span class="hljs-subst">{delete_time:<span class="hljs-number">.2</span>f}</span>s"</span>

<span class="hljs-comment"># Run performance tests</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    perf_test = DatabasePerformanceTest()

    print(<span class="hljs-string">"Setting up test data..."</span>)
    perf_test.generate_test_data(<span class="hljs-number">10000</span>)

    print(<span class="hljs-string">"\n=== Single Query Performance Tests ==="</span>)
    perf_test.test_single_query_performance()

    print(<span class="hljs-string">"\n=== Concurrent Query Performance Tests ==="</span>)
    perf_test.test_concurrent_query_performance()

    print(<span class="hljs-string">"\n=== Bulk Operations Performance Tests ==="</span>)
    perf_test.test_bulk_operations_performance()

    print(<span class="hljs-string">"\nPerformance testing completed!"</span>)
</div></code></pre>
<hr>
<h2 id="%F0%9F%9A%80-cicd-pipeline-implementation">ğŸš€ CI/CD Pipeline Implementation</h2>
<h3 id="github-actions-workflow">GitHub Actions Workflow</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># .github/workflows/database-ci-cd.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Database</span> <span class="hljs-string">CI/CD</span> <span class="hljs-string">Pipeline</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> <span class="hljs-string">[main,</span> <span class="hljs-string">develop]</span>
    <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"migrations/**"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"database/**"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">".github/workflows/database-ci-cd.yml"</span>
  <span class="hljs-attr">pull_request:</span>
    <span class="hljs-attr">branches:</span> <span class="hljs-string">[main]</span>
    <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"migrations/**"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"database/**"</span>

<span class="hljs-attr">env:</span>
  <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">root_password</span>
  <span class="hljs-attr">MYSQL_DATABASE:</span> <span class="hljs-string">myapp_test</span>
  <span class="hljs-attr">MYSQL_USER:</span> <span class="hljs-string">test_user</span>
  <span class="hljs-attr">MYSQL_PASSWORD:</span> <span class="hljs-string">test_password</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">database-lint:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">Database</span> <span class="hljs-string">Linting</span>

    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Python</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-python@v4</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">python-version:</span> <span class="hljs-string">"3.9"</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">SQL</span> <span class="hljs-string">linting</span> <span class="hljs-string">tools</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          pip install sqlfluff
          pip install sqlparse
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Lint</span> <span class="hljs-string">SQL</span> <span class="hljs-string">files</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          sqlfluff lint migrations/ --dialect mysql
          find migrations/ -name "*.sql" -exec sqlparse --format {} \;
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Check</span> <span class="hljs-string">migration</span> <span class="hljs-string">naming</span> <span class="hljs-string">convention</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          python scripts/check_migration_naming.py
</span>
  <span class="hljs-attr">database-test:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">Database</span> <span class="hljs-string">Testing</span>

    <span class="hljs-attr">services:</span>
      <span class="hljs-attr">mysql:</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:8.0</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.MYSQL_ROOT_PASSWORD</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">MYSQL_DATABASE:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.MYSQL_DATABASE</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">MYSQL_USER:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.MYSQL_USER</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">MYSQL_PASSWORD:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.MYSQL_PASSWORD</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">ports:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-number">3306</span><span class="hljs-string">:3306</span>
        <span class="hljs-attr">options:</span> <span class="hljs-string">--health-cmd="mysqladmin</span> <span class="hljs-string">ping"</span> <span class="hljs-string">--health-interval=10s</span> <span class="hljs-string">--health-timeout=5s</span> <span class="hljs-string">--health-retries=3</span>

    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Java</span> <span class="hljs-string">(for</span> <span class="hljs-string">Flyway)</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-java@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">distribution:</span> <span class="hljs-string">"temurin"</span>
          <span class="hljs-attr">java-version:</span> <span class="hljs-string">"11"</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Flyway</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/9.8.1/flyway-commandline-9.8.1-linux-x64.tar.gz | tar xvz
          sudo ln -s `pwd`/flyway-9.8.1/flyway /usr/local/bin
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Wait</span> <span class="hljs-string">for</span> <span class="hljs-string">MySQL</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          while ! mysqladmin ping -h"127.0.0.1" -P3306 -u${{ env.MYSQL_USER }} -p${{ env.MYSQL_PASSWORD }} --silent; do
            sleep 1
          done
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">database</span> <span class="hljs-string">migrations</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          flyway -url=jdbc:mysql://localhost:3306/${{ env.MYSQL_DATABASE }} \
                 -user=${{ env.MYSQL_USER }} \
                 -password=${{ env.MYSQL_PASSWORD }} \
                 -locations=filesystem:migrations \
                 migrate
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Python</span> <span class="hljs-string">for</span> <span class="hljs-string">testing</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-python@v4</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">python-version:</span> <span class="hljs-string">"3.9"</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Python</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          pip install -r requirements-test.txt
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">database</span> <span class="hljs-string">unit</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          python -m pytest tests/test_database_unit.py -v
</span>        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">DB_TEST_HOST:</span> <span class="hljs-string">localhost</span>
          <span class="hljs-attr">DB_TEST_NAME:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.MYSQL_DATABASE</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">DB_TEST_USER:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.MYSQL_USER</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">DB_TEST_PASSWORD:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.MYSQL_PASSWORD</span> <span class="hljs-string">}}</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">database</span> <span class="hljs-string">integration</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          python -m pytest tests/test_database_integration.py -v
</span>        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">DB_TEST_HOST:</span> <span class="hljs-string">localhost</span>
          <span class="hljs-attr">DB_TEST_NAME:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.MYSQL_DATABASE</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">DB_TEST_USER:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.MYSQL_USER</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">DB_TEST_PASSWORD:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.MYSQL_PASSWORD</span> <span class="hljs-string">}}</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">database</span> <span class="hljs-string">performance</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          python -m pytest tests/test_database_performance.py -v
</span>        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">DB_TEST_HOST:</span> <span class="hljs-string">localhost</span>
          <span class="hljs-attr">DB_TEST_NAME:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.MYSQL_DATABASE</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">DB_TEST_USER:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.MYSQL_USER</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">DB_TEST_PASSWORD:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.MYSQL_PASSWORD</span> <span class="hljs-string">}}</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Generate</span> <span class="hljs-string">test</span> <span class="hljs-string">coverage</span> <span class="hljs-string">report</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          python scripts/generate_db_coverage_report.py
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">test</span> <span class="hljs-string">results</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
        <span class="hljs-attr">if:</span> <span class="hljs-string">always()</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">test-results</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">|
            test-results/
            coverage-reports/
</span>
  <span class="hljs-attr">database-security-scan:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">Database</span> <span class="hljs-string">Security</span> <span class="hljs-string">Scan</span>

    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">SQL</span> <span class="hljs-string">injection</span> <span class="hljs-string">vulnerability</span> <span class="hljs-string">scan</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          python scripts/scan_sql_injection.py migrations/
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Check</span> <span class="hljs-string">for</span> <span class="hljs-string">sensitive</span> <span class="hljs-string">data</span> <span class="hljs-string">in</span> <span class="hljs-string">migrations</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          python scripts/check_sensitive_data.py migrations/
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Validate</span> <span class="hljs-string">database</span> <span class="hljs-string">permissions</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          python scripts/validate_db_permissions.py
</span>
  <span class="hljs-attr">deploy-staging:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">Staging</span>
    <span class="hljs-attr">needs:</span> <span class="hljs-string">[database-lint,</span> <span class="hljs-string">database-test,</span> <span class="hljs-string">database-security-scan]</span>
    <span class="hljs-attr">if:</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">'refs/heads/develop'</span>

    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">staging</span>
      <span class="hljs-attr">url:</span> <span class="hljs-string">https://staging.myapp.com</span>

    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Java</span> <span class="hljs-string">(for</span> <span class="hljs-string">Flyway)</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-java@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">distribution:</span> <span class="hljs-string">"temurin"</span>
          <span class="hljs-attr">java-version:</span> <span class="hljs-string">"11"</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Flyway</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/9.8.1/flyway-commandline-9.8.1-linux-x64.tar.gz | tar xvz
          sudo ln -s `pwd`/flyway-9.8.1/flyway /usr/local/bin
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Create</span> <span class="hljs-string">database</span> <span class="hljs-string">backup</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          python scripts/create_backup.py staging
</span>        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">DB_STAGING_HOST:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DB_STAGING_HOST</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">DB_STAGING_NAME:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DB_STAGING_NAME</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">DB_STAGING_USER:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DB_STAGING_USER</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">DB_STAGING_PASSWORD:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DB_STAGING_PASSWORD</span> <span class="hljs-string">}}</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">staging</span> <span class="hljs-string">database</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          flyway -url=jdbc:mysql://${{ secrets.DB_STAGING_HOST }}:3306/${{ secrets.DB_STAGING_NAME }} \
                 -user=${{ secrets.DB_STAGING_USER }} \
                 -password=${{ secrets.DB_STAGING_PASSWORD }} \
                 -locations=filesystem:migrations \
                 -validateOnMigrate=true \
                 migrate
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">post-deployment</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          python scripts/post_deployment_tests.py staging
</span>        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">DB_STAGING_HOST:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DB_STAGING_HOST</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">DB_STAGING_NAME:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DB_STAGING_NAME</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">DB_STAGING_USER:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DB_STAGING_USER</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">DB_STAGING_PASSWORD:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DB_STAGING_PASSWORD</span> <span class="hljs-string">}}</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Notify</span> <span class="hljs-string">deployment</span> <span class="hljs-string">status</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">8398a7/action-slack@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">status:</span> <span class="hljs-string">${{</span> <span class="hljs-string">job.status</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">channel:</span> <span class="hljs-string">"#deployments"</span>
          <span class="hljs-attr">webhook_url:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SLACK_WEBHOOK</span> <span class="hljs-string">}}</span>

  <span class="hljs-attr">deploy-production:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">Production</span>
    <span class="hljs-attr">needs:</span> <span class="hljs-string">[database-lint,</span> <span class="hljs-string">database-test,</span> <span class="hljs-string">database-security-scan]</span>
    <span class="hljs-attr">if:</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">'refs/heads/main'</span>

    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">production</span>
      <span class="hljs-attr">url:</span> <span class="hljs-string">https://myapp.com</span>

    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Java</span> <span class="hljs-string">(for</span> <span class="hljs-string">Flyway)</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-java@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">distribution:</span> <span class="hljs-string">"temurin"</span>
          <span class="hljs-attr">java-version:</span> <span class="hljs-string">"11"</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Flyway</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/9.8.1/flyway-commandline-9.8.1-linux-x64.tar.gz | tar xvz
          sudo ln -s `pwd`/flyway-9.8.1/flyway /usr/local/bin
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Create</span> <span class="hljs-string">database</span> <span class="hljs-string">backup</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          python scripts/create_backup.py production
</span>        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">DB_PROD_HOST:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DB_PROD_HOST</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">DB_PROD_NAME:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DB_PROD_NAME</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">DB_PROD_USER:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DB_PROD_USER</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">DB_PROD_PASSWORD:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DB_PROD_PASSWORD</span> <span class="hljs-string">}}</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">production</span> <span class="hljs-string">database</span> <span class="hljs-string">(with</span> <span class="hljs-string">approval)</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          echo "Deploying to production database..."
          flyway -url=jdbc:mysql://${{ secrets.DB_PROD_HOST }}:3306/${{ secrets.DB_PROD_NAME }} \
                 -user=${{ secrets.DB_PROD_USER }} \
                 -password=${{ secrets.DB_PROD_PASSWORD }} \
                 -locations=filesystem:migrations \
                 -validateOnMigrate=true \
                 -outOfOrder=false \
                 migrate
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">post-deployment</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          python scripts/post_deployment_tests.py production
</span>        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">DB_PROD_HOST:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DB_PROD_HOST</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">DB_PROD_NAME:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DB_PROD_NAME</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">DB_PROD_USER:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DB_PROD_USER</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">DB_PROD_PASSWORD:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DB_PROD_PASSWORD</span> <span class="hljs-string">}}</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Update</span> <span class="hljs-string">monitoring</span> <span class="hljs-string">dashboards</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          python scripts/update_monitoring.py production
</span>        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">GRAFANA_API_KEY:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GRAFANA_API_KEY</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">DATADOG_API_KEY:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DATADOG_API_KEY</span> <span class="hljs-string">}}</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Notify</span> <span class="hljs-string">deployment</span> <span class="hljs-string">status</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">8398a7/action-slack@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">status:</span> <span class="hljs-string">${{</span> <span class="hljs-string">job.status</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">channel:</span> <span class="hljs-string">"#deployments"</span>
          <span class="hljs-attr">webhook_url:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SLACK_WEBHOOK</span> <span class="hljs-string">}}</span>
</div></code></pre>
<h3 id="jenkins-pipeline">Jenkins Pipeline</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Jenkinsfile</span>
pipeline {
    agent any

    environment {
        MYSQL_ROOT_PASSWORD = credentials(<span class="hljs-string">'mysql-root-password'</span>)
        DB_TEST_PASSWORD = credentials(<span class="hljs-string">'db-test-password'</span>)
        DB_STAGING_PASSWORD = credentials(<span class="hljs-string">'db-staging-password'</span>)
        DB_PROD_PASSWORD = credentials(<span class="hljs-string">'db-prod-password'</span>)
    }

    stages {
        stage(<span class="hljs-string">'Checkout'</span>) {
            steps {
                checkout scm
            }
        }

        stage(<span class="hljs-string">'Database Lint'</span>) {
            steps {
                script {
                    sh <span class="hljs-string">'''
                        pip install sqlfluff
                        sqlfluff lint migrations/ --dialect mysql
                    '''</span>
                }
            }
        }

        stage(<span class="hljs-string">'Setup Test Database'</span>) {
            steps {
                script {
                    sh <span class="hljs-string">'''
                        docker run -d --name mysql-test \
                            -e MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD} \
                            -e MYSQL_DATABASE=myapp_test \
                            -e MYSQL_USER=test_user \
                            -e MYSQL_PASSWORD=${DB_TEST_PASSWORD} \
                            -p 3307:3306 \
                            mysql:8.0

                        # Wait for MySQL to be ready
                        sleep 30

                        # Test connection
                        docker exec mysql-test mysqladmin ping -h localhost -u test_user -p${DB_TEST_PASSWORD}
                    '''</span>
                }
            }
        }

        stage(<span class="hljs-string">'Run Migrations'</span>) {
            steps {
                script {
                    sh <span class="hljs-string">'''
                        flyway -url=jdbc:mysql://localhost:3307/myapp_test \
                               -user=test_user \
                               -password=${DB_TEST_PASSWORD} \
                               -locations=filesystem:migrations \
                               migrate
                    '''</span>
                }
            }
        }

        stage(<span class="hljs-string">'Database Tests'</span>) {
            parallel {
                stage(<span class="hljs-string">'Unit Tests'</span>) {
                    steps {
                        script {
                            sh <span class="hljs-string">'''
                                export DB_TEST_HOST=localhost
                                export DB_TEST_PORT=3307
                                export DB_TEST_NAME=myapp_test
                                export DB_TEST_USER=test_user
                                export DB_TEST_PASSWORD=${DB_TEST_PASSWORD}

                                python -m pytest tests/test_database_unit.py -v --junitxml=test-results/unit-tests.xml
                            '''</span>
                        }
                    }
                }

                stage(<span class="hljs-string">'Integration Tests'</span>) {
                    steps {
                        script {
                            sh <span class="hljs-string">'''
                                export DB_TEST_HOST=localhost
                                export DB_TEST_PORT=3307
                                export DB_TEST_NAME=myapp_test
                                export DB_TEST_USER=test_user
                                export DB_TEST_PASSWORD=${DB_TEST_PASSWORD}

                                python -m pytest tests/test_database_integration.py -v --junitxml=test-results/integration-tests.xml
                            '''</span>
                        }
                    }
                }

                stage(<span class="hljs-string">'Performance Tests'</span>) {
                    steps {
                        script {
                            sh <span class="hljs-string">'''
                                export DB_TEST_HOST=localhost
                                export DB_TEST_PORT=3307
                                export DB_TEST_NAME=myapp_test
                                export DB_TEST_USER=test_user
                                export DB_TEST_PASSWORD=${DB_TEST_PASSWORD}

                                python -m pytest tests/test_database_performance.py -v --junitxml=test-results/performance-tests.xml
                            '''</span>
                        }
                    }
                }
            }
        }

        stage(<span class="hljs-string">'Security Scan'</span>) {
            steps {
                script {
                    sh <span class="hljs-string">'''
                        python scripts/scan_sql_injection.py migrations/
                        python scripts/check_sensitive_data.py migrations/
                    '''</span>
                }
            }
        }

        stage(<span class="hljs-string">'Deploy to Staging'</span>) {
            when {
                branch <span class="hljs-string">'develop'</span>
            }
            steps {
                script {
                    sh <span class="hljs-string">'''
                        # Create backup
                        python scripts/create_backup.py staging

                        # Deploy migrations
                        flyway -url=jdbc:mysql://staging-db:3306/myapp_staging \
                               -user=staging_user \
                               -password=${DB_STAGING_PASSWORD} \
                               -locations=filesystem:migrations \
                               migrate

                        # Run post-deployment tests
                        python scripts/post_deployment_tests.py staging
                    '''</span>
                }
            }
        }

        stage(<span class="hljs-string">'Deploy to Production'</span>) {
            when {
                branch <span class="hljs-string">'main'</span>
            }
            steps {
                script {
                    <span class="hljs-comment">// Require manual approval for production</span>
                    input <span class="hljs-string">message:</span> <span class="hljs-string">'Deploy to production?'</span>, <span class="hljs-string">ok:</span> <span class="hljs-string">'Deploy'</span>,
<span class="hljs-symbol">                          submitterParameter:</span> <span class="hljs-string">'DEPLOYER'</span>

                    sh <span class="hljs-string">'''
                        echo "Deploying to production (approved by ${DEPLOYER})"

                        # Create backup
                        python scripts/create_backup.py production

                        # Deploy migrations
                        flyway -url=jdbc:mysql://prod-db:3306/myapp_production \
                               -user=prod_user \
                               -password=${DB_PROD_PASSWORD} \
                               -locations=filesystem:migrations \
                               -validateOnMigrate=true \
                               migrate

                        # Run post-deployment tests
                        python scripts/post_deployment_tests.py production

                        # Update monitoring
                        python scripts/update_monitoring.py production
                    '''</span>
                }
            }
        }
    }

    post {
        always {
            <span class="hljs-comment">// Cleanup test database</span>
            script {
                sh <span class="hljs-string">'docker stop mysql-test || true'</span>
                sh <span class="hljs-string">'docker rm mysql-test || true'</span>
            }

            <span class="hljs-comment">// Publish test results</span>
            junit <span class="hljs-string">'test-results/*.xml'</span>

            <span class="hljs-comment">// Archive artifacts</span>
            archiveArtifacts <span class="hljs-string">artifacts:</span> <span class="hljs-string">'test-results/*, coverage-reports/*'</span>, <span class="hljs-string">allowEmptyArchive:</span> <span class="hljs-literal">true</span>
        }

        success {
            <span class="hljs-comment">// Notify success</span>
            slackSend <span class="hljs-string">channel:</span> <span class="hljs-string">'#deployments'</span>,
<span class="hljs-symbol">                     color:</span> <span class="hljs-string">'good'</span>,
<span class="hljs-symbol">                     message:</span> <span class="hljs-string">"Database deployment successful: ${env.JOB_NAME} - ${env.BUILD_NUMBER}"</span>
        }

        failure {
            <span class="hljs-comment">// Notify failure</span>
            slackSend <span class="hljs-string">channel:</span> <span class="hljs-string">'#deployments'</span>,
<span class="hljs-symbol">                     color:</span> <span class="hljs-string">'danger'</span>,
<span class="hljs-symbol">                     message:</span> <span class="hljs-string">"Database deployment failed: ${env.JOB_NAME} - ${env.BUILD_NUMBER}"</span>
        }
    }
}
</div></code></pre>
<hr>
<h2 id="%F0%9F%8F%97%EF%B8%8F-infrastructure-as-code-iac">ğŸ—ï¸ Infrastructure as Code (IaC)</h2>
<h3 id="terraform-for-database-infrastructure">Terraform for Database Infrastructure</h3>
<pre class="hljs"><code><div># terraform/database.tf
terraform {
  required_version = &quot;&gt;= 1.0&quot;
  required_providers {
    aws = {
      source  = &quot;hashicorp/aws&quot;
      version = &quot;~&gt; 5.0&quot;
    }
  }
}

provider &quot;aws&quot; {
  region = var.aws_region
}

# Variables
variable &quot;aws_region&quot; {
  description = &quot;AWS region&quot;
  type        = string
  default     = &quot;us-east-1&quot;
}

variable &quot;environment&quot; {
  description = &quot;Environment name&quot;
  type        = string
}

variable &quot;project_name&quot; {
  description = &quot;Project name&quot;
  type        = string
  default     = &quot;myapp&quot;
}

variable &quot;db_instance_class&quot; {
  description = &quot;RDS instance class&quot;
  type        = string
  default     = &quot;db.t3.micro&quot;
}

variable &quot;db_allocated_storage&quot; {
  description = &quot;RDS allocated storage&quot;
  type        = number
  default     = 20
}

variable &quot;db_max_allocated_storage&quot; {
  description = &quot;RDS max allocated storage&quot;
  type        = number
  default     = 100
}

variable &quot;backup_retention_period&quot; {
  description = &quot;Backup retention period&quot;
  type        = number
  default     = 7
}

variable &quot;multi_az&quot; {
  description = &quot;Enable Multi-AZ deployment&quot;
  type        = bool
  default     = false
}

# Data sources
data &quot;aws_availability_zones&quot; &quot;available&quot; {
  state = &quot;available&quot;
}

data &quot;aws_caller_identity&quot; &quot;current&quot; {}

# VPC and Networking
resource &quot;aws_vpc&quot; &quot;main&quot; {
  cidr_block           = &quot;10.0.0.0/16&quot;
  enable_dns_hostnames = true
  enable_dns_support   = true

  tags = {
    Name        = &quot;${var.project_name}-${var.environment}-vpc&quot;
    Environment = var.environment
  }
}

resource &quot;aws_subnet&quot; &quot;private&quot; {
  count             = 2
  vpc_id            = aws_vpc.main.id
  cidr_block        = &quot;10.0.${count.index + 1}.0/24&quot;
  availability_zone = data.aws_availability_zones.available.names[count.index]

  tags = {
    Name        = &quot;${var.project_name}-${var.environment}-private-subnet-${count.index + 1}&quot;
    Environment = var.environment
  }
}

resource &quot;aws_subnet&quot; &quot;public&quot; {
  count                   = 2
  vpc_id                  = aws_vpc.main.id
  cidr_block              = &quot;10.0.${count.index + 10}.0/24&quot;
  availability_zone       = data.aws_availability_zones.available.names[count.index]
  map_public_ip_on_launch = true

  tags = {
    Name        = &quot;${var.project_name}-${var.environment}-public-subnet-${count.index + 1}&quot;
    Environment = var.environment
  }
}

resource &quot;aws_internet_gateway&quot; &quot;main&quot; {
  vpc_id = aws_vpc.main.id

  tags = {
    Name        = &quot;${var.project_name}-${var.environment}-igw&quot;
    Environment = var.environment
  }
}

resource &quot;aws_route_table&quot; &quot;public&quot; {
  vpc_id = aws_vpc.main.id

  route {
    cidr_block = &quot;0.0.0.0/0&quot;
    gateway_id = aws_internet_gateway.main.id
  }

  tags = {
    Name        = &quot;${var.project_name}-${var.environment}-public-rt&quot;
    Environment = var.environment
  }
}

resource &quot;aws_route_table_association&quot; &quot;public&quot; {
  count          = length(aws_subnet.public)
  subnet_id      = aws_subnet.public[count.index].id
  route_table_id = aws_route_table.public.id
}

# Security Groups
resource &quot;aws_security_group&quot; &quot;rds&quot; {
  name_prefix = &quot;${var.project_name}-${var.environment}-rds-&quot;
  vpc_id      = aws_vpc.main.id

  ingress {
    from_port       = 3306
    to_port         = 3306
    protocol        = &quot;tcp&quot;
    security_groups = [aws_security_group.app.id]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = &quot;-1&quot;
    cidr_blocks = [&quot;0.0.0.0/0&quot;]
  }

  tags = {
    Name        = &quot;${var.project_name}-${var.environment}-rds-sg&quot;
    Environment = var.environment
  }
}

resource &quot;aws_security_group&quot; &quot;app&quot; {
  name_prefix = &quot;${var.project_name}-${var.environment}-app-&quot;
  vpc_id      = aws_vpc.main.id

  ingress {
    from_port   = 80
    to_port     = 80
    protocol    = &quot;tcp&quot;
    cidr_blocks = [&quot;0.0.0.0/0&quot;]
  }

  ingress {
    from_port   = 443
    to_port     = 443
    protocol    = &quot;tcp&quot;
    cidr_blocks = [&quot;0.0.0.0/0&quot;]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = &quot;-1&quot;
    cidr_blocks = [&quot;0.0.0.0/0&quot;]
  }

  tags = {
    Name        = &quot;${var.project_name}-${var.environment}-app-sg&quot;
    Environment = var.environment
  }
}

# RDS Subnet Group
resource &quot;aws_db_subnet_group&quot; &quot;main&quot; {
  name       = &quot;${var.project_name}-${var.environment}-db-subnet-group&quot;
  subnet_ids = aws_subnet.private[*].id

  tags = {
    Name        = &quot;${var.project_name}-${var.environment}-db-subnet-group&quot;
    Environment = var.environment
  }
}

# RDS Parameter Group
resource &quot;aws_db_parameter_group&quot; &quot;main&quot; {
  family = &quot;mysql8.0&quot;
  name   = &quot;${var.project_name}-${var.environment}-db-params&quot;

  parameter {
    name  = &quot;innodb_buffer_pool_size&quot;
    value = &quot;{DBInstanceClassMemory*3/4}&quot;
  }

  parameter {
    name  = &quot;slow_query_log&quot;
    value = &quot;1&quot;
  }

  parameter {
    name  = &quot;long_query_time&quot;
    value = &quot;2&quot;
  }

  parameter {
    name  = &quot;general_log&quot;
    value = &quot;0&quot;
  }

  tags = {
    Name        = &quot;${var.project_name}-${var.environment}-db-params&quot;
    Environment = var.environment
  }
}

# KMS Key for RDS Encryption
resource &quot;aws_kms_key&quot; &quot;rds&quot; {
  description             = &quot;KMS key for RDS encryption&quot;
  deletion_window_in_days = 7

  tags = {
    Name        = &quot;${var.project_name}-${var.environment}-rds-key&quot;
    Environment = var.environment
  }
}

resource &quot;aws_kms_alias&quot; &quot;rds&quot; {
  name          = &quot;alias/${var.project_name}-${var.environment}-rds&quot;
  target_key_id = aws_kms_key.rds.key_id
}

# Secrets Manager for Database Credentials
resource &quot;aws_secretsmanager_secret&quot; &quot;db_credentials&quot; {
  name                    = &quot;${var.project_name}/${var.environment}/database/credentials&quot;
  description             = &quot;Database credentials for ${var.project_name} ${var.environment}&quot;
  recovery_window_in_days = 7

  tags = {
    Name        = &quot;${var.project_name}-${var.environment}-db-credentials&quot;
    Environment = var.environment
  }
}

resource &quot;aws_secretsmanager_secret_version&quot; &quot;db_credentials&quot; {
  secret_id = aws_secretsmanager_secret.db_credentials.id
  secret_string = jsonencode({
    username = &quot;admin&quot;
    password = random_password.db_password.result
  })
}

resource &quot;random_password&quot; &quot;db_password&quot; {
  length  = 32
  special = true
}

# RDS Instance
resource &quot;aws_db_instance&quot; &quot;main&quot; {
  identifier = &quot;${var.project_name}-${var.environment}-db&quot;

  # Engine
  engine         = &quot;mysql&quot;
  engine_version = &quot;8.0.35&quot;
  instance_class = var.db_instance_class

  # Storage
  allocated_storage     = var.db_allocated_storage
  max_allocated_storage = var.db_max_allocated_storage
  storage_type          = &quot;gp2&quot;
  storage_encrypted     = true
  kms_key_id           = aws_kms_key.rds.arn

  # Database
  db_name  = &quot;${var.project_name}_${var.environment}&quot;
  username = &quot;admin&quot;
  password = random_password.db_password.result

  # Network
  db_subnet_group_name   = aws_db_subnet_group.main.name
  vpc_security_group_ids = [aws_security_group.rds.id]
  publicly_accessible    = false

  # Backup
  backup_retention_period = var.backup_retention_period
  backup_window          = &quot;03:00-04:00&quot;
  maintenance_window     = &quot;sun:04:00-sun:05:00&quot;
  delete_automated_backups = false

  # High Availability
  multi_az = var.multi_az

  # Monitoring
  monitoring_interval = 60
  monitoring_role_arn = aws_iam_role.rds_monitoring.arn
  enabled_cloudwatch_logs_exports = [&quot;error&quot;, &quot;general&quot;, &quot;slow&quot;]

  # Performance Insights
  performance_insights_enabled = true
  performance_insights_kms_key_id = aws_kms_key.rds.arn
  performance_insights_retention_period = 7

  # Parameter Group
  parameter_group_name = aws_db_parameter_group.main.name

  # Deletion Protection
  deletion_protection = var.environment == &quot;production&quot; ? true : false
  skip_final_snapshot = var.environment == &quot;production&quot; ? false : true
  final_snapshot_identifier = var.environment == &quot;production&quot; ? &quot;${var.project_name}-${var.environment}-final-snapshot-${formatdate(&quot;YYYY-MM-DD-hhmm&quot;, timestamp())}&quot; : null

  tags = {
    Name        = &quot;${var.project_name}-${var.environment}-db&quot;
    Environment = var.environment
  }
}

# IAM Role for RDS Monitoring
resource &quot;aws_iam_role&quot; &quot;rds_monitoring&quot; {
  name = &quot;${var.project_name}-${var.environment}-rds-monitoring-role&quot;

  assume_role_policy = jsonencode({
    Version = &quot;2012-10-17&quot;
    Statement = [
      {
        Action = &quot;sts:AssumeRole&quot;
        Effect = &quot;Allow&quot;
        Principal = {
          Service = &quot;monitoring.rds.amazonaws.com&quot;
        }
      }
    ]
  })

  tags = {
    Name        = &quot;${var.project_name}-${var.environment}-rds-monitoring-role&quot;
    Environment = var.environment
  }
}

resource &quot;aws_iam_role_policy_attachment&quot; &quot;rds_monitoring&quot; {
  role       = aws_iam_role.rds_monitoring.name
  policy_arn = &quot;arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole&quot;
}

# Read Replica (for production)
resource &quot;aws_db_instance&quot; &quot;read_replica&quot; {
  count = var.environment == &quot;production&quot; ? 1 : 0

  identifier = &quot;${var.project_name}-${var.environment}-db-replica&quot;

  replicate_source_db = aws_db_instance.main.identifier
  instance_class      = var.db_instance_class

  publicly_accessible = false
  monitoring_interval = 60
  monitoring_role_arn = aws_iam_role.rds_monitoring.arn

  performance_insights_enabled = true
  performance_insights_kms_key_id = aws_kms_key.rds.arn

  tags = {
    Name        = &quot;${var.project_name}-${var.environment}-db-replica&quot;
    Environment = var.environment
  }
}

# Outputs
output &quot;rds_endpoint&quot; {
  description = &quot;RDS instance endpoint&quot;
  value       = aws_db_instance.main.endpoint
  sensitive   = true
}

output &quot;rds_port&quot; {
  description = &quot;RDS instance port&quot;
  value       = aws_db_instance.main.port
}

output &quot;database_name&quot; {
  description = &quot;Database name&quot;
  value       = aws_db_instance.main.db_name
}

output &quot;secret_arn&quot; {
  description = &quot;Secrets Manager secret ARN&quot;
  value       = aws_secretsmanager_secret.db_credentials.arn
}

output &quot;read_replica_endpoint&quot; {
  description = &quot;Read replica endpoint&quot;
  value       = var.environment == &quot;production&quot; ? aws_db_instance.read_replica[0].endpoint : null
  sensitive   = true
}
</div></code></pre>
<h3 id="ansible-for-database-configuration">Ansible for Database Configuration</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># ansible/database-setup.yml</span>
<span class="hljs-meta">---</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Database</span> <span class="hljs-string">Setup</span> <span class="hljs-string">and</span> <span class="hljs-string">Configuration</span>
  <span class="hljs-attr">hosts:</span> <span class="hljs-string">database_servers</span>
  <span class="hljs-attr">become:</span> <span class="hljs-literal">yes</span>
  <span class="hljs-attr">vars:</span>
    <span class="hljs-attr">mysql_root_password:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ vault_mysql_root_password }}</span>"</span>
    <span class="hljs-attr">mysql_databases:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">myapp_production</span>
        <span class="hljs-attr">encoding:</span> <span class="hljs-string">utf8mb4</span>
        <span class="hljs-attr">collation:</span> <span class="hljs-string">utf8mb4_unicode_ci</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">myapp_staging</span>
        <span class="hljs-attr">encoding:</span> <span class="hljs-string">utf8mb4</span>
        <span class="hljs-attr">collation:</span> <span class="hljs-string">utf8mb4_unicode_ci</span>
    <span class="hljs-attr">mysql_users:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app_user</span>
        <span class="hljs-attr">password:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ vault_app_user_password }}</span>"</span>
        <span class="hljs-attr">priv:</span> <span class="hljs-string">"myapp_production.*:ALL"</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">"%"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">readonly_user</span>
        <span class="hljs-attr">password:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ vault_readonly_password }}</span>"</span>
        <span class="hljs-attr">priv:</span> <span class="hljs-string">"myapp_production.*:SELECT"</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">"%"</span>

  <span class="hljs-attr">tasks:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">MySQL</span> <span class="hljs-string">server</span>
      <span class="hljs-attr">package:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">mysql-server</span>
        <span class="hljs-attr">state:</span> <span class="hljs-string">present</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Start</span> <span class="hljs-string">and</span> <span class="hljs-string">enable</span> <span class="hljs-string">MySQL</span> <span class="hljs-string">service</span>
      <span class="hljs-attr">service:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">mysql</span>
        <span class="hljs-attr">state:</span> <span class="hljs-string">started</span>
        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">yes</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">MySQL</span> <span class="hljs-string">root</span> <span class="hljs-string">password</span>
      <span class="hljs-attr">mysql_user:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ mysql_root_password }}</span>"</span>
        <span class="hljs-attr">login_unix_socket:</span> <span class="hljs-string">/var/run/mysqld/mysqld.sock</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Create</span> <span class="hljs-string">MySQL</span> <span class="hljs-string">configuration</span> <span class="hljs-string">file</span>
      <span class="hljs-attr">template:</span>
        <span class="hljs-attr">src:</span> <span class="hljs-string">my.cnf.j2</span>
        <span class="hljs-attr">dest:</span> <span class="hljs-string">/etc/mysql/mysql.conf.d/custom.cnf</span>
        <span class="hljs-attr">backup:</span> <span class="hljs-literal">yes</span>
      <span class="hljs-attr">notify:</span> <span class="hljs-string">restart</span> <span class="hljs-string">mysql</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Create</span> <span class="hljs-string">databases</span>
      <span class="hljs-attr">mysql_db:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ item.name }}</span>"</span>
        <span class="hljs-attr">encoding:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ item.encoding }}</span>"</span>
        <span class="hljs-attr">collation:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ item.collation }}</span>"</span>
        <span class="hljs-attr">state:</span> <span class="hljs-string">present</span>
        <span class="hljs-attr">login_user:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">login_password:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ mysql_root_password }}</span>"</span>
      <span class="hljs-attr">loop:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ mysql_databases }}</span>"</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Create</span> <span class="hljs-string">MySQL</span> <span class="hljs-string">users</span>
      <span class="hljs-attr">mysql_user:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ item.name }}</span>"</span>
        <span class="hljs-attr">password:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ item.password }}</span>"</span>
        <span class="hljs-attr">priv:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ item.priv }}</span>"</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ item.host }}</span>"</span>
        <span class="hljs-attr">state:</span> <span class="hljs-string">present</span>
        <span class="hljs-attr">login_user:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">login_password:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ mysql_root_password }}</span>"</span>
      <span class="hljs-attr">loop:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ mysql_users }}</span>"</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Flyway</span>
      <span class="hljs-attr">unarchive:</span>
        <span class="hljs-attr">src:</span> <span class="hljs-string">https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/9.8.1/flyway-commandline-9.8.1-linux-x64.tar.gz</span>
        <span class="hljs-attr">dest:</span> <span class="hljs-string">/opt</span>
        <span class="hljs-attr">remote_src:</span> <span class="hljs-literal">yes</span>
        <span class="hljs-attr">creates:</span> <span class="hljs-string">/opt/flyway-9.8.1</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Create</span> <span class="hljs-string">Flyway</span> <span class="hljs-string">symlink</span>
      <span class="hljs-attr">file:</span>
        <span class="hljs-attr">src:</span> <span class="hljs-string">/opt/flyway-9.8.1/flyway</span>
        <span class="hljs-attr">dest:</span> <span class="hljs-string">/usr/local/bin/flyway</span>
        <span class="hljs-attr">state:</span> <span class="hljs-string">link</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Create</span> <span class="hljs-string">database</span> <span class="hljs-string">backup</span> <span class="hljs-string">script</span>
      <span class="hljs-attr">template:</span>
        <span class="hljs-attr">src:</span> <span class="hljs-string">backup-database.sh.j2</span>
        <span class="hljs-attr">dest:</span> <span class="hljs-string">/usr/local/bin/backup-database.sh</span>
        <span class="hljs-attr">mode:</span> <span class="hljs-string">"0755"</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Schedule</span> <span class="hljs-string">database</span> <span class="hljs-string">backups</span>
      <span class="hljs-attr">cron:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">"Database backup"</span>
        <span class="hljs-attr">minute:</span> <span class="hljs-string">"0"</span>
        <span class="hljs-attr">hour:</span> <span class="hljs-string">"2"</span>
        <span class="hljs-attr">job:</span> <span class="hljs-string">"/usr/local/bin/backup-database.sh"</span>

  <span class="hljs-attr">handlers:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">restart</span> <span class="hljs-string">mysql</span>
      <span class="hljs-attr">service:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">mysql</span>
        <span class="hljs-attr">state:</span> <span class="hljs-string">restarted</span>
</div></code></pre>
<hr>
<h2 id="%F0%9F%93%8A-monitoring-and-observability">ğŸ“Š Monitoring and Observability</h2>
<h3 id="database-monitoring-with-prometheus-and-grafana">Database Monitoring with Prometheus and Grafana</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># docker-compose.monitoring.yml</span>
<span class="hljs-attr">version:</span> <span class="hljs-string">"3.8"</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-attr">prometheus:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">prom/prometheus:latest</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">prometheus</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9090:9090"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">prometheus_data:/prometheus</span>
    <span class="hljs-attr">command:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"--config.file=/etc/prometheus/prometheus.yml"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"--storage.tsdb.path=/prometheus"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"--web.console.libraries=/etc/prometheus/console_libraries"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"--web.console.templates=/etc/prometheus/consoles"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"--storage.tsdb.retention.time=200h"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"--web.enable-lifecycle"</span>

  <span class="hljs-attr">grafana:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">grafana/grafana:latest</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">grafana</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"3000:3000"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">GF_SECURITY_ADMIN_PASSWORD=admin123</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">grafana_data:/var/lib/grafana</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./grafana/provisioning:/etc/grafana/provisioning</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./grafana/dashboards:/var/lib/grafana/dashboards</span>

  <span class="hljs-attr">mysql-exporter:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">prom/mysqld-exporter:latest</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">mysql-exporter</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9104:9104"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">DATA_SOURCE_NAME=exporter:exporter_password@(mysql:3306)/</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span>

  <span class="hljs-attr">mysql:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:8.0</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">mysql</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">MYSQL_ROOT_PASSWORD=root_password</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">MYSQL_DATABASE=myapp_dev</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">MYSQL_USER=app_user</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">MYSQL_PASSWORD=app_password</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"3306:3306"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql_data:/var/lib/mysql</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./mysql/init:/docker-entrypoint-initdb.d</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">prometheus_data:</span>
  <span class="hljs-attr">grafana_data:</span>
  <span class="hljs-attr">mysql_data:</span>
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment"># prometheus/prometheus.yml</span>
<span class="hljs-attr">global:</span>
  <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">15s</span>
  <span class="hljs-attr">evaluation_interval:</span> <span class="hljs-string">15s</span>

<span class="hljs-attr">rule_files:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"database_rules.yml"</span>

<span class="hljs-attr">scrape_configs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">"mysql"</span>
    <span class="hljs-attr">static_configs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> <span class="hljs-string">["mysql-exporter:9104"]</span>
    <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">5s</span>
    <span class="hljs-attr">metrics_path:</span> <span class="hljs-string">/metrics</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">"application"</span>
    <span class="hljs-attr">static_configs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> <span class="hljs-string">["app:8080"]</span>
    <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">15s</span>

<span class="hljs-attr">alerting:</span>
  <span class="hljs-attr">alertmanagers:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">static_configs:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">alertmanager:9093</span>
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment"># prometheus/database_rules.yml</span>
<span class="hljs-attr">groups:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">database.rules</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">MySQLDown</span>
        <span class="hljs-attr">expr:</span> <span class="hljs-string">mysql_up</span> <span class="hljs-string">==</span> <span class="hljs-number">0</span>
        <span class="hljs-attr">for:</span> <span class="hljs-string">0m</span>
        <span class="hljs-attr">labels:</span>
          <span class="hljs-attr">severity:</span> <span class="hljs-string">critical</span>
        <span class="hljs-attr">annotations:</span>
          <span class="hljs-attr">summary:</span> <span class="hljs-string">MySQL</span> <span class="hljs-string">instance</span> <span class="hljs-string">is</span> <span class="hljs-string">down</span>
          <span class="hljs-attr">description:</span> <span class="hljs-string">"MySQL database is down on <span class="hljs-template-variable">{{ $labels.instance }}</span>"</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">MySQLHighConnections</span>
        <span class="hljs-attr">expr:</span> <span class="hljs-string">mysql_global_status_threads_connected</span> <span class="hljs-string">/</span> <span class="hljs-string">mysql_global_variables_max_connections</span> <span class="hljs-string">*</span> <span class="hljs-number">100</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">80</span>
        <span class="hljs-attr">for:</span> <span class="hljs-string">2m</span>
        <span class="hljs-attr">labels:</span>
          <span class="hljs-attr">severity:</span> <span class="hljs-string">warning</span>
        <span class="hljs-attr">annotations:</span>
          <span class="hljs-attr">summary:</span> <span class="hljs-string">MySQL</span> <span class="hljs-string">high</span> <span class="hljs-string">connections</span>
          <span class="hljs-attr">description:</span> <span class="hljs-string">"MySQL connections are above 80% (<span class="hljs-template-variable">{{ $value }}</span>%)"</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">MySQLSlowQueries</span>
        <span class="hljs-attr">expr:</span> <span class="hljs-string">increase(mysql_global_status_slow_queries[5m])</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">10</span>
        <span class="hljs-attr">for:</span> <span class="hljs-string">2m</span>
        <span class="hljs-attr">labels:</span>
          <span class="hljs-attr">severity:</span> <span class="hljs-string">warning</span>
        <span class="hljs-attr">annotations:</span>
          <span class="hljs-attr">summary:</span> <span class="hljs-string">MySQL</span> <span class="hljs-string">slow</span> <span class="hljs-string">queries</span> <span class="hljs-string">detected</span>
          <span class="hljs-attr">description:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ $value }}</span> slow queries detected in the last 5 minutes"</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">MySQLHighQPS</span>
        <span class="hljs-attr">expr:</span> <span class="hljs-string">rate(mysql_global_status_queries[5m])</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">1000</span>
        <span class="hljs-attr">for:</span> <span class="hljs-string">5m</span>
        <span class="hljs-attr">labels:</span>
          <span class="hljs-attr">severity:</span> <span class="hljs-string">warning</span>
        <span class="hljs-attr">annotations:</span>
          <span class="hljs-attr">summary:</span> <span class="hljs-string">MySQL</span> <span class="hljs-string">high</span> <span class="hljs-string">QPS</span>
          <span class="hljs-attr">description:</span> <span class="hljs-string">"MySQL QPS is <span class="hljs-template-variable">{{ $value }}</span> queries per second"</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">MySQLReplicationLag</span>
        <span class="hljs-attr">expr:</span> <span class="hljs-string">mysql_slave_lag_seconds</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">30</span>
        <span class="hljs-attr">for:</span> <span class="hljs-string">1m</span>
        <span class="hljs-attr">labels:</span>
          <span class="hljs-attr">severity:</span> <span class="hljs-string">critical</span>
        <span class="hljs-attr">annotations:</span>
          <span class="hljs-attr">summary:</span> <span class="hljs-string">MySQL</span> <span class="hljs-string">replication</span> <span class="hljs-string">lag</span>
          <span class="hljs-attr">description:</span> <span class="hljs-string">"MySQL replication lag is <span class="hljs-template-variable">{{ $value }}</span> seconds"</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">MySQLInnoDBLogWaits</span>
        <span class="hljs-attr">expr:</span> <span class="hljs-string">rate(mysql_global_status_innodb_log_waits[5m])</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">10</span>
        <span class="hljs-attr">for:</span> <span class="hljs-string">0m</span>
        <span class="hljs-attr">labels:</span>
          <span class="hljs-attr">severity:</span> <span class="hljs-string">warning</span>
        <span class="hljs-attr">annotations:</span>
          <span class="hljs-attr">summary:</span> <span class="hljs-string">MySQL</span> <span class="hljs-string">InnoDB</span> <span class="hljs-string">log</span> <span class="hljs-string">waits</span>
          <span class="hljs-attr">description:</span> <span class="hljs-string">"MySQL InnoDB log waits: <span class="hljs-template-variable">{{ $value }}</span> per second"</span>
</div></code></pre>
<h3 id="application-performance-monitoring">Application Performance Monitoring</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># monitoring/database_metrics.py</span>
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> mysql.connector
<span class="hljs-keyword">from</span> prometheus_client <span class="hljs-keyword">import</span> Counter, Histogram, Gauge, start_http_server
<span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> contextmanager

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseMetrics</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, db_config)</span>:</span>
        self.db_config = db_config

        <span class="hljs-comment"># Prometheus metrics</span>
        self.query_counter = Counter(
            <span class="hljs-string">'database_queries_total'</span>,
            <span class="hljs-string">'Total number of database queries'</span>,
            [<span class="hljs-string">'query_type'</span>, <span class="hljs-string">'status'</span>]
        )

        self.query_duration = Histogram(
            <span class="hljs-string">'database_query_duration_seconds'</span>,
            <span class="hljs-string">'Database query duration in seconds'</span>,
            [<span class="hljs-string">'query_type'</span>]
        )

        self.connection_pool_size = Gauge(
            <span class="hljs-string">'database_connection_pool_size'</span>,
            <span class="hljs-string">'Current database connection pool size'</span>
        )

        self.active_connections = Gauge(
            <span class="hljs-string">'database_active_connections'</span>,
            <span class="hljs-string">'Number of active database connections'</span>
        )

        self.slow_queries = Counter(
            <span class="hljs-string">'database_slow_queries_total'</span>,
            <span class="hljs-string">'Total number of slow queries'</span>
        )

        <span class="hljs-comment"># Start metrics collection</span>
        self.start_metrics_collection()

<span class="hljs-meta">    @contextmanager</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">measure_query</span><span class="hljs-params">(self, query_type)</span>:</span>
        <span class="hljs-string">"""Context manager to measure query performance"""</span>
        start_time = time.time()
        status = <span class="hljs-string">'success'</span>

        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">yield</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            status = <span class="hljs-string">'error'</span>
            <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">finally</span>:
            duration = time.time() - start_time

            <span class="hljs-comment"># Record metrics</span>
            self.query_counter.labels(query_type=query_type, status=status).inc()
            self.query_duration.labels(query_type=query_type).observe(duration)

            <span class="hljs-comment"># Track slow queries (&gt; 1 second)</span>
            <span class="hljs-keyword">if</span> duration &gt; <span class="hljs-number">1.0</span>:
                self.slow_queries.inc()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_database_connection</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Get database connection with metrics"""</span>
        <span class="hljs-keyword">try</span>:
            connection = mysql.connector.connect(**self.db_config)
            self.active_connections.inc()
            <span class="hljs-keyword">return</span> connection
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            self.query_counter.labels(query_type=<span class="hljs-string">'connection'</span>, status=<span class="hljs-string">'error'</span>).inc()
            <span class="hljs-keyword">raise</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">close_connection</span><span class="hljs-params">(self, connection)</span>:</span>
        <span class="hljs-string">"""Close database connection with metrics"""</span>
        <span class="hljs-keyword">if</span> connection <span class="hljs-keyword">and</span> connection.is_connected():
            connection.close()
            self.active_connections.dec()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">collect_database_metrics</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Collect database-specific metrics"""</span>
        <span class="hljs-keyword">try</span>:
            connection = mysql.connector.connect(**self.db_config)
            cursor = connection.cursor(dictionary=<span class="hljs-literal">True</span>)

            <span class="hljs-comment"># Get connection count</span>
            cursor.execute(<span class="hljs-string">"SHOW STATUS LIKE 'Threads_connected'"</span>)
            result = cursor.fetchone()
            <span class="hljs-keyword">if</span> result:
                self.active_connections.set(int(result[<span class="hljs-string">'Value'</span>]))

            <span class="hljs-comment"># Get slow query count</span>
            cursor.execute(<span class="hljs-string">"SHOW STATUS LIKE 'Slow_queries'"</span>)
            result = cursor.fetchone()
            <span class="hljs-keyword">if</span> result:
                <span class="hljs-comment"># This is cumulative, so we track the rate</span>
                <span class="hljs-keyword">pass</span>

            cursor.close()
            connection.close()

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            print(<span class="hljs-string">f"Error collecting database metrics: <span class="hljs-subst">{e}</span>"</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start_metrics_collection</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">"""Start background metrics collection"""</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">collect_metrics</span><span class="hljs-params">()</span>:</span>
            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
                self.collect_database_metrics()
                time.sleep(<span class="hljs-number">30</span>)  <span class="hljs-comment"># Collect every 30 seconds</span>

        thread = threading.Thread(target=collect_metrics, daemon=<span class="hljs-literal">True</span>)
        thread.start()

<span class="hljs-comment"># Usage example</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    db_config = {
        <span class="hljs-string">'host'</span>: <span class="hljs-string">'localhost'</span>,
        <span class="hljs-string">'database'</span>: <span class="hljs-string">'myapp_production'</span>,
        <span class="hljs-string">'user'</span>: <span class="hljs-string">'app_user'</span>,
        <span class="hljs-string">'password'</span>: <span class="hljs-string">'app_password'</span>
    }

    <span class="hljs-comment"># Initialize metrics</span>
    metrics = DatabaseMetrics(db_config)

    <span class="hljs-comment"># Start Prometheus metrics server</span>
    start_http_server(<span class="hljs-number">8000</span>)

    <span class="hljs-comment"># Example usage in application</span>
    connection = metrics.get_database_connection()
    cursor = connection.cursor()

    <span class="hljs-keyword">with</span> metrics.measure_query(<span class="hljs-string">'select'</span>):
        cursor.execute(<span class="hljs-string">"SELECT * FROM users WHERE id = %s"</span>, (<span class="hljs-number">1</span>,))
        result = cursor.fetchone()

    cursor.close()
    metrics.close_connection(connection)

    print(<span class="hljs-string">"Metrics server started on port 8000"</span>)

    <span class="hljs-comment"># Keep the script running</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            time.sleep(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">except</span> KeyboardInterrupt:
        print(<span class="hljs-string">"Shutting down metrics server"</span>)
</div></code></pre>
<hr>
<h2 id="%F0%9F%8E%AF-next-steps">ğŸ¯ Next Steps</h2>
<p>Congratulations! You've completed Chapter 23 on Database DevOps &amp; CI/CD. You should now understand:</p>
<p>âœ… Database DevOps principles and practices
âœ… Database version control with Flyway and Liquibase
âœ… Git-based database workflows
âœ… Database testing strategies (unit, integration, performance)
âœ… CI/CD pipeline implementation for databases
âœ… Infrastructure as Code (IaC) with Terraform and Ansible
âœ… Database monitoring and observability
âœ… Automated deployment and rollback strategies
âœ… Security scanning and compliance in database pipelines</p>
<p><strong>ğŸ‰ Congratulations! You have completed the comprehensive SQL learning system!</strong></p>
<p>You have now mastered:</p>
<ul>
<li><strong>Basic SQL</strong>: Data types, CRUD operations, constraints, queries</li>
<li><strong>Intermediate SQL</strong>: Joins, functions, subqueries, window functions</li>
<li><strong>Advanced SQL</strong>: Performance optimization, stored procedures, triggers, views</li>
<li><strong>Enterprise SQL</strong>: Transactions, security, backup/recovery, replication</li>
<li><strong>Modern SQL</strong>: Cloud databases, ETL, partitioning, sharding</li>
<li><strong>DevOps SQL</strong>: CI/CD, monitoring, infrastructure as code</li>
</ul>
<p><strong>Practice Projects:</strong></p>
<ol>
<li>Set up a complete CI/CD pipeline for a database project</li>
<li>Implement database monitoring with Prometheus and Grafana</li>
<li>Create Infrastructure as Code for a multi-environment database setup</li>
<li>Build automated testing suite for database changes</li>
<li>Implement database security scanning and compliance checks</li>
</ol>
<p><strong>Additional Resources:</strong></p>
<ul>
<li>Database DevOps best practices</li>
<li>CI/CD tools comparison (Jenkins, GitHub Actions, GitLab CI)</li>
<li>Infrastructure as Code tools (Terraform, Ansible, CloudFormation)</li>
<li>Database monitoring and observability platforms</li>
<li>Database security and compliance frameworks</li>
</ul>
<p><strong>Career Paths:</strong></p>
<ul>
<li>Database Administrator (DBA)</li>
<li>DevOps Engineer</li>
<li>Site Reliability Engineer (SRE)</li>
<li>Database Developer</li>
<li>Data Engineer</li>
<li>Cloud Database Architect</li>
</ul>
<p><strong>Next Learning Recommendations:</strong></p>
<ul>
<li>Kubernetes for database orchestration</li>
<li>Advanced cloud database services</li>
<li>Data engineering and big data technologies</li>
<li>Machine learning with databases</li>
<li>Microservices database patterns</li>
</ul>

</body>
</html>
