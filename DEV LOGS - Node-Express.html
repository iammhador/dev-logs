<!DOCTYPE html>
<html>
<head>
<title>GIT LOGS - Node-Express.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="nodejs-and-expressjs-complete-tutorial-series">Node.js and Express.js Complete Tutorial Series</h1>
<p>A comprehensive tutorial series covering Node.js fundamentals and Express.js web development, from basic concepts to advanced topics including testing, authentication, and deployment.</p>
<h2 id="%F0%9F%93%9A-tutorial-contents">📚 Tutorial Contents</h2>
<h3 id="part-1-nodejs-fundamentals">Part 1: Node.js Fundamentals</h3>
<ol>
<li><strong><a href="01-nodejs-fundamentals.md">Node.js Fundamentals</a></strong> - Introduction to Node.js, its architecture, and core concepts</li>
<li><strong><a href="02-nodejs-installation-and-basics.md">Node.js Installation and Basics</a></strong> - Setting up Node.js development environment</li>
<li><strong><a href="03-npm-package-management.md">NPM Package Management</a></strong> - Managing dependencies and packages</li>
<li><strong><a href="04-nodejs-core-modules.md">Node.js Core Modules</a></strong> - Built-in modules and their usage</li>
<li><strong><a href="05-creating-http-servers.md">Creating HTTP Servers</a></strong> - Building basic HTTP servers with Node.js</li>
</ol>
<h3 id="part-2-expressjs-framework">Part 2: Express.js Framework</h3>
<ol start="6">
<li><strong><a href="06-express-introduction.md">Express Introduction</a></strong> - Getting started with Express.js framework</li>
<li><strong><a href="07-request-response-objects.md">Request and Response Objects</a></strong> - Understanding Express req and res objects</li>
<li><strong><a href="08-serving-static-files.md">Serving Static Files</a></strong> - Handling static assets in Express</li>
<li><strong><a href="09-environment-variables-dotenv.md">Environment Variables with dotenv</a></strong> - Managing configuration and secrets</li>
<li><strong><a href="10-express-router-modular-routes.md">Express Router and Modular Routes</a></strong> - Organizing routes and middleware</li>
</ol>
<h3 id="part-3-advanced-expressjs">Part 3: Advanced Express.js</h3>
<ol start="11">
<li><strong><a href="11-template-engines-ejs-pug.md">Template Engines (EJS &amp; Pug)</a></strong> - Server-side rendering with template engines</li>
<li><strong><a href="12-restful-api-design-principles.md">RESTful API Design Principles</a></strong> - Best practices for API design</li>
<li><strong><a href="13-crud-operations-express.md">CRUD Operations in Express</a></strong> - Building complete CRUD functionality</li>
<li><strong><a href="14-middleware-express.md">Middleware in Express</a></strong> - Custom and third-party middleware</li>
<li><strong><a href="15-database-integration-mongodb-mongoose.md">Database Integration (MongoDB &amp; Mongoose)</a></strong> - Working with databases</li>
</ol>
<h3 id="part-4-security-and-advanced-features">Part 4: Security and Advanced Features</h3>
<ol start="16">
<li><strong><a href="16-authentication-authorization.md">Authentication and Authorization</a></strong> - User authentication, JWT, sessions, and security</li>
<li><strong><a href="17-file-upload-handling.md">File Upload Handling</a></strong> - Managing file uploads and storage</li>
<li><strong><a href="18-testing-express-applications.md">Testing Express Applications</a></strong> - Comprehensive testing strategies and implementation</li>
</ol>
<h2 id="%F0%9F%8E%AF-learning-objectives">🎯 Learning Objectives</h2>
<p>By completing this tutorial series, you will:</p>
<ul>
<li>✅ Understand Node.js fundamentals and asynchronous programming</li>
<li>✅ Master Express.js framework for web development</li>
<li>✅ Build RESTful APIs with proper design principles</li>
<li>✅ Implement authentication and authorization systems</li>
<li>✅ Work with databases using MongoDB and Mongoose</li>
<li>✅ Handle file uploads and static assets</li>
<li>✅ Write comprehensive tests for your applications</li>
<li>✅ Apply security best practices</li>
<li>✅ Structure and organize large-scale applications</li>
</ul>
<h2 id="%F0%9F%9B%A0%EF%B8%8F-prerequisites">🛠️ Prerequisites</h2>
<ul>
<li>Basic knowledge of JavaScript (ES6+)</li>
<li>Understanding of web development concepts</li>
<li>Familiarity with command line/terminal</li>
<li>Basic understanding of HTTP protocol</li>
</ul>
<h2 id="%F0%9F%9A%80-getting-started">🚀 Getting Started</h2>
<ol>
<li><strong>Start with the fundamentals</strong>: Begin with <a href="01-nodejs-fundamentals.md">Node.js Fundamentals</a></li>
<li><strong>Follow the sequence</strong>: Each chapter builds upon previous concepts</li>
<li><strong>Practice along</strong>: Code examples are provided throughout</li>
<li><strong>Build projects</strong>: Apply concepts by building real applications</li>
</ol>
<h2 id="%F0%9F%93%8B-what-youll-build">📋 What You'll Build</h2>
<p>Throughout this series, you'll build:</p>
<ul>
<li><strong>Basic HTTP servers</strong> with Node.js core modules</li>
<li><strong>RESTful APIs</strong> with Express.js</li>
<li><strong>User authentication system</strong> with JWT and sessions</li>
<li><strong>File upload functionality</strong> with validation and storage</li>
<li><strong>Database-driven applications</strong> with MongoDB</li>
<li><strong>Comprehensive test suites</strong> with Jest and Supertest</li>
<li><strong>Production-ready applications</strong> with security and best practices</li>
</ul>
<h2 id="%F0%9F%94%A7-technologies-covered">🔧 Technologies Covered</h2>
<h3 id="core-technologies">Core Technologies</h3>
<ul>
<li><strong>Node.js</strong> - JavaScript runtime environment</li>
<li><strong>Express.js</strong> - Web application framework</li>
<li><strong>MongoDB</strong> - NoSQL database</li>
<li><strong>Mongoose</strong> - MongoDB object modeling</li>
</ul>
<h3 id="development-tools">Development Tools</h3>
<ul>
<li><strong>NPM</strong> - Package management</li>
<li><strong>dotenv</strong> - Environment variable management</li>
<li><strong>Jest</strong> - Testing framework</li>
<li><strong>Supertest</strong> - HTTP testing</li>
<li><strong>Multer</strong> - File upload handling</li>
<li><strong>bcrypt</strong> - Password hashing</li>
<li><strong>jsonwebtoken</strong> - JWT implementation</li>
</ul>
<h3 id="template-engines">Template Engines</h3>
<ul>
<li><strong>EJS</strong> - Embedded JavaScript templates</li>
<li><strong>Pug</strong> - Clean, whitespace-sensitive syntax</li>
</ul>
<h2 id="%F0%9F%93%96-how-to-use-this-tutorial">📖 How to Use This Tutorial</h2>
<h3 id="for-beginners">For Beginners</h3>
<ol>
<li>Start from Chapter 1 and progress sequentially</li>
<li>Complete all code examples</li>
<li>Build the suggested projects</li>
<li>Review concepts before moving to the next chapter</li>
</ol>
<h3 id="for-intermediate-developers">For Intermediate Developers</h3>
<ol>
<li>Review the table of contents</li>
<li>Jump to specific topics of interest</li>
<li>Use as a reference guide</li>
<li>Focus on advanced chapters (16-18)</li>
</ol>
<h3 id="for-advanced-developers">For Advanced Developers</h3>
<ol>
<li>Use as a comprehensive reference</li>
<li>Focus on best practices and patterns</li>
<li>Implement testing strategies</li>
<li>Apply security considerations</li>
</ol>
<h2 id="%F0%9F%8E%93-learning-path-recommendations">🎓 Learning Path Recommendations</h2>
<h3 id="backend-developer-path">Backend Developer Path</h3>
<ol>
<li>Node.js Fundamentals (Chapters 1-5)</li>
<li>Express.js Basics (Chapters 6-10)</li>
<li>Database Integration (Chapter 15)</li>
<li>Authentication (Chapter 16)</li>
<li>Testing (Chapter 18)</li>
</ol>
<h3 id="full-stack-developer-path">Full-Stack Developer Path</h3>
<ol>
<li>Complete all chapters sequentially</li>
<li>Focus on template engines (Chapter 11)</li>
<li>Build complete applications</li>
<li>Implement both API and web interfaces</li>
</ol>
<h3 id="api-developer-path">API Developer Path</h3>
<ol>
<li>Node.js Fundamentals (Chapters 1-5)</li>
<li>Express.js and REST APIs (Chapters 6, 12-15)</li>
<li>Authentication and Security (Chapter 16)</li>
<li>File Handling (Chapter 17)</li>
<li>Testing (Chapter 18)</li>
</ol>
<h2 id="%F0%9F%93%9D-additional-resources">📝 Additional Resources</h2>
<ul>
<li><strong><a href="GIT-LOGS-Node-Express.md">Git Logs</a></strong> - Version control best practices</li>
<li><strong>Official Documentation</strong>:
<ul>
<li><a href="https://nodejs.org/docs/">Node.js Documentation</a></li>
<li><a href="https://expressjs.com/">Express.js Documentation</a></li>
<li><a href="https://docs.mongodb.com/">MongoDB Documentation</a></li>
<li><a href="https://mongoosejs.com/docs/">Mongoose Documentation</a></li>
</ul>
</li>
</ul>
<h2 id="%F0%9F%A4%9D-contributing">🤝 Contributing</h2>
<p>This tutorial series is designed to be comprehensive and up-to-date. If you find any issues or have suggestions for improvements:</p>
<ol>
<li>Review the content thoroughly</li>
<li>Check for outdated information</li>
<li>Suggest additional topics or examples</li>
<li>Report any errors or inconsistencies</li>
</ol>
<h2 id="%F0%9F%93%84-license">📄 License</h2>
<p>This tutorial series is provided for educational purposes. Feel free to use the code examples and concepts in your own projects.</p>
<h2 id="%F0%9F%94%84-updates-and-maintenance">🔄 Updates and Maintenance</h2>
<p>This tutorial series is regularly updated to reflect:</p>
<ul>
<li>Latest Node.js and Express.js versions</li>
<li>Current best practices</li>
<li>New security considerations</li>
<li>Updated dependencies and tools</li>
</ul>
<hr>
<p><strong>Happy Learning! 🚀</strong></p>
<p>Start your journey with <a href="01-nodejs-fundamentals.md">Node.js Fundamentals</a> and build amazing web applications with Node.js and Express.js!</p>
<h1 id="nodejs-fundamentals-understanding-the-runtime">Node.js Fundamentals: Understanding the Runtime</h1>
<h2 id="overview">Overview</h2>
<p>Node.js is a JavaScript runtime built on Chrome's V8 JavaScript engine that allows you to run JavaScript on the server side. Unlike traditional server-side languages, Node.js uses an event-driven, non-blocking I/O model that makes it lightweight and efficient for building scalable network applications.</p>
<h2 id="key-concepts">Key Concepts</h2>
<h3 id="what-is-nodejs">What is Node.js?</h3>
<p>Node.js is not a programming language or a framework – it's a runtime environment that executes JavaScript code outside of a web browser. It was created by Ryan Dahl in 2009 to enable JavaScript to be used for server-side development.</p>
<h3 id="the-v8-engine">The V8 Engine</h3>
<p>Node.js uses Google's V8 JavaScript engine, the same engine that powers Google Chrome. V8 compiles JavaScript directly to native machine code, making it extremely fast. This engine:</p>
<ul>
<li>Compiles JavaScript to machine code</li>
<li>Handles memory allocation and garbage collection</li>
<li>Provides the JavaScript runtime environment</li>
</ul>
<h3 id="the-event-loop">The Event Loop</h3>
<p>The event loop is the heart of Node.js's non-blocking I/O model. It's a single-threaded loop that handles all asynchronous operations.</p>
<pre class="hljs"><code><div>┌───────────────────────────┐
┌─&gt;│           timers          │  ← setTimeout, setInterval
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │     pending callbacks     │  ← I/O callbacks
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │       idle, prepare       │  ← internal use
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │           poll            │  ← new I/O events
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │           check           │  ← setImmediate
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
└──┤      close callbacks      │  ← close events
   └───────────────────────────┘
</div></code></pre>
<h3 id="non-blocking-io">Non-blocking I/O</h3>
<p>Traditional server models create a new thread for each request, which can be resource-intensive. Node.js uses a single thread with an event loop to handle multiple concurrent operations without blocking.</p>
<h2 id="example-code">Example Code</h2>
<h3 id="basic-nodejs-script">Basic Node.js Script</h3>
<p>Create a file called <code>hello.js</code>:</p>
<pre class="hljs"><code><div><span class="hljs-comment">// hello.js</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Hello, Node.js!"</span>);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Current directory:"</span>, process.cwd());
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Node.js version:"</span>, process.version);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Platform:"</span>, process.platform);
</div></code></pre>
<p>Run it with:</p>
<pre class="hljs"><code><div>node hello.js
</div></code></pre>
<h3 id="demonstrating-the-event-loop">Demonstrating the Event Loop</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// event-loop-demo.js</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Start"</span>);

<span class="hljs-comment">// Immediate execution</span>
setImmediate(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"setImmediate"</span>);
});

<span class="hljs-comment">// Timer</span>
setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"setTimeout"</span>);
}, <span class="hljs-number">0</span>);

<span class="hljs-comment">// Process next tick (highest priority)</span>
process.nextTick(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"nextTick"</span>);
});

<span class="hljs-comment">// Promise (microtask)</span>
<span class="hljs-built_in">Promise</span>.resolve().then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Promise"</span>);
});

<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"End"</span>);

<span class="hljs-comment">// Output order:</span>
<span class="hljs-comment">// Start</span>
<span class="hljs-comment">// End</span>
<span class="hljs-comment">// nextTick</span>
<span class="hljs-comment">// Promise</span>
<span class="hljs-comment">// setTimeout</span>
<span class="hljs-comment">// setImmediate</span>
</div></code></pre>
<h3 id="blocking-vs-non-blocking-example">Blocking vs Non-blocking Example</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// blocking-example.js</span>
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);

<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Start"</span>);

<span class="hljs-comment">// Blocking (synchronous) - avoid in production</span>
<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">const</span> data = fs.readFileSync(<span class="hljs-string">"package.json"</span>, <span class="hljs-string">"utf8"</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"File read synchronously"</span>);
} <span class="hljs-keyword">catch</span> (err) {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"File not found (sync)"</span>);
}

<span class="hljs-comment">// Non-blocking (asynchronous) - preferred</span>
fs.readFile(<span class="hljs-string">"package.json"</span>, <span class="hljs-string">"utf8"</span>, (err, data) =&gt; {
  <span class="hljs-keyword">if</span> (err) {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"File not found (async)"</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"File read asynchronously"</span>);
  }
});

<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"End"</span>);

<span class="hljs-comment">// Output:</span>
<span class="hljs-comment">// Start</span>
<span class="hljs-comment">// File read synchronously (or error)</span>
<span class="hljs-comment">// End</span>
<span class="hljs-comment">// File read asynchronously (or error)</span>
</div></code></pre>
<h2 id="real-world-use-case">Real-World Use Case</h2>
<h3 id="cpu-intensive-vs-io-intensive-tasks">CPU-Intensive vs I/O-Intensive Tasks</h3>
<p>Node.js excels at I/O-intensive applications but struggles with CPU-intensive tasks:</p>
<pre class="hljs"><code><div><span class="hljs-comment">// io-intensive.js - Good for Node.js</span>
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">"http"</span>);

<span class="hljs-keyword">const</span> server = http.createServer(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-comment">// Multiple file operations can happen concurrently</span>
  fs.readFile(<span class="hljs-string">"data1.txt"</span>, (err, data1) =&gt; {
    fs.readFile(<span class="hljs-string">"data2.txt"</span>, (err, data2) =&gt; {
      fs.readFile(<span class="hljs-string">"data3.txt"</span>, (err, data3) =&gt; {
        res.end(<span class="hljs-string">"All files processed"</span>);
      });
    });
  });
});

server.listen(<span class="hljs-number">3000</span>);
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">// cpu-intensive.js - Not ideal for Node.js</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fibonacci</span>(<span class="hljs-params">n</span>) </span>{
  <span class="hljs-keyword">if</span> (n &lt; <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> n;
  <span class="hljs-keyword">return</span> fibonacci(n - <span class="hljs-number">1</span>) + fibonacci(n - <span class="hljs-number">2</span>);
}

<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Start"</span>);
<span class="hljs-keyword">const</span> result = fibonacci(<span class="hljs-number">40</span>); <span class="hljs-comment">// This blocks everything</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Result:"</span>, result);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"End"</span>);
</div></code></pre>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-always-use-asynchronous-operations">1. Always Use Asynchronous Operations</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// ❌ Bad - blocks the event loop</span>
<span class="hljs-keyword">const</span> data = fs.readFileSync(<span class="hljs-string">"file.txt"</span>);

<span class="hljs-comment">// ✅ Good - non-blocking</span>
fs.readFile(<span class="hljs-string">"file.txt"</span>, (err, data) =&gt; {
  <span class="hljs-comment">// Handle the data</span>
});

<span class="hljs-comment">// ✅ Even better - using promises/async-await</span>
<span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> fs.promises.readFile(<span class="hljs-string">"file.txt"</span>);
</div></code></pre>
<h3 id="2-handle-errors-properly">2. Handle Errors Properly</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// ❌ Bad - unhandled errors can crash the app</span>
fs.readFile(<span class="hljs-string">"file.txt"</span>, (err, data) =&gt; {
  <span class="hljs-built_in">console</span>.log(data.toString());
});

<span class="hljs-comment">// ✅ Good - always handle errors</span>
fs.readFile(<span class="hljs-string">"file.txt"</span>, (err, data) =&gt; {
  <span class="hljs-keyword">if</span> (err) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error reading file:"</span>, err.message);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-built_in">console</span>.log(data.toString());
});
</div></code></pre>
<h3 id="3-use-environment-variables">3. Use Environment Variables</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// config.js</span>
<span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-attr">port</span>: process.env.PORT || <span class="hljs-number">3000</span>,
  <span class="hljs-attr">nodeEnv</span>: process.env.NODE_ENV || <span class="hljs-string">"development"</span>,
  <span class="hljs-attr">dbUrl</span>: process.env.DATABASE_URL || <span class="hljs-string">"mongodb://localhost:27017/myapp"</span>,
};
</div></code></pre>
<h3 id="4-understand-the-event-loop">4. Understand the Event Loop</h3>
<ul>
<li>Don't block the event loop with synchronous operations</li>
<li>Use <code>setImmediate()</code> for deferring execution</li>
<li>Use <code>process.nextTick()</code> sparingly (it has the highest priority)</li>
</ul>
<h2 id="summary">Summary</h2>
<p>Node.js revolutionizes server-side development by bringing JavaScript to the backend with its event-driven, non-blocking I/O model. Key takeaways:</p>
<ul>
<li><strong>V8 Engine</strong>: Compiles JavaScript to machine code for high performance</li>
<li><strong>Event Loop</strong>: Single-threaded loop that handles asynchronous operations</li>
<li><strong>Non-blocking I/O</strong>: Allows handling multiple operations concurrently</li>
<li><strong>Best Use Cases</strong>: I/O-intensive applications like web servers, APIs, real-time apps</li>
<li><strong>Avoid</strong>: CPU-intensive tasks that can block the event loop</li>
</ul>
<p>Understanding these fundamentals is crucial before diving into Express.js and building web applications. The event-driven nature of Node.js makes it perfect for building scalable network applications, but it requires a different mindset compared to traditional multi-threaded server environments.</p>
<p>Next, we'll explore how to install Node.js and start building our first applications.</p>
<h1 id="nodejs-installation-and-running-basic-scripts">Node.js Installation and Running Basic Scripts</h1>
<h2 id="overview">Overview</h2>
<p>Before you can start building applications with Node.js, you need to install it on your system and understand how to run JavaScript files. This chapter covers the installation process, version management, and running your first Node.js scripts.</p>
<h2 id="key-concepts">Key Concepts</h2>
<h3 id="nodejs-installation-methods">Node.js Installation Methods</h3>
<p>There are several ways to install Node.js:</p>
<ol>
<li><strong>Official Installer</strong> - Download from nodejs.org</li>
<li><strong>Package Managers</strong> - Using npm, Chocolatey (Windows), Homebrew (macOS)</li>
<li><strong>Version Managers</strong> - nvm (Node Version Manager)</li>
<li><strong>Docker</strong> - Running Node.js in containers</li>
</ol>
<h3 id="lts-vs-current-versions">LTS vs Current Versions</h3>
<ul>
<li><strong>LTS (Long Term Support)</strong>: Stable, recommended for production</li>
<li><strong>Current</strong>: Latest features, may have breaking changes</li>
</ul>
<h3 id="nodejs-repl">Node.js REPL</h3>
<p>REPL (Read-Eval-Print Loop) is an interactive shell for testing JavaScript code quickly.</p>
<h2 id="example-code">Example Code</h2>
<h3 id="installation-steps">Installation Steps</h3>
<h4 id="method-1-official-installer-recommended-for-beginners">Method 1: Official Installer (Recommended for Beginners)</h4>
<ol>
<li>Visit <a href="https://nodejs.org">nodejs.org</a></li>
<li>Download the LTS version</li>
<li>Run the installer</li>
<li>Verify installation:</li>
</ol>
<pre class="hljs"><code><div><span class="hljs-comment"># Check Node.js version</span>
node --version
<span class="hljs-comment"># or</span>
node -v

<span class="hljs-comment"># Check npm version</span>
npm --version
<span class="hljs-comment"># or</span>
npm -v
</div></code></pre>
<h4 id="method-2-using-nvm-recommended-for-developers">Method 2: Using nvm (Recommended for Developers)</h4>
<p><strong>Windows (nvm-windows):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Download and install nvm-windows from GitHub</span>
<span class="hljs-comment"># Then install Node.js</span>
nvm install lts
nvm use lts
</div></code></pre>
<p><strong>macOS/Linux:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Install nvm</span>
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

<span class="hljs-comment"># Restart terminal or run:</span>
<span class="hljs-built_in">source</span> ~/.bashrc

<span class="hljs-comment"># Install latest LTS</span>
nvm install --lts
nvm use --lts

<span class="hljs-comment"># List installed versions</span>
nvm list

<span class="hljs-comment"># Switch between versions</span>
nvm use 18.17.0
</div></code></pre>
<h3 id="your-first-nodejs-script">Your First Node.js Script</h3>
<p>Create a file called <code>first-script.js</code>:</p>
<pre class="hljs"><code><div><span class="hljs-comment">// first-script.js</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Welcome to Node.js!"</span>);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Today is:"</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toLocaleDateString());
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Current working directory:"</span>, process.cwd());

<span class="hljs-comment">// Access command line arguments</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Command line arguments:"</span>, process.argv);

<span class="hljs-comment">// Environment variables</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Node environment:"</span>, process.env.NODE_ENV || <span class="hljs-string">"development"</span>);
</div></code></pre>
<p>Run it:</p>
<pre class="hljs"><code><div>node first-script.js
</div></code></pre>
<h3 id="working-with-command-line-arguments">Working with Command Line Arguments</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// args-demo.js</span>
<span class="hljs-keyword">const</span> args = process.argv.slice(<span class="hljs-number">2</span>); <span class="hljs-comment">// Remove 'node' and script name</span>

<span class="hljs-keyword">if</span> (args.length === <span class="hljs-number">0</span>) {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"No arguments provided!"</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Usage: node args-demo.js &lt;name&gt; &lt;age&gt;"</span>);
  process.exit(<span class="hljs-number">1</span>);
}

<span class="hljs-keyword">const</span> [name, age] = args;
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Hello <span class="hljs-subst">${name}</span>, you are <span class="hljs-subst">${age}</span> years old!`</span>);

<span class="hljs-comment">// Handle optional arguments</span>
<span class="hljs-keyword">if</span> (args[<span class="hljs-number">2</span>]) {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Additional info: <span class="hljs-subst">${args[<span class="hljs-number">2</span>]}</span>`</span>);
}
</div></code></pre>
<p>Run with arguments:</p>
<pre class="hljs"><code><div>node args-demo.js John 25 <span class="hljs-string">"Software Developer"</span>
</div></code></pre>
<h3 id="using-the-nodejs-repl">Using the Node.js REPL</h3>
<p>Start the REPL by typing <code>node</code> without any arguments:</p>
<pre class="hljs"><code><div>node
</div></code></pre>
<p>Then you can run JavaScript interactively:</p>
<pre class="hljs"><code><div>&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Hello from REPL!'</span>);
Hello <span class="hljs-keyword">from</span> REPL!
<span class="hljs-literal">undefined</span>

&gt; <span class="hljs-keyword">const</span> greeting = <span class="hljs-string">'Hello World'</span>;
<span class="hljs-literal">undefined</span>

&gt; greeting
<span class="hljs-string">'Hello World'</span>

&gt; <span class="hljs-built_in">Math</span>.random()
<span class="hljs-number">0.8394729834729834</span>

&gt; .help  <span class="hljs-comment">// Show REPL commands</span>
&gt; .exit  <span class="hljs-comment">// Exit REPL (or Ctrl+C twice)</span>
</div></code></pre>
<h3 id="useful-repl-commands">Useful REPL Commands</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// In REPL:</span>
.help     <span class="hljs-comment">// Show help</span>
.break    <span class="hljs-comment">// Break out of multi-line expression</span>
.clear    <span class="hljs-comment">// Clear the context</span>
.exit     <span class="hljs-comment">// Exit REPL</span>
.save filename    <span class="hljs-comment">// Save session to file</span>
.load filename    <span class="hljs-comment">// Load file into session</span>
</div></code></pre>
<h3 id="creating-a-simple-calculator">Creating a Simple Calculator</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// calculator.js</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">a, b</span>) </span>{
  <span class="hljs-keyword">return</span> a + b;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">subtract</span>(<span class="hljs-params">a, b</span>) </span>{
  <span class="hljs-keyword">return</span> a - b;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">multiply</span>(<span class="hljs-params">a, b</span>) </span>{
  <span class="hljs-keyword">return</span> a * b;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">divide</span>(<span class="hljs-params">a, b</span>) </span>{
  <span class="hljs-keyword">if</span> (b === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Division by zero is not allowed"</span>);
  }
  <span class="hljs-keyword">return</span> a / b;
}

<span class="hljs-comment">// Get command line arguments</span>
<span class="hljs-keyword">const</span> [operation, num1, num2] = process.argv.slice(<span class="hljs-number">2</span>);

<span class="hljs-keyword">if</span> (!operation || !num1 || !num2) {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Usage: node calculator.js &lt;operation&gt; &lt;num1&gt; &lt;num2&gt;"</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Operations: add, subtract, multiply, divide"</span>);
  process.exit(<span class="hljs-number">1</span>);
}

<span class="hljs-keyword">const</span> a = <span class="hljs-built_in">parseFloat</span>(num1);
<span class="hljs-keyword">const</span> b = <span class="hljs-built_in">parseFloat</span>(num2);

<span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(a) || <span class="hljs-built_in">isNaN</span>(b)) {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Please provide valid numbers"</span>);
  process.exit(<span class="hljs-number">1</span>);
}

<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">let</span> result;

  <span class="hljs-keyword">switch</span> (operation.toLowerCase()) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"add"</span>:
      result = add(a, b);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">"subtract"</span>:
      result = subtract(a, b);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">"multiply"</span>:
      result = multiply(a, b);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">"divide"</span>:
      result = divide(a, b);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Unknown operation:"</span>, operation);
      process.exit(<span class="hljs-number">1</span>);
  }

  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${a}</span> <span class="hljs-subst">${operation}</span> <span class="hljs-subst">${b}</span> = <span class="hljs-subst">${result}</span>`</span>);
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error:"</span>, error.message);
  process.exit(<span class="hljs-number">1</span>);
}
</div></code></pre>
<p>Test the calculator:</p>
<pre class="hljs"><code><div>node calculator.js add 10 5        <span class="hljs-comment"># Output: 10 add 5 = 15</span>
node calculator.js multiply 7 8    <span class="hljs-comment"># Output: 7 multiply 8 = 56</span>
node calculator.js divide 10 0     <span class="hljs-comment"># Output: Error: Division by zero is not allowed</span>
</div></code></pre>
<h2 id="real-world-use-case">Real-World Use Case</h2>
<h3 id="file-processing-script">File Processing Script</h3>
<p>Create a script that processes text files:</p>
<pre class="hljs"><code><div><span class="hljs-comment">// file-processor.js</span>
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processFile</span>(<span class="hljs-params">filename</span>) </span>{
  <span class="hljs-comment">// Check if file exists</span>
  <span class="hljs-keyword">if</span> (!fs.existsSync(filename)) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`File '<span class="hljs-subst">${filename}</span>' not found!`</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// Read file content</span>
    <span class="hljs-keyword">const</span> content = fs.readFileSync(filename, <span class="hljs-string">"utf8"</span>);

    <span class="hljs-comment">// Process the content</span>
    <span class="hljs-keyword">const</span> lines = content.split(<span class="hljs-string">"\n"</span>);
    <span class="hljs-keyword">const</span> wordCount = content
      .split(<span class="hljs-regexp">/\s+/</span>)
      .filter(<span class="hljs-function">(<span class="hljs-params">word</span>) =&gt;</span> word.length &gt; <span class="hljs-number">0</span>).length;
    <span class="hljs-keyword">const</span> charCount = content.length;

    <span class="hljs-comment">// Display statistics</span>
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`\n📄 File: <span class="hljs-subst">${filename}</span>`</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`📊 Statistics:`</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`   Lines: <span class="hljs-subst">${lines.length}</span>`</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`   Words: <span class="hljs-subst">${wordCount}</span>`</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`   Characters: <span class="hljs-subst">${charCount}</span>`</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`   Size: <span class="hljs-subst">${fs.statSync(filename).size}</span> bytes`</span>);

    <span class="hljs-comment">// Show first few lines</span>
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`\n📖 First 3 lines:`</span>);
    lines.slice(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>).forEach(<span class="hljs-function">(<span class="hljs-params">line, index</span>) =&gt;</span> {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`   <span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>: <span class="hljs-subst">${line}</span>`</span>);
    });
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error processing file:"</span>, error.message);
  }
}

<span class="hljs-comment">// Get filename from command line</span>
<span class="hljs-keyword">const</span> filename = process.argv[<span class="hljs-number">2</span>];

<span class="hljs-keyword">if</span> (!filename) {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Usage: node file-processor.js &lt;filename&gt;"</span>);
  process.exit(<span class="hljs-number">1</span>);
}

processFile(filename);
</div></code></pre>
<p>Create a test file and run:</p>
<pre class="hljs"><code><div><span class="hljs-built_in">echo</span> <span class="hljs-string">"Hello World\nThis is a test file\nWith multiple lines"</span> &gt; test.txt
node file-processor.js test.txt
</div></code></pre>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-version-management">1. Version Management</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Always specify Node.js version in your project</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"18.17.0"</span> &gt; .nvmrc

<span class="hljs-comment"># Team members can then use:</span>
nvm use  <span class="hljs-comment"># Automatically uses version from .nvmrc</span>
</div></code></pre>
<h3 id="2-error-handling">2. Error Handling</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// ❌ Bad - unhandled errors</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-built_in">JSON</span>.parse(userInput);

<span class="hljs-comment">// ✅ Good - proper error handling</span>
<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">const</span> result = <span class="hljs-built_in">JSON</span>.parse(userInput);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Parsed successfully:"</span>, result);
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Invalid JSON:"</span>, error.message);
  process.exit(<span class="hljs-number">1</span>);
}
</div></code></pre>
<h3 id="3-exit-codes">3. Exit Codes</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Use appropriate exit codes</span>
process.exit(<span class="hljs-number">0</span>); <span class="hljs-comment">// Success</span>
process.exit(<span class="hljs-number">1</span>); <span class="hljs-comment">// General error</span>
process.exit(<span class="hljs-number">2</span>); <span class="hljs-comment">// Misuse of shell command</span>
</div></code></pre>
<h3 id="4-environment-detection">4. Environment Detection</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// environment.js</span>
<span class="hljs-keyword">const</span> isDevelopment = process.env.NODE_ENV === <span class="hljs-string">"development"</span>;
<span class="hljs-keyword">const</span> isProduction = process.env.NODE_ENV === <span class="hljs-string">"production"</span>;
<span class="hljs-keyword">const</span> isTest = process.env.NODE_ENV === <span class="hljs-string">"test"</span>;

<span class="hljs-keyword">if</span> (isDevelopment) {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Running in development mode"</span>);
}

<span class="hljs-comment">// Set environment when running</span>
<span class="hljs-comment">// NODE_ENV=production node app.js</span>
</div></code></pre>
<h3 id="5-script-organization">5. Script Organization</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// main.js - Entry point</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// Your main logic here</span>
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Application started successfully"</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Application failed to start:"</span>, error.message);
    process.exit(<span class="hljs-number">1</span>);
  }
}

<span class="hljs-comment">// Only run if this file is executed directly</span>
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">require</span>.main === <span class="hljs-built_in">module</span>) {
  main();
}

<span class="hljs-comment">// Export for testing</span>
<span class="hljs-built_in">module</span>.exports = { main };
</div></code></pre>
<h2 id="summary">Summary</h2>
<p>Getting started with Node.js involves:</p>
<ul>
<li><strong>Installation</strong>: Use official installer for beginners, nvm for developers</li>
<li><strong>Version Management</strong>: Always use LTS for production, consider nvm for multiple projects</li>
<li><strong>Running Scripts</strong>: Use <code>node filename.js</code> to execute JavaScript files</li>
<li><strong>REPL</strong>: Interactive shell for quick testing and experimentation</li>
<li><strong>Command Line Arguments</strong>: Access via <code>process.argv</code> for dynamic scripts</li>
<li><strong>Error Handling</strong>: Always handle errors gracefully and use appropriate exit codes</li>
</ul>
<p>Key commands to remember:</p>
<pre class="hljs"><code><div>node --version          <span class="hljs-comment"># Check Node.js version</span>
node script.js          <span class="hljs-comment"># Run a script</span>
node                    <span class="hljs-comment"># Start REPL</span>
node -e <span class="hljs-string">"console.log('Hi')"</span>  <span class="hljs-comment"># Execute inline code</span>
</div></code></pre>
<p>Now that you have Node.js installed and understand the basics, you're ready to explore npm and start building more complex applications. The next chapter will cover npm fundamentals and package management.</p>
<h1 id="npm-node-package-manager-fundamentals">NPM: Node Package Manager Fundamentals</h1>
<h2 id="overview">Overview</h2>
<p>npm (Node Package Manager) is the default package manager for Node.js and the world's largest software registry. It allows you to install, share, and manage dependencies for your Node.js projects. Understanding npm is crucial for modern JavaScript development.</p>
<h2 id="key-concepts">Key Concepts</h2>
<h3 id="what-is-npm">What is npm?</h3>
<p>npm serves three main purposes:</p>
<ol>
<li><strong>Package Registry</strong>: A massive database of JavaScript packages</li>
<li><strong>Command Line Tool</strong>: For installing and managing packages</li>
<li><strong>Package Manager</strong>: Handles dependencies and versions</li>
</ol>
<h3 id="packagejson">package.json</h3>
<p>The <code>package.json</code> file is the heart of any Node.js project. It contains:</p>
<ul>
<li>Project metadata</li>
<li>Dependencies</li>
<li>Scripts</li>
<li>Configuration</li>
</ul>
<h3 id="semantic-versioning-semver">Semantic Versioning (SemVer)</h3>
<p>npm uses semantic versioning: <code>MAJOR.MINOR.PATCH</code></p>
<ul>
<li><strong>MAJOR</strong>: Breaking changes</li>
<li><strong>MINOR</strong>: New features (backward compatible)</li>
<li><strong>PATCH</strong>: Bug fixes</li>
</ul>
<h3 id="dependencies-vs-devdependencies">Dependencies vs DevDependencies</h3>
<ul>
<li><strong>dependencies</strong>: Required for production</li>
<li><strong>devDependencies</strong>: Only needed for development</li>
</ul>
<h2 id="example-code">Example Code</h2>
<h3 id="initializing-a-new-project">Initializing a New Project</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Create a new directory</span>
mkdir my-node-project
<span class="hljs-built_in">cd</span> my-node-project

<span class="hljs-comment"># Initialize npm (interactive)</span>
npm init

<span class="hljs-comment"># Initialize with defaults</span>
npm init -y
<span class="hljs-comment"># or</span>
npm init --yes
</div></code></pre>
<h3 id="sample-packagejson">Sample package.json</h3>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"my-node-project"</span>,
  <span class="hljs-attr">"version"</span>: <span class="hljs-string">"1.0.0"</span>,
  <span class="hljs-attr">"description"</span>: <span class="hljs-string">"A sample Node.js project"</span>,
  <span class="hljs-attr">"main"</span>: <span class="hljs-string">"index.js"</span>,
  <span class="hljs-attr">"scripts"</span>: {
    <span class="hljs-attr">"start"</span>: <span class="hljs-string">"node index.js"</span>,
    <span class="hljs-attr">"dev"</span>: <span class="hljs-string">"node --watch index.js"</span>,
    <span class="hljs-attr">"test"</span>: <span class="hljs-string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>
  },
  <span class="hljs-attr">"keywords"</span>: [<span class="hljs-string">"node"</span>, <span class="hljs-string">"javascript"</span>, <span class="hljs-string">"tutorial"</span>],
  <span class="hljs-attr">"author"</span>: <span class="hljs-string">"Your Name &lt;your.email@example.com&gt;"</span>,
  <span class="hljs-attr">"license"</span>: <span class="hljs-string">"MIT"</span>,
  <span class="hljs-attr">"dependencies"</span>: {},
  <span class="hljs-attr">"devDependencies"</span>: {}
}
</div></code></pre>
<h3 id="installing-packages">Installing Packages</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Install a package and add to dependencies</span>
npm install express
<span class="hljs-comment"># or</span>
npm i express

<span class="hljs-comment"># Install multiple packages</span>
npm install express mongoose dotenv

<span class="hljs-comment"># Install as dev dependency</span>
npm install --save-dev nodemon
<span class="hljs-comment"># or</span>
npm i -D nodemon

<span class="hljs-comment"># Install globally</span>
npm install -g nodemon

<span class="hljs-comment"># Install specific version</span>
npm install express@4.18.0

<span class="hljs-comment"># Install from GitHub</span>
npm install user/repo
</div></code></pre>
<h3 id="version-specifiers">Version Specifiers</h3>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"dependencies"</span>: {
    <span class="hljs-attr">"express"</span>: <span class="hljs-string">"^4.18.0"</span>, <span class="hljs-comment">// Compatible version (4.x.x)</span>
    <span class="hljs-attr">"mongoose"</span>: <span class="hljs-string">"~7.0.0"</span>, <span class="hljs-comment">// Approximately equivalent (7.0.x)</span>
    <span class="hljs-attr">"lodash"</span>: <span class="hljs-string">"4.17.21"</span>, <span class="hljs-comment">// Exact version</span>
    <span class="hljs-attr">"moment"</span>: <span class="hljs-string">"&gt;=2.29.0"</span>, <span class="hljs-comment">// Greater than or equal</span>
    <span class="hljs-attr">"axios"</span>: <span class="hljs-string">"&lt;1.0.0"</span>, <span class="hljs-comment">// Less than</span>
    <span class="hljs-attr">"dotenv"</span>: <span class="hljs-string">"*"</span> <span class="hljs-comment">// Any version (not recommended)</span>
  }
}
</div></code></pre>
<h3 id="package-management-commands">Package Management Commands</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># List installed packages</span>
npm list
npm ls

<span class="hljs-comment"># List global packages</span>
npm list -g --depth=0

<span class="hljs-comment"># Check for outdated packages</span>
npm outdated

<span class="hljs-comment"># Update packages</span>
npm update
npm update express

<span class="hljs-comment"># Uninstall packages</span>
npm uninstall express
npm remove express
npm rm express

<span class="hljs-comment"># Uninstall global package</span>
npm uninstall -g nodemon

<span class="hljs-comment"># Clean npm cache</span>
npm cache clean --force
</div></code></pre>
<h3 id="working-with-scripts">Working with Scripts</h3>
<p>Create an <code>index.js</code> file:</p>
<pre class="hljs"><code><div><span class="hljs-comment">// index.js</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Hello from npm scripts!"</span>);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Environment:"</span>, process.env.NODE_ENV || <span class="hljs-string">"development"</span>);

<span class="hljs-comment">// Simple HTTP server</span>
<span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">"http"</span>);

<span class="hljs-keyword">const</span> server = http.createServer(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.writeHead(<span class="hljs-number">200</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/plain"</span> });
  res.end(<span class="hljs-string">"Hello from Node.js server!"</span>);
});

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
server.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Server running on port <span class="hljs-subst">${PORT}</span>`</span>);
});
</div></code></pre>
<p>Update <code>package.json</code> scripts:</p>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"scripts"</span>: {
    <span class="hljs-attr">"start"</span>: <span class="hljs-string">"node index.js"</span>,
    <span class="hljs-attr">"dev"</span>: <span class="hljs-string">"nodemon index.js"</span>,
    <span class="hljs-attr">"prod"</span>: <span class="hljs-string">"NODE_ENV=production node index.js"</span>,
    <span class="hljs-attr">"test"</span>: <span class="hljs-string">"echo \"Running tests...\" &amp;&amp; node test.js"</span>,
    <span class="hljs-attr">"build"</span>: <span class="hljs-string">"echo \"Building project...\""</span>,
    <span class="hljs-attr">"clean"</span>: <span class="hljs-string">"rm -rf node_modules package-lock.json"</span>,
    <span class="hljs-attr">"reinstall"</span>: <span class="hljs-string">"npm run clean &amp;&amp; npm install"</span>,
    <span class="hljs-attr">"lint"</span>: <span class="hljs-string">"echo \"Linting code...\""</span>,
    <span class="hljs-attr">"prestart"</span>: <span class="hljs-string">"echo \"Pre-start hook\""</span>,
    <span class="hljs-attr">"poststart"</span>: <span class="hljs-string">"echo \"Post-start hook\""</span>
  }
}
</div></code></pre>
<p>Run scripts:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># Run scripts</span>
npm start
npm run dev
npm <span class="hljs-built_in">test</span>
npm run build

<span class="hljs-comment"># List available scripts</span>
npm run
</div></code></pre>
<h3 id="creating-a-complete-project-setup">Creating a Complete Project Setup</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Initialize project</span>
mkdir todo-app
<span class="hljs-built_in">cd</span> todo-app
npm init -y

<span class="hljs-comment"># Install dependencies</span>
npm install express cors helmet morgan
npm install -D nodemon jest supertest
</div></code></pre>
<p>Update the <code>package.json</code>:</p>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"todo-app"</span>,
  <span class="hljs-attr">"version"</span>: <span class="hljs-string">"1.0.0"</span>,
  <span class="hljs-attr">"description"</span>: <span class="hljs-string">"A simple todo application"</span>,
  <span class="hljs-attr">"main"</span>: <span class="hljs-string">"server.js"</span>,
  <span class="hljs-attr">"scripts"</span>: {
    <span class="hljs-attr">"start"</span>: <span class="hljs-string">"node server.js"</span>,
    <span class="hljs-attr">"dev"</span>: <span class="hljs-string">"nodemon server.js"</span>,
    <span class="hljs-attr">"test"</span>: <span class="hljs-string">"jest"</span>,
    <span class="hljs-attr">"test:watch"</span>: <span class="hljs-string">"jest --watch"</span>,
    <span class="hljs-attr">"lint"</span>: <span class="hljs-string">"echo \"Add linting here\""</span>,
    <span class="hljs-attr">"build"</span>: <span class="hljs-string">"echo \"Build process\""</span>
  },
  <span class="hljs-attr">"keywords"</span>: [<span class="hljs-string">"todo"</span>, <span class="hljs-string">"express"</span>, <span class="hljs-string">"api"</span>],
  <span class="hljs-attr">"author"</span>: <span class="hljs-string">"Your Name"</span>,
  <span class="hljs-attr">"license"</span>: <span class="hljs-string">"MIT"</span>,
  <span class="hljs-attr">"dependencies"</span>: {
    <span class="hljs-attr">"express"</span>: <span class="hljs-string">"^4.18.2"</span>,
    <span class="hljs-attr">"cors"</span>: <span class="hljs-string">"^2.8.5"</span>,
    <span class="hljs-attr">"helmet"</span>: <span class="hljs-string">"^7.0.0"</span>,
    <span class="hljs-attr">"morgan"</span>: <span class="hljs-string">"^1.10.0"</span>
  },
  <span class="hljs-attr">"devDependencies"</span>: {
    <span class="hljs-attr">"nodemon"</span>: <span class="hljs-string">"^3.0.1"</span>,
    <span class="hljs-attr">"jest"</span>: <span class="hljs-string">"^29.6.2"</span>,
    <span class="hljs-attr">"supertest"</span>: <span class="hljs-string">"^6.3.3"</span>
  }
}
</div></code></pre>
<p>Create <code>server.js</code>:</p>
<pre class="hljs"><code><div><span class="hljs-comment">// server.js</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">"cors"</span>);
<span class="hljs-keyword">const</span> helmet = <span class="hljs-built_in">require</span>(<span class="hljs-string">"helmet"</span>);
<span class="hljs-keyword">const</span> morgan = <span class="hljs-built_in">require</span>(<span class="hljs-string">"morgan"</span>);

<span class="hljs-keyword">const</span> app = express();
<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;

<span class="hljs-comment">// Middleware</span>
app.use(helmet());
app.use(cors());
app.use(morgan(<span class="hljs-string">"combined"</span>));
app.use(express.json());

<span class="hljs-comment">// In-memory storage for todos</span>
<span class="hljs-keyword">let</span> todos = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">"Learn Node.js"</span>, <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">"Build an API"</span>, <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span> },
];

<span class="hljs-comment">// Routes</span>
app.get(<span class="hljs-string">"/api/todos"</span>, (req, res) =&gt; {
  res.json(todos);
});

app.post(<span class="hljs-string">"/api/todos"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { text } = req.body;

  <span class="hljs-keyword">if</span> (!text) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Text is required"</span> });
  }

  <span class="hljs-keyword">const</span> newTodo = {
    <span class="hljs-attr">id</span>: todos.length + <span class="hljs-number">1</span>,
    text,
    <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span>,
  };

  todos.push(newTodo);
  res.status(<span class="hljs-number">201</span>).json(newTodo);
});

app.get(<span class="hljs-string">"/health"</span>, (req, res) =&gt; {
  res.json({ <span class="hljs-attr">status</span>: <span class="hljs-string">"OK"</span>, <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString() });
});

app.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🚀 Server running on port <span class="hljs-subst">${PORT}</span>`</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`📝 API available at http://localhost:<span class="hljs-subst">${PORT}</span>/api/todos`</span>);
});

<span class="hljs-built_in">module</span>.exports = app;
</div></code></pre>
<h2 id="real-world-use-case">Real-World Use Case</h2>
<h3 id="packagejson-for-a-production-app">Package.json for a Production App</h3>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"production-api"</span>,
  <span class="hljs-attr">"version"</span>: <span class="hljs-string">"2.1.0"</span>,
  <span class="hljs-attr">"description"</span>: <span class="hljs-string">"Production-ready REST API"</span>,
  <span class="hljs-attr">"main"</span>: <span class="hljs-string">"src/server.js"</span>,
  <span class="hljs-attr">"engines"</span>: {
    <span class="hljs-attr">"node"</span>: <span class="hljs-string">"&gt;=18.0.0"</span>,
    <span class="hljs-attr">"npm"</span>: <span class="hljs-string">"&gt;=8.0.0"</span>
  },
  <span class="hljs-attr">"scripts"</span>: {
    <span class="hljs-attr">"start"</span>: <span class="hljs-string">"node src/server.js"</span>,
    <span class="hljs-attr">"dev"</span>: <span class="hljs-string">"nodemon src/server.js"</span>,
    <span class="hljs-attr">"test"</span>: <span class="hljs-string">"jest --coverage"</span>,
    <span class="hljs-attr">"test:watch"</span>: <span class="hljs-string">"jest --watch"</span>,
    <span class="hljs-attr">"test:integration"</span>: <span class="hljs-string">"jest --testPathPattern=integration"</span>,
    <span class="hljs-attr">"lint"</span>: <span class="hljs-string">"eslint src/"</span>,
    <span class="hljs-attr">"lint:fix"</span>: <span class="hljs-string">"eslint src/ --fix"</span>,
    <span class="hljs-attr">"format"</span>: <span class="hljs-string">"prettier --write src/"</span>,
    <span class="hljs-attr">"build"</span>: <span class="hljs-string">"npm run lint &amp;&amp; npm run test"</span>,
    <span class="hljs-attr">"precommit"</span>: <span class="hljs-string">"npm run lint &amp;&amp; npm run test"</span>,
    <span class="hljs-attr">"docker:build"</span>: <span class="hljs-string">"docker build -t production-api ."</span>,
    <span class="hljs-attr">"docker:run"</span>: <span class="hljs-string">"docker run -p 3000:3000 production-api"</span>
  },
  <span class="hljs-attr">"dependencies"</span>: {
    <span class="hljs-attr">"express"</span>: <span class="hljs-string">"^4.18.2"</span>,
    <span class="hljs-attr">"mongoose"</span>: <span class="hljs-string">"^7.4.0"</span>,
    <span class="hljs-attr">"bcryptjs"</span>: <span class="hljs-string">"^2.4.3"</span>,
    <span class="hljs-attr">"jsonwebtoken"</span>: <span class="hljs-string">"^9.0.1"</span>,
    <span class="hljs-attr">"helmet"</span>: <span class="hljs-string">"^7.0.0"</span>,
    <span class="hljs-attr">"cors"</span>: <span class="hljs-string">"^2.8.5"</span>,
    <span class="hljs-attr">"morgan"</span>: <span class="hljs-string">"^1.10.0"</span>,
    <span class="hljs-attr">"dotenv"</span>: <span class="hljs-string">"^16.3.1"</span>,
    <span class="hljs-attr">"joi"</span>: <span class="hljs-string">"^17.9.2"</span>,
    <span class="hljs-attr">"winston"</span>: <span class="hljs-string">"^3.10.0"</span>
  },
  <span class="hljs-attr">"devDependencies"</span>: {
    <span class="hljs-attr">"nodemon"</span>: <span class="hljs-string">"^3.0.1"</span>,
    <span class="hljs-attr">"jest"</span>: <span class="hljs-string">"^29.6.2"</span>,
    <span class="hljs-attr">"supertest"</span>: <span class="hljs-string">"^6.3.3"</span>,
    <span class="hljs-attr">"eslint"</span>: <span class="hljs-string">"^8.45.0"</span>,
    <span class="hljs-attr">"prettier"</span>: <span class="hljs-string">"^3.0.0"</span>,
    <span class="hljs-attr">"husky"</span>: <span class="hljs-string">"^8.0.3"</span>,
    <span class="hljs-attr">"lint-staged"</span>: <span class="hljs-string">"^13.2.3"</span>
  },
  <span class="hljs-attr">"repository"</span>: {
    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"git"</span>,
    <span class="hljs-attr">"url"</span>: <span class="hljs-string">"https://github.com/username/production-api.git"</span>
  },
  <span class="hljs-attr">"keywords"</span>: [<span class="hljs-string">"api"</span>, <span class="hljs-string">"express"</span>, <span class="hljs-string">"mongodb"</span>, <span class="hljs-string">"jwt"</span>],
  <span class="hljs-attr">"author"</span>: <span class="hljs-string">"Your Name &lt;your.email@example.com&gt;"</span>,
  <span class="hljs-attr">"license"</span>: <span class="hljs-string">"MIT"</span>,
  <span class="hljs-attr">"husky"</span>: {
    <span class="hljs-attr">"hooks"</span>: {
      <span class="hljs-attr">"pre-commit"</span>: <span class="hljs-string">"lint-staged"</span>
    }
  },
  <span class="hljs-attr">"lint-staged"</span>: {
    <span class="hljs-attr">"*.js"</span>: [<span class="hljs-string">"eslint --fix"</span>, <span class="hljs-string">"prettier --write"</span>]
  }
}
</div></code></pre>
<h3 id="npm-configuration">NPM Configuration</h3>
<p>Create <code>.npmrc</code> file for project-specific npm configuration:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># .npmrc</span>
registry=https://registry.npmjs.org/
save-exact=<span class="hljs-literal">true</span>
engine-strict=<span class="hljs-literal">true</span>
fund=<span class="hljs-literal">false</span>
audit-level=moderate
</div></code></pre>
<h3 id="security-best-practices">Security Best Practices</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Check for vulnerabilities</span>
npm audit

<span class="hljs-comment"># Fix vulnerabilities automatically</span>
npm audit fix

<span class="hljs-comment"># Force fix (may introduce breaking changes)</span>
npm audit fix --force

<span class="hljs-comment"># Install specific security updates</span>
npm update --depth 3

<span class="hljs-comment"># Check package info before installing</span>
npm info express
npm view express versions --json
</div></code></pre>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-lock-file-management">1. Lock File Management</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Always commit package-lock.json</span>
git add package-lock.json

<span class="hljs-comment"># Use npm ci in production/CI</span>
npm ci  <span class="hljs-comment"># Faster, reliable, reproducible builds</span>
</div></code></pre>
<h3 id="2-version-management">2. Version Management</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Bump version</span>
npm version patch   <span class="hljs-comment"># 1.0.0 -&gt; 1.0.1</span>
npm version minor   <span class="hljs-comment"># 1.0.0 -&gt; 1.1.0</span>
npm version major   <span class="hljs-comment"># 1.0.0 -&gt; 2.0.0</span>

<span class="hljs-comment"># Pre-release versions</span>
npm version prerelease  <span class="hljs-comment"># 1.0.0 -&gt; 1.0.1-0</span>
</div></code></pre>
<h3 id="3-script-organization">3. Script Organization</h3>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"scripts"</span>: {
    <span class="hljs-attr">"start"</span>: <span class="hljs-string">"node server.js"</span>,
    <span class="hljs-attr">"dev"</span>: <span class="hljs-string">"nodemon server.js"</span>,
    <span class="hljs-attr">"test"</span>: <span class="hljs-string">"npm run test:unit &amp;&amp; npm run test:integration"</span>,
    <span class="hljs-attr">"test:unit"</span>: <span class="hljs-string">"jest --testPathPattern=unit"</span>,
    <span class="hljs-attr">"test:integration"</span>: <span class="hljs-string">"jest --testPathPattern=integration"</span>,
    <span class="hljs-attr">"test:watch"</span>: <span class="hljs-string">"jest --watch"</span>,
    <span class="hljs-attr">"lint"</span>: <span class="hljs-string">"eslint ."</span>,
    <span class="hljs-attr">"lint:fix"</span>: <span class="hljs-string">"eslint . --fix"</span>,
    <span class="hljs-attr">"format"</span>: <span class="hljs-string">"prettier --write ."</span>,
    <span class="hljs-attr">"build"</span>: <span class="hljs-string">"npm run lint &amp;&amp; npm run test"</span>,
    <span class="hljs-attr">"clean"</span>: <span class="hljs-string">"rm -rf node_modules dist"</span>,
    <span class="hljs-attr">"reset"</span>: <span class="hljs-string">"npm run clean &amp;&amp; npm install"</span>
  }
}
</div></code></pre>
<h3 id="4-environment-specific-scripts">4. Environment-Specific Scripts</h3>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"scripts"</span>: {
    <span class="hljs-attr">"start"</span>: <span class="hljs-string">"node server.js"</span>,
    <span class="hljs-attr">"start:dev"</span>: <span class="hljs-string">"NODE_ENV=development nodemon server.js"</span>,
    <span class="hljs-attr">"start:prod"</span>: <span class="hljs-string">"NODE_ENV=production node server.js"</span>,
    <span class="hljs-attr">"start:test"</span>: <span class="hljs-string">"NODE_ENV=test node server.js"</span>
  }
}
</div></code></pre>
<h3 id="5-useful-npm-commands">5. Useful npm Commands</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Show npm configuration</span>
npm config list

<span class="hljs-comment"># Set npm configuration</span>
npm config <span class="hljs-built_in">set</span> registry https://registry.npmjs.org/

<span class="hljs-comment"># Show package information</span>
npm info package-name

<span class="hljs-comment"># Search for packages</span>
npm search express

<span class="hljs-comment"># Show dependency tree</span>
npm ls --depth=0

<span class="hljs-comment"># Find duplicate packages</span>
npm ls --depth=0 | grep -E <span class="hljs-string">'^[├└]'</span>
</div></code></pre>
<h2 id="summary">Summary</h2>
<p>npm is essential for Node.js development, providing:</p>
<ul>
<li><strong>Package Management</strong>: Install, update, and remove dependencies</li>
<li><strong>Version Control</strong>: Semantic versioning and lock files for reproducible builds</li>
<li><strong>Script Runner</strong>: Automate common development tasks</li>
<li><strong>Registry Access</strong>: Access to millions of open-source packages</li>
</ul>
<p>Key commands to remember:</p>
<pre class="hljs"><code><div>npm init -y              <span class="hljs-comment"># Initialize project</span>
npm install package      <span class="hljs-comment"># Install dependency</span>
npm install -D package   <span class="hljs-comment"># Install dev dependency</span>
npm run script-name      <span class="hljs-comment"># Run npm script</span>
npm audit               <span class="hljs-comment"># Check security vulnerabilities</span>
npm outdated            <span class="hljs-comment"># Check for package updates</span>
</div></code></pre>
<p>Mastering npm will significantly improve your development workflow and project management. Next, we'll explore Node.js core modules that provide built-in functionality for file system operations, HTTP servers, and more.</p>
<h1 id="nodejs-core-modules-built-in-functionality">Node.js Core Modules: Built-in Functionality</h1>
<h2 id="overview">Overview</h2>
<p>Node.js comes with a rich set of built-in modules that provide essential functionality without requiring external dependencies. These core modules handle file system operations, HTTP requests, path manipulation, operating system interactions, and much more. Understanding these modules is crucial for effective Node.js development.</p>
<h2 id="key-concepts">Key Concepts</h2>
<h3 id="what-are-core-modules">What are Core Modules?</h3>
<p>Core modules are built into Node.js and can be imported using <code>require()</code> without installation. They provide:</p>
<ul>
<li>File system operations</li>
<li>HTTP/HTTPS functionality</li>
<li>Path and URL utilities</li>
<li>Operating system information</li>
<li>Cryptographic functions</li>
<li>Stream processing</li>
<li>And much more</li>
</ul>
<h3 id="commonjs-vs-es-modules">CommonJS vs ES Modules</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// CommonJS (traditional)</span>
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);

<span class="hljs-comment">// ES Modules (modern)</span>
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"fs"</span>;
<span class="hljs-keyword">import</span> { readFile } <span class="hljs-keyword">from</span> <span class="hljs-string">"fs"</span>;
</div></code></pre>
<h3 id="synchronous-vs-asynchronous-apis">Synchronous vs Asynchronous APIs</h3>
<p>Most core modules provide both sync and async versions:</p>
<ul>
<li>Async: Non-blocking, callback-based or Promise-based</li>
<li>Sync: Blocking, returns result directly</li>
</ul>
<h2 id="example-code">Example Code</h2>
<h3 id="file-system-fs-module">File System (fs) Module</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// fs-examples.js</span>
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);

<span class="hljs-comment">// Reading files</span>
<span class="hljs-comment">// Asynchronous (preferred)</span>
fs.readFile(<span class="hljs-string">"data.txt"</span>, <span class="hljs-string">"utf8"</span>, (err, data) =&gt; {
  <span class="hljs-keyword">if</span> (err) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error reading file:"</span>, err.message);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"File content:"</span>, data);
});

<span class="hljs-comment">// Promise-based (modern approach)</span>
<span class="hljs-keyword">const</span> fsPromises = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>).promises;

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readFileAsync</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> fsPromises.readFile(<span class="hljs-string">"data.txt"</span>, <span class="hljs-string">"utf8"</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"File content (async/await):"</span>, data);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error:"</span>, error.message);
  }
}

<span class="hljs-comment">// Synchronous (use sparingly)</span>
<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">const</span> data = fs.readFileSync(<span class="hljs-string">"data.txt"</span>, <span class="hljs-string">"utf8"</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"File content (sync):"</span>, data);
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error:"</span>, error.message);
}

<span class="hljs-comment">// Writing files</span>
<span class="hljs-keyword">const</span> content = <span class="hljs-string">"Hello, Node.js!\nThis is a test file."</span>;

<span class="hljs-comment">// Asynchronous write</span>
fs.writeFile(<span class="hljs-string">"output.txt"</span>, content, <span class="hljs-string">"utf8"</span>, (err) =&gt; {
  <span class="hljs-keyword">if</span> (err) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error writing file:"</span>, err);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"File written successfully!"</span>);
});

<span class="hljs-comment">// Promise-based write</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeFileAsync</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> fsPromises.writeFile(<span class="hljs-string">"output-async.txt"</span>, content, <span class="hljs-string">"utf8"</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"File written successfully (async/await)!"</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error writing file:"</span>, error.message);
  }
}

<span class="hljs-comment">// Appending to files</span>
fs.appendFile(<span class="hljs-string">"log.txt"</span>, <span class="hljs-string">`\n<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span> - Log entry`</span>, (err) =&gt; {
  <span class="hljs-keyword">if</span> (err) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error appending to file:"</span>, err);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Log entry added!"</span>);
});

<span class="hljs-comment">// Working with directories</span>
fs.readdir(<span class="hljs-string">"."</span>, (err, files) =&gt; {
  <span class="hljs-keyword">if</span> (err) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error reading directory:"</span>, err);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Files in current directory:"</span>, files);
});

<span class="hljs-comment">// Creating directories</span>
fs.mkdir(<span class="hljs-string">"new-folder"</span>, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> }, (err) =&gt; {
  <span class="hljs-keyword">if</span> (err) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error creating directory:"</span>, err);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Directory created!"</span>);
});

<span class="hljs-comment">// File stats</span>
fs.stat(<span class="hljs-string">"package.json"</span>, (err, stats) =&gt; {
  <span class="hljs-keyword">if</span> (err) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error getting file stats:"</span>, err);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"File stats:"</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"  Size:"</span>, stats.size, <span class="hljs-string">"bytes"</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"  Is file:"</span>, stats.isFile());
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"  Is directory:"</span>, stats.isDirectory());
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"  Created:"</span>, stats.birthtime);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"  Modified:"</span>, stats.mtime);
});

<span class="hljs-comment">// Check if file exists</span>
fs.access(<span class="hljs-string">"somefile.txt"</span>, fs.constants.F_OK, (err) =&gt; {
  <span class="hljs-keyword">if</span> (err) {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"File does not exist"</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"File exists"</span>);
  }
});
</div></code></pre>
<h3 id="path-module">Path Module</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// path-examples.js</span>
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);

<span class="hljs-comment">// Path manipulation</span>
<span class="hljs-keyword">const</span> filePath = <span class="hljs-string">"/users/john/documents/file.txt"</span>;

<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Full path:"</span>, filePath);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Directory:"</span>, path.dirname(filePath)); <span class="hljs-comment">// /users/john/documents</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Filename:"</span>, path.basename(filePath)); <span class="hljs-comment">// file.txt</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Extension:"</span>, path.extname(filePath)); <span class="hljs-comment">// .txt</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Name without ext:"</span>, path.basename(filePath, <span class="hljs-string">".txt"</span>)); <span class="hljs-comment">// file</span>

<span class="hljs-comment">// Parsing paths</span>
<span class="hljs-keyword">const</span> parsed = path.parse(filePath);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Parsed path:"</span>, parsed);
<span class="hljs-comment">// {</span>
<span class="hljs-comment">//   root: '/',</span>
<span class="hljs-comment">//   dir: '/users/john/documents',</span>
<span class="hljs-comment">//   base: 'file.txt',</span>
<span class="hljs-comment">//   ext: '.txt',</span>
<span class="hljs-comment">//   name: 'file'</span>
<span class="hljs-comment">// }</span>

<span class="hljs-comment">// Building paths</span>
<span class="hljs-keyword">const</span> newPath = path.format({
  <span class="hljs-attr">dir</span>: <span class="hljs-string">"/users/jane/projects"</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">"app"</span>,
  <span class="hljs-attr">ext</span>: <span class="hljs-string">".js"</span>,
});
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Formatted path:"</span>, newPath); <span class="hljs-comment">// /users/jane/projects/app.js</span>

<span class="hljs-comment">// Joining paths (cross-platform)</span>
<span class="hljs-keyword">const</span> joinedPath = path.join(<span class="hljs-string">"/users"</span>, <span class="hljs-string">"john"</span>, <span class="hljs-string">"documents"</span>, <span class="hljs-string">"file.txt"</span>);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Joined path:"</span>, joinedPath);

<span class="hljs-comment">// Resolving absolute paths</span>
<span class="hljs-keyword">const</span> absolutePath = path.resolve(<span class="hljs-string">"documents"</span>, <span class="hljs-string">"file.txt"</span>);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Absolute path:"</span>, absolutePath);

<span class="hljs-comment">// Relative paths</span>
<span class="hljs-keyword">const</span> relativePath = path.relative(
  <span class="hljs-string">"/users/john"</span>,
  <span class="hljs-string">"/users/john/documents/file.txt"</span>
);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Relative path:"</span>, relativePath); <span class="hljs-comment">// documents/file.txt</span>

<span class="hljs-comment">// Cross-platform path separators</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Path separator:"</span>, path.sep); <span class="hljs-comment">// \ on Windows, / on Unix</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Path delimiter:"</span>, path.delimiter); <span class="hljs-comment">// ; on Windows, : on Unix</span>

<span class="hljs-comment">// Normalize paths</span>
<span class="hljs-keyword">const</span> messyPath = <span class="hljs-string">"/users/john/../jane/./documents//file.txt"</span>;
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Normalized:"</span>, path.normalize(messyPath)); <span class="hljs-comment">// /users/jane/documents/file.txt</span>
</div></code></pre>
<h3 id="http-module">HTTP Module</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// http-examples.js</span>
<span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">"http"</span>);
<span class="hljs-keyword">const</span> url = <span class="hljs-built_in">require</span>(<span class="hljs-string">"url"</span>);
<span class="hljs-keyword">const</span> querystring = <span class="hljs-built_in">require</span>(<span class="hljs-string">"querystring"</span>);

<span class="hljs-comment">// Basic HTTP server</span>
<span class="hljs-keyword">const</span> server = http.createServer(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-comment">// Parse URL</span>
  <span class="hljs-keyword">const</span> parsedUrl = url.parse(req.url, <span class="hljs-literal">true</span>);
  <span class="hljs-keyword">const</span> pathname = parsedUrl.pathname;
  <span class="hljs-keyword">const</span> query = parsedUrl.query;

  <span class="hljs-comment">// Set CORS headers</span>
  res.setHeader(<span class="hljs-string">"Access-Control-Allow-Origin"</span>, <span class="hljs-string">"*"</span>);
  res.setHeader(<span class="hljs-string">"Access-Control-Allow-Methods"</span>, <span class="hljs-string">"GET, POST, PUT, DELETE"</span>);
  res.setHeader(<span class="hljs-string">"Access-Control-Allow-Headers"</span>, <span class="hljs-string">"Content-Type"</span>);

  <span class="hljs-comment">// Handle different routes</span>
  <span class="hljs-keyword">if</span> (pathname === <span class="hljs-string">"/"</span>) {
    res.writeHead(<span class="hljs-number">200</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/html"</span> });
    res.end(<span class="hljs-string">`
            &lt;h1&gt;Welcome to Node.js HTTP Server&lt;/h1&gt;
            &lt;p&gt;Current time: <span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span>&lt;/p&gt;
            &lt;ul&gt;
                &lt;li&gt;&lt;a href="/api/users"&gt;Users API&lt;/a&gt;&lt;/li&gt;
                &lt;li&gt;&lt;a href="/api/health"&gt;Health Check&lt;/a&gt;&lt;/li&gt;
                &lt;li&gt;&lt;a href="/api/info?name=John&amp;age=30"&gt;Info with Query&lt;/a&gt;&lt;/li&gt;
            &lt;/ul&gt;
        `</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pathname === <span class="hljs-string">"/api/users"</span>) {
    <span class="hljs-keyword">const</span> users = [
      { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"John Doe"</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">"john@example.com"</span> },
      { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Jane Smith"</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">"jane@example.com"</span> },
    ];

    res.writeHead(<span class="hljs-number">200</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span> });
    res.end(<span class="hljs-built_in">JSON</span>.stringify(users, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pathname === <span class="hljs-string">"/api/health"</span>) {
    <span class="hljs-keyword">const</span> healthData = {
      <span class="hljs-attr">status</span>: <span class="hljs-string">"OK"</span>,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
      <span class="hljs-attr">uptime</span>: process.uptime(),
      <span class="hljs-attr">memory</span>: process.memoryUsage(),
    };

    res.writeHead(<span class="hljs-number">200</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span> });
    res.end(<span class="hljs-built_in">JSON</span>.stringify(healthData, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pathname === <span class="hljs-string">"/api/info"</span>) {
    <span class="hljs-keyword">const</span> info = {
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Hello from Node.js!"</span>,
      <span class="hljs-attr">query</span>: query,
      <span class="hljs-attr">method</span>: req.method,
      <span class="hljs-attr">headers</span>: req.headers,
      <span class="hljs-attr">url</span>: req.url,
    };

    res.writeHead(<span class="hljs-number">200</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span> });
    res.end(<span class="hljs-built_in">JSON</span>.stringify(info, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (req.method === <span class="hljs-string">"POST"</span> &amp;&amp; pathname === <span class="hljs-string">"/api/data"</span>) {
    <span class="hljs-keyword">let</span> body = <span class="hljs-string">""</span>;

    req.on(<span class="hljs-string">"data"</span>, (chunk) =&gt; {
      body += chunk.toString();
    });

    req.on(<span class="hljs-string">"end"</span>, () =&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> data = <span class="hljs-built_in">JSON</span>.parse(body);
        <span class="hljs-keyword">const</span> response = {
          <span class="hljs-attr">message</span>: <span class="hljs-string">"Data received successfully"</span>,
          <span class="hljs-attr">receivedData</span>: data,
          <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
        };

        res.writeHead(<span class="hljs-number">200</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span> });
        res.end(<span class="hljs-built_in">JSON</span>.stringify(response, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
      } <span class="hljs-keyword">catch</span> (error) {
        res.writeHead(<span class="hljs-number">400</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span> });
        res.end(<span class="hljs-built_in">JSON</span>.stringify({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Invalid JSON"</span> }));
      }
    });
  } <span class="hljs-keyword">else</span> {
    res.writeHead(<span class="hljs-number">404</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span> });
    res.end(<span class="hljs-built_in">JSON</span>.stringify({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Not Found"</span> }));
  }
});

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
server.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🚀 Server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});

<span class="hljs-comment">// HTTP client example</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makeHttpRequest</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> options = {
    <span class="hljs-attr">hostname</span>: <span class="hljs-string">"jsonplaceholder.typicode.com"</span>,
    <span class="hljs-attr">port</span>: <span class="hljs-number">443</span>,
    <span class="hljs-attr">path</span>: <span class="hljs-string">"/posts/1"</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">"GET"</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"Node.js HTTP Client"</span>,
    },
  };

  <span class="hljs-keyword">const</span> req = http.request(options, (res) =&gt; {
    <span class="hljs-keyword">let</span> data = <span class="hljs-string">""</span>;

    res.on(<span class="hljs-string">"data"</span>, (chunk) =&gt; {
      data += chunk;
    });

    res.on(<span class="hljs-string">"end"</span>, () =&gt; {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Response:"</span>, <span class="hljs-built_in">JSON</span>.parse(data));
    });
  });

  req.on(<span class="hljs-string">"error"</span>, (error) =&gt; {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Request error:"</span>, error);
  });

  req.end();
}

<span class="hljs-comment">// Uncomment to test HTTP client</span>
<span class="hljs-comment">// makeHttpRequest();</span>
</div></code></pre>
<h3 id="os-module">OS Module</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// os-examples.js</span>
<span class="hljs-keyword">const</span> os = <span class="hljs-built_in">require</span>(<span class="hljs-string">"os"</span>);

<span class="hljs-comment">// System information</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Operating System Information:"</span>);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Platform:"</span>, os.platform()); <span class="hljs-comment">// win32, darwin, linux</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Architecture:"</span>, os.arch()); <span class="hljs-comment">// x64, arm64, etc.</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"CPU Model:"</span>, os.cpus()[<span class="hljs-number">0</span>].model);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"CPU Cores:"</span>, os.cpus().length);
<span class="hljs-built_in">console</span>.log(
  <span class="hljs-string">"Total Memory:"</span>,
  (os.totalmem() / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>).toFixed(<span class="hljs-number">2</span>),
  <span class="hljs-string">"GB"</span>
);
<span class="hljs-built_in">console</span>.log(
  <span class="hljs-string">"Free Memory:"</span>,
  (os.freemem() / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>).toFixed(<span class="hljs-number">2</span>),
  <span class="hljs-string">"GB"</span>
);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Uptime:"</span>, (os.uptime() / <span class="hljs-number">3600</span>).toFixed(<span class="hljs-number">2</span>), <span class="hljs-string">"hours"</span>);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Hostname:"</span>, os.hostname());
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Home Directory:"</span>, os.homedir());
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Temp Directory:"</span>, os.tmpdir());
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Username:"</span>, os.userInfo().username);

<span class="hljs-comment">// Network interfaces</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"\nNetwork Interfaces:"</span>);
<span class="hljs-keyword">const</span> networkInterfaces = os.networkInterfaces();
<span class="hljs-built_in">Object</span>.keys(networkInterfaces).forEach(<span class="hljs-function">(<span class="hljs-params">interfaceName</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> interfaces = networkInterfaces[interfaceName];
  interfaces.forEach(<span class="hljs-function">(<span class="hljs-params">interface</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (interface.family === <span class="hljs-string">"IPv4"</span> &amp;&amp; !interface.internal) {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${interfaceName}</span>: <span class="hljs-subst">${interface.address}</span>`</span>);
    }
  });
});

<span class="hljs-comment">// Load average (Unix-like systems)</span>
<span class="hljs-keyword">if</span> (os.platform() !== <span class="hljs-string">"win32"</span>) {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"\nLoad Average:"</span>, os.loadavg());
}

<span class="hljs-comment">// EOL (End of Line) character</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"\nEOL character code:"</span>, os.EOL.charCodeAt(<span class="hljs-number">0</span>));
</div></code></pre>
<h3 id="url-module">URL Module</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// url-examples.js</span>
<span class="hljs-keyword">const</span> url = <span class="hljs-built_in">require</span>(<span class="hljs-string">"url"</span>);
<span class="hljs-keyword">const</span> { URL, URLSearchParams } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"url"</span>);

<span class="hljs-comment">// Legacy URL parsing</span>
<span class="hljs-keyword">const</span> urlString =
  <span class="hljs-string">"https://example.com:8080/path/to/resource?name=john&amp;age=30#section1"</span>;
<span class="hljs-keyword">const</span> parsedUrl = url.parse(urlString, <span class="hljs-literal">true</span>);

<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Legacy URL parsing:"</span>);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Protocol:"</span>, parsedUrl.protocol); <span class="hljs-comment">// https:</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Host:"</span>, parsedUrl.host); <span class="hljs-comment">// example.com:8080</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Hostname:"</span>, parsedUrl.hostname); <span class="hljs-comment">// example.com</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Port:"</span>, parsedUrl.port); <span class="hljs-comment">// 8080</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Pathname:"</span>, parsedUrl.pathname); <span class="hljs-comment">// /path/to/resource</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Query:"</span>, parsedUrl.query); <span class="hljs-comment">// { name: 'john', age: '30' }</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Hash:"</span>, parsedUrl.hash); <span class="hljs-comment">// #section1</span>

<span class="hljs-comment">// Modern URL API</span>
<span class="hljs-keyword">const</span> modernUrl = <span class="hljs-keyword">new</span> URL(urlString);

<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"\nModern URL API:"</span>);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Origin:"</span>, modernUrl.origin); <span class="hljs-comment">// https://example.com:8080</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Protocol:"</span>, modernUrl.protocol); <span class="hljs-comment">// https:</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Host:"</span>, modernUrl.host); <span class="hljs-comment">// example.com:8080</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Hostname:"</span>, modernUrl.hostname); <span class="hljs-comment">// example.com</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Port:"</span>, modernUrl.port); <span class="hljs-comment">// 8080</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Pathname:"</span>, modernUrl.pathname); <span class="hljs-comment">// /path/to/resource</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Search:"</span>, modernUrl.search); <span class="hljs-comment">// ?name=john&amp;age=30</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Hash:"</span>, modernUrl.hash); <span class="hljs-comment">// #section1</span>

<span class="hljs-comment">// Working with search parameters</span>
<span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> URLSearchParams(modernUrl.search);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"\nSearch Parameters:"</span>);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Name:"</span>, params.get(<span class="hljs-string">"name"</span>)); <span class="hljs-comment">// john</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Age:"</span>, params.get(<span class="hljs-string">"age"</span>)); <span class="hljs-comment">// 30</span>

<span class="hljs-comment">// Adding/modifying parameters</span>
params.set(<span class="hljs-string">"city"</span>, <span class="hljs-string">"New York"</span>);
params.append(<span class="hljs-string">"hobby"</span>, <span class="hljs-string">"reading"</span>);
params.append(<span class="hljs-string">"hobby"</span>, <span class="hljs-string">"coding"</span>);

<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Modified search:"</span>, params.toString());

<span class="hljs-comment">// Building URLs</span>
<span class="hljs-keyword">const</span> baseUrl = <span class="hljs-string">"https://api.example.com"</span>;
<span class="hljs-keyword">const</span> endpoint = <span class="hljs-string">"/users"</span>;
<span class="hljs-keyword">const</span> queryParams = <span class="hljs-keyword">new</span> URLSearchParams({
  <span class="hljs-attr">page</span>: <span class="hljs-string">"1"</span>,
  <span class="hljs-attr">limit</span>: <span class="hljs-string">"10"</span>,
  <span class="hljs-attr">sort</span>: <span class="hljs-string">"name"</span>,
});

<span class="hljs-keyword">const</span> apiUrl = <span class="hljs-keyword">new</span> URL(endpoint, baseUrl);
apiUrl.search = queryParams.toString();

<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"\nBuilt API URL:"</span>, apiUrl.toString());
</div></code></pre>
<h2 id="real-world-use-case">Real-World Use Case</h2>
<h3 id="file-based-logger-with-core-modules">File-based Logger with Core Modules</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// logger.js</span>
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">const</span> os = <span class="hljs-built_in">require</span>(<span class="hljs-string">"os"</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileLogger</span> </span>{
  <span class="hljs-keyword">constructor</span>(logDir = "logs") {
    <span class="hljs-keyword">this</span>.logDir = logDir;
    <span class="hljs-keyword">this</span>.ensureLogDirectory();
  }

  ensureLogDirectory() {
    <span class="hljs-keyword">if</span> (!fs.existsSync(<span class="hljs-keyword">this</span>.logDir)) {
      fs.mkdirSync(<span class="hljs-keyword">this</span>.logDir, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
    }
  }

  getLogFileName() {
    <span class="hljs-keyword">const</span> date = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString().split(<span class="hljs-string">"T"</span>)[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">return</span> path.join(<span class="hljs-keyword">this</span>.logDir, <span class="hljs-string">`app-<span class="hljs-subst">${date}</span>.log`</span>);
  }

  formatLogEntry(level, message, meta = {}) {
    <span class="hljs-keyword">const</span> timestamp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString();
    <span class="hljs-keyword">const</span> hostname = os.hostname();
    <span class="hljs-keyword">const</span> pid = process.pid;

    <span class="hljs-keyword">const</span> logEntry = {
      timestamp,
      <span class="hljs-attr">level</span>: level.toUpperCase(),
      message,
      hostname,
      pid,
      ...meta,
    };

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.stringify(logEntry) + os.EOL;
  }

  <span class="hljs-keyword">async</span> writeLog(level, message, meta = {}) {
    <span class="hljs-keyword">const</span> logEntry = <span class="hljs-keyword">this</span>.formatLogEntry(level, message, meta);
    <span class="hljs-keyword">const</span> logFile = <span class="hljs-keyword">this</span>.getLogFileName();

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> fs.promises.appendFile(logFile, logEntry, <span class="hljs-string">"utf8"</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Failed to write log:"</span>, error.message);
    }
  }

  info(message, meta = {}) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.writeLog(<span class="hljs-string">"info"</span>, message, meta);
  }

  error(message, meta = {}) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.writeLog(<span class="hljs-string">"error"</span>, message, meta);
  }

  warn(message, meta = {}) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.writeLog(<span class="hljs-string">"warn"</span>, message, meta);
  }

  debug(message, meta = {}) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.writeLog(<span class="hljs-string">"debug"</span>, message, meta);
  }

  <span class="hljs-keyword">async</span> getLogs(date = <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">const</span> targetDate = date || <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString().split(<span class="hljs-string">"T"</span>)[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">const</span> logFile = path.join(<span class="hljs-keyword">this</span>.logDir, <span class="hljs-string">`app-<span class="hljs-subst">${targetDate}</span>.log`</span>);

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> content = <span class="hljs-keyword">await</span> fs.promises.readFile(logFile, <span class="hljs-string">"utf8"</span>);
      <span class="hljs-keyword">return</span> content
        .split(os.EOL)
        .filter(<span class="hljs-function">(<span class="hljs-params">line</span>) =&gt;</span> line.trim())
        .map(<span class="hljs-function">(<span class="hljs-params">line</span>) =&gt;</span> <span class="hljs-built_in">JSON</span>.parse(line));
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (error.code === <span class="hljs-string">"ENOENT"</span>) {
        <span class="hljs-keyword">return</span> [];
      }
      <span class="hljs-keyword">throw</span> error;
    }
  }

  <span class="hljs-keyword">async</span> getLogStats() {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> files = <span class="hljs-keyword">await</span> fs.promises.readdir(<span class="hljs-keyword">this</span>.logDir);
      <span class="hljs-keyword">const</span> logFiles = files.filter(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> file.endsWith(<span class="hljs-string">".log"</span>));

      <span class="hljs-keyword">const</span> stats = <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.all(
        logFiles.map(<span class="hljs-keyword">async</span> (file) =&gt; {
          <span class="hljs-keyword">const</span> filePath = path.join(<span class="hljs-keyword">this</span>.logDir, file);
          <span class="hljs-keyword">const</span> stat = <span class="hljs-keyword">await</span> fs.promises.stat(filePath);
          <span class="hljs-keyword">return</span> {
            file,
            <span class="hljs-attr">size</span>: stat.size,
            <span class="hljs-attr">created</span>: stat.birthtime,
            <span class="hljs-attr">modified</span>: stat.mtime,
          };
        })
      );

      <span class="hljs-keyword">return</span> stats;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Failed to get log stats:"</span>, error.message);
      <span class="hljs-keyword">return</span> [];
    }
  }
}

<span class="hljs-comment">// Usage example</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">demonstrateLogger</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> logger = <span class="hljs-keyword">new</span> FileLogger();

  <span class="hljs-comment">// Log some entries</span>
  <span class="hljs-keyword">await</span> logger.info(<span class="hljs-string">"Application started"</span>, { <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span> });
  <span class="hljs-keyword">await</span> logger.warn(<span class="hljs-string">"This is a warning"</span>, { <span class="hljs-attr">component</span>: <span class="hljs-string">"auth"</span> });
  <span class="hljs-keyword">await</span> logger.error(<span class="hljs-string">"An error occurred"</span>, {
    <span class="hljs-attr">error</span>: <span class="hljs-string">"Database connection failed"</span>,
  });

  <span class="hljs-comment">// Get today's logs</span>
  <span class="hljs-keyword">const</span> logs = <span class="hljs-keyword">await</span> logger.getLogs();
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Today's logs:"</span>, logs);

  <span class="hljs-comment">// Get log file statistics</span>
  <span class="hljs-keyword">const</span> stats = <span class="hljs-keyword">await</span> logger.getLogStats();
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Log file stats:"</span>, stats);
}

<span class="hljs-comment">// Export for use in other modules</span>
<span class="hljs-built_in">module</span>.exports = FileLogger;

<span class="hljs-comment">// Run demonstration if this file is executed directly</span>
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">require</span>.main === <span class="hljs-built_in">module</span>) {
  demonstrateLogger().catch(<span class="hljs-built_in">console</span>.error);
}
</div></code></pre>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-always-use-asynchronous-apis">1. Always Use Asynchronous APIs</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// ❌ Bad - blocks the event loop</span>
<span class="hljs-keyword">const</span> data = fs.readFileSync(<span class="hljs-string">"large-file.txt"</span>);

<span class="hljs-comment">// ✅ Good - non-blocking</span>
fs.readFile(<span class="hljs-string">"large-file.txt"</span>, (err, data) =&gt; {
  <span class="hljs-comment">// Handle result</span>
});

<span class="hljs-comment">// ✅ Even better - modern async/await</span>
<span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> fs.promises.readFile(<span class="hljs-string">"large-file.txt"</span>);
</div></code></pre>
<h3 id="2-handle-errors-properly">2. Handle Errors Properly</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// ❌ Bad - unhandled errors</span>
fs.readFile(<span class="hljs-string">"file.txt"</span>, (err, data) =&gt; {
  <span class="hljs-built_in">console</span>.log(data.toString());
});

<span class="hljs-comment">// ✅ Good - proper error handling</span>
fs.readFile(<span class="hljs-string">"file.txt"</span>, (err, data) =&gt; {
  <span class="hljs-keyword">if</span> (err) {
    <span class="hljs-keyword">if</span> (err.code === <span class="hljs-string">"ENOENT"</span>) {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"File not found"</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error reading file:"</span>, err.message);
    }
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-built_in">console</span>.log(data.toString());
});
</div></code></pre>
<h3 id="3-use-path-module-for-cross-platform-compatibility">3. Use Path Module for Cross-Platform Compatibility</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// ❌ Bad - platform-specific</span>
<span class="hljs-keyword">const</span> filePath = <span class="hljs-string">"logs/app.log"</span>;

<span class="hljs-comment">// ✅ Good - cross-platform</span>
<span class="hljs-keyword">const</span> filePath = path.join(<span class="hljs-string">"logs"</span>, <span class="hljs-string">"app.log"</span>);
</div></code></pre>
<h3 id="4-validate-input-and-handle-edge-cases">4. Validate Input and Handle Edge Cases</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">safeReadFile</span>(<span class="hljs-params">filename</span>) </span>{
  <span class="hljs-keyword">if</span> (!filename || <span class="hljs-keyword">typeof</span> filename !== <span class="hljs-string">"string"</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Filename must be a non-empty string"</span>);
  }

  <span class="hljs-keyword">const</span> normalizedPath = path.normalize(filename);

  <span class="hljs-comment">// Prevent directory traversal attacks</span>
  <span class="hljs-keyword">if</span> (normalizedPath.includes(<span class="hljs-string">".."</span>)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Invalid file path"</span>);
  }

  <span class="hljs-keyword">return</span> fs.promises.readFile(normalizedPath, <span class="hljs-string">"utf8"</span>);
}
</div></code></pre>
<h3 id="5-use-streams-for-large-files">5. Use Streams for Large Files</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// For large files, use streams instead of reading everything into memory</span>
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">const</span> readline = <span class="hljs-built_in">require</span>(<span class="hljs-string">"readline"</span>);

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processLargeFile</span>(<span class="hljs-params">filename</span>) </span>{
  <span class="hljs-keyword">const</span> fileStream = fs.createReadStream(filename);
  <span class="hljs-keyword">const</span> rl = readline.createInterface({
    <span class="hljs-attr">input</span>: fileStream,
    <span class="hljs-attr">crlfDelay</span>: <span class="hljs-literal">Infinity</span>,
  });

  <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> rl) {
    <span class="hljs-comment">// Process each line without loading entire file into memory</span>
    <span class="hljs-built_in">console</span>.log(line);
  }
}
</div></code></pre>
<h2 id="summary">Summary</h2>
<p>Node.js core modules provide essential functionality for:</p>
<ul>
<li><strong>File System (fs)</strong>: Reading, writing, and manipulating files and directories</li>
<li><strong>Path</strong>: Cross-platform path manipulation and resolution</li>
<li><strong>HTTP</strong>: Creating servers and making HTTP requests</li>
<li><strong>OS</strong>: Accessing operating system information and utilities</li>
<li><strong>URL</strong>: Parsing and manipulating URLs</li>
</ul>
<p>Key principles:</p>
<ul>
<li>Always prefer asynchronous APIs to avoid blocking the event loop</li>
<li>Handle errors appropriately with proper error checking</li>
<li>Use path module for cross-platform file path handling</li>
<li>Validate inputs and handle edge cases</li>
<li>Consider using streams for large data processing</li>
</ul>
<p>These core modules form the foundation for building robust Node.js applications. Next, we'll explore how to create HTTP servers and build our first web applications.</p>
<h1 id="creating-http-servers-with-nodejs">Creating HTTP Servers with Node.js</h1>
<h2 id="overview">Overview</h2>
<p>Building HTTP servers is one of the most common use cases for Node.js. The built-in <code>http</code> module provides everything you need to create web servers, handle requests, serve files, and build APIs. This chapter covers creating HTTP servers from scratch, handling different HTTP methods, routing, and serving various types of content.</p>
<h2 id="key-concepts">Key Concepts</h2>
<h3 id="http-protocol-basics">HTTP Protocol Basics</h3>
<p>HTTP (HyperText Transfer Protocol) is a request-response protocol:</p>
<ul>
<li><strong>Client</strong> sends a request to the server</li>
<li><strong>Server</strong> processes the request and sends back a response</li>
<li>Each request contains: method, URL, headers, and optional body</li>
<li>Each response contains: status code, headers, and optional body</li>
</ul>
<h3 id="http-methods">HTTP Methods</h3>
<ul>
<li><strong>GET</strong>: Retrieve data</li>
<li><strong>POST</strong>: Create new data</li>
<li><strong>PUT</strong>: Update existing data</li>
<li><strong>DELETE</strong>: Remove data</li>
<li><strong>PATCH</strong>: Partial update</li>
<li><strong>HEAD</strong>: Get headers only</li>
<li><strong>OPTIONS</strong>: Get allowed methods</li>
</ul>
<h3 id="status-codes">Status Codes</h3>
<ul>
<li><strong>2xx</strong>: Success (200 OK, 201 Created)</li>
<li><strong>3xx</strong>: Redirection (301 Moved, 304 Not Modified)</li>
<li><strong>4xx</strong>: Client Error (400 Bad Request, 404 Not Found)</li>
<li><strong>5xx</strong>: Server Error (500 Internal Server Error)</li>
</ul>
<h2 id="example-code">Example Code</h2>
<h3 id="basic-http-server">Basic HTTP Server</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// basic-server.js</span>
<span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">"http"</span>);

<span class="hljs-comment">// Create server</span>
<span class="hljs-keyword">const</span> server = http.createServer(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-comment">// Set response headers</span>
  res.writeHead(<span class="hljs-number">200</span>, {
    <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/plain"</span>,
    <span class="hljs-string">"Access-Control-Allow-Origin"</span>: <span class="hljs-string">"*"</span>,
  });

  <span class="hljs-comment">// Send response</span>
  res.end(<span class="hljs-string">"Hello, World! This is my first Node.js server."</span>);
});

<span class="hljs-comment">// Start server</span>
<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
server.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🚀 Server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});

<span class="hljs-comment">// Handle server errors</span>
server.on(<span class="hljs-string">"error"</span>, (error) =&gt; {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Server error:"</span>, error.message);
});

<span class="hljs-comment">// Graceful shutdown</span>
process.on(<span class="hljs-string">"SIGTERM"</span>, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Received SIGTERM, shutting down gracefully"</span>);
  server.close(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Server closed"</span>);
    process.exit(<span class="hljs-number">0</span>);
  });
});
</div></code></pre>
<h3 id="handling-different-http-methods">Handling Different HTTP Methods</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// method-handler.js</span>
<span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">"http"</span>);
<span class="hljs-keyword">const</span> url = <span class="hljs-built_in">require</span>(<span class="hljs-string">"url"</span>);

<span class="hljs-comment">// In-memory data store</span>
<span class="hljs-keyword">let</span> users = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"John Doe"</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">"john@example.com"</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Jane Smith"</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">"jane@example.com"</span> },
];

<span class="hljs-keyword">let</span> nextId = <span class="hljs-number">3</span>;

<span class="hljs-keyword">const</span> server = http.createServer(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> parsedUrl = url.parse(req.url, <span class="hljs-literal">true</span>);
  <span class="hljs-keyword">const</span> path = parsedUrl.pathname;
  <span class="hljs-keyword">const</span> method = req.method;
  <span class="hljs-keyword">const</span> query = parsedUrl.query;

  <span class="hljs-comment">// Set common headers</span>
  res.setHeader(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/json"</span>);
  res.setHeader(<span class="hljs-string">"Access-Control-Allow-Origin"</span>, <span class="hljs-string">"*"</span>);
  res.setHeader(
    <span class="hljs-string">"Access-Control-Allow-Methods"</span>,
    <span class="hljs-string">"GET, POST, PUT, DELETE, OPTIONS"</span>
  );
  res.setHeader(<span class="hljs-string">"Access-Control-Allow-Headers"</span>, <span class="hljs-string">"Content-Type"</span>);

  <span class="hljs-comment">// Handle preflight requests</span>
  <span class="hljs-keyword">if</span> (method === <span class="hljs-string">"OPTIONS"</span>) {
    res.writeHead(<span class="hljs-number">200</span>);
    res.end();
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// Route handling</span>
  <span class="hljs-keyword">if</span> (path === <span class="hljs-string">"/api/users"</span>) {
    handleUsersRoute(req, res, method, query);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (path.startsWith(<span class="hljs-string">"/api/users/"</span>)) {
    <span class="hljs-keyword">const</span> userId = <span class="hljs-built_in">parseInt</span>(path.split(<span class="hljs-string">"/"</span>)[<span class="hljs-number">3</span>]);
    handleUserRoute(req, res, method, userId);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (path === <span class="hljs-string">"/"</span>) {
    handleHomeRoute(req, res);
  } <span class="hljs-keyword">else</span> {
    handle404(req, res);
  }
});

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleUsersRoute</span>(<span class="hljs-params">req, res, method, query</span>) </span>{
  <span class="hljs-keyword">switch</span> (method) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"GET"</span>:
      <span class="hljs-comment">// Get all users with optional filtering</span>
      <span class="hljs-keyword">let</span> filteredUsers = users;

      <span class="hljs-keyword">if</span> (query.name) {
        filteredUsers = users.filter(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span>
          user.name.toLowerCase().includes(query.name.toLowerCase())
        );
      }

      res.writeHead(<span class="hljs-number">200</span>);
      res.end(
        <span class="hljs-built_in">JSON</span>.stringify(
          {
            <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">data</span>: filteredUsers,
            <span class="hljs-attr">count</span>: filteredUsers.length,
          },
          <span class="hljs-literal">null</span>,
          <span class="hljs-number">2</span>
        )
      );
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"POST"</span>:
      <span class="hljs-comment">// Create new user</span>
      <span class="hljs-keyword">let</span> body = <span class="hljs-string">""</span>;

      req.on(<span class="hljs-string">"data"</span>, (chunk) =&gt; {
        body += chunk.toString();
      });

      req.on(<span class="hljs-string">"end"</span>, () =&gt; {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">const</span> userData = <span class="hljs-built_in">JSON</span>.parse(body);

          <span class="hljs-comment">// Validate required fields</span>
          <span class="hljs-keyword">if</span> (!userData.name || !userData.email) {
            res.writeHead(<span class="hljs-number">400</span>);
            res.end(
              <span class="hljs-built_in">JSON</span>.stringify({
                <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-attr">error</span>: <span class="hljs-string">"Name and email are required"</span>,
              })
            );
            <span class="hljs-keyword">return</span>;
          }

          <span class="hljs-comment">// Check if email already exists</span>
          <span class="hljs-keyword">const</span> existingUser = users.find(
            <span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> user.email === userData.email
          );
          <span class="hljs-keyword">if</span> (existingUser) {
            res.writeHead(<span class="hljs-number">409</span>);
            res.end(
              <span class="hljs-built_in">JSON</span>.stringify({
                <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-attr">error</span>: <span class="hljs-string">"Email already exists"</span>,
              })
            );
            <span class="hljs-keyword">return</span>;
          }

          <span class="hljs-comment">// Create new user</span>
          <span class="hljs-keyword">const</span> newUser = {
            <span class="hljs-attr">id</span>: nextId++,
            <span class="hljs-attr">name</span>: userData.name,
            <span class="hljs-attr">email</span>: userData.email,
          };

          users.push(newUser);

          res.writeHead(<span class="hljs-number">201</span>);
          res.end(
            <span class="hljs-built_in">JSON</span>.stringify(
              {
                <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">data</span>: newUser,
                <span class="hljs-attr">message</span>: <span class="hljs-string">"User created successfully"</span>,
              },
              <span class="hljs-literal">null</span>,
              <span class="hljs-number">2</span>
            )
          );
        } <span class="hljs-keyword">catch</span> (error) {
          res.writeHead(<span class="hljs-number">400</span>);
          res.end(
            <span class="hljs-built_in">JSON</span>.stringify({
              <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
              <span class="hljs-attr">error</span>: <span class="hljs-string">"Invalid JSON data"</span>,
            })
          );
        }
      });
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">default</span>:
      res.writeHead(<span class="hljs-number">405</span>);
      res.end(
        <span class="hljs-built_in">JSON</span>.stringify({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Method not allowed"</span>,
        })
      );
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleUserRoute</span>(<span class="hljs-params">req, res, method, userId</span>) </span>{
  <span class="hljs-keyword">const</span> userIndex = users.findIndex(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> user.id === userId);

  <span class="hljs-keyword">switch</span> (method) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"GET"</span>:
      <span class="hljs-keyword">if</span> (userIndex === <span class="hljs-number">-1</span>) {
        res.writeHead(<span class="hljs-number">404</span>);
        res.end(
          <span class="hljs-built_in">JSON</span>.stringify({
            <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">error</span>: <span class="hljs-string">"User not found"</span>,
          })
        );
        <span class="hljs-keyword">return</span>;
      }

      res.writeHead(<span class="hljs-number">200</span>);
      res.end(
        <span class="hljs-built_in">JSON</span>.stringify(
          {
            <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">data</span>: users[userIndex],
          },
          <span class="hljs-literal">null</span>,
          <span class="hljs-number">2</span>
        )
      );
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"PUT"</span>:
      <span class="hljs-keyword">if</span> (userIndex === <span class="hljs-number">-1</span>) {
        res.writeHead(<span class="hljs-number">404</span>);
        res.end(
          <span class="hljs-built_in">JSON</span>.stringify({
            <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">error</span>: <span class="hljs-string">"User not found"</span>,
          })
        );
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-keyword">let</span> body = <span class="hljs-string">""</span>;
      req.on(<span class="hljs-string">"data"</span>, (chunk) =&gt; {
        body += chunk.toString();
      });

      req.on(<span class="hljs-string">"end"</span>, () =&gt; {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">const</span> userData = <span class="hljs-built_in">JSON</span>.parse(body);

          <span class="hljs-comment">// Update user</span>
          users[userIndex] = {
            ...users[userIndex],
            ...userData,
            <span class="hljs-attr">id</span>: userId, <span class="hljs-comment">// Ensure ID doesn't change</span>
          };

          res.writeHead(<span class="hljs-number">200</span>);
          res.end(
            <span class="hljs-built_in">JSON</span>.stringify(
              {
                <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">data</span>: users[userIndex],
                <span class="hljs-attr">message</span>: <span class="hljs-string">"User updated successfully"</span>,
              },
              <span class="hljs-literal">null</span>,
              <span class="hljs-number">2</span>
            )
          );
        } <span class="hljs-keyword">catch</span> (error) {
          res.writeHead(<span class="hljs-number">400</span>);
          res.end(
            <span class="hljs-built_in">JSON</span>.stringify({
              <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
              <span class="hljs-attr">error</span>: <span class="hljs-string">"Invalid JSON data"</span>,
            })
          );
        }
      });
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"DELETE"</span>:
      <span class="hljs-keyword">if</span> (userIndex === <span class="hljs-number">-1</span>) {
        res.writeHead(<span class="hljs-number">404</span>);
        res.end(
          <span class="hljs-built_in">JSON</span>.stringify({
            <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">error</span>: <span class="hljs-string">"User not found"</span>,
          })
        );
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-keyword">const</span> deletedUser = users.splice(userIndex, <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>];

      res.writeHead(<span class="hljs-number">200</span>);
      res.end(
        <span class="hljs-built_in">JSON</span>.stringify(
          {
            <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">data</span>: deletedUser,
            <span class="hljs-attr">message</span>: <span class="hljs-string">"User deleted successfully"</span>,
          },
          <span class="hljs-literal">null</span>,
          <span class="hljs-number">2</span>
        )
      );
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">default</span>:
      res.writeHead(<span class="hljs-number">405</span>);
      res.end(
        <span class="hljs-built_in">JSON</span>.stringify({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Method not allowed"</span>,
        })
      );
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleHomeRoute</span>(<span class="hljs-params">req, res</span>) </span>{
  res.setHeader(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"text/html"</span>);
  res.writeHead(<span class="hljs-number">200</span>);
  res.end(<span class="hljs-string">`
        &lt;!DOCTYPE html&gt;
        &lt;html&gt;
        &lt;head&gt;
            &lt;title&gt;Node.js API Server&lt;/title&gt;
            &lt;style&gt;
                body { font-family: Arial, sans-serif; margin: 40px; }
                .endpoint { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
                .method { font-weight: bold; color: #007acc; }
            &lt;/style&gt;
        &lt;/head&gt;
        &lt;body&gt;
            &lt;h1&gt;🚀 Node.js API Server&lt;/h1&gt;
            &lt;p&gt;Welcome to the Node.js HTTP server! Here are the available endpoints:&lt;/p&gt;
            
            &lt;h2&gt;📋 API Endpoints&lt;/h2&gt;
            
            &lt;div class="endpoint"&gt;
                &lt;span class="method"&gt;GET&lt;/span&gt; /api/users - Get all users
                &lt;br&gt;&lt;small&gt;Query params: ?name=searchTerm&lt;/small&gt;
            &lt;/div&gt;
            
            &lt;div class="endpoint"&gt;
                &lt;span class="method"&gt;POST&lt;/span&gt; /api/users - Create a new user
                &lt;br&gt;&lt;small&gt;Body: {"name": "John Doe", "email": "john@example.com"}&lt;/small&gt;
            &lt;/div&gt;
            
            &lt;div class="endpoint"&gt;
                &lt;span class="method"&gt;GET&lt;/span&gt; /api/users/:id - Get user by ID
            &lt;/div&gt;
            
            &lt;div class="endpoint"&gt;
                &lt;span class="method"&gt;PUT&lt;/span&gt; /api/users/:id - Update user by ID
                &lt;br&gt;&lt;small&gt;Body: {"name": "Updated Name", "email": "updated@example.com"}&lt;/small&gt;
            &lt;/div&gt;
            
            &lt;div class="endpoint"&gt;
                &lt;span class="method"&gt;DELETE&lt;/span&gt; /api/users/:id - Delete user by ID
            &lt;/div&gt;
            
            &lt;h2&gt;🧪 Test the API&lt;/h2&gt;
            &lt;p&gt;You can test these endpoints using:&lt;/p&gt;
            &lt;ul&gt;
                &lt;li&gt;Browser (for GET requests)&lt;/li&gt;
                &lt;li&gt;Postman&lt;/li&gt;
                &lt;li&gt;Thunder Client (VS Code extension)&lt;/li&gt;
                &lt;li&gt;curl commands&lt;/li&gt;
            &lt;/ul&gt;
            
            &lt;h3&gt;Example curl commands:&lt;/h3&gt;
            &lt;pre&gt;
# Get all users
curl http://localhost:3000/api/users

# Create a user
curl -X POST http://localhost:3000/api/users \
  -H "Content-Type: application/json" \
  -d '{"name":"Alice Johnson","email":"alice@example.com"}'

# Get user by ID
curl http://localhost:3000/api/users/1

# Update user
curl -X PUT http://localhost:3000/api/users/1 \
  -H "Content-Type: application/json" \
  -d '{"name":"Alice Smith"}'

# Delete user
curl -X DELETE http://localhost:3000/api/users/1
            &lt;/pre&gt;
        &lt;/body&gt;
        &lt;/html&gt;
    `</span>);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle404</span>(<span class="hljs-params">req, res</span>) </span>{
  res.writeHead(<span class="hljs-number">404</span>);
  res.end(
    <span class="hljs-built_in">JSON</span>.stringify(
      {
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Endpoint not found"</span>,
        <span class="hljs-attr">path</span>: req.url,
        <span class="hljs-attr">method</span>: req.method,
      },
      <span class="hljs-literal">null</span>,
      <span class="hljs-number">2</span>
    )
  );
}

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
server.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🚀 Server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`📖 API documentation available at http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</div></code></pre>
<h3 id="file-server">File Server</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// file-server.js</span>
<span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">"http"</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">const</span> url = <span class="hljs-built_in">require</span>(<span class="hljs-string">"url"</span>);

<span class="hljs-comment">// MIME types for different file extensions</span>
<span class="hljs-keyword">const</span> mimeTypes = {
  <span class="hljs-string">".html"</span>: <span class="hljs-string">"text/html"</span>,
  <span class="hljs-string">".css"</span>: <span class="hljs-string">"text/css"</span>,
  <span class="hljs-string">".js"</span>: <span class="hljs-string">"text/javascript"</span>,
  <span class="hljs-string">".json"</span>: <span class="hljs-string">"application/json"</span>,
  <span class="hljs-string">".png"</span>: <span class="hljs-string">"image/png"</span>,
  <span class="hljs-string">".jpg"</span>: <span class="hljs-string">"image/jpeg"</span>,
  <span class="hljs-string">".jpeg"</span>: <span class="hljs-string">"image/jpeg"</span>,
  <span class="hljs-string">".gif"</span>: <span class="hljs-string">"image/gif"</span>,
  <span class="hljs-string">".svg"</span>: <span class="hljs-string">"image/svg+xml"</span>,
  <span class="hljs-string">".ico"</span>: <span class="hljs-string">"image/x-icon"</span>,
  <span class="hljs-string">".txt"</span>: <span class="hljs-string">"text/plain"</span>,
  <span class="hljs-string">".pdf"</span>: <span class="hljs-string">"application/pdf"</span>,
};

<span class="hljs-keyword">const</span> server = http.createServer(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> parsedUrl = url.parse(req.url);
  <span class="hljs-keyword">let</span> pathname = parsedUrl.pathname;

  <span class="hljs-comment">// Security: prevent directory traversal</span>
  pathname = path.normalize(pathname);
  <span class="hljs-keyword">if</span> (pathname.includes(<span class="hljs-string">".."</span>)) {
    res.writeHead(<span class="hljs-number">403</span>);
    res.end(<span class="hljs-string">"Forbidden: Directory traversal not allowed"</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// Default to index.html for root path</span>
  <span class="hljs-keyword">if</span> (pathname === <span class="hljs-string">"/"</span>) {
    pathname = <span class="hljs-string">"/index.html"</span>;
  }

  <span class="hljs-comment">// Construct file path</span>
  <span class="hljs-keyword">const</span> filePath = path.join(__dirname, <span class="hljs-string">"public"</span>, pathname);

  <span class="hljs-comment">// Get file extension and MIME type</span>
  <span class="hljs-keyword">const</span> ext = path.extname(filePath).toLowerCase();
  <span class="hljs-keyword">const</span> mimeType = mimeTypes[ext] || <span class="hljs-string">"application/octet-stream"</span>;

  <span class="hljs-comment">// Check if file exists</span>
  fs.access(filePath, fs.constants.F_OK, (err) =&gt; {
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-comment">// File not found</span>
      serve404(res);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// Get file stats</span>
    fs.stat(filePath, (err, stats) =&gt; {
      <span class="hljs-keyword">if</span> (err) {
        serve500(res, err);
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-comment">// Don't serve directories</span>
      <span class="hljs-keyword">if</span> (stats.isDirectory()) {
        serve403(res, <span class="hljs-string">"Directory listing not allowed"</span>);
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-comment">// Set headers</span>
      res.setHeader(<span class="hljs-string">"Content-Type"</span>, mimeType);
      res.setHeader(<span class="hljs-string">"Content-Length"</span>, stats.size);
      res.setHeader(<span class="hljs-string">"Last-Modified"</span>, stats.mtime.toUTCString());
      res.setHeader(<span class="hljs-string">"Cache-Control"</span>, <span class="hljs-string">"public, max-age=3600"</span>); <span class="hljs-comment">// Cache for 1 hour</span>

      <span class="hljs-comment">// Check if client has cached version</span>
      <span class="hljs-keyword">const</span> ifModifiedSince = req.headers[<span class="hljs-string">"if-modified-since"</span>];
      <span class="hljs-keyword">if</span> (ifModifiedSince &amp;&amp; <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(ifModifiedSince) &gt;= stats.mtime) {
        res.writeHead(<span class="hljs-number">304</span>); <span class="hljs-comment">// Not Modified</span>
        res.end();
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-comment">// Stream file to response</span>
      <span class="hljs-keyword">const</span> readStream = fs.createReadStream(filePath);

      readStream.on(<span class="hljs-string">"error"</span>, (err) =&gt; {
        serve500(res, err);
      });

      res.writeHead(<span class="hljs-number">200</span>);
      readStream.pipe(res);
    });
  });
});

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serve404</span>(<span class="hljs-params">res</span>) </span>{
  res.writeHead(<span class="hljs-number">404</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/html"</span> });
  res.end(<span class="hljs-string">`
        &lt;!DOCTYPE html&gt;
        &lt;html&gt;
        &lt;head&gt;
            &lt;title&gt;404 - Not Found&lt;/title&gt;
            &lt;style&gt;
                body { font-family: Arial, sans-serif; text-align: center; margin-top: 100px; }
                h1 { color: #e74c3c; }
            &lt;/style&gt;
        &lt;/head&gt;
        &lt;body&gt;
            &lt;h1&gt;404 - Page Not Found&lt;/h1&gt;
            &lt;p&gt;The requested resource could not be found on this server.&lt;/p&gt;
            &lt;a href="/"&gt;Go back to home&lt;/a&gt;
        &lt;/body&gt;
        &lt;/html&gt;
    `</span>);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serve403</span>(<span class="hljs-params">res, message</span>) </span>{
  res.writeHead(<span class="hljs-number">403</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/html"</span> });
  res.end(<span class="hljs-string">`
        &lt;!DOCTYPE html&gt;
        &lt;html&gt;
        &lt;head&gt;
            &lt;title&gt;403 - Forbidden&lt;/title&gt;
        &lt;/head&gt;
        &lt;body&gt;
            &lt;h1&gt;403 - Forbidden&lt;/h1&gt;
            &lt;p&gt;<span class="hljs-subst">${message}</span>&lt;/p&gt;
        &lt;/body&gt;
        &lt;/html&gt;
    `</span>);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serve500</span>(<span class="hljs-params">res, error</span>) </span>{
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Server error:"</span>, error);
  res.writeHead(<span class="hljs-number">500</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/html"</span> });
  res.end(<span class="hljs-string">`
        &lt;!DOCTYPE html&gt;
        &lt;html&gt;
        &lt;head&gt;
            &lt;title&gt;500 - Internal Server Error&lt;/title&gt;
        &lt;/head&gt;
        &lt;body&gt;
            &lt;h1&gt;500 - Internal Server Error&lt;/h1&gt;
            &lt;p&gt;Something went wrong on the server.&lt;/p&gt;
        &lt;/body&gt;
        &lt;/html&gt;
    `</span>);
}

<span class="hljs-comment">// Create public directory and sample files</span>
<span class="hljs-keyword">const</span> publicDir = path.join(__dirname, <span class="hljs-string">"public"</span>);
<span class="hljs-keyword">if</span> (!fs.existsSync(publicDir)) {
  fs.mkdirSync(publicDir);

  <span class="hljs-comment">// Create sample index.html</span>
  <span class="hljs-keyword">const</span> indexHtml = <span class="hljs-string">`
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Node.js File Server&lt;/title&gt;
    &lt;link rel="stylesheet" href="styles.css"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Welcome to Node.js File Server&lt;/h1&gt;
    &lt;p&gt;This is a static file server built with Node.js!&lt;/p&gt;
    &lt;script src="script.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
    `</span>;

  <span class="hljs-keyword">const</span> css = <span class="hljs-string">`
body {
    font-family: Arial, sans-serif;
    margin: 40px;
    background-color: #f5f5f5;
}

h1 {
    color: #333;
    text-align: center;
}

p {
    text-align: center;
    font-size: 18px;
}
    `</span>;

  <span class="hljs-keyword">const</span> js = <span class="hljs-string">`
console.log('Hello from Node.js file server!');
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded successfully!');
});
    `</span>;

  fs.writeFileSync(path.join(publicDir, <span class="hljs-string">"index.html"</span>), indexHtml);
  fs.writeFileSync(path.join(publicDir, <span class="hljs-string">"styles.css"</span>), css);
  fs.writeFileSync(path.join(publicDir, <span class="hljs-string">"script.js"</span>), js);
}

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
server.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🚀 File server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`📁 Serving files from: <span class="hljs-subst">${publicDir}</span>`</span>);
});
</div></code></pre>
<h2 id="real-world-use-case">Real-World Use Case</h2>
<h3 id="restful-api-server-with-logging">RESTful API Server with Logging</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// api-server.js</span>
<span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">"http"</span>);
<span class="hljs-keyword">const</span> url = <span class="hljs-built_in">require</span>(<span class="hljs-string">"url"</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);

<span class="hljs-comment">// Simple logging middleware</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Logger</span> </span>{
  <span class="hljs-keyword">static</span> log(req, res, startTime) {
    <span class="hljs-keyword">const</span> duration = <span class="hljs-built_in">Date</span>.now() - startTime;
    <span class="hljs-keyword">const</span> logEntry = {
      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
      <span class="hljs-attr">method</span>: req.method,
      <span class="hljs-attr">url</span>: req.url,
      <span class="hljs-attr">statusCode</span>: res.statusCode,
      <span class="hljs-attr">duration</span>: <span class="hljs-string">`<span class="hljs-subst">${duration}</span>ms`</span>,
      <span class="hljs-attr">userAgent</span>: req.headers[<span class="hljs-string">"user-agent"</span>] || <span class="hljs-string">"Unknown"</span>,
    };

    <span class="hljs-built_in">console</span>.log(
      <span class="hljs-string">`<span class="hljs-subst">${logEntry.method}</span> <span class="hljs-subst">${logEntry.url}</span> <span class="hljs-subst">${logEntry.statusCode}</span> <span class="hljs-subst">${logEntry.duration}</span>`</span>
    );

    <span class="hljs-comment">// Write to log file</span>
    <span class="hljs-keyword">const</span> logLine = <span class="hljs-built_in">JSON</span>.stringify(logEntry) + <span class="hljs-string">"\n"</span>;
    fs.appendFile(<span class="hljs-string">"access.log"</span>, logLine, (err) =&gt; {
      <span class="hljs-keyword">if</span> (err) <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Failed to write log:"</span>, err);
    });
  }
}

<span class="hljs-comment">// Simple router</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Router</span> </span>{
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.routes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>();
  }

  addRoute(method, path, handler) {
    <span class="hljs-keyword">const</span> key = <span class="hljs-string">`<span class="hljs-subst">${method.toUpperCase()}</span>:<span class="hljs-subst">${path}</span>`</span>;
    <span class="hljs-keyword">this</span>.routes.set(key, handler);
  }

  <span class="hljs-keyword">get</span>(path, handler) {
    <span class="hljs-keyword">this</span>.addRoute(<span class="hljs-string">"GET"</span>, path, handler);
  }

  post(path, handler) {
    <span class="hljs-keyword">this</span>.addRoute(<span class="hljs-string">"POST"</span>, path, handler);
  }

  put(path, handler) {
    <span class="hljs-keyword">this</span>.addRoute(<span class="hljs-string">"PUT"</span>, path, handler);
  }

  <span class="hljs-keyword">delete</span>(path, handler) {
    <span class="hljs-keyword">this</span>.addRoute(<span class="hljs-string">"DELETE"</span>, path, handler);
  }

  handle(req, res) {
    <span class="hljs-keyword">const</span> parsedUrl = url.parse(req.url, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">const</span> key = <span class="hljs-string">`<span class="hljs-subst">${req.method}</span>:<span class="hljs-subst">${parsedUrl.pathname}</span>`</span>;

    <span class="hljs-keyword">const</span> handler = <span class="hljs-keyword">this</span>.routes.get(key);
    <span class="hljs-keyword">if</span> (handler) {
      handler(req, res, parsedUrl.query);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// Try pattern matching for dynamic routes</span>
      <span class="hljs-keyword">const</span> dynamicHandler = <span class="hljs-keyword">this</span>.findDynamicRoute(
        req.method,
        parsedUrl.pathname
      );
      <span class="hljs-keyword">if</span> (dynamicHandler) {
        dynamicHandler.handler(req, res, dynamicHandler.params);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.send404(res);
      }
    }
  }

  findDynamicRoute(method, pathname) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, handler] <span class="hljs-keyword">of</span> <span class="hljs-keyword">this</span>.routes) {
      <span class="hljs-keyword">const</span> [routeMethod, routePath] = key.split(<span class="hljs-string">":"</span>);

      <span class="hljs-keyword">if</span> (routeMethod !== method) <span class="hljs-keyword">continue</span>;

      <span class="hljs-keyword">const</span> routeParts = routePath.split(<span class="hljs-string">"/"</span>);
      <span class="hljs-keyword">const</span> pathParts = pathname.split(<span class="hljs-string">"/"</span>);

      <span class="hljs-keyword">if</span> (routeParts.length !== pathParts.length) <span class="hljs-keyword">continue</span>;

      <span class="hljs-keyword">const</span> params = {};
      <span class="hljs-keyword">let</span> matches = <span class="hljs-literal">true</span>;

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; routeParts.length; i++) {
        <span class="hljs-keyword">if</span> (routeParts[i].startsWith(<span class="hljs-string">":"</span>)) {
          <span class="hljs-keyword">const</span> paramName = routeParts[i].slice(<span class="hljs-number">1</span>);
          params[paramName] = pathParts[i];
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (routeParts[i] !== pathParts[i]) {
          matches = <span class="hljs-literal">false</span>;
          <span class="hljs-keyword">break</span>;
        }
      }

      <span class="hljs-keyword">if</span> (matches) {
        <span class="hljs-keyword">return</span> { handler, params };
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }

  send404(res) {
    res.writeHead(<span class="hljs-number">404</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span> });
    res.end(<span class="hljs-built_in">JSON</span>.stringify({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Route not found"</span> }));
  }
}

<span class="hljs-comment">// Response helpers</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Response</span> </span>{
  <span class="hljs-keyword">static</span> json(res, data, statusCode = <span class="hljs-number">200</span>) {
    res.writeHead(statusCode, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span> });
    res.end(<span class="hljs-built_in">JSON</span>.stringify(data, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
  }

  <span class="hljs-keyword">static</span> error(res, message, statusCode = <span class="hljs-number">500</span>) {
    Response.json(res, { <span class="hljs-attr">error</span>: message }, statusCode);
  }
}

<span class="hljs-comment">// Request body parser</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RequestParser</span> </span>{
  <span class="hljs-keyword">static</span> parseBody(req) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">let</span> body = <span class="hljs-string">""</span>;

      req.on(<span class="hljs-string">"data"</span>, (chunk) =&gt; {
        body += chunk.toString();
      });

      req.on(<span class="hljs-string">"end"</span>, () =&gt; {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">const</span> data = body ? <span class="hljs-built_in">JSON</span>.parse(body) : {};
          resolve(data);
        } <span class="hljs-keyword">catch</span> (error) {
          reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Invalid JSON"</span>));
        }
      });

      req.on(<span class="hljs-string">"error"</span>, reject);
    });
  }
}

<span class="hljs-comment">// Data store (in production, use a real database)</span>
<span class="hljs-keyword">let</span> products = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Laptop"</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">999.99</span>, <span class="hljs-attr">category</span>: <span class="hljs-string">"Electronics"</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Book"</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">19.99</span>, <span class="hljs-attr">category</span>: <span class="hljs-string">"Education"</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Coffee Mug"</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">9.99</span>, <span class="hljs-attr">category</span>: <span class="hljs-string">"Kitchen"</span> },
];
<span class="hljs-keyword">let</span> nextId = <span class="hljs-number">4</span>;

<span class="hljs-comment">// Create router and define routes</span>
<span class="hljs-keyword">const</span> router = <span class="hljs-keyword">new</span> Router();

<span class="hljs-comment">// Health check</span>
router.get(<span class="hljs-string">"/health"</span>, (req, res) =&gt; {
  Response.json(res, {
    <span class="hljs-attr">status</span>: <span class="hljs-string">"OK"</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
    <span class="hljs-attr">uptime</span>: process.uptime(),
  });
});

<span class="hljs-comment">// Get all products</span>
router.get(<span class="hljs-string">"/api/products"</span>, (req, res, query) =&gt; {
  <span class="hljs-keyword">let</span> filteredProducts = products;

  <span class="hljs-comment">// Filter by category</span>
  <span class="hljs-keyword">if</span> (query.category) {
    filteredProducts = products.filter(
      <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.category.toLowerCase() === query.category.toLowerCase()
    );
  }

  <span class="hljs-comment">// Filter by price range</span>
  <span class="hljs-keyword">if</span> (query.minPrice) {
    <span class="hljs-keyword">const</span> minPrice = <span class="hljs-built_in">parseFloat</span>(query.minPrice);
    filteredProducts = filteredProducts.filter(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.price &gt;= minPrice);
  }

  <span class="hljs-keyword">if</span> (query.maxPrice) {
    <span class="hljs-keyword">const</span> maxPrice = <span class="hljs-built_in">parseFloat</span>(query.maxPrice);
    filteredProducts = filteredProducts.filter(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.price &lt;= maxPrice);
  }

  Response.json(res, {
    <span class="hljs-attr">products</span>: filteredProducts,
    <span class="hljs-attr">count</span>: filteredProducts.length,
  });
});

<span class="hljs-comment">// Get product by ID</span>
router.get(<span class="hljs-string">"/api/products/:id"</span>, (req, res, params) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(params.id);
  <span class="hljs-keyword">const</span> product = products.find(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id === id);

  <span class="hljs-keyword">if</span> (!product) {
    Response.error(res, <span class="hljs-string">"Product not found"</span>, <span class="hljs-number">404</span>);
    <span class="hljs-keyword">return</span>;
  }

  Response.json(res, { product });
});

<span class="hljs-comment">// Create product</span>
router.post(<span class="hljs-string">"/api/products"</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> RequestParser.parseBody(req);

    <span class="hljs-comment">// Validate required fields</span>
    <span class="hljs-keyword">if</span> (!data.name || !data.price) {
      Response.error(res, <span class="hljs-string">"Name and price are required"</span>, <span class="hljs-number">400</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> newProduct = {
      <span class="hljs-attr">id</span>: nextId++,
      <span class="hljs-attr">name</span>: data.name,
      <span class="hljs-attr">price</span>: <span class="hljs-built_in">parseFloat</span>(data.price),
      <span class="hljs-attr">category</span>: data.category || <span class="hljs-string">"Uncategorized"</span>,
    };

    products.push(newProduct);

    Response.json(
      res,
      {
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Product created successfully"</span>,
        <span class="hljs-attr">product</span>: newProduct,
      },
      <span class="hljs-number">201</span>
    );
  } <span class="hljs-keyword">catch</span> (error) {
    Response.error(res, error.message, <span class="hljs-number">400</span>);
  }
});

<span class="hljs-comment">// Update product</span>
router.put(<span class="hljs-string">"/api/products/:id"</span>, <span class="hljs-keyword">async</span> (req, res, params) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(params.id);
    <span class="hljs-keyword">const</span> productIndex = products.findIndex(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id === id);

    <span class="hljs-keyword">if</span> (productIndex === <span class="hljs-number">-1</span>) {
      Response.error(res, <span class="hljs-string">"Product not found"</span>, <span class="hljs-number">404</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> RequestParser.parseBody(req);

    <span class="hljs-comment">// Update product</span>
    products[productIndex] = {
      ...products[productIndex],
      ...data,
      id, <span class="hljs-comment">// Ensure ID doesn't change</span>
    };

    Response.json(res, {
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Product updated successfully"</span>,
      <span class="hljs-attr">product</span>: products[productIndex],
    });
  } <span class="hljs-keyword">catch</span> (error) {
    Response.error(res, error.message, <span class="hljs-number">400</span>);
  }
});

<span class="hljs-comment">// Delete product</span>
router.delete(<span class="hljs-string">"/api/products/:id"</span>, (req, res, params) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(params.id);
  <span class="hljs-keyword">const</span> productIndex = products.findIndex(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id === id);

  <span class="hljs-keyword">if</span> (productIndex === <span class="hljs-number">-1</span>) {
    Response.error(res, <span class="hljs-string">"Product not found"</span>, <span class="hljs-number">404</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">const</span> deletedProduct = products.splice(productIndex, <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>];

  Response.json(res, {
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Product deleted successfully"</span>,
    <span class="hljs-attr">product</span>: deletedProduct,
  });
});

<span class="hljs-comment">// Create server</span>
<span class="hljs-keyword">const</span> server = http.createServer(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> startTime = <span class="hljs-built_in">Date</span>.now();

  <span class="hljs-comment">// Set CORS headers</span>
  res.setHeader(<span class="hljs-string">"Access-Control-Allow-Origin"</span>, <span class="hljs-string">"*"</span>);
  res.setHeader(
    <span class="hljs-string">"Access-Control-Allow-Methods"</span>,
    <span class="hljs-string">"GET, POST, PUT, DELETE, OPTIONS"</span>
  );
  res.setHeader(<span class="hljs-string">"Access-Control-Allow-Headers"</span>, <span class="hljs-string">"Content-Type"</span>);

  <span class="hljs-comment">// Handle preflight requests</span>
  <span class="hljs-keyword">if</span> (req.method === <span class="hljs-string">"OPTIONS"</span>) {
    res.writeHead(<span class="hljs-number">200</span>);
    res.end();
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// Handle request</span>
  router.handle(req, res);

  <span class="hljs-comment">// Log request after response is sent</span>
  res.on(<span class="hljs-string">"finish"</span>, () =&gt; {
    Logger.log(req, res, startTime);
  });
});

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
server.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🚀 API Server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"📋 Available endpoints:"</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"  GET    /health"</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"  GET    /api/products"</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"  GET    /api/products/:id"</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"  POST   /api/products"</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"  PUT    /api/products/:id"</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"  DELETE /api/products/:id"</span>);
});
</div></code></pre>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-always-handle-errors">1. Always Handle Errors</h3>
<pre class="hljs"><code><div>server.on(<span class="hljs-string">"error"</span>, (error) =&gt; {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Server error:"</span>, error);
});

server.on(<span class="hljs-string">"clientError"</span>, (err, socket) =&gt; {
  socket.end(<span class="hljs-string">"HTTP/1.1 400 Bad Request\r\n\r\n"</span>);
});
</div></code></pre>
<h3 id="2-set-appropriate-headers">2. Set Appropriate Headers</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Security headers</span>
res.setHeader(<span class="hljs-string">"X-Content-Type-Options"</span>, <span class="hljs-string">"nosniff"</span>);
res.setHeader(<span class="hljs-string">"X-Frame-Options"</span>, <span class="hljs-string">"DENY"</span>);
res.setHeader(<span class="hljs-string">"X-XSS-Protection"</span>, <span class="hljs-string">"1; mode=block"</span>);

<span class="hljs-comment">// CORS headers</span>
res.setHeader(<span class="hljs-string">"Access-Control-Allow-Origin"</span>, <span class="hljs-string">"*"</span>);
res.setHeader(<span class="hljs-string">"Access-Control-Allow-Methods"</span>, <span class="hljs-string">"GET, POST, PUT, DELETE"</span>);
</div></code></pre>
<h3 id="3-validate-input">3. Validate Input</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateProductData</span>(<span class="hljs-params">data</span>) </span>{
  <span class="hljs-keyword">const</span> errors = [];

  <span class="hljs-keyword">if</span> (!data.name || <span class="hljs-keyword">typeof</span> data.name !== <span class="hljs-string">"string"</span>) {
    errors.push(<span class="hljs-string">"Name is required and must be a string"</span>);
  }

  <span class="hljs-keyword">if</span> (!data.price || <span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">parseFloat</span>(data.price))) {
    errors.push(<span class="hljs-string">"Price is required and must be a number"</span>);
  }

  <span class="hljs-keyword">return</span> errors;
}
</div></code></pre>
<h3 id="4-use-streams-for-large-data">4. Use Streams for Large Data</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// For large responses, use streams</span>
<span class="hljs-keyword">const</span> readStream = fs.createReadStream(<span class="hljs-string">"large-file.json"</span>);
res.setHeader(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/json"</span>);
readStream.pipe(res);
</div></code></pre>
<h3 id="5-implement-graceful-shutdown">5. Implement Graceful Shutdown</h3>
<pre class="hljs"><code><div>process.on(<span class="hljs-string">"SIGTERM"</span>, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Received SIGTERM, shutting down gracefully"</span>);
  server.close(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Server closed"</span>);
    process.exit(<span class="hljs-number">0</span>);
  });
});
</div></code></pre>
<h2 id="summary">Summary</h2>
<p>Creating HTTP servers with Node.js involves:</p>
<ul>
<li><strong>Basic Server</strong>: Using <code>http.createServer()</code> to handle requests and responses</li>
<li><strong>Routing</strong>: Parsing URLs and handling different endpoints</li>
<li><strong>HTTP Methods</strong>: Supporting GET, POST, PUT, DELETE operations</li>
<li><strong>Request Parsing</strong>: Handling request bodies and query parameters</li>
<li><strong>Response Formatting</strong>: Sending JSON, HTML, and file responses</li>
<li><strong>Error Handling</strong>: Proper error responses and server error handling</li>
<li><strong>Security</strong>: Setting appropriate headers and validating input</li>
</ul>
<p>Key concepts:</p>
<ul>
<li>Always handle errors gracefully</li>
<li>Set appropriate HTTP status codes</li>
<li>Use streams for large data</li>
<li>Implement proper CORS handling</li>
<li>Log requests for debugging and monitoring</li>
</ul>
<p>While building HTTP servers from scratch is educational, in production you'll typically use Express.js, which provides a much more convenient and feature-rich framework. Next, we'll explore Express.js and see how it simplifies web server development.</p>
<h1 id="introduction-to-expressjs-web-framework-for-nodejs">Introduction to Express.js: Web Framework for Node.js</h1>
<h2 id="overview">Overview</h2>
<p>Express.js is a minimal and flexible Node.js web application framework that provides a robust set of features for web and mobile applications. It simplifies the process of building web servers and APIs by providing a thin layer of fundamental web application features, without obscuring Node.js features you know and love.</p>
<h2 id="key-concepts">Key Concepts</h2>
<h3 id="what-is-expressjs">What is Express.js?</h3>
<p>Express.js is:</p>
<ul>
<li>A <strong>web framework</strong> for Node.js</li>
<li><strong>Minimalist</strong> and <strong>unopinionated</strong></li>
<li>Built on top of Node.js HTTP module</li>
<li>Provides <strong>routing</strong>, <strong>middleware</strong>, and <strong>templating</strong> capabilities</li>
<li>The most popular Node.js framework</li>
</ul>
<h3 id="core-features">Core Features</h3>
<ul>
<li><strong>Routing</strong>: Define routes for different HTTP methods and URLs</li>
<li><strong>Middleware</strong>: Functions that execute during the request-response cycle</li>
<li><strong>Template Engines</strong>: Support for various view engines (EJS, Pug, Handlebars)</li>
<li><strong>Static Files</strong>: Serve static assets like CSS, JavaScript, images</li>
<li><strong>Error Handling</strong>: Built-in error handling mechanisms</li>
</ul>
<h3 id="express-vs-raw-nodejs">Express vs Raw Node.js</h3>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Raw Node.js</th>
<th>Express.js</th>
</tr>
</thead>
<tbody>
<tr>
<td>Setup</td>
<td>Complex</td>
<td>Simple</td>
</tr>
<tr>
<td>Routing</td>
<td>Manual parsing</td>
<td>Built-in router</td>
</tr>
<tr>
<td>Middleware</td>
<td>Custom implementation</td>
<td>Rich ecosystem</td>
</tr>
<tr>
<td>Request parsing</td>
<td>Manual</td>
<td>Built-in parsers</td>
</tr>
<tr>
<td>Static files</td>
<td>Manual handling</td>
<td><code>express.static()</code></td>
</tr>
<tr>
<td>Template engines</td>
<td>Manual integration</td>
<td>Built-in support</td>
</tr>
</tbody>
</table>
<h2 id="example-code">Example Code</h2>
<h3 id="installing-express">Installing Express</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># Initialize a new project</span>
npm init -y

<span class="hljs-comment"># Install Express</span>
npm install express

<span class="hljs-comment"># Install development dependencies</span>
npm install -D nodemon
</div></code></pre>
<p>Update <code>package.json</code> scripts:</p>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"scripts"</span>: {
    <span class="hljs-attr">"start"</span>: <span class="hljs-string">"node app.js"</span>,
    <span class="hljs-attr">"dev"</span>: <span class="hljs-string">"nodemon app.js"</span>,
    <span class="hljs-attr">"test"</span>: <span class="hljs-string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>
  }
}
</div></code></pre>
<h3 id="basic-express-server">Basic Express Server</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// app.js</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);

<span class="hljs-comment">// Create Express application</span>
<span class="hljs-keyword">const</span> app = express();
<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;

<span class="hljs-comment">// Basic route</span>
app.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  res.send(<span class="hljs-string">"Hello, Express.js!"</span>);
});

<span class="hljs-comment">// JSON response</span>
app.get(<span class="hljs-string">"/api/status"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">status</span>: <span class="hljs-string">"OK"</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Express server is running"</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
  });
});

<span class="hljs-comment">// Start server</span>
app.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🚀 Express server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</div></code></pre>
<h3 id="basic-routing">Basic Routing</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// routes-basic.js</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// GET route</span>
app.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  res.send(<span class="hljs-string">"&lt;h1&gt;Welcome to Express!&lt;/h1&gt;"</span>);
});

<span class="hljs-comment">// POST route</span>
app.post(<span class="hljs-string">"/users"</span>, (req, res) =&gt; {
  res.json({ <span class="hljs-attr">message</span>: <span class="hljs-string">"User created"</span> });
});

<span class="hljs-comment">// PUT route</span>
app.put(<span class="hljs-string">"/users/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> userId = req.params.id;
  res.json({ <span class="hljs-attr">message</span>: <span class="hljs-string">`User <span class="hljs-subst">${userId}</span> updated`</span> });
});

<span class="hljs-comment">// DELETE route</span>
app.delete(<span class="hljs-string">"/users/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> userId = req.params.id;
  res.json({ <span class="hljs-attr">message</span>: <span class="hljs-string">`User <span class="hljs-subst">${userId}</span> deleted`</span> });
});

<span class="hljs-comment">// Route with multiple HTTP methods</span>
app
  .route(<span class="hljs-string">"/products"</span>)
  .get(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
    res.json({ <span class="hljs-attr">message</span>: <span class="hljs-string">"Get all products"</span> });
  })
  .post(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
    res.json({ <span class="hljs-attr">message</span>: <span class="hljs-string">"Create product"</span> });
  });

<span class="hljs-comment">// Route parameters</span>
app.get(<span class="hljs-string">"/users/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> userId = req.params.id;
  res.json({
    <span class="hljs-attr">message</span>: <span class="hljs-string">`Getting user <span class="hljs-subst">${userId}</span>`</span>,
    <span class="hljs-attr">params</span>: req.params,
  });
});

<span class="hljs-comment">// Multiple route parameters</span>
app.get(<span class="hljs-string">"/users/:userId/posts/:postId"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { userId, postId } = req.params;
  res.json({
    <span class="hljs-attr">message</span>: <span class="hljs-string">`Getting post <span class="hljs-subst">${postId}</span> from user <span class="hljs-subst">${userId}</span>`</span>,
    <span class="hljs-attr">params</span>: req.params,
  });
});

<span class="hljs-comment">// Query parameters</span>
app.get(<span class="hljs-string">"/search"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { q, page, limit } = req.query;
  res.json({
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Search results"</span>,
    <span class="hljs-attr">query</span>: q,
    <span class="hljs-attr">page</span>: page || <span class="hljs-number">1</span>,
    <span class="hljs-attr">limit</span>: limit || <span class="hljs-number">10</span>,
    <span class="hljs-attr">allQuery</span>: req.query,
  });
});

<span class="hljs-comment">// Wildcard routes</span>
app.get(<span class="hljs-string">"/files/*"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> filePath = req.params[<span class="hljs-number">0</span>];
  res.json({
    <span class="hljs-attr">message</span>: <span class="hljs-string">`Accessing file: <span class="hljs-subst">${filePath}</span>`</span>,
    <span class="hljs-attr">fullPath</span>: req.path,
  });
});

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
app.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</div></code></pre>
<h3 id="middleware-basics">Middleware Basics</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// middleware-basics.js</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Built-in middleware for parsing JSON</span>
app.use(express.json());

<span class="hljs-comment">// Built-in middleware for parsing URL-encoded data</span>
app.use(express.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> }));

<span class="hljs-comment">// Custom logging middleware</span>
app.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> timestamp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString();
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`[<span class="hljs-subst">${timestamp}</span>] <span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.path}</span>`</span>);
  next(); <span class="hljs-comment">// Pass control to the next middleware</span>
});

<span class="hljs-comment">// Authentication middleware (example)</span>
<span class="hljs-keyword">const</span> requireAuth = <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> authHeader = req.headers.authorization;

  <span class="hljs-keyword">if</span> (!authHeader) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Authorization header required"</span> });
  }

  <span class="hljs-comment">// Simple token check (in real app, verify JWT)</span>
  <span class="hljs-keyword">if</span> (authHeader !== <span class="hljs-string">"Bearer valid-token"</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Invalid token"</span> });
  }

  <span class="hljs-comment">// Add user info to request object</span>
  req.user = { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"John Doe"</span> };
  next();
};

<span class="hljs-comment">// Middleware for specific routes</span>
app.use(<span class="hljs-string">"/api/protected"</span>, requireAuth);

<span class="hljs-comment">// Request timing middleware</span>
app.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  req.startTime = <span class="hljs-built_in">Date</span>.now();

  <span class="hljs-comment">// Override res.json to add timing</span>
  <span class="hljs-keyword">const</span> originalJson = res.json;
  res.json = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{
    <span class="hljs-keyword">const</span> duration = <span class="hljs-built_in">Date</span>.now() - req.startTime;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Request completed in <span class="hljs-subst">${duration}</span>ms`</span>);
    <span class="hljs-keyword">return</span> originalJson.call(<span class="hljs-keyword">this</span>, data);
  };

  next();
});

<span class="hljs-comment">// Routes</span>
app.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  res.json({ <span class="hljs-attr">message</span>: <span class="hljs-string">"Public endpoint"</span> });
});

app.get(<span class="hljs-string">"/api/protected/profile"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Protected endpoint"</span>,
    <span class="hljs-attr">user</span>: req.user,
  });
});

app.post(<span class="hljs-string">"/api/data"</span>, (req, res) =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Request body:"</span>, req.body);
  res.json({
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Data received"</span>,
    <span class="hljs-attr">received</span>: req.body,
  });
});

<span class="hljs-comment">// Error handling middleware (must be last)</span>
app.use(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error:"</span>, err.message);
  res.status(<span class="hljs-number">500</span>).json({
    <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal server error"</span>,
    <span class="hljs-attr">message</span>: err.message,
  });
});

<span class="hljs-comment">// 404 handler (must be after all routes)</span>
app.use(<span class="hljs-string">"*"</span>, (req, res) =&gt; {
  res.status(<span class="hljs-number">404</span>).json({
    <span class="hljs-attr">error</span>: <span class="hljs-string">"Route not found"</span>,
    <span class="hljs-attr">path</span>: req.path,
    <span class="hljs-attr">method</span>: req.method,
  });
});

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
app.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</div></code></pre>
<h3 id="complete-crud-api-example">Complete CRUD API Example</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// crud-api.js</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Middleware</span>
app.use(express.json());
app.use(express.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> }));

<span class="hljs-comment">// Logging middleware</span>
app.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span> - <span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.path}</span>`</span>);
  next();
});

<span class="hljs-comment">// In-memory data store (use database in production)</span>
<span class="hljs-keyword">let</span> books = [
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">title</span>: <span class="hljs-string">"The Great Gatsby"</span>,
    <span class="hljs-attr">author</span>: <span class="hljs-string">"F. Scott Fitzgerald"</span>,
    <span class="hljs-attr">year</span>: <span class="hljs-number">1925</span>,
  },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">"To Kill a Mockingbird"</span>, <span class="hljs-attr">author</span>: <span class="hljs-string">"Harper Lee"</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">1960</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">"1984"</span>, <span class="hljs-attr">author</span>: <span class="hljs-string">"George Orwell"</span>, <span class="hljs-attr">year</span>: <span class="hljs-number">1949</span> },
];

<span class="hljs-keyword">let</span> nextId = <span class="hljs-number">4</span>;

<span class="hljs-comment">// Validation middleware</span>
<span class="hljs-keyword">const</span> validateBook = <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { title, author, year } = req.body;
  <span class="hljs-keyword">const</span> errors = [];

  <span class="hljs-keyword">if</span> (!title || <span class="hljs-keyword">typeof</span> title !== <span class="hljs-string">"string"</span> || title.trim().length === <span class="hljs-number">0</span>) {
    errors.push(<span class="hljs-string">"Title is required and must be a non-empty string"</span>);
  }

  <span class="hljs-keyword">if</span> (!author || <span class="hljs-keyword">typeof</span> author !== <span class="hljs-string">"string"</span> || author.trim().length === <span class="hljs-number">0</span>) {
    errors.push(<span class="hljs-string">"Author is required and must be a non-empty string"</span>);
  }

  <span class="hljs-keyword">if</span> (
    !year ||
    !<span class="hljs-built_in">Number</span>.isInteger(year) ||
    year &lt; <span class="hljs-number">0</span> ||
    year &gt; <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getFullYear()
  ) {
    errors.push(<span class="hljs-string">"Year must be a valid integer between 0 and current year"</span>);
  }

  <span class="hljs-keyword">if</span> (errors.length &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      errors,
    });
  }

  next();
};

<span class="hljs-comment">// Routes</span>

<span class="hljs-comment">// Home page</span>
app.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  res.send(<span class="hljs-string">`
        &lt;h1&gt;📚 Books API&lt;/h1&gt;
        &lt;p&gt;Welcome to the Books API built with Express.js!&lt;/p&gt;
        &lt;h2&gt;Available Endpoints:&lt;/h2&gt;
        &lt;ul&gt;
            &lt;li&gt;&lt;strong&gt;GET&lt;/strong&gt; /api/books - Get all books&lt;/li&gt;
            &lt;li&gt;&lt;strong&gt;GET&lt;/strong&gt; /api/books/:id - Get book by ID&lt;/li&gt;
            &lt;li&gt;&lt;strong&gt;POST&lt;/strong&gt; /api/books - Create a new book&lt;/li&gt;
            &lt;li&gt;&lt;strong&gt;PUT&lt;/strong&gt; /api/books/:id - Update book by ID&lt;/li&gt;
            &lt;li&gt;&lt;strong&gt;DELETE&lt;/strong&gt; /api/books/:id - Delete book by ID&lt;/li&gt;
        &lt;/ul&gt;
        &lt;h2&gt;Example Usage:&lt;/h2&gt;
        &lt;pre&gt;
# Get all books
curl http://localhost:3000/api/books

# Create a book
curl -X POST http://localhost:3000/api/books \
  -H "Content-Type: application/json" \
  -d '{"title":"Brave New World","author":"Aldous Huxley","year":1932}'
        &lt;/pre&gt;
    `</span>);
});

<span class="hljs-comment">// GET /api/books - Get all books</span>
app.get(<span class="hljs-string">"/api/books"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { author, year, search } = req.query;
  <span class="hljs-keyword">let</span> filteredBooks = books;

  <span class="hljs-comment">// Filter by author</span>
  <span class="hljs-keyword">if</span> (author) {
    filteredBooks = filteredBooks.filter(<span class="hljs-function">(<span class="hljs-params">book</span>) =&gt;</span>
      book.author.toLowerCase().includes(author.toLowerCase())
    );
  }

  <span class="hljs-comment">// Filter by year</span>
  <span class="hljs-keyword">if</span> (year) {
    filteredBooks = filteredBooks.filter(
      <span class="hljs-function">(<span class="hljs-params">book</span>) =&gt;</span> book.year === <span class="hljs-built_in">parseInt</span>(year)
    );
  }

  <span class="hljs-comment">// Search in title or author</span>
  <span class="hljs-keyword">if</span> (search) {
    filteredBooks = filteredBooks.filter(
      <span class="hljs-function">(<span class="hljs-params">book</span>) =&gt;</span>
        book.title.toLowerCase().includes(search.toLowerCase()) ||
        book.author.toLowerCase().includes(search.toLowerCase())
    );
  }

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">count</span>: filteredBooks.length,
    <span class="hljs-attr">data</span>: filteredBooks,
  });
});

<span class="hljs-comment">// GET /api/books/:id - Get book by ID</span>
app.get(<span class="hljs-string">"/api/books/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(req.params.id);

  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(id)) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Invalid book ID"</span>,
    });
  }

  <span class="hljs-keyword">const</span> book = books.find(<span class="hljs-function">(<span class="hljs-params">b</span>) =&gt;</span> b.id === id);

  <span class="hljs-keyword">if</span> (!book) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Book not found"</span>,
    });
  }

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: book,
  });
});

<span class="hljs-comment">// POST /api/books - Create new book</span>
app.post(<span class="hljs-string">"/api/books"</span>, validateBook, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { title, author, year } = req.body;

  <span class="hljs-comment">// Check if book already exists</span>
  <span class="hljs-keyword">const</span> existingBook = books.find(
    <span class="hljs-function">(<span class="hljs-params">b</span>) =&gt;</span>
      b.title.toLowerCase() === title.toLowerCase() &amp;&amp;
      b.author.toLowerCase() === author.toLowerCase()
  );

  <span class="hljs-keyword">if</span> (existingBook) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">409</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Book with this title and author already exists"</span>,
    });
  }

  <span class="hljs-keyword">const</span> newBook = {
    <span class="hljs-attr">id</span>: nextId++,
    <span class="hljs-attr">title</span>: title.trim(),
    <span class="hljs-attr">author</span>: author.trim(),
    year,
  };

  books.push(newBook);

  res.status(<span class="hljs-number">201</span>).json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Book created successfully"</span>,
    <span class="hljs-attr">data</span>: newBook,
  });
});

<span class="hljs-comment">// PUT /api/books/:id - Update book</span>
app.put(<span class="hljs-string">"/api/books/:id"</span>, validateBook, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(req.params.id);

  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(id)) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Invalid book ID"</span>,
    });
  }

  <span class="hljs-keyword">const</span> bookIndex = books.findIndex(<span class="hljs-function">(<span class="hljs-params">b</span>) =&gt;</span> b.id === id);

  <span class="hljs-keyword">if</span> (bookIndex === <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Book not found"</span>,
    });
  }

  <span class="hljs-keyword">const</span> { title, author, year } = req.body;

  <span class="hljs-comment">// Update book</span>
  books[bookIndex] = {
    id,
    <span class="hljs-attr">title</span>: title.trim(),
    <span class="hljs-attr">author</span>: author.trim(),
    year,
  };

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Book updated successfully"</span>,
    <span class="hljs-attr">data</span>: books[bookIndex],
  });
});

<span class="hljs-comment">// DELETE /api/books/:id - Delete book</span>
app.delete(<span class="hljs-string">"/api/books/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(req.params.id);

  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(id)) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Invalid book ID"</span>,
    });
  }

  <span class="hljs-keyword">const</span> bookIndex = books.findIndex(<span class="hljs-function">(<span class="hljs-params">b</span>) =&gt;</span> b.id === id);

  <span class="hljs-keyword">if</span> (bookIndex === <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Book not found"</span>,
    });
  }

  <span class="hljs-keyword">const</span> deletedBook = books.splice(bookIndex, <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>];

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Book deleted successfully"</span>,
    <span class="hljs-attr">data</span>: deletedBook,
  });
});

<span class="hljs-comment">// Health check endpoint</span>
app.get(<span class="hljs-string">"/health"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">status</span>: <span class="hljs-string">"OK"</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
    <span class="hljs-attr">uptime</span>: process.uptime(),
    <span class="hljs-attr">memory</span>: process.memoryUsage(),
    <span class="hljs-attr">booksCount</span>: books.length,
  });
});

<span class="hljs-comment">// Error handling middleware</span>
app.use(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error:"</span>, err.stack);
  res.status(<span class="hljs-number">500</span>).json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal server error"</span>,
  });
});

<span class="hljs-comment">// 404 handler</span>
app.use(<span class="hljs-string">"*"</span>, (req, res) =&gt; {
  res.status(<span class="hljs-number">404</span>).json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">error</span>: <span class="hljs-string">"Endpoint not found"</span>,
    <span class="hljs-attr">path</span>: req.originalUrl,
    <span class="hljs-attr">method</span>: req.method,
  });
});

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
app.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🚀 Books API server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`📖 API documentation available at http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</div></code></pre>
<h2 id="real-world-use-case">Real-World Use Case</h2>
<h3 id="express-server-with-environment-configuration">Express Server with Environment Configuration</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// server.js</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);

<span class="hljs-comment">// Environment configuration</span>
<span class="hljs-keyword">const</span> config = {
  <span class="hljs-attr">port</span>: process.env.PORT || <span class="hljs-number">3000</span>,
  <span class="hljs-attr">nodeEnv</span>: process.env.NODE_ENV || <span class="hljs-string">"development"</span>,
  <span class="hljs-attr">apiPrefix</span>: process.env.API_PREFIX || <span class="hljs-string">"/api/v1"</span>,
};

<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Middleware setup based on environment</span>
<span class="hljs-keyword">if</span> (config.nodeEnv === <span class="hljs-string">"development"</span>) {
  <span class="hljs-comment">// Development-specific middleware</span>
  app.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`[DEV] <span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.path}</span>`</span>);
    next();
  });
}

<span class="hljs-comment">// Global middleware</span>
app.use(express.json({ <span class="hljs-attr">limit</span>: <span class="hljs-string">"10mb"</span> }));
app.use(express.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">limit</span>: <span class="hljs-string">"10mb"</span> }));

<span class="hljs-comment">// Security headers</span>
app.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  res.setHeader(<span class="hljs-string">"X-Content-Type-Options"</span>, <span class="hljs-string">"nosniff"</span>);
  res.setHeader(<span class="hljs-string">"X-Frame-Options"</span>, <span class="hljs-string">"DENY"</span>);
  res.setHeader(<span class="hljs-string">"X-XSS-Protection"</span>, <span class="hljs-string">"1; mode=block"</span>);
  next();
});

<span class="hljs-comment">// API routes</span>
<span class="hljs-keyword">const</span> apiRouter = express.Router();

apiRouter.get(<span class="hljs-string">"/status"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">status</span>: <span class="hljs-string">"OK"</span>,
    <span class="hljs-attr">environment</span>: config.nodeEnv,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
    <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
  });
});

apiRouter.get(<span class="hljs-string">"/info"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">app</span>: <span class="hljs-string">"Express.js API"</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
    <span class="hljs-attr">environment</span>: config.nodeEnv,
    <span class="hljs-attr">node</span>: process.version,
    <span class="hljs-attr">platform</span>: process.platform,
    <span class="hljs-attr">uptime</span>: process.uptime(),
  });
});

<span class="hljs-comment">// Mount API routes</span>
app.use(config.apiPrefix, apiRouter);

<span class="hljs-comment">// Serve static files in production</span>
<span class="hljs-keyword">if</span> (config.nodeEnv === <span class="hljs-string">"production"</span>) {
  app.use(express.static(path.join(__dirname, <span class="hljs-string">"public"</span>)));

  <span class="hljs-comment">// Catch-all handler for SPA</span>
  app.get(<span class="hljs-string">"*"</span>, (req, res) =&gt; {
    res.sendFile(path.join(__dirname, <span class="hljs-string">"public"</span>, <span class="hljs-string">"index.html"</span>));
  });
}

<span class="hljs-comment">// Development route</span>
<span class="hljs-keyword">if</span> (config.nodeEnv === <span class="hljs-string">"development"</span>) {
  app.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
    res.send(<span class="hljs-string">`
            &lt;h1&gt;Express.js Development Server&lt;/h1&gt;
            &lt;p&gt;Environment: <span class="hljs-subst">${config.nodeEnv}</span>&lt;/p&gt;
            &lt;p&gt;API Base URL: &lt;a href="<span class="hljs-subst">${config.apiPrefix}</span>"&gt;<span class="hljs-subst">${config.apiPrefix}</span>&lt;/a&gt;&lt;/p&gt;
            &lt;ul&gt;
                &lt;li&gt;&lt;a href="<span class="hljs-subst">${config.apiPrefix}</span>/status"&gt;Status&lt;/a&gt;&lt;/li&gt;
                &lt;li&gt;&lt;a href="<span class="hljs-subst">${config.apiPrefix}</span>/info"&gt;Info&lt;/a&gt;&lt;/li&gt;
            &lt;/ul&gt;
        `</span>);
  });
}

<span class="hljs-comment">// Error handling</span>
app.use(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error:"</span>, err.stack);

  <span class="hljs-keyword">const</span> errorResponse = {
    <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal server error"</span>,
  };

  <span class="hljs-comment">// Include stack trace in development</span>
  <span class="hljs-keyword">if</span> (config.nodeEnv === <span class="hljs-string">"development"</span>) {
    errorResponse.stack = err.stack;
  }

  res.status(<span class="hljs-number">500</span>).json(errorResponse);
});

<span class="hljs-comment">// 404 handler</span>
app.use(<span class="hljs-string">"*"</span>, (req, res) =&gt; {
  res.status(<span class="hljs-number">404</span>).json({
    <span class="hljs-attr">error</span>: <span class="hljs-string">"Not found"</span>,
    <span class="hljs-attr">path</span>: req.originalUrl,
  });
});

<span class="hljs-comment">// Graceful shutdown</span>
process.on(<span class="hljs-string">"SIGTERM"</span>, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Received SIGTERM, shutting down gracefully"</span>);
  server.close(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Server closed"</span>);
    process.exit(<span class="hljs-number">0</span>);
  });
});

<span class="hljs-keyword">const</span> server = app.listen(config.port, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🚀 Express server running on http://localhost:<span class="hljs-subst">${config.port}</span>`</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`📊 Environment: <span class="hljs-subst">${config.nodeEnv}</span>`</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🔗 API Base URL: <span class="hljs-subst">${config.apiPrefix}</span>`</span>);
});

<span class="hljs-built_in">module</span>.exports = app;
</div></code></pre>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-project-structure">1. Project Structure</h3>
<pre class="hljs"><code><div>project/
├── app.js              # Main application file
├── routes/             # Route definitions
│   ├── index.js
│   ├── users.js
│   └── products.js
├── middleware/         # Custom middleware
│   ├── auth.js
│   └── validation.js
├── controllers/        # Route handlers
│   ├── userController.js
│   └── productController.js
├── models/            # Data models
├── config/            # Configuration files
├── public/            # Static files
└── views/             # Template files
</div></code></pre>
<h3 id="2-environment-variables">2. Environment Variables</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Use environment variables for configuration</span>
<span class="hljs-keyword">const</span> config = {
  <span class="hljs-attr">port</span>: process.env.PORT || <span class="hljs-number">3000</span>,
  <span class="hljs-attr">dbUrl</span>: process.env.DATABASE_URL || <span class="hljs-string">"mongodb://localhost:27017/myapp"</span>,
  <span class="hljs-attr">jwtSecret</span>: process.env.JWT_SECRET || <span class="hljs-string">"fallback-secret"</span>,
  <span class="hljs-attr">nodeEnv</span>: process.env.NODE_ENV || <span class="hljs-string">"development"</span>,
};
</div></code></pre>
<h3 id="3-error-handling">3. Error Handling</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Async error wrapper</span>
<span class="hljs-keyword">const</span> asyncHandler = <span class="hljs-function">(<span class="hljs-params">fn</span>) =&gt;</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">Promise</span>.resolve(fn(req, res, next)).catch(next);
};

<span class="hljs-comment">// Usage</span>
app.get(
  <span class="hljs-string">"/api/users"</span>,
  asyncHandler(<span class="hljs-keyword">async</span> (req, res) =&gt; {
    <span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> User.find();
    res.json(users);
  })
);
</div></code></pre>
<h3 id="4-input-validation">4. Input Validation</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Validation middleware</span>
<span class="hljs-keyword">const</span> validateUser = <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { name, email } = req.body;

  <span class="hljs-keyword">if</span> (!name || name.length &lt; <span class="hljs-number">2</span>) {
    <span class="hljs-keyword">return</span> res
      .status(<span class="hljs-number">400</span>)
      .json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Name must be at least 2 characters"</span> });
  }

  <span class="hljs-keyword">if</span> (!email || !email.includes(<span class="hljs-string">"@"</span>)) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Valid email is required"</span> });
  }

  next();
};
</div></code></pre>
<h3 id="5-security-headers">5. Security Headers</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Security middleware</span>
app.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  res.setHeader(<span class="hljs-string">"X-Content-Type-Options"</span>, <span class="hljs-string">"nosniff"</span>);
  res.setHeader(<span class="hljs-string">"X-Frame-Options"</span>, <span class="hljs-string">"DENY"</span>);
  res.setHeader(<span class="hljs-string">"X-XSS-Protection"</span>, <span class="hljs-string">"1; mode=block"</span>);
  res.setHeader(<span class="hljs-string">"Strict-Transport-Security"</span>, <span class="hljs-string">"max-age=31536000"</span>);
  next();
});
</div></code></pre>
<h2 id="summary">Summary</h2>
<p>Express.js simplifies Node.js web development by providing:</p>
<ul>
<li><strong>Simple Setup</strong>: Minimal boilerplate code to get started</li>
<li><strong>Powerful Routing</strong>: Easy route definition with parameters and query strings</li>
<li><strong>Middleware System</strong>: Modular request processing pipeline</li>
<li><strong>Built-in Parsers</strong>: JSON and URL-encoded body parsing</li>
<li><strong>Static File Serving</strong>: Easy static asset serving</li>
<li><strong>Error Handling</strong>: Centralized error handling mechanisms</li>
</ul>
<p>Key advantages over raw Node.js:</p>
<ul>
<li>Less boilerplate code</li>
<li>Better organization and structure</li>
<li>Rich ecosystem of middleware</li>
<li>Simplified request/response handling</li>
<li>Built-in routing system</li>
</ul>
<p>Express.js strikes the perfect balance between simplicity and functionality, making it the go-to choice for Node.js web applications. Next, we'll dive deeper into handling request and response objects, exploring all the methods and properties available for building robust web applications.</p>
<h1 id="handling-request-and-response-objects-in-expressjs">Handling Request and Response Objects in Express.js</h1>
<h2 id="overview">Overview</h2>
<p>The request (<code>req</code>) and response (<code>res</code>) objects are the heart of Express.js applications. They provide access to HTTP request data and methods to send responses back to clients. Understanding these objects thoroughly is crucial for building robust web applications and APIs.</p>
<h2 id="key-concepts">Key Concepts</h2>
<h3 id="request-object-req">Request Object (req)</h3>
<p>The request object represents the HTTP request and contains properties for:</p>
<ul>
<li>Request parameters, query strings, and body</li>
<li>HTTP headers and cookies</li>
<li>Request method and URL information</li>
<li>User agent and IP address</li>
<li>File uploads and form data</li>
</ul>
<h3 id="response-object-res">Response Object (res)</h3>
<p>The response object represents the HTTP response and provides methods to:</p>
<ul>
<li>Send different types of responses (JSON, HTML, files)</li>
<li>Set HTTP status codes and headers</li>
<li>Handle cookies and redirects</li>
<li>Stream data and handle errors</li>
</ul>
<h3 id="request-response-cycle">Request-Response Cycle</h3>
<ol>
<li>Client sends HTTP request</li>
<li>Express creates <code>req</code> and <code>res</code> objects</li>
<li>Middleware and route handlers process the request</li>
<li>Response is sent back to client</li>
<li>Connection is closed (unless keep-alive)</li>
</ol>
<h2 id="example-code">Example Code</h2>
<h3 id="request-object-properties-and-methods">Request Object Properties and Methods</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// request-examples.js</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Middleware to parse JSON and URL-encoded data</span>
app.use(express.json());
app.use(express.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> }));

<span class="hljs-comment">// Comprehensive request information endpoint</span>
app.all(<span class="hljs-string">"/request-info"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> requestInfo = {
    <span class="hljs-comment">// Basic request information</span>
    <span class="hljs-attr">method</span>: req.method,
    <span class="hljs-attr">url</span>: req.url,
    <span class="hljs-attr">originalUrl</span>: req.originalUrl,
    <span class="hljs-attr">path</span>: req.path,
    <span class="hljs-attr">protocol</span>: req.protocol,
    <span class="hljs-attr">secure</span>: req.secure,

    <span class="hljs-comment">// Headers</span>
    <span class="hljs-attr">headers</span>: req.headers,
    <span class="hljs-attr">userAgent</span>: req.get(<span class="hljs-string">"User-Agent"</span>),
    <span class="hljs-attr">contentType</span>: req.get(<span class="hljs-string">"Content-Type"</span>),
    <span class="hljs-attr">authorization</span>: req.get(<span class="hljs-string">"Authorization"</span>),

    <span class="hljs-comment">// Network information</span>
    <span class="hljs-attr">ip</span>: req.ip,
    <span class="hljs-attr">ips</span>: req.ips,
    <span class="hljs-attr">hostname</span>: req.hostname,

    <span class="hljs-comment">// Parameters and query</span>
    <span class="hljs-attr">params</span>: req.params,
    <span class="hljs-attr">query</span>: req.query,
    <span class="hljs-attr">body</span>: req.body,

    <span class="hljs-comment">// Request properties</span>
    <span class="hljs-attr">fresh</span>: req.fresh,
    <span class="hljs-attr">stale</span>: req.stale,
    <span class="hljs-attr">xhr</span>: req.xhr, <span class="hljs-comment">// Is AJAX request</span>

    <span class="hljs-comment">// Cookies (if cookie-parser middleware is used)</span>
    <span class="hljs-attr">cookies</span>: req.cookies || <span class="hljs-string">"No cookie parser middleware"</span>,
    <span class="hljs-attr">signedCookies</span>: req.signedCookies || <span class="hljs-string">"No cookie parser middleware"</span>,
  };

  res.json(requestInfo);
});

<span class="hljs-comment">// Route parameters examples</span>
app.get(<span class="hljs-string">"/users/:userId"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> userId = req.params.userId;

  res.json({
    <span class="hljs-attr">message</span>: <span class="hljs-string">`Getting user <span class="hljs-subst">${userId}</span>`</span>,
    <span class="hljs-attr">params</span>: req.params,
    <span class="hljs-attr">paramType</span>: <span class="hljs-keyword">typeof</span> userId, <span class="hljs-comment">// Always string</span>
  });
});

<span class="hljs-comment">// Multiple parameters</span>
app.get(<span class="hljs-string">"/users/:userId/posts/:postId"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { userId, postId } = req.params;

  res.json({
    <span class="hljs-attr">message</span>: <span class="hljs-string">`Getting post <span class="hljs-subst">${postId}</span> from user <span class="hljs-subst">${userId}</span>`</span>,
    <span class="hljs-attr">userId</span>: <span class="hljs-built_in">parseInt</span>(userId), <span class="hljs-comment">// Convert to number if needed</span>
    <span class="hljs-attr">postId</span>: <span class="hljs-built_in">parseInt</span>(postId),
    <span class="hljs-attr">allParams</span>: req.params,
  });
});

<span class="hljs-comment">// Query parameters</span>
app.get(<span class="hljs-string">"/search"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> {
    q, <span class="hljs-comment">// Search query</span>
    page = <span class="hljs-number">1</span>, <span class="hljs-comment">// Default value</span>
    limit = <span class="hljs-number">10</span>, <span class="hljs-comment">// Default value</span>
    sort, <span class="hljs-comment">// Optional</span>
    filter, <span class="hljs-comment">// Optional</span>
  } = req.query;

  <span class="hljs-comment">// Convert string parameters to appropriate types</span>
  <span class="hljs-keyword">const</span> pageNum = <span class="hljs-built_in">parseInt</span>(page);
  <span class="hljs-keyword">const</span> limitNum = <span class="hljs-built_in">parseInt</span>(limit);

  <span class="hljs-comment">// Validate parameters</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(pageNum) || pageNum &lt; <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Page must be a positive integer"</span> });
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(limitNum) || limitNum &lt; <span class="hljs-number">1</span> || limitNum &gt; <span class="hljs-number">100</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Limit must be between 1 and 100"</span> });
  }

  res.json({
    <span class="hljs-attr">searchQuery</span>: q,
    <span class="hljs-attr">pagination</span>: {
      <span class="hljs-attr">page</span>: pageNum,
      <span class="hljs-attr">limit</span>: limitNum,
      <span class="hljs-attr">offset</span>: (pageNum - <span class="hljs-number">1</span>) * limitNum,
    },
    <span class="hljs-attr">sorting</span>: sort,
    <span class="hljs-attr">filters</span>: filter,
    <span class="hljs-attr">allQuery</span>: req.query,
  });
});

<span class="hljs-comment">// Request body handling</span>
app.post(<span class="hljs-string">"/data"</span>, (req, res) =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Request body:"</span>, req.body);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Content-Type:"</span>, req.get(<span class="hljs-string">"Content-Type"</span>));

  <span class="hljs-comment">// Validate request body</span>
  <span class="hljs-keyword">if</span> (!req.body || <span class="hljs-built_in">Object</span>.keys(req.body).length === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Request body is required"</span> });
  }

  res.json({
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Data received successfully"</span>,
    <span class="hljs-attr">receivedData</span>: req.body,
    <span class="hljs-attr">dataType</span>: <span class="hljs-keyword">typeof</span> req.body,
    <span class="hljs-attr">contentLength</span>: req.get(<span class="hljs-string">"Content-Length"</span>),
  });
});

<span class="hljs-comment">// Header inspection</span>
app.get(<span class="hljs-string">"/headers"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> importantHeaders = {
    <span class="hljs-attr">userAgent</span>: req.get(<span class="hljs-string">"User-Agent"</span>),
    <span class="hljs-attr">accept</span>: req.get(<span class="hljs-string">"Accept"</span>),
    <span class="hljs-attr">acceptLanguage</span>: req.get(<span class="hljs-string">"Accept-Language"</span>),
    <span class="hljs-attr">acceptEncoding</span>: req.get(<span class="hljs-string">"Accept-Encoding"</span>),
    <span class="hljs-attr">connection</span>: req.get(<span class="hljs-string">"Connection"</span>),
    <span class="hljs-attr">host</span>: req.get(<span class="hljs-string">"Host"</span>),
    <span class="hljs-attr">referer</span>: req.get(<span class="hljs-string">"Referer"</span>),
    <span class="hljs-attr">origin</span>: req.get(<span class="hljs-string">"Origin"</span>),
  };

  res.json({
    importantHeaders,
    <span class="hljs-attr">allHeaders</span>: req.headers,
    <span class="hljs-attr">headerCount</span>: <span class="hljs-built_in">Object</span>.keys(req.headers).length,
  });
});

<span class="hljs-comment">// Content negotiation</span>
app.get(<span class="hljs-string">"/content-negotiation"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> acceptsJson = req.accepts(<span class="hljs-string">"json"</span>);
  <span class="hljs-keyword">const</span> acceptsHtml = req.accepts(<span class="hljs-string">"html"</span>);
  <span class="hljs-keyword">const</span> acceptsXml = req.accepts(<span class="hljs-string">"xml"</span>);

  res.json({
    <span class="hljs-attr">clientAccepts</span>: {
      <span class="hljs-attr">json</span>: !!acceptsJson,
      <span class="hljs-attr">html</span>: !!acceptsHtml,
      <span class="hljs-attr">xml</span>: !!acceptsXml,
    },
    <span class="hljs-attr">acceptHeader</span>: req.get(<span class="hljs-string">"Accept"</span>),
    <span class="hljs-attr">preferredType</span>: req.accepts([<span class="hljs-string">"json"</span>, <span class="hljs-string">"html"</span>, <span class="hljs-string">"xml"</span>]),
  });
});

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
app.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</div></code></pre>
<h3 id="response-object-methods">Response Object Methods</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// response-examples.js</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">const</span> app = express();

app.use(express.json());

<span class="hljs-comment">// Basic response methods</span>
app.get(<span class="hljs-string">"/response-types"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> type = req.query.type;

  <span class="hljs-keyword">switch</span> (type) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"json"</span>:
      res.json({ <span class="hljs-attr">message</span>: <span class="hljs-string">"JSON response"</span>, <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() });
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"text"</span>:
      res.send(<span class="hljs-string">"Plain text response"</span>);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"html"</span>:
      res.send(<span class="hljs-string">"&lt;h1&gt;HTML Response&lt;/h1&gt;&lt;p&gt;This is HTML content&lt;/p&gt;"</span>);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"status"</span>:
      res.status(<span class="hljs-number">201</span>).json({ <span class="hljs-attr">message</span>: <span class="hljs-string">"Created successfully"</span> });
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">default</span>:
      res.json({
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Specify type parameter"</span>,
        <span class="hljs-attr">availableTypes</span>: [<span class="hljs-string">"json"</span>, <span class="hljs-string">"text"</span>, <span class="hljs-string">"html"</span>, <span class="hljs-string">"status"</span>],
      });
  }
});

<span class="hljs-comment">// Status codes</span>
app.get(<span class="hljs-string">"/status/:code"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> statusCode = <span class="hljs-built_in">parseInt</span>(req.params.code);

  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(statusCode) || statusCode &lt; <span class="hljs-number">100</span> || statusCode &gt; <span class="hljs-number">599</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Invalid status code"</span> });
  }

  res.status(statusCode).json({
    statusCode,
    <span class="hljs-attr">message</span>: getStatusMessage(statusCode),
  });
});

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getStatusMessage</span>(<span class="hljs-params">code</span>) </span>{
  <span class="hljs-keyword">const</span> messages = {
    <span class="hljs-number">200</span>: <span class="hljs-string">"OK"</span>,
    <span class="hljs-number">201</span>: <span class="hljs-string">"Created"</span>,
    <span class="hljs-number">400</span>: <span class="hljs-string">"Bad Request"</span>,
    <span class="hljs-number">401</span>: <span class="hljs-string">"Unauthorized"</span>,
    <span class="hljs-number">403</span>: <span class="hljs-string">"Forbidden"</span>,
    <span class="hljs-number">404</span>: <span class="hljs-string">"Not Found"</span>,
    <span class="hljs-number">500</span>: <span class="hljs-string">"Internal Server Error"</span>,
  };
  <span class="hljs-keyword">return</span> messages[code] || <span class="hljs-string">"Unknown Status"</span>;
}

<span class="hljs-comment">// Headers manipulation</span>
app.get(<span class="hljs-string">"/headers-demo"</span>, (req, res) =&gt; {
  <span class="hljs-comment">// Set individual headers</span>
  res.set(<span class="hljs-string">"X-Custom-Header"</span>, <span class="hljs-string">"Custom Value"</span>);
  res.set(<span class="hljs-string">"X-API-Version"</span>, <span class="hljs-string">"1.0.0"</span>);

  <span class="hljs-comment">// Set multiple headers at once</span>
  res.set({
    <span class="hljs-string">"X-Response-Time"</span>: <span class="hljs-built_in">Date</span>.now(),
    <span class="hljs-string">"X-Server"</span>: <span class="hljs-string">"Express.js"</span>,
    <span class="hljs-string">"Cache-Control"</span>: <span class="hljs-string">"no-cache"</span>,
  });

  <span class="hljs-comment">// Get header value</span>
  <span class="hljs-keyword">const</span> customHeader = res.get(<span class="hljs-string">"X-Custom-Header"</span>);

  res.json({
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Headers set successfully"</span>,
    <span class="hljs-attr">customHeaderValue</span>: customHeader,
    <span class="hljs-attr">allHeaders</span>: res.getHeaders(),
  });
});

<span class="hljs-comment">// Content-Type examples</span>
app.get(<span class="hljs-string">"/content-types/:type"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> type = req.params.type;

  <span class="hljs-keyword">switch</span> (type) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"json"</span>:
      res.type(<span class="hljs-string">"json"</span>).send(<span class="hljs-built_in">JSON</span>.stringify({ <span class="hljs-attr">message</span>: <span class="hljs-string">"JSON content"</span> }));
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"xml"</span>:
      res
        .type(<span class="hljs-string">"xml"</span>)
        .send(<span class="hljs-string">'&lt;?xml version="1.0"?&gt;&lt;message&gt;XML content&lt;/message&gt;'</span>);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"plain"</span>:
      res.type(<span class="hljs-string">"txt"</span>).send(<span class="hljs-string">"Plain text content"</span>);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"html"</span>:
      res.type(<span class="hljs-string">"html"</span>).send(<span class="hljs-string">"&lt;h1&gt;HTML Content&lt;/h1&gt;"</span>);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">default</span>:
      res.json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Unknown content type"</span> });
  }
});

<span class="hljs-comment">// Redirects</span>
app.get(<span class="hljs-string">"/redirect-demo/:type"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> type = req.params.type;

  <span class="hljs-keyword">switch</span> (type) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"permanent"</span>:
      res.redirect(<span class="hljs-number">301</span>, <span class="hljs-string">"/redirected"</span>);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"temporary"</span>:
      res.redirect(<span class="hljs-number">302</span>, <span class="hljs-string">"/redirected"</span>);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"back"</span>:
      res.redirect(<span class="hljs-string">"back"</span>); <span class="hljs-comment">// Redirect to referer or '/'</span>
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">default</span>:
      res.redirect(<span class="hljs-string">"/redirected"</span>); <span class="hljs-comment">// Default 302</span>
  }
});

app.get(<span class="hljs-string">"/redirected"</span>, (req, res) =&gt; {
  res.json({ <span class="hljs-attr">message</span>: <span class="hljs-string">"You have been redirected!"</span> });
});

<span class="hljs-comment">// File downloads</span>
app.get(<span class="hljs-string">"/download/:filename"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> filename = req.params.filename;
  <span class="hljs-keyword">const</span> filePath = path.join(__dirname, <span class="hljs-string">"downloads"</span>, filename);

  <span class="hljs-comment">// Check if file exists</span>
  <span class="hljs-keyword">if</span> (!fs.existsSync(filePath)) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"File not found"</span> });
  }

  <span class="hljs-comment">// Download with original filename</span>
  res.download(filePath, (err) =&gt; {
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Download error:"</span>, err);
      <span class="hljs-keyword">if</span> (!res.headersSent) {
        res.status(<span class="hljs-number">500</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Download failed"</span> });
      }
    }
  });
});

<span class="hljs-comment">// File sending</span>
app.get(<span class="hljs-string">"/file/:filename"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> filename = req.params.filename;
  <span class="hljs-keyword">const</span> filePath = path.join(__dirname, <span class="hljs-string">"files"</span>, filename);

  res.sendFile(filePath, (err) =&gt; {
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Send file error:"</span>, err);
      <span class="hljs-keyword">if</span> (!res.headersSent) {
        res.status(<span class="hljs-number">404</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"File not found"</span> });
      }
    }
  });
});

<span class="hljs-comment">// Streaming responses</span>
app.get(<span class="hljs-string">"/stream"</span>, (req, res) =&gt; {
  res.writeHead(<span class="hljs-number">200</span>, {
    <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/plain"</span>,
    <span class="hljs-string">"Transfer-Encoding"</span>: <span class="hljs-string">"chunked"</span>,
  });

  <span class="hljs-keyword">let</span> counter = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> interval = setInterval(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    counter++;
    res.write(<span class="hljs-string">`Chunk <span class="hljs-subst">${counter}</span>: <span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span>\n`</span>);

    <span class="hljs-keyword">if</span> (counter &gt;= <span class="hljs-number">10</span>) {
      clearInterval(interval);
      res.end(<span class="hljs-string">"Stream completed\n"</span>);
    }
  }, <span class="hljs-number">1000</span>);

  <span class="hljs-comment">// Handle client disconnect</span>
  req.on(<span class="hljs-string">"close"</span>, () =&gt; {
    clearInterval(interval);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Client disconnected"</span>);
  });
});

<span class="hljs-comment">// JSON responses with different structures</span>
app.get(<span class="hljs-string">"/api/response-formats/:format"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> format = req.params.format;
  <span class="hljs-keyword">const</span> sampleData = [
    { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"John Doe"</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">"john@example.com"</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Jane Smith"</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">"jane@example.com"</span> },
  ];

  <span class="hljs-keyword">switch</span> (format) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"simple"</span>:
      res.json(sampleData);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"wrapped"</span>:
      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: sampleData,
        <span class="hljs-attr">count</span>: sampleData.length,
      });
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"paginated"</span>:
      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: sampleData,
        <span class="hljs-attr">pagination</span>: {
          <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>,
          <span class="hljs-attr">limit</span>: <span class="hljs-number">10</span>,
          <span class="hljs-attr">total</span>: sampleData.length,
          <span class="hljs-attr">totalPages</span>: <span class="hljs-number">1</span>,
        },
      });
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"meta"</span>:
      res.json({
        <span class="hljs-attr">data</span>: sampleData,
        <span class="hljs-attr">meta</span>: {
          <span class="hljs-attr">count</span>: sampleData.length,
          <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
          <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
        },
      });
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">default</span>:
      res.status(<span class="hljs-number">400</span>).json({
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Invalid format"</span>,
        <span class="hljs-attr">availableFormats</span>: [<span class="hljs-string">"simple"</span>, <span class="hljs-string">"wrapped"</span>, <span class="hljs-string">"paginated"</span>, <span class="hljs-string">"meta"</span>],
      });
  }
});

<span class="hljs-comment">// Error responses</span>
app.get(<span class="hljs-string">"/error/:type"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> type = req.params.type;

  <span class="hljs-keyword">switch</span> (type) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"validation"</span>:
      res.status(<span class="hljs-number">400</span>).json({
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Validation Error"</span>,
        <span class="hljs-attr">details</span>: [
          { <span class="hljs-attr">field</span>: <span class="hljs-string">"email"</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"Email is required"</span> },
          {
            <span class="hljs-attr">field</span>: <span class="hljs-string">"password"</span>,
            <span class="hljs-attr">message</span>: <span class="hljs-string">"Password must be at least 8 characters"</span>,
          },
        ],
      });
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"unauthorized"</span>:
      res.status(<span class="hljs-number">401</span>).json({
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Unauthorized"</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Authentication required"</span>,
      });
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"forbidden"</span>:
      res.status(<span class="hljs-number">403</span>).json({
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Forbidden"</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Insufficient permissions"</span>,
      });
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"notfound"</span>:
      res.status(<span class="hljs-number">404</span>).json({
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Not Found"</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Resource not found"</span>,
      });
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"server"</span>:
      res.status(<span class="hljs-number">500</span>).json({
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal Server Error"</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Something went wrong"</span>,
      });
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">default</span>:
      res.status(<span class="hljs-number">400</span>).json({
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Invalid error type"</span>,
        <span class="hljs-attr">availableTypes</span>: [
          <span class="hljs-string">"validation"</span>,
          <span class="hljs-string">"unauthorized"</span>,
          <span class="hljs-string">"forbidden"</span>,
          <span class="hljs-string">"notfound"</span>,
          <span class="hljs-string">"server"</span>,
        ],
      });
  }
});

<span class="hljs-comment">// Create sample directories and files</span>
<span class="hljs-keyword">const</span> downloadsDir = path.join(__dirname, <span class="hljs-string">"downloads"</span>);
<span class="hljs-keyword">const</span> filesDir = path.join(__dirname, <span class="hljs-string">"files"</span>);

<span class="hljs-keyword">if</span> (!fs.existsSync(downloadsDir)) {
  fs.mkdirSync(downloadsDir, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
  fs.writeFileSync(
    path.join(downloadsDir, <span class="hljs-string">"sample.txt"</span>),
    <span class="hljs-string">"This is a sample download file."</span>
  );
}

<span class="hljs-keyword">if</span> (!fs.existsSync(filesDir)) {
  fs.mkdirSync(filesDir, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
  fs.writeFileSync(
    path.join(filesDir, <span class="hljs-string">"sample.json"</span>),
    <span class="hljs-built_in">JSON</span>.stringify({ <span class="hljs-attr">message</span>: <span class="hljs-string">"Sample JSON file"</span> }, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>)
  );
}

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
app.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</div></code></pre>
<h3 id="advanced-requestresponse-handling">Advanced Request/Response Handling</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// advanced-req-res.js</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> multer = <span class="hljs-built_in">require</span>(<span class="hljs-string">"multer"</span>); <span class="hljs-comment">// For file uploads</span>
<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Configure multer for file uploads</span>
<span class="hljs-keyword">const</span> storage = multer.diskStorage({
  <span class="hljs-attr">destination</span>: <span class="hljs-function">(<span class="hljs-params">req, file, cb</span>) =&gt;</span> {
    cb(<span class="hljs-literal">null</span>, <span class="hljs-string">"uploads/"</span>);
  },
  <span class="hljs-attr">filename</span>: <span class="hljs-function">(<span class="hljs-params">req, file, cb</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> uniqueSuffix = <span class="hljs-built_in">Date</span>.now() + <span class="hljs-string">"-"</span> + <span class="hljs-built_in">Math</span>.round(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">1e9</span>);
    cb(
      <span class="hljs-literal">null</span>,
      file.fieldname + <span class="hljs-string">"-"</span> + uniqueSuffix + path.extname(file.originalname)
    );
  },
});

<span class="hljs-keyword">const</span> upload = multer({
  storage,
  <span class="hljs-attr">limits</span>: {
    <span class="hljs-attr">fileSize</span>: <span class="hljs-number">5</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>, <span class="hljs-comment">// 5MB limit</span>
  },
  <span class="hljs-attr">fileFilter</span>: <span class="hljs-function">(<span class="hljs-params">req, file, cb</span>) =&gt;</span> {
    <span class="hljs-comment">// Accept only images</span>
    <span class="hljs-keyword">if</span> (file.mimetype.startsWith(<span class="hljs-string">"image/"</span>)) {
      cb(<span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>);
    } <span class="hljs-keyword">else</span> {
      cb(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Only image files are allowed"</span>), <span class="hljs-literal">false</span>);
    }
  },
});

app.use(express.json());
app.use(express.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> }));

<span class="hljs-comment">// Request validation middleware</span>
<span class="hljs-keyword">const</span> validateRequest = <span class="hljs-function">(<span class="hljs-params">schema</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> errors = [];

    <span class="hljs-comment">// Validate required fields</span>
    <span class="hljs-keyword">if</span> (schema.required) {
      schema.required.forEach(<span class="hljs-function">(<span class="hljs-params">field</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (!req.body[field]) {
          errors.push(<span class="hljs-string">`<span class="hljs-subst">${field}</span> is required`</span>);
        }
      });
    }

    <span class="hljs-comment">// Validate field types</span>
    <span class="hljs-keyword">if</span> (schema.types) {
      <span class="hljs-built_in">Object</span>.keys(schema.types).forEach(<span class="hljs-function">(<span class="hljs-params">field</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (req.body[field] &amp;&amp; <span class="hljs-keyword">typeof</span> req.body[field] !== schema.types[field]) {
          errors.push(<span class="hljs-string">`<span class="hljs-subst">${field}</span> must be of type <span class="hljs-subst">${schema.types[field]}</span>`</span>);
        }
      });
    }

    <span class="hljs-keyword">if</span> (errors.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        errors,
      });
    }

    next();
  };
};

<span class="hljs-comment">// Request logging middleware</span>
<span class="hljs-keyword">const</span> requestLogger = <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> start = <span class="hljs-built_in">Date</span>.now();

  <span class="hljs-comment">// Log request</span>
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`[<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span>] <span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.path}</span>`</span>);

  <span class="hljs-comment">// Override res.json to log response</span>
  <span class="hljs-keyword">const</span> originalJson = res.json;
  res.json = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{
    <span class="hljs-keyword">const</span> duration = <span class="hljs-built_in">Date</span>.now() - start;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`[<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span>] Response sent in <span class="hljs-subst">${duration}</span>ms`</span>);
    <span class="hljs-keyword">return</span> originalJson.call(<span class="hljs-keyword">this</span>, data);
  };

  next();
};

app.use(requestLogger);

<span class="hljs-comment">// File upload endpoint</span>
app.post(<span class="hljs-string">"/upload"</span>, upload.single(<span class="hljs-string">"image"</span>), (req, res) =&gt; {
  <span class="hljs-keyword">if</span> (!req.file) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"No file uploaded"</span>,
    });
  }

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"File uploaded successfully"</span>,
    <span class="hljs-attr">file</span>: {
      <span class="hljs-attr">originalName</span>: req.file.originalname,
      <span class="hljs-attr">filename</span>: req.file.filename,
      <span class="hljs-attr">size</span>: req.file.size,
      <span class="hljs-attr">mimetype</span>: req.file.mimetype,
      <span class="hljs-attr">path</span>: req.file.path,
    },
  });
});

<span class="hljs-comment">// Multiple file upload</span>
app.post(<span class="hljs-string">"/upload-multiple"</span>, upload.array(<span class="hljs-string">"images"</span>, <span class="hljs-number">5</span>), (req, res) =&gt; {
  <span class="hljs-keyword">if</span> (!req.files || req.files.length === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"No files uploaded"</span>,
    });
  }

  <span class="hljs-keyword">const</span> fileInfo = req.files.map(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> ({
    <span class="hljs-attr">originalName</span>: file.originalname,
    <span class="hljs-attr">filename</span>: file.filename,
    <span class="hljs-attr">size</span>: file.size,
    <span class="hljs-attr">mimetype</span>: file.mimetype,
  }));

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">`<span class="hljs-subst">${req.files.length}</span> files uploaded successfully`</span>,
    <span class="hljs-attr">files</span>: fileInfo,
  });
});

<span class="hljs-comment">// Request with validation</span>
<span class="hljs-keyword">const</span> userSchema = {
  <span class="hljs-attr">required</span>: [<span class="hljs-string">"name"</span>, <span class="hljs-string">"email"</span>],
  <span class="hljs-attr">types</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"string"</span>,
    <span class="hljs-attr">email</span>: <span class="hljs-string">"string"</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-string">"number"</span>,
  },
};

app.post(<span class="hljs-string">"/users"</span>, validateRequest(userSchema), (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { name, email, age } = req.body;

  <span class="hljs-comment">// Additional validation</span>
  <span class="hljs-keyword">if</span> (!email.includes(<span class="hljs-string">"@"</span>)) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Invalid email format"</span>,
    });
  }

  <span class="hljs-keyword">if</span> (age &amp;&amp; (age &lt; <span class="hljs-number">0</span> || age &gt; <span class="hljs-number">150</span>)) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Age must be between 0 and 150"</span>,
    });
  }

  <span class="hljs-comment">// Simulate user creation</span>
  <span class="hljs-keyword">const</span> newUser = {
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">Date</span>.now(),
    name,
    email,
    <span class="hljs-attr">age</span>: age || <span class="hljs-literal">null</span>,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
  };

  res.status(<span class="hljs-number">201</span>).json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"User created successfully"</span>,
    <span class="hljs-attr">user</span>: newUser,
  });
});

<span class="hljs-comment">// Content negotiation</span>
app.get(<span class="hljs-string">"/api/data"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> data = {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">"Sample Data"</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
  };

  <span class="hljs-comment">// Check what the client accepts</span>
  <span class="hljs-keyword">if</span> (req.accepts(<span class="hljs-string">"json"</span>)) {
    res.json(data);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (req.accepts(<span class="hljs-string">"xml"</span>)) {
    <span class="hljs-keyword">const</span> xml = <span class="hljs-string">`&lt;?xml version="1.0"?&gt;
&lt;data&gt;
  &lt;id&gt;<span class="hljs-subst">${data.id}</span>&lt;/id&gt;
  &lt;name&gt;<span class="hljs-subst">${data.name}</span>&lt;/name&gt;
  &lt;timestamp&gt;<span class="hljs-subst">${data.timestamp}</span>&lt;/timestamp&gt;
&lt;/data&gt;`</span>;
    res.type(<span class="hljs-string">"xml"</span>).send(xml);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (req.accepts(<span class="hljs-string">"html"</span>)) {
    <span class="hljs-keyword">const</span> html = <span class="hljs-string">`
        &lt;div&gt;
            &lt;h2&gt;Data&lt;/h2&gt;
            &lt;p&gt;&lt;strong&gt;ID:&lt;/strong&gt; <span class="hljs-subst">${data.id}</span>&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Name:&lt;/strong&gt; <span class="hljs-subst">${data.name}</span>&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Timestamp:&lt;/strong&gt; <span class="hljs-subst">${data.timestamp}</span>&lt;/p&gt;
        &lt;/div&gt;`</span>;
    res.type(<span class="hljs-string">"html"</span>).send(html);
  } <span class="hljs-keyword">else</span> {
    res.status(<span class="hljs-number">406</span>).json({
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Not Acceptable"</span>,
      <span class="hljs-attr">supportedTypes</span>: [<span class="hljs-string">"application/json"</span>, <span class="hljs-string">"application/xml"</span>, <span class="hljs-string">"text/html"</span>],
    });
  }
});

<span class="hljs-comment">// Response caching</span>
app.get(<span class="hljs-string">"/api/cached-data"</span>, (req, res) =&gt; {
  <span class="hljs-comment">// Set cache headers</span>
  res.set({
    <span class="hljs-string">"Cache-Control"</span>: <span class="hljs-string">"public, max-age=3600"</span>, <span class="hljs-comment">// Cache for 1 hour</span>
    <span class="hljs-attr">ETag</span>: <span class="hljs-string">'"123456"'</span>,
    <span class="hljs-string">"Last-Modified"</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toUTCString(),
  });

  <span class="hljs-comment">// Check if client has cached version</span>
  <span class="hljs-keyword">if</span> (req.get(<span class="hljs-string">"If-None-Match"</span>) === <span class="hljs-string">'"123456"'</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">304</span>).end(); <span class="hljs-comment">// Not Modified</span>
  }

  res.json({
    <span class="hljs-attr">message</span>: <span class="hljs-string">"This response is cached"</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
    <span class="hljs-attr">data</span>: <span class="hljs-string">"Some expensive computation result"</span>,
  });
});

<span class="hljs-comment">// Error handling for file uploads</span>
app.use(<span class="hljs-function">(<span class="hljs-params">error, req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (error <span class="hljs-keyword">instanceof</span> multer.MulterError) {
    <span class="hljs-keyword">if</span> (error.code === <span class="hljs-string">"LIMIT_FILE_SIZE"</span>) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"File too large. Maximum size is 5MB"</span>,
      });
    }
  }

  <span class="hljs-keyword">if</span> (error.message === <span class="hljs-string">"Only image files are allowed"</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: error.message,
    });
  }

  next(error);
});

<span class="hljs-comment">// Create uploads directory</span>
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">const</span> uploadsDir = path.join(__dirname, <span class="hljs-string">"uploads"</span>);
<span class="hljs-keyword">if</span> (!fs.existsSync(uploadsDir)) {
  fs.mkdirSync(uploadsDir, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
}

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
app.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</div></code></pre>
<h2 id="real-world-use-case">Real-World Use Case</h2>
<h3 id="api-with-comprehensive-requestresponse-handling">API with Comprehensive Request/Response Handling</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// api-server-complete.js</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Middleware</span>
app.use(express.json({ <span class="hljs-attr">limit</span>: <span class="hljs-string">"10mb"</span> }));
app.use(express.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">limit</span>: <span class="hljs-string">"10mb"</span> }));

<span class="hljs-comment">// Request ID middleware</span>
app.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  req.id = <span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).substr(<span class="hljs-number">2</span>, <span class="hljs-number">9</span>);
  res.set(<span class="hljs-string">"X-Request-ID"</span>, req.id);
  next();
});

<span class="hljs-comment">// API response wrapper</span>
<span class="hljs-keyword">const</span> apiResponse = {
  <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res, data, message = <span class="hljs-string">"Success"</span>, statusCode = <span class="hljs-number">200</span></span>) =&gt;</span> {
    res.status(statusCode).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
      message,
      data,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
      <span class="hljs-attr">requestId</span>: res.get(<span class="hljs-string">"X-Request-ID"</span>),
    });
  },

  <span class="hljs-attr">error</span>: <span class="hljs-function">(<span class="hljs-params">res, message = <span class="hljs-string">"Error"</span>, statusCode = <span class="hljs-number">500</span>, errors = <span class="hljs-literal">null</span></span>) =&gt;</span> {
    res.status(statusCode).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      message,
      errors,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
      <span class="hljs-attr">requestId</span>: res.get(<span class="hljs-string">"X-Request-ID"</span>),
    });
  },

  <span class="hljs-attr">paginated</span>: <span class="hljs-function">(<span class="hljs-params">res, data, pagination, message = <span class="hljs-string">"Success"</span></span>) =&gt;</span> {
    res.json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
      message,
      data,
      pagination,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
      <span class="hljs-attr">requestId</span>: res.get(<span class="hljs-string">"X-Request-ID"</span>),
    });
  },
};

<span class="hljs-comment">// Sample data</span>
<span class="hljs-keyword">let</span> products = [
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">"Laptop"</span>,
    <span class="hljs-attr">price</span>: <span class="hljs-number">999.99</span>,
    <span class="hljs-attr">category</span>: <span class="hljs-string">"Electronics"</span>,
    <span class="hljs-attr">inStock</span>: <span class="hljs-literal">true</span>,
  },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Book"</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">19.99</span>, <span class="hljs-attr">category</span>: <span class="hljs-string">"Education"</span>, <span class="hljs-attr">inStock</span>: <span class="hljs-literal">true</span> },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">"Coffee Mug"</span>,
    <span class="hljs-attr">price</span>: <span class="hljs-number">9.99</span>,
    <span class="hljs-attr">category</span>: <span class="hljs-string">"Kitchen"</span>,
    <span class="hljs-attr">inStock</span>: <span class="hljs-literal">false</span>,
  },
];
<span class="hljs-keyword">let</span> nextId = <span class="hljs-number">4</span>;

<span class="hljs-comment">// Get products with filtering, sorting, and pagination</span>
app.get(<span class="hljs-string">"/api/products"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">let</span> {
      page = <span class="hljs-number">1</span>,
      limit = <span class="hljs-number">10</span>,
      category,
      minPrice,
      maxPrice,
      inStock,
      sort = <span class="hljs-string">"id"</span>,
      order = <span class="hljs-string">"asc"</span>,
      search,
    } = req.query;

    <span class="hljs-comment">// Convert and validate parameters</span>
    page = <span class="hljs-built_in">parseInt</span>(page);
    limit = <span class="hljs-built_in">parseInt</span>(limit);

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(page) || page &lt; <span class="hljs-number">1</span>) page = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(limit) || limit &lt; <span class="hljs-number">1</span> || limit &gt; <span class="hljs-number">100</span>) limit = <span class="hljs-number">10</span>;

    <span class="hljs-keyword">let</span> filteredProducts = [...products];

    <span class="hljs-comment">// Apply filters</span>
    <span class="hljs-keyword">if</span> (category) {
      filteredProducts = filteredProducts.filter(
        <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.category.toLowerCase() === category.toLowerCase()
      );
    }

    <span class="hljs-keyword">if</span> (minPrice) {
      <span class="hljs-keyword">const</span> min = <span class="hljs-built_in">parseFloat</span>(minPrice);
      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isNaN</span>(min)) {
        filteredProducts = filteredProducts.filter(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.price &gt;= min);
      }
    }

    <span class="hljs-keyword">if</span> (maxPrice) {
      <span class="hljs-keyword">const</span> max = <span class="hljs-built_in">parseFloat</span>(maxPrice);
      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isNaN</span>(max)) {
        filteredProducts = filteredProducts.filter(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.price &lt;= max);
      }
    }

    <span class="hljs-keyword">if</span> (inStock !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">const</span> stockFilter = inStock === <span class="hljs-string">"true"</span>;
      filteredProducts = filteredProducts.filter(
        <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.inStock === stockFilter
      );
    }

    <span class="hljs-keyword">if</span> (search) {
      filteredProducts = filteredProducts.filter(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span>
        p.name.toLowerCase().includes(search.toLowerCase())
      );
    }

    <span class="hljs-comment">// Apply sorting</span>
    <span class="hljs-keyword">if</span> (
      sort &amp;&amp;
      filteredProducts.length &gt; <span class="hljs-number">0</span> &amp;&amp;
      filteredProducts[<span class="hljs-number">0</span>].hasOwnProperty(sort)
    ) {
      filteredProducts.sort(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> {
        <span class="hljs-keyword">let</span> aVal = a[sort];
        <span class="hljs-keyword">let</span> bVal = b[sort];

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> aVal === <span class="hljs-string">"string"</span>) {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }

        <span class="hljs-keyword">if</span> (order === <span class="hljs-string">"desc"</span>) {
          <span class="hljs-keyword">return</span> bVal &gt; aVal ? <span class="hljs-number">1</span> : <span class="hljs-number">-1</span>;
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> aVal &gt; bVal ? <span class="hljs-number">1</span> : <span class="hljs-number">-1</span>;
        }
      });
    }

    <span class="hljs-comment">// Apply pagination</span>
    <span class="hljs-keyword">const</span> total = filteredProducts.length;
    <span class="hljs-keyword">const</span> totalPages = <span class="hljs-built_in">Math</span>.ceil(total / limit);
    <span class="hljs-keyword">const</span> offset = (page - <span class="hljs-number">1</span>) * limit;
    <span class="hljs-keyword">const</span> paginatedProducts = filteredProducts.slice(offset, offset + limit);

    <span class="hljs-keyword">const</span> pagination = {
      page,
      limit,
      total,
      totalPages,
      <span class="hljs-attr">hasNext</span>: page &lt; totalPages,
      <span class="hljs-attr">hasPrev</span>: page &gt; <span class="hljs-number">1</span>,
    };

    apiResponse.paginated(
      res,
      paginatedProducts,
      pagination,
      <span class="hljs-string">"Products retrieved successfully"</span>
    );
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error in GET /api/products:"</span>, error);
    apiResponse.error(res, <span class="hljs-string">"Failed to retrieve products"</span>, <span class="hljs-number">500</span>);
  }
});

<span class="hljs-comment">// Get single product</span>
app.get(<span class="hljs-string">"/api/products/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(req.params.id);

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(id)) {
      <span class="hljs-keyword">return</span> apiResponse.error(res, <span class="hljs-string">"Invalid product ID"</span>, <span class="hljs-number">400</span>);
    }

    <span class="hljs-keyword">const</span> product = products.find(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id === id);

    <span class="hljs-keyword">if</span> (!product) {
      <span class="hljs-keyword">return</span> apiResponse.error(res, <span class="hljs-string">"Product not found"</span>, <span class="hljs-number">404</span>);
    }

    apiResponse.success(res, product, <span class="hljs-string">"Product retrieved successfully"</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error in GET /api/products/:id:"</span>, error);
    apiResponse.error(res, <span class="hljs-string">"Failed to retrieve product"</span>, <span class="hljs-number">500</span>);
  }
});

<span class="hljs-comment">// Create product</span>
app.post(<span class="hljs-string">"/api/products"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> { name, price, category, inStock = <span class="hljs-literal">true</span> } = req.body;

    <span class="hljs-comment">// Validation</span>
    <span class="hljs-keyword">const</span> errors = [];

    <span class="hljs-keyword">if</span> (!name || <span class="hljs-keyword">typeof</span> name !== <span class="hljs-string">"string"</span> || name.trim().length === <span class="hljs-number">0</span>) {
      errors.push(<span class="hljs-string">"Name is required and must be a non-empty string"</span>);
    }

    <span class="hljs-keyword">if</span> (!price || <span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">parseFloat</span>(price)) || <span class="hljs-built_in">parseFloat</span>(price) &lt;= <span class="hljs-number">0</span>) {
      errors.push(<span class="hljs-string">"Price is required and must be a positive number"</span>);
    }

    <span class="hljs-keyword">if</span> (
      !category ||
      <span class="hljs-keyword">typeof</span> category !== <span class="hljs-string">"string"</span> ||
      category.trim().length === <span class="hljs-number">0</span>
    ) {
      errors.push(<span class="hljs-string">"Category is required and must be a non-empty string"</span>);
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> inStock !== <span class="hljs-string">"boolean"</span>) {
      errors.push(<span class="hljs-string">"inStock must be a boolean value"</span>);
    }

    <span class="hljs-keyword">if</span> (errors.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> apiResponse.error(res, <span class="hljs-string">"Validation failed"</span>, <span class="hljs-number">400</span>, errors);
    }

    <span class="hljs-comment">// Check for duplicate</span>
    <span class="hljs-keyword">const</span> existingProduct = products.find(
      <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span>
        p.name.toLowerCase() === name.toLowerCase() &amp;&amp;
        p.category.toLowerCase() === category.toLowerCase()
    );

    <span class="hljs-keyword">if</span> (existingProduct) {
      <span class="hljs-keyword">return</span> apiResponse.error(
        res,
        <span class="hljs-string">"Product with this name and category already exists"</span>,
        <span class="hljs-number">409</span>
      );
    }

    <span class="hljs-comment">// Create product</span>
    <span class="hljs-keyword">const</span> newProduct = {
      <span class="hljs-attr">id</span>: nextId++,
      <span class="hljs-attr">name</span>: name.trim(),
      <span class="hljs-attr">price</span>: <span class="hljs-built_in">parseFloat</span>(price),
      <span class="hljs-attr">category</span>: category.trim(),
      inStock,
    };

    products.push(newProduct);

    apiResponse.success(res, newProduct, <span class="hljs-string">"Product created successfully"</span>, <span class="hljs-number">201</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error in POST /api/products:"</span>, error);
    apiResponse.error(res, <span class="hljs-string">"Failed to create product"</span>, <span class="hljs-number">500</span>);
  }
});

<span class="hljs-comment">// Update product</span>
app.put(<span class="hljs-string">"/api/products/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(req.params.id);

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(id)) {
      <span class="hljs-keyword">return</span> apiResponse.error(res, <span class="hljs-string">"Invalid product ID"</span>, <span class="hljs-number">400</span>);
    }

    <span class="hljs-keyword">const</span> productIndex = products.findIndex(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id === id);

    <span class="hljs-keyword">if</span> (productIndex === <span class="hljs-number">-1</span>) {
      <span class="hljs-keyword">return</span> apiResponse.error(res, <span class="hljs-string">"Product not found"</span>, <span class="hljs-number">404</span>);
    }

    <span class="hljs-keyword">const</span> { name, price, category, inStock } = req.body;
    <span class="hljs-keyword">const</span> errors = [];

    <span class="hljs-comment">// Validate only provided fields</span>
    <span class="hljs-keyword">if</span> (
      name !== <span class="hljs-literal">undefined</span> &amp;&amp;
      (<span class="hljs-keyword">typeof</span> name !== <span class="hljs-string">"string"</span> || name.trim().length === <span class="hljs-number">0</span>)
    ) {
      errors.push(<span class="hljs-string">"Name must be a non-empty string"</span>);
    }

    <span class="hljs-keyword">if</span> (
      price !== <span class="hljs-literal">undefined</span> &amp;&amp;
      (<span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">parseFloat</span>(price)) || <span class="hljs-built_in">parseFloat</span>(price) &lt;= <span class="hljs-number">0</span>)
    ) {
      errors.push(<span class="hljs-string">"Price must be a positive number"</span>);
    }

    <span class="hljs-keyword">if</span> (
      category !== <span class="hljs-literal">undefined</span> &amp;&amp;
      (<span class="hljs-keyword">typeof</span> category !== <span class="hljs-string">"string"</span> || category.trim().length === <span class="hljs-number">0</span>)
    ) {
      errors.push(<span class="hljs-string">"Category must be a non-empty string"</span>);
    }

    <span class="hljs-keyword">if</span> (inStock !== <span class="hljs-literal">undefined</span> &amp;&amp; <span class="hljs-keyword">typeof</span> inStock !== <span class="hljs-string">"boolean"</span>) {
      errors.push(<span class="hljs-string">"inStock must be a boolean value"</span>);
    }

    <span class="hljs-keyword">if</span> (errors.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> apiResponse.error(res, <span class="hljs-string">"Validation failed"</span>, <span class="hljs-number">400</span>, errors);
    }

    <span class="hljs-comment">// Update product</span>
    <span class="hljs-keyword">const</span> updatedProduct = {
      ...products[productIndex],
      ...(name !== <span class="hljs-literal">undefined</span> &amp;&amp; { <span class="hljs-attr">name</span>: name.trim() }),
      ...(price !== <span class="hljs-literal">undefined</span> &amp;&amp; { <span class="hljs-attr">price</span>: <span class="hljs-built_in">parseFloat</span>(price) }),
      ...(category !== <span class="hljs-literal">undefined</span> &amp;&amp; { <span class="hljs-attr">category</span>: category.trim() }),
      ...(inStock !== <span class="hljs-literal">undefined</span> &amp;&amp; { inStock }),
    };

    products[productIndex] = updatedProduct;

    apiResponse.success(res, updatedProduct, <span class="hljs-string">"Product updated successfully"</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error in PUT /api/products/:id:"</span>, error);
    apiResponse.error(res, <span class="hljs-string">"Failed to update product"</span>, <span class="hljs-number">500</span>);
  }
});

<span class="hljs-comment">// Delete product</span>
app.delete(<span class="hljs-string">"/api/products/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(req.params.id);

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(id)) {
      <span class="hljs-keyword">return</span> apiResponse.error(res, <span class="hljs-string">"Invalid product ID"</span>, <span class="hljs-number">400</span>);
    }

    <span class="hljs-keyword">const</span> productIndex = products.findIndex(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id === id);

    <span class="hljs-keyword">if</span> (productIndex === <span class="hljs-number">-1</span>) {
      <span class="hljs-keyword">return</span> apiResponse.error(res, <span class="hljs-string">"Product not found"</span>, <span class="hljs-number">404</span>);
    }

    <span class="hljs-keyword">const</span> deletedProduct = products.splice(productIndex, <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>];

    apiResponse.success(res, deletedProduct, <span class="hljs-string">"Product deleted successfully"</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error in DELETE /api/products/:id:"</span>, error);
    apiResponse.error(res, <span class="hljs-string">"Failed to delete product"</span>, <span class="hljs-number">500</span>);
  }
});

<span class="hljs-comment">// Global error handler</span>
app.use(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Unhandled error:"</span>, err.stack);
  apiResponse.error(res, <span class="hljs-string">"Internal server error"</span>, <span class="hljs-number">500</span>);
});

<span class="hljs-comment">// 404 handler</span>
app.use(<span class="hljs-string">"*"</span>, (req, res) =&gt; {
  apiResponse.error(res, <span class="hljs-string">"Endpoint not found"</span>, <span class="hljs-number">404</span>);
});

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
app.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🚀 API server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</div></code></pre>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-always-validate-input">1. Always Validate Input</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> validateInput = <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { email, password } = req.body;

  <span class="hljs-keyword">if</span> (!email || !email.includes(<span class="hljs-string">"@"</span>)) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Valid email required"</span> });
  }

  <span class="hljs-keyword">if</span> (!password || password.length &lt; <span class="hljs-number">8</span>) {
    <span class="hljs-keyword">return</span> res
      .status(<span class="hljs-number">400</span>)
      .json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Password must be at least 8 characters"</span> });
  }

  next();
};
</div></code></pre>
<h3 id="2-use-consistent-response-format">2. Use Consistent Response Format</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> responseFormat = {
  <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">data, message = <span class="hljs-string">"Success"</span></span>) =&gt;</span> ({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    message,
    data,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
  }),

  <span class="hljs-attr">error</span>: <span class="hljs-function">(<span class="hljs-params">message, errors = <span class="hljs-literal">null</span></span>) =&gt;</span> ({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
    message,
    errors,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
  }),
};
</div></code></pre>
<h3 id="3-handle-async-errors">3. Handle Async Errors</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> asyncHandler = <span class="hljs-function">(<span class="hljs-params">fn</span>) =&gt;</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">Promise</span>.resolve(fn(req, res, next)).catch(next);
};

app.get(
  <span class="hljs-string">"/api/users"</span>,
  asyncHandler(<span class="hljs-keyword">async</span> (req, res) =&gt; {
    <span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> User.find();
    res.json(users);
  })
);
</div></code></pre>
<h3 id="4-set-security-headers">4. Set Security Headers</h3>
<pre class="hljs"><code><div>app.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  res.set({
    <span class="hljs-string">"X-Content-Type-Options"</span>: <span class="hljs-string">"nosniff"</span>,
    <span class="hljs-string">"X-Frame-Options"</span>: <span class="hljs-string">"DENY"</span>,
    <span class="hljs-string">"X-XSS-Protection"</span>: <span class="hljs-string">"1; mode=block"</span>,
  });
  next();
});
</div></code></pre>
<h3 id="5-log-requests-and-responses">5. Log Requests and Responses</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> logger = <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> start = <span class="hljs-built_in">Date</span>.now();

  res.on(<span class="hljs-string">"finish"</span>, () =&gt; {
    <span class="hljs-keyword">const</span> duration = <span class="hljs-built_in">Date</span>.now() - start;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.path}</span> <span class="hljs-subst">${res.statusCode}</span> <span class="hljs-subst">${duration}</span>ms`</span>);
  });

  next();
};
</div></code></pre>
<h2 id="summary">Summary</h2>
<p>Mastering request and response objects in Express.js involves:</p>
<p><strong>Request Object (req)</strong>:</p>
<ul>
<li>Access route parameters with <code>req.params</code></li>
<li>Handle query strings with <code>req.query</code></li>
<li>Parse request body with <code>req.body</code></li>
<li>Read headers with <code>req.get()</code> or <code>req.headers</code></li>
<li>Get client information with <code>req.ip</code>, <code>req.hostname</code></li>
</ul>
<p><strong>Response Object (res)</strong>:</p>
<ul>
<li>Send JSON with <code>res.json()</code></li>
<li>Set status codes with <code>res.status()</code></li>
<li>Set headers with <code>res.set()</code></li>
<li>Handle redirects with <code>res.redirect()</code></li>
<li>Send files with <code>res.sendFile()</code> or <code>res.download()</code></li>
</ul>
<p><strong>Best Practices</strong>:</p>
<ul>
<li>Always validate input data</li>
<li>Use consistent response formats</li>
<li>Handle errors gracefully</li>
<li>Set appropriate HTTP status codes</li>
<li>Implement proper logging</li>
<li>Set security headers</li>
</ul>
<p>Understanding these objects thoroughly enables you to build robust, secure, and user-friendly web applications and APIs. Next, we'll explore serving static files and building complete web applications with Express.js.</p>
<h1 id="serving-static-files-in-expressjs">Serving Static Files in Express.js</h1>
<h2 id="overview">Overview</h2>
<p>Serving static files is a fundamental requirement for web applications. Static files include CSS stylesheets, JavaScript files, images, fonts, and other assets that don't change based on user requests. Express.js provides built-in middleware to serve static files efficiently, along with advanced features for optimization and security.</p>
<h2 id="key-concepts">Key Concepts</h2>
<h3 id="static-files-vs-dynamic-content">Static Files vs Dynamic Content</h3>
<p><strong>Static Files</strong>:</p>
<ul>
<li>CSS stylesheets</li>
<li>JavaScript files</li>
<li>Images (PNG, JPG, SVG, etc.)</li>
<li>Fonts (TTF, WOFF, etc.)</li>
<li>Documents (PDF, TXT, etc.)</li>
<li>Audio/Video files</li>
</ul>
<p><strong>Dynamic Content</strong>:</p>
<ul>
<li>HTML generated from templates</li>
<li>API responses</li>
<li>User-specific data</li>
<li>Real-time content</li>
</ul>
<h3 id="express-static-middleware">Express Static Middleware</h3>
<p>Express provides <code>express.static()</code> middleware that:</p>
<ul>
<li>Serves files from a specified directory</li>
<li>Sets appropriate MIME types</li>
<li>Handles caching headers</li>
<li>Supports range requests</li>
<li>Provides security features</li>
</ul>
<h3 id="virtual-paths">Virtual Paths</h3>
<p>Virtual paths allow you to:</p>
<ul>
<li>Mount static files at different URL paths</li>
<li>Organize files logically</li>
<li>Hide actual directory structure</li>
<li>Implement multiple static directories</li>
</ul>
<h2 id="example-code">Example Code</h2>
<h3 id="basic-static-file-serving">Basic Static File Serving</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// basic-static.js</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Serve static files from 'public' directory</span>
app.use(express.static(<span class="hljs-string">"public"</span>));

<span class="hljs-comment">// Alternative: using absolute path</span>
app.use(express.static(path.join(__dirname, <span class="hljs-string">"public"</span>)));

<span class="hljs-comment">// Basic route</span>
app.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  res.send(<span class="hljs-string">`
        &lt;!DOCTYPE html&gt;
        &lt;html&gt;
        &lt;head&gt;
            &lt;title&gt;Static Files Demo&lt;/title&gt;
            &lt;link rel="stylesheet" href="/css/style.css"&gt;
        &lt;/head&gt;
        &lt;body&gt;
            &lt;h1&gt;Welcome to Static Files Demo&lt;/h1&gt;
            &lt;img src="/images/logo.png" alt="Logo"&gt;
            &lt;script src="/js/app.js"&gt;&lt;/script&gt;
        &lt;/body&gt;
        &lt;/html&gt;
    `</span>);
});

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
app.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</div></code></pre>
<h3 id="virtual-path-mounting">Virtual Path Mounting</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// virtual-paths.js</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Mount static files with virtual paths</span>
app.use(<span class="hljs-string">"/static"</span>, express.static(<span class="hljs-string">"public"</span>));
app.use(<span class="hljs-string">"/assets"</span>, express.static(<span class="hljs-string">"assets"</span>));
app.use(<span class="hljs-string">"/uploads"</span>, express.static(<span class="hljs-string">"uploads"</span>));

<span class="hljs-comment">// Multiple directories for same virtual path</span>
app.use(<span class="hljs-string">"/shared"</span>, express.static(<span class="hljs-string">"public"</span>));
app.use(<span class="hljs-string">"/shared"</span>, express.static(<span class="hljs-string">"assets"</span>));

<span class="hljs-comment">// Serve files from different directories</span>
app.use(<span class="hljs-string">"/css"</span>, express.static(path.join(__dirname, <span class="hljs-string">"styles"</span>)));
app.use(<span class="hljs-string">"/js"</span>, express.static(path.join(__dirname, <span class="hljs-string">"scripts"</span>)));
app.use(<span class="hljs-string">"/images"</span>, express.static(path.join(__dirname, <span class="hljs-string">"media"</span>, <span class="hljs-string">"images"</span>)));

<span class="hljs-comment">// API route</span>
app.get(<span class="hljs-string">"/api/info"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Static files are served at:"</span>,
    <span class="hljs-attr">paths</span>: {
      <span class="hljs-attr">general</span>: <span class="hljs-string">"/static/*"</span>,
      <span class="hljs-attr">assets</span>: <span class="hljs-string">"/assets/*"</span>,
      <span class="hljs-attr">uploads</span>: <span class="hljs-string">"/uploads/*"</span>,
      <span class="hljs-attr">styles</span>: <span class="hljs-string">"/css/*"</span>,
      <span class="hljs-attr">scripts</span>: <span class="hljs-string">"/js/*"</span>,
      <span class="hljs-attr">images</span>: <span class="hljs-string">"/images/*"</span>,
    },
  });
});

<span class="hljs-comment">// Demo page</span>
app.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  res.send(<span class="hljs-string">`
        &lt;!DOCTYPE html&gt;
        &lt;html&gt;
        &lt;head&gt;
            &lt;title&gt;Virtual Paths Demo&lt;/title&gt;
            &lt;link rel="stylesheet" href="/css/main.css"&gt;
            &lt;link rel="stylesheet" href="/static/css/theme.css"&gt;
        &lt;/head&gt;
        &lt;body&gt;
            &lt;h1&gt;Virtual Paths Demo&lt;/h1&gt;
            &lt;div&gt;
                &lt;h2&gt;Images from different paths:&lt;/h2&gt;
                &lt;img src="/images/sample1.jpg" alt="Sample 1" style="max-width: 200px;"&gt;
                &lt;img src="/static/images/sample2.jpg" alt="Sample 2" style="max-width: 200px;"&gt;
                &lt;img src="/assets/logo.png" alt="Logo" style="max-width: 100px;"&gt;
            &lt;/div&gt;
            &lt;script src="/js/main.js"&gt;&lt;/script&gt;
            &lt;script src="/static/js/utils.js"&gt;&lt;/script&gt;
        &lt;/body&gt;
        &lt;/html&gt;
    `</span>);
});

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
app.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</div></code></pre>
<h3 id="advanced-static-file-configuration">Advanced Static File Configuration</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// advanced-static.js</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Static middleware with options</span>
app.use(
  <span class="hljs-string">"/public"</span>,
  express.static(<span class="hljs-string">"public"</span>, {
    <span class="hljs-comment">// Set cache control headers</span>
    <span class="hljs-attr">maxAge</span>: <span class="hljs-string">"1d"</span>, <span class="hljs-comment">// Cache for 1 day</span>

    <span class="hljs-comment">// Set custom headers</span>
    <span class="hljs-attr">setHeaders</span>: <span class="hljs-function">(<span class="hljs-params">res, path, stat</span>) =&gt;</span> {
      <span class="hljs-comment">// Set security headers</span>
      res.set(<span class="hljs-string">"X-Content-Type-Options"</span>, <span class="hljs-string">"nosniff"</span>);

      <span class="hljs-comment">// Set different cache times for different file types</span>
      <span class="hljs-keyword">if</span> (path.endsWith(<span class="hljs-string">".css"</span>) || path.endsWith(<span class="hljs-string">".js"</span>)) {
        res.set(<span class="hljs-string">"Cache-Control"</span>, <span class="hljs-string">"public, max-age=31536000"</span>); <span class="hljs-comment">// 1 year</span>
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (path.endsWith(<span class="hljs-string">".html"</span>)) {
        res.set(<span class="hljs-string">"Cache-Control"</span>, <span class="hljs-string">"public, max-age=3600"</span>); <span class="hljs-comment">// 1 hour</span>
      }

      <span class="hljs-comment">// Add custom header with file info</span>
      res.set(<span class="hljs-string">"X-File-Size"</span>, stat.size);
      res.set(<span class="hljs-string">"X-Last-Modified"</span>, stat.mtime.toISOString());
    },

    <span class="hljs-comment">// Custom index file</span>
    <span class="hljs-attr">index</span>: [<span class="hljs-string">"index.html"</span>, <span class="hljs-string">"index.htm"</span>, <span class="hljs-string">"default.html"</span>],

    <span class="hljs-comment">// Disable directory listing</span>
    <span class="hljs-attr">dotfiles</span>: <span class="hljs-string">"ignore"</span>, <span class="hljs-comment">// ignore, allow, deny</span>

    <span class="hljs-comment">// Enable/disable etag</span>
    <span class="hljs-attr">etag</span>: <span class="hljs-literal">true</span>,

    <span class="hljs-comment">// Enable/disable last-modified header</span>
    <span class="hljs-attr">lastModified</span>: <span class="hljs-literal">true</span>,

    <span class="hljs-comment">// Redirect to trailing slash</span>
    <span class="hljs-attr">redirect</span>: <span class="hljs-literal">true</span>,
  })
);

<span class="hljs-comment">// Conditional static serving based on environment</span>
<span class="hljs-keyword">if</span> (process.env.NODE_ENV === <span class="hljs-string">"development"</span>) {
  <span class="hljs-comment">// In development, serve files without caching</span>
  app.use(
    <span class="hljs-string">"/dev-assets"</span>,
    express.static(<span class="hljs-string">"dev-assets"</span>, {
      <span class="hljs-attr">maxAge</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">etag</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">lastModified</span>: <span class="hljs-literal">false</span>,
    })
  );
}

<span class="hljs-comment">// Serve different files based on user agent</span>
app.use(<span class="hljs-string">"/adaptive"</span>, (req, res, next) =&gt; {
  <span class="hljs-keyword">const</span> userAgent = req.get(<span class="hljs-string">"User-Agent"</span>) || <span class="hljs-string">""</span>;

  <span class="hljs-keyword">if</span> (userAgent.includes(<span class="hljs-string">"Mobile"</span>)) {
    express.static(<span class="hljs-string">"mobile-assets"</span>)(req, res, next);
  } <span class="hljs-keyword">else</span> {
    express.static(<span class="hljs-string">"desktop-assets"</span>)(req, res, next);
  }
});

<span class="hljs-comment">// Custom static file handler with authentication</span>
app.use(
  <span class="hljs-string">"/protected"</span>,
  (req, res, next) =&gt; {
    <span class="hljs-comment">// Simple authentication check</span>
    <span class="hljs-keyword">const</span> token = req.get(<span class="hljs-string">"Authorization"</span>);

    <span class="hljs-keyword">if</span> (!token || token !== <span class="hljs-string">"Bearer secret-token"</span>) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Unauthorized"</span> });
    }

    next();
  },
  express.static(<span class="hljs-string">"protected-files"</span>)
);

<span class="hljs-comment">// File download with custom names</span>
app.get(<span class="hljs-string">"/download/:filename"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> filename = req.params.filename;
  <span class="hljs-keyword">const</span> filePath = path.join(__dirname, <span class="hljs-string">"downloads"</span>, filename);

  <span class="hljs-comment">// Check if file exists</span>
  <span class="hljs-keyword">if</span> (!fs.existsSync(filePath)) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"File not found"</span> });
  }

  <span class="hljs-comment">// Get file stats</span>
  <span class="hljs-keyword">const</span> stats = fs.statSync(filePath);

  <span class="hljs-comment">// Set download headers</span>
  res.set({
    <span class="hljs-string">"Content-Disposition"</span>: <span class="hljs-string">`attachment; filename="<span class="hljs-subst">${filename}</span>"`</span>,
    <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/octet-stream"</span>,
    <span class="hljs-string">"Content-Length"</span>: stats.size,
  });

  <span class="hljs-comment">// Stream the file</span>
  <span class="hljs-keyword">const</span> fileStream = fs.createReadStream(filePath);
  fileStream.pipe(res);

  <span class="hljs-comment">// Handle stream errors</span>
  fileStream.on(<span class="hljs-string">"error"</span>, (err) =&gt; {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"File stream error:"</span>, err);
    <span class="hljs-keyword">if</span> (!res.headersSent) {
      res.status(<span class="hljs-number">500</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"File read error"</span> });
    }
  });
});

<span class="hljs-comment">// File information endpoint</span>
app.get(<span class="hljs-string">"/file-info/:filename"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> filename = req.params.filename;
  <span class="hljs-keyword">const</span> filePath = path.join(__dirname, <span class="hljs-string">"public"</span>, filename);

  fs.stat(filePath, (err, stats) =&gt; {
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"File not found"</span> });
    }

    res.json({
      filename,
      <span class="hljs-attr">size</span>: stats.size,
      <span class="hljs-attr">created</span>: stats.birthtime,
      <span class="hljs-attr">modified</span>: stats.mtime,
      <span class="hljs-attr">isFile</span>: stats.isFile(),
      <span class="hljs-attr">isDirectory</span>: stats.isDirectory(),
      <span class="hljs-attr">extension</span>: path.extname(filename),
      <span class="hljs-attr">mimeType</span>: getMimeType(filename),
    });
  });
});

<span class="hljs-comment">// Helper function to get MIME type</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getMimeType</span>(<span class="hljs-params">filename</span>) </span>{
  <span class="hljs-keyword">const</span> ext = path.extname(filename).toLowerCase();
  <span class="hljs-keyword">const</span> mimeTypes = {
    <span class="hljs-string">".html"</span>: <span class="hljs-string">"text/html"</span>,
    <span class="hljs-string">".css"</span>: <span class="hljs-string">"text/css"</span>,
    <span class="hljs-string">".js"</span>: <span class="hljs-string">"application/javascript"</span>,
    <span class="hljs-string">".json"</span>: <span class="hljs-string">"application/json"</span>,
    <span class="hljs-string">".png"</span>: <span class="hljs-string">"image/png"</span>,
    <span class="hljs-string">".jpg"</span>: <span class="hljs-string">"image/jpeg"</span>,
    <span class="hljs-string">".jpeg"</span>: <span class="hljs-string">"image/jpeg"</span>,
    <span class="hljs-string">".gif"</span>: <span class="hljs-string">"image/gif"</span>,
    <span class="hljs-string">".svg"</span>: <span class="hljs-string">"image/svg+xml"</span>,
    <span class="hljs-string">".pdf"</span>: <span class="hljs-string">"application/pdf"</span>,
    <span class="hljs-string">".txt"</span>: <span class="hljs-string">"text/plain"</span>,
  };
  <span class="hljs-keyword">return</span> mimeTypes[ext] || <span class="hljs-string">"application/octet-stream"</span>;
}

<span class="hljs-comment">// Serve SPA (Single Page Application)</span>
app.get(<span class="hljs-string">"*"</span>, (req, res) =&gt; {
  <span class="hljs-comment">// For SPA, serve index.html for all non-API routes</span>
  <span class="hljs-keyword">if</span> (!req.path.startsWith(<span class="hljs-string">"/api/"</span>)) {
    res.sendFile(path.join(__dirname, <span class="hljs-string">"public"</span>, <span class="hljs-string">"index.html"</span>));
  } <span class="hljs-keyword">else</span> {
    res.status(<span class="hljs-number">404</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"API endpoint not found"</span> });
  }
});

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
app.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</div></code></pre>
<h3 id="file-upload-and-static-serving">File Upload and Static Serving</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// upload-static.js</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> multer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'multer'</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Create upload directories</span>
<span class="hljs-keyword">const</span> uploadDirs = [<span class="hljs-string">'uploads/images'</span>, <span class="hljs-string">'uploads/documents'</span>, <span class="hljs-string">'uploads/temp'</span>];
uploadDirs.forEach(<span class="hljs-function"><span class="hljs-params">dir</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (!fs.existsSync(dir)) {
        fs.mkdirSync(dir, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
    }
});

<span class="hljs-comment">// Configure multer for file uploads</span>
<span class="hljs-keyword">const</span> storage = multer.diskStorage({
    <span class="hljs-attr">destination</span>: <span class="hljs-function">(<span class="hljs-params">req, file, cb</span>) =&gt;</span> {
        <span class="hljs-keyword">let</span> uploadPath = <span class="hljs-string">'uploads/temp'</span>;

        <span class="hljs-keyword">if</span> (file.mimetype.startsWith(<span class="hljs-string">'image/'</span>)) {
            uploadPath = <span class="hljs-string">'uploads/images'</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (file.mimetype === <span class="hljs-string">'application/pdf'</span> ||
                   file.mimetype.includes(<span class="hljs-string">'document'</span>)) {
            uploadPath = <span class="hljs-string">'uploads/documents'</span>;
        }

        cb(<span class="hljs-literal">null</span>, uploadPath);
    },
    <span class="hljs-attr">filename</span>: <span class="hljs-function">(<span class="hljs-params">req, file, cb</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> uniqueSuffix = <span class="hljs-built_in">Date</span>.now() + <span class="hljs-string">'-'</span> + <span class="hljs-built_in">Math</span>.round(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">1E9</span>);
        <span class="hljs-keyword">const</span> ext = path.extname(file.originalname);
        <span class="hljs-keyword">const</span> name = path.basename(file.originalname, ext);
        cb(<span class="hljs-literal">null</span>, <span class="hljs-string">`<span class="hljs-subst">${name}</span>-<span class="hljs-subst">${uniqueSuffix}</span><span class="hljs-subst">${ext}</span>`</span>);
    }
});

<span class="hljs-keyword">const</span> upload = multer({
    storage,
    <span class="hljs-attr">limits</span>: {
        <span class="hljs-attr">fileSize</span>: <span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> <span class="hljs-comment">// 10MB limit</span>
    },
    <span class="hljs-attr">fileFilter</span>: <span class="hljs-function">(<span class="hljs-params">req, file, cb</span>) =&gt;</span> {
        <span class="hljs-comment">// Allow specific file types</span>
        <span class="hljs-keyword">const</span> allowedTypes = [
            <span class="hljs-string">'image/jpeg'</span>,
            <span class="hljs-string">'image/png'</span>,
            <span class="hljs-string">'image/gif'</span>,
            <span class="hljs-string">'image/svg+xml'</span>,
            <span class="hljs-string">'application/pdf'</span>,
            <span class="hljs-string">'text/plain'</span>,
            <span class="hljs-string">'application/msword'</span>,
            <span class="hljs-string">'application/vnd.openxmlformats-officedocument.wordprocessingml.document'</span>
        ];

        <span class="hljs-keyword">if</span> (allowedTypes.includes(file.mimetype)) {
            cb(<span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>);
        } <span class="hljs-keyword">else</span> {
            cb(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'File type not allowed'</span>), <span class="hljs-literal">false</span>);
        }
    }
});

<span class="hljs-comment">// Serve uploaded files with different access levels</span>
app.use(<span class="hljs-string">'/uploads/images'</span>, express.static(<span class="hljs-string">'uploads/images'</span>, {
    <span class="hljs-attr">maxAge</span>: <span class="hljs-string">'7d'</span>,
    <span class="hljs-attr">setHeaders</span>: <span class="hljs-function">(<span class="hljs-params">res, path</span>) =&gt;</span> {
        res.set(<span class="hljs-string">'X-Content-Type-Options'</span>, <span class="hljs-string">'nosniff'</span>);
        <span class="hljs-keyword">if</span> (path.endsWith(<span class="hljs-string">'.svg'</span>)) {
            res.set(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'image/svg+xml'</span>);
        }
    }
}));

<span class="hljs-comment">// Protected document serving</span>
app.use(<span class="hljs-string">'/uploads/documents'</span>, (req, res, next) =&gt; {
    <span class="hljs-comment">// Simple authentication for documents</span>
    <span class="hljs-keyword">const</span> auth = req.get(<span class="hljs-string">'Authorization'</span>);
    <span class="hljs-keyword">if</span> (!auth || !auth.startsWith(<span class="hljs-string">'Bearer '</span>)) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">'Authentication required'</span> });
    }
    next();
}, express.static(<span class="hljs-string">'uploads/documents'</span>));

<span class="hljs-comment">// Temporary files with short cache</span>
app.use(<span class="hljs-string">'/uploads/temp'</span>, express.static(<span class="hljs-string">'uploads/temp'</span>, {
    <span class="hljs-attr">maxAge</span>: <span class="hljs-string">'1h'</span>
}));

<span class="hljs-comment">// File upload endpoint</span>
app.post(<span class="hljs-string">'/upload'</span>, upload.single(<span class="hljs-string">'file'</span>), (req, res) =&gt; {
    <span class="hljs-keyword">if</span> (!req.file) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">'No file uploaded'</span> });
    }

    <span class="hljs-keyword">const</span> fileInfo = {
        <span class="hljs-attr">originalName</span>: req.file.originalname,
        <span class="hljs-attr">filename</span>: req.file.filename,
        <span class="hljs-attr">size</span>: req.file.size,
        <span class="hljs-attr">mimetype</span>: req.file.mimetype,
        <span class="hljs-attr">path</span>: req.file.path,
        <span class="hljs-attr">url</span>: <span class="hljs-string">`/<span class="hljs-subst">${req.file.path.replace(<span class="hljs-regexp">/\\/g</span>, <span class="hljs-string">'/'</span>)}</span>`</span> <span class="hljs-comment">// Convert Windows paths</span>
    };

    res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">'File uploaded successfully'</span>,
        <span class="hljs-attr">file</span>: fileInfo
    });
});

<span class="hljs-comment">// Multiple file upload</span>
app.post(<span class="hljs-string">'/upload-multiple'</span>, upload.array(<span class="hljs-string">'files'</span>, <span class="hljs-number">5</span>), (req, res) =&gt; {
    <span class="hljs-keyword">if</span> (!req.files || req.files.length === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">'No files uploaded'</span> });
    }

    <span class="hljs-keyword">const</span> filesInfo = req.files.map(<span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> ({
        <span class="hljs-attr">originalName</span>: file.originalname,
        <span class="hljs-attr">filename</span>: file.filename,
        <span class="hljs-attr">size</span>: file.size,
        <span class="hljs-attr">mimetype</span>: file.mimetype,
        <span class="hljs-attr">url</span>: <span class="hljs-string">`/<span class="hljs-subst">${file.path.replace(<span class="hljs-regexp">/\\/g</span>, <span class="hljs-string">'/'</span>)}</span>`</span>
    }));

    res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">`<span class="hljs-subst">${req.files.length}</span> files uploaded successfully`</span>,
        <span class="hljs-attr">files</span>: filesInfo
    });
});

<span class="hljs-comment">// File gallery endpoint</span>
app.get(<span class="hljs-string">'/api/gallery'</span>, (req, res) =&gt; {
    <span class="hljs-keyword">const</span> imagesDir = path.join(__dirname, <span class="hljs-string">'uploads/images'</span>);

    fs.readdir(imagesDir, (err, files) =&gt; {
        <span class="hljs-keyword">if</span> (err) {
            <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">500</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">'Failed to read directory'</span> });
        }

        <span class="hljs-keyword">const</span> imageFiles = files
            .filter(<span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> <span class="hljs-regexp">/\.(jpg|jpeg|png|gif|svg)$/i</span>.test(file))
            .map(<span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> {
                <span class="hljs-keyword">const</span> filePath = path.join(imagesDir, file);
                <span class="hljs-keyword">const</span> stats = fs.statSync(filePath);

                <span class="hljs-keyword">return</span> {
                    <span class="hljs-attr">filename</span>: file,
                    <span class="hljs-attr">url</span>: <span class="hljs-string">`/uploads/images/<span class="hljs-subst">${file}</span>`</span>,
                    <span class="hljs-attr">size</span>: stats.size,
                    <span class="hljs-attr">modified</span>: stats.mtime
                };
            })
            .sort(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(b.modified) - <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(a.modified));

        res.json({
            <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">images</span>: imageFiles,
            <span class="hljs-attr">count</span>: imageFiles.length
        });
    });
});

<span class="hljs-comment">// File deletion endpoint</span>
app.delete(<span class="hljs-string">'/api/files/:filename'</span>, (req, res) =&gt; {
    <span class="hljs-keyword">const</span> filename = req.params.filename;

    <span class="hljs-comment">// Search in all upload directories</span>
    <span class="hljs-keyword">const</span> searchDirs = [<span class="hljs-string">'uploads/images'</span>, <span class="hljs-string">'uploads/documents'</span>, <span class="hljs-string">'uploads/temp'</span>];
    <span class="hljs-keyword">let</span> fileFound = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> dir <span class="hljs-keyword">of</span> searchDirs) {
        <span class="hljs-keyword">const</span> filePath = path.join(__dirname, dir, filename);

        <span class="hljs-keyword">if</span> (fs.existsSync(filePath)) {
            fs.unlinkSync(filePath);
            fileFound = <span class="hljs-literal">true</span>;

            res.json({
                <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">message</span>: <span class="hljs-string">'File deleted successfully'</span>,
                filename,
                <span class="hljs-attr">directory</span>: dir
            });
            <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-keyword">if</span> (!fileFound) {
        res.status(<span class="hljs-number">404</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">'File not found'</span> });
    }
});

<span class="hljs-comment">// Upload form page</span>
app.get(<span class="hljs-string">'/'</span>, (req, res) =&gt; {
    res.send(<span class="hljs-string">`
        &lt;!DOCTYPE html&gt;
        &lt;html&gt;
        &lt;head&gt;
            &lt;title&gt;File Upload Demo&lt;/title&gt;
            &lt;style&gt;
                body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                .upload-form { border: 1px solid #ddd; padding: 20px; margin: 20px 0; }
                .file-list { margin: 20px 0; }
                .file-item { padding: 10px; border: 1px solid #eee; margin: 5px 0; }
                img { max-width: 200px; max-height: 200px; }
            &lt;/style&gt;
        &lt;/head&gt;
        &lt;body&gt;
            &lt;h1&gt;File Upload and Static Serving Demo&lt;/h1&gt;

            &lt;div class="upload-form"&gt;
                &lt;h2&gt;Single File Upload&lt;/h2&gt;
                &lt;form action="/upload" method="post" enctype="multipart/form-data"&gt;
                    &lt;input type="file" name="file" required&gt;
                    &lt;button type="submit"&gt;Upload&lt;/button&gt;
                &lt;/form&gt;
            &lt;/div&gt;

            &lt;div class="upload-form"&gt;
                &lt;h2&gt;Multiple File Upload&lt;/h2&gt;
                &lt;form action="/upload-multiple" method="post" enctype="multipart/form-data"&gt;
                    &lt;input type="file" name="files" multiple required&gt;
                    &lt;button type="submit"&gt;Upload Files&lt;/button&gt;
                &lt;/form&gt;
            &lt;/div&gt;

            &lt;div class="file-list"&gt;
                &lt;h2&gt;Actions&lt;/h2&gt;
                &lt;button onclick="loadGallery()"&gt;Load Image Gallery&lt;/button&gt;
                &lt;div id="gallery"&gt;&lt;/div&gt;
            &lt;/div&gt;

            &lt;script&gt;
                async function loadGallery() {
                    try {
                        const response = await fetch('/api/gallery');
                        const data = await response.json();

                        const gallery = document.getElementById('gallery');
                        gallery.innerHTML = '&lt;h3&gt;Image Gallery&lt;/h3&gt;';

                        data.images.forEach(image =&gt; {
                            const div = document.createElement('div');
                            div.className = 'file-item';
                            div.innerHTML = `</span>
                                &lt;img src=<span class="hljs-string">"${image.url}"</span> alt=<span class="hljs-string">"${image.filename}"</span>&gt;
                                <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>${image.filename}<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
                                <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Size: ${(image.size / 1024).toFixed(2)} KB<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
                                <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Modified: ${new Date(image.modified).toLocaleString()}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
                                <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"deleteFile('${image.filename}')"</span>&gt;</span>Delete<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
                            <span class="hljs-string">`;
                            gallery.appendChild(div);
                        });
                    } catch (error) {
                        console.error('Error loading gallery:', error);
                    }
                }

                async function deleteFile(filename) {
                    if (confirm('Are you sure you want to delete this file?')) {
                        try {
                            const response = await fetch(`</span>/api/files/${filename}<span class="hljs-string">`, {
                                method: 'DELETE'
                            });

                            if (response.ok) {
                                alert('File deleted successfully');
                                loadGallery();
                            } else {
                                alert('Failed to delete file');
                            }
                        } catch (error) {
                            console.error('Error deleting file:', error);
                        }
                    }
                }
            &lt;/script&gt;
        &lt;/body&gt;
        &lt;/html&gt;
    `</span>);
});

<span class="hljs-comment">// Error handling for multer</span>
app.use(<span class="hljs-function">(<span class="hljs-params">error, req, res, next</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (error <span class="hljs-keyword">instanceof</span> multer.MulterError) {
        <span class="hljs-keyword">if</span> (error.code === <span class="hljs-string">'LIMIT_FILE_SIZE'</span>) {
            <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">'File too large'</span> });
        }
    }

    <span class="hljs-keyword">if</span> (error.message === <span class="hljs-string">'File type not allowed'</span>) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ <span class="hljs-attr">error</span>: error.message });
    }

    next(error);
});

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
app.listen(PORT, () =&gt; {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</div></code></pre>
<h2 id="real-world-use-case">Real-World Use Case</h2>
<h3 id="complete-static-file-server-with-cdn-like-features">Complete Static File Server with CDN-like Features</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// cdn-static-server.js</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">"crypto"</span>);
<span class="hljs-keyword">const</span> compression = <span class="hljs-built_in">require</span>(<span class="hljs-string">"compression"</span>);
<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Enable gzip compression</span>
app.use(compression());

<span class="hljs-comment">// Security headers middleware</span>
app.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  res.set({
    <span class="hljs-string">"X-Content-Type-Options"</span>: <span class="hljs-string">"nosniff"</span>,
    <span class="hljs-string">"X-Frame-Options"</span>: <span class="hljs-string">"DENY"</span>,
    <span class="hljs-string">"X-XSS-Protection"</span>: <span class="hljs-string">"1; mode=block"</span>,
    <span class="hljs-string">"Referrer-Policy"</span>: <span class="hljs-string">"strict-origin-when-cross-origin"</span>,
  });
  next();
});

<span class="hljs-comment">// CORS for static assets</span>
app.use(<span class="hljs-string">"/assets"</span>, (req, res, next) =&gt; {
  res.set({
    <span class="hljs-string">"Access-Control-Allow-Origin"</span>: <span class="hljs-string">"*"</span>,
    <span class="hljs-string">"Access-Control-Allow-Methods"</span>: <span class="hljs-string">"GET, HEAD, OPTIONS"</span>,
    <span class="hljs-string">"Access-Control-Allow-Headers"</span>:
      <span class="hljs-string">"Origin, X-Requested-With, Content-Type, Accept"</span>,
  });

  <span class="hljs-keyword">if</span> (req.method === <span class="hljs-string">"OPTIONS"</span>) {
    <span class="hljs-keyword">return</span> res.sendStatus(<span class="hljs-number">200</span>);
  }

  next();
});

<span class="hljs-comment">// Custom static middleware with versioning</span>
<span class="hljs-keyword">const</span> versionedStatic = <span class="hljs-function">(<span class="hljs-params">directory, options = {}</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> filePath = path.join(directory, req.path);

    <span class="hljs-comment">// Check if file exists</span>
    <span class="hljs-keyword">if</span> (!fs.existsSync(filePath)) {
      <span class="hljs-keyword">return</span> next();
    }

    <span class="hljs-keyword">const</span> stats = fs.statSync(filePath);

    <span class="hljs-comment">// Generate ETag based on file content</span>
    <span class="hljs-keyword">const</span> fileContent = fs.readFileSync(filePath);
    <span class="hljs-keyword">const</span> etag = crypto.createHash(<span class="hljs-string">"md5"</span>).update(fileContent).digest(<span class="hljs-string">"hex"</span>);

    <span class="hljs-comment">// Check if client has cached version</span>
    <span class="hljs-keyword">const</span> clientETag = req.get(<span class="hljs-string">"If-None-Match"</span>);
    <span class="hljs-keyword">if</span> (clientETag === etag) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">304</span>).end();
    }

    <span class="hljs-comment">// Set cache headers based on file type</span>
    <span class="hljs-keyword">const</span> ext = path.extname(filePath).toLowerCase();
    <span class="hljs-keyword">let</span> maxAge = <span class="hljs-string">"1d"</span>; <span class="hljs-comment">// Default 1 day</span>

    <span class="hljs-keyword">if</span> ([<span class="hljs-string">".css"</span>, <span class="hljs-string">".js"</span>].includes(ext)) {
      maxAge = <span class="hljs-string">"1y"</span>; <span class="hljs-comment">// CSS/JS cached for 1 year</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ([<span class="hljs-string">".png"</span>, <span class="hljs-string">".jpg"</span>, <span class="hljs-string">".jpeg"</span>, <span class="hljs-string">".gif"</span>, <span class="hljs-string">".svg"</span>].includes(ext)) {
      maxAge = <span class="hljs-string">"30d"</span>; <span class="hljs-comment">// Images cached for 30 days</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ([<span class="hljs-string">".html"</span>, <span class="hljs-string">".htm"</span>].includes(ext)) {
      maxAge = <span class="hljs-string">"1h"</span>; <span class="hljs-comment">// HTML cached for 1 hour</span>
    }

    <span class="hljs-comment">// Set response headers</span>
    res.set({
      <span class="hljs-string">"Cache-Control"</span>: <span class="hljs-string">`public, max-age=<span class="hljs-subst">${parseMaxAge(maxAge)}</span>`</span>,
      <span class="hljs-attr">ETag</span>: etag,
      <span class="hljs-string">"Last-Modified"</span>: stats.mtime.toUTCString(),
      <span class="hljs-string">"Content-Length"</span>: stats.size,
    });

    <span class="hljs-comment">// Set content type</span>
    <span class="hljs-keyword">const</span> mimeType = getMimeType(ext);
    <span class="hljs-keyword">if</span> (mimeType) {
      res.set(<span class="hljs-string">"Content-Type"</span>, mimeType);
    }

    <span class="hljs-comment">// Stream the file</span>
    <span class="hljs-keyword">const</span> stream = fs.createReadStream(filePath);
    stream.pipe(res);

    stream.on(<span class="hljs-string">"error"</span>, (err) =&gt; {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"File stream error:"</span>, err);
      <span class="hljs-keyword">if</span> (!res.headersSent) {
        res.status(<span class="hljs-number">500</span>).end();
      }
    });
  };
};

<span class="hljs-comment">// Helper function to parse max-age</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseMaxAge</span>(<span class="hljs-params">maxAge</span>) </span>{
  <span class="hljs-keyword">const</span> units = {
    <span class="hljs-attr">s</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">m</span>: <span class="hljs-number">60</span>,
    <span class="hljs-attr">h</span>: <span class="hljs-number">3600</span>,
    <span class="hljs-attr">d</span>: <span class="hljs-number">86400</span>,
    <span class="hljs-attr">w</span>: <span class="hljs-number">604800</span>,
    <span class="hljs-attr">y</span>: <span class="hljs-number">31536000</span>,
  };

  <span class="hljs-keyword">const</span> match = maxAge.match(<span class="hljs-regexp">/^(\d+)([smhdwy])$/</span>);
  <span class="hljs-keyword">if</span> (match) {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseInt</span>(match[<span class="hljs-number">1</span>]) * units[match[<span class="hljs-number">2</span>]];
  }
  <span class="hljs-keyword">return</span> <span class="hljs-number">86400</span>; <span class="hljs-comment">// Default 1 day</span>
}

<span class="hljs-comment">// Helper function for MIME types</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getMimeType</span>(<span class="hljs-params">ext</span>) </span>{
  <span class="hljs-keyword">const</span> mimeTypes = {
    <span class="hljs-string">".html"</span>: <span class="hljs-string">"text/html; charset=utf-8"</span>,
    <span class="hljs-string">".css"</span>: <span class="hljs-string">"text/css; charset=utf-8"</span>,
    <span class="hljs-string">".js"</span>: <span class="hljs-string">"application/javascript; charset=utf-8"</span>,
    <span class="hljs-string">".json"</span>: <span class="hljs-string">"application/json; charset=utf-8"</span>,
    <span class="hljs-string">".png"</span>: <span class="hljs-string">"image/png"</span>,
    <span class="hljs-string">".jpg"</span>: <span class="hljs-string">"image/jpeg"</span>,
    <span class="hljs-string">".jpeg"</span>: <span class="hljs-string">"image/jpeg"</span>,
    <span class="hljs-string">".gif"</span>: <span class="hljs-string">"image/gif"</span>,
    <span class="hljs-string">".svg"</span>: <span class="hljs-string">"image/svg+xml"</span>,
    <span class="hljs-string">".ico"</span>: <span class="hljs-string">"image/x-icon"</span>,
    <span class="hljs-string">".pdf"</span>: <span class="hljs-string">"application/pdf"</span>,
    <span class="hljs-string">".txt"</span>: <span class="hljs-string">"text/plain; charset=utf-8"</span>,
    <span class="hljs-string">".woff"</span>: <span class="hljs-string">"font/woff"</span>,
    <span class="hljs-string">".woff2"</span>: <span class="hljs-string">"font/woff2"</span>,
    <span class="hljs-string">".ttf"</span>: <span class="hljs-string">"font/ttf"</span>,
    <span class="hljs-string">".eot"</span>: <span class="hljs-string">"application/vnd.ms-fontobject"</span>,
  };
  <span class="hljs-keyword">return</span> mimeTypes[ext];
}

<span class="hljs-comment">// Use versioned static middleware</span>
app.use(<span class="hljs-string">"/assets"</span>, versionedStatic(path.join(__dirname, <span class="hljs-string">"assets"</span>)));
app.use(<span class="hljs-string">"/static"</span>, versionedStatic(path.join(__dirname, <span class="hljs-string">"public"</span>)));

<span class="hljs-comment">// Image optimization endpoint</span>
app.get(<span class="hljs-string">"/images/:size/:filename"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { size, filename } = req.params;
  <span class="hljs-keyword">const</span> originalPath = path.join(__dirname, <span class="hljs-string">"images"</span>, filename);

  <span class="hljs-comment">// Validate size parameter</span>
  <span class="hljs-keyword">const</span> validSizes = [<span class="hljs-string">"small"</span>, <span class="hljs-string">"medium"</span>, <span class="hljs-string">"large"</span>, <span class="hljs-string">"thumbnail"</span>];
  <span class="hljs-keyword">if</span> (!validSizes.includes(size)) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Invalid size parameter"</span> });
  }

  <span class="hljs-comment">// Check if original file exists</span>
  <span class="hljs-keyword">if</span> (!fs.existsSync(originalPath)) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Image not found"</span> });
  }

  <span class="hljs-comment">// For demo purposes, just serve the original</span>
  <span class="hljs-comment">// In production, you would resize the image here</span>
  res.set({
    <span class="hljs-string">"Cache-Control"</span>: <span class="hljs-string">"public, max-age=2592000"</span>, <span class="hljs-comment">// 30 days</span>
    <span class="hljs-string">"X-Image-Size"</span>: size,
  });

  res.sendFile(originalPath);
});

<span class="hljs-comment">// Asset manifest endpoint</span>
app.get(<span class="hljs-string">"/api/manifest"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> assetsDir = path.join(__dirname, <span class="hljs-string">"assets"</span>);
  <span class="hljs-keyword">const</span> manifest = {};

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scanDirectory</span>(<span class="hljs-params">dir, prefix = <span class="hljs-string">""</span></span>) </span>{
    <span class="hljs-keyword">const</span> files = fs.readdirSync(dir);

    files.forEach(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> filePath = path.join(dir, file);
      <span class="hljs-keyword">const</span> stats = fs.statSync(filePath);

      <span class="hljs-keyword">if</span> (stats.isDirectory()) {
        scanDirectory(filePath, <span class="hljs-string">`<span class="hljs-subst">${prefix}</span><span class="hljs-subst">${file}</span>/`</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">const</span> relativePath = <span class="hljs-string">`<span class="hljs-subst">${prefix}</span><span class="hljs-subst">${file}</span>`</span>;
        <span class="hljs-keyword">const</span> content = fs.readFileSync(filePath);
        <span class="hljs-keyword">const</span> hash = crypto
          .createHash(<span class="hljs-string">"md5"</span>)
          .update(content)
          .digest(<span class="hljs-string">"hex"</span>)
          .substring(<span class="hljs-number">0</span>, <span class="hljs-number">8</span>);

        manifest[relativePath] = {
          <span class="hljs-attr">path</span>: <span class="hljs-string">`/assets/<span class="hljs-subst">${relativePath}</span>`</span>,
          hash,
          <span class="hljs-attr">size</span>: stats.size,
          <span class="hljs-attr">modified</span>: stats.mtime.toISOString(),
        };
      }
    });
  }

  <span class="hljs-keyword">if</span> (fs.existsSync(assetsDir)) {
    scanDirectory(assetsDir);
  }

  res.json({
    manifest,
    <span class="hljs-attr">generated</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
    <span class="hljs-attr">count</span>: <span class="hljs-built_in">Object</span>.keys(manifest).length,
  });
});

<span class="hljs-comment">// Health check endpoint</span>
app.get(<span class="hljs-string">"/health"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> directories = [<span class="hljs-string">"assets"</span>, <span class="hljs-string">"public"</span>, <span class="hljs-string">"images"</span>];
  <span class="hljs-keyword">const</span> status = {};

  directories.forEach(<span class="hljs-function">(<span class="hljs-params">dir</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> dirPath = path.join(__dirname, dir);
    status[dir] = {
      <span class="hljs-attr">exists</span>: fs.existsSync(dirPath),
      <span class="hljs-attr">readable</span>: fs.existsSync(dirPath) ? fs.constants.R_OK : <span class="hljs-literal">false</span>,
    };
  });

  res.json({
    <span class="hljs-attr">status</span>: <span class="hljs-string">"healthy"</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
    <span class="hljs-attr">directories</span>: status,
    <span class="hljs-attr">uptime</span>: process.uptime(),
  });
});

<span class="hljs-comment">// Create sample directories and files</span>
<span class="hljs-keyword">const</span> sampleDirs = [
  <span class="hljs-string">"assets/css"</span>,
  <span class="hljs-string">"assets/js"</span>,
  <span class="hljs-string">"assets/images"</span>,
  <span class="hljs-string">"public"</span>,
  <span class="hljs-string">"images"</span>,
];
sampleDirs.forEach(<span class="hljs-function">(<span class="hljs-params">dir</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
  }
});

<span class="hljs-comment">// Create sample files</span>
<span class="hljs-keyword">const</span> sampleFiles = {
  <span class="hljs-string">"assets/css/style.css"</span>: <span class="hljs-string">"body { font-family: Arial, sans-serif; }"</span>,
  <span class="hljs-string">"assets/js/app.js"</span>: <span class="hljs-string">'console.log("App loaded");'</span>,
  <span class="hljs-string">"public/index.html"</span>:
    <span class="hljs-string">"&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;Demo&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Hello World&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;"</span>,
};

<span class="hljs-built_in">Object</span>.entries(sampleFiles).forEach(<span class="hljs-function">(<span class="hljs-params">[filePath, content]</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!fs.existsSync(filePath)) {
    fs.writeFileSync(filePath, content);
  }
});

<span class="hljs-comment">// Default route</span>
app.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  res.send(<span class="hljs-string">`
        &lt;!DOCTYPE html&gt;
        &lt;html&gt;
        &lt;head&gt;
            &lt;title&gt;CDN-like Static Server&lt;/title&gt;
            &lt;link rel="stylesheet" href="/assets/css/style.css"&gt;
        &lt;/head&gt;
        &lt;body&gt;
            &lt;h1&gt;CDN-like Static File Server&lt;/h1&gt;
            &lt;div&gt;
                &lt;h2&gt;Available Endpoints:&lt;/h2&gt;
                &lt;ul&gt;
                    &lt;li&gt;&lt;a href="/assets/css/style.css"&gt;/assets/css/style.css&lt;/a&gt;&lt;/li&gt;
                    &lt;li&gt;&lt;a href="/assets/js/app.js"&gt;/assets/js/app.js&lt;/a&gt;&lt;/li&gt;
                    &lt;li&gt;&lt;a href="/static/index.html"&gt;/static/index.html&lt;/a&gt;&lt;/li&gt;
                    &lt;li&gt;&lt;a href="/api/manifest"&gt;/api/manifest&lt;/a&gt;&lt;/li&gt;
                    &lt;li&gt;&lt;a href="/health"&gt;/health&lt;/a&gt;&lt;/li&gt;
                &lt;/ul&gt;
            &lt;/div&gt;
            &lt;script src="/assets/js/app.js"&gt;&lt;/script&gt;
        &lt;/body&gt;
        &lt;/html&gt;
    `</span>);
});

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
app.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🚀 CDN-like static server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</div></code></pre>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-organize-static-files-properly">1. Organize Static Files Properly</h3>
<pre class="hljs"><code><div>project/
├── public/
│   ├── css/
│   ├── js/
│   ├── images/
│   ├── fonts/
│   └── favicon.ico
├── uploads/
│   ├── images/
│   └── documents/
└── assets/
    ├── vendor/
    └── build/
</div></code></pre>
<h3 id="2-set-appropriate-cache-headers">2. Set Appropriate Cache Headers</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> cacheSettings = {
  <span class="hljs-comment">// Long cache for versioned assets</span>
  <span class="hljs-attr">versioned</span>: <span class="hljs-string">"public, max-age=31536000, immutable"</span>,

  <span class="hljs-comment">// Medium cache for images</span>
  <span class="hljs-attr">images</span>: <span class="hljs-string">"public, max-age=2592000"</span>,

  <span class="hljs-comment">// Short cache for HTML</span>
  <span class="hljs-attr">html</span>: <span class="hljs-string">"public, max-age=3600"</span>,

  <span class="hljs-comment">// No cache for development</span>
  <span class="hljs-attr">development</span>: <span class="hljs-string">"no-cache, no-store, must-revalidate"</span>,
};
</div></code></pre>
<h3 id="3-implement-security-headers">3. Implement Security Headers</h3>
<pre class="hljs"><code><div>app.use(<span class="hljs-string">"/static"</span>, (req, res, next) =&gt; {
  res.set({
    <span class="hljs-string">"X-Content-Type-Options"</span>: <span class="hljs-string">"nosniff"</span>,
    <span class="hljs-string">"X-Frame-Options"</span>: <span class="hljs-string">"DENY"</span>,
    <span class="hljs-string">"Content-Security-Policy"</span>: <span class="hljs-string">"default-src 'self'"</span>,
  });
  next();
});
</div></code></pre>
<h3 id="4-use-compression">4. Use Compression</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> compression = <span class="hljs-built_in">require</span>(<span class="hljs-string">"compression"</span>);
app.use(
  compression({
    <span class="hljs-attr">filter</span>: <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
      <span class="hljs-comment">// Don't compress responses if this request has a 'x-no-compression' header</span>
      <span class="hljs-keyword">if</span> (req.headers[<span class="hljs-string">"x-no-compression"</span>]) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
      <span class="hljs-comment">// Use compression filter function</span>
      <span class="hljs-keyword">return</span> compression.filter(req, res);
    },
  })
);
</div></code></pre>
<h3 id="5-handle-file-upload-security">5. Handle File Upload Security</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> upload = multer({
  <span class="hljs-attr">storage</span>: multer.diskStorage({
    <span class="hljs-attr">destination</span>: <span class="hljs-string">"uploads/"</span>,
    <span class="hljs-attr">filename</span>: <span class="hljs-function">(<span class="hljs-params">req, file, cb</span>) =&gt;</span> {
      <span class="hljs-comment">// Sanitize filename</span>
      <span class="hljs-keyword">const</span> sanitized = file.originalname.replace(<span class="hljs-regexp">/[^a-zA-Z0-9.-]/g</span>, <span class="hljs-string">"_"</span>);
      cb(<span class="hljs-literal">null</span>, <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>-<span class="hljs-subst">${sanitized}</span>`</span>);
    },
  }),
  <span class="hljs-attr">limits</span>: {
    <span class="hljs-attr">fileSize</span>: <span class="hljs-number">5</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>, <span class="hljs-comment">// 5MB</span>
    <span class="hljs-attr">files</span>: <span class="hljs-number">5</span>,
  },
  <span class="hljs-attr">fileFilter</span>: <span class="hljs-function">(<span class="hljs-params">req, file, cb</span>) =&gt;</span> {
    <span class="hljs-comment">// Whitelist allowed file types</span>
    <span class="hljs-keyword">const</span> allowedTypes = <span class="hljs-regexp">/jpeg|jpg|png|gif|pdf/</span>;
    <span class="hljs-keyword">const</span> extname = allowedTypes.test(
      path.extname(file.originalname).toLowerCase()
    );
    <span class="hljs-keyword">const</span> mimetype = allowedTypes.test(file.mimetype);

    <span class="hljs-keyword">if</span> (mimetype &amp;&amp; extname) {
      <span class="hljs-keyword">return</span> cb(<span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>);
    } <span class="hljs-keyword">else</span> {
      cb(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Invalid file type"</span>));
    }
  },
});
</div></code></pre>
<h2 id="summary">Summary</h2>
<p>Serving static files in Express.js involves:</p>
<p><strong>Basic Static Serving</strong>:</p>
<ul>
<li>Use <code>express.static()</code> middleware</li>
<li>Organize files in logical directories</li>
<li>Set virtual paths for clean URLs</li>
</ul>
<p><strong>Advanced Features</strong>:</p>
<ul>
<li>Custom cache headers for different file types</li>
<li>Security headers and CORS configuration</li>
<li>File upload handling with validation</li>
<li>Content compression and optimization</li>
</ul>
<p><strong>Performance Optimization</strong>:</p>
<ul>
<li>Implement proper caching strategies</li>
<li>Use ETags for cache validation</li>
<li>Enable gzip compression</li>
<li>Set appropriate max-age values</li>
</ul>
<p><strong>Security Considerations</strong>:</p>
<ul>
<li>Validate file types and sizes</li>
<li>Sanitize file names</li>
<li>Set security headers</li>
<li>Implement access controls</li>
</ul>
<p><strong>Production Features</strong>:</p>
<ul>
<li>Asset versioning and manifests</li>
<li>CDN-like caching behavior</li>
<li>Health checks and monitoring</li>
<li>Error handling and logging</li>
</ul>
<p>Mastering static file serving is essential for building performant web applications. Next, we'll explore environment variables and configuration management with dotenv.</p>
<h1 id="environment-variables-with-dotenv">Environment Variables with dotenv</h1>
<h2 id="overview">Overview</h2>
<p>Environment variables are key-value pairs that exist outside your application code and provide configuration data to your application at runtime. They are essential for managing different configurations across development, testing, and production environments without hardcoding sensitive information like API keys, database URLs, or server ports.</p>
<p>The <code>dotenv</code> package is a popular Node.js library that loads environment variables from a <code>.env</code> file into <code>process.env</code>, making it easy to manage configuration in development.</p>
<h2 id="key-concepts">Key Concepts</h2>
<h3 id="what-are-environment-variables">What are Environment Variables?</h3>
<p>Environment variables are:</p>
<ul>
<li>Configuration values stored outside your code</li>
<li>Accessible through <code>process.env</code> in Node.js</li>
<li>Different for each environment (dev, staging, production)</li>
<li>Secure way to store sensitive information</li>
<li>Platform-independent configuration method</li>
</ul>
<h3 id="why-use-environment-variables">Why Use Environment Variables?</h3>
<ol>
<li><strong>Security</strong>: Keep sensitive data out of source code</li>
<li><strong>Flexibility</strong>: Different configs for different environments</li>
<li><strong>Portability</strong>: Same code works across environments</li>
<li><strong>Best Practice</strong>: Industry standard for configuration</li>
<li><strong>CI/CD</strong>: Easy deployment configuration</li>
</ol>
<h3 id="the-dotenv-package">The dotenv Package</h3>
<p><code>dotenv</code> allows you to:</p>
<ul>
<li>Load variables from <code>.env</code> files</li>
<li>Override system environment variables</li>
<li>Support multiple environment files</li>
<li>Provide default values</li>
<li>Parse different data types</li>
</ul>
<h2 id="example-code">Example Code</h2>
<h3 id="basic-dotenv-setup">Basic dotenv Setup</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// basic-dotenv.js</span>
<span class="hljs-comment">// Load dotenv as early as possible</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">"dotenv"</span>).config();

<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Access environment variables</span>
<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
<span class="hljs-keyword">const</span> NODE_ENV = process.env.NODE_ENV || <span class="hljs-string">"development"</span>;
<span class="hljs-keyword">const</span> API_KEY = process.env.API_KEY;
<span class="hljs-keyword">const</span> DATABASE_URL = process.env.DATABASE_URL;

<span class="hljs-comment">// Middleware</span>
app.use(express.json());

<span class="hljs-comment">// Environment info endpoint</span>
app.get(<span class="hljs-string">"/env-info"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">environment</span>: NODE_ENV,
    <span class="hljs-attr">port</span>: PORT,
    <span class="hljs-attr">hasApiKey</span>: !!API_KEY,
    <span class="hljs-attr">hasDatabaseUrl</span>: !!DATABASE_URL,
    <span class="hljs-attr">nodeVersion</span>: process.version,
    <span class="hljs-attr">platform</span>: process.platform,
    <span class="hljs-comment">// Never expose sensitive values directly</span>
    <span class="hljs-attr">apiKeyLength</span>: API_KEY ? API_KEY.length : <span class="hljs-number">0</span>,
  });
});

<span class="hljs-comment">// Configuration endpoint</span>
app.get(<span class="hljs-string">"/config"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> config = {
    <span class="hljs-attr">server</span>: {
      <span class="hljs-attr">port</span>: PORT,
      <span class="hljs-attr">environment</span>: NODE_ENV,
      <span class="hljs-attr">debug</span>: process.env.DEBUG === <span class="hljs-string">"true"</span>,
    },
    <span class="hljs-attr">features</span>: {
      <span class="hljs-attr">enableLogging</span>: process.env.ENABLE_LOGGING !== <span class="hljs-string">"false"</span>,
      <span class="hljs-attr">maxUploadSize</span>: process.env.MAX_UPLOAD_SIZE || <span class="hljs-string">"10mb"</span>,
      <span class="hljs-attr">rateLimitWindow</span>: <span class="hljs-built_in">parseInt</span>(process.env.RATE_LIMIT_WINDOW) || <span class="hljs-number">900000</span>,
    },
    <span class="hljs-attr">external</span>: {
      <span class="hljs-attr">hasApiKey</span>: !!API_KEY,
      <span class="hljs-attr">hasDatabase</span>: !!DATABASE_URL,
      <span class="hljs-attr">redisUrl</span>: process.env.REDIS_URL ? <span class="hljs-string">"configured"</span> : <span class="hljs-string">"not configured"</span>,
    },
  };

  res.json(config);
});

<span class="hljs-comment">// Health check with environment validation</span>
app.get(<span class="hljs-string">"/health"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> requiredVars = [<span class="hljs-string">"API_KEY"</span>, <span class="hljs-string">"DATABASE_URL"</span>];
  <span class="hljs-keyword">const</span> missing = requiredVars.filter(<span class="hljs-function">(<span class="hljs-params">varName</span>) =&gt;</span> !process.env[varName]);

  <span class="hljs-keyword">const</span> health = {
    <span class="hljs-attr">status</span>: missing.length === <span class="hljs-number">0</span> ? <span class="hljs-string">"healthy"</span> : <span class="hljs-string">"unhealthy"</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
    <span class="hljs-attr">environment</span>: NODE_ENV,
    <span class="hljs-attr">missingVariables</span>: missing,
    <span class="hljs-attr">uptime</span>: process.uptime(),
  };

  <span class="hljs-keyword">const</span> statusCode = health.status === <span class="hljs-string">"healthy"</span> ? <span class="hljs-number">200</span> : <span class="hljs-number">503</span>;
  res.status(statusCode).json(health);
});

app.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🚀 Server running on port <span class="hljs-subst">${PORT}</span>`</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`📊 Environment: <span class="hljs-subst">${NODE_ENV}</span>`</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🔑 API Key: <span class="hljs-subst">${API_KEY ? <span class="hljs-string">"Loaded"</span> : <span class="hljs-string">"Missing"</span>}</span>`</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🗄️  Database: <span class="hljs-subst">${DATABASE_URL ? <span class="hljs-string">"Configured"</span> : <span class="hljs-string">"Missing"</span>}</span>`</span>);
});
</div></code></pre>
<h3 id="advanced-dotenv-configuration">Advanced dotenv Configuration</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// advanced-dotenv.js</span>
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);

<span class="hljs-comment">// Custom dotenv configuration</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">"dotenv"</span>).config({
  <span class="hljs-attr">path</span>: path.join(__dirname, <span class="hljs-string">".env"</span>), <span class="hljs-comment">// Custom path</span>
  <span class="hljs-attr">debug</span>: process.env.DEBUG_DOTENV === <span class="hljs-string">"true"</span>, <span class="hljs-comment">// Debug mode</span>
  <span class="hljs-attr">override</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// Don't override existing env vars</span>
});

<span class="hljs-comment">// Load environment-specific files</span>
<span class="hljs-keyword">const</span> NODE_ENV = process.env.NODE_ENV || <span class="hljs-string">"development"</span>;
<span class="hljs-keyword">const</span> envFiles = [
  <span class="hljs-string">`.env.<span class="hljs-subst">${NODE_ENV}</span>.local`</span>,
  <span class="hljs-string">`.env.<span class="hljs-subst">${NODE_ENV}</span>`</span>,
  <span class="hljs-string">".env.local"</span>,
  <span class="hljs-string">".env"</span>,
];

<span class="hljs-comment">// Load multiple env files in order of priority</span>
envFiles.forEach(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> {
  <span class="hljs-built_in">require</span>(<span class="hljs-string">"dotenv"</span>).config({
    <span class="hljs-attr">path</span>: path.join(__dirname, file),
    <span class="hljs-attr">override</span>: <span class="hljs-literal">false</span>,
  });
});

<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Configuration class</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Config</span> </span>{
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.server = {
      <span class="hljs-attr">port</span>: <span class="hljs-keyword">this</span>.getNumber(<span class="hljs-string">"PORT"</span>, <span class="hljs-number">3000</span>),
      <span class="hljs-attr">host</span>: <span class="hljs-keyword">this</span>.getString(<span class="hljs-string">"HOST"</span>, <span class="hljs-string">"localhost"</span>),
      <span class="hljs-attr">environment</span>: <span class="hljs-keyword">this</span>.getString(<span class="hljs-string">"NODE_ENV"</span>, <span class="hljs-string">"development"</span>),
    };

    <span class="hljs-keyword">this</span>.database = {
      <span class="hljs-attr">url</span>: <span class="hljs-keyword">this</span>.getString(<span class="hljs-string">"DATABASE_URL"</span>),
      <span class="hljs-attr">maxConnections</span>: <span class="hljs-keyword">this</span>.getNumber(<span class="hljs-string">"DB_MAX_CONNECTIONS"</span>, <span class="hljs-number">10</span>),
      <span class="hljs-attr">timeout</span>: <span class="hljs-keyword">this</span>.getNumber(<span class="hljs-string">"DB_TIMEOUT"</span>, <span class="hljs-number">30000</span>),
      <span class="hljs-attr">ssl</span>: <span class="hljs-keyword">this</span>.getBoolean(<span class="hljs-string">"DB_SSL"</span>, <span class="hljs-literal">false</span>),
    };

    <span class="hljs-keyword">this</span>.redis = {
      <span class="hljs-attr">url</span>: <span class="hljs-keyword">this</span>.getString(<span class="hljs-string">"REDIS_URL"</span>),
      <span class="hljs-attr">ttl</span>: <span class="hljs-keyword">this</span>.getNumber(<span class="hljs-string">"REDIS_TTL"</span>, <span class="hljs-number">3600</span>),
    };

    <span class="hljs-keyword">this</span>.auth = {
      <span class="hljs-attr">jwtSecret</span>: <span class="hljs-keyword">this</span>.getString(<span class="hljs-string">"JWT_SECRET"</span>),
      <span class="hljs-attr">jwtExpiry</span>: <span class="hljs-keyword">this</span>.getString(<span class="hljs-string">"JWT_EXPIRY"</span>, <span class="hljs-string">"24h"</span>),
      <span class="hljs-attr">bcryptRounds</span>: <span class="hljs-keyword">this</span>.getNumber(<span class="hljs-string">"BCRYPT_ROUNDS"</span>, <span class="hljs-number">12</span>),
    };

    <span class="hljs-keyword">this</span>.external = {
      <span class="hljs-attr">apiKey</span>: <span class="hljs-keyword">this</span>.getString(<span class="hljs-string">"API_KEY"</span>),
      <span class="hljs-attr">apiUrl</span>: <span class="hljs-keyword">this</span>.getString(<span class="hljs-string">"API_URL"</span>, <span class="hljs-string">"https://api.example.com"</span>),
      <span class="hljs-attr">webhookSecret</span>: <span class="hljs-keyword">this</span>.getString(<span class="hljs-string">"WEBHOOK_SECRET"</span>),
    };

    <span class="hljs-keyword">this</span>.features = {
      <span class="hljs-attr">enableLogging</span>: <span class="hljs-keyword">this</span>.getBoolean(<span class="hljs-string">"ENABLE_LOGGING"</span>, <span class="hljs-literal">true</span>),
      <span class="hljs-attr">enableMetrics</span>: <span class="hljs-keyword">this</span>.getBoolean(<span class="hljs-string">"ENABLE_METRICS"</span>, <span class="hljs-literal">false</span>),
      <span class="hljs-attr">enableCache</span>: <span class="hljs-keyword">this</span>.getBoolean(<span class="hljs-string">"ENABLE_CACHE"</span>, <span class="hljs-literal">true</span>),
      <span class="hljs-attr">maxUploadSize</span>: <span class="hljs-keyword">this</span>.getString(<span class="hljs-string">"MAX_UPLOAD_SIZE"</span>, <span class="hljs-string">"10mb"</span>),
    };

    <span class="hljs-keyword">this</span>.security = {
      <span class="hljs-attr">corsOrigin</span>: <span class="hljs-keyword">this</span>.getArray(<span class="hljs-string">"CORS_ORIGIN"</span>, [<span class="hljs-string">"http://localhost:3000"</span>]),
      <span class="hljs-attr">rateLimitWindow</span>: <span class="hljs-keyword">this</span>.getNumber(<span class="hljs-string">"RATE_LIMIT_WINDOW"</span>, <span class="hljs-number">900000</span>),
      <span class="hljs-attr">rateLimitMax</span>: <span class="hljs-keyword">this</span>.getNumber(<span class="hljs-string">"RATE_LIMIT_MAX"</span>, <span class="hljs-number">100</span>),
    };

    <span class="hljs-comment">// Validate required variables</span>
    <span class="hljs-keyword">this</span>.validate();
  }

  getString(key, defaultValue = <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">const</span> value = process.env[key];
    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span> &amp;&amp; defaultValue === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Required environment variable <span class="hljs-subst">${key}</span> is not set`</span>);
    }
    <span class="hljs-keyword">return</span> value || defaultValue;
  }

  getNumber(key, defaultValue = <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">const</span> value = process.env[key];
    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">if</span> (defaultValue === <span class="hljs-literal">undefined</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Required environment variable <span class="hljs-subst">${key}</span> is not set`</span>);
      }
      <span class="hljs-keyword">return</span> defaultValue;
    }

    <span class="hljs-keyword">const</span> parsed = <span class="hljs-built_in">parseInt</span>(value, <span class="hljs-number">10</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(parsed)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(
        <span class="hljs-string">`Environment variable <span class="hljs-subst">${key}</span> must be a number, got: <span class="hljs-subst">${value}</span>`</span>
      );
    }
    <span class="hljs-keyword">return</span> parsed;
  }

  getBoolean(key, defaultValue = <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">const</span> value = process.env[key];
    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">if</span> (defaultValue === <span class="hljs-literal">undefined</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Required environment variable <span class="hljs-subst">${key}</span> is not set`</span>);
      }
      <span class="hljs-keyword">return</span> defaultValue;
    }

    <span class="hljs-keyword">return</span> value.toLowerCase() === <span class="hljs-string">"true"</span>;
  }

  getArray(key, defaultValue = <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">const</span> value = process.env[key];
    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">if</span> (defaultValue === <span class="hljs-literal">undefined</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Required environment variable <span class="hljs-subst">${key}</span> is not set`</span>);
      }
      <span class="hljs-keyword">return</span> defaultValue;
    }

    <span class="hljs-keyword">return</span> value.split(<span class="hljs-string">","</span>).map(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.trim());
  }

  validate() {
    <span class="hljs-keyword">const</span> requiredVars = {
      <span class="hljs-attr">production</span>: [<span class="hljs-string">"DATABASE_URL"</span>, <span class="hljs-string">"JWT_SECRET"</span>, <span class="hljs-string">"API_KEY"</span>],
      <span class="hljs-attr">development</span>: [<span class="hljs-string">"DATABASE_URL"</span>],
      <span class="hljs-attr">test</span>: [],
    };

    <span class="hljs-keyword">const</span> required = requiredVars[<span class="hljs-keyword">this</span>.server.environment] || [];
    <span class="hljs-keyword">const</span> missing = required.filter(<span class="hljs-function">(<span class="hljs-params">varName</span>) =&gt;</span> !process.env[varName]);

    <span class="hljs-keyword">if</span> (missing.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(
        <span class="hljs-string">`Missing required environment variables: <span class="hljs-subst">${missing.join(<span class="hljs-string">", "</span>)}</span>`</span>
      );
    }
  }

  <span class="hljs-comment">// Get sanitized config for logging (no secrets)</span>
  getSanitized() {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">server</span>: <span class="hljs-keyword">this</span>.server,
      <span class="hljs-attr">database</span>: {
        ...this.database,
        <span class="hljs-attr">url</span>: <span class="hljs-keyword">this</span>.database.url ? <span class="hljs-string">"[CONFIGURED]"</span> : <span class="hljs-string">"[NOT SET]"</span>,
      },
      <span class="hljs-attr">redis</span>: {
        ...this.redis,
        <span class="hljs-attr">url</span>: <span class="hljs-keyword">this</span>.redis.url ? <span class="hljs-string">"[CONFIGURED]"</span> : <span class="hljs-string">"[NOT SET]"</span>,
      },
      <span class="hljs-attr">auth</span>: {
        <span class="hljs-attr">jwtExpiry</span>: <span class="hljs-keyword">this</span>.auth.jwtExpiry,
        <span class="hljs-attr">bcryptRounds</span>: <span class="hljs-keyword">this</span>.auth.bcryptRounds,
        <span class="hljs-attr">jwtSecret</span>: <span class="hljs-keyword">this</span>.auth.jwtSecret ? <span class="hljs-string">"[CONFIGURED]"</span> : <span class="hljs-string">"[NOT SET]"</span>,
      },
      <span class="hljs-attr">external</span>: {
        <span class="hljs-attr">apiUrl</span>: <span class="hljs-keyword">this</span>.external.apiUrl,
        <span class="hljs-attr">apiKey</span>: <span class="hljs-keyword">this</span>.external.apiKey ? <span class="hljs-string">"[CONFIGURED]"</span> : <span class="hljs-string">"[NOT SET]"</span>,
        <span class="hljs-attr">webhookSecret</span>: <span class="hljs-keyword">this</span>.external.webhookSecret
          ? <span class="hljs-string">"[CONFIGURED]"</span>
          : <span class="hljs-string">"[NOT SET]"</span>,
      },
      <span class="hljs-attr">features</span>: <span class="hljs-keyword">this</span>.features,
      <span class="hljs-attr">security</span>: <span class="hljs-keyword">this</span>.security,
    };
  }
}

<span class="hljs-comment">// Initialize configuration</span>
<span class="hljs-keyword">const</span> config = <span class="hljs-keyword">new</span> Config();

app.use(express.json());

<span class="hljs-comment">// Configuration endpoint</span>
app.get(<span class="hljs-string">"/api/config"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">config</span>: config.getSanitized(),
  });
});

<span class="hljs-comment">// Environment variables endpoint</span>
app.get(<span class="hljs-string">"/api/env"</span>, (req, res) =&gt; {
  <span class="hljs-comment">// Only show non-sensitive environment info</span>
  <span class="hljs-keyword">const</span> envInfo = {
    <span class="hljs-attr">nodeVersion</span>: process.version,
    <span class="hljs-attr">platform</span>: process.platform,
    <span class="hljs-attr">architecture</span>: process.arch,
    <span class="hljs-attr">environment</span>: config.server.environment,
    <span class="hljs-attr">uptime</span>: process.uptime(),
    <span class="hljs-attr">memoryUsage</span>: process.memoryUsage(),
    <span class="hljs-attr">loadedEnvFiles</span>: envFiles.filter(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>).accessSync(path.join(__dirname, file));
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">catch</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
    }),
  };

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">environment</span>: envInfo,
  });
});

<span class="hljs-comment">// Feature flags endpoint</span>
app.get(<span class="hljs-string">"/api/features"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">features</span>: config.features,
  });
});

<span class="hljs-comment">// Validation endpoint</span>
app.get(<span class="hljs-string">"/api/validate"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// Re-validate configuration</span>
    config.validate();

    res.json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Configuration is valid"</span>,
      <span class="hljs-attr">environment</span>: config.server.environment,
    });
  } <span class="hljs-keyword">catch</span> (error) {
    res.status(<span class="hljs-number">500</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: error.message,
    });
  }
});

app.listen(config.server.port, config.server.host, () =&gt; {
  <span class="hljs-built_in">console</span>.log(
    <span class="hljs-string">`🚀 Server running on <span class="hljs-subst">${config.server.host}</span>:<span class="hljs-subst">${config.server.port}</span>`</span>
  );
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`📊 Environment: <span class="hljs-subst">${config.server.environment}</span>`</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"📋 Configuration loaded successfully"</span>);

  <span class="hljs-keyword">if</span> (config.server.environment === <span class="hljs-string">"development"</span>) {
    <span class="hljs-built_in">console</span>.log(
      <span class="hljs-string">"🔧 Sanitized config:"</span>,
      <span class="hljs-built_in">JSON</span>.stringify(config.getSanitized(), <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>)
    );
  }
});

<span class="hljs-comment">// Export config for use in other modules</span>
<span class="hljs-built_in">module</span>.exports = config;
</div></code></pre>
<h3 id="environment-specific-configuration">Environment-Specific Configuration</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// config-manager.js</span>
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigManager</span> </span>{
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.loadEnvironmentFiles();
    <span class="hljs-keyword">this</span>.config = <span class="hljs-keyword">this</span>.buildConfig();
  }

  loadEnvironmentFiles() {
    <span class="hljs-keyword">const</span> NODE_ENV = process.env.NODE_ENV || <span class="hljs-string">"development"</span>;

    <span class="hljs-comment">// Priority order: most specific to least specific</span>
    <span class="hljs-keyword">const</span> envFiles = [
      <span class="hljs-string">`.env.<span class="hljs-subst">${NODE_ENV}</span>.local`</span>,
      <span class="hljs-string">`.env.local`</span>,
      <span class="hljs-string">`.env.<span class="hljs-subst">${NODE_ENV}</span>`</span>,
      <span class="hljs-string">".env"</span>,
    ];

    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Loading environment files for: <span class="hljs-subst">${NODE_ENV}</span>`</span>);

    envFiles.forEach(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> filePath = path.join(process.cwd(), file);

      <span class="hljs-keyword">if</span> (fs.existsSync(filePath)) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`✅ Loading <span class="hljs-subst">${file}</span>`</span>);
        <span class="hljs-built_in">require</span>(<span class="hljs-string">"dotenv"</span>).config({
          <span class="hljs-attr">path</span>: filePath,
          <span class="hljs-attr">override</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// Don't override already set variables</span>
        });
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`⏭️  Skipping <span class="hljs-subst">${file}</span> (not found)`</span>);
      }
    });
  }

  buildConfig() {
    <span class="hljs-keyword">const</span> env = process.env.NODE_ENV || <span class="hljs-string">"development"</span>;

    <span class="hljs-keyword">const</span> baseConfig = {
      <span class="hljs-attr">app</span>: {
        <span class="hljs-attr">name</span>: process.env.APP_NAME || <span class="hljs-string">"My App"</span>,
        <span class="hljs-attr">version</span>: process.env.APP_VERSION || <span class="hljs-string">"1.0.0"</span>,
        <span class="hljs-attr">environment</span>: env,
        <span class="hljs-attr">debug</span>: <span class="hljs-keyword">this</span>.parseBoolean(process.env.DEBUG, env === <span class="hljs-string">"development"</span>),
      },

      <span class="hljs-attr">server</span>: {
        <span class="hljs-attr">port</span>: <span class="hljs-keyword">this</span>.parseNumber(process.env.PORT, <span class="hljs-number">3000</span>),
        <span class="hljs-attr">host</span>: process.env.HOST || <span class="hljs-string">"0.0.0.0"</span>,
        <span class="hljs-attr">timeout</span>: <span class="hljs-keyword">this</span>.parseNumber(process.env.SERVER_TIMEOUT, <span class="hljs-number">30000</span>),
        <span class="hljs-attr">keepAliveTimeout</span>: <span class="hljs-keyword">this</span>.parseNumber(
          process.env.KEEP_ALIVE_TIMEOUT,
          <span class="hljs-number">5000</span>
        ),
      },

      <span class="hljs-attr">database</span>: {
        <span class="hljs-attr">url</span>: process.env.DATABASE_URL,
        <span class="hljs-attr">host</span>: process.env.DB_HOST || <span class="hljs-string">"localhost"</span>,
        <span class="hljs-attr">port</span>: <span class="hljs-keyword">this</span>.parseNumber(process.env.DB_PORT, <span class="hljs-number">5432</span>),
        <span class="hljs-attr">name</span>: process.env.DB_NAME || <span class="hljs-string">"myapp"</span>,
        <span class="hljs-attr">username</span>: process.env.DB_USERNAME || <span class="hljs-string">"postgres"</span>,
        <span class="hljs-attr">password</span>: process.env.DB_PASSWORD,
        <span class="hljs-attr">ssl</span>: <span class="hljs-keyword">this</span>.parseBoolean(process.env.DB_SSL, env === <span class="hljs-string">"production"</span>),
        <span class="hljs-attr">pool</span>: {
          <span class="hljs-attr">min</span>: <span class="hljs-keyword">this</span>.parseNumber(process.env.DB_POOL_MIN, <span class="hljs-number">2</span>),
          <span class="hljs-attr">max</span>: <span class="hljs-keyword">this</span>.parseNumber(process.env.DB_POOL_MAX, <span class="hljs-number">10</span>),
          <span class="hljs-attr">idle</span>: <span class="hljs-keyword">this</span>.parseNumber(process.env.DB_POOL_IDLE, <span class="hljs-number">10000</span>),
        },
      },

      <span class="hljs-attr">redis</span>: {
        <span class="hljs-attr">url</span>: process.env.REDIS_URL,
        <span class="hljs-attr">host</span>: process.env.REDIS_HOST || <span class="hljs-string">"localhost"</span>,
        <span class="hljs-attr">port</span>: <span class="hljs-keyword">this</span>.parseNumber(process.env.REDIS_PORT, <span class="hljs-number">6379</span>),
        <span class="hljs-attr">password</span>: process.env.REDIS_PASSWORD,
        <span class="hljs-attr">db</span>: <span class="hljs-keyword">this</span>.parseNumber(process.env.REDIS_DB, <span class="hljs-number">0</span>),
        <span class="hljs-attr">ttl</span>: <span class="hljs-keyword">this</span>.parseNumber(process.env.REDIS_TTL, <span class="hljs-number">3600</span>),
      },

      <span class="hljs-attr">auth</span>: {
        <span class="hljs-attr">jwtSecret</span>: process.env.JWT_SECRET,
        <span class="hljs-attr">jwtExpiry</span>: process.env.JWT_EXPIRY || <span class="hljs-string">"24h"</span>,
        <span class="hljs-attr">refreshTokenExpiry</span>: process.env.REFRESH_TOKEN_EXPIRY || <span class="hljs-string">"7d"</span>,
        <span class="hljs-attr">bcryptRounds</span>: <span class="hljs-keyword">this</span>.parseNumber(process.env.BCRYPT_ROUNDS, <span class="hljs-number">12</span>),
        <span class="hljs-attr">sessionSecret</span>: process.env.SESSION_SECRET,
        <span class="hljs-attr">cookieMaxAge</span>: <span class="hljs-keyword">this</span>.parseNumber(process.env.COOKIE_MAX_AGE, <span class="hljs-number">86400000</span>),
      },

      <span class="hljs-attr">email</span>: {
        <span class="hljs-attr">provider</span>: process.env.EMAIL_PROVIDER || <span class="hljs-string">"smtp"</span>,
        <span class="hljs-attr">host</span>: process.env.EMAIL_HOST,
        <span class="hljs-attr">port</span>: <span class="hljs-keyword">this</span>.parseNumber(process.env.EMAIL_PORT, <span class="hljs-number">587</span>),
        <span class="hljs-attr">secure</span>: <span class="hljs-keyword">this</span>.parseBoolean(process.env.EMAIL_SECURE, <span class="hljs-literal">false</span>),
        <span class="hljs-attr">username</span>: process.env.EMAIL_USERNAME,
        <span class="hljs-attr">password</span>: process.env.EMAIL_PASSWORD,
        <span class="hljs-attr">from</span>: process.env.EMAIL_FROM || <span class="hljs-string">"noreply@example.com"</span>,
      },

      <span class="hljs-attr">storage</span>: {
        <span class="hljs-attr">provider</span>: process.env.STORAGE_PROVIDER || <span class="hljs-string">"local"</span>,
        <span class="hljs-attr">bucket</span>: process.env.STORAGE_BUCKET,
        <span class="hljs-attr">region</span>: process.env.STORAGE_REGION,
        <span class="hljs-attr">accessKey</span>: process.env.STORAGE_ACCESS_KEY,
        <span class="hljs-attr">secretKey</span>: process.env.STORAGE_SECRET_KEY,
        <span class="hljs-attr">uploadPath</span>: process.env.UPLOAD_PATH || <span class="hljs-string">"./uploads"</span>,
        <span class="hljs-attr">maxFileSize</span>: process.env.MAX_FILE_SIZE || <span class="hljs-string">"10mb"</span>,
      },

      <span class="hljs-attr">logging</span>: {
        <span class="hljs-attr">level</span>:
          process.env.LOG_LEVEL || (env === <span class="hljs-string">"production"</span> ? <span class="hljs-string">"info"</span> : <span class="hljs-string">"debug"</span>),
        <span class="hljs-attr">file</span>: <span class="hljs-keyword">this</span>.parseBoolean(process.env.LOG_TO_FILE, env === <span class="hljs-string">"production"</span>),
        <span class="hljs-attr">console</span>: <span class="hljs-keyword">this</span>.parseBoolean(process.env.LOG_TO_CONSOLE, <span class="hljs-literal">true</span>),
        <span class="hljs-attr">logPath</span>: process.env.LOG_PATH || <span class="hljs-string">"./logs"</span>,
      },

      <span class="hljs-attr">security</span>: {
        <span class="hljs-attr">corsOrigin</span>: <span class="hljs-keyword">this</span>.parseArray(process.env.CORS_ORIGIN, [
          <span class="hljs-string">"http://localhost:3000"</span>,
        ]),
        <span class="hljs-attr">rateLimitWindow</span>: <span class="hljs-keyword">this</span>.parseNumber(
          process.env.RATE_LIMIT_WINDOW,
          <span class="hljs-number">900000</span>
        ),
        <span class="hljs-attr">rateLimitMax</span>: <span class="hljs-keyword">this</span>.parseNumber(process.env.RATE_LIMIT_MAX, <span class="hljs-number">100</span>),
        <span class="hljs-attr">helmetEnabled</span>: <span class="hljs-keyword">this</span>.parseBoolean(process.env.HELMET_ENABLED, <span class="hljs-literal">true</span>),
        <span class="hljs-attr">csrfEnabled</span>: <span class="hljs-keyword">this</span>.parseBoolean(
          process.env.CSRF_ENABLED,
          env === <span class="hljs-string">"production"</span>
        ),
      },

      <span class="hljs-attr">monitoring</span>: {
        <span class="hljs-attr">enabled</span>: <span class="hljs-keyword">this</span>.parseBoolean(
          process.env.MONITORING_ENABLED,
          env === <span class="hljs-string">"production"</span>
        ),
        <span class="hljs-attr">metricsPort</span>: <span class="hljs-keyword">this</span>.parseNumber(process.env.METRICS_PORT, <span class="hljs-number">9090</span>),
        <span class="hljs-attr">healthCheckPath</span>: process.env.HEALTH_CHECK_PATH || <span class="hljs-string">"/health"</span>,
      },
    };

    <span class="hljs-comment">// Environment-specific overrides</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.applyEnvironmentOverrides(baseConfig, env);
  }

  applyEnvironmentOverrides(config, env) {
    <span class="hljs-keyword">const</span> overrides = {
      <span class="hljs-attr">development</span>: {
        <span class="hljs-attr">database</span>: {
          <span class="hljs-attr">ssl</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">pool</span>: { <span class="hljs-attr">max</span>: <span class="hljs-number">5</span> },
        },
        <span class="hljs-attr">logging</span>: {
          <span class="hljs-attr">level</span>: <span class="hljs-string">"debug"</span>,
          <span class="hljs-attr">console</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">file</span>: <span class="hljs-literal">false</span>,
        },
        <span class="hljs-attr">security</span>: {
          <span class="hljs-attr">corsOrigin</span>: [<span class="hljs-string">"*"</span>],
          <span class="hljs-attr">csrfEnabled</span>: <span class="hljs-literal">false</span>,
        },
      },

      <span class="hljs-attr">test</span>: {
        <span class="hljs-attr">database</span>: {
          <span class="hljs-attr">name</span>: config.database.name + <span class="hljs-string">"_test"</span>,
          <span class="hljs-attr">pool</span>: { <span class="hljs-attr">max</span>: <span class="hljs-number">2</span> },
        },
        <span class="hljs-attr">logging</span>: {
          <span class="hljs-attr">level</span>: <span class="hljs-string">"error"</span>,
          <span class="hljs-attr">console</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">file</span>: <span class="hljs-literal">false</span>,
        },
        <span class="hljs-attr">auth</span>: {
          <span class="hljs-attr">bcryptRounds</span>: <span class="hljs-number">1</span>, <span class="hljs-comment">// Faster for tests</span>
        },
      },

      <span class="hljs-attr">production</span>: {
        <span class="hljs-attr">server</span>: {
          <span class="hljs-attr">host</span>: <span class="hljs-string">"0.0.0.0"</span>,
        },
        <span class="hljs-attr">database</span>: {
          <span class="hljs-attr">ssl</span>: <span class="hljs-literal">true</span>,
        },
        <span class="hljs-attr">logging</span>: {
          <span class="hljs-attr">level</span>: <span class="hljs-string">"info"</span>,
          <span class="hljs-attr">console</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">file</span>: <span class="hljs-literal">true</span>,
        },
        <span class="hljs-attr">security</span>: {
          <span class="hljs-attr">csrfEnabled</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">helmetEnabled</span>: <span class="hljs-literal">true</span>,
        },
        <span class="hljs-attr">monitoring</span>: {
          <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>,
        },
      },
    };

    <span class="hljs-keyword">const</span> envOverrides = overrides[env] || {};
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.deepMerge(config, envOverrides);
  }

  parseBoolean(value, defaultValue = <span class="hljs-literal">false</span>) {
    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">return</span> defaultValue;
    <span class="hljs-keyword">return</span> value.toLowerCase() === <span class="hljs-string">"true"</span>;
  }

  parseNumber(value, defaultValue = <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">return</span> defaultValue;
    <span class="hljs-keyword">const</span> parsed = <span class="hljs-built_in">parseInt</span>(value, <span class="hljs-number">10</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">isNaN</span>(parsed) ? defaultValue : parsed;
  }

  parseArray(value, defaultValue = []) {
    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">return</span> defaultValue;
    <span class="hljs-keyword">return</span> value
      .split(<span class="hljs-string">","</span>)
      .map(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.trim())
      .filter(<span class="hljs-built_in">Boolean</span>);
  }

  deepMerge(target, source) {
    <span class="hljs-keyword">const</span> result = { ...target };

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> source) {
      <span class="hljs-keyword">if</span> (
        source[key] &amp;&amp;
        <span class="hljs-keyword">typeof</span> source[key] === <span class="hljs-string">"object"</span> &amp;&amp;
        !<span class="hljs-built_in">Array</span>.isArray(source[key])
      ) {
        result[key] = <span class="hljs-keyword">this</span>.deepMerge(target[key] || {}, source[key]);
      } <span class="hljs-keyword">else</span> {
        result[key] = source[key];
      }
    }

    <span class="hljs-keyword">return</span> result;
  }

  validate() {
    <span class="hljs-keyword">const</span> requiredByEnv = {
      <span class="hljs-attr">production</span>: [<span class="hljs-string">"JWT_SECRET"</span>, <span class="hljs-string">"DATABASE_URL"</span>, <span class="hljs-string">"SESSION_SECRET"</span>],
      <span class="hljs-attr">development</span>: [<span class="hljs-string">"DATABASE_URL"</span>],
      <span class="hljs-attr">test</span>: [],
    };

    <span class="hljs-keyword">const</span> required = requiredByEnv[<span class="hljs-keyword">this</span>.config.app.environment] || [];
    <span class="hljs-keyword">const</span> missing = required.filter(<span class="hljs-function">(<span class="hljs-params">varName</span>) =&gt;</span> !process.env[varName]);

    <span class="hljs-keyword">if</span> (missing.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(
        <span class="hljs-string">`Missing required environment variables for <span class="hljs-subst">${
          <span class="hljs-keyword">this</span>.config.app.environment
        }</span>: <span class="hljs-subst">${missing.join(<span class="hljs-string">", "</span>)}</span>`</span>
      );
    }

    <span class="hljs-comment">// Additional validation</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.config.server.port &lt; <span class="hljs-number">1</span> || <span class="hljs-keyword">this</span>.config.server.port &gt; <span class="hljs-number">65535</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"PORT must be between 1 and 65535"</span>);
    }

    <span class="hljs-keyword">if</span> (
      <span class="hljs-keyword">this</span>.config.auth.bcryptRounds &lt; <span class="hljs-number">1</span> ||
      <span class="hljs-keyword">this</span>.config.auth.bcryptRounds &gt; <span class="hljs-number">20</span>
    ) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"BCRYPT_ROUNDS must be between 1 and 20"</span>);
    }
  }

  getSanitized() {
    <span class="hljs-keyword">const</span> sanitized = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-keyword">this</span>.config));

    <span class="hljs-comment">// Remove sensitive data</span>
    <span class="hljs-keyword">const</span> sensitiveKeys = [
      <span class="hljs-string">"password"</span>,
      <span class="hljs-string">"secret"</span>,
      <span class="hljs-string">"key"</span>,
      <span class="hljs-string">"token"</span>,
      <span class="hljs-string">"auth"</span>,
      <span class="hljs-string">"credential"</span>,
    ];

    <span class="hljs-keyword">const</span> sanitize = <span class="hljs-function">(<span class="hljs-params">obj</span>) =&gt;</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj[key] === <span class="hljs-string">"object"</span> &amp;&amp; obj[key] !== <span class="hljs-literal">null</span>) {
          sanitize(obj[key]);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (
          <span class="hljs-keyword">typeof</span> obj[key] === <span class="hljs-string">"string"</span> &amp;&amp;
          sensitiveKeys.some(<span class="hljs-function">(<span class="hljs-params">sensitive</span>) =&gt;</span>
            key.toLowerCase().includes(sensitive)
          )
        ) {
          obj[key] = obj[key] ? <span class="hljs-string">"[CONFIGURED]"</span> : <span class="hljs-string">"[NOT SET]"</span>;
        }
      }
    };

    sanitize(sanitized);
    <span class="hljs-keyword">return</span> sanitized;
  }

  <span class="hljs-keyword">get</span>(path) {
    <span class="hljs-keyword">return</span> path.split(<span class="hljs-string">"."</span>).reduce(<span class="hljs-function">(<span class="hljs-params">obj, key</span>) =&gt;</span> obj &amp;&amp; obj[key], <span class="hljs-keyword">this</span>.config);
  }
}

<span class="hljs-comment">// Usage example</span>
<span class="hljs-keyword">const</span> configManager = <span class="hljs-keyword">new</span> ConfigManager();
configManager.validate();

<span class="hljs-built_in">module</span>.exports = configManager.config;
<span class="hljs-built_in">module</span>.exports.manager = configManager;
</div></code></pre>
<h3 id="sample-env-files">Sample .env Files</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># .env (base configuration)</span>
APP_NAME=My Express App
APP_VERSION=1.0.0
NODE_ENV=development

<span class="hljs-comment"># Server Configuration</span>
PORT=3000
HOST=localhost

<span class="hljs-comment"># Database Configuration</span>
DATABASE_URL=postgresql://username:password@localhost:5432/myapp
DB_POOL_MIN=2
DB_POOL_MAX=10

<span class="hljs-comment"># Redis Configuration</span>
REDIS_URL=redis://localhost:6379
REDIS_TTL=3600

<span class="hljs-comment"># Authentication</span>
JWT_SECRET=your-super-secret-jwt-key
JWT_EXPIRY=24h
BCRYPT_ROUNDS=12
SESSION_SECRET=your-session-secret

<span class="hljs-comment"># Email Configuration</span>
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USERNAME=your-email@gmail.com
EMAIL_PASSWORD=your-app-password
EMAIL_FROM=noreply@yourapp.com

<span class="hljs-comment"># Storage Configuration</span>
STORAGE_PROVIDER=<span class="hljs-built_in">local</span>
UPLOAD_PATH=./uploads
MAX_FILE_SIZE=10mb

<span class="hljs-comment"># Security</span>
CORS_ORIGIN=http://localhost:3000,http://localhost:3001
RATE_LIMIT_WINDOW=900000
RATE_LIMIT_MAX=100

<span class="hljs-comment"># Logging</span>
LOG_LEVEL=debug
LOG_TO_CONSOLE=<span class="hljs-literal">true</span>
LOG_TO_FILE=<span class="hljs-literal">false</span>

<span class="hljs-comment"># Features</span>
ENABLE_LOGGING=<span class="hljs-literal">true</span>
ENABLE_METRICS=<span class="hljs-literal">false</span>
DEBUG=<span class="hljs-literal">true</span>
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment"># .env.development (development overrides)</span>
NODE_ENV=development
DEBUG=<span class="hljs-literal">true</span>
LOG_LEVEL=debug

<span class="hljs-comment"># Development database</span>
DATABASE_URL=postgresql://dev:dev@localhost:5432/myapp_dev
DB_SSL=<span class="hljs-literal">false</span>

<span class="hljs-comment"># Disable security features for development</span>
CSRF_ENABLED=<span class="hljs-literal">false</span>
CORS_ORIGIN=*

<span class="hljs-comment"># Development email (use local service)</span>
EMAIL_HOST=localhost
EMAIL_PORT=1025
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment"># .env.production (production overrides)</span>
NODE_ENV=production
DEBUG=<span class="hljs-literal">false</span>
LOG_LEVEL=info

<span class="hljs-comment"># Production server</span>
PORT=8080
HOST=0.0.0.0

<span class="hljs-comment"># Production database with SSL</span>
DB_SSL=<span class="hljs-literal">true</span>
DB_POOL_MAX=20

<span class="hljs-comment"># Enable all security features</span>
CSRF_ENABLED=<span class="hljs-literal">true</span>
HELMET_ENABLED=<span class="hljs-literal">true</span>

<span class="hljs-comment"># Production logging</span>
LOG_TO_CONSOLE=<span class="hljs-literal">false</span>
LOG_TO_FILE=<span class="hljs-literal">true</span>

<span class="hljs-comment"># Monitoring</span>
MONITORING_ENABLED=<span class="hljs-literal">true</span>
METRICS_PORT=9090
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment"># .env.test (test environment)</span>
NODE_ENV=<span class="hljs-built_in">test</span>
DEBUG=<span class="hljs-literal">false</span>
LOG_LEVEL=error

<span class="hljs-comment"># Test database</span>
DATABASE_URL=postgresql://<span class="hljs-built_in">test</span>:<span class="hljs-built_in">test</span>@localhost:5432/myapp_test
DB_POOL_MAX=2

<span class="hljs-comment"># Fast bcrypt for tests</span>
BCRYPT_ROUNDS=1

<span class="hljs-comment"># Disable logging in tests</span>
LOG_TO_CONSOLE=<span class="hljs-literal">false</span>
LOG_TO_FILE=<span class="hljs-literal">false</span>

<span class="hljs-comment"># Test-specific settings</span>
JWT_EXPIRY=1h
RATE_LIMIT_MAX=1000
</div></code></pre>
<h2 id="real-world-use-case">Real-World Use Case</h2>
<h3 id="complete-application-with-environment-configuration">Complete Application with Environment Configuration</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// app.js</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> helmet = <span class="hljs-built_in">require</span>(<span class="hljs-string">"helmet"</span>);
<span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">"cors"</span>);
<span class="hljs-keyword">const</span> rateLimit = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express-rate-limit"</span>);
<span class="hljs-keyword">const</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./config/config"</span>);
<span class="hljs-keyword">const</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./utils/logger"</span>);

<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Security middleware</span>
<span class="hljs-keyword">if</span> (config.security.helmetEnabled) {
  app.use(helmet());
}

<span class="hljs-comment">// CORS configuration</span>
app.use(
  cors({
    <span class="hljs-attr">origin</span>: config.security.corsOrigin,
    <span class="hljs-attr">credentials</span>: <span class="hljs-literal">true</span>,
  })
);

<span class="hljs-comment">// Rate limiting</span>
<span class="hljs-keyword">if</span> (config.security.rateLimitMax &gt; <span class="hljs-number">0</span>) {
  <span class="hljs-keyword">const</span> limiter = rateLimit({
    <span class="hljs-attr">windowMs</span>: config.security.rateLimitWindow,
    <span class="hljs-attr">max</span>: config.security.rateLimitMax,
    <span class="hljs-attr">message</span>: {
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Too many requests"</span>,
      <span class="hljs-attr">retryAfter</span>: <span class="hljs-built_in">Math</span>.ceil(config.security.rateLimitWindow / <span class="hljs-number">1000</span>),
    },
  });
  app.use(<span class="hljs-string">"/api/"</span>, limiter);
}

<span class="hljs-comment">// Body parsing</span>
app.use(express.json({ <span class="hljs-attr">limit</span>: config.storage.maxFileSize }));
app.use(
  express.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">limit</span>: config.storage.maxFileSize })
);

<span class="hljs-comment">// Request logging</span>
app.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  logger.info(<span class="hljs-string">`<span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.path}</span>`</span>, {
    <span class="hljs-attr">ip</span>: req.ip,
    <span class="hljs-attr">userAgent</span>: req.get(<span class="hljs-string">"User-Agent"</span>),
    <span class="hljs-attr">requestId</span>: req.id,
  });
  next();
});

<span class="hljs-comment">// Health check endpoint</span>
app.get(config.monitoring.healthCheckPath, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> health = {
    <span class="hljs-attr">status</span>: <span class="hljs-string">"healthy"</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
    <span class="hljs-attr">environment</span>: config.app.environment,
    <span class="hljs-attr">version</span>: config.app.version,
    <span class="hljs-attr">uptime</span>: process.uptime(),
    <span class="hljs-attr">memory</span>: process.memoryUsage(),
    <span class="hljs-attr">config</span>: {
      <span class="hljs-attr">database</span>: config.database.url ? <span class="hljs-string">"connected"</span> : <span class="hljs-string">"not configured"</span>,
      <span class="hljs-attr">redis</span>: config.redis.url ? <span class="hljs-string">"connected"</span> : <span class="hljs-string">"not configured"</span>,
      <span class="hljs-attr">email</span>: config.email.host ? <span class="hljs-string">"configured"</span> : <span class="hljs-string">"not configured"</span>,
    },
  };

  res.json(health);
});

<span class="hljs-comment">// Configuration endpoint (development only)</span>
<span class="hljs-keyword">if</span> (config.app.environment === <span class="hljs-string">"development"</span>) {
  app.get(<span class="hljs-string">"/api/config"</span>, (req, res) =&gt; {
    <span class="hljs-keyword">const</span> { manager } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./config/config"</span>);
    res.json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">config</span>: manager.getSanitized(),
    });
  });
}

<span class="hljs-comment">// API routes</span>
app.use(<span class="hljs-string">"/api/users"</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">"./routes/users"</span>));
app.use(<span class="hljs-string">"/api/auth"</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">"./routes/auth"</span>));

<span class="hljs-comment">// Error handling</span>
app.use(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {
  logger.error(<span class="hljs-string">"Unhandled error:"</span>, err);

  res.status(err.status || <span class="hljs-number">500</span>).json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">error</span>:
      config.app.environment === <span class="hljs-string">"production"</span>
        ? <span class="hljs-string">"Internal server error"</span>
        : err.message,
  });
});

<span class="hljs-comment">// 404 handler</span>
app.use(<span class="hljs-string">"*"</span>, (req, res) =&gt; {
  res.status(<span class="hljs-number">404</span>).json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">error</span>: <span class="hljs-string">"Endpoint not found"</span>,
  });
});

<span class="hljs-comment">// Graceful shutdown</span>
process.on(<span class="hljs-string">"SIGTERM"</span>, () =&gt; {
  logger.info(<span class="hljs-string">"SIGTERM received, shutting down gracefully"</span>);
  process.exit(<span class="hljs-number">0</span>);
});

process.on(<span class="hljs-string">"SIGINT"</span>, () =&gt; {
  logger.info(<span class="hljs-string">"SIGINT received, shutting down gracefully"</span>);
  process.exit(<span class="hljs-number">0</span>);
});

<span class="hljs-comment">// Start server</span>
<span class="hljs-keyword">const</span> server = app.listen(config.server.port, config.server.host, () =&gt; {
  logger.info(<span class="hljs-string">`🚀 <span class="hljs-subst">${config.app.name}</span> v<span class="hljs-subst">${config.app.version}</span> started`</span>, {
    <span class="hljs-attr">port</span>: config.server.port,
    <span class="hljs-attr">host</span>: config.server.host,
    <span class="hljs-attr">environment</span>: config.app.environment,
    <span class="hljs-attr">nodeVersion</span>: process.version,
  });
});

<span class="hljs-comment">// Set server timeouts</span>
server.timeout = config.server.timeout;
server.keepAliveTimeout = config.server.keepAliveTimeout;

<span class="hljs-built_in">module</span>.exports = app;
</div></code></pre>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-never-commit-env-files">1. Never Commit .env Files</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># .gitignore</span>
.env
.env.local
.env.*.<span class="hljs-built_in">local</span>
.env.development
.env.production
.env.test

<span class="hljs-comment"># But commit example files</span>
!.env.example
</div></code></pre>
<h3 id="2-provide-envexample">2. Provide .env.example</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># .env.example</span>
<span class="hljs-comment"># Copy this file to .env and fill in your values</span>

<span class="hljs-comment"># Application</span>
APP_NAME=My App
NODE_ENV=development
PORT=3000

<span class="hljs-comment"># Database</span>
DATABASE_URL=postgresql://username:password@localhost:5432/database

<span class="hljs-comment"># Authentication</span>
JWT_SECRET=your-secret-key-here

<span class="hljs-comment"># Email</span>
EMAIL_HOST=smtp.example.com
EMAIL_USERNAME=your-email@example.com
EMAIL_PASSWORD=your-password
</div></code></pre>
<h3 id="3-validate-environment-variables">3. Validate Environment Variables</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> requiredEnvVars = {
  <span class="hljs-attr">production</span>: [<span class="hljs-string">"DATABASE_URL"</span>, <span class="hljs-string">"JWT_SECRET"</span>, <span class="hljs-string">"EMAIL_PASSWORD"</span>],
  <span class="hljs-attr">development</span>: [<span class="hljs-string">"DATABASE_URL"</span>],
  <span class="hljs-attr">test</span>: [],
};

<span class="hljs-keyword">const</span> validateEnv = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> env = process.env.NODE_ENV || <span class="hljs-string">"development"</span>;
  <span class="hljs-keyword">const</span> required = requiredEnvVars[env] || [];
  <span class="hljs-keyword">const</span> missing = required.filter(<span class="hljs-function">(<span class="hljs-params">varName</span>) =&gt;</span> !process.env[varName]);

  <span class="hljs-keyword">if</span> (missing.length &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(
      <span class="hljs-string">`Missing required environment variables: <span class="hljs-subst">${missing.join(<span class="hljs-string">", "</span>)}</span>`</span>
    );
  }
};
</div></code></pre>
<h3 id="4-use-type-conversion">4. Use Type Conversion</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> config = {
  <span class="hljs-attr">port</span>: <span class="hljs-built_in">parseInt</span>(process.env.PORT) || <span class="hljs-number">3000</span>,
  <span class="hljs-attr">debug</span>: process.env.DEBUG === <span class="hljs-string">"true"</span>,
  <span class="hljs-attr">maxConnections</span>: <span class="hljs-built_in">parseInt</span>(process.env.MAX_CONNECTIONS) || <span class="hljs-number">10</span>,
  <span class="hljs-attr">allowedOrigins</span>: (process.env.ALLOWED_ORIGINS || <span class="hljs-string">""</span>)
    .split(<span class="hljs-string">","</span>)
    .filter(<span class="hljs-built_in">Boolean</span>),
};
</div></code></pre>
<h3 id="5-environment-specific-loading">5. Environment-Specific Loading</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> loadEnvFiles = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> env = process.env.NODE_ENV || <span class="hljs-string">"development"</span>;
  <span class="hljs-keyword">const</span> files = [<span class="hljs-string">`.env.<span class="hljs-subst">${env}</span>.local`</span>, <span class="hljs-string">`.env.local`</span>, <span class="hljs-string">`.env.<span class="hljs-subst">${env}</span>`</span>, <span class="hljs-string">".env"</span>];

  files.forEach(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> {
    <span class="hljs-built_in">require</span>(<span class="hljs-string">"dotenv"</span>).config({ <span class="hljs-attr">path</span>: file, <span class="hljs-attr">override</span>: <span class="hljs-literal">false</span> });
  });
};
</div></code></pre>
<h2 id="summary">Summary</h2>
<p>Environment variables with dotenv provide:</p>
<p><strong>Configuration Management</strong>:</p>
<ul>
<li>Separate config from code</li>
<li>Environment-specific settings</li>
<li>Secure handling of sensitive data</li>
<li>Easy deployment configuration</li>
</ul>
<p><strong>Best Practices</strong>:</p>
<ul>
<li>Use <code>.env.example</code> for documentation</li>
<li>Validate required variables</li>
<li>Convert types appropriately</li>
<li>Never commit actual <code>.env</code> files</li>
<li>Use environment-specific files</li>
</ul>
<p><strong>Advanced Features</strong>:</p>
<ul>
<li>Configuration classes with validation</li>
<li>Type conversion and defaults</li>
<li>Sanitized config for logging</li>
<li>Environment-specific overrides</li>
<li>Graceful error handling</li>
</ul>
<p><strong>Security Considerations</strong>:</p>
<ul>
<li>Keep secrets out of source code</li>
<li>Use different secrets per environment</li>
<li>Implement proper access controls</li>
<li>Log configuration without exposing secrets</li>
</ul>
<p>Mastering environment variables is crucial for building maintainable, secure, and deployable applications. Next, we'll explore Express Router and modular route management for organizing larger applications.</p>
<h1 id="express-router-and-modular-route-management">Express Router and Modular Route Management</h1>
<h2 id="overview">Overview</h2>
<p>As Express.js applications grow in complexity, managing all routes in a single file becomes unwieldy and difficult to maintain. Express Router provides a powerful solution for organizing routes into modular, reusable components. It allows you to create mini-applications with their own middleware, routes, and error handling, making your codebase more organized, scalable, and maintainable.</p>
<h2 id="key-concepts">Key Concepts</h2>
<h3 id="express-router">Express Router</h3>
<p>Express Router is:</p>
<ul>
<li>A mini Express application without views or settings</li>
<li>A complete middleware and routing system</li>
<li>Mountable at different paths</li>
<li>Capable of performing middleware and routing functions</li>
<li>Stackable and composable</li>
</ul>
<h3 id="benefits-of-modular-routing">Benefits of Modular Routing</h3>
<ol>
<li><strong>Organization</strong>: Separate concerns into logical modules</li>
<li><strong>Maintainability</strong>: Easier to find and modify specific functionality</li>
<li><strong>Reusability</strong>: Routes can be reused across different applications</li>
<li><strong>Team Development</strong>: Different developers can work on different modules</li>
<li><strong>Testing</strong>: Easier to test individual route modules</li>
<li><strong>Scalability</strong>: Better structure for large applications</li>
</ol>
<h3 id="router-patterns">Router Patterns</h3>
<ul>
<li><strong>Resource-based routing</strong>: Routes organized by data entities</li>
<li><strong>Feature-based routing</strong>: Routes organized by application features</li>
<li><strong>Version-based routing</strong>: API versioning through separate routers</li>
<li><strong>Middleware stacking</strong>: Applying middleware at router level</li>
<li><strong>Nested routing</strong>: Routers within routers for complex hierarchies</li>
</ul>
<h2 id="example-code">Example Code</h2>
<h3 id="basic-router-setup">Basic Router Setup</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// routes/users.js</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> router = express.Router();

<span class="hljs-comment">// Sample user data</span>
<span class="hljs-keyword">let</span> users = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"John Doe"</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">"john@example.com"</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Jane Smith"</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">"jane@example.com"</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">"admin"</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Bob Johnson"</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">"bob@example.com"</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span> },
];
<span class="hljs-keyword">let</span> nextId = <span class="hljs-number">4</span>;

<span class="hljs-comment">// Middleware specific to this router</span>
router.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Users route accessed: <span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.originalUrl}</span>`</span>);
  next();
});

<span class="hljs-comment">// GET /users - Get all users</span>
router.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { role, search, page = <span class="hljs-number">1</span>, limit = <span class="hljs-number">10</span> } = req.query;

  <span class="hljs-keyword">let</span> filteredUsers = [...users];

  <span class="hljs-comment">// Filter by role</span>
  <span class="hljs-keyword">if</span> (role) {
    filteredUsers = filteredUsers.filter(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> user.role === role);
  }

  <span class="hljs-comment">// Search by name or email</span>
  <span class="hljs-keyword">if</span> (search) {
    <span class="hljs-keyword">const</span> searchLower = search.toLowerCase();
    filteredUsers = filteredUsers.filter(
      <span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span>
        user.name.toLowerCase().includes(searchLower) ||
        user.email.toLowerCase().includes(searchLower)
    );
  }

  <span class="hljs-comment">// Pagination</span>
  <span class="hljs-keyword">const</span> startIndex = (page - <span class="hljs-number">1</span>) * limit;
  <span class="hljs-keyword">const</span> endIndex = startIndex + <span class="hljs-built_in">parseInt</span>(limit);
  <span class="hljs-keyword">const</span> paginatedUsers = filteredUsers.slice(startIndex, endIndex);

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: paginatedUsers,
    <span class="hljs-attr">pagination</span>: {
      <span class="hljs-attr">page</span>: <span class="hljs-built_in">parseInt</span>(page),
      <span class="hljs-attr">limit</span>: <span class="hljs-built_in">parseInt</span>(limit),
      <span class="hljs-attr">total</span>: filteredUsers.length,
      <span class="hljs-attr">totalPages</span>: <span class="hljs-built_in">Math</span>.ceil(filteredUsers.length / limit),
    },
  });
});

<span class="hljs-comment">// GET /users/:id - Get user by ID</span>
router.get(<span class="hljs-string">"/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(req.params.id);
  <span class="hljs-keyword">const</span> user = users.find(<span class="hljs-function">(<span class="hljs-params">u</span>) =&gt;</span> u.id === id);

  <span class="hljs-keyword">if</span> (!user) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"User not found"</span>,
    });
  }

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: user,
  });
});

<span class="hljs-comment">// POST /users - Create new user</span>
router.post(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { name, email, role = <span class="hljs-string">"user"</span> } = req.body;

  <span class="hljs-comment">// Validation</span>
  <span class="hljs-keyword">if</span> (!name || !email) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Name and email are required"</span>,
    });
  }

  <span class="hljs-comment">// Check if email already exists</span>
  <span class="hljs-keyword">if</span> (users.find(<span class="hljs-function">(<span class="hljs-params">u</span>) =&gt;</span> u.email === email)) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">409</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Email already exists"</span>,
    });
  }

  <span class="hljs-keyword">const</span> newUser = {
    <span class="hljs-attr">id</span>: nextId++,
    name,
    email,
    role,
  };

  users.push(newUser);

  res.status(<span class="hljs-number">201</span>).json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: newUser,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"User created successfully"</span>,
  });
});

<span class="hljs-comment">// PUT /users/:id - Update user</span>
router.put(<span class="hljs-string">"/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(req.params.id);
  <span class="hljs-keyword">const</span> userIndex = users.findIndex(<span class="hljs-function">(<span class="hljs-params">u</span>) =&gt;</span> u.id === id);

  <span class="hljs-keyword">if</span> (userIndex === <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"User not found"</span>,
    });
  }

  <span class="hljs-keyword">const</span> { name, email, role } = req.body;

  <span class="hljs-comment">// Check if email is being changed and already exists</span>
  <span class="hljs-keyword">if</span> (email &amp;&amp; email !== users[userIndex].email) {
    <span class="hljs-keyword">if</span> (users.find(<span class="hljs-function">(<span class="hljs-params">u</span>) =&gt;</span> u.email === email)) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">409</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Email already exists"</span>,
      });
    }
  }

  <span class="hljs-comment">// Update user</span>
  users[userIndex] = {
    ...users[userIndex],
    ...(name &amp;&amp; { name }),
    ...(email &amp;&amp; { email }),
    ...(role &amp;&amp; { role }),
  };

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: users[userIndex],
    <span class="hljs-attr">message</span>: <span class="hljs-string">"User updated successfully"</span>,
  });
});

<span class="hljs-comment">// DELETE /users/:id - Delete user</span>
router.delete(<span class="hljs-string">"/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(req.params.id);
  <span class="hljs-keyword">const</span> userIndex = users.findIndex(<span class="hljs-function">(<span class="hljs-params">u</span>) =&gt;</span> u.id === id);

  <span class="hljs-keyword">if</span> (userIndex === <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"User not found"</span>,
    });
  }

  <span class="hljs-keyword">const</span> deletedUser = users.splice(userIndex, <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>];

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: deletedUser,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"User deleted successfully"</span>,
  });
});

<span class="hljs-built_in">module</span>.exports = router;
</div></code></pre>
<h3 id="advanced-router-with-middleware">Advanced Router with Middleware</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// routes/posts.js</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> router = express.Router();

<span class="hljs-comment">// Sample posts data</span>
<span class="hljs-keyword">let</span> posts = [
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">title</span>: <span class="hljs-string">"First Post"</span>,
    <span class="hljs-attr">content</span>: <span class="hljs-string">"This is the first post"</span>,
    <span class="hljs-attr">authorId</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">published</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">title</span>: <span class="hljs-string">"Second Post"</span>,
    <span class="hljs-attr">content</span>: <span class="hljs-string">"This is the second post"</span>,
    <span class="hljs-attr">authorId</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">published</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">title</span>: <span class="hljs-string">"Third Post"</span>,
    <span class="hljs-attr">content</span>: <span class="hljs-string">"This is the third post"</span>,
    <span class="hljs-attr">authorId</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">published</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
  },
];
<span class="hljs-keyword">let</span> nextId = <span class="hljs-number">4</span>;

<span class="hljs-comment">// Validation middleware</span>
<span class="hljs-keyword">const</span> validatePost = <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { title, content, authorId } = req.body;
  <span class="hljs-keyword">const</span> errors = [];

  <span class="hljs-keyword">if</span> (!title || title.trim().length === <span class="hljs-number">0</span>) {
    errors.push(<span class="hljs-string">"Title is required"</span>);
  }

  <span class="hljs-keyword">if</span> (!content || content.trim().length === <span class="hljs-number">0</span>) {
    errors.push(<span class="hljs-string">"Content is required"</span>);
  }

  <span class="hljs-keyword">if</span> (!authorId || <span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">parseInt</span>(authorId))) {
    errors.push(<span class="hljs-string">"Valid author ID is required"</span>);
  }

  <span class="hljs-keyword">if</span> (errors.length &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      errors,
    });
  }

  next();
};

<span class="hljs-comment">// Authentication middleware (simplified)</span>
<span class="hljs-keyword">const</span> authenticate = <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> token = req.get(<span class="hljs-string">"Authorization"</span>);

  <span class="hljs-keyword">if</span> (!token) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Authentication required"</span>,
    });
  }

  <span class="hljs-comment">// Simplified token validation</span>
  <span class="hljs-keyword">if</span> (token !== <span class="hljs-string">"Bearer valid-token"</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Invalid token"</span>,
    });
  }

  <span class="hljs-comment">// Add user info to request</span>
  req.user = { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">"admin"</span> };
  next();
};

<span class="hljs-comment">// Authorization middleware</span>
<span class="hljs-keyword">const</span> authorize = <span class="hljs-function">(<span class="hljs-params">roles = []</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!req.user) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Authentication required"</span>,
      });
    }

    <span class="hljs-keyword">if</span> (roles.length &gt; <span class="hljs-number">0</span> &amp;&amp; !roles.includes(req.user.role)) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">403</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Insufficient permissions"</span>,
      });
    }

    next();
  };
};

<span class="hljs-comment">// Logging middleware for this router</span>
router.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(
    <span class="hljs-string">`Posts route: <span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${
      req.originalUrl
    }</span> at <span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span>`</span>
  );
  next();
});

<span class="hljs-comment">// GET /posts - Get all posts (public)</span>
router.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> {
    published,
    authorId,
    search,
    sortBy = <span class="hljs-string">"createdAt"</span>,
    order = <span class="hljs-string">"desc"</span>,
  } = req.query;

  <span class="hljs-keyword">let</span> filteredPosts = [...posts];

  <span class="hljs-comment">// Filter by published status</span>
  <span class="hljs-keyword">if</span> (published !== <span class="hljs-literal">undefined</span>) {
    filteredPosts = filteredPosts.filter(
      <span class="hljs-function">(<span class="hljs-params">post</span>) =&gt;</span> post.published === (published === <span class="hljs-string">"true"</span>)
    );
  }

  <span class="hljs-comment">// Filter by author</span>
  <span class="hljs-keyword">if</span> (authorId) {
    filteredPosts = filteredPosts.filter(
      <span class="hljs-function">(<span class="hljs-params">post</span>) =&gt;</span> post.authorId === <span class="hljs-built_in">parseInt</span>(authorId)
    );
  }

  <span class="hljs-comment">// Search in title and content</span>
  <span class="hljs-keyword">if</span> (search) {
    <span class="hljs-keyword">const</span> searchLower = search.toLowerCase();
    filteredPosts = filteredPosts.filter(
      <span class="hljs-function">(<span class="hljs-params">post</span>) =&gt;</span>
        post.title.toLowerCase().includes(searchLower) ||
        post.content.toLowerCase().includes(searchLower)
    );
  }

  <span class="hljs-comment">// Sorting</span>
  filteredPosts.sort(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> {
    <span class="hljs-keyword">let</span> aVal = a[sortBy];
    <span class="hljs-keyword">let</span> bVal = b[sortBy];

    <span class="hljs-keyword">if</span> (sortBy === <span class="hljs-string">"createdAt"</span>) {
      aVal = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(aVal);
      bVal = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(bVal);
    }

    <span class="hljs-keyword">if</span> (order === <span class="hljs-string">"desc"</span>) {
      <span class="hljs-keyword">return</span> bVal &gt; aVal ? <span class="hljs-number">1</span> : <span class="hljs-number">-1</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> aVal &gt; bVal ? <span class="hljs-number">1</span> : <span class="hljs-number">-1</span>;
    }
  });

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: filteredPosts,
    <span class="hljs-attr">count</span>: filteredPosts.length,
  });
});

<span class="hljs-comment">// GET /posts/:id - Get single post (public)</span>
router.get(<span class="hljs-string">"/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(req.params.id);
  <span class="hljs-keyword">const</span> post = posts.find(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id === id);

  <span class="hljs-keyword">if</span> (!post) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Post not found"</span>,
    });
  }

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: post,
  });
});

<span class="hljs-comment">// POST /posts - Create new post (requires authentication)</span>
router.post(<span class="hljs-string">"/"</span>, authenticate, validatePost, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { title, content, authorId, published = <span class="hljs-literal">false</span> } = req.body;

  <span class="hljs-keyword">const</span> newPost = {
    <span class="hljs-attr">id</span>: nextId++,
    <span class="hljs-attr">title</span>: title.trim(),
    <span class="hljs-attr">content</span>: content.trim(),
    <span class="hljs-attr">authorId</span>: <span class="hljs-built_in">parseInt</span>(authorId),
    published,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
    <span class="hljs-attr">updatedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
  };

  posts.push(newPost);

  res.status(<span class="hljs-number">201</span>).json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: newPost,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Post created successfully"</span>,
  });
});

<span class="hljs-comment">// PUT /posts/:id - Update post (requires authentication)</span>
router.put(<span class="hljs-string">"/:id"</span>, authenticate, validatePost, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(req.params.id);
  <span class="hljs-keyword">const</span> postIndex = posts.findIndex(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id === id);

  <span class="hljs-keyword">if</span> (postIndex === <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Post not found"</span>,
    });
  }

  <span class="hljs-keyword">const</span> { title, content, published } = req.body;

  <span class="hljs-comment">// Update post</span>
  posts[postIndex] = {
    ...posts[postIndex],
    <span class="hljs-attr">title</span>: title.trim(),
    <span class="hljs-attr">content</span>: content.trim(),
    published,
    <span class="hljs-attr">updatedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
  };

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: posts[postIndex],
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Post updated successfully"</span>,
  });
});

<span class="hljs-comment">// DELETE /posts/:id - Delete post (requires admin role)</span>
router.delete(<span class="hljs-string">"/:id"</span>, authenticate, authorize([<span class="hljs-string">"admin"</span>]), (req, res) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(req.params.id);
  <span class="hljs-keyword">const</span> postIndex = posts.findIndex(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id === id);

  <span class="hljs-keyword">if</span> (postIndex === <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Post not found"</span>,
    });
  }

  <span class="hljs-keyword">const</span> deletedPost = posts.splice(postIndex, <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>];

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: deletedPost,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Post deleted successfully"</span>,
  });
});

<span class="hljs-comment">// PATCH /posts/:id/publish - Toggle publish status (requires authentication)</span>
router.patch(<span class="hljs-string">"/:id/publish"</span>, authenticate, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(req.params.id);
  <span class="hljs-keyword">const</span> postIndex = posts.findIndex(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id === id);

  <span class="hljs-keyword">if</span> (postIndex === <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Post not found"</span>,
    });
  }

  posts[postIndex].published = !posts[postIndex].published;
  posts[postIndex].updatedAt = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: posts[postIndex],
    <span class="hljs-attr">message</span>: <span class="hljs-string">`Post <span class="hljs-subst">${
      posts[postIndex].published ? <span class="hljs-string">"published"</span> : <span class="hljs-string">"unpublished"</span>
    }</span> successfully`</span>,
  });
});

<span class="hljs-built_in">module</span>.exports = router;
</div></code></pre>
<h3 id="nested-routers-and-route-parameters">Nested Routers and Route Parameters</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// routes/api.js - Main API router</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> router = express.Router();

<span class="hljs-comment">// Import sub-routers</span>
<span class="hljs-keyword">const</span> usersRouter = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./users"</span>);
<span class="hljs-keyword">const</span> postsRouter = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./posts"</span>);
<span class="hljs-keyword">const</span> commentsRouter = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./comments"</span>);
<span class="hljs-keyword">const</span> authRouter = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./auth"</span>);

<span class="hljs-comment">// API-wide middleware</span>
router.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  res.set({
    <span class="hljs-string">"X-API-Version"</span>: <span class="hljs-string">"1.0.0"</span>,
    <span class="hljs-string">"X-Powered-By"</span>: <span class="hljs-string">"Express.js"</span>,
  });
  next();
});

<span class="hljs-comment">// Request logging</span>
router.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`API Request: <span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.originalUrl}</span>`</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Headers:"</span>, req.headers);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Body:"</span>, req.body);
  next();
});

<span class="hljs-comment">// Mount sub-routers</span>
router.use(<span class="hljs-string">"/auth"</span>, authRouter);
router.use(<span class="hljs-string">"/users"</span>, usersRouter);
router.use(<span class="hljs-string">"/posts"</span>, postsRouter);
router.use(<span class="hljs-string">"/posts/:postId/comments"</span>, commentsRouter); <span class="hljs-comment">// Nested route</span>

<span class="hljs-comment">// API info endpoint</span>
router.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Welcome to the API"</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
    <span class="hljs-attr">endpoints</span>: {
      <span class="hljs-attr">auth</span>: <span class="hljs-string">"/api/auth"</span>,
      <span class="hljs-attr">users</span>: <span class="hljs-string">"/api/users"</span>,
      <span class="hljs-attr">posts</span>: <span class="hljs-string">"/api/posts"</span>,
      <span class="hljs-attr">comments</span>: <span class="hljs-string">"/api/posts/:postId/comments"</span>,
    },
    <span class="hljs-attr">documentation</span>: <span class="hljs-string">"/api/docs"</span>,
  });
});

<span class="hljs-comment">// API documentation endpoint</span>
router.get(<span class="hljs-string">"/docs"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> documentation = {
    <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
    <span class="hljs-attr">baseUrl</span>: <span class="hljs-string">"/api"</span>,
    <span class="hljs-attr">endpoints</span>: {
      <span class="hljs-attr">auth</span>: {
        <span class="hljs-string">"POST /auth/login"</span>: <span class="hljs-string">"Authenticate user"</span>,
        <span class="hljs-string">"POST /auth/register"</span>: <span class="hljs-string">"Register new user"</span>,
        <span class="hljs-string">"POST /auth/logout"</span>: <span class="hljs-string">"Logout user"</span>,
      },
      <span class="hljs-attr">users</span>: {
        <span class="hljs-string">"GET /users"</span>: <span class="hljs-string">"Get all users"</span>,
        <span class="hljs-string">"GET /users/:id"</span>: <span class="hljs-string">"Get user by ID"</span>,
        <span class="hljs-string">"POST /users"</span>: <span class="hljs-string">"Create new user"</span>,
        <span class="hljs-string">"PUT /users/:id"</span>: <span class="hljs-string">"Update user"</span>,
        <span class="hljs-string">"DELETE /users/:id"</span>: <span class="hljs-string">"Delete user"</span>,
      },
      <span class="hljs-attr">posts</span>: {
        <span class="hljs-string">"GET /posts"</span>: <span class="hljs-string">"Get all posts"</span>,
        <span class="hljs-string">"GET /posts/:id"</span>: <span class="hljs-string">"Get post by ID"</span>,
        <span class="hljs-string">"POST /posts"</span>: <span class="hljs-string">"Create new post"</span>,
        <span class="hljs-string">"PUT /posts/:id"</span>: <span class="hljs-string">"Update post"</span>,
        <span class="hljs-string">"DELETE /posts/:id"</span>: <span class="hljs-string">"Delete post"</span>,
        <span class="hljs-string">"PATCH /posts/:id/publish"</span>: <span class="hljs-string">"Toggle publish status"</span>,
      },
      <span class="hljs-attr">comments</span>: {
        <span class="hljs-string">"GET /posts/:postId/comments"</span>: <span class="hljs-string">"Get comments for post"</span>,
        <span class="hljs-string">"POST /posts/:postId/comments"</span>: <span class="hljs-string">"Add comment to post"</span>,
        <span class="hljs-string">"PUT /posts/:postId/comments/:id"</span>: <span class="hljs-string">"Update comment"</span>,
        <span class="hljs-string">"DELETE /posts/:postId/comments/:id"</span>: <span class="hljs-string">"Delete comment"</span>,
      },
    },
  };

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    documentation,
  });
});

<span class="hljs-built_in">module</span>.exports = router;
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">// routes/comments.js - Nested router for comments</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> router = express.Router({ <span class="hljs-attr">mergeParams</span>: <span class="hljs-literal">true</span> }); <span class="hljs-comment">// Important for accessing parent params</span>

<span class="hljs-comment">// Sample comments data</span>
<span class="hljs-keyword">let</span> comments = [
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">postId</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">content</span>: <span class="hljs-string">"Great post!"</span>,
    <span class="hljs-attr">authorId</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">postId</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">content</span>: <span class="hljs-string">"Thanks for sharing"</span>,
    <span class="hljs-attr">authorId</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">postId</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">content</span>: <span class="hljs-string">"Interesting perspective"</span>,
    <span class="hljs-attr">authorId</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
  },
];
<span class="hljs-keyword">let</span> nextId = <span class="hljs-number">4</span>;

<span class="hljs-comment">// Middleware to validate post exists</span>
<span class="hljs-keyword">const</span> validatePost = <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> postId = <span class="hljs-built_in">parseInt</span>(req.params.postId);

  <span class="hljs-comment">// In a real app, you'd check the database</span>
  <span class="hljs-comment">// For demo, we'll assume posts with IDs 1-3 exist</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(postId) || postId &lt; <span class="hljs-number">1</span> || postId &gt; <span class="hljs-number">3</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Post not found"</span>,
    });
  }

  req.postId = postId;
  next();
};

<span class="hljs-comment">// Apply post validation to all routes</span>
router.use(validatePost);

<span class="hljs-comment">// GET /posts/:postId/comments - Get comments for a post</span>
router.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> postComments = comments.filter(
    <span class="hljs-function">(<span class="hljs-params">comment</span>) =&gt;</span> comment.postId === req.postId
  );

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: postComments,
    <span class="hljs-attr">postId</span>: req.postId,
    <span class="hljs-attr">count</span>: postComments.length,
  });
});

<span class="hljs-comment">// GET /posts/:postId/comments/:id - Get specific comment</span>
router.get(<span class="hljs-string">"/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> commentId = <span class="hljs-built_in">parseInt</span>(req.params.id);
  <span class="hljs-keyword">const</span> comment = comments.find(
    <span class="hljs-function">(<span class="hljs-params">c</span>) =&gt;</span> c.id === commentId &amp;&amp; c.postId === req.postId
  );

  <span class="hljs-keyword">if</span> (!comment) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Comment not found"</span>,
    });
  }

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: comment,
  });
});

<span class="hljs-comment">// POST /posts/:postId/comments - Add comment to post</span>
router.post(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { content, authorId } = req.body;

  <span class="hljs-keyword">if</span> (!content || !authorId) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Content and author ID are required"</span>,
    });
  }

  <span class="hljs-keyword">const</span> newComment = {
    <span class="hljs-attr">id</span>: nextId++,
    <span class="hljs-attr">postId</span>: req.postId,
    <span class="hljs-attr">content</span>: content.trim(),
    <span class="hljs-attr">authorId</span>: <span class="hljs-built_in">parseInt</span>(authorId),
    <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
  };

  comments.push(newComment);

  res.status(<span class="hljs-number">201</span>).json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: newComment,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Comment added successfully"</span>,
  });
});

<span class="hljs-comment">// PUT /posts/:postId/comments/:id - Update comment</span>
router.put(<span class="hljs-string">"/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> commentId = <span class="hljs-built_in">parseInt</span>(req.params.id);
  <span class="hljs-keyword">const</span> commentIndex = comments.findIndex(
    <span class="hljs-function">(<span class="hljs-params">c</span>) =&gt;</span> c.id === commentId &amp;&amp; c.postId === req.postId
  );

  <span class="hljs-keyword">if</span> (commentIndex === <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Comment not found"</span>,
    });
  }

  <span class="hljs-keyword">const</span> { content } = req.body;

  <span class="hljs-keyword">if</span> (!content) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Content is required"</span>,
    });
  }

  comments[commentIndex] = {
    ...comments[commentIndex],
    <span class="hljs-attr">content</span>: content.trim(),
    <span class="hljs-attr">updatedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
  };

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: comments[commentIndex],
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Comment updated successfully"</span>,
  });
});

<span class="hljs-comment">// DELETE /posts/:postId/comments/:id - Delete comment</span>
router.delete(<span class="hljs-string">"/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> commentId = <span class="hljs-built_in">parseInt</span>(req.params.id);
  <span class="hljs-keyword">const</span> commentIndex = comments.findIndex(
    <span class="hljs-function">(<span class="hljs-params">c</span>) =&gt;</span> c.id === commentId &amp;&amp; c.postId === req.postId
  );

  <span class="hljs-keyword">if</span> (commentIndex === <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Comment not found"</span>,
    });
  }

  <span class="hljs-keyword">const</span> deletedComment = comments.splice(commentIndex, <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>];

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: deletedComment,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Comment deleted successfully"</span>,
  });
});

<span class="hljs-built_in">module</span>.exports = router;
</div></code></pre>
<h3 id="main-application-with-router-integration">Main Application with Router Integration</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// app.js - Main application file</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">"cors"</span>);
<span class="hljs-keyword">const</span> helmet = <span class="hljs-built_in">require</span>(<span class="hljs-string">"helmet"</span>);
<span class="hljs-keyword">const</span> morgan = <span class="hljs-built_in">require</span>(<span class="hljs-string">"morgan"</span>);

<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Global middleware</span>
app.use(helmet());
app.use(cors());
app.use(morgan(<span class="hljs-string">"combined"</span>));
app.use(express.json({ <span class="hljs-attr">limit</span>: <span class="hljs-string">"10mb"</span> }));
app.use(express.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> }));

<span class="hljs-comment">// Import routers</span>
<span class="hljs-keyword">const</span> apiRouter = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./routes/api"</span>);
<span class="hljs-keyword">const</span> adminRouter = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./routes/admin"</span>);
<span class="hljs-keyword">const</span> webhooksRouter = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./routes/webhooks"</span>);

<span class="hljs-comment">// Mount routers</span>
app.use(<span class="hljs-string">"/api"</span>, apiRouter);
app.use(<span class="hljs-string">"/admin"</span>, adminRouter);
app.use(<span class="hljs-string">"/webhooks"</span>, webhooksRouter);

<span class="hljs-comment">// Root endpoint</span>
app.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Welcome to the Express Router Demo"</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
    <span class="hljs-attr">routes</span>: {
      <span class="hljs-attr">api</span>: <span class="hljs-string">"/api"</span>,
      <span class="hljs-attr">admin</span>: <span class="hljs-string">"/admin"</span>,
      <span class="hljs-attr">webhooks</span>: <span class="hljs-string">"/webhooks"</span>,
    },
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
  });
});

<span class="hljs-comment">// Health check</span>
app.get(<span class="hljs-string">"/health"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">status</span>: <span class="hljs-string">"healthy"</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
    <span class="hljs-attr">uptime</span>: process.uptime(),
    <span class="hljs-attr">memory</span>: process.memoryUsage(),
  });
});

<span class="hljs-comment">// 404 handler</span>
app.use(<span class="hljs-string">"*"</span>, (req, res) =&gt; {
  res.status(<span class="hljs-number">404</span>).json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">error</span>: <span class="hljs-string">"Route not found"</span>,
    <span class="hljs-attr">path</span>: req.originalUrl,
    <span class="hljs-attr">method</span>: req.method,
  });
});

<span class="hljs-comment">// Global error handler</span>
app.use(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Global error handler:"</span>, err);

  res.status(err.status || <span class="hljs-number">500</span>).json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">error</span>:
      process.env.NODE_ENV === <span class="hljs-string">"production"</span>
        ? <span class="hljs-string">"Internal server error"</span>
        : err.message,
    ...(process.env.NODE_ENV !== <span class="hljs-string">"production"</span> &amp;&amp; { <span class="hljs-attr">stack</span>: err.stack }),
  });
});

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
app.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🚀 Server running on port <span class="hljs-subst">${PORT}</span>`</span>);
  <span class="hljs-built_in">console</span>.log(
    <span class="hljs-string">`📚 API documentation available at http://localhost:<span class="hljs-subst">${PORT}</span>/api/docs`</span>
  );
});

<span class="hljs-built_in">module</span>.exports = app;
</div></code></pre>
<h2 id="real-world-use-case">Real-World Use Case</h2>
<h3 id="e-commerce-api-with-modular-routing">E-commerce API with Modular Routing</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// routes/products.js</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> router = express.Router();

<span class="hljs-comment">// Product data (in real app, this would be a database)</span>
<span class="hljs-keyword">let</span> products = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Laptop"</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">999.99</span>, <span class="hljs-attr">category</span>: <span class="hljs-string">"Electronics"</span>, <span class="hljs-attr">stock</span>: <span class="hljs-number">10</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Book"</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">19.99</span>, <span class="hljs-attr">category</span>: <span class="hljs-string">"Education"</span>, <span class="hljs-attr">stock</span>: <span class="hljs-number">50</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Coffee Mug"</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">9.99</span>, <span class="hljs-attr">category</span>: <span class="hljs-string">"Kitchen"</span>, <span class="hljs-attr">stock</span>: <span class="hljs-number">25</span> },
];

<span class="hljs-comment">// Middleware for product validation</span>
<span class="hljs-keyword">const</span> validateProduct = <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { name, price, category } = req.body;
  <span class="hljs-keyword">const</span> errors = [];

  <span class="hljs-keyword">if</span> (!name || name.trim().length === <span class="hljs-number">0</span>) {
    errors.push(<span class="hljs-string">"Product name is required"</span>);
  }

  <span class="hljs-keyword">if</span> (!price || <span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">parseFloat</span>(price)) || <span class="hljs-built_in">parseFloat</span>(price) &lt;= <span class="hljs-number">0</span>) {
    errors.push(<span class="hljs-string">"Valid price is required"</span>);
  }

  <span class="hljs-keyword">if</span> (!category || category.trim().length === <span class="hljs-number">0</span>) {
    errors.push(<span class="hljs-string">"Category is required"</span>);
  }

  <span class="hljs-keyword">if</span> (errors.length &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, errors });
  }

  next();
};

<span class="hljs-comment">// GET /products - Get all products with filtering and pagination</span>
router.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> {
    category,
    minPrice,
    maxPrice,
    search,
    sortBy = <span class="hljs-string">"name"</span>,
    order = <span class="hljs-string">"asc"</span>,
    page = <span class="hljs-number">1</span>,
    limit = <span class="hljs-number">10</span>,
  } = req.query;

  <span class="hljs-keyword">let</span> filteredProducts = [...products];

  <span class="hljs-comment">// Apply filters</span>
  <span class="hljs-keyword">if</span> (category) {
    filteredProducts = filteredProducts.filter(
      <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.category.toLowerCase() === category.toLowerCase()
    );
  }

  <span class="hljs-keyword">if</span> (minPrice) {
    filteredProducts = filteredProducts.filter(
      <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.price &gt;= <span class="hljs-built_in">parseFloat</span>(minPrice)
    );
  }

  <span class="hljs-keyword">if</span> (maxPrice) {
    filteredProducts = filteredProducts.filter(
      <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.price &lt;= <span class="hljs-built_in">parseFloat</span>(maxPrice)
    );
  }

  <span class="hljs-keyword">if</span> (search) {
    <span class="hljs-keyword">const</span> searchLower = search.toLowerCase();
    filteredProducts = filteredProducts.filter(
      <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span>
        p.name.toLowerCase().includes(searchLower) ||
        p.category.toLowerCase().includes(searchLower)
    );
  }

  <span class="hljs-comment">// Apply sorting</span>
  filteredProducts.sort(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> {
    <span class="hljs-keyword">let</span> aVal = a[sortBy];
    <span class="hljs-keyword">let</span> bVal = b[sortBy];

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> aVal === <span class="hljs-string">"string"</span>) {
      aVal = aVal.toLowerCase();
      bVal = bVal.toLowerCase();
    }

    <span class="hljs-keyword">if</span> (order === <span class="hljs-string">"desc"</span>) {
      <span class="hljs-keyword">return</span> bVal &gt; aVal ? <span class="hljs-number">1</span> : <span class="hljs-number">-1</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> aVal &gt; bVal ? <span class="hljs-number">1</span> : <span class="hljs-number">-1</span>;
    }
  });

  <span class="hljs-comment">// Apply pagination</span>
  <span class="hljs-keyword">const</span> startIndex = (page - <span class="hljs-number">1</span>) * limit;
  <span class="hljs-keyword">const</span> endIndex = startIndex + <span class="hljs-built_in">parseInt</span>(limit);
  <span class="hljs-keyword">const</span> paginatedProducts = filteredProducts.slice(startIndex, endIndex);

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: paginatedProducts,
    <span class="hljs-attr">pagination</span>: {
      <span class="hljs-attr">page</span>: <span class="hljs-built_in">parseInt</span>(page),
      <span class="hljs-attr">limit</span>: <span class="hljs-built_in">parseInt</span>(limit),
      <span class="hljs-attr">total</span>: filteredProducts.length,
      <span class="hljs-attr">totalPages</span>: <span class="hljs-built_in">Math</span>.ceil(filteredProducts.length / limit),
    },
    <span class="hljs-attr">filters</span>: { category, minPrice, maxPrice, search },
    <span class="hljs-attr">sorting</span>: { sortBy, order },
  });
});

<span class="hljs-comment">// GET /products/categories - Get all categories</span>
router.get(<span class="hljs-string">"/categories"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> categories = [...new <span class="hljs-built_in">Set</span>(products.map(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.category))];

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: categories,
    <span class="hljs-attr">count</span>: categories.length,
  });
});

<span class="hljs-comment">// GET /products/:id - Get single product</span>
router.get(<span class="hljs-string">"/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(req.params.id);
  <span class="hljs-keyword">const</span> product = products.find(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id === id);

  <span class="hljs-keyword">if</span> (!product) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Product not found"</span>,
    });
  }

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: product,
  });
});

<span class="hljs-comment">// POST /products - Create new product (admin only)</span>
router.post(<span class="hljs-string">"/"</span>, validateProduct, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { name, price, category, stock = <span class="hljs-number">0</span> } = req.body;

  <span class="hljs-keyword">const</span> newProduct = {
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">Math</span>.max(...products.map(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id)) + <span class="hljs-number">1</span>,
    <span class="hljs-attr">name</span>: name.trim(),
    <span class="hljs-attr">price</span>: <span class="hljs-built_in">parseFloat</span>(price),
    <span class="hljs-attr">category</span>: category.trim(),
    <span class="hljs-attr">stock</span>: <span class="hljs-built_in">parseInt</span>(stock) || <span class="hljs-number">0</span>,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
    <span class="hljs-attr">updatedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
  };

  products.push(newProduct);

  res.status(<span class="hljs-number">201</span>).json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: newProduct,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Product created successfully"</span>,
  });
});

<span class="hljs-comment">// PUT /products/:id - Update product</span>
router.put(<span class="hljs-string">"/:id"</span>, validateProduct, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(req.params.id);
  <span class="hljs-keyword">const</span> productIndex = products.findIndex(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id === id);

  <span class="hljs-keyword">if</span> (productIndex === <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Product not found"</span>,
    });
  }

  <span class="hljs-keyword">const</span> { name, price, category, stock } = req.body;

  products[productIndex] = {
    ...products[productIndex],
    <span class="hljs-attr">name</span>: name.trim(),
    <span class="hljs-attr">price</span>: <span class="hljs-built_in">parseFloat</span>(price),
    <span class="hljs-attr">category</span>: category.trim(),
    <span class="hljs-attr">stock</span>: <span class="hljs-built_in">parseInt</span>(stock) || <span class="hljs-number">0</span>,
    <span class="hljs-attr">updatedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
  };

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: products[productIndex],
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Product updated successfully"</span>,
  });
});

<span class="hljs-comment">// PATCH /products/:id/stock - Update stock only</span>
router.patch(<span class="hljs-string">"/:id/stock"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(req.params.id);
  <span class="hljs-keyword">const</span> productIndex = products.findIndex(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id === id);

  <span class="hljs-keyword">if</span> (productIndex === <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Product not found"</span>,
    });
  }

  <span class="hljs-keyword">const</span> { stock } = req.body;

  <span class="hljs-keyword">if</span> (stock === <span class="hljs-literal">undefined</span> || <span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">parseInt</span>(stock))) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Valid stock quantity is required"</span>,
    });
  }

  products[productIndex].stock = <span class="hljs-built_in">parseInt</span>(stock);
  products[productIndex].updatedAt = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: products[productIndex],
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Stock updated successfully"</span>,
  });
});

<span class="hljs-comment">// DELETE /products/:id - Delete product</span>
router.delete(<span class="hljs-string">"/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(req.params.id);
  <span class="hljs-keyword">const</span> productIndex = products.findIndex(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id === id);

  <span class="hljs-keyword">if</span> (productIndex === <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Product not found"</span>,
    });
  }

  <span class="hljs-keyword">const</span> deletedProduct = products.splice(productIndex, <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>];

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: deletedProduct,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Product deleted successfully"</span>,
  });
});

<span class="hljs-built_in">module</span>.exports = router;
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">// routes/orders.js</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> router = express.Router();

<span class="hljs-comment">// Sample orders data</span>
<span class="hljs-keyword">let</span> orders = [
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">userId</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">items</span>: [
      { <span class="hljs-attr">productId</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">999.99</span> },
      { <span class="hljs-attr">productId</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">9.99</span> },
    ],
    <span class="hljs-attr">total</span>: <span class="hljs-number">1019.97</span>,
    <span class="hljs-attr">status</span>: <span class="hljs-string">"pending"</span>,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
  },
];
<span class="hljs-keyword">let</span> nextId = <span class="hljs-number">2</span>;

<span class="hljs-comment">// Order validation middleware</span>
<span class="hljs-keyword">const</span> validateOrder = <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { userId, items } = req.body;

  <span class="hljs-keyword">if</span> (!userId || <span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">parseInt</span>(userId))) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Valid user ID is required"</span>,
    });
  }

  <span class="hljs-keyword">if</span> (!items || !<span class="hljs-built_in">Array</span>.isArray(items) || items.length === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Order must contain at least one item"</span>,
    });
  }

  <span class="hljs-comment">// Validate each item</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> items) {
    <span class="hljs-keyword">if</span> (!item.productId || !item.quantity || !item.price) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Each item must have productId, quantity, and price"</span>,
      });
    }
  }

  next();
};

<span class="hljs-comment">// GET /orders - Get all orders</span>
router.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { userId, status, page = <span class="hljs-number">1</span>, limit = <span class="hljs-number">10</span> } = req.query;

  <span class="hljs-keyword">let</span> filteredOrders = [...orders];

  <span class="hljs-keyword">if</span> (userId) {
    filteredOrders = filteredOrders.filter(
      <span class="hljs-function">(<span class="hljs-params">order</span>) =&gt;</span> order.userId === <span class="hljs-built_in">parseInt</span>(userId)
    );
  }

  <span class="hljs-keyword">if</span> (status) {
    filteredOrders = filteredOrders.filter(<span class="hljs-function">(<span class="hljs-params">order</span>) =&gt;</span> order.status === status);
  }

  <span class="hljs-comment">// Pagination</span>
  <span class="hljs-keyword">const</span> startIndex = (page - <span class="hljs-number">1</span>) * limit;
  <span class="hljs-keyword">const</span> endIndex = startIndex + <span class="hljs-built_in">parseInt</span>(limit);
  <span class="hljs-keyword">const</span> paginatedOrders = filteredOrders.slice(startIndex, endIndex);

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: paginatedOrders,
    <span class="hljs-attr">pagination</span>: {
      <span class="hljs-attr">page</span>: <span class="hljs-built_in">parseInt</span>(page),
      <span class="hljs-attr">limit</span>: <span class="hljs-built_in">parseInt</span>(limit),
      <span class="hljs-attr">total</span>: filteredOrders.length,
      <span class="hljs-attr">totalPages</span>: <span class="hljs-built_in">Math</span>.ceil(filteredOrders.length / limit),
    },
  });
});

<span class="hljs-comment">// GET /orders/:id - Get single order</span>
router.get(<span class="hljs-string">"/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(req.params.id);
  <span class="hljs-keyword">const</span> order = orders.find(<span class="hljs-function">(<span class="hljs-params">o</span>) =&gt;</span> o.id === id);

  <span class="hljs-keyword">if</span> (!order) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Order not found"</span>,
    });
  }

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: order,
  });
});

<span class="hljs-comment">// POST /orders - Create new order</span>
router.post(<span class="hljs-string">"/"</span>, validateOrder, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { userId, items } = req.body;

  <span class="hljs-comment">// Calculate total</span>
  <span class="hljs-keyword">const</span> total = items.reduce(<span class="hljs-function">(<span class="hljs-params">sum, item</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> sum + item.price * item.quantity;
  }, <span class="hljs-number">0</span>);

  <span class="hljs-keyword">const</span> newOrder = {
    <span class="hljs-attr">id</span>: nextId++,
    <span class="hljs-attr">userId</span>: <span class="hljs-built_in">parseInt</span>(userId),
    items,
    <span class="hljs-attr">total</span>: <span class="hljs-built_in">parseFloat</span>(total.toFixed(<span class="hljs-number">2</span>)),
    <span class="hljs-attr">status</span>: <span class="hljs-string">"pending"</span>,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
    <span class="hljs-attr">updatedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
  };

  orders.push(newOrder);

  res.status(<span class="hljs-number">201</span>).json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: newOrder,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Order created successfully"</span>,
  });
});

<span class="hljs-comment">// PATCH /orders/:id/status - Update order status</span>
router.patch(<span class="hljs-string">"/:id/status"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(req.params.id);
  <span class="hljs-keyword">const</span> orderIndex = orders.findIndex(<span class="hljs-function">(<span class="hljs-params">o</span>) =&gt;</span> o.id === id);

  <span class="hljs-keyword">if</span> (orderIndex === <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Order not found"</span>,
    });
  }

  <span class="hljs-keyword">const</span> { status } = req.body;
  <span class="hljs-keyword">const</span> validStatuses = [
    <span class="hljs-string">"pending"</span>,
    <span class="hljs-string">"processing"</span>,
    <span class="hljs-string">"shipped"</span>,
    <span class="hljs-string">"delivered"</span>,
    <span class="hljs-string">"cancelled"</span>,
  ];

  <span class="hljs-keyword">if</span> (!status || !validStatuses.includes(status)) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">`Status must be one of: <span class="hljs-subst">${validStatuses.join(<span class="hljs-string">", "</span>)}</span>`</span>,
    });
  }

  orders[orderIndex].status = status;
  orders[orderIndex].updatedAt = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: orders[orderIndex],
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Order status updated successfully"</span>,
  });
});

<span class="hljs-built_in">module</span>.exports = router;
</div></code></pre>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-organize-routes-by-resource">1. Organize Routes by Resource</h3>
<pre class="hljs"><code><div>routes/
├── api.js          # Main API router
├── auth.js         # Authentication routes
├── users.js        # User management
├── products.js     # Product management
├── orders.js       # Order management
├── admin.js        # Admin routes
└── webhooks.js     # Webhook endpoints
</div></code></pre>
<h3 id="2-use-middleware-effectively">2. Use Middleware Effectively</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Apply middleware at router level</span>
router.use(authenticate); <span class="hljs-comment">// All routes require auth</span>
router.use(<span class="hljs-string">"/admin"</span>, authorize([<span class="hljs-string">"admin"</span>])); <span class="hljs-comment">// Admin routes only</span>

<span class="hljs-comment">// Route-specific middleware</span>
router.post(<span class="hljs-string">"/users"</span>, validateUser, createUser);
router.put(
  <span class="hljs-string">"/users/:id"</span>,
  validateUser,
  authorize([<span class="hljs-string">"admin"</span>, <span class="hljs-string">"user"</span>]),
  updateUser
);
</div></code></pre>
<h3 id="3-handle-route-parameters">3. Handle Route Parameters</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Use router.param for parameter preprocessing</span>
router.param(<span class="hljs-string">"id"</span>, (req, res, next, id) =&gt; {
  <span class="hljs-keyword">const</span> numericId = <span class="hljs-built_in">parseInt</span>(id);
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(numericId)) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Invalid ID format"</span> });
  }
  req.params.id = numericId;
  next();
});
</div></code></pre>
<h3 id="4-implement-consistent-error-handling">4. Implement Consistent Error Handling</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Async error wrapper</span>
<span class="hljs-keyword">const</span> asyncHandler = <span class="hljs-function">(<span class="hljs-params">fn</span>) =&gt;</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">Promise</span>.resolve(fn(req, res, next)).catch(next);
};

<span class="hljs-comment">// Use in routes</span>
router.get(
  <span class="hljs-string">"/users"</span>,
  asyncHandler(<span class="hljs-keyword">async</span> (req, res) =&gt; {
    <span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> User.find();
    res.json({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">data</span>: users });
  })
);
</div></code></pre>
<h3 id="5-version-your-apis">5. Version Your APIs</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// routes/v1/index.js</span>
<span class="hljs-keyword">const</span> router = express.Router();
router.use(<span class="hljs-string">"/users"</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">"./users"</span>));
router.use(<span class="hljs-string">"/posts"</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">"./posts"</span>));

<span class="hljs-comment">// routes/v2/index.js</span>
<span class="hljs-keyword">const</span> router = express.Router();
router.use(<span class="hljs-string">"/users"</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">"./users"</span>));
router.use(<span class="hljs-string">"/posts"</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">"./posts"</span>));

<span class="hljs-comment">// app.js</span>
app.use(<span class="hljs-string">"/api/v1"</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">"./routes/v1"</span>));
app.use(<span class="hljs-string">"/api/v2"</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">"./routes/v2"</span>));
</div></code></pre>
<h2 id="summary">Summary</h2>
<p>Express Router enables modular route management through:</p>
<p><strong>Core Features</strong>:</p>
<ul>
<li>Mini Express applications with routing and middleware</li>
<li>Mountable at different paths</li>
<li>Parameter handling with <code>mergeParams</code></li>
<li>Route-specific and router-level middleware</li>
</ul>
<p><strong>Organization Benefits</strong>:</p>
<ul>
<li>Separation of concerns by resource or feature</li>
<li>Easier maintenance and testing</li>
<li>Better team collaboration</li>
<li>Reusable route modules</li>
</ul>
<p><strong>Advanced Patterns</strong>:</p>
<ul>
<li>Nested routers for complex hierarchies</li>
<li>Parameter preprocessing with <code>router.param()</code></li>
<li>Middleware stacking for authentication and authorization</li>
<li>API versioning through separate routers</li>
</ul>
<p><strong>Best Practices</strong>:</p>
<ul>
<li>Organize routes by logical groupings</li>
<li>Use consistent error handling</li>
<li>Implement proper validation middleware</li>
<li>Document API endpoints</li>
<li>Version APIs for backward compatibility</li>
</ul>
<p>Mastering Express Router is essential for building scalable, maintainable Express.js applications. Next, we'll explore template engines like EJS and Pug for server-side rendering.</p>
<h1 id="template-engines-ejs-and-pug-for-server-side-rendering">Template Engines: EJS and Pug for Server-Side Rendering</h1>
<h2 id="overview">Overview</h2>
<p>Template engines allow you to generate dynamic HTML content on the server side by combining static templates with dynamic data. Express.js supports various template engines, with EJS (Embedded JavaScript) and Pug (formerly Jade) being among the most popular. Template engines enable you to create reusable layouts, inject data into HTML, implement conditional rendering, and build complete web applications with server-side rendering (SSR).</p>
<h2 id="key-concepts">Key Concepts</h2>
<h3 id="template-engines-fundamentals">Template Engines Fundamentals</h3>
<p><strong>Template Engine</strong>: A tool that combines templates (static markup) with data to produce HTML output.</p>
<p><strong>Benefits</strong>:</p>
<ul>
<li><strong>Server-Side Rendering (SSR)</strong>: Better SEO and initial page load performance</li>
<li><strong>Dynamic Content</strong>: Inject data from databases or APIs</li>
<li><strong>Reusable Components</strong>: Create layouts and partials</li>
<li><strong>Logic in Templates</strong>: Conditional rendering and loops</li>
<li><strong>Security</strong>: Automatic escaping prevents XSS attacks</li>
</ul>
<h3 id="ejs-embedded-javascript">EJS (Embedded JavaScript)</h3>
<p><strong>Characteristics</strong>:</p>
<ul>
<li>Uses plain JavaScript syntax</li>
<li>Familiar HTML-like structure</li>
<li>Easy to learn for JavaScript developers</li>
<li>Supports includes and layouts</li>
<li>Good performance</li>
</ul>
<p><strong>Syntax</strong>:</p>
<ul>
<li><code>&lt;% %&gt;</code> - JavaScript code (no output)</li>
<li><code>&lt;%= %&gt;</code> - Output escaped content</li>
<li><code>&lt;%- %&gt;</code> - Output unescaped content</li>
<li><code>&lt;%# %&gt;</code> - Comments</li>
<li><code>&lt;%- include('partial') %&gt;</code> - Include partials</li>
</ul>
<h3 id="pug-formerly-jade">Pug (formerly Jade)</h3>
<p><strong>Characteristics</strong>:</p>
<ul>
<li>Indentation-based syntax (no closing tags)</li>
<li>Concise and clean</li>
<li>Built-in features like mixins and inheritance</li>
<li>Powerful templating features</li>
<li>Steeper learning curve</li>
</ul>
<p><strong>Syntax</strong>:</p>
<ul>
<li>Indentation defines nesting</li>
<li><code>#{}</code> - Interpolation</li>
<li><code>!{}</code> - Unescaped interpolation</li>
<li><code>//</code> - Comments</li>
<li><code>include</code> and <code>extends</code> for modularity</li>
</ul>
<h2 id="example-code">Example Code</h2>
<h3 id="setting-up-ejs">Setting Up EJS</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// app.js - EJS Setup</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Set EJS as template engine</span>
app.set(<span class="hljs-string">"view engine"</span>, <span class="hljs-string">"ejs"</span>);
app.set(<span class="hljs-string">"views"</span>, path.join(__dirname, <span class="hljs-string">"views"</span>));

<span class="hljs-comment">// Middleware</span>
app.use(express.static(<span class="hljs-string">"public"</span>));
app.use(express.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> }));
app.use(express.json());

<span class="hljs-comment">// Sample data</span>
<span class="hljs-keyword">const</span> users = [
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">"John Doe"</span>,
    <span class="hljs-attr">email</span>: <span class="hljs-string">"john@example.com"</span>,
    <span class="hljs-attr">role</span>: <span class="hljs-string">"admin"</span>,
    <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span>,
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">"Jane Smith"</span>,
    <span class="hljs-attr">email</span>: <span class="hljs-string">"jane@example.com"</span>,
    <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
    <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span>,
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">"Bob Johnson"</span>,
    <span class="hljs-attr">email</span>: <span class="hljs-string">"bob@example.com"</span>,
    <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
    <span class="hljs-attr">active</span>: <span class="hljs-literal">false</span>,
  },
];

<span class="hljs-keyword">const</span> posts = [
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">title</span>: <span class="hljs-string">"Getting Started with EJS"</span>,
    <span class="hljs-attr">content</span>: <span class="hljs-string">"EJS is a simple templating language..."</span>,
    <span class="hljs-attr">authorId</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">published</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">"2024-01-15"</span>),
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">title</span>: <span class="hljs-string">"Advanced EJS Techniques"</span>,
    <span class="hljs-attr">content</span>: <span class="hljs-string">"Learn advanced EJS features..."</span>,
    <span class="hljs-attr">authorId</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">published</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">"2024-01-20"</span>),
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">title</span>: <span class="hljs-string">"Draft Post"</span>,
    <span class="hljs-attr">content</span>: <span class="hljs-string">"This is a draft..."</span>,
    <span class="hljs-attr">authorId</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">published</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">"2024-01-25"</span>),
  },
];

<span class="hljs-comment">// Routes</span>
app.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> publishedPosts = posts.filter(<span class="hljs-function">(<span class="hljs-params">post</span>) =&gt;</span> post.published);
  res.render(<span class="hljs-string">"index"</span>, {
    <span class="hljs-attr">title</span>: <span class="hljs-string">"Welcome to EJS Demo"</span>,
    <span class="hljs-attr">posts</span>: publishedPosts,
    users,
    <span class="hljs-attr">currentUser</span>: users[<span class="hljs-number">0</span>], <span class="hljs-comment">// Simulate logged-in user</span>
  });
});

app.get(<span class="hljs-string">"/users"</span>, (req, res) =&gt; {
  res.render(<span class="hljs-string">"users"</span>, {
    <span class="hljs-attr">title</span>: <span class="hljs-string">"User Management"</span>,
    users,
    <span class="hljs-attr">currentUser</span>: users[<span class="hljs-number">0</span>],
  });
});

app.get(<span class="hljs-string">"/users/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> userId = <span class="hljs-built_in">parseInt</span>(req.params.id);
  <span class="hljs-keyword">const</span> user = users.find(<span class="hljs-function">(<span class="hljs-params">u</span>) =&gt;</span> u.id === userId);

  <span class="hljs-keyword">if</span> (!user) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).render(<span class="hljs-string">"error"</span>, {
      <span class="hljs-attr">title</span>: <span class="hljs-string">"User Not Found"</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"The requested user could not be found."</span>,
      <span class="hljs-attr">currentUser</span>: users[<span class="hljs-number">0</span>],
    });
  }

  <span class="hljs-keyword">const</span> userPosts = posts.filter(<span class="hljs-function">(<span class="hljs-params">post</span>) =&gt;</span> post.authorId === userId);

  res.render(<span class="hljs-string">"user-detail"</span>, {
    <span class="hljs-attr">title</span>: <span class="hljs-string">`User: <span class="hljs-subst">${user.name}</span>`</span>,
    user,
    <span class="hljs-attr">posts</span>: userPosts,
    <span class="hljs-attr">currentUser</span>: users[<span class="hljs-number">0</span>],
  });
});

app.get(<span class="hljs-string">"/posts/new"</span>, (req, res) =&gt; {
  res.render(<span class="hljs-string">"post-form"</span>, {
    <span class="hljs-attr">title</span>: <span class="hljs-string">"Create New Post"</span>,
    <span class="hljs-attr">post</span>: <span class="hljs-literal">null</span>,
    users,
    <span class="hljs-attr">currentUser</span>: users[<span class="hljs-number">0</span>],
  });
});

app.post(<span class="hljs-string">"/posts"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { title, content, authorId, published } = req.body;

  <span class="hljs-keyword">const</span> newPost = {
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">Math</span>.max(...posts.map(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id)) + <span class="hljs-number">1</span>,
    title,
    content,
    <span class="hljs-attr">authorId</span>: <span class="hljs-built_in">parseInt</span>(authorId),
    <span class="hljs-attr">published</span>: published === <span class="hljs-string">"on"</span>,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
  };

  posts.push(newPost);
  res.redirect(<span class="hljs-string">"/"</span>);
});

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
app.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🚀 EJS Server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</div></code></pre>
<h3 id="ejs-templates">EJS Templates</h3>
<pre class="hljs"><code><div><span class="hljs-comment">&lt;!-- views/layout.ejs - Main Layout --&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">title</span> %&gt;</span> | EJS Demo<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span>
      <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"</span>
      <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span>
    /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span>
      <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"</span>
      <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span>
    /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
      <span class="hljs-selector-class">.navbar-brand</span> {
        <span class="hljs-attribute">font-weight</span>: bold;
      }
      <span class="hljs-selector-class">.post-card</span> {
        <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.2s</span>;
      }
      <span class="hljs-selector-class">.post-card</span><span class="hljs-selector-pseudo">:hover</span> {
        <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">2px</span>);
      }
      <span class="hljs-selector-class">.user-avatar</span> {
        <span class="hljs-attribute">width</span>: <span class="hljs-number">40px</span>;
        <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;
      }
      <span class="hljs-selector-tag">footer</span> {
        <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">50px</span>;
      }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Navigation --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">%-</span> <span class="hljs-attr">include</span>('<span class="hljs-attr">partials</span>/<span class="hljs-attr">navbar</span>') %&gt;</span>

    <span class="hljs-comment">&lt;!-- Main Content --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container mt-4"</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- Flash Messages --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">%</span> <span class="hljs-attr">if</span> (<span class="hljs-attr">typeof</span> <span class="hljs-attr">message</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-attr">message</span>) { %&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"alert alert-info alert-dismissible fade show"</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"alert"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">message</span> %&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
          <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span>
          <span class="hljs-attr">class</span>=<span class="hljs-string">"btn-close"</span>
          <span class="hljs-attr">data-bs-dismiss</span>=<span class="hljs-string">"alert"</span>
        &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">%</span> } %&gt;</span>

      <span class="hljs-comment">&lt;!-- Page Content --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">%-</span> <span class="hljs-attr">body</span> %&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Footer --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">%-</span> <span class="hljs-attr">include</span>('<span class="hljs-attr">partials</span>/<span class="hljs-attr">footer</span>') %&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">&lt;!-- views/partials/navbar.ejs --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar navbar-expand-lg navbar-dark bg-primary"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar-brand"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-code"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> EJS Demo <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar-toggler"</span>
      <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span>
      <span class="hljs-attr">data-bs-toggle</span>=<span class="hljs-string">"collapse"</span>
      <span class="hljs-attr">data-bs-target</span>=<span class="hljs-string">"#navbarNav"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar-toggler-icon"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"collapse navbar-collapse"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"navbarNav"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar-nav me-auto"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-home"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> Home <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/users"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-users"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> Users
          <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/posts/new"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-plus"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> New Post
          <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>

      <span class="hljs-comment">&lt;!-- User Info --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">%</span> <span class="hljs-attr">if</span> (<span class="hljs-attr">typeof</span> <span class="hljs-attr">currentUser</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-attr">currentUser</span>) { %&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar-nav"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item dropdown"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">a</span>
            <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link dropdown-toggle"</span>
            <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>
            <span class="hljs-attr">role</span>=<span class="hljs-string">"button"</span>
            <span class="hljs-attr">data-bs-toggle</span>=<span class="hljs-string">"dropdown"</span>
          &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
              <span class="hljs-attr">src</span>=<span class="hljs-string">"https://ui-avatars.com/api/?name=&lt;%= encodeURIComponent(currentUser.name) %&gt;&amp;background=random"</span>
              <span class="hljs-attr">alt</span>=<span class="hljs-string">"&lt;%= currentUser.name %&gt;"</span>
              <span class="hljs-attr">class</span>=<span class="hljs-string">"rounded-circle user-avatar me-2"</span>
            /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">currentUser.name</span> %&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dropdown-menu"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dropdown-item"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/users/&lt;%= currentUser.id %&gt;"</span>
                &gt;</span>Profile<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>
              &gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dropdown-item"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/settings"</span>&gt;</span>Settings<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">hr</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dropdown-divider"</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dropdown-item"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/logout"</span>&gt;</span>Logout<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">%</span> } %&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">&lt;!-- views/partials/footer.ejs --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">footer</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bg-light py-4 mt-5"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"row"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-md-6"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h5</span>&gt;</span>EJS Demo Application<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-muted"</span>&gt;</span>Built with Express.js and EJS template engine.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-md-6 text-md-end"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-muted"</span>&gt;</span>
          <span class="hljs-symbol">&amp;copy;</span> <span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">new</span> <span class="hljs-attr">Date</span>()<span class="hljs-attr">.getFullYear</span>() %&gt;</span> EJS Demo. Generated at <span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">new</span>
          <span class="hljs-attr">Date</span>()<span class="hljs-attr">.toLocaleString</span>() %&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">&lt;!-- views/index.ejs --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">%</span> // <span class="hljs-attr">Define</span> <span class="hljs-attr">the</span> <span class="hljs-attr">body</span> <span class="hljs-attr">content</span> <span class="hljs-attr">const</span> <span class="hljs-attr">bodyContent</span> = `
&lt;<span class="hljs-attr">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"row"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-lg-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mb-4"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-newspaper"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> Latest Posts<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">%</span> <span class="hljs-attr">if</span> (<span class="hljs-attr">posts</span> &amp;&amp; <span class="hljs-attr">posts.length</span> &gt;</span> 0) { %&gt; <span class="hljs-tag">&lt;<span class="hljs-name">%</span> <span class="hljs-attr">posts.forEach</span>(<span class="hljs-attr">post</span> =&gt;</span> { %&gt; <span class="hljs-tag">&lt;<span class="hljs-name">%</span>
    <span class="hljs-attr">const</span> <span class="hljs-attr">author</span> = <span class="hljs-string">users.find(u</span> =&gt;</span> u.id === post.authorId) %&gt;
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card post-card mb-4 shadow-sm"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-body"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"d-flex justify-content-between align-items-start mb-3"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h5</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-title mb-0"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/posts/&lt;%= post.id %&gt;"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-decoration-none"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">post.title</span> %&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">%</span> <span class="hljs-attr">if</span> (<span class="hljs-attr">post.published</span>) { %&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"badge bg-success"</span>&gt;</span>Published<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">%</span> } <span class="hljs-attr">else</span> { %&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"badge bg-warning"</span>&gt;</span>Draft<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">%</span> } %&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-text text-muted"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">post.content.substring</span>(<span class="hljs-attr">0</span>, <span class="hljs-attr">150</span>) %&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">%</span> <span class="hljs-attr">if</span> (<span class="hljs-attr">post.content.length</span> &gt;</span>
          150) { %&gt;...<span class="hljs-tag">&lt;<span class="hljs-name">%</span> } %&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"d-flex justify-content-between align-items-center"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"d-flex align-items-center"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
              <span class="hljs-attr">src</span>=<span class="hljs-string">"https://ui-avatars.com/api/?name=&lt;%= encodeURIComponent(author.name) %&gt;&amp;background=random"</span>
              <span class="hljs-attr">alt</span>=<span class="hljs-string">"&lt;%= author.name %&gt;"</span>
              <span class="hljs-attr">class</span>=<span class="hljs-string">"rounded-circle me-2"</span>
              <span class="hljs-attr">width</span>=<span class="hljs-string">"32"</span>
              <span class="hljs-attr">height</span>=<span class="hljs-string">"32"</span>
            /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">small</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-muted"</span>&gt;</span>
              By
              <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/users/&lt;%= author.id %&gt;"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-decoration-none"</span>
                &gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">author.name</span> %&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>
              &gt;</span>
              on <span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">post.createdAt.toLocaleDateString</span>() %&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">small</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">a</span>
            <span class="hljs-attr">href</span>=<span class="hljs-string">"/posts/&lt;%= post.id %&gt;"</span>
            <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-outline-primary btn-sm"</span>
          &gt;</span>
            Read More <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-arrow-right"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">%</span> }) %&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">%</span> } <span class="hljs-attr">else</span> { %&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-center py-5"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-newspaper fa-3x text-muted mb-3"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-muted"</span>&gt;</span>No posts available<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-muted"</span>&gt;</span>Be the first to create a post!<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/posts/new"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-primary"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-plus"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> Create Post
      <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">%</span> } %&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-lg-4"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-header"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h5</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mb-0"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-users"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> Active Users<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-body"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">%</span> <span class="hljs-attr">const</span> <span class="hljs-attr">activeUsers</span> = <span class="hljs-string">users.filter(u</span> =&gt;</span> u.active) %&gt; <span class="hljs-tag">&lt;<span class="hljs-name">%</span>
        <span class="hljs-attr">activeUsers.forEach</span>(<span class="hljs-attr">user</span> =&gt;</span> { %&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"d-flex align-items-center mb-3"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
            <span class="hljs-attr">src</span>=<span class="hljs-string">"https://ui-avatars.com/api/?name=&lt;%= encodeURIComponent(user.name) %&gt;&amp;background=random"</span>
            <span class="hljs-attr">alt</span>=<span class="hljs-string">"&lt;%= user.name %&gt;"</span>
            <span class="hljs-attr">class</span>=<span class="hljs-string">"rounded-circle me-3"</span>
            <span class="hljs-attr">width</span>=<span class="hljs-string">"40"</span>
            <span class="hljs-attr">height</span>=<span class="hljs-string">"40"</span>
          /&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h6</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mb-0"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/users/&lt;%= user.id %&gt;"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-decoration-none"</span>
                &gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">user.name</span> %&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>
              &gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">h6</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">small</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-muted"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-crown text-warning"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">user.role</span> %&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">small</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">%</span> }) %&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card mt-4"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-header"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h5</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mb-0"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-chart-bar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> Statistics<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-body"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"row text-center"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-6"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-primary"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">posts.filter</span>(<span class="hljs-attr">p</span> =&gt;</span> p.published).length %&gt;
            <span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">small</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-muted"</span>&gt;</span>Published Posts<span class="hljs-tag">&lt;/<span class="hljs-name">small</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-6"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-success"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">users.filter</span>(<span class="hljs-attr">u</span> =&gt;</span> u.active).length %&gt;
            <span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">small</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-muted"</span>&gt;</span>Active Users<span class="hljs-tag">&lt;/<span class="hljs-name">small</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
`; %&gt; <span class="hljs-tag">&lt;<span class="hljs-name">%-</span> <span class="hljs-attr">include</span>('<span class="hljs-attr">layout</span>', { <span class="hljs-attr">body:</span> <span class="hljs-attr">bodyContent</span> }) %&gt;</span>
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">&lt;!-- views/users.ejs --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">%</span> <span class="hljs-attr">const</span> <span class="hljs-attr">bodyContent</span> = `
&lt;<span class="hljs-attr">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"d-flex justify-content-between align-items-center mb-4"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-users"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> User Management<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/users/new"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-primary"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-plus"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> Add User
  <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-body"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"table-responsive"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"table table-hover"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">thead</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"table-dark"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>Avatar<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>Name<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>Email<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>Role<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>Status<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>Actions<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">tbody</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">%</span> <span class="hljs-attr">users.forEach</span>(<span class="hljs-attr">user</span> =&gt;</span> { %&gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
                <span class="hljs-attr">src</span>=<span class="hljs-string">"https://ui-avatars.com/api/?name=&lt;%= encodeURIComponent(user.name) %&gt;&amp;background=random"</span>
                <span class="hljs-attr">alt</span>=<span class="hljs-string">"&lt;%= user.name %&gt;"</span>
                <span class="hljs-attr">class</span>=<span class="hljs-string">"rounded-circle"</span>
                <span class="hljs-attr">width</span>=<span class="hljs-string">"40"</span>
                <span class="hljs-attr">height</span>=<span class="hljs-string">"40"</span>
              /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">user.name</span> %&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"mailto:&lt;%= user.email %&gt;"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-decoration-none"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">user.email</span> %&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">%</span> <span class="hljs-attr">if</span> (<span class="hljs-attr">user.role</span> === <span class="hljs-string">'admin'</span>) { %&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"badge bg-danger"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-crown"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> Admin
              <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">%</span> } <span class="hljs-attr">else</span> { %&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"badge bg-primary"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-user"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> User
              <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">%</span> } %&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">%</span> <span class="hljs-attr">if</span> (<span class="hljs-attr">user.active</span>) { %&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"badge bg-success"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-check"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> Active
              <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">%</span> } <span class="hljs-attr">else</span> { %&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"badge bg-secondary"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-times"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> Inactive
              <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">%</span> } %&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn-group"</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"group"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">a</span>
                  <span class="hljs-attr">href</span>=<span class="hljs-string">"/users/&lt;%= user.id %&gt;"</span>
                  <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-sm btn-outline-primary"</span>
                &gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-eye"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">a</span>
                  <span class="hljs-attr">href</span>=<span class="hljs-string">"/users/&lt;%= user.id %&gt;/edit"</span>
                  <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-sm btn-outline-warning"</span>
                &gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-edit"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">%</span> <span class="hljs-attr">if</span> (<span class="hljs-attr">user.id</span> !== <span class="hljs-string">currentUser.id)</span> { %&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
                  <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-sm btn-outline-danger"</span>
                  <span class="hljs-attr">onclick</span>=<span class="hljs-string">"deleteUser(&lt;%= user.id %&gt;)"</span>
                &gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-trash"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">%</span> } %&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">%</span> }) %&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">tbody</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript">
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deleteUser</span><span class="hljs-params">(userId)</span> </span>{
      <span class="hljs-keyword">if</span> (confirm(<span class="hljs-string">'Are you sure you want to delete this user?'</span>)) {
          fetch(\`/users/\${userId}\`, {
              method: <span class="hljs-string">'DELETE'</span>,
              headers: {
                  <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
              }
          })
          .then(response =&gt; {
              <span class="hljs-keyword">if</span> (response.ok) {
                  location.reload();
              } <span class="hljs-keyword">else</span> {
                  alert(<span class="hljs-string">'Error deleting user'</span>);
              }
          })
          .catch(error =&gt; {
              console.error(<span class="hljs-string">'Error:'</span>, error);
              alert(<span class="hljs-string">'Error deleting user'</span>);
          });
      }
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
`; %&gt; <span class="hljs-tag">&lt;<span class="hljs-name">%-</span> <span class="hljs-attr">include</span>('<span class="hljs-attr">layout</span>', { <span class="hljs-attr">body:</span> <span class="hljs-attr">bodyContent</span> }) %&gt;</span>
</div></code></pre>
<h3 id="setting-up-pug">Setting Up Pug</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// app-pug.js - Pug Setup</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Set Pug as template engine</span>
app.set(<span class="hljs-string">"view engine"</span>, <span class="hljs-string">"pug"</span>);
app.set(<span class="hljs-string">"views"</span>, path.join(__dirname, <span class="hljs-string">"views-pug"</span>));

<span class="hljs-comment">// Middleware</span>
app.use(express.static(<span class="hljs-string">"public"</span>));
app.use(express.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> }));
app.use(express.json());

<span class="hljs-comment">// Helper functions for templates</span>
app.locals.formatDate = <span class="hljs-function">(<span class="hljs-params">date</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(date).toLocaleDateString(<span class="hljs-string">"en-US"</span>, {
    <span class="hljs-attr">year</span>: <span class="hljs-string">"numeric"</span>,
    <span class="hljs-attr">month</span>: <span class="hljs-string">"long"</span>,
    <span class="hljs-attr">day</span>: <span class="hljs-string">"numeric"</span>,
  });
};

app.locals.truncate = <span class="hljs-function">(<span class="hljs-params">text, length = <span class="hljs-number">100</span></span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> text.length &gt; length ? text.substring(<span class="hljs-number">0</span>, length) + <span class="hljs-string">"..."</span> : text;
};

<span class="hljs-comment">// Sample data (same as EJS example)</span>
<span class="hljs-keyword">const</span> users = [
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">"John Doe"</span>,
    <span class="hljs-attr">email</span>: <span class="hljs-string">"john@example.com"</span>,
    <span class="hljs-attr">role</span>: <span class="hljs-string">"admin"</span>,
    <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span>,
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">"Jane Smith"</span>,
    <span class="hljs-attr">email</span>: <span class="hljs-string">"jane@example.com"</span>,
    <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
    <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span>,
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">"Bob Johnson"</span>,
    <span class="hljs-attr">email</span>: <span class="hljs-string">"bob@example.com"</span>,
    <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
    <span class="hljs-attr">active</span>: <span class="hljs-literal">false</span>,
  },
];

<span class="hljs-keyword">const</span> posts = [
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">title</span>: <span class="hljs-string">"Getting Started with Pug"</span>,
    <span class="hljs-attr">content</span>: <span class="hljs-string">"Pug is a clean, whitespace-sensitive syntax..."</span>,
    <span class="hljs-attr">authorId</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">published</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">"2024-01-15"</span>),
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">title</span>: <span class="hljs-string">"Advanced Pug Features"</span>,
    <span class="hljs-attr">content</span>: <span class="hljs-string">"Learn about mixins, inheritance, and more..."</span>,
    <span class="hljs-attr">authorId</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">published</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">"2024-01-20"</span>),
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">title</span>: <span class="hljs-string">"Draft Post"</span>,
    <span class="hljs-attr">content</span>: <span class="hljs-string">"This is a draft..."</span>,
    <span class="hljs-attr">authorId</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">published</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">"2024-01-25"</span>),
  },
];

<span class="hljs-comment">// Routes</span>
app.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> publishedPosts = posts.filter(<span class="hljs-function">(<span class="hljs-params">post</span>) =&gt;</span> post.published);
  res.render(<span class="hljs-string">"index"</span>, {
    <span class="hljs-attr">title</span>: <span class="hljs-string">"Welcome to Pug Demo"</span>,
    <span class="hljs-attr">posts</span>: publishedPosts,
    users,
    <span class="hljs-attr">currentUser</span>: users[<span class="hljs-number">0</span>],
  });
});

app.get(<span class="hljs-string">"/users"</span>, (req, res) =&gt; {
  res.render(<span class="hljs-string">"users"</span>, {
    <span class="hljs-attr">title</span>: <span class="hljs-string">"User Management"</span>,
    users,
    <span class="hljs-attr">currentUser</span>: users[<span class="hljs-number">0</span>],
  });
});

app.get(<span class="hljs-string">"/about"</span>, (req, res) =&gt; {
  res.render(<span class="hljs-string">"about"</span>, {
    <span class="hljs-attr">title</span>: <span class="hljs-string">"About Pug"</span>,
    <span class="hljs-attr">features</span>: [
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"Clean Syntax"</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"No closing tags, indentation-based"</span>,
      },
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"Powerful Features"</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"Mixins, inheritance, includes"</span>,
      },
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"JavaScript Integration"</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"Full JavaScript support"</span>,
      },
      { <span class="hljs-attr">name</span>: <span class="hljs-string">"Performance"</span>, <span class="hljs-attr">description</span>: <span class="hljs-string">"Compiled templates for speed"</span> },
    ],
    <span class="hljs-attr">currentUser</span>: users[<span class="hljs-number">0</span>],
  });
});

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3001</span>;
app.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🚀 Pug Server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</div></code></pre>
<h3 id="pug-templates">Pug Templates</h3>
<pre class="hljs"><code><div>//- views-pug/layout.pug - Main Layout
doctype html
html(lang='en')
  head
    meta(charset='UTF-8')
    meta(name='viewport', content='width=device-width, initial-scale=1.0')
    title #{title} | Pug Demo
    link(href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css', rel='stylesheet')
    link(href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css', rel='stylesheet')
    style.
      .navbar-brand { font-weight: bold; }
      .post-card { transition: transform 0.2s; }
      .post-card:hover { transform: translateY(-2px); }
      .user-avatar { width: 40px; height: 40px; }
      footer { margin-top: 50px; }

  body
    //- Navigation
    include partials/navbar

    //- Main Content
    main.container.mt-4
      //- Flash Messages
      if message
        .alert.alert-info.alert-dismissible.fade.show(role='alert')
          = message
          button.btn-close(type='button', data-bs-dismiss='alert')

      //- Page Content
      block content

    //- Footer
    include partials/footer

    script(src='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js')
</div></code></pre>
<pre class="hljs"><code><div>//- views-pug/partials/navbar.pug
nav.navbar.navbar-expand-lg.navbar-dark.bg-primary
  .container
    a.navbar-brand(href='/')
      i.fas.fa-code
      |  Pug Demo

    button.navbar-toggler(type='button', data-bs-toggle='collapse', data-bs-target='#navbarNav')
      span.navbar-toggler-icon

    .collapse.navbar-collapse#navbarNav
      ul.navbar-nav.me-auto
        li.nav-item
          a.nav-link(href='/')
            i.fas.fa-home
            |  Home
        li.nav-item
          a.nav-link(href='/users')
            i.fas.fa-users
            |  Users
        li.nav-item
          a.nav-link(href='/about')
            i.fas.fa-info-circle
            |  About

      //- User Info
      if currentUser
        .navbar-nav
          .nav-item.dropdown
            a.nav-link.dropdown-toggle(href='#', role='button', data-bs-toggle='dropdown')
              img.rounded-circle.user-avatar.me-2(src=`https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&amp;background=random`, alt=currentUser.name)
              = currentUser.name
            ul.dropdown-menu
              li: a.dropdown-item(href=`/users/${currentUser.id}`) Profile
              li: a.dropdown-item(href='/settings') Settings
              li: hr.dropdown-divider
              li: a.dropdown-item(href='/logout') Logout
</div></code></pre>
<pre class="hljs"><code><div>//- views-pug/partials/footer.pug
footer.bg-light.py-4.mt-5
  .container
    .row
      .col-md-6
        h5 Pug Demo Application
        p.text-muted Built with Express.js and Pug template engine.
      .col-md-6.text-md-end
        p.text-muted
          | &amp;copy; #{new Date().getFullYear()} Pug Demo.
          | Generated at #{new Date().toLocaleString()}
</div></code></pre>
<pre class="hljs"><code><div>//- views-pug/mixins/post-card.pug
mixin postCard(post, author)
  .card.post-card.mb-4.shadow-sm
    .card-body
      .d-flex.justify-content-between.align-items-start.mb-3
        h5.card-title.mb-0
          a.text-decoration-none(href=`/posts/${post.id}`)= post.title
        if post.published
          span.badge.bg-success Published
        else
          span.badge.bg-warning Draft

      p.card-text.text-muted= truncate(post.content, 150)

      .d-flex.justify-content-between.align-items-center
        .d-flex.align-items-center
          img.rounded-circle.me-2(src=`https://ui-avatars.com/api/?name=${encodeURIComponent(author.name)}&amp;background=random`, alt=author.name, width='32', height='32')
          small.text-muted
            | By
            a.text-decoration-none(href=`/users/${author.id}`)= author.name
            |  on #{formatDate(post.createdAt)}
        a.btn.btn-outline-primary.btn-sm(href=`/posts/${post.id}`)
          | Read More
          i.fas.fa-arrow-right

mixin userBadge(user)
  .d-flex.align-items-center.mb-3
    img.rounded-circle.me-3(src=`https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&amp;background=random`, alt=user.name, width='40', height='40')
    div
      h6.mb-0
        a.text-decoration-none(href=`/users/${user.id}`)= user.name
      small.text-muted
        i.fas.fa-crown.text-warning
        |  #{user.role}
</div></code></pre>
<pre class="hljs"><code><div>//- views-pug/index.pug
extends layout
include mixins/post-card

block content
  .row
    .col-lg-8
      h1.mb-4
        i.fas.fa-newspaper
        |  Latest Posts

      if posts &amp;&amp; posts.length &gt; 0
        each post in posts
          - const author = users.find(u =&gt; u.id === post.authorId)
          +postCard(post, author)
      else
        .text-center.py-5
          i.fas.fa-newspaper.fa-3x.text-muted.mb-3
          h3.text-muted No posts available
          p.text-muted Be the first to create a post!
          a.btn.btn-primary(href='/posts/new')
            i.fas.fa-plus
            |  Create Post

    .col-lg-4
      .card
        .card-header
          h5.mb-0
            i.fas.fa-users
            |  Active Users
        .card-body
          - const activeUsers = users.filter(u =&gt; u.active)
          each user in activeUsers
            +userBadge(user)

      .card.mt-4
        .card-header
          h5.mb-0
            i.fas.fa-chart-bar
            |  Statistics
        .card-body
          .row.text-center
            .col-6
              h3.text-primary= posts.filter(p =&gt; p.published).length
              small.text-muted Published Posts
            .col-6
              h3.text-success= users.filter(u =&gt; u.active).length
              small.text-muted Active Users
</div></code></pre>
<pre class="hljs"><code><div>//- views-pug/about.pug
extends layout

block content
  .row.justify-content-center
    .col-lg-8
      h1.text-center.mb-5
        i.fas.fa-info-circle.text-primary
        |  About Pug Template Engine

      .card.shadow
        .card-body.p-5
          p.lead.text-center.mb-4
            | Pug is a clean, whitespace-sensitive syntax for writing HTML.

          h3.mb-4 Key Features

          .row
            each feature in features
              .col-md-6.mb-4
                .card.h-100.border-0.bg-light
                  .card-body.text-center
                    h5.card-title.text-primary= feature.name
                    p.card-text= feature.description

          h3.mb-3 Syntax Comparison

          .row
            .col-md-6
              h5 HTML
              pre.bg-light.p-3
                code.
                  &amp;lt;div class=&quot;container&quot;&amp;gt;
                    &amp;lt;h1&amp;gt;Hello World&amp;lt;/h1&amp;gt;
                    &amp;lt;p&amp;gt;Welcome to our site&amp;lt;/p&amp;gt;
                  &amp;lt;/div&amp;gt;

            .col-md-6
              h5 Pug
              pre.bg-light.p-3
                code.
                  .container
                    h1 Hello World
                    p Welcome to our site

          .text-center.mt-4
            a.btn.btn-primary.btn-lg(href='https://pugjs.org', target='_blank')
              | Learn More About Pug
              i.fas.fa-external-link-alt.ms-2
</div></code></pre>
<h2 id="real-world-use-case">Real-World Use Case</h2>
<h3 id="blog-application-with-both-template-engines">Blog Application with Both Template Engines</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// blog-app.js - Complete Blog Application</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>).promises;
<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Configuration</span>
<span class="hljs-keyword">const</span> config = {
    <span class="hljs-attr">templateEngine</span>: process.env.TEMPLATE_ENGINE || <span class="hljs-string">'ejs'</span>, <span class="hljs-comment">// 'ejs' or 'pug'</span>
    <span class="hljs-attr">port</span>: process.env.PORT || <span class="hljs-number">3000</span>,
    <span class="hljs-attr">postsPerPage</span>: <span class="hljs-number">5</span>
};

<span class="hljs-comment">// Set template engine based on config</span>
<span class="hljs-keyword">if</span> (config.templateEngine === <span class="hljs-string">'pug'</span>) {
    app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">'pug'</span>);
    app.set(<span class="hljs-string">'views'</span>, path.join(__dirname, <span class="hljs-string">'views-pug'</span>));
} <span class="hljs-keyword">else</span> {
    app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">'ejs'</span>);
    app.set(<span class="hljs-string">'views'</span>, path.join(__dirname, <span class="hljs-string">'views'</span>));
}

<span class="hljs-comment">// Middleware</span>
app.use(express.static(<span class="hljs-string">'public'</span>));
app.use(express.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> }));
app.use(express.json());

<span class="hljs-comment">// Template helpers</span>
app.locals.formatDate = <span class="hljs-function">(<span class="hljs-params">date</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(date).toLocaleDateString(<span class="hljs-string">'en-US'</span>, {
        <span class="hljs-attr">year</span>: <span class="hljs-string">'numeric'</span>,
        <span class="hljs-attr">month</span>: <span class="hljs-string">'long'</span>,
        <span class="hljs-attr">day</span>: <span class="hljs-string">'numeric'</span>,
        <span class="hljs-attr">hour</span>: <span class="hljs-string">'2-digit'</span>,
        <span class="hljs-attr">minute</span>: <span class="hljs-string">'2-digit'</span>
    });
};

app.locals.truncate = <span class="hljs-function">(<span class="hljs-params">text, length = <span class="hljs-number">100</span></span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> text.length &gt; length ? text.substring(<span class="hljs-number">0</span>, length) + <span class="hljs-string">'...'</span> : text;
};

app.locals.slugify = <span class="hljs-function">(<span class="hljs-params">text</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> text.toLowerCase()
        .replace(<span class="hljs-regexp">/[^\w\s-]/g</span>, <span class="hljs-string">''</span>)
        .replace(<span class="hljs-regexp">/[\s_-]+/g</span>, <span class="hljs-string">'-'</span>)
        .replace(<span class="hljs-regexp">/^-+|-+$/g</span>, <span class="hljs-string">''</span>);
};

<span class="hljs-comment">// Data storage (in production, use a database)</span>
<span class="hljs-keyword">let</span> blogData = {
    <span class="hljs-attr">posts</span>: [
        {
            <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">title</span>: <span class="hljs-string">'Getting Started with Template Engines'</span>,
            <span class="hljs-attr">slug</span>: <span class="hljs-string">'getting-started-template-engines'</span>,
            <span class="hljs-attr">content</span>: <span class="hljs-string">`Template engines are powerful tools that allow developers to generate dynamic HTML content by combining static templates with dynamic data. In this comprehensive guide, we'll explore the fundamentals of template engines and how they can revolutionize your web development workflow.

## What are Template Engines?

Template engines separate the presentation layer from the business logic, making your code more maintainable and organized. They allow you to:

- Create reusable layouts and components
- Inject dynamic data into static templates
- Implement conditional rendering and loops
- Maintain clean separation of concerns

## Popular Template Engines

### EJS (Embedded JavaScript)
EJS uses familiar JavaScript syntax and HTML-like structure, making it easy for developers to adopt.

### Pug (formerly Jade)
Pug offers a clean, indentation-based syntax that eliminates the need for closing tags.

### Handlebars
Handlebars provides a logic-less templating approach with powerful helpers.

## Best Practices

1. **Keep logic minimal** - Templates should focus on presentation
2. **Use partials** - Break down templates into reusable components
3. **Escape user input** - Prevent XSS attacks with proper escaping
4. **Cache templates** - Improve performance in production

Template engines are essential tools for modern web development, enabling developers to create dynamic, maintainable, and secure web applications.`</span>,
            <span class="hljs-attr">excerpt</span>: <span class="hljs-string">'Learn the fundamentals of template engines and how they can improve your web development workflow.'</span>,
            <span class="hljs-attr">authorId</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">categoryId</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">published</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">featured</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">tags</span>: [<span class="hljs-string">'web-development'</span>, <span class="hljs-string">'templates'</span>, <span class="hljs-string">'ejs'</span>, <span class="hljs-string">'pug'</span>],
            <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">'2024-01-15T10:00:00Z'</span>),
            <span class="hljs-attr">updatedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">'2024-01-15T10:00:00Z'</span>),
            <span class="hljs-attr">views</span>: <span class="hljs-number">1250</span>,
            <span class="hljs-attr">likes</span>: <span class="hljs-number">89</span>
        },
        {
            <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
            <span class="hljs-attr">title</span>: <span class="hljs-string">'Advanced EJS Techniques and Best Practices'</span>,
            <span class="hljs-attr">slug</span>: <span class="hljs-string">'advanced-ejs-techniques'</span>,
            <span class="hljs-attr">content</span>: <span class="hljs-string">`EJS (Embedded JavaScript) is one of the most popular template engines for Node.js applications. While it's easy to get started with EJS, mastering its advanced features can significantly improve your development productivity and code quality.

## Advanced EJS Features

### Custom Delimiters
You can customize EJS delimiters to avoid conflicts with other templating systems:

\`\`\`javascript
app.set('view options', {
    delimiter: '?'
});
\`\`\`

### Includes with Data
Pass data to included templates:

\`\`\`ejs
&lt;%- include('partials/header', { pageTitle: 'Custom Title' }) %&gt;
\`\`\`

### Caching for Performance
Enable template caching in production:

\`\`\`javascript
if (process.env.NODE_ENV === 'production') {
    app.set('view cache', true);
}
\`\`\`

### Error Handling
Implement proper error handling in templates:

\`\`\`ejs
&lt;% try { %&gt;
    &lt;%= user.name %&gt;
&lt;% } catch (error) { %&gt;
    &lt;span class="text-muted"&gt;Name not available&lt;/span&gt;
&lt;% } %&gt;
\`\`\`

## Performance Optimization

1. **Enable caching** in production environments
2. **Minimize logic** in templates
3. **Use partials** for reusable components
4. **Precompile templates** for better performance

## Security Considerations

- Always use `</span>&lt;%= %&gt;<span class="hljs-string">` for user input to prevent XSS
- Validate data before passing to templates
- Use Content Security Policy (CSP) headers
- Sanitize HTML content when necessary

By following these advanced techniques and best practices, you can build robust, secure, and performant web applications with EJS.`</span>,
            <span class="hljs-attr">excerpt</span>: <span class="hljs-string">'Discover advanced EJS techniques, performance optimization tips, and security best practices.'</span>,
            <span class="hljs-attr">authorId</span>: <span class="hljs-number">2</span>,
            <span class="hljs-attr">categoryId</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">published</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">featured</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">tags</span>: [<span class="hljs-string">'ejs'</span>, <span class="hljs-string">'performance'</span>, <span class="hljs-string">'security'</span>, <span class="hljs-string">'best-practices'</span>],
            <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">'2024-01-20T14:30:00Z'</span>),
            <span class="hljs-attr">updatedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">'2024-01-20T14:30:00Z'</span>),
            <span class="hljs-attr">views</span>: <span class="hljs-number">892</span>,
            <span class="hljs-attr">likes</span>: <span class="hljs-number">67</span>
        },
        {
            <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>,
            <span class="hljs-attr">title</span>: <span class="hljs-string">'Mastering Pug: From Basics to Advanced Features'</span>,
            <span class="hljs-attr">slug</span>: <span class="hljs-string">'mastering-pug-template-engine'</span>,
            <span class="hljs-attr">content</span>: <span class="hljs-string">`Pug (formerly known as Jade) is a powerful, clean, and feature-rich template engine for Node.js. Its indentation-based syntax and powerful features make it a favorite among developers who value clean, maintainable code.

## Why Choose Pug?

### Clean Syntax
Pug's indentation-based syntax eliminates the need for closing tags:

\`\`\`pug
div.container
  h1.title Welcome to Pug
  p.description This is much cleaner than HTML
\`\`\`

### Powerful Features

#### Mixins
Create reusable template functions:

\`\`\`pug
mixin button(text, type='button')
  button(class=\`btn btn-\${type}\`)= text

+button('Click me', 'primary')
+button('Cancel', 'secondary')
\`\`\`

#### Template Inheritance
Extend layouts for consistent structure:

\`\`\`pug
//- layout.pug
doctype html
html
  head
    title= title
  body
    block content

//- page.pug
extends layout
block content
  h1 Page Content
\`\`\`

#### Filters
Process content with built-in filters:

\`\`\`pug
script.
  const message = 'Hello from Pug!';
  console.log(message);

style.
  .highlight {
    background-color: yellow;
  }
\`\`\`

## Advanced Techniques

### Conditional Classes
\`\`\`pug
div(class={ active: isActive, disabled: !isEnabled })
\`\`\`

### Iteration with Index
\`\`\`pug
ul
  each item, index in items
    li(class=index % 2 ? 'odd' : 'even')= item
\`\`\`

### Case Statements
\`\`\`pug
case user.role
  when 'admin'
    p You are an administrator
  when 'user'
    p You are a regular user
  default
    p Unknown role
\`\`\`

## Best Practices

1. **Use mixins** for reusable components
2. **Leverage inheritance** for consistent layouts
3. **Keep indentation consistent** (2 or 4 spaces)
4. **Use meaningful variable names**
5. **Comment complex logic**

Pug's powerful features and clean syntax make it an excellent choice for developers who want to write maintainable, readable templates while leveraging advanced templating capabilities.`</span>,
            <span class="hljs-attr">excerpt</span>: <span class="hljs-string">'Explore Pug\'s powerful features including mixins, inheritance, and advanced templating techniques.'</span>,
            <span class="hljs-attr">authorId</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">categoryId</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">published</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">featured</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">tags</span>: [<span class="hljs-string">'pug'</span>, <span class="hljs-string">'jade'</span>, <span class="hljs-string">'templates'</span>, <span class="hljs-string">'mixins'</span>, <span class="hljs-string">'inheritance'</span>],
            <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">'2024-01-25T09:15:00Z'</span>),
            <span class="hljs-attr">updatedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">'2024-01-25T09:15:00Z'</span>),
            <span class="hljs-attr">views</span>: <span class="hljs-number">1456</span>,
            <span class="hljs-attr">likes</span>: <span class="hljs-number">123</span>
        }
    ],
    <span class="hljs-attr">authors</span>: [
        {
            <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">name</span>: <span class="hljs-string">'Alex Johnson'</span>,
            <span class="hljs-attr">email</span>: <span class="hljs-string">'alex@example.com'</span>,
            <span class="hljs-attr">bio</span>: <span class="hljs-string">'Full-stack developer with 8+ years of experience in Node.js and modern web technologies.'</span>,
            <span class="hljs-attr">avatar</span>: <span class="hljs-string">'https://ui-avatars.com/api/?name=Alex+Johnson&amp;background=random'</span>,
            <span class="hljs-attr">social</span>: {
                <span class="hljs-attr">twitter</span>: <span class="hljs-string">'@alexjohnson'</span>,
                <span class="hljs-attr">github</span>: <span class="hljs-string">'alexjohnson'</span>,
                <span class="hljs-attr">linkedin</span>: <span class="hljs-string">'alex-johnson'</span>
            },
            <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span>
        },
        {
            <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
            <span class="hljs-attr">name</span>: <span class="hljs-string">'Sarah Chen'</span>,
            <span class="hljs-attr">email</span>: <span class="hljs-string">'sarah@example.com'</span>,
            <span class="hljs-attr">bio</span>: <span class="hljs-string">'Frontend specialist and UI/UX enthusiast. Passionate about creating beautiful, accessible web experiences.'</span>,
            <span class="hljs-attr">avatar</span>: <span class="hljs-string">'https://ui-avatars.com/api/?name=Sarah+Chen&amp;background=random'</span>,
            <span class="hljs-attr">social</span>: {
                <span class="hljs-attr">twitter</span>: <span class="hljs-string">'@sarahchen'</span>,
                <span class="hljs-attr">github</span>: <span class="hljs-string">'sarahchen'</span>,
                <span class="hljs-attr">dribbble</span>: <span class="hljs-string">'sarahchen'</span>
            },
            <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span>
        }
    ],
    <span class="hljs-attr">categories</span>: [
        { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Web Development'</span>, <span class="hljs-attr">slug</span>: <span class="hljs-string">'web-development'</span>, <span class="hljs-attr">description</span>: <span class="hljs-string">'Articles about web development technologies and best practices'</span> },
        { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'JavaScript'</span>, <span class="hljs-attr">slug</span>: <span class="hljs-string">'javascript'</span>, <span class="hljs-attr">description</span>: <span class="hljs-string">'JavaScript tutorials, tips, and advanced techniques'</span> },
        { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Node.js'</span>, <span class="hljs-attr">slug</span>: <span class="hljs-string">'nodejs'</span>, <span class="hljs-attr">description</span>: <span class="hljs-string">'Server-side JavaScript with Node.js'</span> }
    ]
};

<span class="hljs-comment">// Helper functions</span>
<span class="hljs-keyword">const</span> getPostsByCategory = <span class="hljs-function">(<span class="hljs-params">categoryId</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> blogData.posts.filter(<span class="hljs-function"><span class="hljs-params">post</span> =&gt;</span> post.categoryId === categoryId &amp;&amp; post.published);
};

<span class="hljs-keyword">const</span> getPostsByTag = <span class="hljs-function">(<span class="hljs-params">tag</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> blogData.posts.filter(<span class="hljs-function"><span class="hljs-params">post</span> =&gt;</span> post.tags.includes(tag) &amp;&amp; post.published);
};

<span class="hljs-keyword">const</span> getFeaturedPosts = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> blogData.posts.filter(<span class="hljs-function"><span class="hljs-params">post</span> =&gt;</span> post.featured &amp;&amp; post.published);
};

<span class="hljs-keyword">const</span> getPopularPosts = <span class="hljs-function">(<span class="hljs-params">limit = <span class="hljs-number">5</span></span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> blogData.posts
        .filter(<span class="hljs-function"><span class="hljs-params">post</span> =&gt;</span> post.published)
        .sort(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> b.views - a.views)
        .slice(<span class="hljs-number">0</span>, limit);
};

<span class="hljs-comment">// Routes</span>
app.get(<span class="hljs-string">'/'</span>, (req, res) =&gt; {
    <span class="hljs-keyword">const</span> page = <span class="hljs-built_in">parseInt</span>(req.query.page) || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> limit = config.postsPerPage;
    <span class="hljs-keyword">const</span> offset = (page - <span class="hljs-number">1</span>) * limit;

    <span class="hljs-keyword">const</span> publishedPosts = blogData.posts.filter(<span class="hljs-function"><span class="hljs-params">post</span> =&gt;</span> post.published);
    <span class="hljs-keyword">const</span> totalPosts = publishedPosts.length;
    <span class="hljs-keyword">const</span> totalPages = <span class="hljs-built_in">Math</span>.ceil(totalPosts / limit);

    <span class="hljs-keyword">const</span> posts = publishedPosts
        .sort(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(b.createdAt) - <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(a.createdAt))
        .slice(offset, offset + limit);

    <span class="hljs-keyword">const</span> featuredPosts = getFeaturedPosts();
    <span class="hljs-keyword">const</span> popularPosts = getPopularPosts(<span class="hljs-number">3</span>);

    res.render(<span class="hljs-string">'blog/index'</span>, {
        <span class="hljs-attr">title</span>: <span class="hljs-string">'Template Engine Blog'</span>,
        posts,
        featuredPosts,
        popularPosts,
        <span class="hljs-attr">authors</span>: blogData.authors,
        <span class="hljs-attr">categories</span>: blogData.categories,
        <span class="hljs-attr">pagination</span>: {
            page,
            totalPages,
            <span class="hljs-attr">hasNext</span>: page &lt; totalPages,
            <span class="hljs-attr">hasPrev</span>: page &gt; <span class="hljs-number">1</span>,
            <span class="hljs-attr">nextPage</span>: page + <span class="hljs-number">1</span>,
            <span class="hljs-attr">prevPage</span>: page - <span class="hljs-number">1</span>
        },
        <span class="hljs-attr">templateEngine</span>: config.templateEngine
    });
});

app.get(<span class="hljs-string">'/post/:slug'</span>, (req, res) =&gt; {
    <span class="hljs-keyword">const</span> post = blogData.posts.find(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.slug === req.params.slug &amp;&amp; p.published);

    <span class="hljs-keyword">if</span> (!post) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).render(<span class="hljs-string">'error'</span>, {
            <span class="hljs-attr">title</span>: <span class="hljs-string">'Post Not Found'</span>,
            <span class="hljs-attr">error</span>: <span class="hljs-string">'The requested blog post could not be found.'</span>,
            <span class="hljs-attr">statusCode</span>: <span class="hljs-number">404</span>
        });
    }

    <span class="hljs-comment">// Increment views</span>
    post.views++;

    <span class="hljs-keyword">const</span> author = blogData.authors.find(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a.id === post.authorId);
    <span class="hljs-keyword">const</span> category = blogData.categories.find(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c.id === post.categoryId);
    <span class="hljs-keyword">const</span> relatedPosts = getPostsByCategory(post.categoryId)
        .filter(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.id !== post.id)
        .slice(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>);

    res.render(<span class="hljs-string">'blog/post'</span>, {
        <span class="hljs-attr">title</span>: post.title,
        post,
        author,
        category,
        relatedPosts,
        <span class="hljs-attr">authors</span>: blogData.authors
    });
});

app.get(<span class="hljs-string">'/category/:slug'</span>, (req, res) =&gt; {
    <span class="hljs-keyword">const</span> category = blogData.categories.find(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c.slug === req.params.slug);

    <span class="hljs-keyword">if</span> (!category) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).render(<span class="hljs-string">'error'</span>, {
            <span class="hljs-attr">title</span>: <span class="hljs-string">'Category Not Found'</span>,
            <span class="hljs-attr">error</span>: <span class="hljs-string">'The requested category could not be found.'</span>,
            <span class="hljs-attr">statusCode</span>: <span class="hljs-number">404</span>
        });
    }

    <span class="hljs-keyword">const</span> posts = getPostsByCategory(category.id);

    res.render(<span class="hljs-string">'blog/category'</span>, {
        <span class="hljs-attr">title</span>: <span class="hljs-string">`Category: <span class="hljs-subst">${category.name}</span>`</span>,
        category,
        posts,
        <span class="hljs-attr">authors</span>: blogData.authors
    });
});

app.get(<span class="hljs-string">'/tag/:tag'</span>, (req, res) =&gt; {
    <span class="hljs-keyword">const</span> tag = req.params.tag;
    <span class="hljs-keyword">const</span> posts = getPostsByTag(tag);

    res.render(<span class="hljs-string">'blog/tag'</span>, {
        <span class="hljs-attr">title</span>: <span class="hljs-string">`Tag: <span class="hljs-subst">${tag}</span>`</span>,
        tag,
        posts,
        <span class="hljs-attr">authors</span>: blogData.authors
    });
});

app.get(<span class="hljs-string">'/author/:id'</span>, (req, res) =&gt; {
    <span class="hljs-keyword">const</span> authorId = <span class="hljs-built_in">parseInt</span>(req.params.id);
    <span class="hljs-keyword">const</span> author = blogData.authors.find(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a.id === authorId);

    <span class="hljs-keyword">if</span> (!author) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).render(<span class="hljs-string">'error'</span>, {
            <span class="hljs-attr">title</span>: <span class="hljs-string">'Author Not Found'</span>,
            <span class="hljs-attr">error</span>: <span class="hljs-string">'The requested author could not be found.'</span>,
            <span class="hljs-attr">statusCode</span>: <span class="hljs-number">404</span>
        });
    }

    <span class="hljs-keyword">const</span> posts = blogData.posts.filter(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.authorId === authorId &amp;&amp; p.published);

    res.render(<span class="hljs-string">'blog/author'</span>, {
        <span class="hljs-attr">title</span>: <span class="hljs-string">`Author: <span class="hljs-subst">${author.name}</span>`</span>,
        author,
        posts
    });
});

<span class="hljs-comment">// API endpoints for AJAX requests</span>
app.get(<span class="hljs-string">'/api/posts/search'</span>, (req, res) =&gt; {
    <span class="hljs-keyword">const</span> { q, category, tag } = req.query;
    <span class="hljs-keyword">let</span> posts = blogData.posts.filter(<span class="hljs-function"><span class="hljs-params">post</span> =&gt;</span> post.published);

    <span class="hljs-keyword">if</span> (q) {
        <span class="hljs-keyword">const</span> query = q.toLowerCase();
        posts = posts.filter(<span class="hljs-function"><span class="hljs-params">post</span> =&gt;</span>
            post.title.toLowerCase().includes(query) ||
            post.content.toLowerCase().includes(query) ||
            post.excerpt.toLowerCase().includes(query)
        );
    }

    <span class="hljs-keyword">if</span> (category) {
        <span class="hljs-keyword">const</span> categoryId = <span class="hljs-built_in">parseInt</span>(category);
        posts = posts.filter(<span class="hljs-function"><span class="hljs-params">post</span> =&gt;</span> post.categoryId === categoryId);
    }

    <span class="hljs-keyword">if</span> (tag) {
        posts = posts.filter(<span class="hljs-function"><span class="hljs-params">post</span> =&gt;</span> post.tags.includes(tag));
    }

    res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: posts.map(<span class="hljs-function"><span class="hljs-params">post</span> =&gt;</span> ({
            <span class="hljs-attr">id</span>: post.id,
            <span class="hljs-attr">title</span>: post.title,
            <span class="hljs-attr">slug</span>: post.slug,
            <span class="hljs-attr">excerpt</span>: post.excerpt,
            <span class="hljs-attr">author</span>: blogData.authors.find(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a.id === post.authorId)?.name,
            <span class="hljs-attr">category</span>: blogData.categories.find(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c.id === post.categoryId)?.name,
            <span class="hljs-attr">createdAt</span>: post.createdAt,
            <span class="hljs-attr">views</span>: post.views,
            <span class="hljs-attr">likes</span>: post.likes
        })),
        <span class="hljs-attr">count</span>: posts.length
    });
});

<span class="hljs-comment">// Error handling</span>
app.use(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
    res.status(<span class="hljs-number">404</span>).render(<span class="hljs-string">'error'</span>, {
        <span class="hljs-attr">title</span>: <span class="hljs-string">'Page Not Found'</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">'The requested page could not be found.'</span>,
        <span class="hljs-attr">statusCode</span>: <span class="hljs-number">404</span>
    });
});

app.use(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error:'</span>, err);
    res.status(<span class="hljs-number">500</span>).render(<span class="hljs-string">'error'</span>, {
        <span class="hljs-attr">title</span>: <span class="hljs-string">'Server Error'</span>,
        <span class="hljs-attr">error</span>: process.env.NODE_ENV === <span class="hljs-string">'production'</span>
            ? <span class="hljs-string">'An internal server error occurred.'</span>
            : err.message,
        <span class="hljs-attr">statusCode</span>: <span class="hljs-number">500</span>
    });
});

app.listen(config.port, () =&gt; {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🚀 Blog Server running on http://localhost:<span class="hljs-subst">${config.port}</span>`</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`📝 Template Engine: <span class="hljs-subst">${config.templateEngine.toUpperCase()}</span>`</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`📚 Total Posts: <span class="hljs-subst">${blogData.posts.length}</span>`</span>);
});

<span class="hljs-built_in">module</span>.exports = app;
</div></code></pre>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-choose-the-right-template-engine">1. Choose the Right Template Engine</h3>
<p><strong>Use EJS when</strong>:</p>
<ul>
<li>Team is familiar with HTML and JavaScript</li>
<li>Need quick setup and minimal learning curve</li>
<li>Working with existing HTML templates</li>
<li>Prefer explicit syntax</li>
</ul>
<p><strong>Use Pug when</strong>:</p>
<ul>
<li>Want clean, concise syntax</li>
<li>Need powerful features like mixins and inheritance</li>
<li>Building new projects from scratch</li>
<li>Team values code brevity</li>
</ul>
<h3 id="2-organize-templates-effectively">2. Organize Templates Effectively</h3>
<pre class="hljs"><code><div>views/
├── layouts/
│   ├── main.ejs
│   └── admin.ejs
├── partials/
│   ├── header.ejs
│   ├── footer.ejs
│   └── navigation.ejs
├── pages/
│   ├── home.ejs
│   ├── about.ejs
│   └── contact.ejs
└── components/
    ├── post-card.ejs
    └── user-profile.ejs
</div></code></pre>
<h3 id="3-security-considerations">3. Security Considerations</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Always escape user input</span>
&lt;%= userInput %&gt; <span class="hljs-comment">// Safe - automatically escaped</span>
&lt;%- userInput %&gt; <span class="hljs-comment">// Dangerous - unescaped</span>

<span class="hljs-comment">// Validate data before rendering</span>
<span class="hljs-keyword">const</span> sanitizeHtml = <span class="hljs-built_in">require</span>(<span class="hljs-string">'sanitize-html'</span>);
app.locals.sanitize = <span class="hljs-function">(<span class="hljs-params">html</span>) =&gt;</span> sanitizeHtml(html);
</div></code></pre>
<h3 id="4-performance-optimization">4. Performance Optimization</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Enable template caching in production</span>
<span class="hljs-keyword">if</span> (process.env.NODE_ENV === <span class="hljs-string">"production"</span>) {
  app.set(<span class="hljs-string">"view cache"</span>, <span class="hljs-literal">true</span>);
}

<span class="hljs-comment">// Precompile templates</span>
<span class="hljs-keyword">const</span> ejs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"ejs"</span>);
<span class="hljs-keyword">const</span> template = ejs.compile(templateString, { <span class="hljs-attr">cache</span>: <span class="hljs-literal">true</span> });
</div></code></pre>
<h3 id="5-error-handling">5. Error Handling</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Graceful error handling in templates</span>
&lt;% <span class="hljs-keyword">try</span> { %&gt;
    &lt;%= user.profile.name %&gt;
&lt;% } <span class="hljs-keyword">catch</span> (error) { %&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-muted"</span>&gt;</span>Name not available<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>
&lt;% } %&gt;
</div></code></pre>
<h2 id="summary">Summary</h2>
<p>Template engines are essential tools for server-side rendering:</p>
<p><strong>Key Benefits</strong>:</p>
<ul>
<li><strong>Dynamic Content</strong>: Inject data into static templates</li>
<li><strong>Code Reusability</strong>: Create layouts, partials, and components</li>
<li><strong>Separation of Concerns</strong>: Keep presentation separate from logic</li>
<li><strong>Security</strong>: Automatic escaping prevents XSS attacks</li>
</ul>
<p><strong>EJS Advantages</strong>:</p>
<ul>
<li>Familiar JavaScript syntax</li>
<li>Easy learning curve</li>
<li>Good performance</li>
<li>Extensive ecosystem</li>
</ul>
<p><strong>Pug Advantages</strong>:</p>
<ul>
<li>Clean, concise syntax</li>
<li>Powerful features (mixins, inheritance)</li>
<li>Built-in filters and helpers</li>
<li>Excellent for new projects</li>
</ul>
<p><strong>Best Practices</strong>:</p>
<ul>
<li>Choose the right engine for your team and project</li>
<li>Organize templates logically</li>
<li>Always escape user input</li>
<li>Enable caching in production</li>
<li>Handle errors gracefully</li>
</ul>
<p>Template engines enable you to build dynamic, maintainable web applications with server-side rendering capabilities. Next, we'll explore RESTful API design principles for building robust web services.</p>
<h1 id="restful-api-design-principles">RESTful API Design Principles</h1>
<h2 id="overview">Overview</h2>
<p>REST (Representational State Transfer) is an architectural style for designing networked applications, particularly web services. RESTful APIs have become the standard for building web services due to their simplicity, scalability, and stateless nature. Understanding REST principles is crucial for creating APIs that are intuitive, maintainable, and follow industry best practices.</p>
<h2 id="key-concepts">Key Concepts</h2>
<h3 id="rest-fundamentals">REST Fundamentals</h3>
<p><strong>REST (Representational State Transfer)</strong>: An architectural style that defines a set of constraints for creating web services.</p>
<p><strong>Key Principles</strong>:</p>
<ol>
<li><strong>Stateless</strong>: Each request contains all information needed to process it</li>
<li><strong>Client-Server</strong>: Separation of concerns between client and server</li>
<li><strong>Cacheable</strong>: Responses should be cacheable when appropriate</li>
<li><strong>Uniform Interface</strong>: Consistent interface for all resources</li>
<li><strong>Layered System</strong>: Architecture can be composed of hierarchical layers</li>
<li><strong>Code on Demand</strong> (optional): Server can send executable code to client</li>
</ol>
<h3 id="http-methods-and-their-usage">HTTP Methods and Their Usage</h3>
<ul>
<li><strong>GET</strong>: Retrieve data (safe and idempotent)</li>
<li><strong>POST</strong>: Create new resources</li>
<li><strong>PUT</strong>: Update/replace entire resource (idempotent)</li>
<li><strong>PATCH</strong>: Partial update of resource</li>
<li><strong>DELETE</strong>: Remove resource (idempotent)</li>
<li><strong>HEAD</strong>: Get headers only (like GET but no body)</li>
<li><strong>OPTIONS</strong>: Get allowed methods for resource</li>
</ul>
<h3 id="http-status-codes">HTTP Status Codes</h3>
<p><strong>Success (2xx)</strong>:</p>
<ul>
<li><code>200 OK</code>: Request successful</li>
<li><code>201 Created</code>: Resource created successfully</li>
<li><code>204 No Content</code>: Successful request with no response body</li>
</ul>
<p><strong>Client Error (4xx)</strong>:</p>
<ul>
<li><code>400 Bad Request</code>: Invalid request syntax</li>
<li><code>401 Unauthorized</code>: Authentication required</li>
<li><code>403 Forbidden</code>: Access denied</li>
<li><code>404 Not Found</code>: Resource not found</li>
<li><code>409 Conflict</code>: Request conflicts with current state</li>
<li><code>422 Unprocessable Entity</code>: Validation errors</li>
</ul>
<p><strong>Server Error (5xx)</strong>:</p>
<ul>
<li><code>500 Internal Server Error</code>: Generic server error</li>
<li><code>502 Bad Gateway</code>: Invalid response from upstream server</li>
<li><code>503 Service Unavailable</code>: Server temporarily unavailable</li>
</ul>
<h3 id="resource-naming-conventions">Resource Naming Conventions</h3>
<ul>
<li>Use <strong>nouns</strong>, not verbs: <code>/users</code> not <code>/getUsers</code></li>
<li>Use <strong>plural nouns</strong>: <code>/users</code> not <code>/user</code></li>
<li>Use <strong>hierarchical structure</strong>: <code>/users/123/posts</code></li>
<li>Use <strong>lowercase</strong>: <code>/users</code> not <code>/Users</code></li>
<li>Use <strong>hyphens</strong> for multi-word resources: <code>/user-profiles</code></li>
</ul>
<h2 id="example-code">Example Code</h2>
<h3 id="basic-restful-api-structure">Basic RESTful API Structure</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// models/User.js - User Model</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{
  <span class="hljs-keyword">constructor</span>(data) {
    <span class="hljs-keyword">this</span>.id = data.id;
    <span class="hljs-keyword">this</span>.username = data.username;
    <span class="hljs-keyword">this</span>.email = data.email;
    <span class="hljs-keyword">this</span>.firstName = data.firstName;
    <span class="hljs-keyword">this</span>.lastName = data.lastName;
    <span class="hljs-keyword">this</span>.role = data.role || <span class="hljs-string">"user"</span>;
    <span class="hljs-keyword">this</span>.active = data.active !== <span class="hljs-literal">undefined</span> ? data.active : <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.createdAt = data.createdAt || <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
    <span class="hljs-keyword">this</span>.updatedAt = data.updatedAt || <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
  }

  <span class="hljs-comment">// Validation method</span>
  validate() {
    <span class="hljs-keyword">const</span> errors = [];

    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.username || <span class="hljs-keyword">this</span>.username.length &lt; <span class="hljs-number">3</span>) {
      errors.push(<span class="hljs-string">"Username must be at least 3 characters long"</span>);
    }

    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.email || !<span class="hljs-keyword">this</span>.isValidEmail(<span class="hljs-keyword">this</span>.email)) {
      errors.push(<span class="hljs-string">"Valid email is required"</span>);
    }

    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.firstName || <span class="hljs-keyword">this</span>.firstName.length &lt; <span class="hljs-number">1</span>) {
      errors.push(<span class="hljs-string">"First name is required"</span>);
    }

    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.lastName || <span class="hljs-keyword">this</span>.lastName.length &lt; <span class="hljs-number">1</span>) {
      errors.push(<span class="hljs-string">"Last name is required"</span>);
    }

    <span class="hljs-keyword">return</span> errors;
  }

  isValidEmail(email) {
    <span class="hljs-keyword">const</span> emailRegex = <span class="hljs-regexp">/^[^\s@]+@[^\s@]+\.[^\s@]+$/</span>;
    <span class="hljs-keyword">return</span> emailRegex.test(email);
  }

  <span class="hljs-comment">// Get public representation (exclude sensitive data)</span>
  toPublic() {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">id</span>: <span class="hljs-keyword">this</span>.id,
      <span class="hljs-attr">username</span>: <span class="hljs-keyword">this</span>.username,
      <span class="hljs-attr">email</span>: <span class="hljs-keyword">this</span>.email,
      <span class="hljs-attr">firstName</span>: <span class="hljs-keyword">this</span>.firstName,
      <span class="hljs-attr">lastName</span>: <span class="hljs-keyword">this</span>.lastName,
      <span class="hljs-attr">fullName</span>: <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.firstName}</span> <span class="hljs-subst">${<span class="hljs-keyword">this</span>.lastName}</span>`</span>,
      <span class="hljs-attr">role</span>: <span class="hljs-keyword">this</span>.role,
      <span class="hljs-attr">active</span>: <span class="hljs-keyword">this</span>.active,
      <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">this</span>.createdAt,
      <span class="hljs-attr">updatedAt</span>: <span class="hljs-keyword">this</span>.updatedAt,
    };
  }
}

<span class="hljs-built_in">module</span>.exports = User;
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">// services/UserService.js - Business Logic Layer</span>
<span class="hljs-keyword">const</span> User = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../models/User"</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserService</span> </span>{
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-comment">// In-memory storage (use database in production)</span>
    <span class="hljs-keyword">this</span>.users = [
      <span class="hljs-keyword">new</span> User({
        <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">username</span>: <span class="hljs-string">"johndoe"</span>,
        <span class="hljs-attr">email</span>: <span class="hljs-string">"john@example.com"</span>,
        <span class="hljs-attr">firstName</span>: <span class="hljs-string">"John"</span>,
        <span class="hljs-attr">lastName</span>: <span class="hljs-string">"Doe"</span>,
        <span class="hljs-attr">role</span>: <span class="hljs-string">"admin"</span>,
      }),
      <span class="hljs-keyword">new</span> User({
        <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
        <span class="hljs-attr">username</span>: <span class="hljs-string">"janedoe"</span>,
        <span class="hljs-attr">email</span>: <span class="hljs-string">"jane@example.com"</span>,
        <span class="hljs-attr">firstName</span>: <span class="hljs-string">"Jane"</span>,
        <span class="hljs-attr">lastName</span>: <span class="hljs-string">"Doe"</span>,
        <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
      }),
    ];
    <span class="hljs-keyword">this</span>.nextId = <span class="hljs-number">3</span>;
  }

  <span class="hljs-comment">// Get all users with filtering and pagination</span>
  <span class="hljs-keyword">async</span> getAllUsers(options = {}) {
    <span class="hljs-keyword">const</span> {
      page = <span class="hljs-number">1</span>,
      limit = <span class="hljs-number">10</span>,
      sortBy = <span class="hljs-string">"createdAt"</span>,
      sortOrder = <span class="hljs-string">"desc"</span>,
      role,
      active,
      search,
    } = options;

    <span class="hljs-keyword">let</span> filteredUsers = [...this.users];

    <span class="hljs-comment">// Apply filters</span>
    <span class="hljs-keyword">if</span> (role) {
      filteredUsers = filteredUsers.filter(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> user.role === role);
    }

    <span class="hljs-keyword">if</span> (active !== <span class="hljs-literal">undefined</span>) {
      filteredUsers = filteredUsers.filter(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> user.active === active);
    }

    <span class="hljs-keyword">if</span> (search) {
      <span class="hljs-keyword">const</span> searchLower = search.toLowerCase();
      filteredUsers = filteredUsers.filter(
        <span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span>
          user.username.toLowerCase().includes(searchLower) ||
          user.email.toLowerCase().includes(searchLower) ||
          user.firstName.toLowerCase().includes(searchLower) ||
          user.lastName.toLowerCase().includes(searchLower)
      );
    }

    <span class="hljs-comment">// Apply sorting</span>
    filteredUsers.sort(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> {
      <span class="hljs-keyword">let</span> aVal = a[sortBy];
      <span class="hljs-keyword">let</span> bVal = b[sortBy];

      <span class="hljs-keyword">if</span> (sortBy === <span class="hljs-string">"createdAt"</span> || sortBy === <span class="hljs-string">"updatedAt"</span>) {
        aVal = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(aVal);
        bVal = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(bVal);
      }

      <span class="hljs-keyword">if</span> (sortOrder === <span class="hljs-string">"desc"</span>) {
        <span class="hljs-keyword">return</span> bVal &gt; aVal ? <span class="hljs-number">1</span> : <span class="hljs-number">-1</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> aVal &gt; bVal ? <span class="hljs-number">1</span> : <span class="hljs-number">-1</span>;
      }
    });

    <span class="hljs-comment">// Apply pagination</span>
    <span class="hljs-keyword">const</span> total = filteredUsers.length;
    <span class="hljs-keyword">const</span> totalPages = <span class="hljs-built_in">Math</span>.ceil(total / limit);
    <span class="hljs-keyword">const</span> offset = (page - <span class="hljs-number">1</span>) * limit;
    <span class="hljs-keyword">const</span> paginatedUsers = filteredUsers.slice(offset, offset + limit);

    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">users</span>: paginatedUsers.map(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> user.toPublic()),
      <span class="hljs-attr">pagination</span>: {
        <span class="hljs-attr">page</span>: <span class="hljs-built_in">parseInt</span>(page),
        <span class="hljs-attr">limit</span>: <span class="hljs-built_in">parseInt</span>(limit),
        total,
        totalPages,
        <span class="hljs-attr">hasNext</span>: page &lt; totalPages,
        <span class="hljs-attr">hasPrev</span>: page &gt; <span class="hljs-number">1</span>,
      },
    };
  }

  <span class="hljs-comment">// Get user by ID</span>
  <span class="hljs-keyword">async</span> getUserById(id) {
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">this</span>.users.find(<span class="hljs-function">(<span class="hljs-params">u</span>) =&gt;</span> u.id === <span class="hljs-built_in">parseInt</span>(id));
    <span class="hljs-keyword">return</span> user ? user.toPublic() : <span class="hljs-literal">null</span>;
  }

  <span class="hljs-comment">// Create new user</span>
  <span class="hljs-keyword">async</span> createUser(userData) {
    <span class="hljs-comment">// Check if username or email already exists</span>
    <span class="hljs-keyword">const</span> existingUser = <span class="hljs-keyword">this</span>.users.find(
      <span class="hljs-function">(<span class="hljs-params">u</span>) =&gt;</span> u.username === userData.username || u.email === userData.email
    );

    <span class="hljs-keyword">if</span> (existingUser) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Username or email already exists"</span>);
    }

    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">new</span> User({
      ...userData,
      <span class="hljs-attr">id</span>: <span class="hljs-keyword">this</span>.nextId++,
    });

    <span class="hljs-keyword">const</span> validationErrors = user.validate();
    <span class="hljs-keyword">if</span> (validationErrors.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Validation failed: <span class="hljs-subst">${validationErrors.join(<span class="hljs-string">", "</span>)}</span>`</span>);
    }

    <span class="hljs-keyword">this</span>.users.push(user);
    <span class="hljs-keyword">return</span> user.toPublic();
  }

  <span class="hljs-comment">// Update user</span>
  <span class="hljs-keyword">async</span> updateUser(id, updateData) {
    <span class="hljs-keyword">const</span> userIndex = <span class="hljs-keyword">this</span>.users.findIndex(<span class="hljs-function">(<span class="hljs-params">u</span>) =&gt;</span> u.id === <span class="hljs-built_in">parseInt</span>(id));

    <span class="hljs-keyword">if</span> (userIndex === <span class="hljs-number">-1</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-comment">// Check for conflicts with other users</span>
    <span class="hljs-keyword">if</span> (updateData.username || updateData.email) {
      <span class="hljs-keyword">const</span> conflictUser = <span class="hljs-keyword">this</span>.users.find(
        <span class="hljs-function">(<span class="hljs-params">u</span>) =&gt;</span>
          u.id !== <span class="hljs-built_in">parseInt</span>(id) &amp;&amp;
          (u.username === updateData.username || u.email === updateData.email)
      );

      <span class="hljs-keyword">if</span> (conflictUser) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Username or email already exists"</span>);
      }
    }

    <span class="hljs-comment">// Update user data</span>
    <span class="hljs-keyword">const</span> updatedUser = <span class="hljs-keyword">new</span> User({
      ...this.users[userIndex],
      ...updateData,
      <span class="hljs-attr">id</span>: <span class="hljs-built_in">parseInt</span>(id),
      <span class="hljs-attr">updatedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
    });

    <span class="hljs-keyword">const</span> validationErrors = updatedUser.validate();
    <span class="hljs-keyword">if</span> (validationErrors.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Validation failed: <span class="hljs-subst">${validationErrors.join(<span class="hljs-string">", "</span>)}</span>`</span>);
    }

    <span class="hljs-keyword">this</span>.users[userIndex] = updatedUser;
    <span class="hljs-keyword">return</span> updatedUser.toPublic();
  }

  <span class="hljs-comment">// Delete user</span>
  <span class="hljs-keyword">async</span> deleteUser(id) {
    <span class="hljs-keyword">const</span> userIndex = <span class="hljs-keyword">this</span>.users.findIndex(<span class="hljs-function">(<span class="hljs-params">u</span>) =&gt;</span> u.id === <span class="hljs-built_in">parseInt</span>(id));

    <span class="hljs-keyword">if</span> (userIndex === <span class="hljs-number">-1</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">const</span> deletedUser = <span class="hljs-keyword">this</span>.users.splice(userIndex, <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">return</span> deletedUser.toPublic();
  }

  <span class="hljs-comment">// Soft delete (deactivate) user</span>
  <span class="hljs-keyword">async</span> deactivateUser(id) {
    <span class="hljs-keyword">const</span> userIndex = <span class="hljs-keyword">this</span>.users.findIndex(<span class="hljs-function">(<span class="hljs-params">u</span>) =&gt;</span> u.id === <span class="hljs-built_in">parseInt</span>(id));

    <span class="hljs-keyword">if</span> (userIndex === <span class="hljs-number">-1</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">this</span>.users[userIndex].active = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.users[userIndex].updatedAt = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.users[userIndex].toPublic();
  }
}

<span class="hljs-built_in">module</span>.exports = UserService;
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">// controllers/UserController.js - Request/Response Handling</span>
<span class="hljs-keyword">const</span> UserService = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../services/UserService"</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>{
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.userService = <span class="hljs-keyword">new</span> UserService();
  }

  <span class="hljs-comment">// GET /api/users</span>
  <span class="hljs-keyword">async</span> getUsers(req, res) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> options = {
        <span class="hljs-attr">page</span>: req.query.page,
        <span class="hljs-attr">limit</span>: req.query.limit,
        <span class="hljs-attr">sortBy</span>: req.query.sortBy,
        <span class="hljs-attr">sortOrder</span>: req.query.sortOrder,
        <span class="hljs-attr">role</span>: req.query.role,
        <span class="hljs-attr">active</span>:
          req.query.active === <span class="hljs-string">"true"</span>
            ? <span class="hljs-literal">true</span>
            : req.query.active === <span class="hljs-string">"false"</span>
            ? <span class="hljs-literal">false</span>
            : <span class="hljs-literal">undefined</span>,
        <span class="hljs-attr">search</span>: req.query.search,
      };

      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.userService.getAllUsers(options);

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: result.users,
        <span class="hljs-attr">pagination</span>: result.pagination,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Users retrieved successfully"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      res.status(<span class="hljs-number">500</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal server error"</span>,
        <span class="hljs-attr">message</span>: error.message,
      });
    }
  }

  <span class="hljs-comment">// GET /api/users/:id</span>
  <span class="hljs-keyword">async</span> getUserById(req, res) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.userService.getUserById(req.params.id);

      <span class="hljs-keyword">if</span> (!user) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"User not found"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">`User with ID <span class="hljs-subst">${req.params.id}</span> does not exist`</span>,
        });
      }

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: user,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"User retrieved successfully"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      res.status(<span class="hljs-number">500</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal server error"</span>,
        <span class="hljs-attr">message</span>: error.message,
      });
    }
  }

  <span class="hljs-comment">// POST /api/users</span>
  <span class="hljs-keyword">async</span> createUser(req, res) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.userService.createUser(req.body);

      res.status(<span class="hljs-number">201</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: user,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"User created successfully"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (error.message.includes(<span class="hljs-string">"already exists"</span>)) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">409</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Conflict"</span>,
          <span class="hljs-attr">message</span>: error.message,
        });
      }

      <span class="hljs-keyword">if</span> (error.message.includes(<span class="hljs-string">"Validation failed"</span>)) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">422</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Validation error"</span>,
          <span class="hljs-attr">message</span>: error.message,
        });
      }

      res.status(<span class="hljs-number">500</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal server error"</span>,
        <span class="hljs-attr">message</span>: error.message,
      });
    }
  }

  <span class="hljs-comment">// PUT /api/users/:id</span>
  <span class="hljs-keyword">async</span> updateUser(req, res) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.userService.updateUser(req.params.id, req.body);

      <span class="hljs-keyword">if</span> (!user) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"User not found"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">`User with ID <span class="hljs-subst">${req.params.id}</span> does not exist`</span>,
        });
      }

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: user,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"User updated successfully"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (error.message.includes(<span class="hljs-string">"already exists"</span>)) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">409</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Conflict"</span>,
          <span class="hljs-attr">message</span>: error.message,
        });
      }

      <span class="hljs-keyword">if</span> (error.message.includes(<span class="hljs-string">"Validation failed"</span>)) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">422</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Validation error"</span>,
          <span class="hljs-attr">message</span>: error.message,
        });
      }

      res.status(<span class="hljs-number">500</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal server error"</span>,
        <span class="hljs-attr">message</span>: error.message,
      });
    }
  }

  <span class="hljs-comment">// PATCH /api/users/:id</span>
  <span class="hljs-keyword">async</span> patchUser(req, res) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.userService.updateUser(req.params.id, req.body);

      <span class="hljs-keyword">if</span> (!user) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"User not found"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">`User with ID <span class="hljs-subst">${req.params.id}</span> does not exist`</span>,
        });
      }

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: user,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"User updated successfully"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (error.message.includes(<span class="hljs-string">"already exists"</span>)) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">409</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Conflict"</span>,
          <span class="hljs-attr">message</span>: error.message,
        });
      }

      <span class="hljs-keyword">if</span> (error.message.includes(<span class="hljs-string">"Validation failed"</span>)) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">422</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Validation error"</span>,
          <span class="hljs-attr">message</span>: error.message,
        });
      }

      res.status(<span class="hljs-number">500</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal server error"</span>,
        <span class="hljs-attr">message</span>: error.message,
      });
    }
  }

  <span class="hljs-comment">// DELETE /api/users/:id</span>
  <span class="hljs-keyword">async</span> deleteUser(req, res) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.userService.deleteUser(req.params.id);

      <span class="hljs-keyword">if</span> (!user) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"User not found"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">`User with ID <span class="hljs-subst">${req.params.id}</span> does not exist`</span>,
        });
      }

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: user,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"User deleted successfully"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      res.status(<span class="hljs-number">500</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal server error"</span>,
        <span class="hljs-attr">message</span>: error.message,
      });
    }
  }

  <span class="hljs-comment">// PATCH /api/users/:id/deactivate</span>
  <span class="hljs-keyword">async</span> deactivateUser(req, res) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.userService.deactivateUser(req.params.id);

      <span class="hljs-keyword">if</span> (!user) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"User not found"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">`User with ID <span class="hljs-subst">${req.params.id}</span> does not exist`</span>,
        });
      }

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: user,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"User deactivated successfully"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      res.status(<span class="hljs-number">500</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal server error"</span>,
        <span class="hljs-attr">message</span>: error.message,
      });
    }
  }
}

<span class="hljs-built_in">module</span>.exports = UserController;
</div></code></pre>
<h3 id="restful-routes-implementation">RESTful Routes Implementation</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// routes/users.js - User Routes</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> UserController = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../controllers/UserController"</span>);
<span class="hljs-keyword">const</span> router = express.Router();

<span class="hljs-keyword">const</span> userController = <span class="hljs-keyword">new</span> UserController();

<span class="hljs-comment">// Middleware for request logging</span>
router.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span> - <span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.originalUrl}</span>`</span>);
  next();
});

<span class="hljs-comment">// Validation middleware</span>
<span class="hljs-keyword">const</span> validateUserInput = <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { method } = req;
  <span class="hljs-keyword">const</span> { body } = req;

  <span class="hljs-keyword">if</span> (method === <span class="hljs-string">"POST"</span>) {
    <span class="hljs-keyword">const</span> required = [<span class="hljs-string">"username"</span>, <span class="hljs-string">"email"</span>, <span class="hljs-string">"firstName"</span>, <span class="hljs-string">"lastName"</span>];
    <span class="hljs-keyword">const</span> missing = required.filter(<span class="hljs-function">(<span class="hljs-params">field</span>) =&gt;</span> !body[field]);

    <span class="hljs-keyword">if</span> (missing.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Bad Request"</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">`Missing required fields: <span class="hljs-subst">${missing.join(<span class="hljs-string">", "</span>)}</span>`</span>,
      });
    }
  }

  next();
};

<span class="hljs-comment">// Routes following REST conventions</span>

<span class="hljs-comment">// GET /api/users - Get all users</span>
router.get(<span class="hljs-string">"/"</span>, userController.getUsers.bind(userController));

<span class="hljs-comment">// GET /api/users/:id - Get specific user</span>
router.get(<span class="hljs-string">"/:id"</span>, userController.getUserById.bind(userController));

<span class="hljs-comment">// POST /api/users - Create new user</span>
router.post(
  <span class="hljs-string">"/"</span>,
  validateUserInput,
  userController.createUser.bind(userController)
);

<span class="hljs-comment">// PUT /api/users/:id - Update entire user</span>
router.put(
  <span class="hljs-string">"/:id"</span>,
  validateUserInput,
  userController.updateUser.bind(userController)
);

<span class="hljs-comment">// PATCH /api/users/:id - Partial update</span>
router.patch(<span class="hljs-string">"/:id"</span>, userController.patchUser.bind(userController));

<span class="hljs-comment">// DELETE /api/users/:id - Delete user</span>
router.delete(<span class="hljs-string">"/:id"</span>, userController.deleteUser.bind(userController));

<span class="hljs-comment">// PATCH /api/users/:id/deactivate - Deactivate user (custom action)</span>
router.patch(
  <span class="hljs-string">"/:id/deactivate"</span>,
  userController.deactivateUser.bind(userController)
);

<span class="hljs-comment">// OPTIONS /api/users - Get allowed methods</span>
router.options(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  res.set({
    <span class="hljs-attr">Allow</span>: <span class="hljs-string">"GET, POST, OPTIONS"</span>,
    <span class="hljs-string">"Access-Control-Allow-Methods"</span>: <span class="hljs-string">"GET, POST, OPTIONS"</span>,
  });
  res.status(<span class="hljs-number">200</span>).end();
});

router.options(<span class="hljs-string">"/:id"</span>, (req, res) =&gt; {
  res.set({
    <span class="hljs-attr">Allow</span>: <span class="hljs-string">"GET, PUT, PATCH, DELETE, OPTIONS"</span>,
    <span class="hljs-string">"Access-Control-Allow-Methods"</span>: <span class="hljs-string">"GET, PUT, PATCH, DELETE, OPTIONS"</span>,
  });
  res.status(<span class="hljs-number">200</span>).end();
});

<span class="hljs-built_in">module</span>.exports = router;
</div></code></pre>
<h3 id="complete-restful-api-application">Complete RESTful API Application</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// app.js - Main Application</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">"cors"</span>);
<span class="hljs-keyword">const</span> helmet = <span class="hljs-built_in">require</span>(<span class="hljs-string">"helmet"</span>);
<span class="hljs-keyword">const</span> morgan = <span class="hljs-built_in">require</span>(<span class="hljs-string">"morgan"</span>);
<span class="hljs-keyword">const</span> rateLimit = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express-rate-limit"</span>);

<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Security middleware</span>
app.use(helmet());
app.use(
  cors({
    <span class="hljs-attr">origin</span>: process.env.ALLOWED_ORIGINS?.split(<span class="hljs-string">","</span>) || [
      <span class="hljs-string">"http://localhost:3000"</span>,
    ],
    <span class="hljs-attr">credentials</span>: <span class="hljs-literal">true</span>,
  })
);

<span class="hljs-comment">// Rate limiting</span>
<span class="hljs-keyword">const</span> limiter = rateLimit({
  <span class="hljs-attr">windowMs</span>: <span class="hljs-number">15</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 15 minutes</span>
  <span class="hljs-attr">max</span>: <span class="hljs-number">100</span>, <span class="hljs-comment">// limit each IP to 100 requests per windowMs</span>
  <span class="hljs-attr">message</span>: {
    <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">error</span>: <span class="hljs-string">"Too many requests"</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Rate limit exceeded. Please try again later."</span>,
  },
});
app.use(<span class="hljs-string">"/api/"</span>, limiter);

<span class="hljs-comment">// Logging</span>
app.use(morgan(<span class="hljs-string">"combined"</span>));

<span class="hljs-comment">// Body parsing</span>
app.use(express.json({ <span class="hljs-attr">limit</span>: <span class="hljs-string">"10mb"</span> }));
app.use(express.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">limit</span>: <span class="hljs-string">"10mb"</span> }));

<span class="hljs-comment">// API versioning</span>
<span class="hljs-keyword">const</span> v1Router = express.Router();

<span class="hljs-comment">// Import route modules</span>
<span class="hljs-keyword">const</span> userRoutes = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./routes/users"</span>);
<span class="hljs-keyword">const</span> postRoutes = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./routes/posts"</span>);
<span class="hljs-keyword">const</span> categoryRoutes = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./routes/categories"</span>);

<span class="hljs-comment">// Mount routes</span>
v1Router.use(<span class="hljs-string">"/users"</span>, userRoutes);
v1Router.use(<span class="hljs-string">"/posts"</span>, postRoutes);
v1Router.use(<span class="hljs-string">"/categories"</span>, categoryRoutes);

<span class="hljs-comment">// API info endpoint</span>
v1Router.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"RESTful API v1"</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
    <span class="hljs-attr">endpoints</span>: {
      <span class="hljs-attr">users</span>: <span class="hljs-string">"/api/v1/users"</span>,
      <span class="hljs-attr">posts</span>: <span class="hljs-string">"/api/v1/posts"</span>,
      <span class="hljs-attr">categories</span>: <span class="hljs-string">"/api/v1/categories"</span>,
    },
    <span class="hljs-attr">documentation</span>: <span class="hljs-string">"/api/v1/docs"</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
  });
});

<span class="hljs-comment">// API documentation endpoint</span>
v1Router.get(<span class="hljs-string">"/docs"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">documentation</span>: {
      <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
      <span class="hljs-attr">baseUrl</span>: <span class="hljs-string">"/api/v1"</span>,
      <span class="hljs-attr">authentication</span>: <span class="hljs-string">"Bearer token required for protected endpoints"</span>,
      <span class="hljs-attr">rateLimit</span>: <span class="hljs-string">"100 requests per 15 minutes per IP"</span>,
      <span class="hljs-attr">endpoints</span>: {
        <span class="hljs-attr">users</span>: {
          <span class="hljs-string">"GET /users"</span>: {
            <span class="hljs-attr">description</span>: <span class="hljs-string">"Get all users"</span>,
            <span class="hljs-attr">parameters</span>: {
              <span class="hljs-attr">page</span>: <span class="hljs-string">"Page number (default: 1)"</span>,
              <span class="hljs-attr">limit</span>: <span class="hljs-string">"Items per page (default: 10)"</span>,
              <span class="hljs-attr">sortBy</span>: <span class="hljs-string">"Sort field (default: createdAt)"</span>,
              <span class="hljs-attr">sortOrder</span>: <span class="hljs-string">"Sort order: asc|desc (default: desc)"</span>,
              <span class="hljs-attr">role</span>: <span class="hljs-string">"Filter by role"</span>,
              <span class="hljs-attr">active</span>: <span class="hljs-string">"Filter by active status: true|false"</span>,
              <span class="hljs-attr">search</span>: <span class="hljs-string">"Search in username, email, firstName, lastName"</span>,
            },
            <span class="hljs-attr">response</span>: <span class="hljs-string">"200 OK with users array and pagination info"</span>,
          },
          <span class="hljs-string">"GET /users/:id"</span>: {
            <span class="hljs-attr">description</span>: <span class="hljs-string">"Get user by ID"</span>,
            <span class="hljs-attr">parameters</span>: { <span class="hljs-attr">id</span>: <span class="hljs-string">"User ID"</span> },
            <span class="hljs-attr">response</span>: <span class="hljs-string">"200 OK with user object or 404 Not Found"</span>,
          },
          <span class="hljs-string">"POST /users"</span>: {
            <span class="hljs-attr">description</span>: <span class="hljs-string">"Create new user"</span>,
            <span class="hljs-attr">body</span>: {
              <span class="hljs-attr">username</span>: <span class="hljs-string">"string (required)"</span>,
              <span class="hljs-attr">email</span>: <span class="hljs-string">"string (required)"</span>,
              <span class="hljs-attr">firstName</span>: <span class="hljs-string">"string (required)"</span>,
              <span class="hljs-attr">lastName</span>: <span class="hljs-string">"string (required)"</span>,
              <span class="hljs-attr">role</span>: <span class="hljs-string">"string (optional, default: user)"</span>,
            },
            <span class="hljs-attr">response</span>: <span class="hljs-string">"201 Created with user object"</span>,
          },
          <span class="hljs-string">"PUT /users/:id"</span>: {
            <span class="hljs-attr">description</span>: <span class="hljs-string">"Update entire user"</span>,
            <span class="hljs-attr">parameters</span>: { <span class="hljs-attr">id</span>: <span class="hljs-string">"User ID"</span> },
            <span class="hljs-attr">body</span>: <span class="hljs-string">"Complete user object"</span>,
            <span class="hljs-attr">response</span>: <span class="hljs-string">"200 OK with updated user or 404 Not Found"</span>,
          },
          <span class="hljs-string">"PATCH /users/:id"</span>: {
            <span class="hljs-attr">description</span>: <span class="hljs-string">"Partial user update"</span>,
            <span class="hljs-attr">parameters</span>: { <span class="hljs-attr">id</span>: <span class="hljs-string">"User ID"</span> },
            <span class="hljs-attr">body</span>: <span class="hljs-string">"Partial user object"</span>,
            <span class="hljs-attr">response</span>: <span class="hljs-string">"200 OK with updated user or 404 Not Found"</span>,
          },
          <span class="hljs-string">"DELETE /users/:id"</span>: {
            <span class="hljs-attr">description</span>: <span class="hljs-string">"Delete user"</span>,
            <span class="hljs-attr">parameters</span>: { <span class="hljs-attr">id</span>: <span class="hljs-string">"User ID"</span> },
            <span class="hljs-attr">response</span>: <span class="hljs-string">"200 OK with deleted user or 404 Not Found"</span>,
          },
        },
      },
      <span class="hljs-attr">statusCodes</span>: {
        <span class="hljs-number">200</span>: <span class="hljs-string">"OK - Request successful"</span>,
        <span class="hljs-number">201</span>: <span class="hljs-string">"Created - Resource created successfully"</span>,
        <span class="hljs-number">400</span>: <span class="hljs-string">"Bad Request - Invalid request syntax"</span>,
        <span class="hljs-number">401</span>: <span class="hljs-string">"Unauthorized - Authentication required"</span>,
        <span class="hljs-number">403</span>: <span class="hljs-string">"Forbidden - Access denied"</span>,
        <span class="hljs-number">404</span>: <span class="hljs-string">"Not Found - Resource not found"</span>,
        <span class="hljs-number">409</span>: <span class="hljs-string">"Conflict - Request conflicts with current state"</span>,
        <span class="hljs-number">422</span>: <span class="hljs-string">"Unprocessable Entity - Validation errors"</span>,
        <span class="hljs-number">429</span>: <span class="hljs-string">"Too Many Requests - Rate limit exceeded"</span>,
        <span class="hljs-number">500</span>: <span class="hljs-string">"Internal Server Error - Server error"</span>,
      },
    },
  });
});

<span class="hljs-comment">// Mount API version</span>
app.use(<span class="hljs-string">"/api/v1"</span>, v1Router);

<span class="hljs-comment">// Root endpoint</span>
app.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"RESTful API Server"</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
    <span class="hljs-attr">api</span>: {
      <span class="hljs-attr">v1</span>: <span class="hljs-string">"/api/v1"</span>,
      <span class="hljs-attr">documentation</span>: <span class="hljs-string">"/api/v1/docs"</span>,
    },
    <span class="hljs-attr">status</span>: <span class="hljs-string">"healthy"</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
  });
});

<span class="hljs-comment">// Health check endpoint</span>
app.get(<span class="hljs-string">"/health"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">status</span>: <span class="hljs-string">"healthy"</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
    <span class="hljs-attr">uptime</span>: process.uptime(),
    <span class="hljs-attr">memory</span>: process.memoryUsage(),
    <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
  });
});

<span class="hljs-comment">// 404 handler</span>
app.use(<span class="hljs-string">"*"</span>, (req, res) =&gt; {
  res.status(<span class="hljs-number">404</span>).json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">error</span>: <span class="hljs-string">"Not Found"</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">`Route <span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.originalUrl}</span> not found`</span>,
    <span class="hljs-attr">availableEndpoints</span>: {
      <span class="hljs-attr">api</span>: <span class="hljs-string">"/api/v1"</span>,
      <span class="hljs-attr">documentation</span>: <span class="hljs-string">"/api/v1/docs"</span>,
      <span class="hljs-attr">health</span>: <span class="hljs-string">"/health"</span>,
    },
  });
});

<span class="hljs-comment">// Global error handler</span>
app.use(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Global error handler:"</span>, err);

  <span class="hljs-comment">// Handle specific error types</span>
  <span class="hljs-keyword">if</span> (err.type === <span class="hljs-string">"entity.parse.failed"</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Bad Request"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Invalid JSON in request body"</span>,
    });
  }

  <span class="hljs-keyword">if</span> (err.type === <span class="hljs-string">"entity.too.large"</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">413</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Payload Too Large"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Request body exceeds size limit"</span>,
    });
  }

  res.status(err.status || <span class="hljs-number">500</span>).json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">error</span>: err.status === <span class="hljs-number">500</span> ? <span class="hljs-string">"Internal Server Error"</span> : err.name || <span class="hljs-string">"Error"</span>,
    <span class="hljs-attr">message</span>:
      process.env.NODE_ENV === <span class="hljs-string">"production"</span>
        ? <span class="hljs-string">"An error occurred while processing your request"</span>
        : err.message,
    ...(process.env.NODE_ENV !== <span class="hljs-string">"production"</span> &amp;&amp; { <span class="hljs-attr">stack</span>: err.stack }),
  });
});

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
app.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🚀 RESTful API Server running on port <span class="hljs-subst">${PORT}</span>`</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`📚 API Documentation: http://localhost:<span class="hljs-subst">${PORT}</span>/api/v1/docs`</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🏥 Health Check: http://localhost:<span class="hljs-subst">${PORT}</span>/health`</span>);
});

<span class="hljs-built_in">module</span>.exports = app;
</div></code></pre>
<h2 id="real-world-use-case">Real-World Use Case</h2>
<h3 id="e-commerce-product-api">E-commerce Product API</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// models/Product.js</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Product</span> </span>{
  <span class="hljs-keyword">constructor</span>(data) {
    <span class="hljs-keyword">this</span>.id = data.id;
    <span class="hljs-keyword">this</span>.name = data.name;
    <span class="hljs-keyword">this</span>.description = data.description;
    <span class="hljs-keyword">this</span>.price = <span class="hljs-built_in">parseFloat</span>(data.price);
    <span class="hljs-keyword">this</span>.category = data.category;
    <span class="hljs-keyword">this</span>.brand = data.brand;
    <span class="hljs-keyword">this</span>.sku = data.sku;
    <span class="hljs-keyword">this</span>.stock = <span class="hljs-built_in">parseInt</span>(data.stock) || <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>.images = data.images || [];
    <span class="hljs-keyword">this</span>.specifications = data.specifications || {};
    <span class="hljs-keyword">this</span>.tags = data.tags || [];
    <span class="hljs-keyword">this</span>.active = data.active !== <span class="hljs-literal">undefined</span> ? data.active : <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.featured = data.featured || <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.rating = data.rating || <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>.reviewCount = data.reviewCount || <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>.createdAt = data.createdAt || <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
    <span class="hljs-keyword">this</span>.updatedAt = data.updatedAt || <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
  }

  validate() {
    <span class="hljs-keyword">const</span> errors = [];

    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.name || <span class="hljs-keyword">this</span>.name.length &lt; <span class="hljs-number">3</span>) {
      errors.push(<span class="hljs-string">"Product name must be at least 3 characters"</span>);
    }

    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.description || <span class="hljs-keyword">this</span>.description.length &lt; <span class="hljs-number">10</span>) {
      errors.push(<span class="hljs-string">"Description must be at least 10 characters"</span>);
    }

    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.price || <span class="hljs-keyword">this</span>.price &lt;= <span class="hljs-number">0</span>) {
      errors.push(<span class="hljs-string">"Price must be greater than 0"</span>);
    }

    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.category) {
      errors.push(<span class="hljs-string">"Category is required"</span>);
    }

    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.sku) {
      errors.push(<span class="hljs-string">"SKU is required"</span>);
    }

    <span class="hljs-keyword">return</span> errors;
  }

  toPublic() {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">id</span>: <span class="hljs-keyword">this</span>.id,
      <span class="hljs-attr">name</span>: <span class="hljs-keyword">this</span>.name,
      <span class="hljs-attr">description</span>: <span class="hljs-keyword">this</span>.description,
      <span class="hljs-attr">price</span>: <span class="hljs-keyword">this</span>.price,
      <span class="hljs-attr">category</span>: <span class="hljs-keyword">this</span>.category,
      <span class="hljs-attr">brand</span>: <span class="hljs-keyword">this</span>.brand,
      <span class="hljs-attr">sku</span>: <span class="hljs-keyword">this</span>.sku,
      <span class="hljs-attr">stock</span>: <span class="hljs-keyword">this</span>.stock,
      <span class="hljs-attr">images</span>: <span class="hljs-keyword">this</span>.images,
      <span class="hljs-attr">specifications</span>: <span class="hljs-keyword">this</span>.specifications,
      <span class="hljs-attr">tags</span>: <span class="hljs-keyword">this</span>.tags,
      <span class="hljs-attr">active</span>: <span class="hljs-keyword">this</span>.active,
      <span class="hljs-attr">featured</span>: <span class="hljs-keyword">this</span>.featured,
      <span class="hljs-attr">rating</span>: <span class="hljs-keyword">this</span>.rating,
      <span class="hljs-attr">reviewCount</span>: <span class="hljs-keyword">this</span>.reviewCount,
      <span class="hljs-attr">availability</span>: <span class="hljs-keyword">this</span>.stock &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">"in-stock"</span> : <span class="hljs-string">"out-of-stock"</span>,
      <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">this</span>.createdAt,
      <span class="hljs-attr">updatedAt</span>: <span class="hljs-keyword">this</span>.updatedAt,
    };
  }
}

<span class="hljs-built_in">module</span>.exports = Product;
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">// routes/products.js - Product API Routes</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> Product = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../models/Product"</span>);
<span class="hljs-keyword">const</span> router = express.Router();

<span class="hljs-comment">// Sample product data</span>
<span class="hljs-keyword">let</span> products = [
  <span class="hljs-keyword">new</span> Product({
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'MacBook Pro 16"'</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"Powerful laptop for professionals with M2 Pro chip"</span>,
    <span class="hljs-attr">price</span>: <span class="hljs-number">2499.99</span>,
    <span class="hljs-attr">category</span>: <span class="hljs-string">"Electronics"</span>,
    <span class="hljs-attr">brand</span>: <span class="hljs-string">"Apple"</span>,
    <span class="hljs-attr">sku</span>: <span class="hljs-string">"MBP16-M2PRO-512"</span>,
    <span class="hljs-attr">stock</span>: <span class="hljs-number">15</span>,
    <span class="hljs-attr">images</span>: [<span class="hljs-string">"macbook-1.jpg"</span>, <span class="hljs-string">"macbook-2.jpg"</span>],
    <span class="hljs-attr">specifications</span>: {
      <span class="hljs-attr">processor</span>: <span class="hljs-string">"M2 Pro"</span>,
      <span class="hljs-attr">memory</span>: <span class="hljs-string">"16GB"</span>,
      <span class="hljs-attr">storage</span>: <span class="hljs-string">"512GB SSD"</span>,
      <span class="hljs-attr">display</span>: <span class="hljs-string">"16-inch Retina"</span>,
    },
    <span class="hljs-attr">tags</span>: [<span class="hljs-string">"laptop"</span>, <span class="hljs-string">"apple"</span>, <span class="hljs-string">"professional"</span>],
    <span class="hljs-attr">featured</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">rating</span>: <span class="hljs-number">4.8</span>,
    <span class="hljs-attr">reviewCount</span>: <span class="hljs-number">127</span>,
  }),
  <span class="hljs-keyword">new</span> Product({
    <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">"iPhone 15 Pro"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"Latest iPhone with titanium design and A17 Pro chip"</span>,
    <span class="hljs-attr">price</span>: <span class="hljs-number">999.99</span>,
    <span class="hljs-attr">category</span>: <span class="hljs-string">"Electronics"</span>,
    <span class="hljs-attr">brand</span>: <span class="hljs-string">"Apple"</span>,
    <span class="hljs-attr">sku</span>: <span class="hljs-string">"IP15PRO-128-TIT"</span>,
    <span class="hljs-attr">stock</span>: <span class="hljs-number">25</span>,
    <span class="hljs-attr">images</span>: [<span class="hljs-string">"iphone-1.jpg"</span>, <span class="hljs-string">"iphone-2.jpg"</span>],
    <span class="hljs-attr">specifications</span>: {
      <span class="hljs-attr">processor</span>: <span class="hljs-string">"A17 Pro"</span>,
      <span class="hljs-attr">storage</span>: <span class="hljs-string">"128GB"</span>,
      <span class="hljs-attr">camera</span>: <span class="hljs-string">"48MP Pro camera system"</span>,
      <span class="hljs-attr">display</span>: <span class="hljs-string">"6.1-inch Super Retina XDR"</span>,
    },
    <span class="hljs-attr">tags</span>: [<span class="hljs-string">"smartphone"</span>, <span class="hljs-string">"apple"</span>, <span class="hljs-string">"pro"</span>],
    <span class="hljs-attr">featured</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">rating</span>: <span class="hljs-number">4.9</span>,
    <span class="hljs-attr">reviewCount</span>: <span class="hljs-number">89</span>,
  }),
];
<span class="hljs-keyword">let</span> nextId = <span class="hljs-number">3</span>;

<span class="hljs-comment">// GET /api/products - Get all products with advanced filtering</span>
router.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> {
      page = <span class="hljs-number">1</span>,
      limit = <span class="hljs-number">10</span>,
      sortBy = <span class="hljs-string">"createdAt"</span>,
      sortOrder = <span class="hljs-string">"desc"</span>,
      category,
      brand,
      minPrice,
      maxPrice,
      inStock,
      featured,
      search,
      tags,
    } = req.query;

    <span class="hljs-keyword">let</span> filteredProducts = products.filter(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.active);

    <span class="hljs-comment">// Apply filters</span>
    <span class="hljs-keyword">if</span> (category) {
      filteredProducts = filteredProducts.filter(
        <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.category.toLowerCase() === category.toLowerCase()
      );
    }

    <span class="hljs-keyword">if</span> (brand) {
      filteredProducts = filteredProducts.filter(
        <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.brand.toLowerCase() === brand.toLowerCase()
      );
    }

    <span class="hljs-keyword">if</span> (minPrice) {
      filteredProducts = filteredProducts.filter(
        <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.price &gt;= <span class="hljs-built_in">parseFloat</span>(minPrice)
      );
    }

    <span class="hljs-keyword">if</span> (maxPrice) {
      filteredProducts = filteredProducts.filter(
        <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.price &lt;= <span class="hljs-built_in">parseFloat</span>(maxPrice)
      );
    }

    <span class="hljs-keyword">if</span> (inStock === <span class="hljs-string">"true"</span>) {
      filteredProducts = filteredProducts.filter(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.stock &gt; <span class="hljs-number">0</span>);
    }

    <span class="hljs-keyword">if</span> (featured === <span class="hljs-string">"true"</span>) {
      filteredProducts = filteredProducts.filter(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.featured);
    }

    <span class="hljs-keyword">if</span> (search) {
      <span class="hljs-keyword">const</span> searchLower = search.toLowerCase();
      filteredProducts = filteredProducts.filter(
        <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span>
          p.name.toLowerCase().includes(searchLower) ||
          p.description.toLowerCase().includes(searchLower) ||
          p.brand.toLowerCase().includes(searchLower) ||
          p.tags.some(<span class="hljs-function">(<span class="hljs-params">tag</span>) =&gt;</span> tag.toLowerCase().includes(searchLower))
      );
    }

    <span class="hljs-keyword">if</span> (tags) {
      <span class="hljs-keyword">const</span> tagList = tags.split(<span class="hljs-string">","</span>).map(<span class="hljs-function">(<span class="hljs-params">tag</span>) =&gt;</span> tag.trim().toLowerCase());
      filteredProducts = filteredProducts.filter(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span>
        tagList.some(<span class="hljs-function">(<span class="hljs-params">tag</span>) =&gt;</span> p.tags.map(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.toLowerCase()).includes(tag))
      );
    }

    <span class="hljs-comment">// Apply sorting</span>
    filteredProducts.sort(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> {
      <span class="hljs-keyword">let</span> aVal = a[sortBy];
      <span class="hljs-keyword">let</span> bVal = b[sortBy];

      <span class="hljs-keyword">if</span> (sortBy === <span class="hljs-string">"createdAt"</span> || sortBy === <span class="hljs-string">"updatedAt"</span>) {
        aVal = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(aVal);
        bVal = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(bVal);
      }

      <span class="hljs-keyword">if</span> (sortOrder === <span class="hljs-string">"desc"</span>) {
        <span class="hljs-keyword">return</span> bVal &gt; aVal ? <span class="hljs-number">1</span> : <span class="hljs-number">-1</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> aVal &gt; bVal ? <span class="hljs-number">1</span> : <span class="hljs-number">-1</span>;
      }
    });

    <span class="hljs-comment">// Apply pagination</span>
    <span class="hljs-keyword">const</span> total = filteredProducts.length;
    <span class="hljs-keyword">const</span> totalPages = <span class="hljs-built_in">Math</span>.ceil(total / limit);
    <span class="hljs-keyword">const</span> offset = (page - <span class="hljs-number">1</span>) * limit;
    <span class="hljs-keyword">const</span> paginatedProducts = filteredProducts.slice(
      offset,
      offset + <span class="hljs-built_in">parseInt</span>(limit)
    );

    <span class="hljs-comment">// Get filter options for frontend</span>
    <span class="hljs-keyword">const</span> filterOptions = {
      <span class="hljs-attr">categories</span>: [...new <span class="hljs-built_in">Set</span>(products.map(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.category))],
      <span class="hljs-attr">brands</span>: [...new <span class="hljs-built_in">Set</span>(products.map(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.brand))],
      <span class="hljs-attr">priceRange</span>: {
        <span class="hljs-attr">min</span>: <span class="hljs-built_in">Math</span>.min(...products.map(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.price)),
        <span class="hljs-attr">max</span>: <span class="hljs-built_in">Math</span>.max(...products.map(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.price)),
      },
      <span class="hljs-attr">tags</span>: [...new <span class="hljs-built_in">Set</span>(products.flatMap(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.tags))],
    };

    res.json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">data</span>: paginatedProducts.map(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.toPublic()),
      <span class="hljs-attr">pagination</span>: {
        <span class="hljs-attr">page</span>: <span class="hljs-built_in">parseInt</span>(page),
        <span class="hljs-attr">limit</span>: <span class="hljs-built_in">parseInt</span>(limit),
        total,
        totalPages,
        <span class="hljs-attr">hasNext</span>: page &lt; totalPages,
        <span class="hljs-attr">hasPrev</span>: page &gt; <span class="hljs-number">1</span>,
      },
      <span class="hljs-attr">filters</span>: {
        <span class="hljs-attr">applied</span>: {
          category,
          brand,
          minPrice,
          maxPrice,
          inStock,
          featured,
          search,
          tags,
        },
        <span class="hljs-attr">available</span>: filterOptions,
      },
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Products retrieved successfully"</span>,
    });
  } <span class="hljs-keyword">catch</span> (error) {
    res.status(<span class="hljs-number">500</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal server error"</span>,
      <span class="hljs-attr">message</span>: error.message,
    });
  }
});

<span class="hljs-comment">// GET /api/products/featured - Get featured products</span>
router.get(<span class="hljs-string">"/featured"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> featuredProducts = products
      .filter(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.featured &amp;&amp; p.active)
      .sort(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> b.rating - a.rating)
      .slice(<span class="hljs-number">0</span>, <span class="hljs-built_in">parseInt</span>(req.query.limit) || <span class="hljs-number">6</span>);

    res.json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">data</span>: featuredProducts.map(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.toPublic()),
      <span class="hljs-attr">count</span>: featuredProducts.length,
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Featured products retrieved successfully"</span>,
    });
  } <span class="hljs-keyword">catch</span> (error) {
    res.status(<span class="hljs-number">500</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal server error"</span>,
      <span class="hljs-attr">message</span>: error.message,
    });
  }
});

<span class="hljs-comment">// GET /api/products/categories - Get all categories</span>
router.get(<span class="hljs-string">"/categories"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> categories = [...new <span class="hljs-built_in">Set</span>(products.map(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.category))];
    <span class="hljs-keyword">const</span> categoryStats = categories.map(<span class="hljs-function">(<span class="hljs-params">category</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> categoryProducts = products.filter(
        <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.category === category &amp;&amp; p.active
      );
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">name</span>: category,
        <span class="hljs-attr">count</span>: categoryProducts.length,
        <span class="hljs-attr">averagePrice</span>:
          categoryProducts.reduce(<span class="hljs-function">(<span class="hljs-params">sum, p</span>) =&gt;</span> sum + p.price, <span class="hljs-number">0</span>) /
          categoryProducts.length,
      };
    });

    res.json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">data</span>: categoryStats,
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Categories retrieved successfully"</span>,
    });
  } <span class="hljs-keyword">catch</span> (error) {
    res.status(<span class="hljs-number">500</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal server error"</span>,
      <span class="hljs-attr">message</span>: error.message,
    });
  }
});

<span class="hljs-comment">// GET /api/products/:id - Get product by ID</span>
router.get(<span class="hljs-string">"/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> product = products.find(
      <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id === <span class="hljs-built_in">parseInt</span>(req.params.id) &amp;&amp; p.active
    );

    <span class="hljs-keyword">if</span> (!product) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Product not found"</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">`Product with ID <span class="hljs-subst">${req.params.id}</span> does not exist`</span>,
      });
    }

    <span class="hljs-comment">// Get related products</span>
    <span class="hljs-keyword">const</span> relatedProducts = products
      .filter(
        <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span>
          p.id !== product.id &amp;&amp; p.category === product.category &amp;&amp; p.active
      )
      .sort(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> b.rating - a.rating)
      .slice(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>);

    res.json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">data</span>: {
        <span class="hljs-attr">product</span>: product.toPublic(),
        <span class="hljs-attr">related</span>: relatedProducts.map(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.toPublic()),
      },
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Product retrieved successfully"</span>,
    });
  } <span class="hljs-keyword">catch</span> (error) {
    res.status(<span class="hljs-number">500</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal server error"</span>,
      <span class="hljs-attr">message</span>: error.message,
    });
  }
});

<span class="hljs-comment">// POST /api/products - Create new product</span>
router.post(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// Check if SKU already exists</span>
    <span class="hljs-keyword">const</span> existingProduct = products.find(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.sku === req.body.sku);
    <span class="hljs-keyword">if</span> (existingProduct) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">409</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Conflict"</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Product with this SKU already exists"</span>,
      });
    }

    <span class="hljs-keyword">const</span> product = <span class="hljs-keyword">new</span> Product({
      ...req.body,
      <span class="hljs-attr">id</span>: nextId++,
    });

    <span class="hljs-keyword">const</span> validationErrors = product.validate();
    <span class="hljs-keyword">if</span> (validationErrors.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">422</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Validation error"</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">`Validation failed: <span class="hljs-subst">${validationErrors.join(<span class="hljs-string">", "</span>)}</span>`</span>,
      });
    }

    products.push(product);

    res.status(<span class="hljs-number">201</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">data</span>: product.toPublic(),
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Product created successfully"</span>,
    });
  } <span class="hljs-keyword">catch</span> (error) {
    res.status(<span class="hljs-number">500</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal server error"</span>,
      <span class="hljs-attr">message</span>: error.message,
    });
  }
});

<span class="hljs-comment">// PUT /api/products/:id - Update entire product</span>
router.put(<span class="hljs-string">"/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> productIndex = products.findIndex(
      <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id === <span class="hljs-built_in">parseInt</span>(req.params.id)
    );

    <span class="hljs-keyword">if</span> (productIndex === <span class="hljs-number">-1</span>) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Product not found"</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">`Product with ID <span class="hljs-subst">${req.params.id}</span> does not exist`</span>,
      });
    }

    <span class="hljs-comment">// Check SKU conflict</span>
    <span class="hljs-keyword">if</span> (req.body.sku) {
      <span class="hljs-keyword">const</span> conflictProduct = products.find(
        <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id !== <span class="hljs-built_in">parseInt</span>(req.params.id) &amp;&amp; p.sku === req.body.sku
      );
      <span class="hljs-keyword">if</span> (conflictProduct) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">409</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Conflict"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">"Product with this SKU already exists"</span>,
        });
      }
    }

    <span class="hljs-keyword">const</span> updatedProduct = <span class="hljs-keyword">new</span> Product({
      ...req.body,
      <span class="hljs-attr">id</span>: <span class="hljs-built_in">parseInt</span>(req.params.id),
      <span class="hljs-attr">updatedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
    });

    <span class="hljs-keyword">const</span> validationErrors = updatedProduct.validate();
    <span class="hljs-keyword">if</span> (validationErrors.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">422</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Validation error"</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">`Validation failed: <span class="hljs-subst">${validationErrors.join(<span class="hljs-string">", "</span>)}</span>`</span>,
      });
    }

    products[productIndex] = updatedProduct;

    res.json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">data</span>: updatedProduct.toPublic(),
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Product updated successfully"</span>,
    });
  } <span class="hljs-keyword">catch</span> (error) {
    res.status(<span class="hljs-number">500</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal server error"</span>,
      <span class="hljs-attr">message</span>: error.message,
    });
  }
});

<span class="hljs-comment">// PATCH /api/products/:id/stock - Update stock only</span>
router.patch(<span class="hljs-string">"/:id/stock"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> productIndex = products.findIndex(
      <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id === <span class="hljs-built_in">parseInt</span>(req.params.id)
    );

    <span class="hljs-keyword">if</span> (productIndex === <span class="hljs-number">-1</span>) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Product not found"</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">`Product with ID <span class="hljs-subst">${req.params.id}</span> does not exist`</span>,
      });
    }

    <span class="hljs-keyword">const</span> { stock } = req.body;

    <span class="hljs-keyword">if</span> (stock === <span class="hljs-literal">undefined</span> || <span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">parseInt</span>(stock)) || <span class="hljs-built_in">parseInt</span>(stock) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Bad Request"</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Valid stock quantity (&gt;= 0) is required"</span>,
      });
    }

    products[productIndex].stock = <span class="hljs-built_in">parseInt</span>(stock);
    products[productIndex].updatedAt = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();

    res.json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">data</span>: products[productIndex].toPublic(),
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Product stock updated successfully"</span>,
    });
  } <span class="hljs-keyword">catch</span> (error) {
    res.status(<span class="hljs-number">500</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal server error"</span>,
      <span class="hljs-attr">message</span>: error.message,
    });
  }
});

<span class="hljs-comment">// DELETE /api/products/:id - Delete product (soft delete)</span>
router.delete(<span class="hljs-string">"/:id"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> productIndex = products.findIndex(
      <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.id === <span class="hljs-built_in">parseInt</span>(req.params.id)
    );

    <span class="hljs-keyword">if</span> (productIndex === <span class="hljs-number">-1</span>) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Product not found"</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">`Product with ID <span class="hljs-subst">${req.params.id}</span> does not exist`</span>,
      });
    }

    <span class="hljs-comment">// Soft delete - mark as inactive</span>
    products[productIndex].active = <span class="hljs-literal">false</span>;
    products[productIndex].updatedAt = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();

    res.json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">data</span>: products[productIndex].toPublic(),
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Product deleted successfully"</span>,
    });
  } <span class="hljs-keyword">catch</span> (error) {
    res.status(<span class="hljs-number">500</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal server error"</span>,
      <span class="hljs-attr">message</span>: error.message,
    });
  }
});

<span class="hljs-built_in">module</span>.exports = router;
</div></code></pre>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-use-proper-http-methods">1. Use Proper HTTP Methods</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// ✅ Correct usage</span>
GET / api / users; <span class="hljs-comment">// Get all users</span>
GET / api / users / <span class="hljs-number">123</span>; <span class="hljs-comment">// Get specific user</span>
POST / api / users; <span class="hljs-comment">// Create new user</span>
PUT / api / users / <span class="hljs-number">123</span>; <span class="hljs-comment">// Update entire user</span>
PATCH / api / users / <span class="hljs-number">123</span>; <span class="hljs-comment">// Partial update</span>
DELETE / api / users / <span class="hljs-number">123</span>; <span class="hljs-comment">// Delete user</span>

<span class="hljs-comment">// ❌ Incorrect usage</span>
GET / api / getUsers; <span class="hljs-comment">// Don't use verbs in URLs</span>
POST /
  api /
  users /
  <span class="hljs-keyword">delete</span> (
    <span class="hljs-comment">// Use DELETE method instead</span>
    GET
  ) /
  api /
  users /
  create; <span class="hljs-comment">// Use POST for creation</span>
</div></code></pre>
<h3 id="2-implement-consistent-response-format">2. Implement Consistent Response Format</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Success response format</span>
{
    <span class="hljs-string">"success"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">"data"</span>: { <span class="hljs-comment">/* response data */</span> },
    <span class="hljs-string">"message"</span>: <span class="hljs-string">"Operation completed successfully"</span>,
    <span class="hljs-string">"pagination"</span>: { <span class="hljs-comment">/* pagination info if applicable */</span> }
}

<span class="hljs-comment">// Error response format</span>
{
    <span class="hljs-string">"success"</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-string">"error"</span>: <span class="hljs-string">"Error Type"</span>,
    <span class="hljs-string">"message"</span>: <span class="hljs-string">"Detailed error message"</span>,
    <span class="hljs-string">"details"</span>: { <span class="hljs-comment">/* additional error details */</span> }
}
</div></code></pre>
<h3 id="3-use-appropriate-status-codes">3. Use Appropriate Status Codes</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Success responses</span>
res.status(<span class="hljs-number">200</span>).json(data); <span class="hljs-comment">// OK - successful GET, PUT, PATCH</span>
res.status(<span class="hljs-number">201</span>).json(data); <span class="hljs-comment">// Created - successful POST</span>
res.status(<span class="hljs-number">204</span>).end(); <span class="hljs-comment">// No Content - successful DELETE</span>

<span class="hljs-comment">// Client error responses</span>
res.status(<span class="hljs-number">400</span>).json(error); <span class="hljs-comment">// Bad Request - invalid syntax</span>
res.status(<span class="hljs-number">401</span>).json(error); <span class="hljs-comment">// Unauthorized - authentication required</span>
res.status(<span class="hljs-number">403</span>).json(error); <span class="hljs-comment">// Forbidden - access denied</span>
res.status(<span class="hljs-number">404</span>).json(error); <span class="hljs-comment">// Not Found - resource doesn't exist</span>
res.status(<span class="hljs-number">409</span>).json(error); <span class="hljs-comment">// Conflict - resource already exists</span>
res.status(<span class="hljs-number">422</span>).json(error); <span class="hljs-comment">// Unprocessable Entity - validation errors</span>

<span class="hljs-comment">// Server error responses</span>
res.status(<span class="hljs-number">500</span>).json(error); <span class="hljs-comment">// Internal Server Error</span>
</div></code></pre>
<h3 id="4-implement-proper-error-handling">4. Implement Proper Error Handling</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Async error wrapper</span>
<span class="hljs-keyword">const</span> asyncHandler = <span class="hljs-function">(<span class="hljs-params">fn</span>) =&gt;</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">Promise</span>.resolve(fn(req, res, next)).catch(next);
};

<span class="hljs-comment">// Usage</span>
router.get(
  <span class="hljs-string">"/users"</span>,
  asyncHandler(<span class="hljs-keyword">async</span> (req, res) =&gt; {
    <span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> userService.getAllUsers();
    res.json({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">data</span>: users });
  })
);
</div></code></pre>
<h3 id="5-add-input-validation">5. Add Input Validation</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> { body, validationResult } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express-validator"</span>);

<span class="hljs-keyword">const</span> validateUser = [
  body(<span class="hljs-string">"username"</span>)
    .isLength({ <span class="hljs-attr">min</span>: <span class="hljs-number">3</span> })
    .withMessage(<span class="hljs-string">"Username must be at least 3 characters"</span>),
  body(<span class="hljs-string">"email"</span>).isEmail().withMessage(<span class="hljs-string">"Valid email is required"</span>),
  body(<span class="hljs-string">"firstName"</span>).notEmpty().withMessage(<span class="hljs-string">"First name is required"</span>),
  body(<span class="hljs-string">"lastName"</span>).notEmpty().withMessage(<span class="hljs-string">"Last name is required"</span>),

  (req, res, next) =&gt; {
    <span class="hljs-keyword">const</span> errors = validationResult(req);
    <span class="hljs-keyword">if</span> (!errors.isEmpty()) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">422</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Validation error"</span>,
        <span class="hljs-attr">details</span>: errors.array(),
      });
    }
    next();
  },
];
</div></code></pre>
<h2 id="summary">Summary</h2>
<p>RESTful API design principles provide a foundation for building scalable, maintainable web services:</p>
<p><strong>Core Principles</strong>:</p>
<ul>
<li><strong>Stateless</strong>: Each request is independent</li>
<li><strong>Resource-based</strong>: URLs represent resources, not actions</li>
<li><strong>HTTP methods</strong>: Use appropriate methods for different operations</li>
<li><strong>Status codes</strong>: Return meaningful HTTP status codes</li>
<li><strong>Consistent format</strong>: Standardize request/response structures</li>
</ul>
<p><strong>Best Practices</strong>:</p>
<ul>
<li>Use nouns in URLs, not verbs</li>
<li>Implement proper error handling</li>
<li>Add input validation</li>
<li>Use consistent response formats</li>
<li>Follow HTTP status code conventions</li>
<li>Implement pagination for large datasets</li>
<li>Add filtering and sorting capabilities</li>
</ul>
<p><strong>Benefits</strong>:</p>
<ul>
<li><strong>Predictable</strong>: Follows established conventions</li>
<li><strong>Scalable</strong>: Stateless nature enables horizontal scaling</li>
<li><strong>Cacheable</strong>: Responses can be cached for performance</li>
<li><strong>Maintainable</strong>: Clear structure and separation of concerns</li>
<li><strong>Interoperable</strong>: Works with any HTTP client</li>
</ul>
<p>Mastering RESTful API design is essential for building modern web applications. Next, we'll explore CRUD operations with Express.js in more detail, building upon these REST principles.</p>
<h1 id="crud-operations-with-expressjs">CRUD Operations with Express.js</h1>
<h2 id="overview">Overview</h2>
<p>CRUD (Create, Read, Update, Delete) operations are the fundamental building blocks of any data-driven application. In Express.js, implementing CRUD operations involves creating endpoints that handle HTTP requests to manipulate data resources. This chapter covers how to build comprehensive CRUD APIs with proper validation, error handling, and real-world patterns.</p>
<h2 id="key-concepts">Key Concepts</h2>
<h3 id="crud-operations-mapping">CRUD Operations Mapping</h3>
<p><strong>CRUD to HTTP Methods</strong>:</p>
<ul>
<li><strong>Create</strong>: POST requests to create new resources</li>
<li><strong>Read</strong>: GET requests to retrieve existing resources</li>
<li><strong>Update</strong>: PUT (full update) or PATCH (partial update) requests</li>
<li><strong>Delete</strong>: DELETE requests to remove resources</li>
</ul>
<h3 id="data-persistence-patterns">Data Persistence Patterns</h3>
<p><strong>In-Memory Storage</strong>: Simple arrays/objects for development and testing
<strong>File-Based Storage</strong>: JSON files for lightweight persistence
<strong>Database Integration</strong>: SQL/NoSQL databases for production applications</p>
<h3 id="validation-and-error-handling">Validation and Error Handling</h3>
<p><strong>Input Validation</strong>: Ensuring data integrity before processing
<strong>Business Logic Validation</strong>: Enforcing domain-specific rules
<strong>Error Responses</strong>: Consistent error formatting and appropriate status codes</p>
<h3 id="advanced-crud-features">Advanced CRUD Features</h3>
<p><strong>Filtering</strong>: Query parameters to filter results
<strong>Sorting</strong>: Order results by specific fields
<strong>Pagination</strong>: Handle large datasets efficiently
<strong>Search</strong>: Text-based search across multiple fields
<strong>Bulk Operations</strong>: Handle multiple records in single requests</p>
<h2 id="example-code">Example Code</h2>
<h3 id="basic-crud-implementation">Basic CRUD Implementation</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// models/Task.js - Task Model</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Task</span> </span>{
  <span class="hljs-keyword">constructor</span>(data) {
    <span class="hljs-keyword">this</span>.id = data.id;
    <span class="hljs-keyword">this</span>.title = data.title;
    <span class="hljs-keyword">this</span>.description = data.description || <span class="hljs-string">""</span>;
    <span class="hljs-keyword">this</span>.status = data.status || <span class="hljs-string">"pending"</span>; <span class="hljs-comment">// pending, in-progress, completed</span>
    <span class="hljs-keyword">this</span>.priority = data.priority || <span class="hljs-string">"medium"</span>; <span class="hljs-comment">// low, medium, high, urgent</span>
    <span class="hljs-keyword">this</span>.dueDate = data.dueDate ? <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(data.dueDate) : <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.assignedTo = data.assignedTo || <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.tags = data.tags || [];
    <span class="hljs-keyword">this</span>.createdAt = data.createdAt || <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
    <span class="hljs-keyword">this</span>.updatedAt = data.updatedAt || <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
    <span class="hljs-keyword">this</span>.completedAt = data.completedAt || <span class="hljs-literal">null</span>;
  }

  validate() {
    <span class="hljs-keyword">const</span> errors = [];

    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.title || <span class="hljs-keyword">this</span>.title.trim().length &lt; <span class="hljs-number">3</span>) {
      errors.push(<span class="hljs-string">"Title must be at least 3 characters long"</span>);
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.title &amp;&amp; <span class="hljs-keyword">this</span>.title.length &gt; <span class="hljs-number">100</span>) {
      errors.push(<span class="hljs-string">"Title cannot exceed 100 characters"</span>);
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.description &amp;&amp; <span class="hljs-keyword">this</span>.description.length &gt; <span class="hljs-number">500</span>) {
      errors.push(<span class="hljs-string">"Description cannot exceed 500 characters"</span>);
    }

    <span class="hljs-keyword">const</span> validStatuses = [<span class="hljs-string">"pending"</span>, <span class="hljs-string">"in-progress"</span>, <span class="hljs-string">"completed"</span>];
    <span class="hljs-keyword">if</span> (!validStatuses.includes(<span class="hljs-keyword">this</span>.status)) {
      errors.push(<span class="hljs-string">"Status must be one of: pending, in-progress, completed"</span>);
    }

    <span class="hljs-keyword">const</span> validPriorities = [<span class="hljs-string">"low"</span>, <span class="hljs-string">"medium"</span>, <span class="hljs-string">"high"</span>, <span class="hljs-string">"urgent"</span>];
    <span class="hljs-keyword">if</span> (!validPriorities.includes(<span class="hljs-keyword">this</span>.priority)) {
      errors.push(<span class="hljs-string">"Priority must be one of: low, medium, high, urgent"</span>);
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dueDate &amp;&amp; <span class="hljs-keyword">this</span>.dueDate &lt; <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()) {
      errors.push(<span class="hljs-string">"Due date cannot be in the past"</span>);
    }

    <span class="hljs-keyword">return</span> errors;
  }

  toJSON() {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">id</span>: <span class="hljs-keyword">this</span>.id,
      <span class="hljs-attr">title</span>: <span class="hljs-keyword">this</span>.title,
      <span class="hljs-attr">description</span>: <span class="hljs-keyword">this</span>.description,
      <span class="hljs-attr">status</span>: <span class="hljs-keyword">this</span>.status,
      <span class="hljs-attr">priority</span>: <span class="hljs-keyword">this</span>.priority,
      <span class="hljs-attr">dueDate</span>: <span class="hljs-keyword">this</span>.dueDate,
      <span class="hljs-attr">assignedTo</span>: <span class="hljs-keyword">this</span>.assignedTo,
      <span class="hljs-attr">tags</span>: <span class="hljs-keyword">this</span>.tags,
      <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">this</span>.createdAt,
      <span class="hljs-attr">updatedAt</span>: <span class="hljs-keyword">this</span>.updatedAt,
      <span class="hljs-attr">completedAt</span>: <span class="hljs-keyword">this</span>.completedAt,
      <span class="hljs-attr">isOverdue</span>:
        <span class="hljs-keyword">this</span>.dueDate &amp;&amp;
        <span class="hljs-keyword">this</span>.dueDate &lt; <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() &amp;&amp;
        <span class="hljs-keyword">this</span>.status !== <span class="hljs-string">"completed"</span>,
    };
  }

  markCompleted() {
    <span class="hljs-keyword">this</span>.status = <span class="hljs-string">"completed"</span>;
    <span class="hljs-keyword">this</span>.completedAt = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
    <span class="hljs-keyword">this</span>.updatedAt = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
  }

  updateStatus(newStatus) {
    <span class="hljs-keyword">const</span> oldStatus = <span class="hljs-keyword">this</span>.status;
    <span class="hljs-keyword">this</span>.status = newStatus;
    <span class="hljs-keyword">this</span>.updatedAt = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();

    <span class="hljs-keyword">if</span> (newStatus === <span class="hljs-string">"completed"</span> &amp;&amp; oldStatus !== <span class="hljs-string">"completed"</span>) {
      <span class="hljs-keyword">this</span>.completedAt = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newStatus !== <span class="hljs-string">"completed"</span>) {
      <span class="hljs-keyword">this</span>.completedAt = <span class="hljs-literal">null</span>;
    }
  }
}

<span class="hljs-built_in">module</span>.exports = Task;
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">// services/TaskService.js - Business Logic Layer</span>
<span class="hljs-keyword">const</span> Task = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../models/Task"</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>).promises;
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TaskService</span> </span>{
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.tasks = [];
    <span class="hljs-keyword">this</span>.nextId = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">this</span>.dataFile = path.join(__dirname, <span class="hljs-string">"../data/tasks.json"</span>);
    <span class="hljs-keyword">this</span>.loadTasks();
  }

  <span class="hljs-comment">// Load tasks from file</span>
  <span class="hljs-keyword">async</span> loadTasks() {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> fs.readFile(<span class="hljs-keyword">this</span>.dataFile, <span class="hljs-string">"utf8"</span>);
      <span class="hljs-keyword">const</span> tasksData = <span class="hljs-built_in">JSON</span>.parse(data);
      <span class="hljs-keyword">this</span>.tasks = tasksData.tasks.map(<span class="hljs-function">(<span class="hljs-params">taskData</span>) =&gt;</span> <span class="hljs-keyword">new</span> Task(taskData));
      <span class="hljs-keyword">this</span>.nextId = tasksData.nextId || <span class="hljs-number">1</span>;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-comment">// File doesn't exist or is invalid, start with empty array</span>
      <span class="hljs-keyword">this</span>.tasks = [];
      <span class="hljs-keyword">this</span>.nextId = <span class="hljs-number">1</span>;
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.saveTasks();
    }
  }

  <span class="hljs-comment">// Save tasks to file</span>
  <span class="hljs-keyword">async</span> saveTasks() {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> dataDir = path.dirname(<span class="hljs-keyword">this</span>.dataFile);
      <span class="hljs-keyword">await</span> fs.mkdir(dataDir, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });

      <span class="hljs-keyword">const</span> data = {
        <span class="hljs-attr">tasks</span>: <span class="hljs-keyword">this</span>.tasks.map(<span class="hljs-function">(<span class="hljs-params">task</span>) =&gt;</span> task.toJSON()),
        <span class="hljs-attr">nextId</span>: <span class="hljs-keyword">this</span>.nextId,
        <span class="hljs-attr">lastUpdated</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
      };

      <span class="hljs-keyword">await</span> fs.writeFile(<span class="hljs-keyword">this</span>.dataFile, <span class="hljs-built_in">JSON</span>.stringify(data, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error saving tasks:"</span>, error);
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Failed to save tasks"</span>);
    }
  }

  <span class="hljs-comment">// CREATE - Add new task</span>
  <span class="hljs-keyword">async</span> createTask(taskData) {
    <span class="hljs-keyword">const</span> task = <span class="hljs-keyword">new</span> Task({
      ...taskData,
      <span class="hljs-attr">id</span>: <span class="hljs-keyword">this</span>.nextId++,
    });

    <span class="hljs-keyword">const</span> validationErrors = task.validate();
    <span class="hljs-keyword">if</span> (validationErrors.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Validation failed: <span class="hljs-subst">${validationErrors.join(<span class="hljs-string">", "</span>)}</span>`</span>);
    }

    <span class="hljs-keyword">this</span>.tasks.push(task);
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.saveTasks();

    <span class="hljs-keyword">return</span> task.toJSON();
  }

  <span class="hljs-comment">// READ - Get all tasks with filtering, sorting, and pagination</span>
  <span class="hljs-keyword">async</span> getAllTasks(options = {}) {
    <span class="hljs-keyword">const</span> {
      page = <span class="hljs-number">1</span>,
      limit = <span class="hljs-number">10</span>,
      sortBy = <span class="hljs-string">"createdAt"</span>,
      sortOrder = <span class="hljs-string">"desc"</span>,
      status,
      priority,
      assignedTo,
      search,
      tags,
      overdue,
      dueDateFrom,
      dueDateTo,
    } = options;

    <span class="hljs-keyword">let</span> filteredTasks = [...this.tasks];

    <span class="hljs-comment">// Apply filters</span>
    <span class="hljs-keyword">if</span> (status) {
      filteredTasks = filteredTasks.filter(<span class="hljs-function">(<span class="hljs-params">task</span>) =&gt;</span> task.status === status);
    }

    <span class="hljs-keyword">if</span> (priority) {
      filteredTasks = filteredTasks.filter(
        <span class="hljs-function">(<span class="hljs-params">task</span>) =&gt;</span> task.priority === priority
      );
    }

    <span class="hljs-keyword">if</span> (assignedTo) {
      filteredTasks = filteredTasks.filter(
        <span class="hljs-function">(<span class="hljs-params">task</span>) =&gt;</span> task.assignedTo === assignedTo
      );
    }

    <span class="hljs-keyword">if</span> (search) {
      <span class="hljs-keyword">const</span> searchLower = search.toLowerCase();
      filteredTasks = filteredTasks.filter(
        <span class="hljs-function">(<span class="hljs-params">task</span>) =&gt;</span>
          task.title.toLowerCase().includes(searchLower) ||
          task.description.toLowerCase().includes(searchLower) ||
          (task.assignedTo &amp;&amp;
            task.assignedTo.toLowerCase().includes(searchLower))
      );
    }

    <span class="hljs-keyword">if</span> (tags) {
      <span class="hljs-keyword">const</span> tagList = tags.split(<span class="hljs-string">","</span>).map(<span class="hljs-function">(<span class="hljs-params">tag</span>) =&gt;</span> tag.trim().toLowerCase());
      filteredTasks = filteredTasks.filter(<span class="hljs-function">(<span class="hljs-params">task</span>) =&gt;</span>
        tagList.some(<span class="hljs-function">(<span class="hljs-params">tag</span>) =&gt;</span>
          task.tags.map(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.toLowerCase()).includes(tag)
        )
      );
    }

    <span class="hljs-keyword">if</span> (overdue === <span class="hljs-string">"true"</span>) {
      <span class="hljs-keyword">const</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
      filteredTasks = filteredTasks.filter(
        <span class="hljs-function">(<span class="hljs-params">task</span>) =&gt;</span>
          task.dueDate &amp;&amp; task.dueDate &lt; now &amp;&amp; task.status !== <span class="hljs-string">"completed"</span>
      );
    }

    <span class="hljs-keyword">if</span> (dueDateFrom) {
      <span class="hljs-keyword">const</span> fromDate = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(dueDateFrom);
      filteredTasks = filteredTasks.filter(
        <span class="hljs-function">(<span class="hljs-params">task</span>) =&gt;</span> task.dueDate &amp;&amp; task.dueDate &gt;= fromDate
      );
    }

    <span class="hljs-keyword">if</span> (dueDateTo) {
      <span class="hljs-keyword">const</span> toDate = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(dueDateTo);
      filteredTasks = filteredTasks.filter(
        <span class="hljs-function">(<span class="hljs-params">task</span>) =&gt;</span> task.dueDate &amp;&amp; task.dueDate &lt;= toDate
      );
    }

    <span class="hljs-comment">// Apply sorting</span>
    filteredTasks.sort(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> {
      <span class="hljs-keyword">let</span> aVal = a[sortBy];
      <span class="hljs-keyword">let</span> bVal = b[sortBy];

      <span class="hljs-comment">// Handle date fields</span>
      <span class="hljs-keyword">if</span> (
        [<span class="hljs-string">"createdAt"</span>, <span class="hljs-string">"updatedAt"</span>, <span class="hljs-string">"dueDate"</span>, <span class="hljs-string">"completedAt"</span>].includes(sortBy)
      ) {
        aVal = aVal ? <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(aVal) : <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-number">0</span>);
        bVal = bVal ? <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(bVal) : <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-number">0</span>);
      }

      <span class="hljs-comment">// Handle priority sorting</span>
      <span class="hljs-keyword">if</span> (sortBy === <span class="hljs-string">"priority"</span>) {
        <span class="hljs-keyword">const</span> priorityOrder = { <span class="hljs-attr">low</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">medium</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">high</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">urgent</span>: <span class="hljs-number">4</span> };
        aVal = priorityOrder[aVal] || <span class="hljs-number">0</span>;
        bVal = priorityOrder[bVal] || <span class="hljs-number">0</span>;
      }

      <span class="hljs-keyword">if</span> (sortOrder === <span class="hljs-string">"desc"</span>) {
        <span class="hljs-keyword">return</span> bVal &gt; aVal ? <span class="hljs-number">1</span> : <span class="hljs-number">-1</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> aVal &gt; bVal ? <span class="hljs-number">1</span> : <span class="hljs-number">-1</span>;
      }
    });

    <span class="hljs-comment">// Apply pagination</span>
    <span class="hljs-keyword">const</span> total = filteredTasks.length;
    <span class="hljs-keyword">const</span> totalPages = <span class="hljs-built_in">Math</span>.ceil(total / limit);
    <span class="hljs-keyword">const</span> offset = (page - <span class="hljs-number">1</span>) * limit;
    <span class="hljs-keyword">const</span> paginatedTasks = filteredTasks.slice(offset, offset + limit);

    <span class="hljs-comment">// Calculate statistics</span>
    <span class="hljs-keyword">const</span> stats = {
      <span class="hljs-attr">total</span>: <span class="hljs-keyword">this</span>.tasks.length,
      <span class="hljs-attr">filtered</span>: total,
      <span class="hljs-attr">byStatus</span>: {
        <span class="hljs-attr">pending</span>: <span class="hljs-keyword">this</span>.tasks.filter(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.status === <span class="hljs-string">"pending"</span>).length,
        <span class="hljs-string">"in-progress"</span>: <span class="hljs-keyword">this</span>.tasks.filter(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.status === <span class="hljs-string">"in-progress"</span>)
          .length,
        <span class="hljs-attr">completed</span>: <span class="hljs-keyword">this</span>.tasks.filter(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.status === <span class="hljs-string">"completed"</span>).length,
      },
      <span class="hljs-attr">overdue</span>: <span class="hljs-keyword">this</span>.tasks.filter(
        <span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.dueDate &amp;&amp; t.dueDate &lt; <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() &amp;&amp; t.status !== <span class="hljs-string">"completed"</span>
      ).length,
    };

    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">tasks</span>: paginatedTasks.map(<span class="hljs-function">(<span class="hljs-params">task</span>) =&gt;</span> task.toJSON()),
      <span class="hljs-attr">pagination</span>: {
        <span class="hljs-attr">page</span>: <span class="hljs-built_in">parseInt</span>(page),
        <span class="hljs-attr">limit</span>: <span class="hljs-built_in">parseInt</span>(limit),
        total,
        totalPages,
        <span class="hljs-attr">hasNext</span>: page &lt; totalPages,
        <span class="hljs-attr">hasPrev</span>: page &gt; <span class="hljs-number">1</span>,
      },
      stats,
    };
  }

  <span class="hljs-comment">// READ - Get task by ID</span>
  <span class="hljs-keyword">async</span> getTaskById(id) {
    <span class="hljs-keyword">const</span> task = <span class="hljs-keyword">this</span>.tasks.find(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.id === <span class="hljs-built_in">parseInt</span>(id));
    <span class="hljs-keyword">return</span> task ? task.toJSON() : <span class="hljs-literal">null</span>;
  }

  <span class="hljs-comment">// UPDATE - Update entire task</span>
  <span class="hljs-keyword">async</span> updateTask(id, updateData) {
    <span class="hljs-keyword">const</span> taskIndex = <span class="hljs-keyword">this</span>.tasks.findIndex(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.id === <span class="hljs-built_in">parseInt</span>(id));

    <span class="hljs-keyword">if</span> (taskIndex === <span class="hljs-number">-1</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">const</span> updatedTask = <span class="hljs-keyword">new</span> Task({
      ...this.tasks[taskIndex],
      ...updateData,
      <span class="hljs-attr">id</span>: <span class="hljs-built_in">parseInt</span>(id),
      <span class="hljs-attr">updatedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
    });

    <span class="hljs-keyword">const</span> validationErrors = updatedTask.validate();
    <span class="hljs-keyword">if</span> (validationErrors.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Validation failed: <span class="hljs-subst">${validationErrors.join(<span class="hljs-string">", "</span>)}</span>`</span>);
    }

    <span class="hljs-keyword">this</span>.tasks[taskIndex] = updatedTask;
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.saveTasks();

    <span class="hljs-keyword">return</span> updatedTask.toJSON();
  }

  <span class="hljs-comment">// UPDATE - Partial update</span>
  <span class="hljs-keyword">async</span> patchTask(id, patchData) {
    <span class="hljs-keyword">const</span> taskIndex = <span class="hljs-keyword">this</span>.tasks.findIndex(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.id === <span class="hljs-built_in">parseInt</span>(id));

    <span class="hljs-keyword">if</span> (taskIndex === <span class="hljs-number">-1</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-comment">// Handle status change logic</span>
    <span class="hljs-keyword">if</span> (patchData.status &amp;&amp; patchData.status !== <span class="hljs-keyword">this</span>.tasks[taskIndex].status) {
      <span class="hljs-keyword">this</span>.tasks[taskIndex].updateStatus(patchData.status);
    }

    <span class="hljs-comment">// Apply other updates</span>
    <span class="hljs-built_in">Object</span>.keys(patchData).forEach(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (key !== <span class="hljs-string">"id"</span> &amp;&amp; key !== <span class="hljs-string">"createdAt"</span> &amp;&amp; patchData[key] !== <span class="hljs-literal">undefined</span>) {
        <span class="hljs-keyword">this</span>.tasks[taskIndex][key] = patchData[key];
      }
    });

    <span class="hljs-keyword">this</span>.tasks[taskIndex].updatedAt = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();

    <span class="hljs-keyword">const</span> validationErrors = <span class="hljs-keyword">this</span>.tasks[taskIndex].validate();
    <span class="hljs-keyword">if</span> (validationErrors.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Validation failed: <span class="hljs-subst">${validationErrors.join(<span class="hljs-string">", "</span>)}</span>`</span>);
    }

    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.saveTasks();

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.tasks[taskIndex].toJSON();
  }

  <span class="hljs-comment">// DELETE - Remove task</span>
  <span class="hljs-keyword">async</span> deleteTask(id) {
    <span class="hljs-keyword">const</span> taskIndex = <span class="hljs-keyword">this</span>.tasks.findIndex(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.id === <span class="hljs-built_in">parseInt</span>(id));

    <span class="hljs-keyword">if</span> (taskIndex === <span class="hljs-number">-1</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">const</span> deletedTask = <span class="hljs-keyword">this</span>.tasks.splice(taskIndex, <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.saveTasks();

    <span class="hljs-keyword">return</span> deletedTask.toJSON();
  }

  <span class="hljs-comment">// BULK OPERATIONS</span>
  <span class="hljs-keyword">async</span> bulkUpdateTasks(ids, updateData) {
    <span class="hljs-keyword">const</span> updatedTasks = [];
    <span class="hljs-keyword">const</span> errors = [];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> id <span class="hljs-keyword">of</span> ids) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> updated = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.patchTask(id, updateData);
        <span class="hljs-keyword">if</span> (updated) {
          updatedTasks.push(updated);
        } <span class="hljs-keyword">else</span> {
          errors.push(<span class="hljs-string">`Task with ID <span class="hljs-subst">${id}</span> not found`</span>);
        }
      } <span class="hljs-keyword">catch</span> (error) {
        errors.push(<span class="hljs-string">`Task <span class="hljs-subst">${id}</span>: <span class="hljs-subst">${error.message}</span>`</span>);
      }
    }

    <span class="hljs-keyword">return</span> { updatedTasks, errors };
  }

  <span class="hljs-keyword">async</span> bulkDeleteTasks(ids) {
    <span class="hljs-keyword">const</span> deletedTasks = [];
    <span class="hljs-keyword">const</span> errors = [];

    <span class="hljs-comment">// Sort IDs in descending order to avoid index shifting issues</span>
    <span class="hljs-keyword">const</span> sortedIds = ids.sort(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> b - a);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> id <span class="hljs-keyword">of</span> sortedIds) {
      <span class="hljs-keyword">const</span> deleted = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.deleteTask(id);
      <span class="hljs-keyword">if</span> (deleted) {
        deletedTasks.push(deleted);
      } <span class="hljs-keyword">else</span> {
        errors.push(<span class="hljs-string">`Task with ID <span class="hljs-subst">${id}</span> not found`</span>);
      }
    }

    <span class="hljs-keyword">return</span> { <span class="hljs-attr">deletedTasks</span>: deletedTasks.reverse(), errors };
  }

  <span class="hljs-comment">// ANALYTICS</span>
  <span class="hljs-keyword">async</span> getTaskAnalytics() {
    <span class="hljs-keyword">const</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
    <span class="hljs-keyword">const</span> oneWeekAgo = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(now.getTime() - <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);
    <span class="hljs-keyword">const</span> oneMonthAgo = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(now.getTime() - <span class="hljs-number">30</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);

    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">total</span>: <span class="hljs-keyword">this</span>.tasks.length,
      <span class="hljs-attr">byStatus</span>: {
        <span class="hljs-attr">pending</span>: <span class="hljs-keyword">this</span>.tasks.filter(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.status === <span class="hljs-string">"pending"</span>).length,
        <span class="hljs-string">"in-progress"</span>: <span class="hljs-keyword">this</span>.tasks.filter(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.status === <span class="hljs-string">"in-progress"</span>)
          .length,
        <span class="hljs-attr">completed</span>: <span class="hljs-keyword">this</span>.tasks.filter(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.status === <span class="hljs-string">"completed"</span>).length,
      },
      <span class="hljs-attr">byPriority</span>: {
        <span class="hljs-attr">low</span>: <span class="hljs-keyword">this</span>.tasks.filter(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.priority === <span class="hljs-string">"low"</span>).length,
        <span class="hljs-attr">medium</span>: <span class="hljs-keyword">this</span>.tasks.filter(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.priority === <span class="hljs-string">"medium"</span>).length,
        <span class="hljs-attr">high</span>: <span class="hljs-keyword">this</span>.tasks.filter(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.priority === <span class="hljs-string">"high"</span>).length,
        <span class="hljs-attr">urgent</span>: <span class="hljs-keyword">this</span>.tasks.filter(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.priority === <span class="hljs-string">"urgent"</span>).length,
      },
      <span class="hljs-attr">overdue</span>: <span class="hljs-keyword">this</span>.tasks.filter(
        <span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.dueDate &amp;&amp; t.dueDate &lt; now &amp;&amp; t.status !== <span class="hljs-string">"completed"</span>
      ).length,
      <span class="hljs-attr">completedThisWeek</span>: <span class="hljs-keyword">this</span>.tasks.filter(
        <span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.completedAt &amp;&amp; t.completedAt &gt;= oneWeekAgo
      ).length,
      <span class="hljs-attr">completedThisMonth</span>: <span class="hljs-keyword">this</span>.tasks.filter(
        <span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.completedAt &amp;&amp; t.completedAt &gt;= oneMonthAgo
      ).length,
      <span class="hljs-attr">averageCompletionTime</span>: <span class="hljs-keyword">this</span>.calculateAverageCompletionTime(),
      <span class="hljs-attr">topAssignees</span>: <span class="hljs-keyword">this</span>.getTopAssignees(),
    };
  }

  calculateAverageCompletionTime() {
    <span class="hljs-keyword">const</span> completedTasks = <span class="hljs-keyword">this</span>.tasks.filter(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.completedAt);
    <span class="hljs-keyword">if</span> (completedTasks.length === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

    <span class="hljs-keyword">const</span> totalTime = completedTasks.reduce(<span class="hljs-function">(<span class="hljs-params">sum, task</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> completionTime = task.completedAt - task.createdAt;
      <span class="hljs-keyword">return</span> sum + completionTime;
    }, <span class="hljs-number">0</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.round(
      totalTime / completedTasks.length / (<span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span>)
    ); <span class="hljs-comment">// days</span>
  }

  getTopAssignees() {
    <span class="hljs-keyword">const</span> assigneeCounts = {};
    <span class="hljs-keyword">this</span>.tasks.forEach(<span class="hljs-function">(<span class="hljs-params">task</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (task.assignedTo) {
        assigneeCounts[task.assignedTo] =
          (assigneeCounts[task.assignedTo] || <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>;
      }
    });

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.entries(assigneeCounts)
      .sort(<span class="hljs-function">(<span class="hljs-params">[, a], [, b]</span>) =&gt;</span> b - a)
      .slice(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>)
      .map(<span class="hljs-function">(<span class="hljs-params">[name, count]</span>) =&gt;</span> ({ name, count }));
  }
}

<span class="hljs-built_in">module</span>.exports = TaskService;
</div></code></pre>
<h3 id="crud-controllers">CRUD Controllers</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// controllers/TaskController.js - Request/Response Handling</span>
<span class="hljs-keyword">const</span> TaskService = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../services/TaskService"</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TaskController</span> </span>{
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.taskService = <span class="hljs-keyword">new</span> TaskService();
  }

  <span class="hljs-comment">// CREATE - POST /api/tasks</span>
  <span class="hljs-keyword">async</span> createTask(req, res) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> task = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.taskService.createTask(req.body);

      res.status(<span class="hljs-number">201</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: task,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Task created successfully"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (error.message.includes(<span class="hljs-string">"Validation failed"</span>)) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">422</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Validation Error"</span>,
          <span class="hljs-attr">message</span>: error.message,
        });
      }

      res.status(<span class="hljs-number">500</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal Server Error"</span>,
        <span class="hljs-attr">message</span>: error.message,
      });
    }
  }

  <span class="hljs-comment">// READ - GET /api/tasks</span>
  <span class="hljs-keyword">async</span> getAllTasks(req, res) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> options = {
        <span class="hljs-attr">page</span>: req.query.page,
        <span class="hljs-attr">limit</span>: req.query.limit,
        <span class="hljs-attr">sortBy</span>: req.query.sortBy,
        <span class="hljs-attr">sortOrder</span>: req.query.sortOrder,
        <span class="hljs-attr">status</span>: req.query.status,
        <span class="hljs-attr">priority</span>: req.query.priority,
        <span class="hljs-attr">assignedTo</span>: req.query.assignedTo,
        <span class="hljs-attr">search</span>: req.query.search,
        <span class="hljs-attr">tags</span>: req.query.tags,
        <span class="hljs-attr">overdue</span>: req.query.overdue,
        <span class="hljs-attr">dueDateFrom</span>: req.query.dueDateFrom,
        <span class="hljs-attr">dueDateTo</span>: req.query.dueDateTo,
      };

      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.taskService.getAllTasks(options);

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: result.tasks,
        <span class="hljs-attr">pagination</span>: result.pagination,
        <span class="hljs-attr">stats</span>: result.stats,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Tasks retrieved successfully"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      res.status(<span class="hljs-number">500</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal Server Error"</span>,
        <span class="hljs-attr">message</span>: error.message,
      });
    }
  }

  <span class="hljs-comment">// READ - GET /api/tasks/:id</span>
  <span class="hljs-keyword">async</span> getTaskById(req, res) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> task = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.taskService.getTaskById(req.params.id);

      <span class="hljs-keyword">if</span> (!task) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Not Found"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">`Task with ID <span class="hljs-subst">${req.params.id}</span> does not exist`</span>,
        });
      }

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: task,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Task retrieved successfully"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      res.status(<span class="hljs-number">500</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal Server Error"</span>,
        <span class="hljs-attr">message</span>: error.message,
      });
    }
  }

  <span class="hljs-comment">// UPDATE - PUT /api/tasks/:id</span>
  <span class="hljs-keyword">async</span> updateTask(req, res) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> task = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.taskService.updateTask(req.params.id, req.body);

      <span class="hljs-keyword">if</span> (!task) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Not Found"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">`Task with ID <span class="hljs-subst">${req.params.id}</span> does not exist`</span>,
        });
      }

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: task,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Task updated successfully"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (error.message.includes(<span class="hljs-string">"Validation failed"</span>)) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">422</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Validation Error"</span>,
          <span class="hljs-attr">message</span>: error.message,
        });
      }

      res.status(<span class="hljs-number">500</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal Server Error"</span>,
        <span class="hljs-attr">message</span>: error.message,
      });
    }
  }

  <span class="hljs-comment">// UPDATE - PATCH /api/tasks/:id</span>
  <span class="hljs-keyword">async</span> patchTask(req, res) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> task = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.taskService.patchTask(req.params.id, req.body);

      <span class="hljs-keyword">if</span> (!task) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Not Found"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">`Task with ID <span class="hljs-subst">${req.params.id}</span> does not exist`</span>,
        });
      }

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: task,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Task updated successfully"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (error.message.includes(<span class="hljs-string">"Validation failed"</span>)) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">422</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Validation Error"</span>,
          <span class="hljs-attr">message</span>: error.message,
        });
      }

      res.status(<span class="hljs-number">500</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal Server Error"</span>,
        <span class="hljs-attr">message</span>: error.message,
      });
    }
  }

  <span class="hljs-comment">// DELETE - DELETE /api/tasks/:id</span>
  <span class="hljs-keyword">async</span> deleteTask(req, res) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> task = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.taskService.deleteTask(req.params.id);

      <span class="hljs-keyword">if</span> (!task) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Not Found"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">`Task with ID <span class="hljs-subst">${req.params.id}</span> does not exist`</span>,
        });
      }

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: task,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Task deleted successfully"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      res.status(<span class="hljs-number">500</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal Server Error"</span>,
        <span class="hljs-attr">message</span>: error.message,
      });
    }
  }

  <span class="hljs-comment">// BULK OPERATIONS</span>

  <span class="hljs-comment">// PATCH /api/tasks/bulk</span>
  <span class="hljs-keyword">async</span> bulkUpdateTasks(req, res) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> { ids, updateData } = req.body;

      <span class="hljs-keyword">if</span> (!ids || !<span class="hljs-built_in">Array</span>.isArray(ids) || ids.length === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Bad Request"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">"Array of task IDs is required"</span>,
        });
      }

      <span class="hljs-keyword">if</span> (!updateData || <span class="hljs-built_in">Object</span>.keys(updateData).length === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Bad Request"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">"Update data is required"</span>,
        });
      }

      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.taskService.bulkUpdateTasks(ids, updateData);

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: {
          <span class="hljs-attr">updated</span>: result.updatedTasks,
          <span class="hljs-attr">errors</span>: result.errors,
        },
        <span class="hljs-attr">message</span>: <span class="hljs-string">`<span class="hljs-subst">${result.updatedTasks.length}</span> tasks updated successfully`</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      res.status(<span class="hljs-number">500</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal Server Error"</span>,
        <span class="hljs-attr">message</span>: error.message,
      });
    }
  }

  <span class="hljs-comment">// DELETE /api/tasks/bulk</span>
  <span class="hljs-keyword">async</span> bulkDeleteTasks(req, res) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> { ids } = req.body;

      <span class="hljs-keyword">if</span> (!ids || !<span class="hljs-built_in">Array</span>.isArray(ids) || ids.length === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Bad Request"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">"Array of task IDs is required"</span>,
        });
      }

      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.taskService.bulkDeleteTasks(ids);

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: {
          <span class="hljs-attr">deleted</span>: result.deletedTasks,
          <span class="hljs-attr">errors</span>: result.errors,
        },
        <span class="hljs-attr">message</span>: <span class="hljs-string">`<span class="hljs-subst">${result.deletedTasks.length}</span> tasks deleted successfully`</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      res.status(<span class="hljs-number">500</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal Server Error"</span>,
        <span class="hljs-attr">message</span>: error.message,
      });
    }
  }

  <span class="hljs-comment">// ANALYTICS - GET /api/tasks/analytics</span>
  <span class="hljs-keyword">async</span> getTaskAnalytics(req, res) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> analytics = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.taskService.getTaskAnalytics();

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: analytics,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Task analytics retrieved successfully"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      res.status(<span class="hljs-number">500</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal Server Error"</span>,
        <span class="hljs-attr">message</span>: error.message,
      });
    }
  }

  <span class="hljs-comment">// CUSTOM ACTIONS</span>

  <span class="hljs-comment">// PATCH /api/tasks/:id/complete</span>
  <span class="hljs-keyword">async</span> completeTask(req, res) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> task = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.taskService.patchTask(req.params.id, {
        <span class="hljs-attr">status</span>: <span class="hljs-string">"completed"</span>,
      });

      <span class="hljs-keyword">if</span> (!task) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Not Found"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">`Task with ID <span class="hljs-subst">${req.params.id}</span> does not exist`</span>,
        });
      }

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: task,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Task marked as completed"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      res.status(<span class="hljs-number">500</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal Server Error"</span>,
        <span class="hljs-attr">message</span>: error.message,
      });
    }
  }

  <span class="hljs-comment">// GET /api/tasks/overdue</span>
  <span class="hljs-keyword">async</span> getOverdueTasks(req, res) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> options = {
        ...req.query,
        <span class="hljs-attr">overdue</span>: <span class="hljs-string">"true"</span>,
      };

      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.taskService.getAllTasks(options);

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: result.tasks,
        <span class="hljs-attr">pagination</span>: result.pagination,
        <span class="hljs-attr">count</span>: result.tasks.length,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Overdue tasks retrieved successfully"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      res.status(<span class="hljs-number">500</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal Server Error"</span>,
        <span class="hljs-attr">message</span>: error.message,
      });
    }
  }
}

<span class="hljs-built_in">module</span>.exports = TaskController;
</div></code></pre>
<h3 id="crud-routes-with-validation">CRUD Routes with Validation</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// routes/tasks.js - Task Routes with Validation</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> { body, query, param, validationResult } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express-validator"</span>);
<span class="hljs-keyword">const</span> TaskController = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../controllers/TaskController"</span>);
<span class="hljs-keyword">const</span> router = express.Router();

<span class="hljs-keyword">const</span> taskController = <span class="hljs-keyword">new</span> TaskController();

<span class="hljs-comment">// Validation middleware</span>
<span class="hljs-keyword">const</span> handleValidationErrors = <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> errors = validationResult(req);
  <span class="hljs-keyword">if</span> (!errors.isEmpty()) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">422</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Validation Error"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Invalid input data"</span>,
      <span class="hljs-attr">details</span>: errors.array(),
    });
  }
  next();
};

<span class="hljs-comment">// Validation rules</span>
<span class="hljs-keyword">const</span> createTaskValidation = [
  body(<span class="hljs-string">"title"</span>)
    .trim()
    .isLength({ <span class="hljs-attr">min</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">100</span> })
    .withMessage(<span class="hljs-string">"Title must be between 3 and 100 characters"</span>),
  body(<span class="hljs-string">"description"</span>)
    .optional()
    .isLength({ <span class="hljs-attr">max</span>: <span class="hljs-number">500</span> })
    .withMessage(<span class="hljs-string">"Description cannot exceed 500 characters"</span>),
  body(<span class="hljs-string">"status"</span>)
    .optional()
    .isIn([<span class="hljs-string">"pending"</span>, <span class="hljs-string">"in-progress"</span>, <span class="hljs-string">"completed"</span>])
    .withMessage(<span class="hljs-string">"Status must be one of: pending, in-progress, completed"</span>),
  body(<span class="hljs-string">"priority"</span>)
    .optional()
    .isIn([<span class="hljs-string">"low"</span>, <span class="hljs-string">"medium"</span>, <span class="hljs-string">"high"</span>, <span class="hljs-string">"urgent"</span>])
    .withMessage(<span class="hljs-string">"Priority must be one of: low, medium, high, urgent"</span>),
  body(<span class="hljs-string">"dueDate"</span>)
    .optional()
    .isISO8601()
    .withMessage(<span class="hljs-string">"Due date must be a valid ISO 8601 date"</span>),
  body(<span class="hljs-string">"assignedTo"</span>)
    .optional()
    .trim()
    .isLength({ <span class="hljs-attr">min</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">50</span> })
    .withMessage(<span class="hljs-string">"Assigned to must be between 1 and 50 characters"</span>),
  body(<span class="hljs-string">"tags"</span>).optional().isArray().withMessage(<span class="hljs-string">"Tags must be an array"</span>),
  body(<span class="hljs-string">"tags.*"</span>)
    .optional()
    .trim()
    .isLength({ <span class="hljs-attr">min</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">20</span> })
    .withMessage(<span class="hljs-string">"Each tag must be between 1 and 20 characters"</span>),
];

<span class="hljs-keyword">const</span> updateTaskValidation = [
  param(<span class="hljs-string">"id"</span>)
    .isInt({ <span class="hljs-attr">min</span>: <span class="hljs-number">1</span> })
    .withMessage(<span class="hljs-string">"Task ID must be a positive integer"</span>),
  ...createTaskValidation,
];

<span class="hljs-keyword">const</span> patchTaskValidation = [
  param(<span class="hljs-string">"id"</span>)
    .isInt({ <span class="hljs-attr">min</span>: <span class="hljs-number">1</span> })
    .withMessage(<span class="hljs-string">"Task ID must be a positive integer"</span>),
  body(<span class="hljs-string">"title"</span>)
    .optional()
    .trim()
    .isLength({ <span class="hljs-attr">min</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">100</span> })
    .withMessage(<span class="hljs-string">"Title must be between 3 and 100 characters"</span>),
  body(<span class="hljs-string">"description"</span>)
    .optional()
    .isLength({ <span class="hljs-attr">max</span>: <span class="hljs-number">500</span> })
    .withMessage(<span class="hljs-string">"Description cannot exceed 500 characters"</span>),
  body(<span class="hljs-string">"status"</span>)
    .optional()
    .isIn([<span class="hljs-string">"pending"</span>, <span class="hljs-string">"in-progress"</span>, <span class="hljs-string">"completed"</span>])
    .withMessage(<span class="hljs-string">"Status must be one of: pending, in-progress, completed"</span>),
  body(<span class="hljs-string">"priority"</span>)
    .optional()
    .isIn([<span class="hljs-string">"low"</span>, <span class="hljs-string">"medium"</span>, <span class="hljs-string">"high"</span>, <span class="hljs-string">"urgent"</span>])
    .withMessage(<span class="hljs-string">"Priority must be one of: low, medium, high, urgent"</span>),
  body(<span class="hljs-string">"dueDate"</span>)
    .optional()
    .isISO8601()
    .withMessage(<span class="hljs-string">"Due date must be a valid ISO 8601 date"</span>),
  body(<span class="hljs-string">"assignedTo"</span>)
    .optional()
    .trim()
    .isLength({ <span class="hljs-attr">min</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">50</span> })
    .withMessage(<span class="hljs-string">"Assigned to must be between 1 and 50 characters"</span>),
  body(<span class="hljs-string">"tags"</span>).optional().isArray().withMessage(<span class="hljs-string">"Tags must be an array"</span>),
  body(<span class="hljs-string">"tags.*"</span>)
    .optional()
    .trim()
    .isLength({ <span class="hljs-attr">min</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">20</span> })
    .withMessage(<span class="hljs-string">"Each tag must be between 1 and 20 characters"</span>),
];

<span class="hljs-keyword">const</span> queryValidation = [
  query(<span class="hljs-string">"page"</span>)
    .optional()
    .isInt({ <span class="hljs-attr">min</span>: <span class="hljs-number">1</span> })
    .withMessage(<span class="hljs-string">"Page must be a positive integer"</span>),
  query(<span class="hljs-string">"limit"</span>)
    .optional()
    .isInt({ <span class="hljs-attr">min</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">100</span> })
    .withMessage(<span class="hljs-string">"Limit must be between 1 and 100"</span>),
  query(<span class="hljs-string">"sortBy"</span>)
    .optional()
    .isIn([<span class="hljs-string">"createdAt"</span>, <span class="hljs-string">"updatedAt"</span>, <span class="hljs-string">"title"</span>, <span class="hljs-string">"status"</span>, <span class="hljs-string">"priority"</span>, <span class="hljs-string">"dueDate"</span>])
    .withMessage(<span class="hljs-string">"Invalid sort field"</span>),
  query(<span class="hljs-string">"sortOrder"</span>)
    .optional()
    .isIn([<span class="hljs-string">"asc"</span>, <span class="hljs-string">"desc"</span>])
    .withMessage(<span class="hljs-string">"Sort order must be asc or desc"</span>),
  query(<span class="hljs-string">"status"</span>)
    .optional()
    .isIn([<span class="hljs-string">"pending"</span>, <span class="hljs-string">"in-progress"</span>, <span class="hljs-string">"completed"</span>])
    .withMessage(<span class="hljs-string">"Invalid status filter"</span>),
  query(<span class="hljs-string">"priority"</span>)
    .optional()
    .isIn([<span class="hljs-string">"low"</span>, <span class="hljs-string">"medium"</span>, <span class="hljs-string">"high"</span>, <span class="hljs-string">"urgent"</span>])
    .withMessage(<span class="hljs-string">"Invalid priority filter"</span>),
  query(<span class="hljs-string">"overdue"</span>)
    .optional()
    .isBoolean()
    .withMessage(<span class="hljs-string">"Overdue must be true or false"</span>),
  query(<span class="hljs-string">"dueDateFrom"</span>)
    .optional()
    .isISO8601()
    .withMessage(<span class="hljs-string">"Due date from must be a valid ISO 8601 date"</span>),
  query(<span class="hljs-string">"dueDateTo"</span>)
    .optional()
    .isISO8601()
    .withMessage(<span class="hljs-string">"Due date to must be a valid ISO 8601 date"</span>),
];

<span class="hljs-keyword">const</span> bulkValidation = [
  body(<span class="hljs-string">"ids"</span>)
    .isArray({ <span class="hljs-attr">min</span>: <span class="hljs-number">1</span> })
    .withMessage(<span class="hljs-string">"IDs array is required and must not be empty"</span>),
  body(<span class="hljs-string">"ids.*"</span>)
    .isInt({ <span class="hljs-attr">min</span>: <span class="hljs-number">1</span> })
    .withMessage(<span class="hljs-string">"Each ID must be a positive integer"</span>),
];

<span class="hljs-comment">// Request logging middleware</span>
router.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span> - <span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.originalUrl}</span>`</span>);
  <span class="hljs-keyword">if</span> (req.body &amp;&amp; <span class="hljs-built_in">Object</span>.keys(req.body).length &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Request body:"</span>, <span class="hljs-built_in">JSON</span>.stringify(req.body, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
  }
  next();
});

<span class="hljs-comment">// CRUD Routes</span>

<span class="hljs-comment">// CREATE - POST /api/tasks</span>
router.post(
  <span class="hljs-string">"/"</span>,
  createTaskValidation,
  handleValidationErrors,
  taskController.createTask.bind(taskController)
);

<span class="hljs-comment">// READ - GET /api/tasks</span>
router.get(
  <span class="hljs-string">"/"</span>,
  queryValidation,
  handleValidationErrors,
  taskController.getAllTasks.bind(taskController)
);

<span class="hljs-comment">// READ - GET /api/tasks/analytics (before /:id to avoid conflicts)</span>
router.get(<span class="hljs-string">"/analytics"</span>, taskController.getTaskAnalytics.bind(taskController));

<span class="hljs-comment">// READ - GET /api/tasks/overdue</span>
router.get(
  <span class="hljs-string">"/overdue"</span>,
  queryValidation,
  handleValidationErrors,
  taskController.getOverdueTasks.bind(taskController)
);

<span class="hljs-comment">// READ - GET /api/tasks/:id</span>
router.get(
  <span class="hljs-string">"/:id"</span>,
  param(<span class="hljs-string">"id"</span>)
    .isInt({ <span class="hljs-attr">min</span>: <span class="hljs-number">1</span> })
    .withMessage(<span class="hljs-string">"Task ID must be a positive integer"</span>),
  handleValidationErrors,
  taskController.getTaskById.bind(taskController)
);

<span class="hljs-comment">// UPDATE - PUT /api/tasks/:id</span>
router.put(
  <span class="hljs-string">"/:id"</span>,
  updateTaskValidation,
  handleValidationErrors,
  taskController.updateTask.bind(taskController)
);

<span class="hljs-comment">// UPDATE - PATCH /api/tasks/:id</span>
router.patch(
  <span class="hljs-string">"/:id"</span>,
  patchTaskValidation,
  handleValidationErrors,
  taskController.patchTask.bind(taskController)
);

<span class="hljs-comment">// DELETE - DELETE /api/tasks/:id</span>
router.delete(
  <span class="hljs-string">"/:id"</span>,
  param(<span class="hljs-string">"id"</span>)
    .isInt({ <span class="hljs-attr">min</span>: <span class="hljs-number">1</span> })
    .withMessage(<span class="hljs-string">"Task ID must be a positive integer"</span>),
  handleValidationErrors,
  taskController.deleteTask.bind(taskController)
);

<span class="hljs-comment">// BULK OPERATIONS</span>

<span class="hljs-comment">// PATCH /api/tasks/bulk</span>
router.patch(
  <span class="hljs-string">"/bulk"</span>,
  bulkValidation,
  body(<span class="hljs-string">"updateData"</span>).isObject().withMessage(<span class="hljs-string">"Update data object is required"</span>),
  handleValidationErrors,
  taskController.bulkUpdateTasks.bind(taskController)
);

<span class="hljs-comment">// DELETE /api/tasks/bulk</span>
router.delete(
  <span class="hljs-string">"/bulk"</span>,
  bulkValidation,
  handleValidationErrors,
  taskController.bulkDeleteTasks.bind(taskController)
);

<span class="hljs-comment">// CUSTOM ACTIONS</span>

<span class="hljs-comment">// PATCH /api/tasks/:id/complete</span>
router.patch(
  <span class="hljs-string">"/:id/complete"</span>,
  param(<span class="hljs-string">"id"</span>)
    .isInt({ <span class="hljs-attr">min</span>: <span class="hljs-number">1</span> })
    .withMessage(<span class="hljs-string">"Task ID must be a positive integer"</span>),
  handleValidationErrors,
  taskController.completeTask.bind(taskController)
);

<span class="hljs-comment">// Error handling middleware for this router</span>
router.use(<span class="hljs-function">(<span class="hljs-params">error, req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Task router error:"</span>, error);
  res.status(<span class="hljs-number">500</span>).json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal Server Error"</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"An error occurred while processing the task request"</span>,
  });
});

<span class="hljs-built_in">module</span>.exports = router;
</div></code></pre>
<h2 id="real-world-use-case">Real-World Use Case</h2>
<h3 id="complete-task-management-api">Complete Task Management API</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// app.js - Complete CRUD Application</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">"cors"</span>);
<span class="hljs-keyword">const</span> helmet = <span class="hljs-built_in">require</span>(<span class="hljs-string">"helmet"</span>);
<span class="hljs-keyword">const</span> morgan = <span class="hljs-built_in">require</span>(<span class="hljs-string">"morgan"</span>);
<span class="hljs-keyword">const</span> rateLimit = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express-rate-limit"</span>);
<span class="hljs-keyword">const</span> compression = <span class="hljs-built_in">require</span>(<span class="hljs-string">"compression"</span>);

<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Security and performance middleware</span>
app.use(helmet());
app.use(compression());
app.use(
  cors({
    <span class="hljs-attr">origin</span>: process.env.ALLOWED_ORIGINS?.split(<span class="hljs-string">","</span>) || [
      <span class="hljs-string">"http://localhost:3000"</span>,
    ],
    <span class="hljs-attr">credentials</span>: <span class="hljs-literal">true</span>,
  })
);

<span class="hljs-comment">// Rate limiting</span>
<span class="hljs-keyword">const</span> limiter = rateLimit({
  <span class="hljs-attr">windowMs</span>: <span class="hljs-number">15</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 15 minutes</span>
  <span class="hljs-attr">max</span>: <span class="hljs-number">100</span>, <span class="hljs-comment">// limit each IP to 100 requests per windowMs</span>
  <span class="hljs-attr">message</span>: {
    <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">error</span>: <span class="hljs-string">"Too Many Requests"</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Rate limit exceeded. Please try again later."</span>,
  },
  <span class="hljs-attr">standardHeaders</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">legacyHeaders</span>: <span class="hljs-literal">false</span>,
});
app.use(<span class="hljs-string">"/api/"</span>, limiter);

<span class="hljs-comment">// Logging</span>
app.use(morgan(<span class="hljs-string">"combined"</span>));

<span class="hljs-comment">// Body parsing</span>
app.use(express.json({ <span class="hljs-attr">limit</span>: <span class="hljs-string">"10mb"</span> }));
app.use(express.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">limit</span>: <span class="hljs-string">"10mb"</span> }));

<span class="hljs-comment">// API versioning</span>
<span class="hljs-keyword">const</span> v1Router = express.Router();

<span class="hljs-comment">// Import routes</span>
<span class="hljs-keyword">const</span> taskRoutes = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./routes/tasks"</span>);
<span class="hljs-keyword">const</span> userRoutes = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./routes/users"</span>);
<span class="hljs-keyword">const</span> projectRoutes = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./routes/projects"</span>);

<span class="hljs-comment">// Mount routes</span>
v1Router.use(<span class="hljs-string">"/tasks"</span>, taskRoutes);
v1Router.use(<span class="hljs-string">"/users"</span>, userRoutes);
v1Router.use(<span class="hljs-string">"/projects"</span>, projectRoutes);

<span class="hljs-comment">// API info endpoint</span>
v1Router.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Task Management API v1"</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
    <span class="hljs-attr">endpoints</span>: {
      <span class="hljs-attr">tasks</span>: <span class="hljs-string">"/api/v1/tasks"</span>,
      <span class="hljs-attr">users</span>: <span class="hljs-string">"/api/v1/users"</span>,
      <span class="hljs-attr">projects</span>: <span class="hljs-string">"/api/v1/projects"</span>,
    },
    <span class="hljs-attr">features</span>: {
      <span class="hljs-attr">crud</span>: <span class="hljs-string">"Full CRUD operations"</span>,
      <span class="hljs-attr">filtering</span>: <span class="hljs-string">"Advanced filtering and search"</span>,
      <span class="hljs-attr">pagination</span>: <span class="hljs-string">"Cursor and offset pagination"</span>,
      <span class="hljs-attr">sorting</span>: <span class="hljs-string">"Multi-field sorting"</span>,
      <span class="hljs-attr">bulk</span>: <span class="hljs-string">"Bulk operations support"</span>,
      <span class="hljs-attr">analytics</span>: <span class="hljs-string">"Built-in analytics"</span>,
      <span class="hljs-attr">validation</span>: <span class="hljs-string">"Comprehensive input validation"</span>,
    },
    <span class="hljs-attr">documentation</span>: <span class="hljs-string">"/api/v1/docs"</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
  });
});

<span class="hljs-comment">// Health check with detailed status</span>
v1Router.get(<span class="hljs-string">"/health"</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// Check database connectivity (if using database)</span>
    <span class="hljs-comment">// const dbStatus = await checkDatabaseConnection();</span>

    <span class="hljs-keyword">const</span> health = {
      <span class="hljs-attr">status</span>: <span class="hljs-string">"healthy"</span>,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
      <span class="hljs-attr">uptime</span>: process.uptime(),
      <span class="hljs-attr">memory</span>: {
        <span class="hljs-attr">used</span>: <span class="hljs-built_in">Math</span>.round(process.memoryUsage().heapUsed / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>),
        <span class="hljs-attr">total</span>: <span class="hljs-built_in">Math</span>.round(process.memoryUsage().heapTotal / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>),
        <span class="hljs-attr">external</span>: <span class="hljs-built_in">Math</span>.round(process.memoryUsage().external / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>),
      },
      <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
      <span class="hljs-attr">environment</span>: process.env.NODE_ENV || <span class="hljs-string">"development"</span>,
      <span class="hljs-comment">// database: dbStatus</span>
    };

    res.json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">data</span>: health,
    });
  } <span class="hljs-keyword">catch</span> (error) {
    res.status(<span class="hljs-number">503</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Service Unavailable"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Health check failed"</span>,
      <span class="hljs-attr">details</span>: error.message,
    });
  }
});

<span class="hljs-comment">// Mount API version</span>
app.use(<span class="hljs-string">"/api/v1"</span>, v1Router);

<span class="hljs-comment">// Root endpoint</span>
app.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Task Management API Server"</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
    <span class="hljs-attr">api</span>: {
      <span class="hljs-attr">v1</span>: <span class="hljs-string">"/api/v1"</span>,
      <span class="hljs-attr">documentation</span>: <span class="hljs-string">"/api/v1/docs"</span>,
      <span class="hljs-attr">health</span>: <span class="hljs-string">"/api/v1/health"</span>,
    },
    <span class="hljs-attr">status</span>: <span class="hljs-string">"running"</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
  });
});

<span class="hljs-comment">// 404 handler</span>
app.use(<span class="hljs-string">"*"</span>, (req, res) =&gt; {
  res.status(<span class="hljs-number">404</span>).json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">error</span>: <span class="hljs-string">"Not Found"</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">`Route <span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.originalUrl}</span> not found`</span>,
    <span class="hljs-attr">availableEndpoints</span>: {
      <span class="hljs-attr">api</span>: <span class="hljs-string">"/api/v1"</span>,
      <span class="hljs-attr">tasks</span>: <span class="hljs-string">"/api/v1/tasks"</span>,
      <span class="hljs-attr">users</span>: <span class="hljs-string">"/api/v1/users"</span>,
      <span class="hljs-attr">projects</span>: <span class="hljs-string">"/api/v1/projects"</span>,
      <span class="hljs-attr">health</span>: <span class="hljs-string">"/api/v1/health"</span>,
    },
  });
});

<span class="hljs-comment">// Global error handler</span>
app.use(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Global error handler:"</span>, err);

  <span class="hljs-comment">// Handle specific error types</span>
  <span class="hljs-keyword">if</span> (err.type === <span class="hljs-string">"entity.parse.failed"</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Bad Request"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Invalid JSON in request body"</span>,
    });
  }

  <span class="hljs-keyword">if</span> (err.type === <span class="hljs-string">"entity.too.large"</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">413</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Payload Too Large"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Request body exceeds size limit"</span>,
    });
  }

  <span class="hljs-keyword">if</span> (err.code === <span class="hljs-string">"ENOENT"</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">500</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal Server Error"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">"File system error occurred"</span>,
    });
  }

  res.status(err.status || <span class="hljs-number">500</span>).json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">error</span>: err.status === <span class="hljs-number">500</span> ? <span class="hljs-string">"Internal Server Error"</span> : err.name || <span class="hljs-string">"Error"</span>,
    <span class="hljs-attr">message</span>:
      process.env.NODE_ENV === <span class="hljs-string">"production"</span>
        ? <span class="hljs-string">"An error occurred while processing your request"</span>
        : err.message,
    ...(process.env.NODE_ENV !== <span class="hljs-string">"production"</span> &amp;&amp; { <span class="hljs-attr">stack</span>: err.stack }),
  });
});

<span class="hljs-comment">// Graceful shutdown</span>
process.on(<span class="hljs-string">"SIGTERM"</span>, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"SIGTERM received, shutting down gracefully"</span>);
  server.close(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Process terminated"</span>);
  });
});

process.on(<span class="hljs-string">"SIGINT"</span>, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"SIGINT received, shutting down gracefully"</span>);
  server.close(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Process terminated"</span>);
  });
});

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
<span class="hljs-keyword">const</span> server = app.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🚀 Task Management API Server running on port <span class="hljs-subst">${PORT}</span>`</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`📚 API Documentation: http://localhost:<span class="hljs-subst">${PORT}</span>/api/v1/docs`</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🏥 Health Check: http://localhost:<span class="hljs-subst">${PORT}</span>/api/v1/health`</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`📋 Tasks API: http://localhost:<span class="hljs-subst">${PORT}</span>/api/v1/tasks`</span>);
});

<span class="hljs-built_in">module</span>.exports = app;
</div></code></pre>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-implement-proper-validation">1. Implement Proper Validation</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Use express-validator for comprehensive validation</span>
<span class="hljs-keyword">const</span> { body, query, param } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express-validator"</span>);

<span class="hljs-comment">// Input sanitization</span>
body(<span class="hljs-string">"title"</span>).trim().escape(),
  body(<span class="hljs-string">"email"</span>).normalizeEmail(),
  <span class="hljs-comment">// Custom validation</span>
  body(<span class="hljs-string">"dueDate"</span>).custom(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(value) &lt; <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Due date cannot be in the past"</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  });
</div></code></pre>
<h3 id="2-use-consistent-error-handling">2. Use Consistent Error Handling</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Async error wrapper</span>
<span class="hljs-keyword">const</span> asyncHandler = <span class="hljs-function">(<span class="hljs-params">fn</span>) =&gt;</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">Promise</span>.resolve(fn(req, res, next)).catch(next);
};

<span class="hljs-comment">// Centralized error handling</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Error</span> </span>{
  <span class="hljs-keyword">constructor</span>(message, statusCode) {
    <span class="hljs-keyword">super</span>(message);
    <span class="hljs-keyword">this</span>.statusCode = statusCode;
    <span class="hljs-keyword">this</span>.isOperational = <span class="hljs-literal">true</span>;
  }
}
</div></code></pre>
<h3 id="3-implement-pagination-and-filtering">3. Implement Pagination and Filtering</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Cursor-based pagination for large datasets</span>
<span class="hljs-keyword">const</span> paginateResults = <span class="hljs-function">(<span class="hljs-params">data, cursor, limit</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> startIndex = cursor
    ? data.findIndex(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.id === cursor) + <span class="hljs-number">1</span>
    : <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> endIndex = startIndex + limit;
  <span class="hljs-keyword">const</span> results = data.slice(startIndex, endIndex);

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">data</span>: results,
    <span class="hljs-attr">hasNext</span>: endIndex &lt; data.length,
    <span class="hljs-attr">nextCursor</span>: results.length &gt; <span class="hljs-number">0</span> ? results[results.length - <span class="hljs-number">1</span>].id : <span class="hljs-literal">null</span>,
  };
};
</div></code></pre>
<h3 id="4-add-requestresponse-logging">4. Add Request/Response Logging</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Custom logging middleware</span>
<span class="hljs-keyword">const</span> requestLogger = <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> start = <span class="hljs-built_in">Date</span>.now();

  res.on(<span class="hljs-string">"finish"</span>, () =&gt; {
    <span class="hljs-keyword">const</span> duration = <span class="hljs-built_in">Date</span>.now() - start;
    <span class="hljs-built_in">console</span>.log(
      <span class="hljs-string">`<span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.originalUrl}</span> - <span class="hljs-subst">${res.statusCode}</span> - <span class="hljs-subst">${duration}</span>ms`</span>
    );
  });

  next();
};
</div></code></pre>
<h3 id="5-implement-data-persistence">5. Implement Data Persistence</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// File-based persistence with atomic writes</span>
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>).promises;
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileStorage</span> </span>{
  <span class="hljs-keyword">async</span> saveData(filename, data) {
    <span class="hljs-keyword">const</span> tempFile = <span class="hljs-string">`<span class="hljs-subst">${filename}</span>.tmp`</span>;
    <span class="hljs-keyword">await</span> fs.writeFile(tempFile, <span class="hljs-built_in">JSON</span>.stringify(data, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
    <span class="hljs-keyword">await</span> fs.rename(tempFile, filename);
  }

  <span class="hljs-keyword">async</span> loadData(filename) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> fs.readFile(filename, <span class="hljs-string">"utf8"</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse(data);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (error.code === <span class="hljs-string">"ENOENT"</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// File doesn't exist</span>
      }
      <span class="hljs-keyword">throw</span> error;
    }
  }
}
</div></code></pre>
<h2 id="summary">Summary</h2>
<p>CRUD operations form the foundation of data-driven applications in Express.js:</p>
<p><strong>Core CRUD Operations</strong>:</p>
<ul>
<li><strong>Create</strong>: POST requests with validation and error handling</li>
<li><strong>Read</strong>: GET requests with filtering, sorting, and pagination</li>
<li><strong>Update</strong>: PUT (full) and PATCH (partial) with validation</li>
<li><strong>Delete</strong>: DELETE requests with proper cleanup</li>
</ul>
<p><strong>Advanced Features</strong>:</p>
<ul>
<li><strong>Bulk operations</strong>: Handle multiple records efficiently</li>
<li><strong>Search and filtering</strong>: Query parameters for data retrieval</li>
<li><strong>Analytics</strong>: Built-in reporting and statistics</li>
<li><strong>Validation</strong>: Comprehensive input validation and sanitization</li>
<li><strong>Error handling</strong>: Consistent error responses and logging</li>
</ul>
<p><strong>Best Practices</strong>:</p>
<ul>
<li>Use proper HTTP methods and status codes</li>
<li>Implement comprehensive validation</li>
<li>Add pagination for large datasets</li>
<li>Use consistent response formats</li>
<li>Handle errors gracefully</li>
<li>Add request/response logging</li>
<li>Implement data persistence strategies</li>
</ul>
<p><strong>Benefits</strong>:</p>
<ul>
<li><strong>Scalable</strong>: Handle growing data requirements</li>
<li><strong>Maintainable</strong>: Clear separation of concerns</li>
<li><strong>Robust</strong>: Comprehensive error handling and validation</li>
<li><strong>Flexible</strong>: Support for various query patterns</li>
<li><strong>Performance</strong>: Efficient data operations and caching</li>
</ul>
<p>Mastering CRUD operations is essential for building robust web applications. Next, we'll explore middleware in Express.js, which provides powerful ways to process requests and responses throughout the application lifecycle.</p>
<h1 id="middleware-in-expressjs">Middleware in Express.js</h1>
<h2 id="overview">Overview</h2>
<p>Middleware functions are the backbone of Express.js applications. They are functions that have access to the request object (<code>req</code>), response object (<code>res</code>), and the next middleware function in the application's request-response cycle. Middleware can execute code, modify request and response objects, end the request-response cycle, or call the next middleware in the stack. Understanding middleware is crucial for building scalable and maintainable Express applications.</p>
<h2 id="key-concepts">Key Concepts</h2>
<h3 id="what-is-middleware">What is Middleware?</h3>
<p><strong>Middleware Function</strong>: A function that sits between the raw HTTP request and the final route handler, processing the request and response objects.</p>
<p><strong>Middleware Stack</strong>: The sequence of middleware functions that execute in order during request processing.</p>
<p><strong>Next Function</strong>: A function that passes control to the next middleware function. If not called, the request will be left hanging.</p>
<h3 id="types-of-middleware">Types of Middleware</h3>
<ol>
<li><strong>Application-level middleware</strong>: Bound to the app object</li>
<li><strong>Router-level middleware</strong>: Bound to router instances</li>
<li><strong>Error-handling middleware</strong>: Special middleware for handling errors</li>
<li><strong>Built-in middleware</strong>: Provided by Express (e.g., <code>express.static</code>)</li>
<li><strong>Third-party middleware</strong>: External packages (e.g., <code>cors</code>, <code>helmet</code>)</li>
</ol>
<h3 id="middleware-execution-order">Middleware Execution Order</h3>
<p>Middleware executes in the order it's defined:</p>
<ol>
<li>Application-level middleware</li>
<li>Router-level middleware</li>
<li>Route handlers</li>
<li>Error-handling middleware</li>
</ol>
<h2 id="example-code">Example Code</h2>
<h3 id="basic-middleware-concepts">Basic Middleware Concepts</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// middleware/logger.js - Custom Logging Middleware</span>
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>).promises;
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Logger</span> </span>{
  <span class="hljs-keyword">constructor</span>(options = {}) {
    <span class="hljs-keyword">this</span>.logFile =
      options.logFile || path.join(__dirname, <span class="hljs-string">"../logs/access.log"</span>);
    <span class="hljs-keyword">this</span>.format = options.format || <span class="hljs-string">"combined"</span>;
    <span class="hljs-keyword">this</span>.enableConsole = options.enableConsole !== <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.enableFile = options.enableFile !== <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.ensureLogDirectory();
  }

  <span class="hljs-keyword">async</span> ensureLogDirectory() {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> logDir = path.dirname(<span class="hljs-keyword">this</span>.logFile);
      <span class="hljs-keyword">await</span> fs.mkdir(logDir, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Failed to create log directory:"</span>, error);
    }
  }

  formatLog(req, res, responseTime) {
    <span class="hljs-keyword">const</span> timestamp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString();
    <span class="hljs-keyword">const</span> method = req.method;
    <span class="hljs-keyword">const</span> url = req.originalUrl || req.url;
    <span class="hljs-keyword">const</span> status = res.statusCode;
    <span class="hljs-keyword">const</span> userAgent = req.get(<span class="hljs-string">"User-Agent"</span>) || <span class="hljs-string">"-"</span>;
    <span class="hljs-keyword">const</span> ip = req.ip || req.connection.remoteAddress;
    <span class="hljs-keyword">const</span> contentLength = res.get(<span class="hljs-string">"Content-Length"</span>) || <span class="hljs-string">"-"</span>;

    <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>.format) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"simple"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${timestamp}</span> <span class="hljs-subst">${method}</span> <span class="hljs-subst">${url}</span> <span class="hljs-subst">${status}</span> <span class="hljs-subst">${responseTime}</span>ms`</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">"combined"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${ip}</span> - - [<span class="hljs-subst">${timestamp}</span>] "<span class="hljs-subst">${method}</span> <span class="hljs-subst">${url}</span> HTTP/1.1" <span class="hljs-subst">${status}</span> <span class="hljs-subst">${contentLength}</span> "-" "<span class="hljs-subst">${userAgent}</span>" <span class="hljs-subst">${responseTime}</span>ms`</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">"json"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.stringify({
          timestamp,
          method,
          url,
          status,
          responseTime,
          ip,
          userAgent,
          contentLength,
        });
      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${timestamp}</span> <span class="hljs-subst">${method}</span> <span class="hljs-subst">${url}</span> <span class="hljs-subst">${status}</span> <span class="hljs-subst">${responseTime}</span>ms`</span>;
    }
  }

  middleware() {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> startTime = <span class="hljs-built_in">Date</span>.now();

      <span class="hljs-comment">// Capture the original end function</span>
      <span class="hljs-keyword">const</span> originalEnd = res.end;

      <span class="hljs-comment">// Override the end function to log when response is sent</span>
      res.end = <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> responseTime = <span class="hljs-built_in">Date</span>.now() - startTime;
        <span class="hljs-keyword">const</span> logEntry = <span class="hljs-keyword">this</span>.formatLog(req, res, responseTime);

        <span class="hljs-comment">// Log to console</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.enableConsole) {
          <span class="hljs-built_in">console</span>.log(logEntry);
        }

        <span class="hljs-comment">// Log to file</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.enableFile) {
          <span class="hljs-keyword">this</span>.writeToFile(logEntry);
        }

        <span class="hljs-comment">// Call the original end function</span>
        originalEnd.apply(res, args);
      };

      next();
    };
  }

  <span class="hljs-keyword">async</span> writeToFile(logEntry) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> fs.appendFile(<span class="hljs-keyword">this</span>.logFile, logEntry + <span class="hljs-string">"\n"</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Failed to write to log file:"</span>, error);
    }
  }
}

<span class="hljs-built_in">module</span>.exports = Logger;
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">// middleware/auth.js - Authentication Middleware</span>
<span class="hljs-keyword">const</span> jwt = <span class="hljs-built_in">require</span>(<span class="hljs-string">"jsonwebtoken"</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthMiddleware</span> </span>{
  <span class="hljs-keyword">constructor</span>(options = {}) {
    <span class="hljs-keyword">this</span>.secret = options.secret || process.env.JWT_SECRET || <span class="hljs-string">"default-secret"</span>;
    <span class="hljs-keyword">this</span>.algorithms = options.algorithms || [<span class="hljs-string">"HS256"</span>];
    <span class="hljs-keyword">this</span>.expiresIn = options.expiresIn || <span class="hljs-string">"24h"</span>;
    <span class="hljs-keyword">this</span>.issuer = options.issuer || <span class="hljs-string">"task-api"</span>;
  }

  <span class="hljs-comment">// Generate JWT token</span>
  generateToken(payload) {
    <span class="hljs-keyword">return</span> jwt.sign({ ...payload, <span class="hljs-attr">iss</span>: <span class="hljs-keyword">this</span>.issuer }, <span class="hljs-keyword">this</span>.secret, {
      <span class="hljs-attr">expiresIn</span>: <span class="hljs-keyword">this</span>.expiresIn,
      <span class="hljs-attr">algorithm</span>: <span class="hljs-keyword">this</span>.algorithms[<span class="hljs-number">0</span>],
    });
  }

  <span class="hljs-comment">// Verify JWT token</span>
  verifyToken(token) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> jwt.verify(token, <span class="hljs-keyword">this</span>.secret, {
        <span class="hljs-attr">algorithms</span>: <span class="hljs-keyword">this</span>.algorithms,
        <span class="hljs-attr">issuer</span>: <span class="hljs-keyword">this</span>.issuer,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Token verification failed: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Extract token from request</span>
  extractToken(req) {
    <span class="hljs-comment">// Check Authorization header</span>
    <span class="hljs-keyword">const</span> authHeader = req.headers.authorization;
    <span class="hljs-keyword">if</span> (authHeader &amp;&amp; authHeader.startsWith(<span class="hljs-string">"Bearer "</span>)) {
      <span class="hljs-keyword">return</span> authHeader.substring(<span class="hljs-number">7</span>);
    }

    <span class="hljs-comment">// Check query parameter</span>
    <span class="hljs-keyword">if</span> (req.query.token) {
      <span class="hljs-keyword">return</span> req.query.token;
    }

    <span class="hljs-comment">// Check cookies</span>
    <span class="hljs-keyword">if</span> (req.cookies &amp;&amp; req.cookies.token) {
      <span class="hljs-keyword">return</span> req.cookies.token;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }

  <span class="hljs-comment">// Authentication middleware</span>
  authenticate() {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> token = <span class="hljs-keyword">this</span>.extractToken(req);

        <span class="hljs-keyword">if</span> (!token) {
          <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({
            <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">error</span>: <span class="hljs-string">"Unauthorized"</span>,
            <span class="hljs-attr">message</span>: <span class="hljs-string">"Access token is required"</span>,
          });
        }

        <span class="hljs-keyword">const</span> decoded = <span class="hljs-keyword">this</span>.verifyToken(token);
        req.user = decoded;
        next();
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Unauthorized"</span>,
          <span class="hljs-attr">message</span>: error.message,
        });
      }
    };
  }

  <span class="hljs-comment">// Authorization middleware (role-based)</span>
  authorize(roles = []) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!req.user) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Unauthorized"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">"Authentication required"</span>,
        });
      }

      <span class="hljs-keyword">if</span> (roles.length &gt; <span class="hljs-number">0</span> &amp;&amp; !roles.includes(req.user.role)) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">403</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Forbidden"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">"Insufficient permissions"</span>,
        });
      }

      next();
    };
  }

  <span class="hljs-comment">// Optional authentication (doesn't fail if no token)</span>
  optionalAuth() {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> token = <span class="hljs-keyword">this</span>.extractToken(req);

        <span class="hljs-keyword">if</span> (token) {
          <span class="hljs-keyword">const</span> decoded = <span class="hljs-keyword">this</span>.verifyToken(token);
          req.user = decoded;
        }
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-comment">// Ignore token errors for optional auth</span>
        <span class="hljs-built_in">console</span>.warn(<span class="hljs-string">"Optional auth token error:"</span>, error.message);
      }

      next();
    };
  }
}

<span class="hljs-built_in">module</span>.exports = AuthMiddleware;
</div></code></pre>
<h3 id="validation-middleware">Validation Middleware</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// middleware/validation.js - Request Validation Middleware</span>
<span class="hljs-keyword">const</span> { validationResult } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express-validator"</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ValidationMiddleware</span> </span>{
  <span class="hljs-comment">// Handle validation errors</span>
  <span class="hljs-keyword">static</span> handleValidationErrors(req, res, next) {
    <span class="hljs-keyword">const</span> errors = validationResult(req);

    <span class="hljs-keyword">if</span> (!errors.isEmpty()) {
      <span class="hljs-keyword">const</span> formattedErrors = errors.array().map(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> ({
        <span class="hljs-attr">field</span>: error.path || error.param,
        <span class="hljs-attr">message</span>: error.msg,
        <span class="hljs-attr">value</span>: error.value,
        <span class="hljs-attr">location</span>: error.location,
      }));

      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">422</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Validation Error"</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Invalid input data"</span>,
        <span class="hljs-attr">details</span>: formattedErrors,
      });
    }

    next();
  }

  <span class="hljs-comment">// Sanitize request data</span>
  <span class="hljs-keyword">static</span> sanitizeRequest(req, res, next) {
    <span class="hljs-comment">// Remove undefined and null values from body</span>
    <span class="hljs-keyword">if</span> (req.body &amp;&amp; <span class="hljs-keyword">typeof</span> req.body === <span class="hljs-string">"object"</span>) {
      <span class="hljs-built_in">Object</span>.keys(req.body).forEach(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (req.body[key] === <span class="hljs-literal">undefined</span> || req.body[key] === <span class="hljs-literal">null</span>) {
          <span class="hljs-keyword">delete</span> req.body[key];
        }

        <span class="hljs-comment">// Trim string values</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> req.body[key] === <span class="hljs-string">"string"</span>) {
          req.body[key] = req.body[key].trim();
        }
      });
    }

    next();
  }

  <span class="hljs-comment">// Content type validation</span>
  <span class="hljs-keyword">static</span> validateContentType(allowedTypes = [<span class="hljs-string">"application/json"</span>]) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (req.method === <span class="hljs-string">"GET"</span> || req.method === <span class="hljs-string">"DELETE"</span>) {
        <span class="hljs-keyword">return</span> next();
      }

      <span class="hljs-keyword">const</span> contentType = req.get(<span class="hljs-string">"Content-Type"</span>);

      <span class="hljs-keyword">if</span> (!contentType) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Bad Request"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">"Content-Type header is required"</span>,
        });
      }

      <span class="hljs-keyword">const</span> isValidType = allowedTypes.some(<span class="hljs-function">(<span class="hljs-params">type</span>) =&gt;</span>
        contentType.toLowerCase().includes(type.toLowerCase())
      );

      <span class="hljs-keyword">if</span> (!isValidType) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">415</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Unsupported Media Type"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">`Content-Type must be one of: <span class="hljs-subst">${allowedTypes.join(<span class="hljs-string">", "</span>)}</span>`</span>,
        });
      }

      next();
    };
  }

  <span class="hljs-comment">// Request size validation</span>
  <span class="hljs-keyword">static</span> validateRequestSize(maxSize = <span class="hljs-string">"10mb"</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> contentLength = req.get(<span class="hljs-string">"Content-Length"</span>);

      <span class="hljs-keyword">if</span> (contentLength) {
        <span class="hljs-keyword">const</span> sizeInBytes = <span class="hljs-built_in">parseInt</span>(contentLength);
        <span class="hljs-keyword">const</span> maxSizeInBytes = <span class="hljs-keyword">this</span>.parseSize(maxSize);

        <span class="hljs-keyword">if</span> (sizeInBytes &gt; maxSizeInBytes) {
          <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">413</span>).json({
            <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">error</span>: <span class="hljs-string">"Payload Too Large"</span>,
            <span class="hljs-attr">message</span>: <span class="hljs-string">`Request size exceeds maximum allowed size of <span class="hljs-subst">${maxSize}</span>`</span>,
          });
        }
      }

      next();
    };
  }

  <span class="hljs-keyword">static</span> parseSize(size) {
    <span class="hljs-keyword">const</span> units = {
      <span class="hljs-attr">b</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">kb</span>: <span class="hljs-number">1024</span>,
      <span class="hljs-attr">mb</span>: <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>,
      <span class="hljs-attr">gb</span>: <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>,
    };

    <span class="hljs-keyword">const</span> match = size.toLowerCase().match(<span class="hljs-regexp">/^(\d+)([a-z]+)$/</span>);
    <span class="hljs-keyword">if</span> (!match) <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseInt</span>(size);

    <span class="hljs-keyword">const</span> [, number, unit] = match;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseInt</span>(number) * (units[unit] || <span class="hljs-number">1</span>);
  }
}

<span class="hljs-built_in">module</span>.exports = ValidationMiddleware;
</div></code></pre>
<h3 id="error-handling-middleware">Error Handling Middleware</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// middleware/errorHandler.js - Comprehensive Error Handling</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ErrorHandler</span> </span>{
  <span class="hljs-keyword">constructor</span>(options = {}) {
    <span class="hljs-keyword">this</span>.includeStack =
      options.includeStack || process.env.NODE_ENV !== <span class="hljs-string">"production"</span>;
    <span class="hljs-keyword">this</span>.logErrors = options.logErrors !== <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.logger = options.logger || <span class="hljs-built_in">console</span>;
  }

  <span class="hljs-comment">// Main error handling middleware</span>
  handle() {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {
      <span class="hljs-comment">// Log error</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.logErrors) {
        <span class="hljs-keyword">this</span>.logError(err, req);
      }

      <span class="hljs-comment">// Handle different error types</span>
      <span class="hljs-keyword">if</span> (err.name === <span class="hljs-string">"ValidationError"</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.handleValidationError(err, res);
      }

      <span class="hljs-keyword">if</span> (err.name === <span class="hljs-string">"CastError"</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.handleCastError(err, res);
      }

      <span class="hljs-keyword">if</span> (err.code === <span class="hljs-number">11000</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.handleDuplicateError(err, res);
      }

      <span class="hljs-keyword">if</span> (err.name === <span class="hljs-string">"JsonWebTokenError"</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.handleJWTError(err, res);
      }

      <span class="hljs-keyword">if</span> (err.name === <span class="hljs-string">"TokenExpiredError"</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.handleTokenExpiredError(err, res);
      }

      <span class="hljs-keyword">if</span> (err.type === <span class="hljs-string">"entity.parse.failed"</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.handleJSONParseError(err, res);
      }

      <span class="hljs-keyword">if</span> (err.type === <span class="hljs-string">"entity.too.large"</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.handlePayloadTooLargeError(err, res);
      }

      <span class="hljs-comment">// Handle operational errors</span>
      <span class="hljs-keyword">if</span> (err.isOperational) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.handleOperationalError(err, res);
      }

      <span class="hljs-comment">// Handle programming errors</span>
      <span class="hljs-keyword">this</span>.handleProgrammingError(err, res);
    };
  }

  logError(err, req) {
    <span class="hljs-keyword">const</span> errorInfo = {
      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
      <span class="hljs-attr">method</span>: req.method,
      <span class="hljs-attr">url</span>: req.originalUrl,
      <span class="hljs-attr">ip</span>: req.ip,
      <span class="hljs-attr">userAgent</span>: req.get(<span class="hljs-string">"User-Agent"</span>),
      <span class="hljs-attr">error</span>: {
        <span class="hljs-attr">name</span>: err.name,
        <span class="hljs-attr">message</span>: err.message,
        <span class="hljs-attr">stack</span>: err.stack,
      },
      <span class="hljs-attr">user</span>: req.user ? { <span class="hljs-attr">id</span>: req.user.id, <span class="hljs-attr">role</span>: req.user.role } : <span class="hljs-literal">null</span>,
    };

    <span class="hljs-keyword">this</span>.logger.error(<span class="hljs-string">"Application Error:"</span>, <span class="hljs-built_in">JSON</span>.stringify(errorInfo, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
  }

  handleValidationError(err, res) {
    <span class="hljs-keyword">const</span> errors = <span class="hljs-built_in">Object</span>.values(err.errors).map(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> ({
      <span class="hljs-attr">field</span>: error.path,
      <span class="hljs-attr">message</span>: error.message,
      <span class="hljs-attr">value</span>: error.value,
    }));

    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">422</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Validation Error"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Invalid input data"</span>,
      <span class="hljs-attr">details</span>: errors,
    });
  }

  handleCastError(err, res) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Bad Request"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">`Invalid <span class="hljs-subst">${err.path}</span>: <span class="hljs-subst">${err.value}</span>`</span>,
    });
  }

  handleDuplicateError(err, res) {
    <span class="hljs-keyword">const</span> field = <span class="hljs-built_in">Object</span>.keys(err.keyValue)[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">const</span> value = err.keyValue[field];

    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">409</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Conflict"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">`<span class="hljs-subst">${field}</span> '<span class="hljs-subst">${value}</span>' already exists`</span>,
    });
  }

  handleJWTError(err, res) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Unauthorized"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Invalid authentication token"</span>,
    });
  }

  handleTokenExpiredError(err, res) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Unauthorized"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Authentication token has expired"</span>,
    });
  }

  handleJSONParseError(err, res) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Bad Request"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Invalid JSON in request body"</span>,
    });
  }

  handlePayloadTooLargeError(err, res) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">413</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Payload Too Large"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Request body exceeds size limit"</span>,
    });
  }

  handleOperationalError(err, res) {
    <span class="hljs-keyword">return</span> res.status(err.statusCode || <span class="hljs-number">500</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: err.name || <span class="hljs-string">"Operational Error"</span>,
      <span class="hljs-attr">message</span>: err.message,
      ...(<span class="hljs-keyword">this</span>.includeStack &amp;&amp; { <span class="hljs-attr">stack</span>: err.stack }),
    });
  }

  handleProgrammingError(err, res) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">500</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal Server Error"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-keyword">this</span>.includeStack ? err.message : <span class="hljs-string">"Something went wrong"</span>,
      ...(<span class="hljs-keyword">this</span>.includeStack &amp;&amp; { <span class="hljs-attr">stack</span>: err.stack }),
    });
  }

  <span class="hljs-comment">// 404 handler</span>
  notFound() {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> error = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(
        <span class="hljs-string">`Route <span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.originalUrl}</span> not found`</span>
      );
      error.statusCode = <span class="hljs-number">404</span>;
      error.isOperational = <span class="hljs-literal">true</span>;
      next(error);
    };
  }
}

<span class="hljs-built_in">module</span>.exports = ErrorHandler;
</div></code></pre>
<h3 id="security-middleware">Security Middleware</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// middleware/security.js - Security Middleware Collection</span>
<span class="hljs-keyword">const</span> rateLimit = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express-rate-limit"</span>);
<span class="hljs-keyword">const</span> slowDown = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express-slow-down"</span>);
<span class="hljs-keyword">const</span> helmet = <span class="hljs-built_in">require</span>(<span class="hljs-string">"helmet"</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityMiddleware</span> </span>{
  <span class="hljs-comment">// Rate limiting</span>
  <span class="hljs-keyword">static</span> createRateLimit(options = {}) {
    <span class="hljs-keyword">return</span> rateLimit({
      <span class="hljs-attr">windowMs</span>: options.windowMs || <span class="hljs-number">15</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 15 minutes</span>
      <span class="hljs-attr">max</span>: options.max || <span class="hljs-number">100</span>, <span class="hljs-comment">// limit each IP to 100 requests per windowMs</span>
      <span class="hljs-attr">message</span>: {
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Too Many Requests"</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Rate limit exceeded. Please try again later."</span>,
        <span class="hljs-attr">retryAfter</span>: <span class="hljs-built_in">Math</span>.ceil(options.windowMs / <span class="hljs-number">1000</span>) || <span class="hljs-number">900</span>,
      },
      <span class="hljs-attr">standardHeaders</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">legacyHeaders</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">handler</span>: <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
        res.status(<span class="hljs-number">429</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Too Many Requests"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">"Rate limit exceeded. Please try again later."</span>,
          <span class="hljs-attr">retryAfter</span>: <span class="hljs-built_in">Math</span>.ceil(options.windowMs / <span class="hljs-number">1000</span>) || <span class="hljs-number">900</span>,
        });
      },
      <span class="hljs-attr">skip</span>: options.skip || <span class="hljs-function">(<span class="hljs-params">(</span>) =&gt;</span> <span class="hljs-literal">false</span>),
    });
  }

  <span class="hljs-comment">// Speed limiting (slow down responses)</span>
  <span class="hljs-keyword">static</span> createSpeedLimit(options = {}) {
    <span class="hljs-keyword">return</span> slowDown({
      <span class="hljs-attr">windowMs</span>: options.windowMs || <span class="hljs-number">15</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 15 minutes</span>
      <span class="hljs-attr">delayAfter</span>: options.delayAfter || <span class="hljs-number">50</span>, <span class="hljs-comment">// allow 50 requests per windowMs without delay</span>
      <span class="hljs-attr">delayMs</span>: options.delayMs || <span class="hljs-number">500</span>, <span class="hljs-comment">// add 500ms delay per request after delayAfter</span>
      <span class="hljs-attr">maxDelayMs</span>: options.maxDelayMs || <span class="hljs-number">20000</span>, <span class="hljs-comment">// max delay of 20 seconds</span>
      <span class="hljs-attr">skipFailedRequests</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">skipSuccessfulRequests</span>: <span class="hljs-literal">false</span>,
    });
  }

  <span class="hljs-comment">// CORS configuration</span>
  <span class="hljs-keyword">static</span> configureCORS(options = {}) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> allowedOrigins = options.origins || [
        <span class="hljs-string">"http://localhost:3000"</span>,
        <span class="hljs-string">"http://localhost:3001"</span>,
        <span class="hljs-string">"https://yourdomain.com"</span>,
      ];

      <span class="hljs-keyword">const</span> origin = req.headers.origin;

      <span class="hljs-keyword">if</span> (allowedOrigins.includes(origin) || !origin) {
        res.setHeader(<span class="hljs-string">"Access-Control-Allow-Origin"</span>, origin || <span class="hljs-string">"*"</span>);
      }

      res.setHeader(
        <span class="hljs-string">"Access-Control-Allow-Methods"</span>,
        <span class="hljs-string">"GET, POST, PUT, PATCH, DELETE, OPTIONS"</span>
      );
      res.setHeader(
        <span class="hljs-string">"Access-Control-Allow-Headers"</span>,
        <span class="hljs-string">"Content-Type, Authorization, X-Requested-With"</span>
      );
      res.setHeader(<span class="hljs-string">"Access-Control-Allow-Credentials"</span>, <span class="hljs-string">"true"</span>);
      res.setHeader(<span class="hljs-string">"Access-Control-Max-Age"</span>, <span class="hljs-string">"86400"</span>); <span class="hljs-comment">// 24 hours</span>

      <span class="hljs-keyword">if</span> (req.method === <span class="hljs-string">"OPTIONS"</span>) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">200</span>).end();
      }

      next();
    };
  }

  <span class="hljs-comment">// Security headers</span>
  <span class="hljs-keyword">static</span> securityHeaders() {
    <span class="hljs-keyword">return</span> helmet({
      <span class="hljs-attr">contentSecurityPolicy</span>: {
        <span class="hljs-attr">directives</span>: {
          <span class="hljs-attr">defaultSrc</span>: [<span class="hljs-string">"'self'"</span>],
          <span class="hljs-attr">styleSrc</span>: [<span class="hljs-string">"'self'"</span>, <span class="hljs-string">"'unsafe-inline'"</span>],
          <span class="hljs-attr">scriptSrc</span>: [<span class="hljs-string">"'self'"</span>],
          <span class="hljs-attr">imgSrc</span>: [<span class="hljs-string">"'self'"</span>, <span class="hljs-string">"data:"</span>, <span class="hljs-string">"https:"</span>],
          <span class="hljs-attr">connectSrc</span>: [<span class="hljs-string">"'self'"</span>],
          <span class="hljs-attr">fontSrc</span>: [<span class="hljs-string">"'self'"</span>],
          <span class="hljs-attr">objectSrc</span>: [<span class="hljs-string">"'none'"</span>],
          <span class="hljs-attr">mediaSrc</span>: [<span class="hljs-string">"'self'"</span>],
          <span class="hljs-attr">frameSrc</span>: [<span class="hljs-string">"'none'"</span>],
        },
      },
      <span class="hljs-attr">crossOriginEmbedderPolicy</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">hsts</span>: {
        <span class="hljs-attr">maxAge</span>: <span class="hljs-number">31536000</span>,
        <span class="hljs-attr">includeSubDomains</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">preload</span>: <span class="hljs-literal">true</span>,
      },
    });
  }

  <span class="hljs-comment">// IP whitelist/blacklist</span>
  <span class="hljs-keyword">static</span> ipFilter(options = {}) {
    <span class="hljs-keyword">const</span> whitelist = options.whitelist || [];
    <span class="hljs-keyword">const</span> blacklist = options.blacklist || [];

    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> clientIP = req.ip || req.connection.remoteAddress;

      <span class="hljs-comment">// Check blacklist first</span>
      <span class="hljs-keyword">if</span> (blacklist.length &gt; <span class="hljs-number">0</span> &amp;&amp; blacklist.includes(clientIP)) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">403</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Forbidden"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">"Access denied from this IP address"</span>,
        });
      }

      <span class="hljs-comment">// Check whitelist if defined</span>
      <span class="hljs-keyword">if</span> (whitelist.length &gt; <span class="hljs-number">0</span> &amp;&amp; !whitelist.includes(clientIP)) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">403</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Forbidden"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">"Access denied from this IP address"</span>,
        });
      }

      next();
    };
  }

  <span class="hljs-comment">// Request sanitization</span>
  <span class="hljs-keyword">static</span> sanitizeRequest() {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
      <span class="hljs-comment">// Remove potentially dangerous characters</span>
      <span class="hljs-keyword">const</span> sanitize = <span class="hljs-function">(<span class="hljs-params">obj</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">"string"</span>) {
          <span class="hljs-keyword">return</span> obj
            .replace(<span class="hljs-regexp">/&lt;script[^&gt;]*&gt;.*?&lt;\/script&gt;/gi</span>, <span class="hljs-string">""</span>)
            .replace(<span class="hljs-regexp">/&lt;[^&gt;]*&gt;/g</span>, <span class="hljs-string">""</span>)
            .replace(<span class="hljs-regexp">/javascript:/gi</span>, <span class="hljs-string">""</span>)
            .replace(<span class="hljs-regexp">/on\w+=/gi</span>, <span class="hljs-string">""</span>);
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">"object"</span> &amp;&amp; obj !== <span class="hljs-literal">null</span>) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj) {
            obj[key] = sanitize(obj[key]);
          }
        }

        <span class="hljs-keyword">return</span> obj;
      };

      <span class="hljs-keyword">if</span> (req.body) {
        req.body = sanitize(req.body);
      }

      <span class="hljs-keyword">if</span> (req.query) {
        req.query = sanitize(req.query);
      }

      <span class="hljs-keyword">if</span> (req.params) {
        req.params = sanitize(req.params);
      }

      next();
    };
  }
}

<span class="hljs-built_in">module</span>.exports = SecurityMiddleware;
</div></code></pre>
<h3 id="complete-middleware-application">Complete Middleware Application</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// app.js - Application with Comprehensive Middleware</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> cookieParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">"cookie-parser"</span>);
<span class="hljs-keyword">const</span> compression = <span class="hljs-built_in">require</span>(<span class="hljs-string">"compression"</span>);

<span class="hljs-comment">// Custom middleware</span>
<span class="hljs-keyword">const</span> Logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./middleware/logger"</span>);
<span class="hljs-keyword">const</span> AuthMiddleware = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./middleware/auth"</span>);
<span class="hljs-keyword">const</span> ValidationMiddleware = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./middleware/validation"</span>);
<span class="hljs-keyword">const</span> ErrorHandler = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./middleware/errorHandler"</span>);
<span class="hljs-keyword">const</span> SecurityMiddleware = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./middleware/security"</span>);

<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Trust proxy (for accurate IP addresses behind reverse proxy)</span>
app.set(<span class="hljs-string">"trust proxy"</span>, <span class="hljs-number">1</span>);

<span class="hljs-comment">// Initialize middleware instances</span>
<span class="hljs-keyword">const</span> logger = <span class="hljs-keyword">new</span> Logger({
  <span class="hljs-attr">format</span>: <span class="hljs-string">"combined"</span>,
  <span class="hljs-attr">enableConsole</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">enableFile</span>: <span class="hljs-literal">true</span>,
});

<span class="hljs-keyword">const</span> auth = <span class="hljs-keyword">new</span> AuthMiddleware({
  <span class="hljs-attr">secret</span>: process.env.JWT_SECRET,
  <span class="hljs-attr">expiresIn</span>: <span class="hljs-string">"24h"</span>,
});

<span class="hljs-keyword">const</span> errorHandler = <span class="hljs-keyword">new</span> ErrorHandler({
  <span class="hljs-attr">includeStack</span>: process.env.NODE_ENV !== <span class="hljs-string">"production"</span>,
  <span class="hljs-attr">logErrors</span>: <span class="hljs-literal">true</span>,
});

<span class="hljs-comment">// Security middleware (applied first)</span>
app.use(SecurityMiddleware.securityHeaders());
app.use(
  SecurityMiddleware.configureCORS({
    <span class="hljs-attr">origins</span>: process.env.ALLOWED_ORIGINS?.split(<span class="hljs-string">","</span>) || [
      <span class="hljs-string">"http://localhost:3000"</span>,
    ],
  })
);

<span class="hljs-comment">// Rate limiting</span>
app.use(
  <span class="hljs-string">"/api/"</span>,
  SecurityMiddleware.createRateLimit({
    <span class="hljs-attr">windowMs</span>: <span class="hljs-number">15</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 15 minutes</span>
    <span class="hljs-attr">max</span>: <span class="hljs-number">100</span>, <span class="hljs-comment">// requests per window</span>
  })
);

<span class="hljs-comment">// Speed limiting for auth endpoints</span>
app.use(
  <span class="hljs-string">"/api/auth/"</span>,
  SecurityMiddleware.createSpeedLimit({
    <span class="hljs-attr">windowMs</span>: <span class="hljs-number">15</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>,
    <span class="hljs-attr">delayAfter</span>: <span class="hljs-number">5</span>,
    <span class="hljs-attr">delayMs</span>: <span class="hljs-number">1000</span>,
  })
);

<span class="hljs-comment">// Compression</span>
app.use(compression());

<span class="hljs-comment">// Body parsing</span>
app.use(express.json({ <span class="hljs-attr">limit</span>: <span class="hljs-string">"10mb"</span> }));
app.use(express.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">limit</span>: <span class="hljs-string">"10mb"</span> }));
app.use(cookieParser());

<span class="hljs-comment">// Request sanitization</span>
app.use(SecurityMiddleware.sanitizeRequest());

<span class="hljs-comment">// Content type validation for POST/PUT/PATCH</span>
app.use(ValidationMiddleware.validateContentType([<span class="hljs-string">"application/json"</span>]));

<span class="hljs-comment">// Request size validation</span>
app.use(ValidationMiddleware.validateRequestSize(<span class="hljs-string">"10mb"</span>));

<span class="hljs-comment">// Request sanitization</span>
app.use(ValidationMiddleware.sanitizeRequest);

<span class="hljs-comment">// Logging</span>
app.use(logger.middleware());

<span class="hljs-comment">// Custom request context middleware</span>
app.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  req.requestId = <span class="hljs-built_in">require</span>(<span class="hljs-string">"crypto"</span>).randomUUID();
  req.startTime = <span class="hljs-built_in">Date</span>.now();

  <span class="hljs-comment">// Add request ID to response headers</span>
  res.setHeader(<span class="hljs-string">"X-Request-ID"</span>, req.requestId);

  next();
});

<span class="hljs-comment">// API versioning</span>
<span class="hljs-keyword">const</span> v1Router = express.Router();

<span class="hljs-comment">// Authentication routes (no auth required)</span>
v1Router.post(<span class="hljs-string">"/auth/login"</span>, (req, res) =&gt; {
  <span class="hljs-comment">// Mock login logic</span>
  <span class="hljs-keyword">const</span> { username, password } = req.body;

  <span class="hljs-keyword">if</span> (username === <span class="hljs-string">"admin"</span> &amp;&amp; password === <span class="hljs-string">"password"</span>) {
    <span class="hljs-keyword">const</span> token = auth.generateToken({
      <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">username</span>: <span class="hljs-string">"admin"</span>,
      <span class="hljs-attr">role</span>: <span class="hljs-string">"admin"</span>,
    });

    res.json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">data</span>: {
        token,
        <span class="hljs-attr">user</span>: { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">username</span>: <span class="hljs-string">"admin"</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">"admin"</span> },
      },
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Login successful"</span>,
    });
  } <span class="hljs-keyword">else</span> {
    res.status(<span class="hljs-number">401</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Unauthorized"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Invalid credentials"</span>,
    });
  }
});

<span class="hljs-comment">// Protected routes</span>
<span class="hljs-keyword">const</span> protectedRouter = express.Router();

<span class="hljs-comment">// Apply authentication to all protected routes</span>
protectedRouter.use(auth.authenticate());

<span class="hljs-comment">// Import and mount route modules</span>
<span class="hljs-keyword">const</span> taskRoutes = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./routes/tasks"</span>);
<span class="hljs-keyword">const</span> userRoutes = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./routes/users"</span>);

protectedRouter.use(<span class="hljs-string">"/tasks"</span>, taskRoutes);
protectedRouter.use(<span class="hljs-string">"/users"</span>, auth.authorize([<span class="hljs-string">"admin"</span>]), userRoutes);

<span class="hljs-comment">// Mount routers</span>
v1Router.use(<span class="hljs-string">"/"</span>, protectedRouter);

<span class="hljs-comment">// API info endpoint</span>
v1Router.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Task Management API v1"</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
    <span class="hljs-attr">requestId</span>: req.requestId,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
    <span class="hljs-attr">user</span>: req.user || <span class="hljs-literal">null</span>,
  });
});

<span class="hljs-comment">// Mount API version</span>
app.use(<span class="hljs-string">"/api/v1"</span>, v1Router);

<span class="hljs-comment">// Root endpoint</span>
app.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Task Management API Server"</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
    <span class="hljs-attr">requestId</span>: req.requestId,
    <span class="hljs-attr">endpoints</span>: {
      <span class="hljs-attr">api</span>: <span class="hljs-string">"/api/v1"</span>,
      <span class="hljs-attr">auth</span>: <span class="hljs-string">"/api/v1/auth/login"</span>,
      <span class="hljs-attr">tasks</span>: <span class="hljs-string">"/api/v1/tasks"</span>,
      <span class="hljs-attr">users</span>: <span class="hljs-string">"/api/v1/users"</span>,
    },
  });
});

<span class="hljs-comment">// Health check endpoint</span>
app.get(<span class="hljs-string">"/health"</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> healthData = {
    <span class="hljs-attr">status</span>: <span class="hljs-string">"healthy"</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
    <span class="hljs-attr">uptime</span>: process.uptime(),
    <span class="hljs-attr">memory</span>: {
      <span class="hljs-attr">used</span>: <span class="hljs-built_in">Math</span>.round(process.memoryUsage().heapUsed / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>),
      <span class="hljs-attr">total</span>: <span class="hljs-built_in">Math</span>.round(process.memoryUsage().heapTotal / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>),
    },
    <span class="hljs-attr">requestId</span>: req.requestId,
  };

  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: healthData,
  });
});

<span class="hljs-comment">// 404 handler</span>
app.use(errorHandler.notFound());

<span class="hljs-comment">// Global error handler (must be last)</span>
app.use(errorHandler.handle());

<span class="hljs-comment">// Graceful shutdown</span>
process.on(<span class="hljs-string">"SIGTERM"</span>, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"SIGTERM received, shutting down gracefully"</span>);
  server.close(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Process terminated"</span>);
  });
});

<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;
<span class="hljs-keyword">const</span> server = app.listen(PORT, () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🚀 Server running on port <span class="hljs-subst">${PORT}</span>`</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`📚 API: http://localhost:<span class="hljs-subst">${PORT}</span>/api/v1`</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🏥 Health: http://localhost:<span class="hljs-subst">${PORT}</span>/health`</span>);
});

<span class="hljs-built_in">module</span>.exports = app;
</div></code></pre>
<h2 id="real-world-use-case">Real-World Use Case</h2>
<h3 id="e-commerce-api-with-advanced-middleware">E-commerce API with Advanced Middleware</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// middleware/analytics.js - Analytics and Monitoring Middleware</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnalyticsMiddleware</span> </span>{
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.metrics = {
      <span class="hljs-attr">requests</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">errors</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">responseTimeSum</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">endpoints</span>: {},
      <span class="hljs-attr">statusCodes</span>: {},
      <span class="hljs-attr">userAgents</span>: {},
      <span class="hljs-attr">ips</span>: {},
    };

    <span class="hljs-comment">// Reset metrics every hour</span>
    setInterval(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-keyword">this</span>.resetMetrics();
    }, <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);
  }

  middleware() {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> startTime = <span class="hljs-built_in">Date</span>.now();

      <span class="hljs-comment">// Track request</span>
      <span class="hljs-keyword">this</span>.metrics.requests++;

      <span class="hljs-comment">// Track endpoint</span>
      <span class="hljs-keyword">const</span> endpoint = <span class="hljs-string">`<span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.route?.path || req.path}</span>`</span>;
      <span class="hljs-keyword">this</span>.metrics.endpoints[endpoint] =
        (<span class="hljs-keyword">this</span>.metrics.endpoints[endpoint] || <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>;

      <span class="hljs-comment">// Track IP</span>
      <span class="hljs-keyword">const</span> ip = req.ip;
      <span class="hljs-keyword">this</span>.metrics.ips[ip] = (<span class="hljs-keyword">this</span>.metrics.ips[ip] || <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>;

      <span class="hljs-comment">// Track User Agent</span>
      <span class="hljs-keyword">const</span> userAgent = req.get(<span class="hljs-string">"User-Agent"</span>) || <span class="hljs-string">"Unknown"</span>;
      <span class="hljs-keyword">this</span>.metrics.userAgents[userAgent] =
        (<span class="hljs-keyword">this</span>.metrics.userAgents[userAgent] || <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>;

      <span class="hljs-comment">// Override res.end to capture response metrics</span>
      <span class="hljs-keyword">const</span> originalEnd = res.end;
      res.end = <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> responseTime = <span class="hljs-built_in">Date</span>.now() - startTime;

        <span class="hljs-comment">// Track response time</span>
        <span class="hljs-keyword">this</span>.metrics.responseTimeSum += responseTime;

        <span class="hljs-comment">// Track status codes</span>
        <span class="hljs-keyword">const</span> statusCode = res.statusCode;
        <span class="hljs-keyword">this</span>.metrics.statusCodes[statusCode] =
          (<span class="hljs-keyword">this</span>.metrics.statusCodes[statusCode] || <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>;

        <span class="hljs-comment">// Track errors</span>
        <span class="hljs-keyword">if</span> (statusCode &gt;= <span class="hljs-number">400</span>) {
          <span class="hljs-keyword">this</span>.metrics.errors++;
        }

        <span class="hljs-comment">// Add performance headers</span>
        res.setHeader(<span class="hljs-string">"X-Response-Time"</span>, <span class="hljs-string">`<span class="hljs-subst">${responseTime}</span>ms`</span>);

        originalEnd.apply(res, args);
      };

      next();
    };
  }

  getMetrics() {
    <span class="hljs-keyword">const</span> avgResponseTime =
      <span class="hljs-keyword">this</span>.metrics.requests &gt; <span class="hljs-number">0</span>
        ? <span class="hljs-built_in">Math</span>.round(<span class="hljs-keyword">this</span>.metrics.responseTimeSum / <span class="hljs-keyword">this</span>.metrics.requests)
        : <span class="hljs-number">0</span>;

    <span class="hljs-keyword">return</span> {
      ...this.metrics,
      <span class="hljs-attr">averageResponseTime</span>: avgResponseTime,
      <span class="hljs-attr">errorRate</span>:
        <span class="hljs-keyword">this</span>.metrics.requests &gt; <span class="hljs-number">0</span>
          ? <span class="hljs-built_in">Math</span>.round((<span class="hljs-keyword">this</span>.metrics.errors / <span class="hljs-keyword">this</span>.metrics.requests) * <span class="hljs-number">100</span>)
          : <span class="hljs-number">0</span>,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
    };
  }

  resetMetrics() {
    <span class="hljs-keyword">this</span>.metrics = {
      <span class="hljs-attr">requests</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">errors</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">responseTimeSum</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">endpoints</span>: {},
      <span class="hljs-attr">statusCodes</span>: {},
      <span class="hljs-attr">userAgents</span>: {},
      <span class="hljs-attr">ips</span>: {},
    };
  }
}

<span class="hljs-built_in">module</span>.exports = AnalyticsMiddleware;
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">// middleware/cache.js - Response Caching Middleware</span>
<span class="hljs-keyword">const</span> NodeCache = <span class="hljs-built_in">require</span>(<span class="hljs-string">"node-cache"</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CacheMiddleware</span> </span>{
  <span class="hljs-keyword">constructor</span>(options = {}) {
    <span class="hljs-keyword">this</span>.cache = <span class="hljs-keyword">new</span> NodeCache({
      <span class="hljs-attr">stdTTL</span>: options.ttl || <span class="hljs-number">300</span>, <span class="hljs-comment">// 5 minutes default</span>
      <span class="hljs-attr">checkperiod</span>: options.checkperiod || <span class="hljs-number">60</span>, <span class="hljs-comment">// check for expired keys every 60 seconds</span>
      <span class="hljs-attr">useClones</span>: <span class="hljs-literal">false</span>,
    });

    <span class="hljs-keyword">this</span>.defaultTTL = options.ttl || <span class="hljs-number">300</span>;
  }

  <span class="hljs-comment">// Cache GET requests</span>
  cacheGet(ttl = <span class="hljs-keyword">this</span>.defaultTTL) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
      <span class="hljs-comment">// Only cache GET requests</span>
      <span class="hljs-keyword">if</span> (req.method !== <span class="hljs-string">"GET"</span>) {
        <span class="hljs-keyword">return</span> next();
      }

      <span class="hljs-comment">// Create cache key from URL and query parameters</span>
      <span class="hljs-keyword">const</span> cacheKey = <span class="hljs-keyword">this</span>.generateCacheKey(req);

      <span class="hljs-comment">// Check if response is cached</span>
      <span class="hljs-keyword">const</span> cachedResponse = <span class="hljs-keyword">this</span>.cache.get(cacheKey);

      <span class="hljs-keyword">if</span> (cachedResponse) {
        res.setHeader(<span class="hljs-string">"X-Cache"</span>, <span class="hljs-string">"HIT"</span>);
        res.setHeader(<span class="hljs-string">"X-Cache-Key"</span>, cacheKey);
        <span class="hljs-keyword">return</span> res.json(cachedResponse);
      }

      <span class="hljs-comment">// Override res.json to cache the response</span>
      <span class="hljs-keyword">const</span> originalJson = res.json;
      res.json = <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
        <span class="hljs-comment">// Only cache successful responses</span>
        <span class="hljs-keyword">if</span> (res.statusCode &gt;= <span class="hljs-number">200</span> &amp;&amp; res.statusCode &lt; <span class="hljs-number">300</span>) {
          <span class="hljs-keyword">this</span>.cache.set(cacheKey, data, ttl);
          res.setHeader(<span class="hljs-string">"X-Cache"</span>, <span class="hljs-string">"MISS"</span>);
          res.setHeader(<span class="hljs-string">"X-Cache-TTL"</span>, ttl.toString());
        } <span class="hljs-keyword">else</span> {
          res.setHeader(<span class="hljs-string">"X-Cache"</span>, <span class="hljs-string">"SKIP"</span>);
        }

        res.setHeader(<span class="hljs-string">"X-Cache-Key"</span>, cacheKey);
        originalJson.call(res, data);
      };

      next();
    };
  }

  <span class="hljs-comment">// Invalidate cache for specific patterns</span>
  invalidate(pattern) {
    <span class="hljs-keyword">const</span> keys = <span class="hljs-keyword">this</span>.cache.keys();
    <span class="hljs-keyword">const</span> keysToDelete = keys.filter(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> key.includes(pattern));

    keysToDelete.forEach(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
      <span class="hljs-keyword">this</span>.cache.del(key);
    });

    <span class="hljs-keyword">return</span> keysToDelete.length;
  }

  <span class="hljs-comment">// Clear all cache</span>
  clear() {
    <span class="hljs-keyword">this</span>.cache.flushAll();
  }

  <span class="hljs-comment">// Get cache statistics</span>
  getStats() {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">keys</span>: <span class="hljs-keyword">this</span>.cache.keys().length,
      <span class="hljs-attr">hits</span>: <span class="hljs-keyword">this</span>.cache.getStats().hits,
      <span class="hljs-attr">misses</span>: <span class="hljs-keyword">this</span>.cache.getStats().misses,
      <span class="hljs-attr">ksize</span>: <span class="hljs-keyword">this</span>.cache.getStats().ksize,
      <span class="hljs-attr">vsize</span>: <span class="hljs-keyword">this</span>.cache.getStats().vsize,
    };
  }

  generateCacheKey(req) {
    <span class="hljs-keyword">const</span> url = req.originalUrl || req.url;
    <span class="hljs-keyword">const</span> user = req.user ? req.user.id : <span class="hljs-string">"anonymous"</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${user}</span>:<span class="hljs-subst">${url}</span>`</span>;
  }

  <span class="hljs-comment">// Middleware to add cache control headers</span>
  cacheControl(maxAge = <span class="hljs-number">300</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (req.method === <span class="hljs-string">"GET"</span>) {
        res.setHeader(<span class="hljs-string">"Cache-Control"</span>, <span class="hljs-string">`public, max-age=<span class="hljs-subst">${maxAge}</span>`</span>);
        res.setHeader(<span class="hljs-string">"ETag"</span>, <span class="hljs-keyword">this</span>.generateETag(req));
      } <span class="hljs-keyword">else</span> {
        res.setHeader(<span class="hljs-string">"Cache-Control"</span>, <span class="hljs-string">"no-cache, no-store, must-revalidate"</span>);
      }

      next();
    };
  }

  generateETag(req) {
    <span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">"crypto"</span>);
    <span class="hljs-keyword">const</span> content = req.originalUrl + (req.user ? req.user.id : <span class="hljs-string">""</span>);
    <span class="hljs-keyword">return</span> crypto.createHash(<span class="hljs-string">"md5"</span>).update(content).digest(<span class="hljs-string">"hex"</span>);
  }
}

<span class="hljs-built_in">module</span>.exports = CacheMiddleware;
</div></code></pre>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-middleware-order-matters">1. Middleware Order Matters</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Correct order:</span>
app.use(helmet()); <span class="hljs-comment">// Security first</span>
app.use(cors()); <span class="hljs-comment">// CORS before other middleware</span>
app.use(rateLimit); <span class="hljs-comment">// Rate limiting early</span>
app.use(express.json()); <span class="hljs-comment">// Body parsing</span>
app.use(authentication); <span class="hljs-comment">// Auth before routes</span>
app.use(<span class="hljs-string">"/api"</span>, routes); <span class="hljs-comment">// Routes</span>
app.use(errorHandler); <span class="hljs-comment">// Error handling last</span>
</div></code></pre>
<h3 id="2-use-async-middleware-properly">2. Use Async Middleware Properly</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Async middleware wrapper</span>
<span class="hljs-keyword">const</span> asyncMiddleware = <span class="hljs-function">(<span class="hljs-params">fn</span>) =&gt;</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">Promise</span>.resolve(fn(req, res, next)).catch(next);
};

<span class="hljs-comment">// Usage</span>
app.use(
  <span class="hljs-string">"/api/users"</span>,
  asyncMiddleware(<span class="hljs-keyword">async</span> (req, res, next) =&gt; {
    req.user = <span class="hljs-keyword">await</span> getUserFromDatabase(req.headers.authorization);
    next();
  })
);
</div></code></pre>
<h3 id="3-create-reusable-middleware">3. Create Reusable Middleware</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Factory function for creating middleware</span>
<span class="hljs-keyword">const</span> createAuthMiddleware = <span class="hljs-function">(<span class="hljs-params">options = {}</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
    <span class="hljs-comment">// Middleware logic with options</span>
    next();
  };
};

<span class="hljs-comment">// Usage</span>
app.use(<span class="hljs-string">"/admin"</span>, createAuthMiddleware({ <span class="hljs-attr">role</span>: <span class="hljs-string">"admin"</span> }));
app.use(<span class="hljs-string">"/api"</span>, createAuthMiddleware({ <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span> }));
</div></code></pre>
<h3 id="4-handle-errors-properly">4. Handle Errors Properly</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Always call next() with error to trigger error handling</span>
app.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// Middleware logic</span>
    next();
  } <span class="hljs-keyword">catch</span> (error) {
    next(error); <span class="hljs-comment">// Pass error to error handler</span>
  }
});
</div></code></pre>
<h3 id="5-use-conditional-middleware">5. Use Conditional Middleware</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Apply middleware conditionally</span>
<span class="hljs-keyword">const</span> conditionalMiddleware = <span class="hljs-function">(<span class="hljs-params">condition, middleware</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (condition(req)) {
      <span class="hljs-keyword">return</span> middleware(req, res, next);
    }
    next();
  };
};

<span class="hljs-comment">// Usage</span>
app.use(conditionalMiddleware(<span class="hljs-function">(<span class="hljs-params">req</span>) =&gt;</span> req.path.startsWith(<span class="hljs-string">"/api"</span>), rateLimit));
</div></code></pre>
<h2 id="summary">Summary</h2>
<p>Middleware is the foundation of Express.js applications, providing a powerful way to process requests and responses:</p>
<p><strong>Key Concepts</strong>:</p>
<ul>
<li><strong>Middleware Stack</strong>: Functions execute in order</li>
<li><strong>Next Function</strong>: Controls flow to next middleware</li>
<li><strong>Error Handling</strong>: Special middleware for error processing</li>
<li><strong>Types</strong>: Application, router, built-in, third-party, and error-handling</li>
</ul>
<p><strong>Common Middleware Types</strong>:</p>
<ul>
<li><strong>Security</strong>: Authentication, authorization, rate limiting</li>
<li><strong>Logging</strong>: Request/response logging and analytics</li>
<li><strong>Validation</strong>: Input validation and sanitization</li>
<li><strong>Caching</strong>: Response caching and cache control</li>
<li><strong>Error Handling</strong>: Comprehensive error processing</li>
</ul>
<p><strong>Best Practices</strong>:</p>
<ul>
<li>Order middleware correctly</li>
<li>Handle async operations properly</li>
<li>Create reusable middleware factories</li>
<li>Always handle errors</li>
<li>Use conditional middleware when needed</li>
<li>Keep middleware focused and single-purpose</li>
</ul>
<p><strong>Benefits</strong>:</p>
<ul>
<li><strong>Modularity</strong>: Separate concerns into focused functions</li>
<li><strong>Reusability</strong>: Share middleware across routes and applications</li>
<li><strong>Flexibility</strong>: Apply middleware conditionally</li>
<li><strong>Maintainability</strong>: Clear separation of cross-cutting concerns</li>
<li><strong>Testability</strong>: Easy to test individual middleware functions</li>
</ul>
<p>Mastering middleware is essential for building robust, secure, and maintainable Express.js applications. Next, we'll explore database integration with MongoDB and Mongoose, building upon the middleware foundation to create data-driven applications.</p>
<h1 id="database-integration-mongodb-and-mongoose">Database Integration: MongoDB and Mongoose</h1>
<h2 id="overview">Overview</h2>
<p>MongoDB is a popular NoSQL document database that stores data in flexible, JSON-like documents. Mongoose is an Object Document Mapping (ODM) library for MongoDB and Node.js that provides a schema-based solution to model application data. This chapter covers integrating MongoDB with Express.js applications using Mongoose, including schema design, CRUD operations, data validation, and advanced querying.</p>
<h2 id="key-concepts">Key Concepts</h2>
<h3 id="mongodb-fundamentals">MongoDB Fundamentals</h3>
<p><strong>Document Database</strong>: MongoDB stores data in BSON (Binary JSON) documents within collections.</p>
<p><strong>Collections</strong>: Groups of documents, similar to tables in relational databases.</p>
<p><strong>Documents</strong>: Individual records stored as key-value pairs, similar to rows in relational databases.</p>
<p><strong>Schema-less</strong>: Documents in a collection don't need to have the same structure.</p>
<h3 id="mongoose-benefits">Mongoose Benefits</h3>
<p><strong>Schema Definition</strong>: Define structure and validation rules for documents.</p>
<p><strong>Type Casting</strong>: Automatic type conversion and validation.</p>
<p><strong>Middleware</strong>: Pre and post hooks for document operations.</p>
<p><strong>Query Building</strong>: Chainable query API with powerful features.</p>
<p><strong>Population</strong>: Reference other documents and populate them automatically.</p>
<p><strong>Validation</strong>: Built-in and custom validation rules.</p>
<h2 id="example-code">Example Code</h2>
<h3 id="database-connection-setup">Database Connection Setup</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// config/database.js - Database Configuration</span>
<span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">"mongoose"</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseConnection</span> </span>{
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.connection = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.isConnected = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">async</span> connect(options = {}) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> mongoUri =
        options.uri ||
        process.env.MONGODB_URI ||
        <span class="hljs-string">"mongodb://localhost:27017/taskmanager"</span>;

      <span class="hljs-keyword">const</span> connectionOptions = {
        <span class="hljs-attr">useNewUrlParser</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">useUnifiedTopology</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">maxPoolSize</span>: options.maxPoolSize || <span class="hljs-number">10</span>,
        <span class="hljs-attr">serverSelectionTimeoutMS</span>: options.serverSelectionTimeoutMS || <span class="hljs-number">5000</span>,
        <span class="hljs-attr">socketTimeoutMS</span>: options.socketTimeoutMS || <span class="hljs-number">45000</span>,
        <span class="hljs-attr">bufferCommands</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">bufferMaxEntries</span>: <span class="hljs-number">0</span>,
        ...options.mongooseOptions,
      };

      <span class="hljs-keyword">this</span>.connection = <span class="hljs-keyword">await</span> mongoose.connect(mongoUri, connectionOptions);
      <span class="hljs-keyword">this</span>.isConnected = <span class="hljs-literal">true</span>;

      <span class="hljs-built_in">console</span>.log(
        <span class="hljs-string">`✅ MongoDB connected: <span class="hljs-subst">${<span class="hljs-keyword">this</span>.connection.connection.host}</span>:<span class="hljs-subst">${<span class="hljs-keyword">this</span>.connection.connection.port}</span>`</span>
      );
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`📊 Database: <span class="hljs-subst">${<span class="hljs-keyword">this</span>.connection.connection.name}</span>`</span>);

      <span class="hljs-comment">// Connection event listeners</span>
      mongoose.connection.on(<span class="hljs-string">"error"</span>, <span class="hljs-keyword">this</span>.handleError.bind(<span class="hljs-keyword">this</span>));
      mongoose.connection.on(
        <span class="hljs-string">"disconnected"</span>,
        <span class="hljs-keyword">this</span>.handleDisconnected.bind(<span class="hljs-keyword">this</span>)
      );
      mongoose.connection.on(<span class="hljs-string">"reconnected"</span>, <span class="hljs-keyword">this</span>.handleReconnected.bind(<span class="hljs-keyword">this</span>));

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.connection;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"❌ MongoDB connection error:"</span>, error.message);
      <span class="hljs-keyword">throw</span> error;
    }
  }

  <span class="hljs-keyword">async</span> disconnect() {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isConnected) {
        <span class="hljs-keyword">await</span> mongoose.disconnect();
        <span class="hljs-keyword">this</span>.isConnected = <span class="hljs-literal">false</span>;
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"📴 MongoDB disconnected"</span>);
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"❌ MongoDB disconnection error:"</span>, error.message);
      <span class="hljs-keyword">throw</span> error;
    }
  }

  handleError(error) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"❌ MongoDB error:"</span>, error.message);
    <span class="hljs-keyword">this</span>.isConnected = <span class="hljs-literal">false</span>;
  }

  handleDisconnected() {
    <span class="hljs-built_in">console</span>.warn(<span class="hljs-string">"⚠️ MongoDB disconnected"</span>);
    <span class="hljs-keyword">this</span>.isConnected = <span class="hljs-literal">false</span>;
  }

  handleReconnected() {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"🔄 MongoDB reconnected"</span>);
    <span class="hljs-keyword">this</span>.isConnected = <span class="hljs-literal">true</span>;
  }

  getConnectionStatus() {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">isConnected</span>: <span class="hljs-keyword">this</span>.isConnected,
      <span class="hljs-attr">readyState</span>: mongoose.connection.readyState,
      <span class="hljs-attr">host</span>: mongoose.connection.host,
      <span class="hljs-attr">port</span>: mongoose.connection.port,
      <span class="hljs-attr">name</span>: mongoose.connection.name,
    };
  }

  <span class="hljs-comment">// Health check</span>
  <span class="hljs-keyword">async</span> healthCheck() {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> adminDb = mongoose.connection.db.admin();
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> adminDb.ping();
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">status</span>: <span class="hljs-string">"healthy"</span>,
        <span class="hljs-attr">ping</span>: result,
        <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
      };
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">status</span>: <span class="hljs-string">"unhealthy"</span>,
        <span class="hljs-attr">error</span>: error.message,
        <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
      };
    }
  }
}

<span class="hljs-built_in">module</span>.exports = <span class="hljs-keyword">new</span> DatabaseConnection();
</div></code></pre>
<h3 id="schema-definitions">Schema Definitions</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// models/User.js - User Schema</span>
<span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">"mongoose"</span>);
<span class="hljs-keyword">const</span> bcrypt = <span class="hljs-built_in">require</span>(<span class="hljs-string">"bcryptjs"</span>);
<span class="hljs-keyword">const</span> validator = <span class="hljs-built_in">require</span>(<span class="hljs-string">"validator"</span>);

<span class="hljs-keyword">const</span> userSchema = <span class="hljs-keyword">new</span> mongoose.Schema(
  {
    <span class="hljs-attr">username</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
      <span class="hljs-attr">required</span>: [<span class="hljs-literal">true</span>, <span class="hljs-string">"Username is required"</span>],
      <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">trim</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">minlength</span>: [<span class="hljs-number">3</span>, <span class="hljs-string">"Username must be at least 3 characters"</span>],
      <span class="hljs-attr">maxlength</span>: [<span class="hljs-number">30</span>, <span class="hljs-string">"Username cannot exceed 30 characters"</span>],
      <span class="hljs-attr">match</span>: [
        <span class="hljs-regexp">/^[a-zA-Z0-9_]+$/</span>,
        <span class="hljs-string">"Username can only contain letters, numbers, and underscores"</span>,
      ],
    },
    <span class="hljs-attr">email</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
      <span class="hljs-attr">required</span>: [<span class="hljs-literal">true</span>, <span class="hljs-string">"Email is required"</span>],
      <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">lowercase</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">trim</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">validate</span>: {
        <span class="hljs-attr">validator</span>: validator.isEmail,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Please provide a valid email address"</span>,
      },
    },
    <span class="hljs-attr">password</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
      <span class="hljs-attr">required</span>: [<span class="hljs-literal">true</span>, <span class="hljs-string">"Password is required"</span>],
      <span class="hljs-attr">minlength</span>: [<span class="hljs-number">8</span>, <span class="hljs-string">"Password must be at least 8 characters"</span>],
      <span class="hljs-attr">select</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// Don't include password in queries by default</span>
    },
    <span class="hljs-attr">firstName</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
      <span class="hljs-attr">required</span>: [<span class="hljs-literal">true</span>, <span class="hljs-string">"First name is required"</span>],
      <span class="hljs-attr">trim</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">maxlength</span>: [<span class="hljs-number">50</span>, <span class="hljs-string">"First name cannot exceed 50 characters"</span>],
    },
    <span class="hljs-attr">lastName</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
      <span class="hljs-attr">required</span>: [<span class="hljs-literal">true</span>, <span class="hljs-string">"Last name is required"</span>],
      <span class="hljs-attr">trim</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">maxlength</span>: [<span class="hljs-number">50</span>, <span class="hljs-string">"Last name cannot exceed 50 characters"</span>],
    },
    <span class="hljs-attr">avatar</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
      <span class="hljs-attr">validate</span>: {
        <span class="hljs-attr">validator</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">v</span>) </span>{
          <span class="hljs-keyword">return</span> !v || validator.isURL(v);
        },
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Avatar must be a valid URL"</span>,
      },
    },
    <span class="hljs-attr">role</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
      <span class="hljs-attr">enum</span>: {
        <span class="hljs-attr">values</span>: [<span class="hljs-string">"user"</span>, <span class="hljs-string">"admin"</span>, <span class="hljs-string">"moderator"</span>],
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Role must be either user, admin, or moderator"</span>,
      },
      <span class="hljs-attr">default</span>: <span class="hljs-string">"user"</span>,
    },
    <span class="hljs-attr">isActive</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">Boolean</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-literal">true</span>,
    },
    <span class="hljs-attr">lastLogin</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">Date</span>,
    },
    <span class="hljs-attr">preferences</span>: {
      <span class="hljs-attr">theme</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
        <span class="hljs-attr">enum</span>: [<span class="hljs-string">"light"</span>, <span class="hljs-string">"dark"</span>, <span class="hljs-string">"auto"</span>],
        <span class="hljs-attr">default</span>: <span class="hljs-string">"auto"</span>,
      },
      <span class="hljs-attr">notifications</span>: {
        <span class="hljs-attr">email</span>: { <span class="hljs-attr">type</span>: <span class="hljs-built_in">Boolean</span>, <span class="hljs-attr">default</span>: <span class="hljs-literal">true</span> },
        <span class="hljs-attr">push</span>: { <span class="hljs-attr">type</span>: <span class="hljs-built_in">Boolean</span>, <span class="hljs-attr">default</span>: <span class="hljs-literal">true</span> },
        <span class="hljs-attr">sms</span>: { <span class="hljs-attr">type</span>: <span class="hljs-built_in">Boolean</span>, <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span> },
      },
      <span class="hljs-attr">timezone</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-string">"UTC"</span>,
      },
    },
    <span class="hljs-attr">metadata</span>: {
      <span class="hljs-attr">createdBy</span>: {
        <span class="hljs-attr">type</span>: mongoose.Schema.Types.ObjectId,
        <span class="hljs-attr">ref</span>: <span class="hljs-string">"User"</span>,
      },
      <span class="hljs-attr">tags</span>: [
        {
          <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
          <span class="hljs-attr">trim</span>: <span class="hljs-literal">true</span>,
        },
      ],
      <span class="hljs-attr">notes</span>: <span class="hljs-built_in">String</span>,
    },
  },
  {
    <span class="hljs-attr">timestamps</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// Adds createdAt and updatedAt</span>
    <span class="hljs-attr">toJSON</span>: {
      <span class="hljs-attr">virtuals</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">transform</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">doc, ret</span>) </span>{
        <span class="hljs-keyword">delete</span> ret.password;
        <span class="hljs-keyword">delete</span> ret.__v;
        <span class="hljs-keyword">return</span> ret;
      },
    },
    <span class="hljs-attr">toObject</span>: { <span class="hljs-attr">virtuals</span>: <span class="hljs-literal">true</span> },
  }
);

<span class="hljs-comment">// Indexes</span>
userSchema.index({ <span class="hljs-attr">email</span>: <span class="hljs-number">1</span> });
userSchema.index({ <span class="hljs-attr">username</span>: <span class="hljs-number">1</span> });
userSchema.index({ <span class="hljs-attr">role</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">isActive</span>: <span class="hljs-number">1</span> });
userSchema.index({ <span class="hljs-attr">createdAt</span>: <span class="hljs-number">-1</span> });
userSchema.index({ <span class="hljs-string">"metadata.tags"</span>: <span class="hljs-number">1</span> });

<span class="hljs-comment">// Virtual properties</span>
userSchema.virtual(<span class="hljs-string">"fullName"</span>).get(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.firstName}</span> <span class="hljs-subst">${<span class="hljs-keyword">this</span>.lastName}</span>`</span>;
});

userSchema.virtual(<span class="hljs-string">"initials"</span>).get(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.firstName.charAt(<span class="hljs-number">0</span>)}</span><span class="hljs-subst">${<span class="hljs-keyword">this</span>.lastName.charAt(<span class="hljs-number">0</span>)}</span>`</span>.toUpperCase();
});

userSchema.virtual(<span class="hljs-string">"tasksCount"</span>, {
  <span class="hljs-attr">ref</span>: <span class="hljs-string">"Task"</span>,
  <span class="hljs-attr">localField</span>: <span class="hljs-string">"_id"</span>,
  <span class="hljs-attr">foreignField</span>: <span class="hljs-string">"assignedTo"</span>,
  <span class="hljs-attr">count</span>: <span class="hljs-literal">true</span>,
});

<span class="hljs-comment">// Pre-save middleware</span>
userSchema.pre(<span class="hljs-string">"save"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">next</span>) </span>{
  <span class="hljs-comment">// Only hash password if it's modified</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isModified(<span class="hljs-string">"password"</span>)) <span class="hljs-keyword">return</span> next();

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// Hash password</span>
    <span class="hljs-keyword">const</span> salt = <span class="hljs-keyword">await</span> bcrypt.genSalt(<span class="hljs-number">12</span>);
    <span class="hljs-keyword">this</span>.password = <span class="hljs-keyword">await</span> bcrypt.hash(<span class="hljs-keyword">this</span>.password, salt);
    next();
  } <span class="hljs-keyword">catch</span> (error) {
    next(error);
  }
});

<span class="hljs-comment">// Pre-save middleware for username uniqueness</span>
userSchema.pre(<span class="hljs-string">"save"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">next</span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isModified(<span class="hljs-string">"username"</span>)) <span class="hljs-keyword">return</span> next();

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> existingUser = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.constructor.findOne({
      <span class="hljs-attr">username</span>: <span class="hljs-keyword">this</span>.username,
      <span class="hljs-attr">_id</span>: { <span class="hljs-attr">$ne</span>: <span class="hljs-keyword">this</span>._id },
    });

    <span class="hljs-keyword">if</span> (existingUser) {
      <span class="hljs-keyword">const</span> error = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Username already exists"</span>);
      error.name = <span class="hljs-string">"ValidationError"</span>;
      <span class="hljs-keyword">return</span> next(error);
    }

    next();
  } <span class="hljs-keyword">catch</span> (error) {
    next(error);
  }
});

<span class="hljs-comment">// Instance methods</span>
userSchema.methods.comparePassword = <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">candidatePassword</span>) </span>{
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> bcrypt.compare(candidatePassword, <span class="hljs-keyword">this</span>.password);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Password comparison failed"</span>);
  }
};

userSchema.methods.updateLastLogin = <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>.lastLogin = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.save({ <span class="hljs-attr">validateBeforeSave</span>: <span class="hljs-literal">false</span> });
};

userSchema.methods.toPublicJSON = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> userObject = <span class="hljs-keyword">this</span>.toObject();
  <span class="hljs-keyword">delete</span> userObject.password;
  <span class="hljs-keyword">delete</span> userObject.__v;
  <span class="hljs-keyword">return</span> userObject;
};

<span class="hljs-comment">// Static methods</span>
userSchema.statics.findByEmail = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">email</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.findOne({ <span class="hljs-attr">email</span>: email.toLowerCase() });
};

userSchema.statics.findActiveUsers = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.find({ <span class="hljs-attr">isActive</span>: <span class="hljs-literal">true</span> });
};

userSchema.statics.getUserStats = <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> stats = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.aggregate([
    {
      <span class="hljs-attr">$group</span>: {
        <span class="hljs-attr">_id</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">totalUsers</span>: { <span class="hljs-attr">$sum</span>: <span class="hljs-number">1</span> },
        <span class="hljs-attr">activeUsers</span>: {
          <span class="hljs-attr">$sum</span>: { <span class="hljs-attr">$cond</span>: [{ <span class="hljs-attr">$eq</span>: [<span class="hljs-string">"$isActive"</span>, <span class="hljs-literal">true</span>] }, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>] },
        },
        <span class="hljs-attr">adminUsers</span>: {
          <span class="hljs-attr">$sum</span>: { <span class="hljs-attr">$cond</span>: [{ <span class="hljs-attr">$eq</span>: [<span class="hljs-string">"$role"</span>, <span class="hljs-string">"admin"</span>] }, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>] },
        },
        <span class="hljs-attr">averageTasksPerUser</span>: { <span class="hljs-attr">$avg</span>: <span class="hljs-string">"$tasksCount"</span> },
      },
    },
  ]);

  <span class="hljs-keyword">return</span> (
    stats[<span class="hljs-number">0</span>] || {
      <span class="hljs-attr">totalUsers</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">activeUsers</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">adminUsers</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">averageTasksPerUser</span>: <span class="hljs-number">0</span>,
    }
  );
};

<span class="hljs-built_in">module</span>.exports = mongoose.model(<span class="hljs-string">"User"</span>, userSchema);
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">// models/Task.js - Task Schema</span>
<span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">"mongoose"</span>);

<span class="hljs-keyword">const</span> taskSchema = <span class="hljs-keyword">new</span> mongoose.Schema(
  {
    <span class="hljs-attr">title</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
      <span class="hljs-attr">required</span>: [<span class="hljs-literal">true</span>, <span class="hljs-string">"Task title is required"</span>],
      <span class="hljs-attr">trim</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">maxlength</span>: [<span class="hljs-number">200</span>, <span class="hljs-string">"Title cannot exceed 200 characters"</span>],
    },
    <span class="hljs-attr">description</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
      <span class="hljs-attr">trim</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">maxlength</span>: [<span class="hljs-number">2000</span>, <span class="hljs-string">"Description cannot exceed 2000 characters"</span>],
    },
    <span class="hljs-attr">status</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
      <span class="hljs-attr">enum</span>: {
        <span class="hljs-attr">values</span>: [<span class="hljs-string">"pending"</span>, <span class="hljs-string">"in-progress"</span>, <span class="hljs-string">"completed"</span>, <span class="hljs-string">"cancelled"</span>],
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Status must be pending, in-progress, completed, or cancelled"</span>,
      },
      <span class="hljs-attr">default</span>: <span class="hljs-string">"pending"</span>,
    },
    <span class="hljs-attr">priority</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
      <span class="hljs-attr">enum</span>: {
        <span class="hljs-attr">values</span>: [<span class="hljs-string">"low"</span>, <span class="hljs-string">"medium"</span>, <span class="hljs-string">"high"</span>, <span class="hljs-string">"urgent"</span>],
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Priority must be low, medium, high, or urgent"</span>,
      },
      <span class="hljs-attr">default</span>: <span class="hljs-string">"medium"</span>,
    },
    <span class="hljs-attr">category</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
      <span class="hljs-attr">required</span>: [<span class="hljs-literal">true</span>, <span class="hljs-string">"Category is required"</span>],
      <span class="hljs-attr">trim</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">maxlength</span>: [<span class="hljs-number">50</span>, <span class="hljs-string">"Category cannot exceed 50 characters"</span>],
    },
    <span class="hljs-attr">tags</span>: [
      {
        <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
        <span class="hljs-attr">trim</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">maxlength</span>: [<span class="hljs-number">30</span>, <span class="hljs-string">"Tag cannot exceed 30 characters"</span>],
      },
    ],
    <span class="hljs-attr">assignedTo</span>: {
      <span class="hljs-attr">type</span>: mongoose.Schema.Types.ObjectId,
      <span class="hljs-attr">ref</span>: <span class="hljs-string">"User"</span>,
      <span class="hljs-attr">required</span>: [<span class="hljs-literal">true</span>, <span class="hljs-string">"Task must be assigned to a user"</span>],
    },
    <span class="hljs-attr">createdBy</span>: {
      <span class="hljs-attr">type</span>: mongoose.Schema.Types.ObjectId,
      <span class="hljs-attr">ref</span>: <span class="hljs-string">"User"</span>,
      <span class="hljs-attr">required</span>: [<span class="hljs-literal">true</span>, <span class="hljs-string">"Creator is required"</span>],
    },
    <span class="hljs-attr">dueDate</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">Date</span>,
      <span class="hljs-attr">validate</span>: {
        <span class="hljs-attr">validator</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">v</span>) </span>{
          <span class="hljs-keyword">return</span> !v || v &gt; <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
        },
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Due date must be in the future"</span>,
      },
    },
    <span class="hljs-attr">completedAt</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">Date</span>,
    },
    <span class="hljs-attr">estimatedHours</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">Number</span>,
      <span class="hljs-attr">min</span>: [<span class="hljs-number">0</span>, <span class="hljs-string">"Estimated hours cannot be negative"</span>],
      <span class="hljs-attr">max</span>: [<span class="hljs-number">1000</span>, <span class="hljs-string">"Estimated hours cannot exceed 1000"</span>],
    },
    <span class="hljs-attr">actualHours</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">Number</span>,
      <span class="hljs-attr">min</span>: [<span class="hljs-number">0</span>, <span class="hljs-string">"Actual hours cannot be negative"</span>],
      <span class="hljs-attr">max</span>: [<span class="hljs-number">1000</span>, <span class="hljs-string">"Actual hours cannot exceed 1000"</span>],
    },
    <span class="hljs-attr">attachments</span>: [
      {
        <span class="hljs-attr">filename</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
          <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
        },
        <span class="hljs-attr">originalName</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
          <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
        },
        <span class="hljs-attr">mimetype</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
          <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
        },
        <span class="hljs-attr">size</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-built_in">Number</span>,
          <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
        },
        <span class="hljs-attr">url</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
          <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
        },
        <span class="hljs-attr">uploadedAt</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-built_in">Date</span>,
          <span class="hljs-attr">default</span>: <span class="hljs-built_in">Date</span>.now,
        },
      },
    ],
    <span class="hljs-attr">comments</span>: [
      {
        <span class="hljs-attr">author</span>: {
          <span class="hljs-attr">type</span>: mongoose.Schema.Types.ObjectId,
          <span class="hljs-attr">ref</span>: <span class="hljs-string">"User"</span>,
          <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
        },
        <span class="hljs-attr">content</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
          <span class="hljs-attr">required</span>: [<span class="hljs-literal">true</span>, <span class="hljs-string">"Comment content is required"</span>],
          <span class="hljs-attr">trim</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">maxlength</span>: [<span class="hljs-number">1000</span>, <span class="hljs-string">"Comment cannot exceed 1000 characters"</span>],
        },
        <span class="hljs-attr">createdAt</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-built_in">Date</span>,
          <span class="hljs-attr">default</span>: <span class="hljs-built_in">Date</span>.now,
        },
        <span class="hljs-attr">editedAt</span>: <span class="hljs-built_in">Date</span>,
        <span class="hljs-attr">isEdited</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-built_in">Boolean</span>,
          <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>,
        },
      },
    ],
    <span class="hljs-attr">subtasks</span>: [
      {
        <span class="hljs-attr">title</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
          <span class="hljs-attr">required</span>: [<span class="hljs-literal">true</span>, <span class="hljs-string">"Subtask title is required"</span>],
          <span class="hljs-attr">trim</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">maxlength</span>: [<span class="hljs-number">200</span>, <span class="hljs-string">"Subtask title cannot exceed 200 characters"</span>],
        },
        <span class="hljs-attr">completed</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-built_in">Boolean</span>,
          <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>,
        },
        <span class="hljs-attr">completedAt</span>: <span class="hljs-built_in">Date</span>,
        <span class="hljs-attr">order</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-built_in">Number</span>,
          <span class="hljs-attr">default</span>: <span class="hljs-number">0</span>,
        },
      },
    ],
    <span class="hljs-attr">isArchived</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">Boolean</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>,
    },
  },
  {
    <span class="hljs-attr">timestamps</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">toJSON</span>: { <span class="hljs-attr">virtuals</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-attr">toObject</span>: { <span class="hljs-attr">virtuals</span>: <span class="hljs-literal">true</span> },
  }
);

<span class="hljs-comment">// Indexes</span>
taskSchema.index({ <span class="hljs-attr">assignedTo</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">status</span>: <span class="hljs-number">1</span> });
taskSchema.index({ <span class="hljs-attr">createdBy</span>: <span class="hljs-number">1</span> });
taskSchema.index({ <span class="hljs-attr">status</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">priority</span>: <span class="hljs-number">1</span> });
taskSchema.index({ <span class="hljs-attr">category</span>: <span class="hljs-number">1</span> });
taskSchema.index({ <span class="hljs-attr">tags</span>: <span class="hljs-number">1</span> });
taskSchema.index({ <span class="hljs-attr">dueDate</span>: <span class="hljs-number">1</span> });
taskSchema.index({ <span class="hljs-attr">createdAt</span>: <span class="hljs-number">-1</span> });
taskSchema.index({ <span class="hljs-attr">title</span>: <span class="hljs-string">"text"</span>, <span class="hljs-attr">description</span>: <span class="hljs-string">"text"</span> }); <span class="hljs-comment">// Text search</span>

<span class="hljs-comment">// Virtual properties</span>
taskSchema.virtual(<span class="hljs-string">"isOverdue"</span>).get(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> (
    <span class="hljs-keyword">this</span>.dueDate &amp;&amp; <span class="hljs-keyword">this</span>.dueDate &lt; <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() &amp;&amp; <span class="hljs-keyword">this</span>.status !== <span class="hljs-string">"completed"</span>
  );
});

taskSchema.virtual(<span class="hljs-string">"daysUntilDue"</span>).get(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.dueDate) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">const</span> diffTime = <span class="hljs-keyword">this</span>.dueDate - <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.ceil(diffTime / (<span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span>));
});

taskSchema.virtual(<span class="hljs-string">"completionPercentage"</span>).get(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.subtasks.length === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.status === <span class="hljs-string">"completed"</span> ? <span class="hljs-number">100</span> : <span class="hljs-number">0</span>;
  }

  <span class="hljs-keyword">const</span> completedSubtasks = <span class="hljs-keyword">this</span>.subtasks.filter(
    <span class="hljs-function">(<span class="hljs-params">subtask</span>) =&gt;</span> subtask.completed
  ).length;
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.round((completedSubtasks / <span class="hljs-keyword">this</span>.subtasks.length) * <span class="hljs-number">100</span>);
});

taskSchema.virtual(<span class="hljs-string">"timeSpent"</span>).get(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.actualHours || <span class="hljs-number">0</span>;
});

<span class="hljs-comment">// Pre-save middleware</span>
taskSchema.pre(<span class="hljs-string">"save"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">next</span>) </span>{
  <span class="hljs-comment">// Set completedAt when status changes to completed</span>
  <span class="hljs-keyword">if</span> (
    <span class="hljs-keyword">this</span>.isModified(<span class="hljs-string">"status"</span>) &amp;&amp;
    <span class="hljs-keyword">this</span>.status === <span class="hljs-string">"completed"</span> &amp;&amp;
    !<span class="hljs-keyword">this</span>.completedAt
  ) {
    <span class="hljs-keyword">this</span>.completedAt = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
  }

  <span class="hljs-comment">// Clear completedAt when status changes from completed</span>
  <span class="hljs-keyword">if</span> (
    <span class="hljs-keyword">this</span>.isModified(<span class="hljs-string">"status"</span>) &amp;&amp;
    <span class="hljs-keyword">this</span>.status !== <span class="hljs-string">"completed"</span> &amp;&amp;
    <span class="hljs-keyword">this</span>.completedAt
  ) {
    <span class="hljs-keyword">this</span>.completedAt = <span class="hljs-literal">undefined</span>;
  }

  next();
});

<span class="hljs-comment">// Pre-save middleware for subtasks</span>
taskSchema.pre(<span class="hljs-string">"save"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">next</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isModified(<span class="hljs-string">"subtasks"</span>)) {
    <span class="hljs-keyword">this</span>.subtasks.forEach(<span class="hljs-function">(<span class="hljs-params">subtask, index</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (subtask.completed &amp;&amp; !subtask.completedAt) {
        subtask.completedAt = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!subtask.completed &amp;&amp; subtask.completedAt) {
        subtask.completedAt = <span class="hljs-literal">undefined</span>;
      }

      <span class="hljs-comment">// Set order if not provided</span>
      <span class="hljs-keyword">if</span> (subtask.order === <span class="hljs-literal">undefined</span>) {
        subtask.order = index;
      }
    });
  }

  next();
});

<span class="hljs-comment">// Instance methods</span>
taskSchema.methods.addComment = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">authorId, content</span>) </span>{
  <span class="hljs-keyword">this</span>.comments.push({
    <span class="hljs-attr">author</span>: authorId,
    <span class="hljs-attr">content</span>: content,
  });
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.save();
};

taskSchema.methods.addSubtask = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">title</span>) </span>{
  <span class="hljs-keyword">this</span>.subtasks.push({
    <span class="hljs-attr">title</span>: title,
    <span class="hljs-attr">order</span>: <span class="hljs-keyword">this</span>.subtasks.length,
  });
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.save();
};

taskSchema.methods.toggleSubtask = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">subtaskId</span>) </span>{
  <span class="hljs-keyword">const</span> subtask = <span class="hljs-keyword">this</span>.subtasks.id(subtaskId);
  <span class="hljs-keyword">if</span> (subtask) {
    subtask.completed = !subtask.completed;
    subtask.completedAt = subtask.completed ? <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() : <span class="hljs-literal">undefined</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.save();
  }
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Subtask not found"</span>);
};

taskSchema.methods.archive = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>.isArchived = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.save();
};

taskSchema.methods.unarchive = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>.isArchived = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.save();
};

<span class="hljs-comment">// Static methods</span>
taskSchema.statics.findByUser = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">userId</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.find({ <span class="hljs-attr">assignedTo</span>: userId, <span class="hljs-attr">isArchived</span>: <span class="hljs-literal">false</span> });
};

taskSchema.statics.findOverdue = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.find({
    <span class="hljs-attr">dueDate</span>: { <span class="hljs-attr">$lt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() },
    <span class="hljs-attr">status</span>: { <span class="hljs-attr">$ne</span>: <span class="hljs-string">"completed"</span> },
    <span class="hljs-attr">isArchived</span>: <span class="hljs-literal">false</span>,
  });
};

taskSchema.statics.getTaskStats = <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">userId = null</span>) </span>{
  <span class="hljs-keyword">const</span> matchStage = userId
    ? { <span class="hljs-attr">assignedTo</span>: mongoose.Types.ObjectId(userId) }
    : {};

  <span class="hljs-keyword">const</span> stats = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.aggregate([
    { <span class="hljs-attr">$match</span>: { ...matchStage, <span class="hljs-attr">isArchived</span>: <span class="hljs-literal">false</span> } },
    {
      <span class="hljs-attr">$group</span>: {
        <span class="hljs-attr">_id</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">totalTasks</span>: { <span class="hljs-attr">$sum</span>: <span class="hljs-number">1</span> },
        <span class="hljs-attr">pendingTasks</span>: {
          <span class="hljs-attr">$sum</span>: { <span class="hljs-attr">$cond</span>: [{ <span class="hljs-attr">$eq</span>: [<span class="hljs-string">"$status"</span>, <span class="hljs-string">"pending"</span>] }, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>] },
        },
        <span class="hljs-attr">inProgressTasks</span>: {
          <span class="hljs-attr">$sum</span>: { <span class="hljs-attr">$cond</span>: [{ <span class="hljs-attr">$eq</span>: [<span class="hljs-string">"$status"</span>, <span class="hljs-string">"in-progress"</span>] }, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>] },
        },
        <span class="hljs-attr">completedTasks</span>: {
          <span class="hljs-attr">$sum</span>: { <span class="hljs-attr">$cond</span>: [{ <span class="hljs-attr">$eq</span>: [<span class="hljs-string">"$status"</span>, <span class="hljs-string">"completed"</span>] }, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>] },
        },
        <span class="hljs-attr">overdueTasks</span>: {
          <span class="hljs-attr">$sum</span>: {
            <span class="hljs-attr">$cond</span>: [
              {
                <span class="hljs-attr">$and</span>: [
                  { <span class="hljs-attr">$lt</span>: [<span class="hljs-string">"$dueDate"</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()] },
                  { <span class="hljs-attr">$ne</span>: [<span class="hljs-string">"$status"</span>, <span class="hljs-string">"completed"</span>] },
                ],
              },
              <span class="hljs-number">1</span>,
              <span class="hljs-number">0</span>,
            ],
          },
        },
        <span class="hljs-attr">averageCompletionTime</span>: {
          <span class="hljs-attr">$avg</span>: {
            <span class="hljs-attr">$cond</span>: [
              { <span class="hljs-attr">$eq</span>: [<span class="hljs-string">"$status"</span>, <span class="hljs-string">"completed"</span>] },
              { <span class="hljs-attr">$subtract</span>: [<span class="hljs-string">"$completedAt"</span>, <span class="hljs-string">"$createdAt"</span>] },
              <span class="hljs-literal">null</span>,
            ],
          },
        },
      },
    },
  ]);

  <span class="hljs-keyword">return</span> (
    stats[<span class="hljs-number">0</span>] || {
      <span class="hljs-attr">totalTasks</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">pendingTasks</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">inProgressTasks</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">completedTasks</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">overdueTasks</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">averageCompletionTime</span>: <span class="hljs-number">0</span>,
    }
  );
};

<span class="hljs-built_in">module</span>.exports = mongoose.model(<span class="hljs-string">"Task"</span>, taskSchema);
</div></code></pre>
<h3 id="service-layer-with-advanced-queries">Service Layer with Advanced Queries</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// services/TaskService.js - Task Business Logic</span>
<span class="hljs-keyword">const</span> Task = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../models/Task"</span>);
<span class="hljs-keyword">const</span> User = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../models/User"</span>);
<span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">"mongoose"</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TaskService</span> </span>{
  <span class="hljs-comment">// Create a new task</span>
  <span class="hljs-keyword">async</span> createTask(taskData, createdBy) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// Validate assignee exists</span>
      <span class="hljs-keyword">const</span> assignee = <span class="hljs-keyword">await</span> User.findById(taskData.assignedTo);
      <span class="hljs-keyword">if</span> (!assignee) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Assigned user not found"</span>);
      }

      <span class="hljs-keyword">const</span> task = <span class="hljs-keyword">new</span> Task({
        ...taskData,
        createdBy,
      });

      <span class="hljs-keyword">await</span> task.save();

      <span class="hljs-comment">// Populate references</span>
      <span class="hljs-keyword">await</span> task.populate([
        { <span class="hljs-attr">path</span>: <span class="hljs-string">"assignedTo"</span>, <span class="hljs-attr">select</span>: <span class="hljs-string">"username email firstName lastName"</span> },
        { <span class="hljs-attr">path</span>: <span class="hljs-string">"createdBy"</span>, <span class="hljs-attr">select</span>: <span class="hljs-string">"username email firstName lastName"</span> },
      ]);

      <span class="hljs-keyword">return</span> task;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Failed to create task: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Get tasks with advanced filtering and pagination</span>
  <span class="hljs-keyword">async</span> getTasks(options = {}) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> {
        page = <span class="hljs-number">1</span>,
        limit = <span class="hljs-number">10</span>,
        sortBy = <span class="hljs-string">"createdAt"</span>,
        sortOrder = <span class="hljs-string">"desc"</span>,
        status,
        priority,
        category,
        assignedTo,
        createdBy,
        tags,
        search,
        dueDateFrom,
        dueDateTo,
        isOverdue,
        includeArchived = <span class="hljs-literal">false</span>,
      } = options;

      <span class="hljs-comment">// Build query</span>
      <span class="hljs-keyword">const</span> query = {};

      <span class="hljs-keyword">if</span> (!includeArchived) {
        query.isArchived = <span class="hljs-literal">false</span>;
      }

      <span class="hljs-keyword">if</span> (status) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(status)) {
          query.status = { <span class="hljs-attr">$in</span>: status };
        } <span class="hljs-keyword">else</span> {
          query.status = status;
        }
      }

      <span class="hljs-keyword">if</span> (priority) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(priority)) {
          query.priority = { <span class="hljs-attr">$in</span>: priority };
        } <span class="hljs-keyword">else</span> {
          query.priority = priority;
        }
      }

      <span class="hljs-keyword">if</span> (category) {
        query.category = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(category, <span class="hljs-string">"i"</span>);
      }

      <span class="hljs-keyword">if</span> (assignedTo) {
        query.assignedTo = assignedTo;
      }

      <span class="hljs-keyword">if</span> (createdBy) {
        query.createdBy = createdBy;
      }

      <span class="hljs-keyword">if</span> (tags &amp;&amp; tags.length &gt; <span class="hljs-number">0</span>) {
        query.tags = { <span class="hljs-attr">$in</span>: tags };
      }

      <span class="hljs-keyword">if</span> (search) {
        query.$text = { <span class="hljs-attr">$search</span>: search };
      }

      <span class="hljs-comment">// Date range filtering</span>
      <span class="hljs-keyword">if</span> (dueDateFrom || dueDateTo) {
        query.dueDate = {};
        <span class="hljs-keyword">if</span> (dueDateFrom) {
          query.dueDate.$gte = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(dueDateFrom);
        }
        <span class="hljs-keyword">if</span> (dueDateTo) {
          query.dueDate.$lte = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(dueDateTo);
        }
      }

      <span class="hljs-comment">// Overdue filtering</span>
      <span class="hljs-keyword">if</span> (isOverdue === <span class="hljs-literal">true</span>) {
        query.dueDate = { <span class="hljs-attr">$lt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() };
        query.status = { <span class="hljs-attr">$ne</span>: <span class="hljs-string">"completed"</span> };
      }

      <span class="hljs-comment">// Build sort object</span>
      <span class="hljs-keyword">const</span> sort = {};
      sort[sortBy] = sortOrder === <span class="hljs-string">"desc"</span> ? <span class="hljs-number">-1</span> : <span class="hljs-number">1</span>;

      <span class="hljs-comment">// Calculate pagination</span>
      <span class="hljs-keyword">const</span> skip = (page - <span class="hljs-number">1</span>) * limit;

      <span class="hljs-comment">// Execute query with population</span>
      <span class="hljs-keyword">const</span> [tasks, totalCount] = <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.all([
        Task.find(query)
          .populate(<span class="hljs-string">"assignedTo"</span>, <span class="hljs-string">"username email firstName lastName avatar"</span>)
          .populate(<span class="hljs-string">"createdBy"</span>, <span class="hljs-string">"username email firstName lastName"</span>)
          .populate(<span class="hljs-string">"comments.author"</span>, <span class="hljs-string">"username firstName lastName avatar"</span>)
          .sort(sort)
          .skip(skip)
          .limit(<span class="hljs-built_in">parseInt</span>(limit))
          .lean(),
        Task.countDocuments(query),
      ]);

      <span class="hljs-comment">// Calculate pagination info</span>
      <span class="hljs-keyword">const</span> totalPages = <span class="hljs-built_in">Math</span>.ceil(totalCount / limit);
      <span class="hljs-keyword">const</span> hasNextPage = page &lt; totalPages;
      <span class="hljs-keyword">const</span> hasPrevPage = page &gt; <span class="hljs-number">1</span>;

      <span class="hljs-keyword">return</span> {
        tasks,
        <span class="hljs-attr">pagination</span>: {
          <span class="hljs-attr">currentPage</span>: <span class="hljs-built_in">parseInt</span>(page),
          totalPages,
          totalCount,
          hasNextPage,
          hasPrevPage,
          <span class="hljs-attr">limit</span>: <span class="hljs-built_in">parseInt</span>(limit),
        },
        <span class="hljs-attr">filters</span>: {
          status,
          priority,
          category,
          assignedTo,
          createdBy,
          tags,
          search,
          dueDateFrom,
          dueDateTo,
          isOverdue,
        },
      };
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Failed to get tasks: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Get task by ID with full population</span>
  <span class="hljs-keyword">async</span> getTaskById(taskId, userId = <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (!mongoose.Types.ObjectId.isValid(taskId)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Invalid task ID"</span>);
      }

      <span class="hljs-keyword">const</span> query = { <span class="hljs-attr">_id</span>: taskId };

      <span class="hljs-comment">// If userId provided, ensure user has access to the task</span>
      <span class="hljs-keyword">if</span> (userId) {
        query.$or = [{ <span class="hljs-attr">assignedTo</span>: userId }, { <span class="hljs-attr">createdBy</span>: userId }];
      }

      <span class="hljs-keyword">const</span> task = <span class="hljs-keyword">await</span> Task.findOne(query)
        .populate(<span class="hljs-string">"assignedTo"</span>, <span class="hljs-string">"username email firstName lastName avatar role"</span>)
        .populate(<span class="hljs-string">"createdBy"</span>, <span class="hljs-string">"username email firstName lastName avatar"</span>)
        .populate(<span class="hljs-string">"comments.author"</span>, <span class="hljs-string">"username firstName lastName avatar"</span>)
        .lean();

      <span class="hljs-keyword">if</span> (!task) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Task not found or access denied"</span>);
      }

      <span class="hljs-keyword">return</span> task;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Failed to get task: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Update task</span>
  <span class="hljs-keyword">async</span> updateTask(taskId, updateData, userId) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (!mongoose.Types.ObjectId.isValid(taskId)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Invalid task ID"</span>);
      }

      <span class="hljs-comment">// Find task and check permissions</span>
      <span class="hljs-keyword">const</span> task = <span class="hljs-keyword">await</span> Task.findOne({
        <span class="hljs-attr">_id</span>: taskId,
        <span class="hljs-attr">$or</span>: [{ <span class="hljs-attr">assignedTo</span>: userId }, { <span class="hljs-attr">createdBy</span>: userId }],
      });

      <span class="hljs-keyword">if</span> (!task) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Task not found or access denied"</span>);
      }

      <span class="hljs-comment">// Validate assignee if being updated</span>
      <span class="hljs-keyword">if</span> (
        updateData.assignedTo &amp;&amp;
        updateData.assignedTo !== task.assignedTo.toString()
      ) {
        <span class="hljs-keyword">const</span> assignee = <span class="hljs-keyword">await</span> User.findById(updateData.assignedTo);
        <span class="hljs-keyword">if</span> (!assignee) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Assigned user not found"</span>);
        }
      }

      <span class="hljs-comment">// Update task</span>
      <span class="hljs-built_in">Object</span>.assign(task, updateData);
      <span class="hljs-keyword">await</span> task.save();

      <span class="hljs-comment">// Populate and return updated task</span>
      <span class="hljs-keyword">await</span> task.populate([
        {
          <span class="hljs-attr">path</span>: <span class="hljs-string">"assignedTo"</span>,
          <span class="hljs-attr">select</span>: <span class="hljs-string">"username email firstName lastName avatar"</span>,
        },
        { <span class="hljs-attr">path</span>: <span class="hljs-string">"createdBy"</span>, <span class="hljs-attr">select</span>: <span class="hljs-string">"username email firstName lastName"</span> },
        {
          <span class="hljs-attr">path</span>: <span class="hljs-string">"comments.author"</span>,
          <span class="hljs-attr">select</span>: <span class="hljs-string">"username firstName lastName avatar"</span>,
        },
      ]);

      <span class="hljs-keyword">return</span> task;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Failed to update task: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Delete task</span>
  <span class="hljs-keyword">async</span> deleteTask(taskId, userId) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (!mongoose.Types.ObjectId.isValid(taskId)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Invalid task ID"</span>);
      }

      <span class="hljs-keyword">const</span> task = <span class="hljs-keyword">await</span> Task.findOneAndDelete({
        <span class="hljs-attr">_id</span>: taskId,
        <span class="hljs-attr">$or</span>: [{ <span class="hljs-attr">assignedTo</span>: userId }, { <span class="hljs-attr">createdBy</span>: userId }],
      });

      <span class="hljs-keyword">if</span> (!task) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Task not found or access denied"</span>);
      }

      <span class="hljs-keyword">return</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">"Task deleted successfully"</span> };
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Failed to delete task: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Bulk operations</span>
  <span class="hljs-keyword">async</span> bulkUpdateTasks(taskIds, updateData, userId) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> validIds = taskIds.filter(<span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span>
        mongoose.Types.ObjectId.isValid(id)
      );

      <span class="hljs-keyword">if</span> (validIds.length === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"No valid task IDs provided"</span>);
      }

      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> Task.updateMany(
        {
          <span class="hljs-attr">_id</span>: { <span class="hljs-attr">$in</span>: validIds },
          <span class="hljs-attr">$or</span>: [{ <span class="hljs-attr">assignedTo</span>: userId }, { <span class="hljs-attr">createdBy</span>: userId }],
        },
        updateData
      );

      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">matchedCount</span>: result.matchedCount,
        <span class="hljs-attr">modifiedCount</span>: result.modifiedCount,
        <span class="hljs-attr">message</span>: <span class="hljs-string">`Updated <span class="hljs-subst">${result.modifiedCount}</span> tasks`</span>,
      };
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Failed to bulk update tasks: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Get task analytics</span>
  <span class="hljs-keyword">async</span> getTaskAnalytics(userId = <span class="hljs-literal">null</span>, dateRange = <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> matchStage = {};

      <span class="hljs-keyword">if</span> (userId) {
        matchStage.$or = [
          { <span class="hljs-attr">assignedTo</span>: mongoose.Types.ObjectId(userId) },
          { <span class="hljs-attr">createdBy</span>: mongoose.Types.ObjectId(userId) },
        ];
      }

      <span class="hljs-keyword">if</span> (dateRange) {
        matchStage.createdAt = {
          <span class="hljs-attr">$gte</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(dateRange.from),
          <span class="hljs-attr">$lte</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(dateRange.to),
        };
      }

      <span class="hljs-keyword">const</span> analytics = <span class="hljs-keyword">await</span> Task.aggregate([
        { <span class="hljs-attr">$match</span>: { ...matchStage, <span class="hljs-attr">isArchived</span>: <span class="hljs-literal">false</span> } },
        {
          <span class="hljs-attr">$facet</span>: {
            <span class="hljs-attr">statusDistribution</span>: [
              {
                <span class="hljs-attr">$group</span>: {
                  <span class="hljs-attr">_id</span>: <span class="hljs-string">"$status"</span>,
                  <span class="hljs-attr">count</span>: { <span class="hljs-attr">$sum</span>: <span class="hljs-number">1</span> },
                },
              },
            ],
            <span class="hljs-attr">priorityDistribution</span>: [
              {
                <span class="hljs-attr">$group</span>: {
                  <span class="hljs-attr">_id</span>: <span class="hljs-string">"$priority"</span>,
                  <span class="hljs-attr">count</span>: { <span class="hljs-attr">$sum</span>: <span class="hljs-number">1</span> },
                },
              },
            ],
            <span class="hljs-attr">categoryDistribution</span>: [
              {
                <span class="hljs-attr">$group</span>: {
                  <span class="hljs-attr">_id</span>: <span class="hljs-string">"$category"</span>,
                  <span class="hljs-attr">count</span>: { <span class="hljs-attr">$sum</span>: <span class="hljs-number">1</span> },
                },
              },
              { <span class="hljs-attr">$sort</span>: { <span class="hljs-attr">count</span>: <span class="hljs-number">-1</span> } },
              { <span class="hljs-attr">$limit</span>: <span class="hljs-number">10</span> },
            ],
            <span class="hljs-attr">completionTrend</span>: [
              {
                <span class="hljs-attr">$match</span>: { <span class="hljs-attr">status</span>: <span class="hljs-string">"completed"</span> },
              },
              {
                <span class="hljs-attr">$group</span>: {
                  <span class="hljs-attr">_id</span>: {
                    <span class="hljs-attr">year</span>: { <span class="hljs-attr">$year</span>: <span class="hljs-string">"$completedAt"</span> },
                    <span class="hljs-attr">month</span>: { <span class="hljs-attr">$month</span>: <span class="hljs-string">"$completedAt"</span> },
                    <span class="hljs-attr">day</span>: { <span class="hljs-attr">$dayOfMonth</span>: <span class="hljs-string">"$completedAt"</span> },
                  },
                  <span class="hljs-attr">count</span>: { <span class="hljs-attr">$sum</span>: <span class="hljs-number">1</span> },
                },
              },
              { <span class="hljs-attr">$sort</span>: { <span class="hljs-string">"_id.year"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"_id.month"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"_id.day"</span>: <span class="hljs-number">1</span> } },
            ],
            <span class="hljs-attr">averageCompletionTime</span>: [
              {
                <span class="hljs-attr">$match</span>: { <span class="hljs-attr">status</span>: <span class="hljs-string">"completed"</span>, <span class="hljs-attr">completedAt</span>: { <span class="hljs-attr">$exists</span>: <span class="hljs-literal">true</span> } },
              },
              {
                <span class="hljs-attr">$group</span>: {
                  <span class="hljs-attr">_id</span>: <span class="hljs-literal">null</span>,
                  <span class="hljs-attr">avgTime</span>: {
                    <span class="hljs-attr">$avg</span>: {
                      <span class="hljs-attr">$subtract</span>: [<span class="hljs-string">"$completedAt"</span>, <span class="hljs-string">"$createdAt"</span>],
                    },
                  },
                },
              },
            ],
          },
        },
      ]);

      <span class="hljs-keyword">return</span> analytics[<span class="hljs-number">0</span>];
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Failed to get task analytics: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }
}

<span class="hljs-built_in">module</span>.exports = <span class="hljs-keyword">new</span> TaskService();
</div></code></pre>
<h3 id="database-middleware-and-hooks">Database Middleware and Hooks</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// middleware/database.js - Database Middleware</span>
<span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">"mongoose"</span>);
<span class="hljs-keyword">const</span> database = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../config/database"</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseMiddleware</span> </span>{
  <span class="hljs-comment">// Connection middleware</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> ensureConnection(req, res, next) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (!database.isConnected) {
        <span class="hljs-keyword">await</span> database.connect();
      }
      next();
    } <span class="hljs-keyword">catch</span> (error) {
      res.status(<span class="hljs-number">503</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Service Unavailable"</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Database connection failed"</span>,
      });
    }
  }

  <span class="hljs-comment">// Transaction middleware</span>
  <span class="hljs-keyword">static</span> withTransaction() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (req, res, next) =&gt; {
      <span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> mongoose.startSession();

      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> session.withTransaction(<span class="hljs-keyword">async</span> () =&gt; {
          req.dbSession = session;
          <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> originalEnd = res.end;
            res.end = <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {
              <span class="hljs-keyword">if</span> (res.statusCode &gt;= <span class="hljs-number">400</span>) {
                reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Transaction failed due to error response"</span>));
              } <span class="hljs-keyword">else</span> {
                resolve();
              }
              originalEnd.apply(res, args);
            };

            next();
          });
        });
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Transaction failed:"</span>, error);
        <span class="hljs-keyword">if</span> (!res.headersSent) {
          res.status(<span class="hljs-number">500</span>).json({
            <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal Server Error"</span>,
            <span class="hljs-attr">message</span>: <span class="hljs-string">"Transaction failed"</span>,
          });
        }
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">await</span> session.endSession();
      }
    };
  }

  <span class="hljs-comment">// Database health check middleware</span>
  <span class="hljs-keyword">static</span> healthCheck() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (req, res, next) =&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> health = <span class="hljs-keyword">await</span> database.healthCheck();
        req.dbHealth = health;
        next();
      } <span class="hljs-keyword">catch</span> (error) {
        req.dbHealth = {
          <span class="hljs-attr">status</span>: <span class="hljs-string">"unhealthy"</span>,
          <span class="hljs-attr">error</span>: error.message,
          <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
        };
        next();
      }
    };
  }

  <span class="hljs-comment">// Query performance monitoring</span>
  <span class="hljs-keyword">static</span> queryMonitor() {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> originalQuery = mongoose.Query.prototype.exec;
      <span class="hljs-keyword">const</span> queries = [];

      mongoose.Query.prototype.exec = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">const</span> startTime = <span class="hljs-built_in">Date</span>.now();
        <span class="hljs-keyword">const</span> query = <span class="hljs-keyword">this</span>.getQuery();
        <span class="hljs-keyword">const</span> collection = <span class="hljs-keyword">this</span>.mongooseCollection.name;

        <span class="hljs-keyword">return</span> originalQuery.call(<span class="hljs-keyword">this</span>).then(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
          <span class="hljs-keyword">const</span> duration = <span class="hljs-built_in">Date</span>.now() - startTime;
          queries.push({
            collection,
            query,
            duration,
            <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
          });

          <span class="hljs-keyword">return</span> result;
        });
      };

      <span class="hljs-comment">// Restore original exec after request</span>
      <span class="hljs-keyword">const</span> originalEnd = res.end;
      res.end = <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {
        mongoose.Query.prototype.exec = originalQuery;

        <span class="hljs-comment">// Add query info to response headers (for debugging)</span>
        <span class="hljs-keyword">if</span> (process.env.NODE_ENV === <span class="hljs-string">"development"</span>) {
          res.setHeader(<span class="hljs-string">"X-DB-Queries"</span>, queries.length.toString());
          res.setHeader(
            <span class="hljs-string">"X-DB-Query-Time"</span>,
            queries.reduce(<span class="hljs-function">(<span class="hljs-params">sum, q</span>) =&gt;</span> sum + q.duration, <span class="hljs-number">0</span>).toString() + <span class="hljs-string">"ms"</span>
          );
        }

        req.dbQueries = queries;
        originalEnd.apply(res, args);
      };

      next();
    };
  }
}

<span class="hljs-built_in">module</span>.exports = DatabaseMiddleware;
</div></code></pre>
<h2 id="real-world-use-case">Real-World Use Case</h2>
<h3 id="complete-task-management-api-with-mongodb">Complete Task Management API with MongoDB</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// app.js - Complete Application with MongoDB Integration</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">"cors"</span>);
<span class="hljs-keyword">const</span> helmet = <span class="hljs-built_in">require</span>(<span class="hljs-string">"helmet"</span>);
<span class="hljs-keyword">const</span> compression = <span class="hljs-built_in">require</span>(<span class="hljs-string">"compression"</span>);
<span class="hljs-keyword">const</span> rateLimit = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express-rate-limit"</span>);

<span class="hljs-comment">// Database</span>
<span class="hljs-keyword">const</span> database = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./config/database"</span>);
<span class="hljs-keyword">const</span> DatabaseMiddleware = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./middleware/database"</span>);

<span class="hljs-comment">// Routes</span>
<span class="hljs-keyword">const</span> authRoutes = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./routes/auth"</span>);
<span class="hljs-keyword">const</span> taskRoutes = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./routes/tasks"</span>);
<span class="hljs-keyword">const</span> userRoutes = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./routes/users"</span>);
<span class="hljs-keyword">const</span> analyticsRoutes = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./routes/analytics"</span>);

<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// Trust proxy</span>
app.set(<span class="hljs-string">"trust proxy"</span>, <span class="hljs-number">1</span>);

<span class="hljs-comment">// Security middleware</span>
app.use(helmet());
app.use(
  cors({
    <span class="hljs-attr">origin</span>: process.env.ALLOWED_ORIGINS?.split(<span class="hljs-string">","</span>) || [
      <span class="hljs-string">"http://localhost:3000"</span>,
    ],
    <span class="hljs-attr">credentials</span>: <span class="hljs-literal">true</span>,
  })
);

<span class="hljs-comment">// Rate limiting</span>
app.use(
  rateLimit({
    <span class="hljs-attr">windowMs</span>: <span class="hljs-number">15</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 15 minutes</span>
    <span class="hljs-attr">max</span>: <span class="hljs-number">100</span>, <span class="hljs-comment">// requests per window</span>
  })
);

<span class="hljs-comment">// Compression</span>
app.use(compression());

<span class="hljs-comment">// Body parsing</span>
app.use(express.json({ <span class="hljs-attr">limit</span>: <span class="hljs-string">"10mb"</span> }));
app.use(express.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">limit</span>: <span class="hljs-string">"10mb"</span> }));

<span class="hljs-comment">// Database middleware</span>
app.use(DatabaseMiddleware.ensureConnection);
app.use(DatabaseMiddleware.queryMonitor());

<span class="hljs-comment">// Routes</span>
app.use(<span class="hljs-string">"/api/v1/auth"</span>, authRoutes);
app.use(<span class="hljs-string">"/api/v1/tasks"</span>, taskRoutes);
app.use(<span class="hljs-string">"/api/v1/users"</span>, userRoutes);
app.use(<span class="hljs-string">"/api/v1/analytics"</span>, analyticsRoutes);

<span class="hljs-comment">// Health check with database status</span>
app.get(<span class="hljs-string">"/health"</span>, DatabaseMiddleware.healthCheck(), (req, res) =&gt; {
  <span class="hljs-keyword">const</span> healthData = {
    <span class="hljs-attr">status</span>: <span class="hljs-string">"healthy"</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
    <span class="hljs-attr">uptime</span>: process.uptime(),
    <span class="hljs-attr">memory</span>: {
      <span class="hljs-attr">used</span>: <span class="hljs-built_in">Math</span>.round(process.memoryUsage().heapUsed / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>),
      <span class="hljs-attr">total</span>: <span class="hljs-built_in">Math</span>.round(process.memoryUsage().heapTotal / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>),
    },
    <span class="hljs-attr">database</span>: req.dbHealth,
    <span class="hljs-attr">queries</span>: req.dbQueries?.length || <span class="hljs-number">0</span>,
  };

  <span class="hljs-keyword">const</span> status = req.dbHealth?.status === <span class="hljs-string">"healthy"</span> ? <span class="hljs-number">200</span> : <span class="hljs-number">503</span>;

  res.status(status).json({
    <span class="hljs-attr">success</span>: status === <span class="hljs-number">200</span>,
    <span class="hljs-attr">data</span>: healthData,
  });
});

<span class="hljs-comment">// Root endpoint</span>
app.get(<span class="hljs-string">"/"</span>, (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Task Management API with MongoDB"</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
    <span class="hljs-attr">database</span>: database.getConnectionStatus(),
    <span class="hljs-attr">endpoints</span>: {
      <span class="hljs-attr">auth</span>: <span class="hljs-string">"/api/v1/auth"</span>,
      <span class="hljs-attr">tasks</span>: <span class="hljs-string">"/api/v1/tasks"</span>,
      <span class="hljs-attr">users</span>: <span class="hljs-string">"/api/v1/users"</span>,
      <span class="hljs-attr">analytics</span>: <span class="hljs-string">"/api/v1/analytics"</span>,
      <span class="hljs-attr">health</span>: <span class="hljs-string">"/health"</span>,
    },
  });
});

<span class="hljs-comment">// 404 handler</span>
app.use(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.status(<span class="hljs-number">404</span>).json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">error</span>: <span class="hljs-string">"Not Found"</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">`Route <span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.originalUrl}</span> not found`</span>,
  });
});

<span class="hljs-comment">// Global error handler</span>
app.use(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Application Error:"</span>, err);

  <span class="hljs-comment">// Mongoose validation error</span>
  <span class="hljs-keyword">if</span> (err.name === <span class="hljs-string">"ValidationError"</span>) {
    <span class="hljs-keyword">const</span> errors = <span class="hljs-built_in">Object</span>.values(err.errors).map(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> ({
      <span class="hljs-attr">field</span>: e.path,
      <span class="hljs-attr">message</span>: e.message,
    }));

    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">422</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Validation Error"</span>,
      <span class="hljs-attr">details</span>: errors,
    });
  }

  <span class="hljs-comment">// Mongoose cast error</span>
  <span class="hljs-keyword">if</span> (err.name === <span class="hljs-string">"CastError"</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Bad Request"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">`Invalid <span class="hljs-subst">${err.path}</span>: <span class="hljs-subst">${err.value}</span>`</span>,
    });
  }

  <span class="hljs-comment">// MongoDB duplicate key error</span>
  <span class="hljs-keyword">if</span> (err.code === <span class="hljs-number">11000</span>) {
    <span class="hljs-keyword">const</span> field = <span class="hljs-built_in">Object</span>.keys(err.keyValue)[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">409</span>).json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"Conflict"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">`<span class="hljs-subst">${field}</span> already exists`</span>,
    });
  }

  <span class="hljs-comment">// Default error</span>
  res.status(<span class="hljs-number">500</span>).json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal Server Error"</span>,
    <span class="hljs-attr">message</span>:
      process.env.NODE_ENV === <span class="hljs-string">"production"</span>
        ? <span class="hljs-string">"Something went wrong"</span>
        : err.message,
  });
});

<span class="hljs-comment">// Graceful shutdown</span>
process.on(<span class="hljs-string">"SIGTERM"</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"SIGTERM received, shutting down gracefully"</span>);

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> database.disconnect();
    server.close(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Process terminated"</span>);
    });
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Error during shutdown:"</span>, error);
    process.exit(<span class="hljs-number">1</span>);
  }
});

<span class="hljs-comment">// Start server</span>
<span class="hljs-keyword">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>;

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">startServer</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// Connect to database</span>
    <span class="hljs-keyword">await</span> database.connect({
      <span class="hljs-attr">uri</span>: process.env.MONGODB_URI,
      <span class="hljs-attr">maxPoolSize</span>: <span class="hljs-number">10</span>,
      <span class="hljs-attr">serverSelectionTimeoutMS</span>: <span class="hljs-number">5000</span>,
    });

    <span class="hljs-comment">// Start HTTP server</span>
    <span class="hljs-keyword">const</span> server = app.listen(PORT, () =&gt; {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🚀 Server running on port <span class="hljs-subst">${PORT}</span>`</span>);
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`📚 API: http://localhost:<span class="hljs-subst">${PORT}</span>/api/v1`</span>);
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🏥 Health: http://localhost:<span class="hljs-subst">${PORT}</span>/health`</span>);
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`🗄️ Database: <span class="hljs-subst">${database.getConnectionStatus().name}</span>`</span>);
    });

    <span class="hljs-keyword">return</span> server;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Failed to start server:"</span>, error);
    process.exit(<span class="hljs-number">1</span>);
  }
}

<span class="hljs-keyword">if</span> (<span class="hljs-built_in">require</span>.main === <span class="hljs-built_in">module</span>) {
  startServer();
}

<span class="hljs-built_in">module</span>.exports = app;
</div></code></pre>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-schema-design">1. Schema Design</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Use appropriate data types and validation</span>
<span class="hljs-keyword">const</span> schema = <span class="hljs-keyword">new</span> mongoose.Schema({
  <span class="hljs-attr">email</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">lowercase</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">validate</span>: [validator.isEmail, <span class="hljs-string">"Invalid email"</span>],
  },
  <span class="hljs-attr">createdAt</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-built_in">Date</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-built_in">Date</span>.now,
    <span class="hljs-attr">index</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// Add indexes for frequently queried fields</span>
  },
});
</div></code></pre>
<h3 id="2-use-indexes-effectively">2. Use Indexes Effectively</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Compound indexes for complex queries</span>
schema.index({ <span class="hljs-attr">userId</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">status</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">createdAt</span>: <span class="hljs-number">-1</span> });

<span class="hljs-comment">// Text indexes for search</span>
schema.index({ <span class="hljs-attr">title</span>: <span class="hljs-string">"text"</span>, <span class="hljs-attr">description</span>: <span class="hljs-string">"text"</span> });

<span class="hljs-comment">// Sparse indexes for optional fields</span>
schema.index({ <span class="hljs-attr">email</span>: <span class="hljs-number">1</span> }, { <span class="hljs-attr">sparse</span>: <span class="hljs-literal">true</span> });
</div></code></pre>
<h3 id="3-handle-errors-properly">3. Handle Errors Properly</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Use try-catch with async/await</span>
<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> User.findById(id);
  <span class="hljs-keyword">if</span> (!user) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"User not found"</span>);
  }
  <span class="hljs-keyword">return</span> user;
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Database operation failed: <span class="hljs-subst">${error.message}</span>`</span>);
}
</div></code></pre>
<h3 id="4-use-transactions-for-related-operations">4. Use Transactions for Related Operations</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Use transactions for operations that must succeed together</span>
<span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> mongoose.startSession();
<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">await</span> session.withTransaction(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">await</span> User.create([userData], { session });
    <span class="hljs-keyword">await</span> Task.create([taskData], { session });
  });
} <span class="hljs-keyword">finally</span> {
  <span class="hljs-keyword">await</span> session.endSession();
}
</div></code></pre>
<h3 id="5-optimize-queries">5. Optimize Queries</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Use lean() for read-only operations</span>
<span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> User.find().lean();

<span class="hljs-comment">// Use select() to limit fields</span>
<span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> User.find().select(<span class="hljs-string">"name email"</span>);

<span class="hljs-comment">// Use populate() efficiently</span>
<span class="hljs-keyword">const</span> tasks = <span class="hljs-keyword">await</span> Task.find()
  .populate(<span class="hljs-string">"assignedTo"</span>, <span class="hljs-string">"name email"</span>)
  .populate(<span class="hljs-string">"comments.author"</span>, <span class="hljs-string">"name"</span>);
</div></code></pre>
<h2 id="summary">Summary</h2>
<p>MongoDB with Mongoose provides a powerful foundation for Node.js applications:</p>
<p><strong>Key Features</strong>:</p>
<ul>
<li><strong>Schema Definition</strong>: Structure and validation for documents</li>
<li><strong>Type Casting</strong>: Automatic data type conversion</li>
<li><strong>Middleware</strong>: Pre and post hooks for document operations</li>
<li><strong>Query Building</strong>: Chainable, powerful query API</li>
<li><strong>Population</strong>: Reference and populate related documents</li>
<li><strong>Validation</strong>: Built-in and custom validation rules</li>
</ul>
<p><strong>Advanced Capabilities</strong>:</p>
<ul>
<li><strong>Aggregation</strong>: Complex data processing and analytics</li>
<li><strong>Indexing</strong>: Performance optimization for queries</li>
<li><strong>Transactions</strong>: ACID compliance for related operations</li>
<li><strong>Change Streams</strong>: Real-time data change notifications</li>
<li><strong>GridFS</strong>: Large file storage and retrieval</li>
</ul>
<p><strong>Best Practices</strong>:</p>
<ul>
<li>Design schemas with proper validation and indexes</li>
<li>Use transactions for related operations</li>
<li>Optimize queries with lean(), select(), and populate()</li>
<li>Handle errors appropriately</li>
<li>Monitor query performance</li>
<li>Use connection pooling and proper configuration</li>
</ul>
<p><strong>Benefits</strong>:</p>
<ul>
<li><strong>Flexibility</strong>: Schema-less design with optional structure</li>
<li><strong>Scalability</strong>: Horizontal scaling capabilities</li>
<li><strong>Performance</strong>: Optimized for read-heavy workloads</li>
<li><strong>Developer Experience</strong>: Intuitive API and powerful features</li>
<li><strong>Rich Ecosystem</strong>: Extensive tooling and community support</li>
</ul>
<p>MongoDB and Mongoose integration enables building robust, scalable applications with complex data requirements. Next, we'll explore authentication and authorization patterns, building upon the database foundation to create secure user management systems.</p>
<h1 id="authentication-and-authorization-in-expressjs">Authentication and Authorization in Express.js</h1>
<h2 id="overview">Overview</h2>
<p>Authentication and authorization are critical security components in web applications. Authentication verifies who a user is (identity), while authorization determines what a user can do (permissions). This chapter covers implementing secure authentication using JWT (JSON Web Tokens), session-based authentication, password hashing, role-based access control (RBAC), and advanced security patterns in Express.js applications.</p>
<h2 id="key-concepts">Key Concepts</h2>
<h3 id="authentication-vs-authorization">Authentication vs Authorization</h3>
<p><strong>Authentication</strong>: The process of verifying a user's identity (&quot;Who are you?&quot;)</p>
<ul>
<li>Login with username/password</li>
<li>Token verification</li>
<li>Multi-factor authentication</li>
<li>Social login (OAuth)</li>
</ul>
<p><strong>Authorization</strong>: The process of determining what an authenticated user can access (&quot;What can you do?&quot;)</p>
<ul>
<li>Role-based access control (RBAC)</li>
<li>Permission-based access control</li>
<li>Resource-level permissions</li>
<li>Attribute-based access control (ABAC)</li>
</ul>
<h3 id="jwt-json-web-tokens">JWT (JSON Web Tokens)</h3>
<p><strong>Structure</strong>: Header.Payload.Signature</p>
<ul>
<li><strong>Header</strong>: Token type and signing algorithm</li>
<li><strong>Payload</strong>: Claims (user data, permissions, expiration)</li>
<li><strong>Signature</strong>: Verification of token integrity</li>
</ul>
<p><strong>Benefits</strong>: Stateless, scalable, cross-domain support
<strong>Considerations</strong>: Token size, security, refresh strategies</p>
<h3 id="session-based-authentication">Session-Based Authentication</h3>
<p><strong>Server-side sessions</strong>: Store session data on server
<strong>Session cookies</strong>: Client stores session identifier
<strong>Benefits</strong>: Server control, easy revocation
<strong>Considerations</strong>: Scalability, memory usage</p>
<h2 id="example-code">Example Code</h2>
<h3 id="jwt-authentication-service">JWT Authentication Service</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// services/AuthService.js - Comprehensive Authentication Service</span>
<span class="hljs-keyword">const</span> jwt = <span class="hljs-built_in">require</span>(<span class="hljs-string">"jsonwebtoken"</span>);
<span class="hljs-keyword">const</span> bcrypt = <span class="hljs-built_in">require</span>(<span class="hljs-string">"bcryptjs"</span>);
<span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">"crypto"</span>);
<span class="hljs-keyword">const</span> User = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../models/User"</span>);
<span class="hljs-keyword">const</span> RefreshToken = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../models/RefreshToken"</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthService</span> </span>{
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.jwtSecret = process.env.JWT_SECRET || <span class="hljs-string">"your-secret-key"</span>;
    <span class="hljs-keyword">this</span>.jwtRefreshSecret =
      process.env.JWT_REFRESH_SECRET || <span class="hljs-string">"your-refresh-secret"</span>;
    <span class="hljs-keyword">this</span>.accessTokenExpiry = process.env.JWT_EXPIRES_IN || <span class="hljs-string">"15m"</span>;
    <span class="hljs-keyword">this</span>.refreshTokenExpiry = process.env.JWT_REFRESH_EXPIRES_IN || <span class="hljs-string">"7d"</span>;
    <span class="hljs-keyword">this</span>.issuer = process.env.JWT_ISSUER || <span class="hljs-string">"task-api"</span>;
    <span class="hljs-keyword">this</span>.audience = process.env.JWT_AUDIENCE || <span class="hljs-string">"task-app"</span>;
  }

  <span class="hljs-comment">// Generate access token</span>
  generateAccessToken(user) {
    <span class="hljs-keyword">const</span> payload = {
      <span class="hljs-attr">sub</span>: user._id.toString(), <span class="hljs-comment">// Subject (user ID)</span>
      <span class="hljs-attr">username</span>: user.username,
      <span class="hljs-attr">email</span>: user.email,
      <span class="hljs-attr">role</span>: user.role,
      <span class="hljs-attr">permissions</span>: <span class="hljs-keyword">this</span>.getUserPermissions(user.role),
      <span class="hljs-attr">iss</span>: <span class="hljs-keyword">this</span>.issuer, <span class="hljs-comment">// Issuer</span>
      <span class="hljs-attr">aud</span>: <span class="hljs-keyword">this</span>.audience, <span class="hljs-comment">// Audience</span>
      <span class="hljs-attr">iat</span>: <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Date</span>.now() / <span class="hljs-number">1000</span>), <span class="hljs-comment">// Issued at</span>
      <span class="hljs-attr">type</span>: <span class="hljs-string">"access"</span>,
    };

    <span class="hljs-keyword">return</span> jwt.sign(payload, <span class="hljs-keyword">this</span>.jwtSecret, {
      <span class="hljs-attr">expiresIn</span>: <span class="hljs-keyword">this</span>.accessTokenExpiry,
      <span class="hljs-attr">algorithm</span>: <span class="hljs-string">"HS256"</span>,
    });
  }

  <span class="hljs-comment">// Generate refresh token</span>
  <span class="hljs-keyword">async</span> generateRefreshToken(userId) {
    <span class="hljs-keyword">const</span> token = crypto.randomBytes(<span class="hljs-number">64</span>).toString(<span class="hljs-string">"hex"</span>);
    <span class="hljs-keyword">const</span> expiresAt = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
    expiresAt.setTime(expiresAt.getTime() + <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>); <span class="hljs-comment">// 7 days</span>

    <span class="hljs-comment">// Store refresh token in database</span>
    <span class="hljs-keyword">const</span> refreshToken = <span class="hljs-keyword">new</span> RefreshToken({
      token,
      userId,
      expiresAt,
      <span class="hljs-attr">isActive</span>: <span class="hljs-literal">true</span>,
    });

    <span class="hljs-keyword">await</span> refreshToken.save();
    <span class="hljs-keyword">return</span> token;
  }

  <span class="hljs-comment">// Verify access token</span>
  verifyAccessToken(token) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> decoded = jwt.verify(token, <span class="hljs-keyword">this</span>.jwtSecret, {
        <span class="hljs-attr">issuer</span>: <span class="hljs-keyword">this</span>.issuer,
        <span class="hljs-attr">audience</span>: <span class="hljs-keyword">this</span>.audience,
        <span class="hljs-attr">algorithms</span>: [<span class="hljs-string">"HS256"</span>],
      });

      <span class="hljs-keyword">if</span> (decoded.type !== <span class="hljs-string">"access"</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Invalid token type"</span>);
      }

      <span class="hljs-keyword">return</span> decoded;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Token verification failed: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Verify refresh token</span>
  <span class="hljs-keyword">async</span> verifyRefreshToken(token) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> refreshToken = <span class="hljs-keyword">await</span> RefreshToken.findOne({
        token,
        <span class="hljs-attr">isActive</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">expiresAt</span>: { <span class="hljs-attr">$gt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() },
      }).populate(<span class="hljs-string">"userId"</span>);

      <span class="hljs-keyword">if</span> (!refreshToken) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Invalid or expired refresh token"</span>);
      }

      <span class="hljs-keyword">return</span> refreshToken;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Refresh token verification failed: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Register new user</span>
  <span class="hljs-keyword">async</span> register(userData) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> { username, email, password, firstName, lastName } = userData;

      <span class="hljs-comment">// Check if user already exists</span>
      <span class="hljs-keyword">const</span> existingUser = <span class="hljs-keyword">await</span> User.findOne({
        <span class="hljs-attr">$or</span>: [{ email }, { username }],
      });

      <span class="hljs-keyword">if</span> (existingUser) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"User already exists with this email or username"</span>);
      }

      <span class="hljs-comment">// Create new user</span>
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">new</span> User({
        username,
        email,
        password, <span class="hljs-comment">// Will be hashed by pre-save middleware</span>
        firstName,
        lastName,
        <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>, <span class="hljs-comment">// Default role</span>
      });

      <span class="hljs-keyword">await</span> user.save();

      <span class="hljs-comment">// Generate tokens</span>
      <span class="hljs-keyword">const</span> accessToken = <span class="hljs-keyword">this</span>.generateAccessToken(user);
      <span class="hljs-keyword">const</span> refreshToken = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.generateRefreshToken(user._id);

      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">user</span>: user.toPublicJSON(),
        <span class="hljs-attr">tokens</span>: {
          accessToken,
          refreshToken,
          <span class="hljs-attr">expiresIn</span>: <span class="hljs-keyword">this</span>.accessTokenExpiry,
        },
      };
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Registration failed: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Login user</span>
  <span class="hljs-keyword">async</span> login(credentials) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> { identifier, password, rememberMe = <span class="hljs-literal">false</span> } = credentials;

      <span class="hljs-comment">// Find user by email or username</span>
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> User.findOne({
        <span class="hljs-attr">$or</span>: [{ <span class="hljs-attr">email</span>: identifier.toLowerCase() }, { <span class="hljs-attr">username</span>: identifier }],
        <span class="hljs-attr">isActive</span>: <span class="hljs-literal">true</span>,
      }).select(<span class="hljs-string">"+password"</span>); <span class="hljs-comment">// Include password field</span>

      <span class="hljs-keyword">if</span> (!user) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Invalid credentials"</span>);
      }

      <span class="hljs-comment">// Verify password</span>
      <span class="hljs-keyword">const</span> isPasswordValid = <span class="hljs-keyword">await</span> user.comparePassword(password);
      <span class="hljs-keyword">if</span> (!isPasswordValid) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Invalid credentials"</span>);
      }

      <span class="hljs-comment">// Update last login</span>
      <span class="hljs-keyword">await</span> user.updateLastLogin();

      <span class="hljs-comment">// Generate tokens</span>
      <span class="hljs-keyword">const</span> accessToken = <span class="hljs-keyword">this</span>.generateAccessToken(user);
      <span class="hljs-keyword">const</span> refreshToken = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.generateRefreshToken(user._id);

      <span class="hljs-comment">// Revoke old refresh tokens if not "remember me"</span>
      <span class="hljs-keyword">if</span> (!rememberMe) {
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.revokeUserRefreshTokens(user._id);
      }

      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">user</span>: user.toPublicJSON(),
        <span class="hljs-attr">tokens</span>: {
          accessToken,
          refreshToken,
          <span class="hljs-attr">expiresIn</span>: <span class="hljs-keyword">this</span>.accessTokenExpiry,
        },
      };
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Login failed: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Refresh access token</span>
  <span class="hljs-keyword">async</span> refreshAccessToken(refreshToken) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> tokenDoc = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.verifyRefreshToken(refreshToken);
      <span class="hljs-keyword">const</span> user = tokenDoc.userId;

      <span class="hljs-keyword">if</span> (!user.isActive) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"User account is deactivated"</span>);
      }

      <span class="hljs-comment">// Generate new access token</span>
      <span class="hljs-keyword">const</span> newAccessToken = <span class="hljs-keyword">this</span>.generateAccessToken(user);

      <span class="hljs-comment">// Optionally rotate refresh token</span>
      <span class="hljs-keyword">let</span> newRefreshToken = refreshToken;
      <span class="hljs-keyword">if</span> (process.env.ROTATE_REFRESH_TOKENS === <span class="hljs-string">"true"</span>) {
        <span class="hljs-comment">// Revoke old refresh token</span>
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.revokeRefreshToken(refreshToken);
        <span class="hljs-comment">// Generate new refresh token</span>
        newRefreshToken = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.generateRefreshToken(user._id);
      }

      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">accessToken</span>: newAccessToken,
        <span class="hljs-attr">refreshToken</span>: newRefreshToken,
        <span class="hljs-attr">expiresIn</span>: <span class="hljs-keyword">this</span>.accessTokenExpiry,
      };
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Token refresh failed: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Logout user</span>
  <span class="hljs-keyword">async</span> logout(refreshToken) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (refreshToken) {
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.revokeRefreshToken(refreshToken);
      }
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">"Logged out successfully"</span> };
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Logout failed: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Logout from all devices</span>
  <span class="hljs-keyword">async</span> logoutAll(userId) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.revokeUserRefreshTokens(userId);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">"Logged out from all devices"</span> };
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Logout all failed: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Revoke refresh token</span>
  <span class="hljs-keyword">async</span> revokeRefreshToken(token) {
    <span class="hljs-keyword">await</span> RefreshToken.updateOne(
      { token },
      { <span class="hljs-attr">isActive</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">revokedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() }
    );
  }

  <span class="hljs-comment">// Revoke all user refresh tokens</span>
  <span class="hljs-keyword">async</span> revokeUserRefreshTokens(userId) {
    <span class="hljs-keyword">await</span> RefreshToken.updateMany(
      { userId, <span class="hljs-attr">isActive</span>: <span class="hljs-literal">true</span> },
      { <span class="hljs-attr">isActive</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">revokedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() }
    );
  }

  <span class="hljs-comment">// Change password</span>
  <span class="hljs-keyword">async</span> changePassword(userId, currentPassword, newPassword) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> User.findById(userId).select(<span class="hljs-string">"+password"</span>);
      <span class="hljs-keyword">if</span> (!user) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"User not found"</span>);
      }

      <span class="hljs-comment">// Verify current password</span>
      <span class="hljs-keyword">const</span> isCurrentPasswordValid = <span class="hljs-keyword">await</span> user.comparePassword(
        currentPassword
      );
      <span class="hljs-keyword">if</span> (!isCurrentPasswordValid) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Current password is incorrect"</span>);
      }

      <span class="hljs-comment">// Update password</span>
      user.password = newPassword;
      <span class="hljs-keyword">await</span> user.save();

      <span class="hljs-comment">// Revoke all refresh tokens to force re-login</span>
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.revokeUserRefreshTokens(userId);

      <span class="hljs-keyword">return</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">"Password changed successfully"</span> };
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Password change failed: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Reset password</span>
  <span class="hljs-keyword">async</span> resetPassword(email) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> User.findOne({ <span class="hljs-attr">email</span>: email.toLowerCase() });
      <span class="hljs-keyword">if</span> (!user) {
        <span class="hljs-comment">// Don't reveal if email exists</span>
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">"If the email exists, a reset link has been sent"</span> };
      }

      <span class="hljs-comment">// Generate reset token</span>
      <span class="hljs-keyword">const</span> resetToken = crypto.randomBytes(<span class="hljs-number">32</span>).toString(<span class="hljs-string">"hex"</span>);
      <span class="hljs-keyword">const</span> resetTokenExpiry = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-built_in">Date</span>.now() + <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>); <span class="hljs-comment">// 1 hour</span>

      <span class="hljs-comment">// Save reset token to user</span>
      user.passwordResetToken = crypto
        .createHash(<span class="hljs-string">"sha256"</span>)
        .update(resetToken)
        .digest(<span class="hljs-string">"hex"</span>);
      user.passwordResetExpires = resetTokenExpiry;
      <span class="hljs-keyword">await</span> user.save({ <span class="hljs-attr">validateBeforeSave</span>: <span class="hljs-literal">false</span> });

      <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Send email with reset link</span>
      <span class="hljs-comment">// await emailService.sendPasswordResetEmail(user.email, resetToken);</span>

      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Password reset link sent to email"</span>,
        resetToken, <span class="hljs-comment">// Remove in production</span>
      };
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Password reset failed: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Confirm password reset</span>
  <span class="hljs-keyword">async</span> confirmPasswordReset(resetToken, newPassword) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> hashedToken = crypto
        .createHash(<span class="hljs-string">"sha256"</span>)
        .update(resetToken)
        .digest(<span class="hljs-string">"hex"</span>);

      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> User.findOne({
        <span class="hljs-attr">passwordResetToken</span>: hashedToken,
        <span class="hljs-attr">passwordResetExpires</span>: { <span class="hljs-attr">$gt</span>: <span class="hljs-built_in">Date</span>.now() },
      });

      <span class="hljs-keyword">if</span> (!user) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Invalid or expired reset token"</span>);
      }

      <span class="hljs-comment">// Update password and clear reset token</span>
      user.password = newPassword;
      user.passwordResetToken = <span class="hljs-literal">undefined</span>;
      user.passwordResetExpires = <span class="hljs-literal">undefined</span>;
      <span class="hljs-keyword">await</span> user.save();

      <span class="hljs-comment">// Revoke all refresh tokens</span>
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.revokeUserRefreshTokens(user._id);

      <span class="hljs-keyword">return</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">"Password reset successfully"</span> };
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Password reset confirmation failed: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Get user permissions based on role</span>
  getUserPermissions(role) {
    <span class="hljs-keyword">const</span> permissions = {
      <span class="hljs-attr">user</span>: [
        <span class="hljs-string">"tasks:read:own"</span>,
        <span class="hljs-string">"tasks:create"</span>,
        <span class="hljs-string">"tasks:update:own"</span>,
        <span class="hljs-string">"tasks:delete:own"</span>,
        <span class="hljs-string">"profile:read:own"</span>,
        <span class="hljs-string">"profile:update:own"</span>,
      ],
      <span class="hljs-attr">moderator</span>: [
        <span class="hljs-string">"tasks:read:all"</span>,
        <span class="hljs-string">"tasks:create"</span>,
        <span class="hljs-string">"tasks:update:all"</span>,
        <span class="hljs-string">"tasks:delete:own"</span>,
        <span class="hljs-string">"users:read:all"</span>,
        <span class="hljs-string">"profile:read:own"</span>,
        <span class="hljs-string">"profile:update:own"</span>,
      ],
      <span class="hljs-attr">admin</span>: [<span class="hljs-string">"tasks:*"</span>, <span class="hljs-string">"users:*"</span>, <span class="hljs-string">"analytics:read"</span>, <span class="hljs-string">"system:manage"</span>],
    };

    <span class="hljs-keyword">return</span> permissions[role] || permissions.user;
  }

  <span class="hljs-comment">// Clean up expired tokens (run periodically)</span>
  <span class="hljs-keyword">async</span> cleanupExpiredTokens() {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> RefreshToken.deleteMany({
        <span class="hljs-attr">$or</span>: [
          { <span class="hljs-attr">expiresAt</span>: { <span class="hljs-attr">$lt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() } },
          {
            <span class="hljs-attr">isActive</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">revokedAt</span>: { <span class="hljs-attr">$lt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-built_in">Date</span>.now() - <span class="hljs-number">30</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>) },
          }, <span class="hljs-comment">// 30 days old</span>
        ],
      });

      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Cleaned up <span class="hljs-subst">${result.deletedCount}</span> expired tokens`</span>);
      <span class="hljs-keyword">return</span> result.deletedCount;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Token cleanup failed:"</span>, error);
      <span class="hljs-keyword">throw</span> error;
    }
  }
}

<span class="hljs-built_in">module</span>.exports = <span class="hljs-keyword">new</span> AuthService();
</div></code></pre>
<h3 id="refresh-token-model">Refresh Token Model</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// models/RefreshToken.js - Refresh Token Schema</span>
<span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">"mongoose"</span>);

<span class="hljs-keyword">const</span> refreshTokenSchema = <span class="hljs-keyword">new</span> mongoose.Schema(
  {
    <span class="hljs-attr">token</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
      <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">index</span>: <span class="hljs-literal">true</span>,
    },
    <span class="hljs-attr">userId</span>: {
      <span class="hljs-attr">type</span>: mongoose.Schema.Types.ObjectId,
      <span class="hljs-attr">ref</span>: <span class="hljs-string">"User"</span>,
      <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">index</span>: <span class="hljs-literal">true</span>,
    },
    <span class="hljs-attr">isActive</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">Boolean</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">index</span>: <span class="hljs-literal">true</span>,
    },
    <span class="hljs-attr">expiresAt</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">Date</span>,
      <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">index</span>: { <span class="hljs-attr">expireAfterSeconds</span>: <span class="hljs-number">0</span> }, <span class="hljs-comment">// MongoDB TTL index</span>
    },
    <span class="hljs-attr">revokedAt</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">Date</span>,
    },
    <span class="hljs-attr">deviceInfo</span>: {
      <span class="hljs-attr">userAgent</span>: <span class="hljs-built_in">String</span>,
      <span class="hljs-attr">ip</span>: <span class="hljs-built_in">String</span>,
      <span class="hljs-attr">platform</span>: <span class="hljs-built_in">String</span>,
      <span class="hljs-attr">browser</span>: <span class="hljs-built_in">String</span>,
    },
    <span class="hljs-attr">lastUsed</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-built_in">Date</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-built_in">Date</span>.now,
    },
  },
  {
    <span class="hljs-attr">timestamps</span>: <span class="hljs-literal">true</span>,
  }
);

<span class="hljs-comment">// Compound indexes</span>
refreshTokenSchema.index({ <span class="hljs-attr">userId</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">isActive</span>: <span class="hljs-number">1</span> });
refreshTokenSchema.index({ <span class="hljs-attr">token</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">isActive</span>: <span class="hljs-number">1</span> });

<span class="hljs-comment">// Update lastUsed when token is accessed</span>
refreshTokenSchema.methods.updateLastUsed = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>.lastUsed = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.save({ <span class="hljs-attr">validateBeforeSave</span>: <span class="hljs-literal">false</span> });
};

<span class="hljs-comment">// Static method to find active tokens for user</span>
refreshTokenSchema.statics.findActiveTokensForUser = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">userId</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.find({
    userId,
    <span class="hljs-attr">isActive</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">expiresAt</span>: { <span class="hljs-attr">$gt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() },
  }).sort({ <span class="hljs-attr">lastUsed</span>: <span class="hljs-number">-1</span> });
};

<span class="hljs-built_in">module</span>.exports = mongoose.model(<span class="hljs-string">"RefreshToken"</span>, refreshTokenSchema);
</div></code></pre>
<h3 id="authentication-middleware">Authentication Middleware</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// middleware/auth.js - Authentication and Authorization Middleware</span>
<span class="hljs-keyword">const</span> AuthService = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../services/AuthService"</span>);
<span class="hljs-keyword">const</span> User = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../models/User"</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthMiddleware</span> </span>{
  <span class="hljs-comment">// Extract token from request</span>
  <span class="hljs-keyword">static</span> extractToken(req) {
    <span class="hljs-comment">// Check Authorization header (Bearer token)</span>
    <span class="hljs-keyword">const</span> authHeader = req.headers.authorization;
    <span class="hljs-keyword">if</span> (authHeader &amp;&amp; authHeader.startsWith(<span class="hljs-string">"Bearer "</span>)) {
      <span class="hljs-keyword">return</span> authHeader.substring(<span class="hljs-number">7</span>);
    }

    <span class="hljs-comment">// Check query parameter</span>
    <span class="hljs-keyword">if</span> (req.query.token) {
      <span class="hljs-keyword">return</span> req.query.token;
    }

    <span class="hljs-comment">// Check cookies</span>
    <span class="hljs-keyword">if</span> (req.cookies &amp;&amp; req.cookies.accessToken) {
      <span class="hljs-keyword">return</span> req.cookies.accessToken;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }

  <span class="hljs-comment">// Authentication middleware - requires valid token</span>
  <span class="hljs-keyword">static</span> authenticate() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (req, res, next) =&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> token = AuthMiddleware.extractToken(req);

        <span class="hljs-keyword">if</span> (!token) {
          <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({
            <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">error</span>: <span class="hljs-string">"Unauthorized"</span>,
            <span class="hljs-attr">message</span>: <span class="hljs-string">"Access token is required"</span>,
          });
        }

        <span class="hljs-comment">// Verify token</span>
        <span class="hljs-keyword">const</span> decoded = AuthService.verifyAccessToken(token);

        <span class="hljs-comment">// Get fresh user data</span>
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> User.findById(decoded.sub);
        <span class="hljs-keyword">if</span> (!user || !user.isActive) {
          <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({
            <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">error</span>: <span class="hljs-string">"Unauthorized"</span>,
            <span class="hljs-attr">message</span>: <span class="hljs-string">"User not found or inactive"</span>,
          });
        }

        <span class="hljs-comment">// Attach user and token info to request</span>
        req.user = user;
        req.token = decoded;
        req.permissions = decoded.permissions || [];

        next();
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Unauthorized"</span>,
          <span class="hljs-attr">message</span>: error.message,
        });
      }
    };
  }

  <span class="hljs-comment">// Optional authentication - doesn't fail if no token</span>
  <span class="hljs-keyword">static</span> optionalAuth() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (req, res, next) =&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> token = AuthMiddleware.extractToken(req);

        <span class="hljs-keyword">if</span> (token) {
          <span class="hljs-keyword">const</span> decoded = AuthService.verifyAccessToken(token);
          <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> User.findById(decoded.sub);

          <span class="hljs-keyword">if</span> (user &amp;&amp; user.isActive) {
            req.user = user;
            req.token = decoded;
            req.permissions = decoded.permissions || [];
          }
        }
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-comment">// Ignore token errors for optional auth</span>
        <span class="hljs-built_in">console</span>.warn(<span class="hljs-string">"Optional auth token error:"</span>, error.message);
      }

      next();
    };
  }

  <span class="hljs-comment">// Role-based authorization</span>
  <span class="hljs-keyword">static</span> authorize(allowedRoles = []) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!req.user) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Unauthorized"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">"Authentication required"</span>,
        });
      }

      <span class="hljs-keyword">if</span> (allowedRoles.length &gt; <span class="hljs-number">0</span> &amp;&amp; !allowedRoles.includes(req.user.role)) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">403</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Forbidden"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">"Insufficient permissions"</span>,
        });
      }

      next();
    };
  }

  <span class="hljs-comment">// Permission-based authorization</span>
  <span class="hljs-keyword">static</span> requirePermission(permission) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!req.user) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Unauthorized"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">"Authentication required"</span>,
        });
      }

      <span class="hljs-keyword">if</span> (!AuthMiddleware.hasPermission(req.permissions, permission)) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">403</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Forbidden"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">`Permission required: <span class="hljs-subst">${permission}</span>`</span>,
        });
      }

      next();
    };
  }

  <span class="hljs-comment">// Resource ownership authorization</span>
  <span class="hljs-keyword">static</span> requireOwnership(resourceField = <span class="hljs-string">"userId"</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!req.user) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Unauthorized"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">"Authentication required"</span>,
        });
      }

      <span class="hljs-comment">// Admin can access any resource</span>
      <span class="hljs-keyword">if</span> (req.user.role === <span class="hljs-string">"admin"</span>) {
        <span class="hljs-keyword">return</span> next();
      }

      <span class="hljs-comment">// Check if user owns the resource</span>
      <span class="hljs-keyword">const</span> resourceUserId =
        req.params[resourceField] || req.body[resourceField];

      <span class="hljs-keyword">if</span> (resourceUserId &amp;&amp; resourceUserId !== req.user._id.toString()) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">403</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Forbidden"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">"Access denied to this resource"</span>,
        });
      }

      next();
    };
  }

  <span class="hljs-comment">// Check if user has specific permission</span>
  <span class="hljs-keyword">static</span> hasPermission(userPermissions, requiredPermission) {
    <span class="hljs-keyword">if</span> (!userPermissions || userPermissions.length === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// Check for exact match</span>
    <span class="hljs-keyword">if</span> (userPermissions.includes(requiredPermission)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">// Check for wildcard permissions</span>
    <span class="hljs-keyword">const</span> [resource, action, scope] = requiredPermission.split(<span class="hljs-string">":"</span>);

    <span class="hljs-comment">// Check for resource-level wildcard (e.g., 'tasks:*')</span>
    <span class="hljs-keyword">if</span> (userPermissions.includes(<span class="hljs-string">`<span class="hljs-subst">${resource}</span>:*`</span>)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">// Check for action-level wildcard (e.g., 'tasks:read:*')</span>
    <span class="hljs-keyword">if</span> (scope &amp;&amp; userPermissions.includes(<span class="hljs-string">`<span class="hljs-subst">${resource}</span>:<span class="hljs-subst">${action}</span>:*`</span>)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">// Rate limiting for auth endpoints</span>
  <span class="hljs-keyword">static</span> createAuthRateLimit() {
    <span class="hljs-keyword">const</span> rateLimit = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express-rate-limit"</span>);

    <span class="hljs-keyword">return</span> rateLimit({
      <span class="hljs-attr">windowMs</span>: <span class="hljs-number">15</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 15 minutes</span>
      <span class="hljs-attr">max</span>: <span class="hljs-number">5</span>, <span class="hljs-comment">// 5 attempts per window</span>
      <span class="hljs-attr">message</span>: {
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Too Many Requests"</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Too many authentication attempts. Please try again later."</span>,
      },
      <span class="hljs-attr">standardHeaders</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">legacyHeaders</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">skipSuccessfulRequests</span>: <span class="hljs-literal">true</span>,
    });
  }

  <span class="hljs-comment">// Account lockout middleware</span>
  <span class="hljs-keyword">static</span> accountLockout() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (req, res, next) =&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> { identifier } = req.body;

        <span class="hljs-keyword">if</span> (identifier) {
          <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> User.findOne({
            <span class="hljs-attr">$or</span>: [
              { <span class="hljs-attr">email</span>: identifier.toLowerCase() },
              { <span class="hljs-attr">username</span>: identifier },
            ],
          });

          <span class="hljs-keyword">if</span> (user &amp;&amp; user.isLocked) {
            <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">423</span>).json({
              <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
              <span class="hljs-attr">error</span>: <span class="hljs-string">"Account Locked"</span>,
              <span class="hljs-attr">message</span>:
                <span class="hljs-string">"Account is temporarily locked due to multiple failed login attempts"</span>,
            });
          }
        }

        next();
      } <span class="hljs-keyword">catch</span> (error) {
        next(error);
      }
    };
  }
}

<span class="hljs-built_in">module</span>.exports = AuthMiddleware;
</div></code></pre>
<h3 id="session-based-authentication-alternative">Session-Based Authentication Alternative</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// middleware/sessionAuth.js - Session-Based Authentication</span>
<span class="hljs-keyword">const</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express-session"</span>);
<span class="hljs-keyword">const</span> MongoStore = <span class="hljs-built_in">require</span>(<span class="hljs-string">"connect-mongo"</span>);
<span class="hljs-keyword">const</span> User = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../models/User"</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SessionAuth</span> </span>{
  <span class="hljs-comment">// Configure session middleware</span>
  <span class="hljs-keyword">static</span> configureSession() {
    <span class="hljs-keyword">return</span> session({
      <span class="hljs-attr">secret</span>: process.env.SESSION_SECRET || <span class="hljs-string">"your-session-secret"</span>,
      <span class="hljs-attr">resave</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">saveUninitialized</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">store</span>: MongoStore.create({
        <span class="hljs-attr">mongoUrl</span>: process.env.MONGODB_URI,
        <span class="hljs-attr">touchAfter</span>: <span class="hljs-number">24</span> * <span class="hljs-number">3600</span>, <span class="hljs-comment">// lazy session update</span>
        <span class="hljs-attr">ttl</span>: <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span>, <span class="hljs-comment">// 7 days</span>
      }),
      <span class="hljs-attr">cookie</span>: {
        <span class="hljs-attr">secure</span>: process.env.NODE_ENV === <span class="hljs-string">"production"</span>, <span class="hljs-comment">// HTTPS only in production</span>
        <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// Prevent XSS</span>
        <span class="hljs-attr">maxAge</span>: <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 7 days</span>
        <span class="hljs-attr">sameSite</span>: <span class="hljs-string">"strict"</span>, <span class="hljs-comment">// CSRF protection</span>
      },
      <span class="hljs-attr">name</span>: <span class="hljs-string">"sessionId"</span>, <span class="hljs-comment">// Don't use default session name</span>
    });
  }

  <span class="hljs-comment">// Login user (session-based)</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> login(req, res, next) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> { identifier, password } = req.body;

      <span class="hljs-comment">// Find user</span>
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> User.findOne({
        <span class="hljs-attr">$or</span>: [{ <span class="hljs-attr">email</span>: identifier.toLowerCase() }, { <span class="hljs-attr">username</span>: identifier }],
        <span class="hljs-attr">isActive</span>: <span class="hljs-literal">true</span>,
      }).select(<span class="hljs-string">"+password"</span>);

      <span class="hljs-keyword">if</span> (!user || !(<span class="hljs-keyword">await</span> user.comparePassword(password))) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Unauthorized"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">"Invalid credentials"</span>,
        });
      }

      <span class="hljs-comment">// Create session</span>
      req.session.userId = user._id;
      req.session.role = user.role;
      req.session.loginTime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();

      <span class="hljs-comment">// Update last login</span>
      <span class="hljs-keyword">await</span> user.updateLastLogin();

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: {
          <span class="hljs-attr">user</span>: user.toPublicJSON(),
          <span class="hljs-attr">sessionId</span>: req.sessionID,
        },
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Login successful"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      next(error);
    }
  }

  <span class="hljs-comment">// Logout user (session-based)</span>
  <span class="hljs-keyword">static</span> logout(req, res, next) {
    req.session.destroy(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">return</span> next(err);
      }

      res.clearCookie(<span class="hljs-string">"sessionId"</span>);
      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Logout successful"</span>,
      });
    });
  }

  <span class="hljs-comment">// Authentication middleware (session-based)</span>
  <span class="hljs-keyword">static</span> authenticate() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (req, res, next) =&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (!req.session.userId) {
          <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({
            <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">error</span>: <span class="hljs-string">"Unauthorized"</span>,
            <span class="hljs-attr">message</span>: <span class="hljs-string">"Please log in to access this resource"</span>,
          });
        }

        <span class="hljs-comment">// Get user data</span>
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> User.findById(req.session.userId);
        <span class="hljs-keyword">if</span> (!user || !user.isActive) {
          req.session.destroy(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {});
          <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({
            <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">error</span>: <span class="hljs-string">"Unauthorized"</span>,
            <span class="hljs-attr">message</span>: <span class="hljs-string">"User not found or inactive"</span>,
          });
        }

        req.user = user;
        next();
      } <span class="hljs-keyword">catch</span> (error) {
        next(error);
      }
    };
  }

  <span class="hljs-comment">// Authorization middleware (session-based)</span>
  <span class="hljs-keyword">static</span> authorize(allowedRoles = []) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!req.user) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Unauthorized"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">"Authentication required"</span>,
        });
      }

      <span class="hljs-keyword">if</span> (allowedRoles.length &gt; <span class="hljs-number">0</span> &amp;&amp; !allowedRoles.includes(req.user.role)) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">403</span>).json({
          <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-string">"Forbidden"</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">"Insufficient permissions"</span>,
        });
      }

      next();
    };
  }
}

<span class="hljs-built_in">module</span>.exports = SessionAuth;
</div></code></pre>
<h3 id="authentication-routes">Authentication Routes</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// routes/auth.js - Authentication Routes</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> { body, validationResult } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express-validator"</span>);
<span class="hljs-keyword">const</span> AuthService = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../services/AuthService"</span>);
<span class="hljs-keyword">const</span> AuthMiddleware = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../middleware/auth"</span>);
<span class="hljs-keyword">const</span> ValidationMiddleware = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../middleware/validation"</span>);

<span class="hljs-keyword">const</span> router = express.Router();

<span class="hljs-comment">// Validation rules</span>
<span class="hljs-keyword">const</span> registerValidation = [
  body(<span class="hljs-string">"username"</span>)
    .isLength({ <span class="hljs-attr">min</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">30</span> })
    .matches(<span class="hljs-regexp">/^[a-zA-Z0-9_]+$/</span>)
    .withMessage(
      <span class="hljs-string">"Username must be 3-30 characters and contain only letters, numbers, and underscores"</span>
    ),
  body(<span class="hljs-string">"email"</span>)
    .isEmail()
    .normalizeEmail()
    .withMessage(<span class="hljs-string">"Please provide a valid email"</span>),
  body(<span class="hljs-string">"password"</span>)
    .isLength({ <span class="hljs-attr">min</span>: <span class="hljs-number">8</span> })
    .matches(<span class="hljs-regexp">/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&amp;])[A-Za-z\d@$!%*?&amp;]/</span>)
    .withMessage(
      <span class="hljs-string">"Password must be at least 8 characters with uppercase, lowercase, number, and special character"</span>
    ),
  body(<span class="hljs-string">"firstName"</span>)
    .trim()
    .isLength({ <span class="hljs-attr">min</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">50</span> })
    .withMessage(<span class="hljs-string">"First name is required and must be less than 50 characters"</span>),
  body(<span class="hljs-string">"lastName"</span>)
    .trim()
    .isLength({ <span class="hljs-attr">min</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">50</span> })
    .withMessage(<span class="hljs-string">"Last name is required and must be less than 50 characters"</span>),
];

<span class="hljs-keyword">const</span> loginValidation = [
  body(<span class="hljs-string">"identifier"</span>).notEmpty().withMessage(<span class="hljs-string">"Email or username is required"</span>),
  body(<span class="hljs-string">"password"</span>).notEmpty().withMessage(<span class="hljs-string">"Password is required"</span>),
];

<span class="hljs-keyword">const</span> changePasswordValidation = [
  body(<span class="hljs-string">"currentPassword"</span>)
    .notEmpty()
    .withMessage(<span class="hljs-string">"Current password is required"</span>),
  body(<span class="hljs-string">"newPassword"</span>)
    .isLength({ <span class="hljs-attr">min</span>: <span class="hljs-number">8</span> })
    .matches(<span class="hljs-regexp">/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&amp;])[A-Za-z\d@$!%*?&amp;]/</span>)
    .withMessage(
      <span class="hljs-string">"New password must be at least 8 characters with uppercase, lowercase, number, and special character"</span>
    ),
];

<span class="hljs-comment">// Apply rate limiting to auth routes</span>
router.use(AuthMiddleware.createAuthRateLimit());

<span class="hljs-comment">// Register</span>
router.post(
  <span class="hljs-string">"/register"</span>,
  registerValidation,
  ValidationMiddleware.handleValidationErrors,
  <span class="hljs-keyword">async</span> (req, res, next) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> AuthService.register(req.body);

      <span class="hljs-comment">// Set refresh token as httpOnly cookie</span>
      res.cookie(<span class="hljs-string">"refreshToken"</span>, result.tokens.refreshToken, {
        <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">secure</span>: process.env.NODE_ENV === <span class="hljs-string">"production"</span>,
        <span class="hljs-attr">sameSite</span>: <span class="hljs-string">"strict"</span>,
        <span class="hljs-attr">maxAge</span>: <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 7 days</span>
      });

      res.status(<span class="hljs-number">201</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: {
          <span class="hljs-attr">user</span>: result.user,
          <span class="hljs-attr">accessToken</span>: result.tokens.accessToken,
          <span class="hljs-attr">expiresIn</span>: result.tokens.expiresIn,
        },
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Registration successful"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      next(error);
    }
  }
);

<span class="hljs-comment">// Login</span>
router.post(
  <span class="hljs-string">"/login"</span>,
  loginValidation,
  ValidationMiddleware.handleValidationErrors,
  AuthMiddleware.accountLockout(),
  <span class="hljs-keyword">async</span> (req, res, next) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> AuthService.login(req.body);

      <span class="hljs-comment">// Set refresh token as httpOnly cookie</span>
      res.cookie(<span class="hljs-string">"refreshToken"</span>, result.tokens.refreshToken, {
        <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">secure</span>: process.env.NODE_ENV === <span class="hljs-string">"production"</span>,
        <span class="hljs-attr">sameSite</span>: <span class="hljs-string">"strict"</span>,
        <span class="hljs-attr">maxAge</span>: <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 7 days</span>
      });

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">data</span>: {
          <span class="hljs-attr">user</span>: result.user,
          <span class="hljs-attr">accessToken</span>: result.tokens.accessToken,
          <span class="hljs-attr">expiresIn</span>: result.tokens.expiresIn,
        },
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Login successful"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      next(error);
    }
  }
);

<span class="hljs-comment">// Refresh token</span>
router.post(<span class="hljs-string">"/refresh"</span>, <span class="hljs-keyword">async</span> (req, res, next) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> refreshToken = req.cookies.refreshToken || req.body.refreshToken;

    <span class="hljs-keyword">if</span> (!refreshToken) {
      <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"Unauthorized"</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Refresh token is required"</span>,
      });
    }

    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> AuthService.refreshAccessToken(refreshToken);

    <span class="hljs-comment">// Update refresh token cookie if rotated</span>
    <span class="hljs-keyword">if</span> (result.refreshToken !== refreshToken) {
      res.cookie(<span class="hljs-string">"refreshToken"</span>, result.refreshToken, {
        <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">secure</span>: process.env.NODE_ENV === <span class="hljs-string">"production"</span>,
        <span class="hljs-attr">sameSite</span>: <span class="hljs-string">"strict"</span>,
        <span class="hljs-attr">maxAge</span>: <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 7 days</span>
      });
    }

    res.json({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">data</span>: {
        <span class="hljs-attr">accessToken</span>: result.accessToken,
        <span class="hljs-attr">expiresIn</span>: result.expiresIn,
      },
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Token refreshed successfully"</span>,
    });
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// Clear invalid refresh token</span>
    res.clearCookie(<span class="hljs-string">"refreshToken"</span>);
    next(error);
  }
});

<span class="hljs-comment">// Logout</span>
router.post(
  <span class="hljs-string">"/logout"</span>,
  AuthMiddleware.optionalAuth(),
  <span class="hljs-keyword">async</span> (req, res, next) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> refreshToken = req.cookies.refreshToken || req.body.refreshToken;

      <span class="hljs-keyword">await</span> AuthService.logout(refreshToken);

      <span class="hljs-comment">// Clear refresh token cookie</span>
      res.clearCookie(<span class="hljs-string">"refreshToken"</span>);

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Logout successful"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      next(error);
    }
  }
);

<span class="hljs-comment">// Logout from all devices</span>
router.post(
  <span class="hljs-string">"/logout-all"</span>,
  AuthMiddleware.authenticate(),
  <span class="hljs-keyword">async</span> (req, res, next) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> AuthService.logoutAll(req.user._id);

      <span class="hljs-comment">// Clear refresh token cookie</span>
      res.clearCookie(<span class="hljs-string">"refreshToken"</span>);

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Logged out from all devices"</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      next(error);
    }
  }
);

<span class="hljs-comment">// Change password</span>
router.post(
  <span class="hljs-string">"/change-password"</span>,
  AuthMiddleware.authenticate(),
  changePasswordValidation,
  ValidationMiddleware.handleValidationErrors,
  <span class="hljs-keyword">async</span> (req, res, next) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> { currentPassword, newPassword } = req.body;

      <span class="hljs-keyword">await</span> AuthService.changePassword(
        req.user._id,
        currentPassword,
        newPassword
      );

      <span class="hljs-comment">// Clear refresh token cookie to force re-login</span>
      res.clearCookie(<span class="hljs-string">"refreshToken"</span>);

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Password changed successfully. Please log in again."</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      next(error);
    }
  }
);

<span class="hljs-comment">// Request password reset</span>
router.post(
  <span class="hljs-string">"/forgot-password"</span>,
  body(<span class="hljs-string">"email"</span>)
    .isEmail()
    .normalizeEmail()
    .withMessage(<span class="hljs-string">"Please provide a valid email"</span>),
  ValidationMiddleware.handleValidationErrors,
  <span class="hljs-keyword">async</span> (req, res, next) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> { email } = req.body;

      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> AuthService.resetPassword(email);

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">message</span>: result.message,
        ...(process.env.NODE_ENV === <span class="hljs-string">"development"</span> &amp;&amp; {
          <span class="hljs-attr">resetToken</span>: result.resetToken,
        }),
      });
    } <span class="hljs-keyword">catch</span> (error) {
      next(error);
    }
  }
);

<span class="hljs-comment">// Confirm password reset</span>
router.post(
  <span class="hljs-string">"/reset-password"</span>,
  body(<span class="hljs-string">"resetToken"</span>).notEmpty().withMessage(<span class="hljs-string">"Reset token is required"</span>),
  body(<span class="hljs-string">"newPassword"</span>)
    .isLength({ <span class="hljs-attr">min</span>: <span class="hljs-number">8</span> })
    .matches(<span class="hljs-regexp">/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&amp;])[A-Za-z\d@$!%*?&amp;]/</span>)
    .withMessage(
      <span class="hljs-string">"Password must be at least 8 characters with uppercase, lowercase, number, and special character"</span>
    ),
  ValidationMiddleware.handleValidationErrors,
  <span class="hljs-keyword">async</span> (req, res, next) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> { resetToken, newPassword } = req.body;

      <span class="hljs-keyword">await</span> AuthService.confirmPasswordReset(resetToken, newPassword);

      res.json({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">message</span>:
          <span class="hljs-string">"Password reset successfully. Please log in with your new password."</span>,
      });
    } <span class="hljs-keyword">catch</span> (error) {
      next(error);
    }
  }
);

<span class="hljs-comment">// Get current user profile</span>
router.get(<span class="hljs-string">"/me"</span>, AuthMiddleware.authenticate(), (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: {
      <span class="hljs-attr">user</span>: req.user.toPublicJSON(),
      <span class="hljs-attr">permissions</span>: req.permissions,
      <span class="hljs-attr">tokenInfo</span>: {
        <span class="hljs-attr">issuedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(req.token.iat * <span class="hljs-number">1000</span>),
        <span class="hljs-attr">expiresAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(req.token.exp * <span class="hljs-number">1000</span>),
      },
    },
  });
});

<span class="hljs-comment">// Verify token (for client-side validation)</span>
router.post(<span class="hljs-string">"/verify"</span>, AuthMiddleware.authenticate(), (req, res) =&gt; {
  res.json({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: {
      <span class="hljs-attr">valid</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">user</span>: req.user.toPublicJSON(),
      <span class="hljs-attr">permissions</span>: req.permissions,
    },
    <span class="hljs-attr">message</span>: <span class="hljs-string">"Token is valid"</span>,
  });
});

<span class="hljs-built_in">module</span>.exports = router;
</div></code></pre>
<h2 id="real-world-use-case">Real-World Use Case</h2>
<h3 id="multi-factor-authentication-mfa">Multi-Factor Authentication (MFA)</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// services/MFAService.js - Multi-Factor Authentication</span>
<span class="hljs-keyword">const</span> speakeasy = <span class="hljs-built_in">require</span>(<span class="hljs-string">"speakeasy"</span>);
<span class="hljs-keyword">const</span> QRCode = <span class="hljs-built_in">require</span>(<span class="hljs-string">"qrcode"</span>);
<span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">"crypto"</span>);
<span class="hljs-keyword">const</span> User = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../models/User"</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MFAService</span> </span>{
  <span class="hljs-comment">// Generate TOTP secret for user</span>
  <span class="hljs-keyword">async</span> generateTOTPSecret(userId) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> User.findById(userId);
      <span class="hljs-keyword">if</span> (!user) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"User not found"</span>);
      }

      <span class="hljs-keyword">const</span> secret = speakeasy.generateSecret({
        <span class="hljs-attr">name</span>: <span class="hljs-string">`TaskApp (<span class="hljs-subst">${user.email}</span>)`</span>,
        <span class="hljs-attr">issuer</span>: <span class="hljs-string">"TaskApp"</span>,
        <span class="hljs-attr">length</span>: <span class="hljs-number">32</span>,
      });

      <span class="hljs-comment">// Store secret temporarily (not activated until verified)</span>
      user.mfa = {
        <span class="hljs-attr">secret</span>: secret.base32,
        <span class="hljs-attr">enabled</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">backupCodes</span>: <span class="hljs-keyword">this</span>.generateBackupCodes(),
      };

      <span class="hljs-keyword">await</span> user.save();

      <span class="hljs-comment">// Generate QR code</span>
      <span class="hljs-keyword">const</span> qrCodeUrl = <span class="hljs-keyword">await</span> QRCode.toDataURL(secret.otpauth_url);

      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">secret</span>: secret.base32,
        <span class="hljs-attr">qrCode</span>: qrCodeUrl,
        <span class="hljs-attr">backupCodes</span>: user.mfa.backupCodes,
      };
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`MFA setup failed: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Verify and enable TOTP</span>
  <span class="hljs-keyword">async</span> enableTOTP(userId, token) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> User.findById(userId);
      <span class="hljs-keyword">if</span> (!user || !user.mfa || !user.mfa.secret) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"MFA not set up"</span>);
      }

      <span class="hljs-keyword">const</span> verified = speakeasy.totp.verify({
        <span class="hljs-attr">secret</span>: user.mfa.secret,
        <span class="hljs-attr">encoding</span>: <span class="hljs-string">"base32"</span>,
        token,
        <span class="hljs-attr">window</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// Allow 2 time steps (60 seconds)</span>
      });

      <span class="hljs-keyword">if</span> (!verified) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Invalid verification code"</span>);
      }

      <span class="hljs-comment">// Enable MFA</span>
      user.mfa.enabled = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">await</span> user.save();

      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">message</span>: <span class="hljs-string">"MFA enabled successfully"</span>,
        <span class="hljs-attr">backupCodes</span>: user.mfa.backupCodes,
      };
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`MFA verification failed: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Verify TOTP token</span>
  <span class="hljs-keyword">async</span> verifyTOTP(userId, token) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> User.findById(userId);
      <span class="hljs-keyword">if</span> (!user || !user.mfa || !user.mfa.enabled) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"MFA not enabled"</span>);
      }

      <span class="hljs-comment">// Check if it's a backup code</span>
      <span class="hljs-keyword">if</span> (user.mfa.backupCodes.includes(token)) {
        <span class="hljs-comment">// Remove used backup code</span>
        user.mfa.backupCodes = user.mfa.backupCodes.filter(
          <span class="hljs-function">(<span class="hljs-params">code</span>) =&gt;</span> code !== token
        );
        <span class="hljs-keyword">await</span> user.save();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }

      <span class="hljs-comment">// Verify TOTP</span>
      <span class="hljs-keyword">const</span> verified = speakeasy.totp.verify({
        <span class="hljs-attr">secret</span>: user.mfa.secret,
        <span class="hljs-attr">encoding</span>: <span class="hljs-string">"base32"</span>,
        token,
        <span class="hljs-attr">window</span>: <span class="hljs-number">2</span>,
      });

      <span class="hljs-keyword">return</span> verified;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`MFA verification failed: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Disable MFA</span>
  <span class="hljs-keyword">async</span> disableMFA(userId, password) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> User.findById(userId).select(<span class="hljs-string">"+password"</span>);
      <span class="hljs-keyword">if</span> (!user) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"User not found"</span>);
      }

      <span class="hljs-comment">// Verify password</span>
      <span class="hljs-keyword">const</span> isPasswordValid = <span class="hljs-keyword">await</span> user.comparePassword(password);
      <span class="hljs-keyword">if</span> (!isPasswordValid) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Invalid password"</span>);
      }

      <span class="hljs-comment">// Disable MFA</span>
      user.mfa = {
        <span class="hljs-attr">enabled</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">secret</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">backupCodes</span>: [],
      };

      <span class="hljs-keyword">await</span> user.save();

      <span class="hljs-keyword">return</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">"MFA disabled successfully"</span> };
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`MFA disable failed: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">// Generate backup codes</span>
  generateBackupCodes(count = <span class="hljs-number">10</span>) {
    <span class="hljs-keyword">const</span> codes = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
      codes.push(crypto.randomBytes(<span class="hljs-number">4</span>).toString(<span class="hljs-string">"hex"</span>).toUpperCase());
    }
    <span class="hljs-keyword">return</span> codes;
  }

  <span class="hljs-comment">// Regenerate backup codes</span>
  <span class="hljs-keyword">async</span> regenerateBackupCodes(userId) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> User.findById(userId);
      <span class="hljs-keyword">if</span> (!user || !user.mfa || !user.mfa.enabled) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"MFA not enabled"</span>);
      }

      user.mfa.backupCodes = <span class="hljs-keyword">this</span>.generateBackupCodes();
      <span class="hljs-keyword">await</span> user.save();

      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">message</span>: <span class="hljs-string">"Backup codes regenerated"</span>,
        <span class="hljs-attr">backupCodes</span>: user.mfa.backupCodes,
      };
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Backup code regeneration failed: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }
}

<span class="hljs-built_in">module</span>.exports = <span class="hljs-keyword">new</span> MFAService();
</div></code></pre>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-password-security">1. Password Security</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Use strong hashing with salt</span>
<span class="hljs-keyword">const</span> bcrypt = <span class="hljs-built_in">require</span>(<span class="hljs-string">"bcryptjs"</span>);
<span class="hljs-keyword">const</span> saltRounds = <span class="hljs-number">12</span>; <span class="hljs-comment">// Increase for better security</span>

<span class="hljs-comment">// Hash password</span>
<span class="hljs-keyword">const</span> hashedPassword = <span class="hljs-keyword">await</span> bcrypt.hash(password, saltRounds);

<span class="hljs-comment">// Verify password</span>
<span class="hljs-keyword">const</span> isValid = <span class="hljs-keyword">await</span> bcrypt.compare(password, hashedPassword);
</div></code></pre>
<h3 id="2-jwt-security">2. JWT Security</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Use strong secrets and proper algorithms</span>
<span class="hljs-keyword">const</span> jwt = <span class="hljs-built_in">require</span>(<span class="hljs-string">"jsonwebtoken"</span>);

<span class="hljs-keyword">const</span> token = jwt.sign(
  { userId, role },
  process.env.JWT_SECRET, <span class="hljs-comment">// Use strong, random secret</span>
  {
    <span class="hljs-attr">expiresIn</span>: <span class="hljs-string">"15m"</span>, <span class="hljs-comment">// Short expiry for access tokens</span>
    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">"HS256"</span>, <span class="hljs-comment">// Specify algorithm</span>
    <span class="hljs-attr">issuer</span>: <span class="hljs-string">"your-app"</span>,
    <span class="hljs-attr">audience</span>: <span class="hljs-string">"your-users"</span>,
  }
);
</div></code></pre>
<h3 id="3-rate-limiting">3. Rate Limiting</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Implement aggressive rate limiting for auth endpoints</span>
<span class="hljs-keyword">const</span> authRateLimit = rateLimit({
  <span class="hljs-attr">windowMs</span>: <span class="hljs-number">15</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 15 minutes</span>
  <span class="hljs-attr">max</span>: <span class="hljs-number">5</span>, <span class="hljs-comment">// 5 attempts per window</span>
  <span class="hljs-attr">skipSuccessfulRequests</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">message</span>: <span class="hljs-string">"Too many authentication attempts"</span>,
});
</div></code></pre>
<h3 id="4-input-validation">4. Input Validation</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Validate all authentication inputs</span>
<span class="hljs-keyword">const</span> { body } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express-validator"</span>);

<span class="hljs-keyword">const</span> loginValidation = [
  body(<span class="hljs-string">"email"</span>).isEmail().normalizeEmail(),
  body(<span class="hljs-string">"password"</span>)
    .isLength({ <span class="hljs-attr">min</span>: <span class="hljs-number">8</span> })
    .matches(<span class="hljs-regexp">/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/</span>),
];
</div></code></pre>
<h3 id="5-secure-headers">5. Secure Headers</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Set security headers</span>
app.use(
  helmet({
    <span class="hljs-attr">contentSecurityPolicy</span>: {
      <span class="hljs-attr">directives</span>: {
        <span class="hljs-attr">defaultSrc</span>: [<span class="hljs-string">"'self'"</span>],
        <span class="hljs-attr">scriptSrc</span>: [<span class="hljs-string">"'self'"</span>, <span class="hljs-string">"'unsafe-inline'"</span>],
      },
    },
    <span class="hljs-attr">hsts</span>: {
      <span class="hljs-attr">maxAge</span>: <span class="hljs-number">31536000</span>,
      <span class="hljs-attr">includeSubDomains</span>: <span class="hljs-literal">true</span>,
    },
  })
);
</div></code></pre>
<h2 id="summary">Summary</h2>
<p>Authentication and authorization are fundamental security components:</p>
<p><strong>Authentication Methods</strong>:</p>
<ul>
<li><strong>JWT</strong>: Stateless, scalable, cross-domain support</li>
<li><strong>Sessions</strong>: Server-side control, easy revocation</li>
<li><strong>Multi-Factor</strong>: Enhanced security with TOTP/backup codes</li>
<li><strong>OAuth</strong>: Third-party authentication integration</li>
</ul>
<p><strong>Authorization Patterns</strong>:</p>
<ul>
<li><strong>Role-Based Access Control (RBAC)</strong>: Simple role hierarchy</li>
<li><strong>Permission-Based</strong>: Granular permission system</li>
<li><strong>Resource Ownership</strong>: User-specific resource access</li>
<li><strong>Attribute-Based</strong>: Context-aware authorization</li>
</ul>
<p><strong>Security Best Practices</strong>:</p>
<ul>
<li>Use strong password hashing (bcrypt with high salt rounds)</li>
<li>Implement proper JWT security (strong secrets, short expiry)</li>
<li>Apply rate limiting to authentication endpoints</li>
<li>Validate and sanitize all inputs</li>
<li>Use secure headers and HTTPS</li>
<li>Implement account lockout mechanisms</li>
<li>Log security events for monitoring</li>
</ul>
<p><strong>Advanced Features</strong>:</p>
<ul>
<li>Token refresh and rotation</li>
<li>Multi-factor authentication</li>
<li>Password reset flows</li>
<li>Session management</li>
<li>Device tracking</li>
<li>Security event logging</li>
</ul>
<p>Proper authentication and authorization implementation ensures application security while providing a smooth user experience. Next, we'll explore file upload and handling, building upon the secure foundation to manage user-generated content safely.</p>

</body>
</html>
